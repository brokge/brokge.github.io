<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="brokge"><title>Dubbo详解 · 玉蘇子</title><meta name="description" content="一、前言
分布式架构的 有 3 种解决方案
基于反向代理的中心化架构
嵌入应用内部的去中心化架构
基于独立代理进程的Service Mesh架构

基于反向代理的集中式分布式架构这是最简单和传统做法，在服务消费者和生产者之间，代理作为独立一层集中部署，由独立团队(一般是运维或框架)负责治理和运维。常"><meta name="keywords" content="玉苏子"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/font-chinese.css"><link rel="stylesheet" href="/css/style-red.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><link rel="stylesheet" href="/css/prism-ghcolors.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><div id="stage" class="container"><div class="row"><div id="side-bar" class="col-sm-3 col-xs-12 side-container invisible"><div class="vertical-text site-title"><h3 tabindex="-1" class="site-title-small"><a href="/" class="a-title">I and i</a></h3><h1 tabindex="-1" class="site-title-large"><a href="/" class="a-title">玉蘇子</a></h1><!--h6(onclick="triggerSiteNav()") Trigger--></div><br class="visible-lg visible-md visible-sm"><div id="site-nav" class="site-title-links"><ul><li><a href="/">首頁</a></li><li><a href="/archives">歸檔</a></li><li><a href="/categories">分類</a></li><li><a href="/tags">標籤</a></li><li> <a href="https://brokge.github.io/scrapydoc/">爬虫</a></li><li> <a href="https://brokge.github.io/linux-command-line/html/">Linux命令行</a></li><li>            <a href="https://brokge.github.io/svg2android">svg转xml</a></li><li><a href="/about/index.html">关于</a></li><li class="soc"><a href="https://github.com/brokge" target="_blank" rel="noopener noreferrer"><i class="fa fa-github">&nbsp;</i></a><a href="https://brokge.github.io/atom.xml" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss">&nbsp;</i></a></li></ul><div class="visible-lg visible-md visible-sm site-nav-footer"><br class="site-nav-footer-br"><footer><p>&copy;&nbsp;2020&nbsp;<a target="_blank" href="https://brokge.github.io" rel="noopener noreferrer">brokge</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer><script type="text/javascript" id="maid-script" src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js?v=undefined"></script><script>if (window.mermaid) {
  var options = JSON.parse(document.getElementById('maid-script').getAttribute('mermaidoptioins'));
  mermaid.initialize(options);
}
 </script></div></div></div><div id="main-container" class="col-sm-9 col-xs-12 main-container invisible"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post-container"><p class="post-title"><a>Dubbo详解</a></p><p class="post-meta"><span class="date meta-item">發佈於&nbsp;2020-06-02</span></p><p class="post-abstract"></p><h2><span id="一-前言">一、前言</span></h2><p><img src="http://note.youdao.com/yws/res/9311/64A03BA7F21B4BB29F4ABC5F11140870" alt="image"></p>
<h4><span id="分布式架构的-有-3-种解决方案"><strong>分布式架构的 有 3 种解决方案</strong></span></h4><ol>
<li>基于反向代理的中心化架构</li>
<li>嵌入应用内部的去中心化架构</li>
<li>基于独立代理进程的Service Mesh架构</li>
</ol>
<h4><span id="基于反向代理的集中式分布式架构">基于反向代理的集中式分布式架构</span></h4><p>这是最简单和传统做法，在服务消费者和生产者之间，代理作为独立一层集中部署，由独立团队(一般是运维或框架)负责治理和运维。常用的集中式代理有硬件负载均衡器(如F5)，或者软件负载均衡器(如Nginx)，这种软硬结合两层代理也是业内常见做法，兼顾配置的灵活性(Nginx比F5易于配置)。</p>
<p><img src="http://note.youdao.com/yws/res/9352/29E919D8DA684D4E99671F5A16013855" alt="image"></p>
<p><strong>Http+Nginx 方案总结</strong></p>
<p><strong>优点：</strong> 简单快速、几乎没有学习成本</p>
<p><strong>适用场景：</strong> 轻量级分布式系统、局部分布式架构。</p>
<p><strong>瓶颈：</strong> Nginx中心负载、Http传输、JSON序列化、开发效率、运维效率。</p>
<h3><span id="嵌入应用内部的去中心化架构">嵌入应用内部的去中心化架构</span></h3><p>这是很多互联网公司比较流行的一种做法，代理(包括服务发现和负载均衡逻辑)以客户库的形式嵌入在应用程序中。这种模式一般需要独立的服务注册中心组件配合，服务启动时自动注册到注册中心并定期报心跳，客户端代理则发现服务并做负载均衡。我们所熟悉的 duboo 和spring cloud Eureka +Ribbon/‘rɪbən/ 都是这种方式实现。</p>
<p><img src="http://note.youdao.com/yws/res/9359/91E7A4D0836A49B395A817DDC2CF2376" alt="image"><br>相比第一代架构它有以下特点几点：</p>
<ul>
<li>去中心化，客户端直连服务端</li>
<li>动态注册和发现服务</li>
<li>高效稳定的网络传输</li>
<li>高效可容错的序列化</li>
</ul>
<h3><span id="基于独立代理进程的架构service-mesh">基于独立代理进程的架构(Service Mesh)</span></h3><p>这种做法是上面两种模式的一个折中，代理既不是独立集中部署，也不嵌入在客户应用程序中，而是作为独立进程部署在每一个主机上，一个主机上的多个消费者应用可以共用这个代理，实现服务发现和负载均衡，如下图所示。这个模式一般也需要独立的服务注册中心组件配合，作用同第二代架构。</p>
<p><img src="http://note.youdao.com/yws/res/9364/E7DE6B068DC74C7D8AE0808F46AB24AF" alt="image"></p>
<h4><span id="三种架构的比较">三种架构的比较</span></h4><table>
<thead>
<tr>
<th style="text-align:left"><strong>模式</strong></th>
<th style="text-align:left"><strong>优点</strong></th>
<th style="text-align:left"><strong>缺点</strong></th>
<th style="text-align:left"><strong>适应场景</strong></th>
<th style="text-align:left"><strong>案例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">集中式负载架构</td>
<td style="text-align:left">简单  集中式治理  与语言无关</td>
<td style="text-align:left">配置维护成本高  多了一层IO  单点问题</td>
<td style="text-align:left">大部分公司都适用，对运维有要求</td>
<td style="text-align:left">亿贝、携程、早期互联网公司</td>
</tr>
<tr>
<td style="text-align:left">客户端嵌入式架构</td>
<td style="text-align:left">无单点  性能更好</td>
<td style="text-align:left">客户端复杂  语言栈要求</td>
<td style="text-align:left">中大规模公司、语言栈统一</td>
<td style="text-align:left">Dubbo    、  Twitter finagle、  Spring Cloud Ribbon</td>
</tr>
<tr>
<td style="text-align:left">独立进程代理架构</td>
<td style="text-align:left">无单点  性能更好  与语言无关</td>
<td style="text-align:left">运维部署复杂  开发联调复杂</td>
<td style="text-align:left">中大规模公司  对运维有要求</td>
<td style="text-align:left">Smart Stack  Service Mesh</td>
</tr>
</tbody>
</table>
<h2><span id="二-什么是-dubbo">二、什么是 Dubbo</span></h2><p>dubbo 阿里开源的一个 SOA（面向服务的架构） 服务治理框架，从目前来看把它称作是一个RPC远程调用框架更为贴切。单从RPC框架来说，功能较完善，支持多种传输和序列化方案。所以想必大家已经知道他的核心功能了：就是远程调用。</p>
<p><img src="http://note.youdao.com/yws/res/9319/81A705F26C0346EA871AB8936296BFE1" alt="image"></p>
<p><strong>流程说明：</strong></p>
<ol>
<li>Provider(提供者)绑定指定端口并启动服务</li>
<li>指供者连接注册中心，并发本机IP、端口、应用信息和提供服务信息发送至注册中心存储</li>
<li>Consumer(消费者），连接注册中心 ，并发送应用信息、所求服务信息至注册中心</li>
<li>注册中心根据 消费 者所求服务信息匹配对应的提供者列表发送至Consumer 应用缓存。</li>
<li>Consumer 在发起远程调用时基于缓存的消费者列表择其一发起调用。</li>
<li>Provider 状态变更会实时通知注册中心、在由注册中心实时推送至Consumer</li>
</ol>
<p><strong>这么设计的意义：</strong></p>
<ol>
<li>Consumer 与Provider 解偶，双方都可以横向增减节点数。</li>
<li>注册中心对本身可做对等集群，可动态增减节点，并且任意一台宕掉后，将自动切换到另一台</li>
<li>去中心化，双方不直接依懒注册中心，即使注册中心全部宕机短时间内也不会影响服务的调用</li>
<li>服务提供者无状态，任意一台宕掉后，不影响使用</li>
</ol>
<p><strong>Dubbo 设计层级</strong></p>
<p><img src="http://note.youdao.com/yws/res/9322/60BD217B1ED345898A01578CF19291CB" alt="image"></p>
<ul>
<li>config <strong>配置层</strong>：对外配置接口，以 ServiceConfig, ReferenceConfig 为中心，可以直接初始化配置类，也可以通过 spring 解析配置生成配置类</li>
<li>proxy <strong>服务代理层</strong>：服务接口透明代理，生成动态代理 扩展接口为 ProxyFactory</li>
<li>registry <strong>注册中心层</strong>：封装服务地址的注册与发现，以服务 URL 为中心，扩展接口为 RegistryFactory, Registry, RegistryService</li>
<li>cluster <strong>路由层</strong>：封装多个提供者的路由及负载均衡，并桥接注册中心，以 Invoker 为中心，扩展接口为 Cluster, Directory, Router, LoadBalance</li>
<li>monitor <strong>监控层</strong>：RPC 调用次数和调用时间监控，以 Statistics 为中心，扩展接口为 MonitorFactory, Monitor, MonitorService</li>
<li>protocol <strong>远程调用层</strong>：封装 RPC 调用，以 Invocation, Result 为中心，扩展接口为 Protocol, Invoker, Exporter</li>
<li>exchange <strong>信息交换层</strong>：封装请求响应模式，同步转异步，以 Request, Response 为中心，扩展接口为 Exchanger, ExchangeChannel, ExchangeClient, ExchangeServer</li>
<li>transport <strong>网络传输层</strong>：抽象 mina 和 netty 为统一接口，以 Message 为中心，扩展接口为 Channel, Transporter, Client, Server, Codec</li>
<li>serialize <strong>数据序列化层</strong>：可复用的一些工具，扩展接口为 Serialization, ObjectInput, ObjectOutput, ThreadPool</li>
</ul>
<p><img src="http://note.youdao.com/yws/res/9335/7DC769031DD64DDABC42BDFBC7384599" alt="image"></p>
<h3><span id="dubbo-spi-机制">Dubbo SPI 机制</span></h3><p>Java SPI 的具体约定为:当服务的提供者，提供了服务接口的一种实现之后，在jar包的META-INF/services/目录里同时创建一个以服务接口命名的文件。该文件里就是实现该服务接口的具体实现类。而当外部程序装配这个模块的时候，就能通过该jar包META-INF/services/里的配置文件找到具体的实现类名，并装载实例化，完成模块的注入。 基于这样一个约定就能很好的找到服务接口的实现类，而不需要再代码里制定。jdk提供服务实现查找的一个工具类java.util.ServiceLoader</p>
<p><img src="http://note.youdao.com/yws/res/9338/0723FDE7587148BAB47925D8471D652D" alt="image"></p>
<p>META-INF/services/xxx.dubbo.server.UserService 中的值：</p>
<pre><code>xxx.dubbo.server.impl.UserServiceImpl2
</code></pre><p>装载获取SPI实现类：</p>
<pre><code>public static void main(String[] args) {
    Iterator&lt;UserService&gt; services = ServiceLoader.load(UserService.class).iterator();
    UserService service = null;
    while (services.hasNext()) {
        service = services.next();
    }
    System.out.println(service.getUser(111));
}
</code></pre><p>Dubbo SPI 在JAVA自带的SPI基础上加入了扩展点的功能，即每个实现类都会对应至一个扩展点名称，其目的是 应用可基于此名称进行相应的装配。</p>
<p><img src="http://note.youdao.com/yws/res/9343/B158D3A511A54EE0819951B33A188F0D" alt="image"><br>dubbo spi  文件内容：</p>
<pre><code>luban=xxx.dubbo.server.LubanFilter
</code></pre><p>装配自定义Filter</p>
<p><img src="http://note.youdao.com/yws/res/9345/17D1822AA2FB4427A92566F2E64917B7" alt="image"></p>
<p>想了解更详细信息：<br><a href="http://dubbo.apache.org/zh-cn/docs/source_code_guide/dubbo-spi.html" target="_blank" rel="noopener">官方文档</a></p>
<h2><span id="三-dubbo注册中心详解">三、Dubbo注册中心详解</span></h2><h3><span id="注册中心的作用">注册中心的作用</span></h3><p>为了到达服务集群动态扩容的目的，注册中心存储了服务的地址信息与可用状态信息，并实时推送给订阅了相关服务的客户端。<br><img src="http://note.youdao.com/yws/res/9386/8638BBF57BF946769ABFCE0DAF896809" alt="image"></p>
<p><strong>一个完整的注册中心需要实现以下功能：</strong></p>
<ol>
<li>接收服务端的注册与客户端的引用，即将引用与消费建立关联，并支持多对多。</li>
<li>当服务非正常关闭时能即时清除其状态</li>
<li>当注册中心重启时，能自动恢复注册数据，以及订阅请求</li>
<li>注册中心本身的集群 。</li>
</ol>
<h3><span id="dubbo所支持的注册中心">Dubbo所支持的注册中心</span></h3><ol>
<li><strong>Multicast 注册中心</strong><ol>
<li>基于组网广播技术，只能用在局域网内，一般用于简单的测试服务</li>
</ol>
</li>
<li><strong>Zookeeper 注册中心(**</strong>推荐<strong>**)</strong><ol>
<li><a href="http://zookeeper.apache.org/" target="_blank" rel="noopener">Zookeeper</a> 是 Apacahe Hadoop 的子项目，是一个树型的目录服务，支持变更推送，适合作为 Dubbo 服务的注册中心，工业强度较高，可用于生产环境，并推荐使用</li>
</ol>
</li>
<li><strong>Redis 注册中心</strong><ol>
<li>基于Redis的注册中心</li>
</ol>
</li>
<li><strong>Simple 注册中心</strong><ol>
<li>基于本身的Dubbo服务实现（SimpleRegistryService），不支持集群可作为自定义注册中心的参考，但不适合直接用于生产环境。 </li>
</ol>
</li>
</ol>
<h3><span id="redis-注册中心"><strong>Redis 注册中心</strong></span></h3><p>关于Redis注册中心我们需要了解两点，</p>
<h4><span id="1-如何存储服务的注册与订阅关系">1. 如何存储服务的注册与订阅关系</span></h4><p>redis 注册中心配置</p>
<pre><code>&lt;dubbo:registry protocol=&quot;redis&quot; address=&quot;192.168.0.147:6379&quot;/&gt;
</code></pre><p>当我们启动两个服务端后发现，Reids中增加了一个Hash 类型的记录，其key为/dubbo/xxx.dubbo.server.UserService/providers。Value中分别存储了两个服务提供者的URL和有效期。</p>
<p><img src="http://note.youdao.com/yws/res/9377/89233BE1BB03402C9224A6348FAA7007" alt="image"></p>
<p><strong>同样消费者也是类似其整体结构如下：</strong></p>
<pre><code>//服务提供者注册信息 
/dubbbo/com.xxx.teach.service.DemoService/providers
  dubbo://192.168.246.1:20880/XXX.DemoService=1542619052964 
  dubbo://192.168.246.2:20880/XXX.DemoService=1542619052964 
//服务消费订阅信息
/dubbbo/com.xxx.teach.service.DemoService/consumers
  dubbo://192.168.246.1:20880/XXX.DemoService=1542619788641
</code></pre><ul>
<li>主 Key 为服务名和类型</li>
<li>Map 中的 Key 为 URL 地址</li>
<li>Map 中的 Value 为过期时间，用于判断脏数据，脏数据由监控中心删除</li>
</ul>
<h4><span id="2-是当服务状态改变时如何即时更新">2. 是当服务状态改变时如何即时更新？</span></h4><p>第二个问题 <strong>当提供者突然 宕机状态能即里变更吗</strong>？<br>这里Dubbo采用的是<strong>定时心跳的机制</strong> 来维护服务URL的有效期，默认<strong>每30秒更新一次有效期</strong>。即URL对应的毫秒值。具体代码参见：com.alibaba.dubbo.registry.redis.RedisRegistry#expireExecutor</p>
<p><img src="http://note.youdao.com/yws/res/9390/F32248B7D113492EBC48590051A3CD04" alt="image"></p>
<p>com.alibaba.dubbo.registry.redis.RedisRegistry#deferExpired<br>com.alibaba.dubbo.registry.integration.RegistryDirectory<br>com.alibaba.dubbo.registry.support.ProviderConsumerRegTable</p>
<h3><span id="zookeeper-注册中心"><strong>Zookeeper 注册中心</strong></span></h3><p>关于Zookeeper 注册中心同样需要了解其存储结构和更新机制。<br>Zookeper是一个树型的目录服务，本身支持变更推送相比 redis 的实现 Publish/Subscribe 功能更稳定。</p>
<ol>
<li>Provider和Consumer向Zookeeper注册临时节点，当连接断开时删除相应的注册节点。</li>
<li>Consumer订阅 Providers节点的子节点，通过 watch 事件，当 Zookeeper 删除临时节点时，实时感知 Provider 的变化情况，实时同步自身的Invoker对象，保证 RPC的可用性。</li>
</ol>
<p>结构：</p>
<p><img src="http://note.youdao.com/yws/res/9425/D8B581F4BF944E94AF6382ECA1CB770F" alt="image"></p>
<h4><span id="源码查看">源码查看</span></h4><pre class="line-numbers language-java"><code class="language-java"> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doRegister</span><span class="token punctuation">(</span>URL url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            zkClient<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">toUrlPath</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>DYNAMIC_KEY<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">"Failed to register "</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">" to zookeeper "</span> <span class="token operator">+</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">create</span><span class="token punctuation">(</span>String path<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ephemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ephemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkExists</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 把前面的先创建好   dubbo/com.xx.xx/providers</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 创建持久节点</span>
            <span class="token function">create</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ephemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//创建一个临时节点,node 节点（保存具体地址）。</span>
            <span class="token function">createEphemeral</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 创建持久节点</span>
            <span class="token function">createPersistent</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>失败重连：</strong><br>com.alibaba.dubbo.registry.support.FailbackRegistry</p>
<p><strong>提供者突然断开：</strong><br>存储基于Zookeeper 临时节点机制实现，在客户端会话超时后（默认为40秒） Zookeeper 会自动删除所有临时节点。 </p>
<pre><code>// 创建临时节点
com.alibaba.dubbo.remoting.zookeeper.curator.CuratorZookeeperClient#createEphemeral
</code></pre><p><strong>在 zookeeper 断开的40秒内 如果 有客户端加入 会调用 已失效的提供者连接吗？</strong></p>
<blockquote>
<p>答：不会，提供者宕机后 ，其与客户端的链接也随即断开，客户端在调用前会检测长连接是否可用状态的方法。</p>
<pre><code>// 检测连接是否有效
 com.alibaba.dubbo.rpc.protocol.dubbo.DubboInvoker#isAvailable
</code></pre></blockquote>
<p>创建 configurators与 routers  会通过 <strong>持久节点</strong>来创建, 比如：“dubbo/com.xx.xx/providers”</p>
<pre><code>com.alibaba.dubbo.remoting.zookeeper.curator.CuratorZookeeperClient#createPersistent
</code></pre><p><strong>服务订阅机制实现：</strong></p>
<pre><code>// 注册目录
com.alibaba.dubbo.registry.integration.RegistryDirectory
</code></pre><p><img src="http://note.youdao.com/yws/res/9435/7903EF7E728C436EBABA5AB637CB1588" alt="image"></p>
<h2><span id="三-dubbo-调用模块">三、 Dubbo 调用模块</span></h2><p>dubbo调用模块核心功能是发起一个远程方法的调用并顺利拿到返回结果，其体系组成如下：</p>
<ol>
<li><strong>透明代理：</strong> 通过动态代理技术，屏蔽远程调用细节以提高编程友好性。</li>
<li><strong>负载均衡：</strong> 当有多个提供者是，如何选择哪个进行调用的负载算法。</li>
<li><strong>容错机制：</strong> 当服务调用失败时采取的策略</li>
<li><strong>调用方式：</strong> 支持同步调用、异步调用</li>
</ol>
<p><img src="http://note.youdao.com/yws/res/9440/C29CEB5BE9E4479EA5988A07FC429C28" alt="image"></p>
<h3><span id="透明代理">透明代理：</span></h3><p>针对代理 dubbo 提供 三种方式：</p>
<p><img src="http://note.youdao.com/yws/res/9448/BCE9E2B8BB9F4E1DBE9E0249FCE1D4C7" alt="image"></p>
<p>默认方式是：</p>
<pre><code>    public static final String DEFAULT_PROXY = &quot;javassist&quot;;

</code></pre><p>调用链如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token operator">></span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ReferenceConfig#createProxy

<span class="token operator">--</span><span class="token operator">></span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>javassist<span class="token punctuation">.</span>JavassistProxyFactory

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">></span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span>bytecode<span class="token punctuation">.</span>Proxy#<span class="token function">getProxy</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ClassLoader<span class="token punctuation">,</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">></span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span>bytecode<span class="token punctuation">.</span>ClassGenerator#<span class="token function">newInstance</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ClassLoader<span class="token punctuation">)</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="http://note.youdao.com/yws/res/9461/2835D117E1FE424F84ED8907FC986A2B" alt="image"></p>
<p><img src="http://note.youdao.com/yws/res/9451/5B1BA7C374ED444DAFD557DF5055D4D9" alt="image"></p>
<p><img src="http://note.youdao.com/yws/res/9453/B8DCD49FB51847ED97BBA2C316A5BCDF" alt="image"></p>
<p><img src="http://note.youdao.com/yws/res/9463/E7EF7C875FBD48A4B2037B3A74D5BC62" alt="image"></p>
<h3><span id="负载均衡"><strong>负载均衡</strong></span></h3><p>Dubbo 目前官方支持以下负载均衡策略：</p>
<ol>
<li><strong>随机</strong>(random)：按权重设置随机概率。此为默认算法.</li>
<li><strong>轮循</strong>(roundrobin):按公约后的权重设置轮循比率。</li>
<li><strong>最少活跃调用数</strong>(leastactive):相同活跃数的随机，活跃数指调用前后计数差。</li>
<li><strong>一致性Hash</strong>(consistenthash ):相同的参数总是发到同一台机器</li>
</ol>
<p><img src="http://note.youdao.com/yws/res/9468/EDE99CF742414CB5921E56E2BD341282" alt="image"><br>设置方式支持如下四种方式设置，优先级由低至高</p>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- 服务端级别--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>service</span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span> <span class="token attr-name">loadbalance</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roundrobin<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token comment" spellcheck="true">&lt;!-- 客户端级别--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span> <span class="token attr-name">loadbalance</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roundrobin<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token comment" spellcheck="true">&lt;!-- 服务端方法级别--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>service</span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span> <span class="token attr-name">loadbalance</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roundrobin<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">dubbo:</span>service</span><span class="token punctuation">></span></span>
<span class="token comment" spellcheck="true">&lt;!-- 客户端方法级别--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span> <span class="token attr-name">loadbalance</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roundrobin<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">dubbo:</span>reference</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3><span id="容错"><strong>容错</strong></span></h3><p>Dubbo 官方目前支持以下容错策略：</p>
<ol>
<li><strong>失败自动切换：</strong> 调用失败后基于retries=“2” 属性重试其它服务器</li>
<li><strong>快速失败：</strong> 快速失败，只发起一次调用，失败立即报错。</li>
<li><strong>勿略失败：</strong> 失败后勿略，不抛出异常给客户端。</li>
<li><strong>失败重试：</strong> 失败自动恢复，后台记录失败请求，定时重发。通常用于消息通知操作</li>
<li><strong>并行调用:</strong> 只要一个成功即返回，并行调用指定数量机器，可通过 forks=”2” 来设置最大并行数。</li>
<li><strong>广播调用：</strong> 广播调用所有提供者，逐个调用，任意一台报错则报错</li>
</ol>
<p><img src="http://note.youdao.com/yws/res/9473/CD04A0766E944919A0D62EBFE9F964C6" alt="image"><br>设置方式支持如下两种方式设置，优先级由低至高</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>
Failover 失败自动切换 retries<span class="token operator">=</span><span class="token string">"1"</span> 切换次数
Failfast 快速失败
Failsafe 勿略失败
Failback 失败重试，<span class="token number">5</span>秒后仅重试一次
Forking 并行调用 forks<span class="token operator">=</span><span class="token string">"2"</span> 最大并行数
Broadcast 广播调用
<span class="token operator">--</span><span class="token operator">></span>
<span class="token operator">&lt;</span>dubbo<span class="token operator">:</span>service <span class="token keyword">interface</span><span class="token operator">=</span><span class="token string">"..."</span> cluster<span class="token operator">=</span><span class="token string">"broadcast"</span> <span class="token operator">/</span><span class="token operator">></span>
<span class="token operator">&lt;</span>dubbo<span class="token operator">:</span>reference <span class="token keyword">interface</span><span class="token operator">=</span><span class="token string">"..."</span> cluster<span class="token operator">=</span><span class="token string">"broadcast"</span><span class="token operator">/</span> <span class="token operator">></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注：容错机制 在基于 API设置时无效 如  referenceConfig.setCluster(“failback”); 经测试不启作用 </p>
<h3><span id="异步调用"><strong>异步调用</strong></span></h3><p>异步调用是指发起远程调用之后获取结果的方式。</p>
<ol>
<li>同步等待结果返回（默认）</li>
<li>异步等待结果返回</li>
<li>不需要返回结果</li>
</ol>
<p><img src="http://note.youdao.com/yws/res/9475/F1C320C5A219405B8EFC66F1FE4CC78B" alt="image"></p>
<p>异步调用配置:</p>
<pre><code>&lt;dubbo:reference id=&quot;asyncDemoService&quot;
    interface=&quot;com.xxx.teach.service.async.AsyncDemoService&quot;&gt;
   &lt;!-- 异步调async：true 异步调用 false 同步调用--&gt;
   &lt;dubbo:method name=&quot;sayHello1&quot; async=&quot;false&quot;/&gt;
   &lt;dubbo:method name=&quot;sayHello2&quot; async=&quot;false&quot;/&gt;
   &lt;dubbo:method name=&quot;notReturn&quot; return=&quot;false&quot;/&gt;
&lt;/dubbo:reference&gt;
</code></pre><p>注：在进行异步调用时 容错机制不能为  cluster=”forking” 或  cluster=”broadcast”</p>
<p><em>异步调用结果获取Demo</em></p>
<pre class="line-numbers language-java"><code class="language-java">demoService<span class="token punctuation">.</span><span class="token function">sayHello1</span><span class="token punctuation">(</span><span class="token string">"han"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Future<span class="token operator">&lt;</span>Object<span class="token operator">></span> future1 <span class="token operator">=</span> RpcContext<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
demoService<span class="token punctuation">.</span><span class="token function">sayHello2</span><span class="token punctuation">(</span><span class="token string">"han2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Future<span class="token operator">&lt;</span>Object<span class="token operator">></span> future2 <span class="token operator">=</span> RpcContext<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Object r1 <span class="token operator">=</span> null<span class="token punctuation">,</span> r2 <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// wait 直到拿到结果 或超时</span>
r1 <span class="token operator">=</span> future1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// wait 直到拿到结果 或超时</span>
r2 <span class="token operator">=</span> future2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3><span id="过滤器"><strong>过滤器</strong></span></h3><p><strong> 类似于 WEB 中的Filter ，Dubbo本身提供了Filter 功能用于拦截远程方法的调用。其支持自定义过滤器与官方的过滤器使用：</strong></p>
<p>#TODO 演示添加日志访问过滤:</p>
<pre><code>&lt;dubbo:provider  filter=&quot;accesslog&quot; accesslog=&quot;logs/dubbo.log&quot;/&gt;
</code></pre><p>以上配置 就是 为 服务提供者 添加 日志记录过滤器， 所有访问日志将会集中打印至 accesslog 当中。</p>
<h2><span id="调用通信-内部实现原理">调用通信  内部实现原理</span></h2><p><img src="http://note.youdao.com/yws/res/9490/17E56F436154424BA5E8AAC97BD84B13" alt="image"></p>
<p><strong>IO模型：</strong></p>
<ol>
<li>BIO 同步阻塞</li>
<li>NIO 同步非阻塞</li>
<li>AIO 异步非阻塞</li>
</ol>
<p><strong>连接模型：</strong></p>
<ol>
<li>长连接</li>
<li>短连接</li>
</ol>
<p><strong>线程分类：</strong></p>
<ol>
<li>IO线程</li>
<li>服务端业务线程</li>
<li>客户端调度线程</li>
<li>客户端结果exchange线程。</li>
<li>保活心跳线程</li>
<li>重连线程</li>
</ol>
<p><strong>线程池模型：</strong></p>
<ol>
<li>固定数量线程池</li>
<li>缓存线程池</li>
<li>有限线程池</li>
</ol>
<h3><span id="dubbo-长连接实现与配置"><strong>Dubbo 长连接实现与配置</strong></span></h3><p><strong>初始连接：</strong></p>
<p>引用服务增加提供者 —&gt; 获取连接 –&gt; 是否获取共享连接 –&gt;创建连接客户端–&gt;开启心跳检测状态检查定时任务–&gt; 开启连接状态检测.</p>
<blockquote>
<p>com.alibaba.dubbo.rpc.protocol.dubbo.DubboProtocol#getClients</p>
</blockquote>
<p><strong>心跳发送：</strong><br>在创建一个连接客户端同时也会创建一个心跳客户端，客户端默认基于60秒发送一次心跳来保持连接的存活，可通过 heartbeat 设置。</p>
<blockquote>
<p>com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeClient#startHeatbeatTimer</p>
</blockquote>
<p><strong>断线重连：</strong><br>每创建一个客户端连接都会启动一个定时任务每两秒中检测一次当前连接状态，如果断线则自动重连。</p>
<blockquote>
<p>com.alibaba.dubbo.remoting.transport.AbstractClient#initConnectStatusCheckCommand</p>
</blockquote>
<p><strong>连接销毁:</strong><br>基于注册中心通知，服务端断开后销毁</p>
<blockquote>
<p>com.alibaba.dubbo.remoting.transport.AbstractClient#close()</p>
</blockquote>
<h3><span id="dubbo-传输协作线程"><strong>Dubbo 传输协作线程</strong></span></h3><ol>
<li><strong>客户端调度线程</strong>：用于发起远程方法调用的线程。</li>
<li><strong>客户端结果Exchange线程：</strong> 当远程方法返回response后由该线程填充至指定ResponseFuture，并叫醒等待的调度线程。</li>
<li><strong>客户端IO线程</strong> 由传输框架实现，用于request 消息流发送、response 消息流读取与解码等操作。</li>
<li><strong>服务端IO线程</strong>：由传输框架实现，用于request消息流读取与解码 与Response发送。</li>
<li><strong>业务执行线程：</strong> 服务端具体执行业务方法的线程</li>
</ol>
<p><strong>客户端线程协作：</strong><br><img src="http://note.youdao.com/yws/res/9495/9564293312B2420DB80E156C7FB00CF5" alt="image"></p>
<ol>
<li><strong>调度线程</strong><ol>
<li>调用远程方法</li>
<li>对request 进行协议编码</li>
<li>发送request 消息至IO线程</li>
<li>等待结果的获取</li>
</ol>
</li>
<li><strong>IO线程</strong><ol>
<li>读取response流</li>
<li>response 解码</li>
<li>提交Exchange 任务</li>
</ol>
</li>
<li><strong>Exchange线程</strong><ol>
<li>填写response值 至 ResponseFuture</li>
<li>唤醒调度线程，通知其获取结果</li>
</ol>
</li>
</ol>
<p><strong>服务端线程协作：</strong><br><img src="http://note.youdao.com/yws/res/9500/6E0C6D20EF8C4276B16C4BCF37D183CF" alt="image"></p>
<ol>
<li><strong>IO线程：</strong><ol>
<li>request 流读取</li>
<li>request 解码</li>
<li>提交业务处理任务</li>
</ol>
</li>
<li><strong>业务线程：</strong><ol>
<li>业务方法执行</li>
<li>response 编码</li>
<li>回写结果至channel</li>
</ol>
</li>
</ol>
<p><strong>线程池</strong></p>
<ol>
<li><strong>fixed：</strong> 固定线程池,此线程池启动时即创建固定大小的线程数，不做任何伸缩，</li>
<li><strong>cached：</strong> 缓存线程池,此线程池可伸缩，线程空闲一分钟后回收，新请求重新创建线程</li>
<li><strong>Limited：</strong> 有限线程池,此线程池一直增长，直到上限，增长后不收缩。</li>
</ol>
<h2><span id="四-dubbo-协议">四、Dubbo 协议</span></h2><h3><span id="rpc-协议名词解释"><strong>RPC 协议名词解释</strong></span></h3><p>在一个典型RPC的使用场景中，包含了服务发现、负载、容错、网络传输、序列化等组件，其中RPC协议就指明了程序如何进行网络传输和序列化 。也就是说一个RPC协议的实现就等于一个非透明的远程调用实现，如何做到的的呢？</p>
<p><img src="http://note.youdao.com/yws/res/9510/AFE8EDF1A5B0427FA856137A2B9C6B12" alt="image"></p>
<p><img src="http://note.youdao.com/yws/res/9512/35AAA35E698A442687702615820C1AD7" alt="image"></p>
<ol>
<li>地址：服务提供者地址</li>
<li>端口：协议指定开放的端口</li>
<li>报文编码：协议报文编码 ，分为请求头和请求体两部分。</li>
<li>序列化方式：将请求体序列化成对象<br><img src="http://note.youdao.com/yws/res/9516/A8AA0D50758B4D9BA51737391F3AE4CE" alt="image"></li>
<li>运行服务: 网络传输实现<br><img src="http://note.youdao.com/yws/res/9514/3DC6FD7E7BFB4F4786B0CCD6A9BF87DA" alt="image"></li>
</ol>
<h3><span id="dubbo-支持的rpc协议">dubbo 支持的RPC协议</span></h3><p><img src="http://note.youdao.com/yws/res/9523/DC0DB69BE0F449DF870E40A1093A57CC" alt="image"></p>
<table>
<thead>
<tr>
<th style="text-align:left"><strong>名称</strong></th>
<th style="text-align:left"><strong>实现描述</strong></th>
<th style="text-align:left"><strong>连接描述</strong></th>
<th style="text-align:left"><strong>适用场景</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>dubbo</strong></td>
<td style="text-align:left">传输服务: mina, netty(默认), grizzy序列化: hessian2(默认), java, fastjson自定义报文</td>
<td style="text-align:left">单个长连接NIO异步传输</td>
<td style="text-align:left">1、常规RPC调用2、传输数据量小3、提供者少于消费者</td>
</tr>
<tr>
<td style="text-align:left"><strong>rmi</strong></td>
<td style="text-align:left">传输：java rmi 服务序列化：java原生二进制序列化</td>
<td style="text-align:left">多个短连接BIO同步传输</td>
<td style="text-align:left">1、常规RPC调用2、与原RMI客户端集成3、可传少量文件4、不支持防火墙穿透</td>
</tr>
<tr>
<td style="text-align:left"><strong>hessian</strong></td>
<td style="text-align:left">传输服务：servlet容器序列化：hessian二进制序列化</td>
<td style="text-align:left">基于Http 协议传输，依懒servlet容器配置</td>
<td style="text-align:left">1、提供者多于消费者2、可传大字段和文件3、跨语言调用</td>
</tr>
<tr>
<td style="text-align:left"><strong>http</strong></td>
<td style="text-align:left">传输服务：servlet容器序列化：java原生二进制序列化</td>
<td style="text-align:left">依懒servlet容器配置</td>
<td style="text-align:left">1、数据包大小混合</td>
</tr>
<tr>
<td style="text-align:left"><strong>thrift</strong></td>
<td style="text-align:left">与thrift RPC 实现集成，并在其基础上修改了报文头</td>
<td style="text-align:left">长连接、NIO异步传输</td>
</tr>
</tbody>
</table>
<p><strong><em>关于RMI不支持防火墙穿透的补充说明：</em></strong><br>    原因在于RMI 底层实现中会有两个端口，一个是固定的用于服务发现的注册端口，另外会生成一个<strong><em>随机</em></strong>端口用于网络传输。因为这个随机端口就不能在防火墙中提前设置开放开。所以存在<em>防火墙穿透问题</em></p>
<h3><span id="协议的使用与配置"><strong>协议的使用与配置:</strong></span></h3><p>Dubbo框架配置协议非常方便，用户只需要在 provider 应用中 配置<em>&lt;**dubbo:protocol&gt;</em>元素即可。</p>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!--
 name: 协议名称 dubbo|rmi|hessian|http|
host:本机IP可不填，则系统自动获取
port：端口、填-1表示系统自动选择
server：运行服务 mina|netty|grizzy|servlet|jetty
 serialization：序列化方式 hessian2|java|compactedjava|fastjson
 详细配置参见dubbo 官网 dubbo.io
--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>protocol</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dubbo<span class="token punctuation">"</span></span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>192.168.0.11<span class="token punctuation">"</span></span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20880<span class="token punctuation">"</span></span> <span class="token attr-name">server</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>netty<span class="token punctuation">"</span></span>
 <span class="token attr-name">serialization</span><span class="token attr-value"><span class="token punctuation">=</span>“hessian2”</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span>“UTF-8”</span> <span class="token punctuation">/></span></span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3><span id="dubbo-支持的序列化">dubbo 支持的序列化：</span></h3><table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">特点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">fastjson</td>
<td style="text-align:left">文本型：体积较大，性能慢、跨语言、可读性高</td>
</tr>
<tr>
<td style="text-align:left">fst</td>
<td style="text-align:left">二进制型：体积小、兼容 JDK 原生的序列化。要求 JDK 1.7 支持。</td>
</tr>
<tr>
<td style="text-align:left">hessian2</td>
<td style="text-align:left">二进制型：跨语言、容错性高、体积小</td>
</tr>
<tr>
<td style="text-align:left">java</td>
<td style="text-align:left">二进制型：在JAVA原生的基础上 可以写入Null</td>
</tr>
<tr>
<td style="text-align:left">compactedjava</td>
<td style="text-align:left">二进制型：与java 类似，内容做了压缩</td>
</tr>
<tr>
<td style="text-align:left">nativejava</td>
<td style="text-align:left">二进制型：原生的JAVA 序列化</td>
</tr>
<tr>
<td style="text-align:left">kryo</td>
<td style="text-align:left">二进制型：体积比hessian2 还要小，但容错性 没有hessian2 好</td>
</tr>
</tbody>
</table>
<h3><span id="hessian-序列化">Hessian 序列化</span></h3><ul>
<li>参数及返回值需实现 Serializable 接口</li>
<li>参数及返回值不能自定义实现 List,Map,Number,Date,Calendar等接口，只能用 JDK 自带的实现，因为 hessian 会做特殊处理，自定义实现类中的属性值都会丢失。</li>
<li>Hessian 序列化，只传成员属性值和值的类型，不传方法或静态变量，兼容情况 <a href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/dubbo.html#fn1" target="_blank" rel="noopener">[1]</a><a href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/dubbo.html#fn2" target="_blank" rel="noopener">[2]</a>：</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left"><strong>数据通讯</strong></th>
<th style="text-align:left"><strong>情况</strong></th>
<th style="text-align:left"><strong>结果</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">A-&gt;B</td>
<td style="text-align:left">类A多一种 属性（或者说类B少一种 属性）</td>
<td style="text-align:left">不抛异常，A多的那 个属性的值，B没有， 其他正常</td>
</tr>
<tr>
<td style="text-align:left">A-&gt;B</td>
<td style="text-align:left">枚举A多一种 枚举（或者说B少一种 枚举），A使用多 出来的枚举进行传输</td>
<td style="text-align:left">抛异常</td>
</tr>
<tr>
<td style="text-align:left">A-&gt;B</td>
<td style="text-align:left">枚举A多一种 枚举（或者说B少一种 枚举），A不使用 多出来的枚举进行传输</td>
<td style="text-align:left">不抛异常，B正常接 收数据</td>
</tr>
<tr>
<td style="text-align:left">A-&gt;B</td>
<td style="text-align:left">A和B的属性 名相同，但类型不相同</td>
<td style="text-align:left">抛异常</td>
</tr>
<tr>
<td style="text-align:left">A-&gt;B</td>
<td style="text-align:left">serialId 不相同</td>
<td style="text-align:left">正常传输</td>
</tr>
</tbody>
</table>
<blockquote>
<p>接口增加方法，对客户端无影响，如果该方法不是客户端需要的，客户端不需要重新部署。输入参数和结果集中增加属性，对客户端无影响，如果客户端并不需要新属性，不用重新部署。<br>输入参数和结果集属性名变化，对客户端序列化无影响，但是如果客户端不重新部署，不管输入还是输出，属性名变化的属性值是获取不到的。</p>
</blockquote>
<p>总结：服务器端和客户端对领域对象并不需要完全一致，而是按照最大匹配原则。</p>
<h2><span id="五-rpc协议报文编码与实现详解">五、RPC协议报文编码与实现详解</span></h2><h3><span id="rpc-传输实现"><strong>RPC 传输实现：</strong></span></h3><p>RPC的协议的传输是基于 TCP/IP 做为基础使用Socket 或Netty、mina等网络编程组件实现。但有个问题是TCP是面向字节流的无边边界协议，其只管负责数据传输并不会区分每次请求所对应的消息，这样就会出现TCP协义传输当中的拆包与粘包问题</p>
<h3><span id="拆包与粘包产生的原因"><strong>拆包与粘包产生的原因：</strong></span></h3><p>我们知道tcp是以流动的方式传输数据，传输的最小单位为一个报文段（segment）。tcp Header中有个Options标识位，常见的标识为mss(Maximum Segment Size)指的是，连接层每次传输的数据有个最大限制MTU(Maximum Transmission Unit)，一般是1500比特，超过这个量要分成多个报文段，mss则是这个最大限制减去TCP的header，光是要传输的数据的大小，一般为1460比特。换算成字节，也就是180多字节。</p>
<p>tcp为提高性能，发送端会将需要发送的数据发送到缓冲区，等待缓冲区满了之后，再将缓冲中的数据发送到接收方。同理，接收方也有缓冲区这样的机制，来接收数据。这时就会出现以下情况：</p>
<ol>
<li>应用程序写入的数据大于MSS大小，这将会发生拆包。</li>
<li>应用程序写入数据小于MSS大小，这将会发生粘包。</li>
<li>接收方法不及时读取套接字缓冲区数据，这将发生粘包。</li>
</ol>
<h3><span id="拆包与粘包解决办法"><strong>拆包与粘包解决办法：</strong></span></h3><ol>
<li>设置定长消息，服务端每次读取既定长度的内容作为一条完整消息。</li>
<li>{“type”:”message”,”content”:”hello”}\n</li>
<li>使用带消息头的协议、消息头存储消息开始标识及消息长度信息，服务端获取消息头的时候解析出消息长度，然后向后读取该长度的内容。</li>
</ol>
<p><strong>比如：</strong> Http协议 heade 中的 Content-Length 就表示消息体的大小。</p>
<p><img src="http://note.youdao.com/yws/res/9536/1627E3D71B36459393AAD1066002AFE6" alt="image"></p>
<h3><span id="dubbo-协议报文编码">Dubbo 协议报文编码：</span></h3><p><strong>dubbo 协议报文编码：</strong></p>
<p><img src="http://note.youdao.com/yws/res/9538/25B9C2C5C20C46168D641144B2B6A07E" alt="image"></p>
<ul>
<li><strong>magic</strong>：类似java字节码文件里的魔数，用来判断是不是dubbo协议的数据包。魔数是常量0xdabb,用于判断报文的开始。</li>
<li><strong>flag</strong>：标志位, 一共8个地址位。低四位用来表示消息体数据用的序列化工具的类型（默认hessian），高四位中，第一位为1表示是request请求，第二位为1表示双向传输（即有返回response），第三位为1表示是心跳ping事件。</li>
<li><strong>status</strong>：状态位, 设置请求响应状态，dubbo定义了一些响应的类型。具体类型见 com.alibaba.dubbo.remoting.exchange.Response</li>
<li><strong>invoke id：</strong> 消息id, long 类型。每一个请求的唯一识别id（由于采用异步通讯的方式，用来把请求request和返回的response对应上）</li>
<li><strong>body length：</strong> 消息体 body 长度, int 类型，即记录Body Content有多少个字节。</li>
</ul>
<p><img src="http://note.youdao.com/yws/res/9542/B37D5C57C013452AA75C1DCB90F2766A" alt="image"></p>
<ul>
<li>com.alibaba.dubbo.rpc.protocol.dubbo.DubboCodec#encodeRequestData()</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encodeRequestData</span><span class="token punctuation">(</span>Channel channel<span class="token punctuation">,</span> ObjectOutput out<span class="token punctuation">,</span> Object data<span class="token punctuation">,</span> String version<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        RpcInvocation inv <span class="token operator">=</span> <span class="token punctuation">(</span>RpcInvocation<span class="token punctuation">)</span> data<span class="token punctuation">;</span>

         <span class="token comment" spellcheck="true">//版本号</span>
        out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//接口路径</span>
        out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span>inv<span class="token punctuation">.</span><span class="token function">getAttachment</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>PATH_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//接口版本</span>
        out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span>inv<span class="token punctuation">.</span><span class="token function">getAttachment</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>VERSION_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//方法名称</span>
        out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span>inv<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//参数类型</span>
        out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span>ReflectUtils<span class="token punctuation">.</span><span class="token function">getDesc</span><span class="token punctuation">(</span>inv<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//参数值</span>
        Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> inv<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> null<span class="token punctuation">)</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token function">encodeInvocationArgument</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> inv<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>inv<span class="token punctuation">.</span><span class="token function">getAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>com.alibaba.dubbo.rpc.protocol.dubbo.DubboCodec#encodeResponseData()</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encodeResponseData</span><span class="token punctuation">(</span>Channel channel<span class="token punctuation">,</span> ObjectOutput out<span class="token punctuation">,</span> Object data<span class="token punctuation">,</span> String version<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
      Result result <span class="token operator">=</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span> data<span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// currently, the version value in Response records the version of Request</span>
      <span class="token keyword">boolean</span> attach <span class="token operator">=</span> Version<span class="token punctuation">.</span><span class="token function">isSupportResponseAttatchment</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Throwable th <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>th <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Object ret <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              out<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>attach <span class="token operator">?</span> RESPONSE_NULL_VALUE_WITH_ATTACHMENTS <span class="token operator">:</span> RESPONSE_NULL_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              out<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>attach <span class="token operator">?</span> RESPONSE_VALUE_WITH_ATTACHMENTS <span class="token operator">:</span> RESPONSE_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
              out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          out<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>attach <span class="token operator">?</span> RESPONSE_WITH_EXCEPTION_WITH_ATTACHMENTS <span class="token operator">:</span> RESPONSE_WITH_EXCEPTION<span class="token punctuation">)</span><span class="token punctuation">;</span>
          out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>th<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>attach<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// returns current version of Response to consumer side.</span>
          result<span class="token punctuation">.</span><span class="token function">getAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>DUBBO_VERSION_KEY<span class="token punctuation">,</span> Version<span class="token punctuation">.</span><span class="token function">getProtocolVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>解码</p>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> Object <span class="token function">decodeBody</span><span class="token punctuation">(</span>Channel channel<span class="token punctuation">,</span> InputStream is<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> header<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">byte</span> flag <span class="token operator">=</span> header<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> proto <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> SERIALIZATION_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取 request id</span>
        <span class="token keyword">long</span> id <span class="token operator">=</span> Bytes<span class="token punctuation">.</span><span class="token function">bytes2long</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//判断是request 解码还是 response 解码</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> FLAG_REQUEST<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//客户端： 解码 response.</span>
            Response res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> FLAG_EVENT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                res<span class="token punctuation">.</span><span class="token function">setEvent</span><span class="token punctuation">(</span>Response<span class="token punctuation">.</span>HEARTBEAT_EVENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// get status.</span>
            <span class="token keyword">byte</span> status <span class="token operator">=</span> header<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            res<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> Response<span class="token punctuation">.</span>OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Object data<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">isHeartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        data <span class="token operator">=</span> <span class="token function">decodeHeartbeatData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>  CodecSupport<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is<span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">isEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        data <span class="token operator">=</span> <span class="token function">decodeEventData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>  CodecSupport<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is<span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        DecodeableRpcResult result<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>
                                Constants<span class="token punctuation">.</span>DECODE_IN_IO_THREAD_KEY<span class="token punctuation">,</span>
                                Constants<span class="token punctuation">.</span>DEFAULT_DECODE_IN_IO_THREAD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DecodeableRpcResult</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> res<span class="token punctuation">,</span> is<span class="token punctuation">,</span>
                                    <span class="token punctuation">(</span>Invocation<span class="token punctuation">)</span> <span class="token function">getRequestData</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            result<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DecodeableRpcResult</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> res<span class="token punctuation">,</span>
                                    <span class="token keyword">new</span> <span class="token class-name">UnsafeByteArrayInputStream</span><span class="token punctuation">(</span><span class="token function">readMessageData</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    <span class="token punctuation">(</span>Invocation<span class="token punctuation">)</span> <span class="token function">getRequestData</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        data <span class="token operator">=</span> result<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    res<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    res<span class="token punctuation">.</span><span class="token function">setErrorMessage</span><span class="token punctuation">(</span>CodecSupport<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is<span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Decode response failed: "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                res<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>Response<span class="token punctuation">.</span>CLIENT_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                res<span class="token punctuation">.</span><span class="token function">setErrorMessage</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 服务端 ：解码 request.</span>
            Request req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            req<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span>Version<span class="token punctuation">.</span><span class="token function">getProtocolVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            req<span class="token punctuation">.</span><span class="token function">setTwoWay</span><span class="token punctuation">(</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> FLAG_TWOWAY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> FLAG_EVENT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                req<span class="token punctuation">.</span><span class="token function">setEvent</span><span class="token punctuation">(</span>Request<span class="token punctuation">.</span>HEARTBEAT_EVENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                Object data<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">isHeartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    data <span class="token operator">=</span> <span class="token function">decodeHeartbeatData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> CodecSupport<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is<span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">isEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    data <span class="token operator">=</span> <span class="token function">decodeEventData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> CodecSupport<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is<span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    DecodeableRpcInvocation inv<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>
                            Constants<span class="token punctuation">.</span>DECODE_IN_IO_THREAD_KEY<span class="token punctuation">,</span>
                            Constants<span class="token punctuation">.</span>DEFAULT_DECODE_IN_IO_THREAD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        inv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DecodeableRpcInvocation</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> req<span class="token punctuation">,</span> is<span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        inv<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        inv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DecodeableRpcInvocation</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> req<span class="token punctuation">,</span>
                                <span class="token keyword">new</span> <span class="token class-name">UnsafeByteArrayInputStream</span><span class="token punctuation">(</span><span class="token function">readMessageData</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    data <span class="token operator">=</span> inv<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                req<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Decode request failed: "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// bad request</span>
                req<span class="token punctuation">.</span><span class="token function">setBroken</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                req<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> req<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="http://note.youdao.com/yws/res/9545/298139E160AA428486709FD4E1641C6A" alt="image"></p>
<h2><span id="六-最后">六、最后</span></h2><ol>
<li>负载均衡：多个机器调用哪一台?<blockquote>
<p>答：多种负载均衡策略。</p>
</blockquote>
</li>
<li>服务发现：怎样发现新的服务地址呢？<blockquote>
<p>答：服务注册与发现。</p>
</blockquote>
</li>
<li>健康检测：服务关宕机或恢复后怎么办？<blockquote>
<p>答：两种情况，消费者还是用老的请求，则</p>
</blockquote>
</li>
<li>容错：如果调用其中一台调用出错了怎么办？<blockquote>
<p>答：容错策略。</p>
</blockquote>
</li>
</ol>
<ul>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/quick-start.html" target="_blank" rel="noopener">Dubbo官方文档</a></li>
</ul>
<p></p></div><div class="share"><span>分享到</span>&nbsp;<span class="soc"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></span><span class="soc"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></span><span class="soc"><a href="http://twitter.com/home?status=https://brokge.github.io/2020/06/02/Dubbo详解/%20玉蘇子%20Dubbo详解" class="fa fa-twitter"></a></span></div><div class="pagination"><p class="clearfix"><span class="pre pagbuttons"><a role="navigation" href="/2020/06/04/Redis核心原理详解/" title="Redis核心原理详解"><i class="fa fa-angle-double-left"></i>&nbsp;上一篇: Redis核心原理详解</a></span><span>&nbsp;</span><span class="next pagbuttons"><a role="navigation" href="/2020/02/10/redis5集群搭建/" title="Redis5 集群搭建">下一篇: Redis5 集群搭建&nbsp;<i class="fa fa-angle-double-right"></i></a></span></p></div><div id="vcomments"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script type="text/javascript">(function(){
    new Valine({
    el: '#vcomments',
    appId: 'UmwJ3stwyISCG9WnW9Nc3SAN-gzGzoHsz',
    appKey: 'UKq878kYn6RXJWx34b77lma6'})
})();
</script></div></div></div><div class="visible-xs site-bottom-footer"><footer><p>&copy;&nbsp;2020&nbsp;<a target="_blank" href="https://brokge.github.io" rel="noopener noreferrer">brokge</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer><script type="text/javascript" id="maid-script" src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js?v=undefined"></script><script>if (window.mermaid) {
  var options = JSON.parse(document.getElementById('maid-script').getAttribute('mermaidoptioins'));
  mermaid.initialize(options);
}
 </script></div></div></div></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/google-analytics.js"></script><script src="/js/typography.js"></script></body></html>