<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ç‰è˜‡å­</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://brokge.github.io/"/>
  <updated>2020-09-04T03:23:00.351Z</updated>
  <id>https://brokge.github.io/</id>
  
  <author>
    <name>brokge</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Spring cloud FeignåŸç†åˆ†æ</title>
    <link href="https://brokge.github.io/2020/09/04/Spring-cloud-Feign%E5%AE%9E%E8%B7%B5/"/>
    <id>https://brokge.github.io/2020/09/04/Spring-cloud-Feignå®è·µ/</id>
    <published>2020-09-04T02:46:41.000Z</published>
    <updated>2020-09-04T03:23:00.351Z</updated>
    
    <content type="html"><![CDATA[<p>Feignæ˜¯ä¸€ä¸ªhttpè¯·æ±‚è°ƒç”¨çš„è½»é‡çº§æ¡†æ¶ï¼Œå¯ä»¥ä»¥Javaæ¥å£æ³¨è§£çš„æ–¹å¼è°ƒç”¨Httpè¯·æ±‚ã€‚Spring Cloudå¼•å…¥ Feignå¹¶ä¸”é›†æˆäº†Ribbonå®ç°å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡è°ƒç”¨ã€‚<br>é›†æˆ Hystrix å®ç°å®¢æˆ·ç«¯é™æµé™çº§ã€‚<br>å°è£…äº†Httpè°ƒç”¨æµç¨‹ï¼Œæ›´é€‚åˆé¢å‘æ¥å£åŒ–çš„å˜æˆä¹ æƒ¯ã€‚</p><a id="more"></a><p>Spring Cloud  å¯¹ Feign çš„å¢å¼ºå’Œæ”¹é€ ï¼š</p><ol><li>å°† Spring MVC çš„æ³¨è§£ä¸ Feign å®¢æˆ·ç«¯çš„å®šä¹‰è¿›è¡Œäº†ç»“åˆã€‚</li><li>æ”¯æŒä½¿ç”¨ Spring Web ä¸­çš„ HttpMessageConverterså¯¹è¯·æ±‚å’Œå“åº”è¿›è¡Œç¼–ç å·¥ä½œã€‚</li></ol><h1 id="1-é›†æˆç¤ºä¾‹"><a href="#1-é›†æˆç¤ºä¾‹" class="headerlink" title="1. é›†æˆç¤ºä¾‹"></a>1. é›†æˆç¤ºä¾‹</h1><ol><li><p>å¼•å…¥ SpringCloudå…³äº Feignçš„ç›¸å…³ä¾èµ–</p><pre><code>&lt;dependency&gt;  &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;  &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;&lt;/dependency&gt;</code></pre></li><li><p>å¯åŠ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ @EnableFeignClients</p><pre><code>@SpringBootApplication@EnableFeignClientspublic class SpringCloudFeignApplication { public static void main(String[] args) {     SpringApplication.run(SpringCloudFeignApplication.class, args); }}</code></pre></li><li><p>åˆ›å»ºæ¥å£ interface,å¹¶ä½¿ç”¨ @FeignClient æ³¨è§£æ ‡æ³¨</p></li></ol><pre><code>@Component//fallback åœ¨demoä¸­å¯ä»¥å»æ‰@FeignClient(name=&quot;userServer&quot;,fallback = UserServerFallback.class)public interface HelloDemoService {    @RequestMapping(value = &quot;&quot;,method = RequestMethod.GET)    public String index();    @RequestMapping(value = &quot;/user&quot;,method = RequestMethod.GET)    public String getName(@RequestParam(&quot;name&quot;) String name);    @Body(&quot;%7B\&quot;name\&quot;:\&quot;{name}\&quot;%7D&quot;)    @RequestMapping(value = &quot;/test-user&quot;,method = RequestMethod.POST)    public String testName(@Param(&quot;name&quot;)String name);}</code></pre><ol start="4"><li>æ¥å£è°ƒç”¨</li></ol><pre><code>@RestControllerpublic class DemoController {    @Autowired    HelloDemoService helloDemoService;    @GetMapping(&quot;index&quot;)    public Object getIndex(){        return helloDemoService.index();     }    @GetMapping(&quot;/find-user&quot;)    public Object getUser(@RequestParam(&quot;name&quot;)String name){        // å’Œæ™®é€šæ–¹æ³•ä¸€æ ·è°ƒç”¨        return helloDemoService.getName(name);    }    @GetMapping(&quot;/set-user&quot;)    public Object setUser(@RequestParam(&quot;name&quot;)String name){        // å’Œæ™®é€šçš„æ–¹æ³•ä¸€æ ·è°ƒç”¨        return helloDemoService.getName(name);    }}</code></pre><ol start="5"><li><p>æ–°åˆ›å»ºä¸€ä¸ª module </p><pre><code>spring:application: name: userServer</code></pre></li><li><p>åœ¨ userServer ä¸­åˆ›å»ºä¸€ä¸ª controller</p><pre><code>@RestControllerpublic class UserController { @GetMapping(&quot;&quot;) public String index() throws InterruptedException {     Random random = new Random();     int timeOut = random.nextInt(150);     System.out.println(&quot;å½“å‰çº¿ç¨‹ä¼‘çœ æ—¶é—´æ˜¯:&quot;+timeOut);     Thread.sleep(timeOut);     String str =  &quot;è¿™æ˜¯æœåŠ¡ç«¯1è¿”å›çš„åº”ç­”&quot;;     return new String(str); } @GetMapping(&quot;user&quot;) public String getName(@RequestParam(&quot;name&quot;) String name){     return name; } @PostMapping(&quot;/find-user&quot;) public String getName(@RequestBody Map&lt;String,Object&gt; map){     return (String) map.get(&quot;name&quot;); }}</code></pre></li><li><p>å¯åŠ¨ userServer å’Œ é›†æˆ Feign çš„ Server.è¯·æ±‚ <code>localhost:8080\index</code></p></li></ol><h1 id="2-åŸç†åˆ†æ"><a href="#2-åŸç†åˆ†æ" class="headerlink" title="2. åŸç†åˆ†æ"></a>2. åŸç†åˆ†æ</h1><h2 id="1-å†…éƒ¨æ“ä½œæµç¨‹"><a href="#1-å†…éƒ¨æ“ä½œæµç¨‹" class="headerlink" title="1. å†…éƒ¨æ“ä½œæµç¨‹"></a>1. å†…éƒ¨æ“ä½œæµç¨‹</h2><p>æ•´ä½“æµç¨‹è¯·æ±‚<br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/33C8169A6EA1442C90CCC83C42CF3CFE.jpg" alt="image"></p><p>åœ¨å¾®æœåŠ¡å¯åŠ¨æ—¶ï¼ŒFeign ä¼šè¿›è¡ŒåŒ…æ‰«æï¼Œå¯¹åŠ  @FeignClient æ³¨è§£çš„æ¥å£ï¼ŒæŒ‰ç…§æ³¨è§£çš„è§„åˆ™ï¼Œåˆ›å»ºè¿œç¨‹æ¥å£çš„æœ¬åœ°JDK Proxyä»£ç†å®ä¾‹ã€‚ç„¶åï¼Œå°†è¿™äº›æœ¬åœ° Proxy ä»£ç†å®ä¾‹ï¼Œæ³¨å…¥åˆ°Spring IOCå®¹å™¨ä¸­ã€‚å½“è¿œç¨‹æ¥å£çš„æ–¹æ³•è¢«è°ƒç”¨ï¼Œç”± Proxy ä»£ç†å®ä¾‹å»å®Œæˆå¯¹å…¶ä»–æœåŠ¡çœŸæ­£çš„è¿œç¨‹è®¿é—®ï¼ˆä¹Ÿå°±æ˜¯ http è¯·æ±‚ï¼‰ï¼Œå¹¶ä¸”è¿”å›ç»“æœã€‚</p><p>å†…éƒ¨æµç¨‹å¤§æ¦‚å°±å¦‚ä¸Šæ‰€è¯‰ï¼ŒåŸç†éå¸¸ç®€å•ï¼Œä½†æ˜¯åœ¨ Feign å†…éƒ¨å®ç°å´å¾ˆå¤æ‚ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/3A6A4AD8528643E68BED64B25ECCFA7E.jpg" alt="image"><br>å¤æ‚çš„åœ°æ–¹ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><ol><li>é‡‡ç”¨ åŠ¨æ€ä»£ç†(JDK proxy).</li><li>è¯·æ±‚å¯¹è±¡çš„è½¬ç å’Œè¿”å›å¯¹è±¡çš„è§£ç </li><li>ä¸åŒ http æ¡†æ¶çš„æ”¯æŒã€‚</li><li>é’ˆå¯¹ æ–­è·¯å™¨çš„æ”¯æŒ(hystrix)ã€‚</li><li>é’ˆå¯¹ è´Ÿè½½å‡è¡¡çš„æ”¯æŒ(Ribbon)ã€‚</li><li>é’ˆå¯¹ æ—¥å¿—çš„å¤„ç†ã€‚</li></ol><p>ä¸‹é¢é’ˆå¯¹ä»¥ä¸Šå‡ ä¸ªæ–¹é¢åˆ†åˆ«è¯´æ˜</p><h2 id="2-1-JDK-Proxyä»£ç†"><a href="#2-1-JDK-Proxyä»£ç†" class="headerlink" title="2.1 JDK Proxyä»£ç†"></a>2.1 JDK Proxyä»£ç†</h2><p>è¿œç¨‹æ¥å£çš„æœ¬åœ°JDK Proxyä»£ç†å®ä¾‹ï¼Œæœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><ol><li><p>æˆ‘ä»¬é€šè¿‡ æ·»åŠ @EnableFeignClients æ³¨è§£ï¼Œè®© spring å¼€å¯ å¯¹@FeignClient æ³¨è§£çš„æ‰«æï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„ä»£ç†å®ä¾‹ï¼ˆè¿œç¨‹è°ƒç”¨æ¥å£ï¼‰</p></li><li><p>Proxyä»£ç†å®ä¾‹ï¼Œåœ¨å†…éƒ¨è¿›è¡ŒHTTPè¯·æ±‚çš„å°è£…ï¼Œä»¥åŠå‘é€HTTP è¯·æ±‚ï¼›</p></li><li><p>Proxyä»£ç†å®ä¾‹ï¼Œèƒ½å¤„ç†è¿œç¨‹HTTPè¯·æ±‚çš„å“åº”ï¼Œå¹¶ä¸”å®Œæˆç»“æœçš„è§£ç ï¼Œç„¶åè¿”å›ç»™è°ƒç”¨è€…ã€‚</p></li></ol><p>åœ¨ FeignClientsRegistrar.java ä¸­</p><pre><code>private void registerFeignClient(BeanDefinitionRegistry registry,AnnotationMetadata annotationMetadata, Map&lt;String, Object&gt; attributes) {    String className = annotationMetadata.getClassName();    BeanDefinitionBuilder definition = BeanDefinitionBuilder                .genericBeanDefinition(FeignClientFactoryBean.class);}</code></pre><p><strong>æœ¬è´¨é€šè¿‡ FeignClientFactoryBean.java ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œå¹¶äº¤ç»™springç®¡ç†ã€‚</strong><br>ä¸‹é¢è®©æˆ‘ä»¬æ¥çœ‹çœ‹ <code>FeginClientFactoryBean.java</code>å…³é”®ä»£ç ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> Object <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    FeignContext context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>FeignContext<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Feign<span class="token punctuation">.</span>Builder builder <span class="token operator">=</span> <span class="token function">feign</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/***çœç•¥éƒ¨åˆ†ä»£ç ***/</span>    Targeter targeter <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> Targeter<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> targeter<span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> builder<span class="token punctuation">,</span> context<span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">HardCodedTarget</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>getTarget() è°ƒç”¨ç›®æ ‡ <code>targeter.targetï¼ˆï¼‰</code>æ–¹æ³•ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯åœ¨ Feign ä¸­æœ‰ä¸¤ç§å®ç°ï¼Œ<code>DefaultTargeter</code> å’Œ <code>HystrixTrgeter</code> ä¸¤ç§å®ç°ï¼Œå…¶ä¸­ <code>HystrixTargeter</code>å®ç°ç›¸å¯¹å¤æ‚ï¼Œä½†æœ€ç»ˆéƒ½è°ƒç”¨äº†<code>Feign.Builder</code> çš„ <code>targetï¼ˆï¼‰</code>æ–¹æ³•ã€‚</p><p>ä»¥ä¸‹ä¸º <code>Feign.Builder</code>çš„ å…³é”®ä»£ç ï¼š</p><pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">target</span><span class="token punctuation">(</span>Target<span class="token operator">&lt;</span>T<span class="token operator">></span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> Feign <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    SynchronousMethodHandler<span class="token punctuation">.</span>Factory synchronousMethodHandlerFactory <span class="token operator">=</span>          <span class="token keyword">new</span> <span class="token class-name">SynchronousMethodHandler<span class="token punctuation">.</span>Factory</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> retryer<span class="token punctuation">,</span> requestInterceptors<span class="token punctuation">,</span> logger<span class="token punctuation">,</span>              logLevel<span class="token punctuation">,</span> decode404<span class="token punctuation">,</span> closeAfterDecode<span class="token punctuation">,</span> propagationPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>    ParseHandlersByName handlersByName <span class="token operator">=</span>          <span class="token keyword">new</span> <span class="token class-name">ParseHandlersByName</span><span class="token punctuation">(</span>contract<span class="token punctuation">,</span> options<span class="token punctuation">,</span> encoder<span class="token punctuation">,</span> decoder<span class="token punctuation">,</span> queryMapEncoder<span class="token punctuation">,</span>              errorDecoder<span class="token punctuation">,</span> synchronousMethodHandlerFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReflectiveFeign</span><span class="token punctuation">(</span>handlersByName<span class="token punctuation">,</span> invocationHandlerFactory<span class="token punctuation">,</span> queryMapEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€ç»ˆè°ƒç”¨çš„ <code>newInstanceï¼ˆï¼‰</code>æ–¹æ³•ï¼Œæ˜¯ <code>ReflectiveFeign.java</code> é‡Œé¢çš„å®ç°ã€‚</p><pre><code>  @Override  public &lt;T&gt; T newInstance(Target&lt;T&gt; target) {    Map&lt;String, MethodHandler&gt; nameToHandler = targetToHandlersByName.apply(target);    Map&lt;Method, MethodHandler&gt; methodToHandler = new LinkedHashMap&lt;Method, MethodHandler&gt;();    List&lt;DefaultMethodHandler&gt; defaultMethodHandlers = new LinkedList&lt;DefaultMethodHandler&gt;();    for (Method method : target.type().getMethods()) {      if (method.getDeclaringClass() == Object.class) {        continue;      } else if (Util.isDefault(method)) {        DefaultMethodHandler handler = new DefaultMethodHandler(method);        defaultMethodHandlers.add(handler);        methodToHandler.put(method, handler);      } else {        methodToHandler.put(method, nameToHandler.get(Feign.configKey(target.type(), method)));      }    }    InvocationHandler handler = factory.create(target, methodToHandler);    T proxy = (T) Proxy.newProxyInstance(target.type().getClassLoader(),        new Class&lt;?&gt;[] {target.type()}, handler);    for (DefaultMethodHandler defaultMethodHandler : defaultMethodHandlers) {      defaultMethodHandler.bindTo(proxy);    }    return proxy;  }</code></pre><p>ç»ˆäºï¼Œçœ‹åˆ°äº†ç†Ÿæ‚‰çš„ JDK Proxy åŠ¨æ€ä»£ç†ä»£ç ã€‚<br>ä»ä»£ç æ¥çœ‹åŒæ­¥æ–¹æ³•æ“ä½œè€…æ˜¯ <code>SynchronousMethodHandler.java</code> ï¼Œè¿™é‡Œæ˜¯å°è£…å…·ä½“è¯·æ±‚çš„å…³é”®ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>    RequestTemplate template <span class="token operator">=</span> buildTemplateFromArgs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>    Retryer retryer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>retryer<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">try</span> <span class="token punctuation">{</span>         <span class="token comment" spellcheck="true">// æ‰§è¡Œå¹¶è§£ç </span>        <span class="token keyword">return</span> <span class="token function">executeAndDecode</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RetryableException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>          retryer<span class="token punctuation">.</span><span class="token function">continueOrPropagate</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RetryableException</span> th<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token comment" spellcheck="true">//çœç•¥ä¸å…³é”®ä»£ç </span>        <span class="token keyword">continue</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-2-è¯·æ±‚å¯¹è±¡çš„è½¬ç å’Œè¿”å›å¯¹è±¡çš„è§£æè§£ç ã€‚"><a href="#2-2-è¯·æ±‚å¯¹è±¡çš„è½¬ç å’Œè¿”å›å¯¹è±¡çš„è§£æè§£ç ã€‚" class="headerlink" title="2.2 è¯·æ±‚å¯¹è±¡çš„è½¬ç å’Œè¿”å›å¯¹è±¡çš„è§£æè§£ç ã€‚"></a>2.2 è¯·æ±‚å¯¹è±¡çš„è½¬ç å’Œè¿”å›å¯¹è±¡çš„è§£æè§£ç ã€‚</h2><ol><li>é¦–å…ˆ Spring Cloud Feign æ”¯æŒå¯¹è¯·æ±‚å’Œå“åº”è¿›è¡ŒGZIPå‹ç¼©ï¼Œä»¥æé«˜é€šä¿¡æ•ˆç‡ã€‚<br>application.yml é…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š</li></ol><pre class="line-numbers language-xml"><code class="language-xml">feign:  compression:    request: #è¯·æ±‚      enabled: true #å¼€å¯      mime-types: text/xml,application/xml,application/json #å¼€å¯æ”¯æŒå‹ç¼©çš„MIME TYPE      min-request-size: 2048 #é…ç½®å‹ç¼©æ•°æ®å¤§å°çš„ä¸‹é™    response: #å“åº”      enabled: true #å¼€å¯å“åº”GZIPå‹ç¼©<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŒæ—¶è¦æ³¨æ„ï¼š</p><blockquote><p>ç”±äºå¼€å¯GZIPå‹ç¼©ä¹‹åï¼ŒFeignä¹‹é—´çš„è°ƒç”¨æ•°æ®é€šè¿‡äºŒè¿›åˆ¶åè®®è¿›è¡Œä¼ è¾“ï¼Œè¿”å›å€¼éœ€è¦ä¿®æ”¹ä¸ºResponseEntity&lt;byte[]&gt;æ‰å¯ä»¥æ­£å¸¸æ˜¾ç¤ºï¼Œå¦åˆ™ä¼šå¯¼è‡´æœåŠ¡ä¹‹é—´çš„è°ƒç”¨ä¹±ç ã€‚</p></blockquote><p>ä»£ç å¤§æ¦‚åƒä»¥ä¸‹è¿™æ ·å­ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/order/{productId}"</span><span class="token punctuation">)</span>ResponseEntity<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token function">addCart</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"productId"</span><span class="token punctuation">)</span> Long productId<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="2"><li>é’ˆå¯¹ encode å’Œ decode ä¹Ÿåšäº†æ”¯æŒ,åœ¨yaml é…ç½®æ–‡ä»¶ä¸­æœ‰è¿™æ ·</li></ol><pre class="line-numbers language-xml"><code class="language-xml">feign:  client:    config:      feignName:        connectTimeout: 5000        readTimeout: 5000        loggerLevel: full        errorDecoder: com.example.SimpleErrorDecoder        retryer: com.example.SimpleRetryer        requestInterceptors:          - com.example.FooRequestInterceptor          - com.example.BarRequestInterceptor        decode404: false        encoder: com.example.SimpleEncoder        decoder: com.example.SimpleDecoder        contract: com.example.SimpleContract<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹Ÿå¯ä»¥é€šè¿‡æ‰‹åŠ¨æ–¹å¼ï¼Œåœ¨ä»£ç ä¸­ç›´æ¥é…ç½®</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span>FeignClientsConfiguration<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">FooController</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> FooClient fooClient<span class="token punctuation">;</span>    <span class="token keyword">private</span> FooClient adminClient<span class="token punctuation">;</span>        <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">public</span> <span class="token function">FooController</span><span class="token punctuation">(</span>Decoder decoder<span class="token punctuation">,</span> Encoder encoder<span class="token punctuation">,</span> Client client<span class="token punctuation">,</span> Contract contract<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>fooClient <span class="token operator">=</span> Feign<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">encoder</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">decoder</span><span class="token punctuation">(</span>decoder<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">contract</span><span class="token punctuation">(</span>contract<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BasicAuthRequestInterceptor</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span>FooClient<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"https://PROD-SVC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>adminClient <span class="token operator">=</span> Feign<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">encoder</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">decoder</span><span class="token punctuation">(</span>decoder<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">contract</span><span class="token punctuation">(</span>contract<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BasicAuthRequestInterceptor</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">,</span> <span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span>FooClient<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"https://PROD-SVC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-3-ä¸åŒ-http-æ¡†æ¶çš„æ”¯æŒ"><a href="#2-3-ä¸åŒ-http-æ¡†æ¶çš„æ”¯æŒ" class="headerlink" title="2.3 ä¸åŒ http æ¡†æ¶çš„æ”¯æŒ"></a>2.3 ä¸åŒ http æ¡†æ¶çš„æ”¯æŒ</h2><p>Feign é»˜è®¤åº•å±‚é€šè¿‡JDK çš„ java.net.HttpURLConnection å®ç°äº†feign.Clientæ¥å£ç±»,åœ¨æ¯æ¬¡å‘é€è¯·æ±‚çš„æ—¶å€™ï¼Œéƒ½ä¼šåˆ›å»ºæ–°çš„HttpURLConnectioné“¾æ¥ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆé»˜è®¤æƒ…å†µä¸‹Feignçš„æ€§èƒ½å¾ˆå·®çš„åŸå› ã€‚å¯ä»¥é€šè¿‡æ‹“å±•è¯¥æ¥å£ï¼Œä½¿ç”¨Apache HttpClient æˆ–è€…OkHttp3ç­‰åŸºäºè¿æ¥æ± çš„é«˜æ€§èƒ½Httpå®¢æˆ·ç«¯ã€‚</p><p>Apacheæä¾›çš„HttpClientæ¡†æ¶ç›¸æ¯”ä¼ ç»ŸJDKè‡ªå¸¦çš„HttpURLConnectionï¼Œå®ƒå°è£…äº†è®¿é—®httpçš„è¯·æ±‚å¤´ï¼Œå‚æ•°ï¼Œå†…å®¹ä½“ï¼Œå“åº”ç­‰ç­‰ï¼›å®ƒä¸ä»…ä½¿å®¢æˆ·ç«¯å‘é€HTTPè¯·æ±‚å˜å¾—å®¹æ˜“ï¼Œè€Œä¸”ä¹Ÿæ–¹ä¾¿äº†å¼€å‘äººå‘˜æµ‹è¯•æ¥å£ï¼ˆåŸºäºHttpåè®®çš„ï¼‰ï¼Œå³æé«˜äº†å¼€å‘çš„æ•ˆç‡ï¼Œä¹Ÿæ–¹ä¾¿æé«˜ä»£ç çš„å¥å£®æ€§ï¼›å¦å¤–é«˜å¹¶å‘å¤§é‡çš„è¯·æ±‚ç½‘ç»œçš„æ—¶å€™ï¼Œè¿˜æ˜¯ç”¨â€œHTTPè¿æ¥æ± â€æå‡ååé‡ã€‚</p><p>OKHttp æ˜¯ä¸€ä¸ªå¤„ç†ç½‘ç»œè¯·æ±‚çš„å¼€æºé¡¹ç›®,æ˜¯å®‰å“ç«¯å¸¸ç”¨çš„è½»é‡çº§æ¡†æ¶ã€‚OKHttpæ‹¥æœ‰å…±äº«Socket,å‡å°‘å¯¹æœåŠ¡å™¨çš„è¯·æ±‚æ¬¡æ•°ï¼Œé€šè¿‡è¿æ¥æ± ,å‡å°‘äº†è¯·æ±‚å»¶è¿Ÿç­‰æŠ€æœ¯ç‰¹ç‚¹ã€‚</p><p>ä½¿ç”¨Feign å†…éƒ¨çš„ HttpClient æˆ– okhttp çš„æ–¹å¼ï¼š</p><pre class="line-numbers language-xml"><code class="language-xml">feign.httpclient.enabled = truefeign.okhttp.enabled = true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="2-4-é’ˆå¯¹-æ–­è·¯å™¨çš„æ”¯æŒ-hystrix"><a href="#2-4-é’ˆå¯¹-æ–­è·¯å™¨çš„æ”¯æŒ-hystrix" class="headerlink" title="2.4 é’ˆå¯¹ æ–­è·¯å™¨çš„æ”¯æŒ(hystrix)"></a>2.4 é’ˆå¯¹ æ–­è·¯å™¨çš„æ”¯æŒ(hystrix)</h2><p>Feign é»˜è®¤æ˜¯ä¸å¼€å¯ Hystrix çš„ã€‚é»˜è®¤ä¸ºï¼šfalseã€‚</p><p>å¼€å¯éœ€è¦åœ¨yamlæ–‡ä»¶è¿›è¡Œé…ç½®</p><pre class="line-numbers language-xml"><code class="language-xml">feign.hystrix.enabled=true<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æºç ä½“ç°åœ¨FeignClientsConfiguration.javaä¸­</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Configuration</span>    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> HystrixCommand<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> HystrixFeign<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">HystrixFeignConfiguration</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Bean</span>        <span class="token annotation punctuation">@Scope</span><span class="token punctuation">(</span><span class="token string">"prototype"</span><span class="token punctuation">)</span>        <span class="token annotation punctuation">@ConditionalOnMissingBean</span>        <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"feign.hystrix.enabled"</span><span class="token punctuation">)</span>        <span class="token keyword">public</span> Feign<span class="token punctuation">.</span>Builder <span class="token function">feignHystrixBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> HystrixFeign<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŒæ—¶å®šä¹‰ fallback å¯¹é™çº§è¿›è¡Œå¤„ç†é€»è¾‘ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> HystrixClientFallback<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token keyword">protected</span> <span class="token keyword">interface</span> <span class="token class-name">HystrixClient</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"/hello"</span><span class="token punctuation">)</span>    Hello <span class="token function">iFailSometimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">HystrixClientFallback</span> <span class="token keyword">implements</span> <span class="token class-name">HystrixClient</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Hello <span class="token function">iFailSometimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Hello</span><span class="token punctuation">(</span><span class="token string">"fallback"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¼€å¯ä¹‹åæ—¢å¯ä»¥è¿›è¡Œ hystrix çš„å¸¸è§„é…ç½®ï¼Œè¯¦ç»†å¯ä»¥æŸ¥çœ‹ hystrix ç›¸å…³å†…å®¹ã€‚</p><h2 id="2-5-é’ˆå¯¹-æ—¥å¿—çš„å¤„ç†"><a href="#2-5-é’ˆå¯¹-æ—¥å¿—çš„å¤„ç†" class="headerlink" title="2.5 é’ˆå¯¹ æ—¥å¿—çš„å¤„ç†"></a>2.5 é’ˆå¯¹ æ—¥å¿—çš„å¤„ç†</h2><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">protected</span> Feign<span class="token punctuation">.</span>Builder <span class="token function">feign</span><span class="token punctuation">(</span>FeignContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        FeignLoggerFactory loggerFactory <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> FeignLoggerFactory<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Logger logger <span class="token operator">=</span> loggerFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// @formatter:off</span>        Feign<span class="token punctuation">.</span>Builder builder <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> Feign<span class="token punctuation">.</span>Builder<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">// required values</span>                <span class="token punctuation">.</span><span class="token function">logger</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">encoder</span><span class="token punctuation">(</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> Encoder<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">decoder</span><span class="token punctuation">(</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> Decoder<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">contract</span><span class="token punctuation">(</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> Contract<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// @formatter:on</span>        <span class="token function">configureFeign</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> builder<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> builder<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é»˜è®¤å®ç°æ˜¯ <code>DefaultFeignLoggerFactory</code></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul><li><a href="https://docs.spring.io/spring-cloud-openfeign/docs/2.2.5.RELEASE/reference/html/#configuration-properties">https://docs.spring.io/spring-cloud-openfeign/docs/2.2.5.RELEASE/reference/html/#configuration-properties</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Feignæ˜¯ä¸€ä¸ªhttpè¯·æ±‚è°ƒç”¨çš„è½»é‡çº§æ¡†æ¶ï¼Œå¯ä»¥ä»¥Javaæ¥å£æ³¨è§£çš„æ–¹å¼è°ƒç”¨Httpè¯·æ±‚ã€‚Spring Cloudå¼•å…¥ Feignå¹¶ä¸”é›†æˆäº†Ribbonå®ç°å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡è°ƒç”¨ã€‚&lt;br&gt;é›†æˆ Hystrix å®ç°å®¢æˆ·ç«¯é™æµé™çº§ã€‚&lt;br&gt;å°è£…äº†Httpè°ƒç”¨æµç¨‹ï¼Œæ›´é€‚åˆé¢å‘æ¥å£åŒ–çš„å˜æˆä¹ æƒ¯ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="å¾®æœåŠ¡" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
    
      <category term="Java" scheme="https://brokge.github.io/tags/Java/"/>
    
      <category term="Spring Cloud" scheme="https://brokge.github.io/tags/Spring-Cloud/"/>
    
  </entry>
  
  <entry>
    <title>Rocket MQ æ‰«ç›²</title>
    <link href="https://brokge.github.io/2020/08/23/Rocket-MQ-%E6%89%AB%E7%9B%B2/"/>
    <id>https://brokge.github.io/2020/08/23/Rocket-MQ-æ‰«ç›²/</id>
    <published>2020-08-23T10:52:48.000Z</published>
    <updated>2020-08-23T10:57:12.522Z</updated>
    
    <content type="html"><![CDATA[<p>æ–‡ç« æ¥æº  <a href="https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247485969&idx=1&sn=6bd53abde30d42a778d5a35ec104428c&chksm=cea245daf9d5cccce631f93115f0c2c4a7634e55f5bef9009fd03f5a0ffa55b745b5ef4f0530&token=294077121&lang=zh_CN#rd">FrancisQ è€å“¥</a></p><p>æ¶ˆæ¯é˜Ÿåˆ—é¡¾åæ€ä¹‰å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—æˆ‘å°±ä¸è§£é‡Šäº†ï¼Œåˆ«å‘Šè¯‰æˆ‘ä½ è¿é˜Ÿåˆ—éƒ½ä¸çŸ¥é“ä¼¼å•¥å§ï¼Ÿ</p><a id="more"></a><h2 id="æ¶ˆæ¯é˜Ÿåˆ—æ‰«ç›²"><a href="#æ¶ˆæ¯é˜Ÿåˆ—æ‰«ç›²" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—æ‰«ç›²"></a>æ¶ˆæ¯é˜Ÿåˆ—æ‰«ç›²</h2><p>æ‰€ä»¥é—®é¢˜å¹¶ä¸æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä»€ä¹ˆï¼Œè€Œæ˜¯ <strong>æ¶ˆæ¯é˜Ÿåˆ—ä¸ºä»€ä¹ˆä¼šå‡ºç°ï¼Ÿæ¶ˆæ¯é˜Ÿåˆ—èƒ½ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿç”¨å®ƒæ¥å¹²è¿™äº›äº‹ä¼šå¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼Ÿæ¶ˆæ¯é˜Ÿåˆ—ä¼šå¸¦æ¥å‰¯ä½œç”¨å—ï¼Ÿ</strong></p><h3 id="æ¶ˆæ¯é˜Ÿåˆ—ä¸ºä»€ä¹ˆä¼šå‡ºç°ï¼Ÿ"><a href="#æ¶ˆæ¯é˜Ÿåˆ—ä¸ºä»€ä¹ˆä¼šå‡ºç°ï¼Ÿ" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—ä¸ºä»€ä¹ˆä¼šå‡ºç°ï¼Ÿ"></a>æ¶ˆæ¯é˜Ÿåˆ—ä¸ºä»€ä¹ˆä¼šå‡ºç°ï¼Ÿ</h3><p>æ¶ˆæ¯é˜Ÿåˆ—ç®—æ˜¯ä½œä¸ºåç«¯ç¨‹åºå‘˜çš„ä¸€ä¸ªå¿…å¤‡æŠ€èƒ½å§ï¼Œå› ä¸º<strong>åˆ†å¸ƒå¼åº”ç”¨å¿…å®šæ¶‰åŠåˆ°å„ä¸ªç³»ç»Ÿä¹‹é—´çš„é€šä¿¡é—®é¢˜</strong>ï¼Œè¿™ä¸ªæ—¶å€™æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿåº”è¿è€Œç”Ÿäº†ã€‚å¯ä»¥è¯´åˆ†å¸ƒå¼çš„äº§ç”Ÿæ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„åŸºç¡€ï¼Œè€Œåˆ†å¸ƒå¼æ€•æ˜¯ä¸€ä¸ªå¾ˆå¤è€çš„æ¦‚å¿µäº†å§ï¼Œæ‰€ä»¥æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¤è€çš„ä¸­é—´ä»¶äº†ã€‚</p><h3 id="æ¶ˆæ¯é˜Ÿåˆ—èƒ½ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿ"><a href="#æ¶ˆæ¯é˜Ÿåˆ—èƒ½ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—èƒ½ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿ"></a>æ¶ˆæ¯é˜Ÿåˆ—èƒ½ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿ</h3><h4 id="å¼‚æ­¥"><a href="#å¼‚æ­¥" class="headerlink" title="å¼‚æ­¥"></a>å¼‚æ­¥</h4><p>ä½ å¯èƒ½ä¼šåé©³æˆ‘ï¼Œåº”ç”¨ä¹‹é—´çš„é€šä¿¡åˆä¸æ˜¯åªèƒ½ç”±æ¶ˆæ¯é˜Ÿåˆ—è§£å†³ï¼Œå¥½å¥½çš„é€šä¿¡ä¸ºä»€ä¹ˆä¸­é—´éè¦æ’ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å‘¢ï¼Ÿæˆ‘ä¸èƒ½ç›´æ¥è¿›è¡Œé€šä¿¡å—ï¼Ÿ</p><p>å¾ˆå¥½ğŸ‘ï¼Œä½ åˆæå‡ºäº†ä¸€ä¸ªæ¦‚å¿µï¼Œ<strong>åŒæ­¥é€šä¿¡</strong>ã€‚å°±æ¯”å¦‚ç°åœ¨ä¸šç•Œä½¿ç”¨æ¯”è¾ƒå¤šçš„ <code>Dubbo</code> å°±æ˜¯ä¸€ä¸ªé€‚ç”¨äºå„ä¸ªç³»ç»Ÿä¹‹é—´åŒæ­¥é€šä¿¡çš„ <code>RPC</code> æ¡†æ¶ã€‚</p><p>æˆ‘æ¥ä¸¾ä¸ªğŸŒ°å§ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªè´­ç¥¨ç³»ç»Ÿï¼Œéœ€æ±‚æ˜¯ç”¨æˆ·åœ¨è´­ä¹°å®Œä¹‹åèƒ½æ¥æ”¶åˆ°è´­ä¹°å®Œæˆçš„çŸ­ä¿¡ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef37fee7e09230.jpg.jpg"></p><p>æˆ‘ä»¬çœç•¥ä¸­é—´çš„ç½‘ç»œé€šä¿¡æ—¶é—´æ¶ˆè€—ï¼Œå‡å¦‚è´­ç¥¨ç³»ç»Ÿå¤„ç†éœ€è¦ 150ms ï¼ŒçŸ­ä¿¡ç³»ç»Ÿå¤„ç†éœ€è¦ 200ms ï¼Œé‚£ä¹ˆæ•´ä¸ªå¤„ç†æµç¨‹çš„æ—¶é—´æ¶ˆè€—å°±æ˜¯ 150ms + 200ms = 350msã€‚</p><p>å½“ç„¶ï¼Œä¹çœ‹æ²¡ä»€ä¹ˆé—®é¢˜ã€‚å¯æ˜¯ä»”ç»†ä¸€æƒ³ä½ å°±æ„Ÿè§‰æœ‰ç‚¹é—®é¢˜ï¼Œæˆ‘ç”¨æˆ·è´­ç¥¨åœ¨è´­ç¥¨ç³»ç»Ÿçš„æ—¶å€™å…¶å®å°±å·²ç»å®Œæˆäº†è´­ä¹°ï¼Œè€Œæˆ‘ç°åœ¨é€šè¿‡åŒæ­¥è°ƒç”¨éè¦è®©æ•´ä¸ªè¯·æ±‚æ‹‰é•¿æ—¶é—´ï¼Œè€ŒçŸ­æ¯ç³»ç»Ÿè¿™ç©æ„åˆä¸æ˜¯å¾ˆæœ‰å¿…è¦ï¼Œå®ƒä»…ä»…æ˜¯ä¸€ä¸ªè¾…åŠ©åŠŸèƒ½å¢å¼ºç”¨æˆ·ä½“éªŒæ„Ÿè€Œå·²ã€‚æˆ‘ç°åœ¨æ•´ä¸ªè°ƒç”¨æµç¨‹å°±æœ‰ç‚¹ <strong>å¤´é‡è„šè½»</strong> çš„æ„Ÿè§‰äº†ï¼Œè´­ç¥¨æ˜¯ä¸€ä¸ªä¸å¤ªè€—æ—¶çš„æµç¨‹ï¼Œè€Œæˆ‘ç°åœ¨å› ä¸ºåŒæ­¥è°ƒç”¨ï¼Œéè¦ç­‰å¾…å‘é€çŸ­ä¿¡è¿™ä¸ªæ¯”è¾ƒè€—æ—¶çš„æ“ä½œæ‰è¿”å›ç»“æœã€‚é‚£æˆ‘å¦‚æœå†åŠ ä¸€ä¸ªå‘é€é‚®ä»¶å‘¢ï¼Ÿ</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef380429cf373e.jpg.jpg"></p><p>è¿™æ ·æ•´ä¸ªç³»ç»Ÿçš„è°ƒç”¨é“¾åˆå˜é•¿äº†ï¼Œæ•´ä¸ªæ—¶é—´å°±å˜æˆäº†550msã€‚</p><p>å½“æˆ‘ä»¬åœ¨å­¦ç”Ÿæ—¶ä»£éœ€è¦åœ¨é£Ÿå ‚æ’é˜Ÿçš„æ—¶å€™ï¼Œæˆ‘ä»¬å’Œé£Ÿå ‚å¤§å¦ˆå°±æ˜¯ä¸€ä¸ªåŒæ­¥çš„æ¨¡å‹ã€‚</p><p>æˆ‘ä»¬éœ€è¦å‘Šè¯‰é£Ÿå ‚å¤§å¦ˆï¼šâ€œå§å§ï¼Œç»™æˆ‘åŠ ä¸ªé¸¡è…¿ï¼Œå†åŠ ä¸ªé…¸è¾£åœŸè±†ä¸ï¼Œå¸®æˆ‘æµ‡ç‚¹æ±ä¸Šå»ï¼Œå¤šæ‰“ç‚¹é¥­å“¦ğŸ˜‹ğŸ˜‹ğŸ˜‹â€  å’¦<del>~</del> ä¸ºäº†å¤šåƒç‚¹ï¼ŒçœŸæ¶å¿ƒã€‚</p><p>ç„¶åå¤§å¦ˆå¸®æˆ‘ä»¬æ‰“é¥­é…èœï¼Œæˆ‘ä»¬çœ‹ç€å¤§å¦ˆé‚£é¢¤æŠ–çš„æ‰‹å’Œæ‰è½çš„åœŸè±†ä¸ä¸ç¦å’½äº†å’½å£æ°´ã€‚</p><p>æœ€ç»ˆæˆ‘ä»¬ä»å¤§å¦ˆæ‰‹ä¸­æ¥è¿‡é¥­èœç„¶åå»å¯»æ‰¾åº§ä½äº†â€¦</p><p>å›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬åœ¨ç»™å¤§å¦ˆå‘é€éœ€è¦çš„ä¿¡æ¯ä¹‹åæˆ‘ä»¬æ˜¯ <strong>åŒæ­¥ç­‰å¾…å¤§å¦ˆç»™æˆ‘é…å¥½é¥­èœ</strong> çš„ï¼Œä¸Šé¢æˆ‘ä»¬åªæ˜¯åŠ äº†é¸¡è…¿å’ŒåœŸè±†ä¸ï¼Œä¸‡ä¸€æˆ‘å†åŠ ä¸€ä¸ªç•ªèŒ„ç‰›è…©ï¼ŒéŸ­èœé¸¡è›‹ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯å¤§å¦ˆæ‰“é¥­é…èœçš„æµç¨‹å°±ä¼šå˜é•¿ï¼Œæˆ‘ä»¬ç­‰å¾…çš„æ—¶é—´ä¹Ÿä¼šç›¸åº”çš„å˜é•¿ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/006APoFYly1fvd9cwjlfrj30as0b03ym.jpg.jpg"></p><p>é‚£åæ¥ï¼Œæˆ‘ä»¬å·¥ä½œèµšé’±äº†æœ‰é’±å»é¥­åº—åƒé¥­äº†ï¼Œæˆ‘ä»¬å‘Šè¯‰æœåŠ¡å‘˜æ¥ä¸€ç¢—ç‰›è‚‰é¢åŠ ä¸ªè·åŒ…è›‹ <strong>(ä¼ è¾¾ä¸€ä¸ªæ¶ˆæ¯)</strong> ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥åœ¨é¥­æ¡Œä¸Šå®‰å¿ƒçš„ç©æ‰‹æœºäº† <strong>(å¹²è‡ªå·±å…¶ä»–äº‹æƒ…)</strong> ï¼Œç­‰åˆ°æˆ‘ä»¬çš„ç‰›è‚‰é¢ä¸Šäº†æˆ‘ä»¬å°±å¯ä»¥åƒäº†ã€‚è¿™å…¶ä¸­æˆ‘ä»¬ä¹Ÿå°±ä¼ è¾¾äº†ä¸€ä¸ªæ¶ˆæ¯ï¼Œç„¶åæˆ‘ä»¬åˆè½¬è¿‡å¤´å¹²å…¶ä»–äº‹æƒ…äº†ã€‚è¿™å…¶ä¸­è™½ç„¶åšé¢çš„æ—¶é—´æ²¡æœ‰å˜çŸ­ï¼Œä½†æ˜¯æˆ‘ä»¬åªéœ€è¦ä¼ è¾¾ä¸€ä¸ªæ¶ˆæ¯å°±å¯ä»¥çœ‹å…¶ä»–äº‹æƒ…äº†ï¼Œè¿™æ˜¯ä¸€ä¸ª <strong>å¼‚æ­¥</strong> çš„æ¦‚å¿µã€‚</p><p>æ‰€ä»¥ï¼Œä¸ºäº†è§£å†³è¿™ä¸€ä¸ªé—®é¢˜ï¼Œèªæ˜çš„ç¨‹åºå‘˜åœ¨ä¸­é—´ä¹ŸåŠ äº†ä¸ªç±»ä¼¼äºæœåŠ¡å‘˜çš„ä¸­é—´ä»¶â€”â€”æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥æŠŠæ¨¡å‹ç»™æ”¹é€ äº†ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef38124f55eaea.jpg.jpg"></p><p>è¿™æ ·ï¼Œæˆ‘ä»¬åœ¨å°†æ¶ˆæ¯å­˜å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¹‹åæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è¿”å›äº†(æˆ‘ä»¬å‘Šè¯‰æœåŠ¡å‘˜æˆ‘ä»¬è¦åƒä»€ä¹ˆç„¶åç©æ‰‹æœº)ï¼Œæ‰€ä»¥æ•´ä¸ªè€—æ—¶åªæ˜¯ 150ms + 10ms = 160msã€‚</p><blockquote><p>ä½†æ˜¯ä½ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ•´ä¸ªæµç¨‹çš„æ—¶é•¿æ˜¯æ²¡å˜çš„ï¼Œå°±åƒä½ ä»…ä»…å‘Šè¯‰æœåŠ¡å‘˜è¦åƒä»€ä¹ˆæ˜¯ä¸ä¼šå½±å“åˆ°åšé¢çš„é€Ÿåº¦çš„ã€‚</p></blockquote><h4 id="è§£è€¦"><a href="#è§£è€¦" class="headerlink" title="è§£è€¦"></a>è§£è€¦</h4><p>å›åˆ°æœ€åˆåŒæ­¥è°ƒç”¨çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å†™ä¸ªä¼ªä»£ç ç®€å•æ¦‚æ‹¬ä¸€ä¸‹ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef381a505d3e1f.jpg.jpg"></p><p>é‚£ä¹ˆç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬åˆæ·»åŠ äº†ä¸€ä¸ªå‘é€é‚®ä»¶ï¼Œæˆ‘ä»¬å°±å¾—é‡æ–°å»ä¿®æ”¹ä»£ç ï¼Œå¦‚æœæˆ‘ä»¬åˆåŠ ä¸€ä¸ªéœ€æ±‚ï¼šç”¨æˆ·è´­ä¹°å®Œè¿˜éœ€è¦ç»™ä»–åŠ ç§¯åˆ†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ˜¯ä¸æ˜¯åˆå¾—æ”¹ä»£ç ï¼Ÿ</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef381c4e1b1ac7.jpg.jpg"></p><p>å¦‚æœä½ è§‰å¾—è¿˜è¡Œï¼Œé‚£ä¹ˆæˆ‘è¿™ä¸ªæ—¶å€™ä¸è¦å‘é‚®ä»¶è¿™ä¸ªæœåŠ¡äº†å‘¢ï¼Œæˆ‘æ˜¯ä¸æ˜¯åˆå¾—æ”¹ä»£ç ï¼Œåˆå¾—é‡å¯åº”ç”¨ï¼Ÿ</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef381f273a66bd.jpg.jpg"></p><p>è¿™æ ·æ”¹æ¥æ”¹å»æ˜¯ä¸æ˜¯å¾ˆéº»çƒ¦ï¼Œé‚£ä¹ˆ <strong>æ­¤æ—¶æˆ‘ä»¬å°±ç”¨ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—åœ¨ä¸­é—´è¿›è¡Œè§£è€¦</strong> ã€‚ä½ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åé¢çš„å‘é€çŸ­ä¿¡ã€å‘é€é‚®ä»¶ã€æ·»åŠ ç§¯åˆ†ç­‰ä¸€äº›æ“ä½œéƒ½ä¾èµ–äºä¸Šé¢çš„ <code>result</code> ï¼Œè¿™ä¸œè¥¿æŠ½è±¡å‡ºæ¥å°±æ˜¯è´­ç¥¨çš„å¤„ç†ç»“æœå‘€ï¼Œæ¯”å¦‚è®¢å•å·ï¼Œç”¨æˆ·è´¦å·ç­‰ç­‰ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åé¢çš„ä¸€ç³»åˆ—æœåŠ¡éƒ½æ˜¯éœ€è¦åŒæ ·çš„æ¶ˆæ¯æ¥è¿›è¡Œå¤„ç†ã€‚æ—¢ç„¶è¿™æ ·ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥é€šè¿‡ <strong>â€œå¹¿æ’­æ¶ˆæ¯â€</strong> æ¥å®ç°ã€‚</p><p>æˆ‘ä¸Šé¢æ‰€è®²çš„â€œå¹¿æ’­â€å¹¶ä¸æ˜¯çœŸæ­£çš„å¹¿æ’­ï¼Œè€Œæ˜¯æ¥ä¸‹æ¥çš„ç³»ç»Ÿä½œä¸ºæ¶ˆè´¹è€…å» <strong>è®¢é˜…</strong> ç‰¹å®šçš„ä¸»é¢˜ã€‚æ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„ä¸»é¢˜å°±å¯ä»¥å«åš <code>è®¢ç¥¨</code> ï¼Œæˆ‘ä»¬è´­ä¹°ç³»ç»Ÿä½œä¸ºä¸€ä¸ªç”Ÿäº§è€…å»ç”Ÿäº§è¿™æ¡æ¶ˆæ¯æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åæ¶ˆè´¹è€…è®¢é˜…äº†è¿™ä¸ªä¸»é¢˜ï¼Œä¼šä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ‹‰å–æ¶ˆæ¯å¹¶æ¶ˆè´¹ã€‚å°±æ¯”å¦‚æˆ‘ä»¬åˆšåˆšç”»çš„é‚£å¼ å›¾ï¼Œä½ ä¼šå‘ç°ï¼Œåœ¨ç”Ÿäº§è€…è¿™è¾¹æˆ‘ä»¬åªéœ€è¦å…³æ³¨ <strong>ç”Ÿäº§æ¶ˆæ¯åˆ°æŒ‡å®šä¸»é¢˜ä¸­</strong> ï¼Œè€Œ <strong>æ¶ˆè´¹è€…åªéœ€è¦å…³æ³¨ä»æŒ‡å®šä¸»é¢˜ä¸­æ‹‰å–æ¶ˆæ¯</strong> å°±è¡Œäº†ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef382674b66892.jpg.jpg"></p><blockquote><p>å¦‚æœæ²¡æœ‰æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¯å½“ä¸€ä¸ªæ–°çš„ä¸šåŠ¡æ¥å…¥ï¼Œæˆ‘ä»¬éƒ½è¦åœ¨ä¸»ç³»ç»Ÿè°ƒç”¨æ–°æ¥å£ã€æˆ–è€…å½“æˆ‘ä»¬å–æ¶ˆæŸäº›ä¸šåŠ¡ï¼Œæˆ‘ä»¬ä¹Ÿå¾—åœ¨ä¸»ç³»ç»Ÿåˆ é™¤æŸäº›æ¥å£è°ƒç”¨ã€‚æœ‰äº†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ‘ä»¬åªéœ€è¦å…³å¿ƒæ¶ˆæ¯æ˜¯å¦é€è¾¾äº†é˜Ÿåˆ—ï¼Œè‡³äºè°å¸Œæœ›è®¢é˜…ï¼Œæ¥ä¸‹æ¥æ”¶åˆ°æ¶ˆæ¯å¦‚ä½•å¤„ç†ï¼Œæ˜¯ä¸‹æ¸¸çš„äº‹æƒ…ï¼Œæ— ç–‘æå¤§åœ°å‡å°‘äº†å¼€å‘å’Œè”è°ƒçš„å·¥ä½œé‡ã€‚</p></blockquote><h4 id="å‰Šå³°"><a href="#å‰Šå³°" class="headerlink" title="å‰Šå³°"></a>å‰Šå³°</h4><p>æˆ‘ä»¬å†æ¬¡å›åˆ°ä¸€å¼€å§‹æˆ‘ä»¬ä½¿ç”¨åŒæ­¥è°ƒç”¨ç³»ç»Ÿçš„æƒ…å†µï¼Œå¹¶ä¸”æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœæ­¤æ—¶æœ‰å¤§é‡ç”¨æˆ·è¯·æ±‚è´­ç¥¨æ•´ä¸ªç³»ç»Ÿä¼šå˜æˆä»€ä¹ˆæ ·ï¼Ÿ</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef382a9756bb1c.jpg.jpg"></p><p>å¦‚æœï¼Œæ­¤æ—¶æœ‰ä¸€ä¸‡çš„è¯·æ±‚è¿›å…¥è´­ç¥¨ç³»ç»Ÿï¼Œæˆ‘ä»¬çŸ¥é“è¿è¡Œæˆ‘ä»¬ä¸»ä¸šåŠ¡çš„æœåŠ¡å™¨é…ç½®ä¸€èˆ¬ä¼šæ¯”è¾ƒå¥½ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å‡è®¾è´­ç¥¨ç³»ç»Ÿèƒ½æ‰¿å—è¿™ä¸€ä¸‡çš„ç”¨æˆ·è¯·æ±‚ï¼Œé‚£ä¹ˆä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬åŒæ—¶ä¹Ÿä¼šå‡ºç°ä¸€ä¸‡è°ƒç”¨å‘çŸ­ä¿¡æœåŠ¡çš„è¯·æ±‚ã€‚è€Œå¯¹äºçŸ­ä¿¡ç³»ç»Ÿæ¥è¯´å¹¶ä¸æ˜¯æˆ‘ä»¬çš„ä¸»è¦ä¸šåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬é…å¤‡çš„ç¡¬ä»¶èµ„æºå¹¶ä¸ä¼šå¤ªé«˜ï¼Œé‚£ä¹ˆä½ è§‰å¾—ç°åœ¨è¿™ä¸ªçŸ­ä¿¡ç³»ç»Ÿèƒ½æ‰¿å—è¿™ä¸€ä¸‡çš„å³°å€¼ä¹ˆï¼Œä¸”ä¸è¯´èƒ½ä¸èƒ½æ‰¿å—ï¼Œç³»ç»Ÿä¼šä¸ä¼š <strong>ç›´æ¥å´©æºƒ</strong> äº†ï¼Ÿ</p><p>çŸ­ä¿¡ä¸šåŠ¡åˆä¸æ˜¯æˆ‘ä»¬çš„ä¸»ä¸šåŠ¡ï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½ <strong>æŠ˜ä¸­å¤„ç†</strong> å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬æŠŠè´­ä¹°å®Œæˆçš„ä¿¡æ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œè€ŒçŸ­ä¿¡ç³»ç»Ÿ <strong>å°½è‡ªå·±æ‰€èƒ½åœ°å»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–æ¶ˆæ¯å’Œæ¶ˆè´¹æ¶ˆæ¯</strong> ï¼Œå³ä½¿å¤„ç†é€Ÿåº¦æ…¢ä¸€ç‚¹ä¹Ÿæ— æ‰€è°“ï¼Œåªè¦æˆ‘ä»¬çš„ç³»ç»Ÿæ²¡æœ‰å´©æºƒå°±è¡Œäº†ã€‚</p><p>ç•™å¾—æ±Ÿå±±åœ¨ï¼Œè¿˜æ€•æ²¡æŸ´çƒ§ï¼Ÿä½ æ•¢è¯´æ¯æ¬¡å‘é€éªŒè¯ç çš„æ—¶å€™æ˜¯ä¸€å‘ä½ å°±æ”¶åˆ°äº†çš„ä¹ˆï¼Ÿ</p><h4 id="æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼Ÿ"><a href="#æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼Ÿ" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼Ÿ"></a>æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼Ÿ</h4><p>å…¶å®ä¸Šé¢æˆ‘å·²ç»è¯´äº†ã€‚<strong>å¼‚æ­¥ã€è§£è€¦ã€å‰Šå³°ã€‚</strong> å“ªæ€•ä½ ä¸Šé¢çš„éƒ½æ²¡çœ‹æ‡‚ä¹Ÿåƒä¸‡è¦è®°ä½è¿™å…­ä¸ªå­—ï¼Œå› ä¸ºä»–ä¸ä»…æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„ç²¾åï¼Œæ›´æ˜¯ç¼–ç¨‹å’Œæ¶æ„çš„ç²¾åã€‚</p><h4 id="æ¶ˆæ¯é˜Ÿåˆ—ä¼šå¸¦æ¥å‰¯ä½œç”¨å—ï¼Ÿ"><a href="#æ¶ˆæ¯é˜Ÿåˆ—ä¼šå¸¦æ¥å‰¯ä½œç”¨å—ï¼Ÿ" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—ä¼šå¸¦æ¥å‰¯ä½œç”¨å—ï¼Ÿ"></a>æ¶ˆæ¯é˜Ÿåˆ—ä¼šå¸¦æ¥å‰¯ä½œç”¨å—ï¼Ÿ</h4><p>æ²¡æœ‰å“ªä¸€é—¨æŠ€æœ¯æ˜¯â€œé“¶å¼¹â€ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿæœ‰å®ƒçš„å‰¯ä½œç”¨ã€‚</p><p>æ¯”å¦‚ï¼Œæœ¬æ¥å¥½å¥½çš„ä¸¤ä¸ªç³»ç»Ÿä¹‹é—´çš„è°ƒç”¨ï¼Œæˆ‘ä¸­é—´åŠ äº†ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚æœæ¶ˆæ¯é˜Ÿåˆ—æŒ‚äº†æ€ä¹ˆåŠå‘¢ï¼Ÿæ˜¯ä¸æ˜¯ <strong>é™ä½äº†ç³»ç»Ÿçš„å¯ç”¨æ€§</strong> ï¼Ÿ</p><p>é‚£è¿™æ ·æ˜¯ä¸æ˜¯è¦ä¿è¯HA(é«˜å¯ç”¨)ï¼Ÿæ˜¯ä¸æ˜¯è¦æé›†ç¾¤ï¼Ÿé‚£ä¹ˆæˆ‘ <strong>æ•´ä¸ªç³»ç»Ÿçš„å¤æ‚åº¦æ˜¯ä¸æ˜¯ä¸Šå‡äº†</strong> ï¼Ÿ</p><p>æŠ›å¼€ä¸Šé¢çš„é—®é¢˜ä¸è®²ï¼Œä¸‡ä¸€æˆ‘å‘é€æ–¹å‘é€å¤±è´¥äº†ï¼Œç„¶åæ‰§è¡Œé‡è¯•ï¼Œè¿™æ ·å°±å¯èƒ½äº§ç”Ÿé‡å¤çš„æ¶ˆæ¯ã€‚</p><p>æˆ–è€…æˆ‘æ¶ˆè´¹ç«¯å¤„ç†å¤±è´¥äº†ï¼Œè¯·æ±‚é‡å‘ï¼Œè¿™æ ·ä¹Ÿä¼šäº§ç”Ÿé‡å¤çš„æ¶ˆæ¯ã€‚</p><p>å¯¹äºä¸€äº›å¾®æœåŠ¡æ¥è¯´ï¼Œæ¶ˆè´¹é‡å¤æ¶ˆæ¯ä¼šå¸¦æ¥æ›´å¤§çš„éº»çƒ¦ï¼Œæ¯”å¦‚å¢åŠ ç§¯åˆ†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘åŠ äº†å¤šæ¬¡æ˜¯ä¸æ˜¯å¯¹å…¶ä»–ç”¨æˆ·ä¸å…¬å¹³ï¼Ÿ</p><p>é‚£ä¹ˆï¼Œåˆ <strong>å¦‚ä½•è§£å†³é‡å¤æ¶ˆè´¹æ¶ˆæ¯çš„é—®é¢˜</strong> å‘¢ï¼Ÿ</p><p>å¦‚æœæˆ‘ä»¬æ­¤æ—¶çš„æ¶ˆæ¯éœ€è¦ä¿è¯ä¸¥æ ¼çš„é¡ºåºæ€§æ€ä¹ˆåŠå‘¢ï¼Ÿæ¯”å¦‚ç”Ÿäº§è€…ç”Ÿäº§äº†ä¸€ç³»åˆ—çš„æœ‰åºæ¶ˆæ¯(å¯¹ä¸€ä¸ªidä¸º1çš„è®°å½•è¿›è¡Œåˆ é™¤å¢åŠ ä¿®æ”¹)ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“åœ¨å‘å¸ƒè®¢é˜…æ¨¡å‹ä¸­ï¼Œå¯¹äºä¸»é¢˜æ˜¯æ— é¡ºåºçš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±ä¼šå¯¼è‡´å¯¹äºæ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™æ²¡æœ‰æŒ‰ç…§ç”Ÿäº§è€…çš„å‘é€é¡ºåºæ¶ˆè´¹ï¼Œæ¯”å¦‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ¶ˆè´¹çš„é¡ºåºä¸ºä¿®æ”¹åˆ é™¤å¢åŠ ï¼Œå¦‚æœè¯¥è®°å½•æ¶‰åŠåˆ°é‡‘é¢çš„è¯æ˜¯ä¸æ˜¯ä¼šå‡ºå¤§äº‹æƒ…ï¼Ÿ</p><p>é‚£ä¹ˆï¼Œåˆ <strong>å¦‚ä½•è§£å†³æ¶ˆæ¯çš„é¡ºåºæ¶ˆè´¹é—®é¢˜</strong> å‘¢ï¼Ÿ</p><p>å°±æ‹¿æˆ‘ä»¬ä¸Šé¢æ‰€è®²çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´ï¼Œç”¨æˆ·è´­ç¥¨å®Œæˆä¹‹åæ˜¯ä¸æ˜¯éœ€è¦å¢åŠ è´¦æˆ·ç§¯åˆ†ï¼Ÿåœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸­æˆ‘ä»¬ä¸€èˆ¬ä¼šä½¿ç”¨äº‹åŠ¡æ¥è¿›è¡Œè§£å†³ï¼Œå¦‚æœç”¨ <code>Spring</code> çš„è¯æˆ‘ä»¬åœ¨ä¸Šé¢ä¼ªä»£ç ä¸­åŠ å…¥ <code>@Transactional</code> æ³¨è§£å°±å¥½äº†ã€‚ä½†æ˜¯åœ¨ä¸åŒç³»ç»Ÿä¸­å¦‚ä½•ä¿è¯äº‹åŠ¡å‘¢ï¼Ÿæ€»ä¸èƒ½è¿™ä¸ªç³»ç»Ÿæˆ‘æ‰£é’±æˆåŠŸäº†ä½ é‚£ç§¯åˆ†ç³»ç»Ÿç§¯åˆ†æ²¡åŠ å§ï¼Ÿæˆ–è€…è¯´æˆ‘è¿™æ‰£é’±æ˜æ˜å¤±è´¥äº†ï¼Œä½ é‚£ç§¯åˆ†ç³»ç»Ÿç»™æˆ‘åŠ äº†ç§¯åˆ†ã€‚</p><p>é‚£ä¹ˆï¼Œåˆå¦‚ä½• <strong>è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜</strong> å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬åˆšåˆšè¯´äº†ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥è¿›è¡Œå‰Šå³°æ“ä½œï¼Œé‚£å¦‚æœæˆ‘çš„æ¶ˆè´¹è€…å¦‚æœæ¶ˆè´¹å¾ˆæ…¢æˆ–è€…ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯å¾ˆå¿«ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯ä¼šå°†æ¶ˆæ¯å †ç§¯åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Ÿ</p><p>é‚£ä¹ˆï¼Œåˆå¦‚ä½• <strong>è§£å†³æ¶ˆæ¯å †ç§¯çš„é—®é¢˜</strong> å‘¢ï¼Ÿ</p><p>å¯ç”¨æ€§é™ä½ï¼Œå¤æ‚åº¦ä¸Šå‡ï¼Œåˆå¸¦æ¥ä¸€ç³»åˆ—çš„é‡å¤æ¶ˆè´¹ï¼Œé¡ºåºæ¶ˆè´¹ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œæ¶ˆæ¯å †ç§¯çš„é—®é¢˜ï¼Œè¿™æ¶ˆæ¯é˜Ÿåˆ—è¿˜æ€ä¹ˆç”¨å•ŠğŸ˜µï¼Ÿ</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef382d709abc9d.png.jpg"></p><p>åˆ«æ€¥ï¼ŒåŠæ³•æ€»æ˜¯æœ‰çš„ã€‚</p><h2 id="RocketMQæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#RocketMQæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="RocketMQæ˜¯ä»€ä¹ˆï¼Ÿ"></a>RocketMQæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef383014430799.jpg.jpg"></p><p>å“‡ï¼Œä½ ä¸ªæ··è›‹ï¼ä¸Šé¢ç»™æˆ‘æŠ›å‡ºé‚£ä¹ˆå¤šé—®é¢˜ï¼Œä½ ç°åœ¨åˆè®² <code>RocketMQ</code> ï¼Œè¿˜è®©ä¸è®©äººæ´»äº†ï¼Ÿï¼ğŸ¤¬</p><p>åˆ«æ€¥åˆ«æ€¥ï¼Œè¯è¯´ä½ ç°åœ¨æ¸…æ¥š <code>MQ</code> çš„æ„é€ å—ï¼Œæˆ‘è¿˜æ²¡è®²å‘¢ï¼Œæˆ‘ä»¬å…ˆææ˜ç™½ <code>MQ</code> çš„å†…éƒ¨æ„é€ ï¼Œå†æ¥çœ‹çœ‹å¦‚ä½•è§£å†³ä¸Šé¢çš„ä¸€ç³»åˆ—é—®é¢˜å§ï¼Œä¸è¿‡ä½ æœ€å¥½å¸¦ç€é—®é¢˜å»é˜…è¯»å’Œäº†è§£å–”ã€‚</p><p><code>RocketMQ</code> æ˜¯ä¸€ä¸ª <strong>é˜Ÿåˆ—æ¨¡å‹</strong> çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå…·æœ‰<strong>é«˜æ€§èƒ½ã€é«˜å¯é ã€é«˜å®æ—¶ã€åˆ†å¸ƒå¼</strong> çš„ç‰¹ç‚¹ã€‚å®ƒæ˜¯ä¸€ä¸ªé‡‡ç”¨ <code>Java</code> è¯­è¨€å¼€å‘çš„åˆ†å¸ƒå¼çš„æ¶ˆæ¯ç³»ç»Ÿï¼Œç”±é˜¿é‡Œå·´å·´å›¢é˜Ÿå¼€å‘ï¼Œåœ¨2016å¹´åº•è´¡çŒ®ç»™ <code>Apache</code>ï¼Œæˆä¸ºäº† <code>Apache</code> çš„ä¸€ä¸ªé¡¶çº§é¡¹ç›®ã€‚ åœ¨é˜¿é‡Œå†…éƒ¨ï¼Œ<code>RocketMQ</code> å¾ˆå¥½åœ°æœåŠ¡äº†é›†å›¢å¤§å¤§å°å°ä¸Šåƒä¸ªåº”ç”¨ï¼Œåœ¨æ¯å¹´çš„åŒåä¸€å½“å¤©ï¼Œæ›´æœ‰ä¸å¯æ€è®®çš„ä¸‡äº¿çº§æ¶ˆæ¯é€šè¿‡ <code>RocketMQ</code> æµè½¬ã€‚</p><p>åºŸè¯ä¸å¤šè¯´ï¼Œæƒ³è¦äº†è§£ <code>RocketMQ</code> å†å²çš„åŒå­¦å¯ä»¥è‡ªå·±å»æœå¯»èµ„æ–™ã€‚å¬å®Œä¸Šé¢çš„ä»‹ç»ï¼Œä½ åªè¦çŸ¥é“ <code>RocketMQ</code> å¾ˆå¿«ã€å¾ˆç‰›ã€è€Œä¸”ç»å†è¿‡åŒåä¸€çš„å®è·µå°±è¡Œäº†ï¼</p><h2 id="é˜Ÿåˆ—æ¨¡å‹å’Œä¸»é¢˜æ¨¡å‹"><a href="#é˜Ÿåˆ—æ¨¡å‹å’Œä¸»é¢˜æ¨¡å‹" class="headerlink" title="é˜Ÿåˆ—æ¨¡å‹å’Œä¸»é¢˜æ¨¡å‹"></a>é˜Ÿåˆ—æ¨¡å‹å’Œä¸»é¢˜æ¨¡å‹</h2><p>åœ¨è°ˆ <code>RocketMQ</code> çš„æŠ€æœ¯æ¶æ„ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ä¸¤ä¸ªåè¯æ¦‚å¿µâ€”â€”<strong>é˜Ÿåˆ—æ¨¡å‹</strong> å’Œ <strong>ä¸»é¢˜æ¨¡å‹</strong> ã€‚</p><p>é¦–å…ˆæˆ‘é—®ä¸€ä¸ªé—®é¢˜ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸ºä»€ä¹ˆè¦å«æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ</p><p>ä½ å¯èƒ½è§‰å¾—å¾ˆå¼±æ™ºï¼Œè¿™ç©æ„ä¸å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—å˜›ï¼Ÿä¸å«æ¶ˆæ¯é˜Ÿåˆ—å«ä»€ä¹ˆï¼Ÿ</p><p>çš„ç¡®ï¼Œæ—©æœŸçš„æ¶ˆæ¯ä¸­é—´ä»¶æ˜¯é€šè¿‡ <strong>é˜Ÿåˆ—</strong> è¿™ä¸€æ¨¡å‹æ¥å®ç°çš„ï¼Œå¯èƒ½æ˜¯å†å²åŸå› ï¼Œæˆ‘ä»¬éƒ½ä¹ æƒ¯æŠŠæ¶ˆæ¯ä¸­é—´ä»¶æˆä¸ºæ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚ä»Šä¾‹å¦‚ <code>RocketMQ</code> ã€<code>Kafka</code> è¿™äº›ä¼˜ç§€çš„æ¶ˆæ¯ä¸­é—´ä»¶ä¸ä»…ä»…æ˜¯é€šè¿‡ä¸€ä¸ª <strong>é˜Ÿåˆ—</strong> æ¥å®ç°æ¶ˆæ¯å­˜å‚¨çš„ã€‚</p><h3 id="é˜Ÿåˆ—æ¨¡å‹"><a href="#é˜Ÿåˆ—æ¨¡å‹" class="headerlink" title="é˜Ÿåˆ—æ¨¡å‹"></a>é˜Ÿåˆ—æ¨¡å‹</h3><p>å°±åƒæˆ‘ä»¬ç†è§£é˜Ÿåˆ—ä¸€æ ·ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶çš„é˜Ÿåˆ—æ¨¡å‹å°±çœŸçš„åªæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ã€‚ã€‚ã€‚æˆ‘ç”»ä¸€å¼ å›¾ç»™å¤§å®¶ç†è§£ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef3834ae653469.jpg.jpg"></p><p>åœ¨ä¸€å¼€å§‹æˆ‘è·Ÿä½ æåˆ°äº†ä¸€ä¸ª <strong>â€œå¹¿æ’­â€</strong> çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬æ­¤æ—¶æˆ‘ä»¬éœ€è¦å°†ä¸€ä¸ªæ¶ˆæ¯å‘é€ç»™å¤šä¸ªæ¶ˆè´¹è€…(æ¯”å¦‚æ­¤æ—¶æˆ‘éœ€è¦å°†ä¿¡æ¯å‘é€ç»™çŸ­ä¿¡ç³»ç»Ÿå’Œé‚®ä»¶ç³»ç»Ÿ)ï¼Œè¿™ä¸ªæ—¶å€™å•ä¸ªé˜Ÿåˆ—å³ä¸èƒ½æ»¡è¶³éœ€æ±‚äº†ã€‚</p><p>å½“ç„¶ä½ å¯ä»¥è®© <code>Producer</code> ç”Ÿäº§æ¶ˆæ¯æ”¾å…¥å¤šä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åæ¯ä¸ªé˜Ÿåˆ—å»å¯¹åº”æ¯ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚é—®é¢˜æ˜¯å¯ä»¥è§£å†³ï¼Œåˆ›å»ºå¤šä¸ªé˜Ÿåˆ—å¹¶ä¸”å¤åˆ¶å¤šä»½æ¶ˆæ¯æ˜¯ä¼šå¾ˆå½±å“èµ„æºå’Œæ€§èƒ½çš„ã€‚è€Œä¸”ï¼Œè¿™æ ·å­å°±ä¼šå¯¼è‡´ç”Ÿäº§è€…éœ€è¦çŸ¥é“å…·ä½“æ¶ˆè´¹è€…ä¸ªæ•°ç„¶åå»å¤åˆ¶å¯¹åº”æ•°é‡çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™å°±è¿èƒŒæˆ‘ä»¬æ¶ˆæ¯ä¸­é—´ä»¶çš„ <strong>è§£è€¦</strong> è¿™ä¸€åŸåˆ™ã€‚</p><h3 id="ä¸»é¢˜æ¨¡å‹"><a href="#ä¸»é¢˜æ¨¡å‹" class="headerlink" title="ä¸»é¢˜æ¨¡å‹"></a>ä¸»é¢˜æ¨¡å‹</h3><p>é‚£ä¹ˆæœ‰æ²¡æœ‰å¥½çš„æ–¹æ³•å»è§£å†³è¿™ä¸€ä¸ªé—®é¢˜å‘¢ï¼Ÿæœ‰ï¼Œé‚£å°±æ˜¯ <strong>ä¸»é¢˜æ¨¡å‹</strong> æˆ–è€…å¯ä»¥ç§°ä¸º <strong>å‘å¸ƒè®¢é˜…æ¨¡å‹</strong> ã€‚</p><blockquote><p>æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å»äº†è§£ä¸€ä¸‹è®¾è®¡æ¨¡å¼é‡Œé¢çš„è§‚å¯Ÿè€…æ¨¡å¼å¹¶ä¸”æ‰‹åŠ¨å®ç°ä¸€ä¸‹ï¼Œæˆ‘ç›¸ä¿¡ä½ ä¼šæœ‰æ‰€æ”¶è·çš„ã€‚</p></blockquote><p>åœ¨ä¸»é¢˜æ¨¡å‹ä¸­ï¼Œæ¶ˆæ¯çš„ç”Ÿäº§è€…ç§°ä¸º <strong>å‘å¸ƒè€…(Publisher)</strong> ï¼Œæ¶ˆæ¯çš„æ¶ˆè´¹è€…ç§°ä¸º <strong>è®¢é˜…è€…(Subscriber)</strong> ï¼Œå­˜æ”¾æ¶ˆæ¯çš„å®¹å™¨ç§°ä¸º <strong>ä¸»é¢˜(Topic)</strong> ã€‚</p><p>å…¶ä¸­ï¼Œå‘å¸ƒè€…å°†æ¶ˆæ¯å‘é€åˆ°æŒ‡å®šä¸»é¢˜ä¸­ï¼Œè®¢é˜…è€…éœ€è¦ <strong>æå‰è®¢é˜…ä¸»é¢˜</strong> æ‰èƒ½æ¥å—ç‰¹å®šä¸»é¢˜çš„æ¶ˆæ¯ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef3837887d9a54sds.jpg.jpg"></p><h3 id="RocketMQä¸­çš„æ¶ˆæ¯æ¨¡å‹"><a href="#RocketMQä¸­çš„æ¶ˆæ¯æ¨¡å‹" class="headerlink" title="RocketMQä¸­çš„æ¶ˆæ¯æ¨¡å‹"></a>RocketMQä¸­çš„æ¶ˆæ¯æ¨¡å‹</h3><p><code>RockerMQ</code> ä¸­çš„æ¶ˆæ¯æ¨¡å‹å°±æ˜¯æŒ‰ç…§ <strong>ä¸»é¢˜æ¨¡å‹</strong> æ‰€å®ç°çš„ã€‚ä½ å¯èƒ½ä¼šå¥½å¥‡è¿™ä¸ª <strong>ä¸»é¢˜</strong> åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿä½ ä¸Šé¢ä¹Ÿæ²¡æœ‰è®²åˆ°å‘€ï¼</p><p>å…¶å®å¯¹äºä¸»é¢˜æ¨¡å‹çš„å®ç°æ¥è¯´æ¯ä¸ªæ¶ˆæ¯ä¸­é—´ä»¶çš„åº•å±‚è®¾è®¡éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå°±æ¯”å¦‚ <code>Kafka</code> ä¸­çš„ <strong>åˆ†åŒº</strong> ï¼Œ<code>RocketMQ</code> ä¸­çš„ <strong>é˜Ÿåˆ—</strong> ï¼Œ<code>RabbitMQ</code> ä¸­çš„ <code>Exchange</code> ã€‚æˆ‘ä»¬å¯ä»¥ç†è§£ä¸º <strong>ä¸»é¢˜æ¨¡å‹/å‘å¸ƒè®¢é˜…æ¨¡å‹</strong> å°±æ˜¯ä¸€ä¸ªæ ‡å‡†ï¼Œé‚£äº›ä¸­é—´ä»¶åªä¸è¿‡ç…§ç€è¿™ä¸ªæ ‡å‡†å»å®ç°è€Œå·²ã€‚</p><p>æ‰€ä»¥ï¼Œ<code>RocketMQ</code> ä¸­çš„ <strong>ä¸»é¢˜æ¨¡å‹</strong> åˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿé¦–å…ˆæˆ‘ç”»ä¸€å¼ å›¾ï¼Œå¤§å®¶å°è¯•ç€å»ç†è§£ä¸€ä¸‹ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef383d3e8c9788.jpg.jpg"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨æ•´ä¸ªå›¾ä¸­æœ‰ <code>Producer Group</code> ã€<code>Topic</code> ã€<code>Consumer Group</code>  ä¸‰ä¸ªè§’è‰²ï¼Œæˆ‘æ¥åˆ†åˆ«ä»‹ç»ä¸€ä¸‹ä»–ä»¬ã€‚</p><ul><li><code>Producer Group</code> ç”Ÿäº§è€…ç»„ï¼š ä»£è¡¨æŸä¸€ç±»çš„ç”Ÿäº§è€…ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰å¤šä¸ªç§’æ€ç³»ç»Ÿä½œä¸ºç”Ÿäº§è€…ï¼Œè¿™å¤šä¸ªåˆåœ¨ä¸€èµ·å°±æ˜¯ä¸€ä¸ª <code>Producer Group</code> ç”Ÿäº§è€…ç»„ï¼Œå®ƒä»¬ä¸€èˆ¬ç”Ÿäº§ç›¸åŒçš„æ¶ˆæ¯ã€‚</li><li><code>Consumer Group</code> æ¶ˆè´¹è€…ç»„ï¼š ä»£è¡¨æŸä¸€ç±»çš„æ¶ˆè´¹è€…ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰å¤šä¸ªçŸ­ä¿¡ç³»ç»Ÿä½œä¸ºæ¶ˆè´¹è€…ï¼Œè¿™å¤šä¸ªåˆåœ¨ä¸€èµ·å°±æ˜¯ä¸€ä¸ª <code>Consumer Group</code> æ¶ˆè´¹è€…ç»„ï¼Œå®ƒä»¬ä¸€èˆ¬æ¶ˆè´¹ç›¸åŒçš„æ¶ˆæ¯ã€‚</li><li><code>Topic</code> ä¸»é¢˜ï¼š ä»£è¡¨ä¸€ç±»æ¶ˆæ¯ï¼Œæ¯”å¦‚è®¢å•æ¶ˆæ¯ï¼Œç‰©æµæ¶ˆæ¯ç­‰ç­‰ã€‚</li></ul><p>ä½ å¯ä»¥çœ‹åˆ°å›¾ä¸­ç”Ÿäº§è€…ç»„ä¸­çš„ç”Ÿäº§è€…ä¼šå‘ä¸»é¢˜å‘é€æ¶ˆæ¯ï¼Œè€Œ <strong>ä¸»é¢˜ä¸­å­˜åœ¨å¤šä¸ªé˜Ÿåˆ—</strong>ï¼Œç”Ÿäº§è€…æ¯æ¬¡ç”Ÿäº§æ¶ˆæ¯ä¹‹åæ˜¯æŒ‡å®šä¸»é¢˜ä¸­çš„æŸä¸ªé˜Ÿåˆ—å‘é€æ¶ˆæ¯çš„ã€‚</p><p>æ¯ä¸ªä¸»é¢˜ä¸­éƒ½æœ‰å¤šä¸ªé˜Ÿåˆ—(è¿™é‡Œè¿˜ä¸æ¶‰åŠåˆ° <code>Broker</code>)ï¼Œé›†ç¾¤æ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…é›†ç¾¤å¤šå°æœºå™¨å…±åŒæ¶ˆè´¹ä¸€ä¸ª <code>topic</code> çš„å¤šä¸ªé˜Ÿåˆ—ï¼Œ<strong>ä¸€ä¸ªé˜Ÿåˆ—åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹</strong>ã€‚å¦‚æœæŸä¸ªæ¶ˆè´¹è€…æŒ‚æ‰ï¼Œåˆ†ç»„å†…å…¶å®ƒæ¶ˆè´¹è€…ä¼šæ¥æ›¿æŒ‚æ‰çš„æ¶ˆè´¹è€…ç»§ç»­æ¶ˆè´¹ã€‚å°±åƒä¸Šå›¾ä¸­ <code>Consumer1</code> å’Œ <code>Consumer2</code> åˆ†åˆ«å¯¹åº”ç€ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œè€Œ <code>Consuer3</code> æ˜¯æ²¡æœ‰é˜Ÿåˆ—å¯¹åº”çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬æ¥è®²è¦æ§åˆ¶ <strong>æ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…ä¸ªæ•°å’Œä¸»é¢˜ä¸­é˜Ÿåˆ—ä¸ªæ•°ç›¸åŒ</strong> ã€‚</p><p>å½“ç„¶ä¹Ÿå¯ä»¥æ¶ˆè´¹è€…ä¸ªæ•°å°äºé˜Ÿåˆ—ä¸ªæ•°ï¼Œåªä¸è¿‡ä¸å¤ªå»ºè®®ã€‚å¦‚ä¸‹å›¾ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef3850c808d707.jpg.jpg"></p><p><strong>æ¯ä¸ªæ¶ˆè´¹ç»„åœ¨æ¯ä¸ªé˜Ÿåˆ—ä¸Šç»´æŠ¤ä¸€ä¸ªæ¶ˆè´¹ä½ç½®</strong> ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å› ä¸ºæˆ‘ä»¬åˆšåˆšç”»çš„ä»…ä»…æ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨å‘å¸ƒè®¢é˜…æ¨¡å¼ä¸­ä¸€èˆ¬ä¼šæ¶‰åŠåˆ°å¤šä¸ªæ¶ˆè´¹è€…ç»„ï¼Œè€Œæ¯ä¸ªæ¶ˆè´¹è€…ç»„åœ¨æ¯ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆè´¹ä½ç½®éƒ½æ˜¯ä¸åŒçš„ã€‚å¦‚æœæ­¤æ—¶æœ‰å¤šä¸ªæ¶ˆè´¹è€…ç»„ï¼Œé‚£ä¹ˆæ¶ˆæ¯è¢«ä¸€ä¸ªæ¶ˆè´¹è€…ç»„æ¶ˆè´¹å®Œä¹‹åæ˜¯ä¸ä¼šåˆ é™¤çš„(å› ä¸ºå…¶å®ƒæ¶ˆè´¹è€…ç»„ä¹Ÿéœ€è¦å‘€)ï¼Œå®ƒä»…ä»…æ˜¯ä¸ºæ¯ä¸ªæ¶ˆè´¹è€…ç»„ç»´æŠ¤ä¸€ä¸ª <strong>æ¶ˆè´¹ä½ç§»(offset)</strong> ï¼Œæ¯æ¬¡æ¶ˆè´¹è€…ç»„æ¶ˆè´¹å®Œä¼šè¿”å›ä¸€ä¸ªæˆåŠŸçš„å“åº”ï¼Œç„¶åé˜Ÿåˆ—å†æŠŠç»´æŠ¤çš„æ¶ˆè´¹ä½ç§»åŠ ä¸€ï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºç°åˆšåˆšæ¶ˆè´¹è¿‡çš„æ¶ˆæ¯å†ä¸€æ¬¡è¢«æ¶ˆè´¹äº†ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef3857fefaa079.jpg.jpg"></p><p>å¯èƒ½ä½ è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ<strong>ä¸ºä»€ä¹ˆä¸€ä¸ªä¸»é¢˜ä¸­éœ€è¦ç»´æŠ¤å¤šä¸ªé˜Ÿåˆ—</strong> ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ <strong>æé«˜å¹¶å‘èƒ½åŠ›</strong> ã€‚çš„ç¡®ï¼Œæ¯ä¸ªä¸»é¢˜ä¸­åªå­˜åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚ä½ æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæ¯ä¸ªä¸»é¢˜ä¸­åªå­˜åœ¨ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—ä¸­ä¹Ÿç»´æŠ¤ç€æ¯ä¸ªæ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹ä½ç½®ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥åšåˆ° <strong>å‘å¸ƒè®¢é˜…æ¨¡å¼</strong> ã€‚å¦‚ä¸‹å›¾ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef38600cdb6d4b.jpg.jpg"></p><p>ä½†æ˜¯ï¼Œè¿™æ ·æˆ‘ç”Ÿäº§è€…æ˜¯ä¸æ˜¯åªèƒ½å‘ä¸€ä¸ªé˜Ÿåˆ—å‘é€æ¶ˆæ¯ï¼Ÿåˆå› ä¸ºéœ€è¦ç»´æŠ¤æ¶ˆè´¹ä½ç½®æ‰€ä»¥ä¸€ä¸ªé˜Ÿåˆ—åªèƒ½å¯¹åº”ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯å…¶ä»–çš„ <code>Consumer</code> å°±æ²¡æœ‰ç”¨æ­¦ä¹‹åœ°äº†ï¼Ÿä»è¿™ä¸¤ä¸ªè§’åº¦æ¥è®²ï¼Œå¹¶å‘åº¦ä¸€ä¸‹å­å°±å°äº†å¾ˆå¤šã€‚</p><p>æ‰€ä»¥æ€»ç»“æ¥è¯´ï¼Œ<code>RocketMQ</code> é€šè¿‡<strong>ä½¿ç”¨åœ¨ä¸€ä¸ª <code>Topic</code> ä¸­é…ç½®å¤šä¸ªé˜Ÿåˆ—å¹¶ä¸”æ¯ä¸ªé˜Ÿåˆ—ç»´æŠ¤æ¯ä¸ªæ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹ä½ç½®</strong> å®ç°äº† <strong>ä¸»é¢˜æ¨¡å¼/å‘å¸ƒè®¢é˜…æ¨¡å¼</strong> ã€‚</p><h2 id="RocketMQçš„æ¶æ„å›¾"><a href="#RocketMQçš„æ¶æ„å›¾" class="headerlink" title="RocketMQçš„æ¶æ„å›¾"></a>RocketMQçš„æ¶æ„å›¾</h2><p>è®²å®Œäº†æ¶ˆæ¯æ¨¡å‹ï¼Œæˆ‘ä»¬ç†è§£èµ· <code>RocketMQ</code> çš„æŠ€æœ¯æ¶æ„èµ·æ¥å°±å®¹æ˜“å¤šäº†ã€‚</p><p><code>RocketMQ</code> æŠ€æœ¯æ¶æ„ä¸­æœ‰å››å¤§è§’è‰² <code>NameServer</code> ã€<code>Broker</code> ã€<code>Producer</code> ã€<code>Consumer</code> ã€‚æˆ‘æ¥å‘å¤§å®¶åˆ†åˆ«è§£é‡Šä¸€ä¸‹è¿™å››ä¸ªè§’è‰²æ˜¯å¹²å•¥çš„ã€‚</p><ul><li><p><code>Broker</code>ï¼š ä¸»è¦è´Ÿè´£æ¶ˆæ¯çš„å­˜å‚¨ã€æŠ•é€’å’ŒæŸ¥è¯¢ä»¥åŠæœåŠ¡é«˜å¯ç”¨ä¿è¯ã€‚è¯´ç™½äº†å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨å˜›ï¼Œç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯åˆ° <code>Broker</code> ï¼Œæ¶ˆè´¹è€…ä» <code>Broker</code> æ‹‰å–æ¶ˆæ¯å¹¶æ¶ˆè´¹ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘è¿˜å¾—æ™®åŠä¸€ä¸‹å…³äº <code>Broker</code> ã€<code>Topic</code> å’Œ é˜Ÿåˆ—çš„å…³ç³»ã€‚ä¸Šé¢æˆ‘è®²è§£äº† <code>Topic</code> å’Œé˜Ÿåˆ—çš„å…³ç³»â€”â€”ä¸€ä¸ª <code>Topic</code> ä¸­å­˜åœ¨å¤šä¸ªé˜Ÿåˆ—ï¼Œé‚£ä¹ˆè¿™ä¸ª <code>Topic</code> å’Œé˜Ÿåˆ—å­˜æ”¾åœ¨å“ªå‘¢ï¼Ÿ</p><p><strong>ä¸€ä¸ª <code>Topic</code> åˆ†å¸ƒåœ¨å¤šä¸ª <code>Broker</code>ä¸Šï¼Œä¸€ä¸ª <code>Broker</code> å¯ä»¥é…ç½®å¤šä¸ª <code>Topic</code> ï¼Œå®ƒä»¬æ˜¯å¤šå¯¹å¤šçš„å…³ç³»</strong>ã€‚ </p><p>å¦‚æœæŸä¸ª <code>Topic</code> æ¶ˆæ¯é‡å¾ˆå¤§ï¼Œåº”è¯¥ç»™å®ƒå¤šé…ç½®å‡ ä¸ªé˜Ÿåˆ—(ä¸Šæ–‡ä¸­æåˆ°äº†æé«˜å¹¶å‘èƒ½åŠ›)ï¼Œå¹¶ä¸” <strong>å°½é‡å¤šåˆ†å¸ƒåœ¨ä¸åŒ <code>Broker</code> ä¸Šï¼Œä»¥å‡è½»æŸä¸ª <code>Broker</code> çš„å‹åŠ›</strong> ã€‚</p><p><code>Topic</code> æ¶ˆæ¯é‡éƒ½æ¯”è¾ƒå‡åŒ€çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæŸä¸ª <code>broker</code> ä¸Šçš„é˜Ÿåˆ—è¶Šå¤šï¼Œåˆ™è¯¥ <code>broker</code> å‹åŠ›è¶Šå¤§ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef38687488a5a4.jpg.jpg"></p><blockquote><p>æ‰€ä»¥è¯´æˆ‘ä»¬éœ€è¦é…ç½®å¤šä¸ªBrokerã€‚</p></blockquote></li><li><p><code>NameServer</code>ï¼š ä¸çŸ¥é“ä½ ä»¬æœ‰æ²¡æœ‰æ¥è§¦è¿‡ <code>ZooKeeper</code> å’Œ <code>Spring Cloud</code> ä¸­çš„ <code>Eureka</code> ï¼Œå®ƒå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ª <strong>æ³¨å†Œä¸­å¿ƒ</strong> ï¼Œä¸»è¦æä¾›ä¸¤ä¸ªåŠŸèƒ½ï¼š<strong>Brokerç®¡ç†</strong> å’Œ <strong>è·¯ç”±ä¿¡æ¯ç®¡ç†</strong> ã€‚è¯´ç™½äº†å°±æ˜¯ <code>Broker</code> ä¼šå°†è‡ªå·±çš„ä¿¡æ¯æ³¨å†Œåˆ° <code>NameServer</code> ä¸­ï¼Œæ­¤æ—¶ <code>NameServer</code> å°±å­˜æ”¾äº†å¾ˆå¤š <code>Broker</code> çš„ä¿¡æ¯(Brokerçš„è·¯ç”±è¡¨)ï¼Œæ¶ˆè´¹è€…å’Œç”Ÿäº§è€…å°±ä» <code>NameServer</code> ä¸­è·å–è·¯ç”±è¡¨ç„¶åç…§ç€è·¯ç”±è¡¨çš„ä¿¡æ¯å’Œå¯¹åº”çš„ <code>Broker</code> è¿›è¡Œé€šä¿¡(ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å®šæœŸä¼šå‘ <code>NameServer</code> å»æŸ¥è¯¢ç›¸å…³çš„ <code>Broker</code> çš„ä¿¡æ¯)ã€‚</p></li><li><p><code>Producer</code>ï¼š æ¶ˆæ¯å‘å¸ƒçš„è§’è‰²ï¼Œæ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤æ–¹å¼éƒ¨ç½²ã€‚è¯´ç™½äº†å°±æ˜¯ç”Ÿäº§è€…ã€‚</p></li><li><p><code>Consumer</code>ï¼š æ¶ˆæ¯æ¶ˆè´¹çš„è§’è‰²ï¼Œæ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤æ–¹å¼éƒ¨ç½²ã€‚æ”¯æŒä»¥pushæ¨ï¼Œpullæ‹‰ä¸¤ç§æ¨¡å¼å¯¹æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ã€‚åŒæ—¶ä¹Ÿæ”¯æŒé›†ç¾¤æ–¹å¼å’Œå¹¿æ’­æ–¹å¼çš„æ¶ˆè´¹ï¼Œå®ƒæä¾›å®æ—¶æ¶ˆæ¯è®¢é˜…æœºåˆ¶ã€‚è¯´ç™½äº†å°±æ˜¯æ¶ˆè´¹è€…ã€‚</p></li></ul><p>å¬å®Œäº†ä¸Šé¢çš„è§£é‡Šä½ å¯èƒ½ä¼šè§‰å¾—ï¼Œè¿™ç©æ„å¥½ç®€å•ã€‚ä¸å°±æ˜¯è¿™æ ·çš„ä¹ˆï¼Ÿ</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef386c6d1e8bdb.jpg.jpg"></p><p>å—¯ï¼Ÿä½ å¯èƒ½ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œè¿™è€å®¶ä¼™ <code>NameServer</code> å¹²å•¥ç”¨çš„ï¼Œè¿™ä¸å¤šä½™å—ï¼Ÿç›´æ¥ <code>Producer</code> ã€<code>Consumer</code> å’Œ <code>Broker</code> ç›´æ¥è¿›è¡Œç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹æ¶ˆæ¯ä¸å°±å¥½äº†ä¹ˆï¼Ÿ</p><p>ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸Šæ–‡æåˆ°è¿‡ <code>Broker</code> æ˜¯éœ€è¦ä¿è¯é«˜å¯ç”¨çš„ï¼Œå¦‚æœæ•´ä¸ªç³»ç»Ÿä»…ä»…é ç€ä¸€ä¸ª <code>Broker</code> æ¥ç»´æŒçš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ª <code>Broker</code> çš„å‹åŠ›ä¼šä¸ä¼šå¾ˆå¤§ï¼Ÿæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨å¤šä¸ª <code>Broker</code> æ¥ä¿è¯ <strong>è´Ÿè½½å‡è¡¡</strong> ã€‚</p><p>å¦‚æœè¯´ï¼Œæˆ‘ä»¬çš„æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ç›´æ¥å’Œå¤šä¸ª <code>Broker</code> ç›¸è¿ï¼Œé‚£ä¹ˆå½“ <code>Broker</code> ä¿®æ”¹çš„æ—¶å€™å¿…å®šä¼šç‰µè¿ç€æ¯ä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œè¿™æ ·å°±ä¼šäº§ç”Ÿè€¦åˆé—®é¢˜ï¼Œè€Œ <code>NameServer</code> æ³¨å†Œä¸­å¿ƒå°±æ˜¯ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚</p><blockquote><p>å¦‚æœè¿˜ä¸æ˜¯å¾ˆç†è§£çš„è¯ï¼Œå¯ä»¥å»çœ‹æˆ‘ä»‹ç» <code>Spring Cloud</code> çš„é‚£ç¯‡æ–‡ç« ï¼Œå…¶ä¸­ä»‹ç»äº† <code>Eureka</code> æ³¨å†Œä¸­å¿ƒã€‚</p></blockquote><p>å½“ç„¶ï¼Œ<code>RocketMQ</code> ä¸­çš„æŠ€æœ¯æ¶æ„è‚¯å®šä¸æ­¢å‰é¢é‚£ä¹ˆç®€å•ï¼Œå› ä¸ºä¸Šé¢å›¾ä¸­çš„å››ä¸ªè§’è‰²éƒ½æ˜¯éœ€è¦åšé›†ç¾¤çš„ã€‚æˆ‘ç»™å‡ºä¸€å¼ å®˜ç½‘çš„æ¶æ„å›¾ï¼Œå¤§å®¶å°è¯•ç†è§£ä¸€ä¸‹ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef386fa3be1e53.jpg.jpg"></p><p>å…¶å®å’Œæˆ‘ä»¬æœ€å¼€å§‹ç”»çš„é‚£å¼ ä¹ä¸ç‰ˆçš„æ¶æ„å›¾ä¹Ÿæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œä¸»è¦æ˜¯ä¸€äº›ç»†èŠ‚ä¸Šçš„å·®åˆ«ã€‚å¬æˆ‘ç»†ç»†é“æ¥ğŸ¤¨ã€‚</p><p>ç¬¬ä¸€ã€æˆ‘ä»¬çš„ <code>Broker</code> <strong>åšäº†é›†ç¾¤å¹¶ä¸”è¿˜è¿›è¡Œäº†ä¸»ä»éƒ¨ç½²</strong> ï¼Œç”±äºæ¶ˆæ¯åˆ†å¸ƒåœ¨å„ä¸ª <code>Broker</code> ä¸Šï¼Œä¸€æ—¦æŸä¸ª <code>Broker</code> å®•æœºï¼Œåˆ™è¯¥<code>Broker</code> ä¸Šçš„æ¶ˆæ¯è¯»å†™éƒ½ä¼šå—åˆ°å½±å“ã€‚æ‰€ä»¥ <code>Rocketmq</code> æä¾›äº† <code>master/slave</code> çš„ç»“æ„ï¼Œ<code> salve</code> å®šæ—¶ä» <code>master</code> åŒæ­¥æ•°æ®(åŒæ­¥åˆ·ç›˜æˆ–è€…å¼‚æ­¥åˆ·ç›˜)ï¼Œå¦‚æœ <code>master</code> å®•æœºï¼Œ<strong>åˆ™ <code>slave</code> æä¾›æ¶ˆè´¹æœåŠ¡ï¼Œä½†æ˜¯ä¸èƒ½å†™å…¥æ¶ˆæ¯</strong> (åé¢æˆ‘è¿˜ä¼šæåˆ°å“¦)ã€‚</p><p>ç¬¬äºŒã€ä¸ºäº†ä¿è¯ <code>HA</code> ï¼Œæˆ‘ä»¬çš„ <code>NameServer</code> ä¹Ÿåšäº†é›†ç¾¤éƒ¨ç½²ï¼Œä½†æ˜¯è¯·æ³¨æ„å®ƒæ˜¯ <strong>å»ä¸­å¿ƒåŒ–</strong> çš„ã€‚ä¹Ÿå°±æ„å‘³ç€å®ƒæ²¡æœ‰ä¸»èŠ‚ç‚¹ï¼Œä½ å¯ä»¥å¾ˆæ˜æ˜¾åœ°çœ‹å‡º <code>NameServer</code> çš„æ‰€æœ‰èŠ‚ç‚¹æ˜¯æ²¡æœ‰è¿›è¡Œ <code>Info Replicate</code> çš„ï¼Œåœ¨ <code>RocketMQ</code> ä¸­æ˜¯é€šè¿‡ <strong>å•ä¸ªBrokerå’Œæ‰€æœ‰NameServerä¿æŒé•¿è¿æ¥</strong> ï¼Œå¹¶ä¸”åœ¨æ¯éš”30ç§’ <code>Broker</code> ä¼šå‘æ‰€æœ‰ <code>Nameserver</code> å‘é€å¿ƒè·³ï¼Œå¿ƒè·³åŒ…å«äº†è‡ªèº«çš„ <code>Topic</code> é…ç½®ä¿¡æ¯ï¼Œè¿™ä¸ªæ­¥éª¤å°±å¯¹åº”è¿™ä¸Šé¢çš„ <code>Routing Info</code> ã€‚</p><p>ç¬¬ä¸‰ã€åœ¨ç”Ÿäº§è€…éœ€è¦å‘ <code>Broker</code> å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œ<strong>éœ€è¦å…ˆä» <code>NameServer</code> è·å–å…³äº <code>Broker</code> çš„è·¯ç”±ä¿¡æ¯</strong>ï¼Œç„¶åé€šè¿‡ <strong>è½®è¯¢</strong> çš„æ–¹æ³•å»å‘æ¯ä¸ªé˜Ÿåˆ—ä¸­ç”Ÿäº§æ•°æ®ä»¥è¾¾åˆ° <strong>è´Ÿè½½å‡è¡¡</strong> çš„æ•ˆæœã€‚</p><p>ç¬¬å››ã€æ¶ˆè´¹è€…é€šè¿‡ <code>NameServer</code> è·å–æ‰€æœ‰ <code>Broker</code> çš„è·¯ç”±ä¿¡æ¯åï¼Œå‘ <code>Broker</code> å‘é€ <code>Pull</code> è¯·æ±‚æ¥è·å–æ¶ˆæ¯æ•°æ®ã€‚<code>Consumer</code> å¯ä»¥ä»¥ä¸¤ç§æ¨¡å¼å¯åŠ¨â€”â€” <strong>å¹¿æ’­ï¼ˆBroadcastï¼‰å’Œé›†ç¾¤ï¼ˆClusterï¼‰</strong>ã€‚å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œä¸€æ¡æ¶ˆæ¯ä¼šå‘é€ç»™ <strong>åŒä¸€ä¸ªæ¶ˆè´¹ç»„ä¸­çš„æ‰€æœ‰æ¶ˆè´¹è€…</strong> ï¼Œé›†ç¾¤æ¨¡å¼ä¸‹æ¶ˆæ¯åªä¼šå‘é€ç»™ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚</p><h2 id="å¦‚ä½•è§£å†³-é¡ºåºæ¶ˆè´¹ã€é‡å¤æ¶ˆè´¹"><a href="#å¦‚ä½•è§£å†³-é¡ºåºæ¶ˆè´¹ã€é‡å¤æ¶ˆè´¹" class="headerlink" title="å¦‚ä½•è§£å†³ é¡ºåºæ¶ˆè´¹ã€é‡å¤æ¶ˆè´¹"></a>å¦‚ä½•è§£å†³ é¡ºåºæ¶ˆè´¹ã€é‡å¤æ¶ˆè´¹</h2><p>å…¶å®ï¼Œè¿™äº›ä¸œè¥¿éƒ½æ˜¯æˆ‘åœ¨ä»‹ç»æ¶ˆæ¯é˜Ÿåˆ—å¸¦æ¥çš„ä¸€äº›å‰¯ä½œç”¨çš„æ—¶å€™æåˆ°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™äº›é—®é¢˜ä¸ä»…ä»…æŒ‚é’©äº <code>RocketMQ</code> ï¼Œè€Œæ˜¯åº”è¯¥æ¯ä¸ªæ¶ˆæ¯ä¸­é—´ä»¶éƒ½éœ€è¦å»è§£å†³çš„ã€‚</p><p>åœ¨ä¸Šé¢æˆ‘ä»‹ç» <code>RocketMQ</code> çš„æŠ€æœ¯æ¶æ„çš„æ—¶å€™æˆ‘å·²ç»å‘ä½ å±•ç¤ºäº† <strong>å®ƒæ˜¯å¦‚ä½•ä¿è¯é«˜å¯ç”¨çš„</strong> ï¼Œè¿™é‡Œä¸æ¶‰åŠè¿ç»´æ–¹é¢çš„æ­å»ºï¼Œå¦‚æœä½ æ„Ÿå…´è¶£å¯ä»¥è‡ªå·±å»å®˜ç½‘ä¸Šç…§ç€ä¾‹å­æ­å»ºå±äºä½ è‡ªå·±çš„ <code>RocketMQ</code> é›†ç¾¤ã€‚</p><blockquote><p>å…¶å® <code>Kafka</code> çš„æ¶æ„åŸºæœ¬å’Œ <code>RocketMQ</code> ç±»ä¼¼ï¼Œåªæ˜¯å®ƒæ³¨å†Œä¸­å¿ƒä½¿ç”¨äº† <code>Zookeeper</code> ã€å®ƒçš„ <strong>åˆ†åŒº</strong> å°±ç›¸å½“äº <code>RocketMQ</code> ä¸­çš„ <strong>é˜Ÿåˆ—</strong> ã€‚è¿˜æœ‰ä¸€äº›å°ç»†èŠ‚ä¸åŒä¼šåœ¨åé¢æåˆ°ã€‚</p></blockquote><h3 id="é¡ºåºæ¶ˆè´¹"><a href="#é¡ºåºæ¶ˆè´¹" class="headerlink" title="é¡ºåºæ¶ˆè´¹"></a>é¡ºåºæ¶ˆè´¹</h3><p>åœ¨ä¸Šé¢çš„æŠ€æœ¯æ¶æ„ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† <strong><code>RocketMQ</code> åœ¨ä¸»é¢˜ä¸Šæ˜¯æ— åºçš„ã€å®ƒåªæœ‰åœ¨é˜Ÿåˆ—å±‚é¢æ‰æ˜¯ä¿è¯æœ‰åº</strong> çš„ã€‚</p><p>è¿™åˆæ‰¯åˆ°ä¸¤ä¸ªæ¦‚å¿µâ€”â€”<strong>æ™®é€šé¡ºåº</strong> å’Œ <strong>ä¸¥æ ¼é¡ºåº</strong> ã€‚</p><p>æ‰€è°“æ™®é€šé¡ºåºæ˜¯æŒ‡ æ¶ˆè´¹è€…é€šè¿‡ <strong>åŒä¸€ä¸ªæ¶ˆè´¹é˜Ÿåˆ—æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯æœ‰é¡ºåºçš„</strong> ï¼Œä¸åŒæ¶ˆæ¯é˜Ÿåˆ—æ”¶åˆ°çš„æ¶ˆæ¯åˆ™å¯èƒ½æ˜¯æ— é¡ºåºçš„ã€‚æ™®é€šé¡ºåºæ¶ˆæ¯åœ¨ <code>Broker</code> <strong>é‡å¯æƒ…å†µä¸‹ä¸ä¼šä¿è¯æ¶ˆæ¯é¡ºåºæ€§</strong> (çŸ­æš‚æ—¶é—´) ã€‚</p><p>æ‰€è°“ä¸¥æ ¼é¡ºåºæ˜¯æŒ‡  æ¶ˆè´¹è€…æ”¶åˆ°çš„ <strong>æ‰€æœ‰æ¶ˆæ¯</strong> å‡æ˜¯æœ‰é¡ºåºçš„ã€‚ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ <strong>å³ä½¿åœ¨å¼‚å¸¸æƒ…å†µä¸‹ä¹Ÿä¼šä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§</strong> ã€‚</p><p>ä½†æ˜¯ï¼Œä¸¥æ ¼é¡ºåºçœ‹èµ·æ¥è™½å¥½ï¼Œå®ç°å®ƒå¯ä¼šä»˜å‡ºå·¨å¤§çš„ä»£ä»·ã€‚å¦‚æœä½ ä½¿ç”¨ä¸¥æ ¼é¡ºåºæ¨¡å¼ï¼Œ<code>Broker</code> é›†ç¾¤ä¸­åªè¦æœ‰ä¸€å°æœºå™¨ä¸å¯ç”¨ï¼Œåˆ™æ•´ä¸ªé›†ç¾¤éƒ½ä¸å¯ç”¨ã€‚ä½ è¿˜ç”¨å•¥ï¼Ÿç°åœ¨ä¸»è¦åœºæ™¯ä¹Ÿå°±åœ¨ <code>binlog</code> åŒæ­¥ã€‚</p><p>ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬çš„ <code>MQ</code> éƒ½æ˜¯èƒ½å®¹å¿çŸ­æš‚çš„ä¹±åºï¼Œæ‰€ä»¥æ¨èä½¿ç”¨æ™®é€šé¡ºåºæ¨¡å¼ã€‚</p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬ç°åœ¨ä½¿ç”¨äº† <strong>æ™®é€šé¡ºåºæ¨¡å¼</strong> ï¼Œæˆ‘ä»¬ä»ä¸Šé¢å­¦ä¹ çŸ¥é“äº†åœ¨ <code>Producer</code> ç”Ÿäº§æ¶ˆæ¯çš„æ—¶å€™ä¼šè¿›è¡Œè½®è¯¢(å–å†³ä½ çš„è´Ÿè½½å‡è¡¡ç­–ç•¥)æ¥å‘åŒä¸€ä¸»é¢˜çš„ä¸åŒæ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯ã€‚é‚£ä¹ˆå¦‚æœæ­¤æ—¶æˆ‘æœ‰å‡ ä¸ªæ¶ˆæ¯åˆ†åˆ«æ˜¯åŒä¸€ä¸ªè®¢å•çš„åˆ›å»ºã€æ”¯ä»˜ã€å‘è´§ï¼Œåœ¨è½®è¯¢çš„ç­–ç•¥ä¸‹è¿™ <strong>ä¸‰ä¸ªæ¶ˆæ¯ä¼šè¢«å‘é€åˆ°ä¸åŒé˜Ÿåˆ—</strong> ï¼Œå› ä¸ºåœ¨ä¸åŒçš„é˜Ÿåˆ—æ­¤æ—¶å°±æ— æ³•ä½¿ç”¨ <code>RocketMQ</code> å¸¦æ¥çš„é˜Ÿåˆ—æœ‰åºç‰¹æ€§æ¥ä¿è¯æ¶ˆæ¯æœ‰åºæ€§äº†ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef3874585e096e.jpg.jpg"></p><p>é‚£ä¹ˆï¼Œæ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p><p>å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†çš„ä»…ä»…æ˜¯å°†åŒä¸€è¯­ä¹‰ä¸‹çš„æ¶ˆæ¯æ”¾å…¥åŒä¸€ä¸ªé˜Ÿåˆ—(æ¯”å¦‚è¿™é‡Œæ˜¯åŒä¸€ä¸ªè®¢å•)ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ <strong>Hashå–æ¨¡æ³•</strong> æ¥ä¿è¯åŒä¸€ä¸ªè®¢å•åœ¨åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­å°±è¡Œäº†ã€‚</p><h3 id="é‡å¤æ¶ˆè´¹"><a href="#é‡å¤æ¶ˆè´¹" class="headerlink" title="é‡å¤æ¶ˆè´¹"></a>é‡å¤æ¶ˆè´¹</h3><p>emmmï¼Œå°±ä¸¤ä¸ªå­—â€”â€” <strong>å¹‚ç­‰</strong> ã€‚åœ¨ç¼–ç¨‹ä¸­ä¸€ä¸ª<em>å¹‚ç­‰</em> æ“ä½œçš„ç‰¹ç‚¹æ˜¯å…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚æ¯”å¦‚è¯´ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æœ‰ä¸€ä¸ªè®¢å•çš„å¤„ç†ç§¯åˆ†çš„ç³»ç»Ÿï¼Œæ¯å½“æ¥ä¸€ä¸ªæ¶ˆæ¯çš„æ—¶å€™å®ƒå°±è´Ÿè´£ä¸ºåˆ›å»ºè¿™ä¸ªè®¢å•çš„ç”¨æˆ·çš„ç§¯åˆ†åŠ ä¸Šç›¸åº”çš„æ•°å€¼ã€‚å¯æ˜¯æœ‰ä¸€æ¬¡ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å‘é€ç»™è®¢å•ç³»ç»Ÿ FrancisQ çš„è®¢å•ä¿¡æ¯ï¼Œå…¶è¦æ±‚æ˜¯ç»™ FrancisQ çš„ç§¯åˆ†åŠ ä¸Š 500ã€‚ä½†æ˜¯ç§¯åˆ†ç³»ç»Ÿåœ¨æ”¶åˆ° FrancisQ çš„è®¢å•ä¿¡æ¯å¤„ç†å®Œæˆä¹‹åè¿”å›ç»™æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†æˆåŠŸçš„ä¿¡æ¯çš„æ—¶å€™å‡ºç°äº†ç½‘ç»œæ³¢åŠ¨(å½“ç„¶è¿˜æœ‰å¾ˆå¤šç§æƒ…å†µï¼Œæ¯”å¦‚Brokeræ„å¤–é‡å¯ç­‰ç­‰)ï¼Œè¿™æ¡å›åº”æ²¡æœ‰å‘é€æˆåŠŸã€‚</p><p>é‚£ä¹ˆï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ²¡æ”¶åˆ°ç§¯åˆ†ç³»ç»Ÿçš„å›åº”ä¼šä¸ä¼šå°è¯•é‡å‘è¿™ä¸ªæ¶ˆæ¯ï¼Ÿé—®é¢˜å°±æ¥äº†ï¼Œæˆ‘å†å‘è¿™ä¸ªæ¶ˆæ¯ï¼Œä¸‡ä¸€å®ƒåˆç»™ FrancisQ çš„è´¦æˆ·åŠ ä¸Š 500 ç§¯åˆ†æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»™æˆ‘ä»¬çš„æ¶ˆè´¹è€…å®ç° <strong>å¹‚ç­‰</strong> ï¼Œä¹Ÿå°±æ˜¯å¯¹åŒä¸€ä¸ªæ¶ˆæ¯çš„å¤„ç†ç»“æœï¼Œæ‰§è¡Œå¤šå°‘æ¬¡éƒ½ä¸å˜ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•ç»™ä¸šåŠ¡å®ç°å¹‚ç­‰å‘¢ï¼Ÿè¿™ä¸ªè¿˜æ˜¯éœ€è¦ç»“åˆå…·ä½“çš„ä¸šåŠ¡çš„ã€‚ä½ å¯ä»¥ä½¿ç”¨ <strong>å†™å…¥ <code>Redis</code></strong> æ¥ä¿è¯ï¼Œå› ä¸º <code>Redis</code> çš„ <code>key</code> å’Œ <code>value</code> å°±æ˜¯å¤©ç„¶æ”¯æŒå¹‚ç­‰çš„ã€‚å½“ç„¶è¿˜æœ‰ä½¿ç”¨ <strong>æ•°æ®åº“æ’å…¥æ³•</strong> ï¼ŒåŸºäºæ•°æ®åº“çš„å”¯ä¸€é”®æ¥ä¿è¯é‡å¤æ•°æ®ä¸ä¼šè¢«æ’å…¥å¤šæ¡ã€‚</p><p>ä¸è¿‡æœ€ä¸»è¦çš„è¿˜æ˜¯éœ€è¦ <strong>æ ¹æ®ç‰¹å®šåœºæ™¯ä½¿ç”¨ç‰¹å®šçš„è§£å†³æ–¹æ¡ˆ</strong> ï¼Œä½ è¦çŸ¥é“ä½ çš„æ¶ˆæ¯æ¶ˆè´¹æ˜¯å¦æ˜¯å®Œå…¨ä¸å¯é‡å¤æ¶ˆè´¹è¿˜æ˜¯å¯ä»¥å¿å—é‡å¤æ¶ˆè´¹çš„ï¼Œç„¶åå†é€‰æ‹©å¼ºæ ¡éªŒå’Œå¼±æ ¡éªŒçš„æ–¹å¼ã€‚æ¯•ç«Ÿåœ¨ CS é¢†åŸŸè¿˜æ˜¯å¾ˆå°‘æœ‰æŠ€æœ¯é“¶å¼¹çš„è¯´æ³•ã€‚</p><p>è€Œåœ¨æ•´ä¸ªäº’è”ç½‘é¢†åŸŸï¼Œå¹‚ç­‰ä¸ä»…ä»…é€‚ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—çš„é‡å¤æ¶ˆè´¹é—®é¢˜ï¼Œè¿™äº›å®ç°å¹‚ç­‰çš„æ–¹æ³•ï¼Œä¹ŸåŒæ ·é€‚ç”¨äºï¼Œ<strong>åœ¨å…¶ä»–åœºæ™¯ä¸­æ¥è§£å†³é‡å¤è¯·æ±‚æˆ–è€…é‡å¤è°ƒç”¨çš„é—®é¢˜</strong> ã€‚æ¯”å¦‚å°†HTTPæœåŠ¡è®¾è®¡æˆå¹‚ç­‰çš„ï¼Œ<strong>è§£å†³å‰ç«¯æˆ–è€…APPé‡å¤æäº¤è¡¨å•æ•°æ®çš„é—®é¢˜</strong> ï¼Œä¹Ÿå¯ä»¥å°†ä¸€ä¸ªå¾®æœåŠ¡è®¾è®¡æˆå¹‚ç­‰çš„ï¼Œè§£å†³ <code>RPC</code> æ¡†æ¶è‡ªåŠ¨é‡è¯•å¯¼è‡´çš„ <strong>é‡å¤è°ƒç”¨é—®é¢˜</strong> ã€‚</p><h2 id="åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡"></a>åˆ†å¸ƒå¼äº‹åŠ¡</h2><p>å¦‚ä½•è§£é‡Šåˆ†å¸ƒå¼äº‹åŠ¡å‘¢ï¼Ÿäº‹åŠ¡å¤§å®¶éƒ½çŸ¥é“å§ï¼Ÿ<strong>è¦ä¹ˆéƒ½æ‰§è¡Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ</strong> ã€‚åœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸­æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å®ç°äº‹åŠ¡ï¼Œä½†æ˜¯åœ¨åˆ†å¸ƒå¼æ¶æ„ä¸­ï¼Œæˆ‘ä»¬æœ‰å¾ˆå¤šæœåŠ¡æ˜¯éƒ¨ç½²åœ¨ä¸åŒç³»ç»Ÿä¹‹é—´çš„ï¼Œè€Œä¸åŒæœåŠ¡ä¹‹é—´åˆéœ€è¦è¿›è¡Œè°ƒç”¨ã€‚æ¯”å¦‚æ­¤æ—¶æˆ‘ä¸‹è®¢å•ç„¶åå¢åŠ ç§¯åˆ†ï¼Œå¦‚æœä¿è¯ä¸äº†åˆ†å¸ƒå¼äº‹åŠ¡çš„è¯ï¼Œå°±ä¼šå‡ºç°Aç³»ç»Ÿä¸‹äº†è®¢å•ï¼Œä½†æ˜¯Bç³»ç»Ÿå¢åŠ ç§¯åˆ†å¤±è´¥æˆ–è€…Aç³»ç»Ÿæ²¡æœ‰ä¸‹è®¢å•ï¼ŒBç³»ç»Ÿå´å¢åŠ äº†ç§¯åˆ†ã€‚å‰è€…å¯¹ç”¨æˆ·ä¸å‹å¥½ï¼Œåè€…å¯¹è¿è¥å•†ä¸åˆ©ï¼Œè¿™æ˜¯æˆ‘ä»¬éƒ½ä¸æ„¿æ„è§åˆ°çš„ã€‚</p><p>é‚£ä¹ˆï¼Œå¦‚ä½•å»è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p><p>å¦‚ä»Šæ¯”è¾ƒå¸¸è§çš„åˆ†å¸ƒå¼äº‹åŠ¡å®ç°æœ‰ 2PCã€TCC å’Œäº‹åŠ¡æ¶ˆæ¯(half åŠæ¶ˆæ¯æœºåˆ¶)ã€‚æ¯ä¸€ç§å®ç°éƒ½æœ‰å…¶ç‰¹å®šçš„ä½¿ç”¨åœºæ™¯ï¼Œä½†æ˜¯ä¹Ÿæœ‰å„è‡ªçš„é—®é¢˜ï¼Œ<strong>éƒ½ä¸æ˜¯å®Œç¾çš„è§£å†³æ–¹æ¡ˆ</strong>ã€‚</p><p>åœ¨ <code>RocketMQ</code> ä¸­ä½¿ç”¨çš„æ˜¯ <strong>äº‹åŠ¡æ¶ˆæ¯åŠ ä¸Šäº‹åŠ¡åæŸ¥æœºåˆ¶</strong> æ¥è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜çš„ã€‚æˆ‘ç”»äº†å¼ å›¾ï¼Œå¤§å®¶å¯ä»¥å¯¹ç…§ç€å›¾è¿›è¡Œç†è§£ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef38798d7a987f.png.jpg"></p><p>åœ¨ç¬¬ä¸€æ­¥å‘é€çš„ half æ¶ˆæ¯ ï¼Œå®ƒçš„æ„æ€æ˜¯ <strong>åœ¨äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œå¯¹äºæ¶ˆè´¹è€…æ¥è¯´ï¼Œè¿™ä¸ªæ¶ˆæ¯æ˜¯ä¸å¯è§çš„</strong> ã€‚</p><blockquote><p>é‚£ä¹ˆï¼Œå¦‚ä½•åšåˆ°å†™å…¥æ¶ˆæ¯ä½†æ˜¯å¯¹ç”¨æˆ·ä¸å¯è§å‘¢ï¼ŸRocketMQäº‹åŠ¡æ¶ˆæ¯çš„åšæ³•æ˜¯ï¼šå¦‚æœæ¶ˆæ¯æ˜¯halfæ¶ˆæ¯ï¼Œå°†å¤‡ä»½åŸæ¶ˆæ¯çš„ä¸»é¢˜ä¸æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œç„¶å <strong>æ”¹å˜ä¸»é¢˜</strong> ä¸ºRMQ_SYS_TRANS_HALF_TOPICã€‚ç”±äºæ¶ˆè´¹ç»„æœªè®¢é˜…è¯¥ä¸»é¢˜ï¼Œæ•…æ¶ˆè´¹ç«¯æ— æ³•æ¶ˆè´¹halfç±»å‹çš„æ¶ˆæ¯ï¼Œ<strong>ç„¶åRocketMQä¼šå¼€å¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œä»Topicä¸ºRMQ_SYS_TRANS_HALF_TOPICä¸­æ‹‰å–æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹</strong>ï¼Œæ ¹æ®ç”Ÿäº§è€…ç»„è·å–ä¸€ä¸ªæœåŠ¡æä¾›è€…å‘é€å›æŸ¥äº‹åŠ¡çŠ¶æ€è¯·æ±‚ï¼Œæ ¹æ®äº‹åŠ¡çŠ¶æ€æ¥å†³å®šæ˜¯æäº¤æˆ–å›æ»šæ¶ˆæ¯ã€‚</p></blockquote><p>ä½ å¯ä»¥è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæ²¡æœ‰ä»ç¬¬5æ­¥å¼€å§‹çš„ <strong>äº‹åŠ¡åæŸ¥æœºåˆ¶</strong> ï¼Œå¦‚æœå‡ºç°ç½‘è·¯æ³¢åŠ¨ç¬¬4æ­¥æ²¡æœ‰å‘é€æˆåŠŸï¼Œè¿™æ ·å°±ä¼šäº§ç”Ÿ MQ ä¸çŸ¥é“æ˜¯ä¸æ˜¯éœ€è¦ç»™æ¶ˆè´¹è€…æ¶ˆè´¹çš„é—®é¢˜ï¼Œä»–å°±åƒä¸€ä¸ªæ— å¤´è‹è‡ä¸€æ ·ã€‚åœ¨ <code>RocketMQ</code> ä¸­å°±æ˜¯ä½¿ç”¨çš„ä¸Šè¿°çš„äº‹åŠ¡åæŸ¥æ¥è§£å†³çš„ï¼Œè€Œåœ¨ <code>Kafka</code> ä¸­é€šå¸¸æ˜¯ç›´æ¥æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸è®©ç”¨æˆ·æ¥è‡ªè¡Œè§£å†³ã€‚</p><p>ä½ è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ <code>MQ Server</code> æŒ‡å‘ç³»ç»ŸBçš„æ“ä½œå·²ç»å’Œç³»ç»ŸAä¸ç›¸å…³äº†ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯â€”â€”<strong>æœ¬åœ°äº‹åŠ¡å’Œå­˜å‚¨æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—æ‰æ˜¯åŒä¸€ä¸ªäº‹åŠ¡</strong>ã€‚è¿™æ ·ä¹Ÿå°±äº§ç”Ÿäº†äº‹åŠ¡çš„<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼Œå› ä¸ºæ•´ä¸ªè¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼Œ<strong>æ¯ä¸ªç³»ç»Ÿåªè¦ä¿è¯å®ƒè‡ªå·±é‚£ä¸€éƒ¨åˆ†çš„äº‹åŠ¡å°±è¡Œäº†</strong>ã€‚</p><h2 id="æ¶ˆæ¯å †ç§¯é—®é¢˜"><a href="#æ¶ˆæ¯å †ç§¯é—®é¢˜" class="headerlink" title="æ¶ˆæ¯å †ç§¯é—®é¢˜"></a>æ¶ˆæ¯å †ç§¯é—®é¢˜</h2><p>åœ¨ä¸Šé¢æˆ‘ä»¬æåˆ°äº†æ¶ˆæ¯é˜Ÿåˆ—ä¸€ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½â€”â€”<strong>å‰Šå³°</strong> ã€‚é‚£ä¹ˆå¦‚æœè¿™ä¸ªå³°å€¼å¤ªå¤§äº†å¯¼è‡´æ¶ˆæ¯å †ç§¯åœ¨é˜Ÿåˆ—ä¸­æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>å…¶å®è¿™ä¸ªé—®é¢˜å¯ä»¥å°†å®ƒå¹¿ä¹‰åŒ–ï¼Œå› ä¸ºäº§ç”Ÿæ¶ˆæ¯å †ç§¯çš„æ ¹æºå…¶å®å°±åªæœ‰ä¸¤ä¸ªâ€”â€”ç”Ÿäº§è€…ç”Ÿäº§å¤ªå¿«æˆ–è€…æ¶ˆè´¹è€…æ¶ˆè´¹å¤ªæ…¢ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä»å¤šä¸ªè§’åº¦å»æ€è€ƒè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå½“æµé‡åˆ°å³°å€¼çš„æ—¶å€™æ˜¯å› ä¸ºç”Ÿäº§è€…ç”Ÿäº§å¤ªå¿«ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº› <strong>é™æµé™çº§</strong> çš„æ–¹æ³•ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥å¢åŠ å¤šä¸ªæ¶ˆè´¹è€…å®ä¾‹å»æ°´å¹³æ‰©å±•å¢åŠ æ¶ˆè´¹èƒ½åŠ›æ¥åŒ¹é…ç”Ÿäº§çš„æ¿€å¢ã€‚å¦‚æœæ¶ˆè´¹è€…æ¶ˆè´¹è¿‡æ…¢çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæ£€æŸ¥ <strong>æ˜¯å¦æ˜¯æ¶ˆè´¹è€…å‡ºç°äº†å¤§é‡çš„æ¶ˆè´¹é”™è¯¯</strong> ï¼Œæˆ–è€…æ‰“å°ä¸€ä¸‹æ—¥å¿—æŸ¥çœ‹æ˜¯å¦æ˜¯å“ªä¸€ä¸ªçº¿ç¨‹å¡æ­»ï¼Œå‡ºç°äº†é”èµ„æºä¸é‡Šæ”¾ç­‰ç­‰çš„é—®é¢˜ã€‚</p><blockquote><p>å½“ç„¶ï¼Œæœ€å¿«é€Ÿè§£å†³æ¶ˆæ¯å †ç§¯é—®é¢˜çš„æ–¹æ³•è¿˜æ˜¯å¢åŠ æ¶ˆè´¹è€…å®ä¾‹ï¼Œä¸è¿‡ <strong>åŒæ—¶ä½ è¿˜éœ€è¦å¢åŠ æ¯ä¸ªä¸»é¢˜çš„é˜Ÿåˆ—æ•°é‡</strong> ã€‚</p><p>åˆ«å¿˜äº†åœ¨ <code>RocketMQ</code> ä¸­ï¼Œ<strong>ä¸€ä¸ªé˜Ÿåˆ—åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹</strong> ï¼Œå¦‚æœä½ ä»…ä»…æ˜¯å¢åŠ æ¶ˆè´¹è€…å®ä¾‹å°±ä¼šå‡ºç°æˆ‘ä¸€å¼€å§‹ç»™ä½ ç”»æ¶æ„å›¾çš„é‚£ç§æƒ…å†µã€‚</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef387d939ab66d.jpg.jpg"></p><h2 id="å›æº¯æ¶ˆè´¹"><a href="#å›æº¯æ¶ˆè´¹" class="headerlink" title="å›æº¯æ¶ˆè´¹"></a>å›æº¯æ¶ˆè´¹</h2><p>å›æº¯æ¶ˆè´¹æ˜¯æŒ‡ <code>Consumer</code> å·²ç»æ¶ˆè´¹æˆåŠŸçš„æ¶ˆæ¯ï¼Œç”±äºä¸šåŠ¡ä¸Šéœ€æ±‚éœ€è¦é‡æ–°æ¶ˆè´¹ï¼Œåœ¨<code>RocketMQ</code> ä¸­ï¼Œ <code>Broker</code> åœ¨å‘<code>Consumer</code> æŠ•é€’æˆåŠŸæ¶ˆæ¯åï¼Œ<strong>æ¶ˆæ¯ä»ç„¶éœ€è¦ä¿ç•™</strong> ã€‚å¹¶ä¸”é‡æ–°æ¶ˆè´¹ä¸€èˆ¬æ˜¯æŒ‰ç…§æ—¶é—´ç»´åº¦ï¼Œä¾‹å¦‚ç”±äº <code>Consumer</code> ç³»ç»Ÿæ•…éšœï¼Œæ¢å¤åéœ€è¦é‡æ–°æ¶ˆè´¹1å°æ—¶å‰çš„æ•°æ®ï¼Œé‚£ä¹ˆ <code>Broker</code> è¦æä¾›ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥æŒ‰ç…§æ—¶é—´ç»´åº¦æ¥å›é€€æ¶ˆè´¹è¿›åº¦ã€‚<code>RocketMQ</code> æ”¯æŒæŒ‰ç…§æ—¶é—´å›æº¯æ¶ˆè´¹ï¼Œæ—¶é—´ç»´åº¦ç²¾ç¡®åˆ°æ¯«ç§’ã€‚</p><p>è¿™æ˜¯å®˜æ–¹æ–‡æ¡£çš„è§£é‡Šï¼Œæˆ‘ç›´æ¥ç…§æ¬è¿‡æ¥å°±å½“ç§‘æ™®äº†ğŸ˜ğŸ˜ğŸ˜ã€‚</p><h2 id="RocketMQ-çš„åˆ·ç›˜æœºåˆ¶"><a href="#RocketMQ-çš„åˆ·ç›˜æœºåˆ¶" class="headerlink" title="RocketMQ çš„åˆ·ç›˜æœºåˆ¶"></a>RocketMQ çš„åˆ·ç›˜æœºåˆ¶</h2><p>ä¸Šé¢æˆ‘è®²äº†é‚£ä¹ˆå¤šçš„ <code>RocketMQ</code> çš„æ¶æ„å’Œè®¾è®¡åŸç†ï¼Œä½ æœ‰æ²¡æœ‰å¥½å¥‡</p><p>åœ¨ <code>Topic</code> ä¸­çš„ <strong>é˜Ÿåˆ—æ˜¯ä»¥ä»€ä¹ˆæ ·çš„å½¢å¼å­˜åœ¨çš„ï¼Ÿ</strong></p><p><strong>é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åˆæ˜¯å¦‚ä½•è¿›è¡Œå­˜å‚¨æŒä¹…åŒ–çš„å‘¢ï¼Ÿ</strong></p><p>æˆ‘åœ¨ä¸Šæ–‡ä¸­æåˆ°çš„ <strong>åŒæ­¥åˆ·ç›˜</strong> å’Œ <strong>å¼‚æ­¥åˆ·ç›˜</strong> åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒä»¬ä¼šç»™æŒä¹…åŒ–å¸¦æ¥ä»€ä¹ˆæ ·çš„å½±å“å‘¢ï¼Ÿ</p><p>ä¸‹é¢æˆ‘å°†ç»™ä½ ä»¬ä¸€ä¸€è§£é‡Šã€‚</p><h3 id="åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜"><a href="#åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜" class="headerlink" title="åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜"></a>åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜</h3><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef387fba311cda.jpg.jpg"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨åŒæ­¥åˆ·ç›˜ä¸­éœ€è¦ç­‰å¾…ä¸€ä¸ªåˆ·ç›˜æˆåŠŸçš„ <code>ACK</code> ï¼ŒåŒæ­¥åˆ·ç›˜å¯¹ <code>MQ</code> æ¶ˆæ¯å¯é æ€§æ¥è¯´æ˜¯ä¸€ç§ä¸é”™çš„ä¿éšœï¼Œä½†æ˜¯ <strong>æ€§èƒ½ä¸Šä¼šæœ‰è¾ƒå¤§å½±å“</strong> ï¼Œä¸€èˆ¬åœ°é€‚ç”¨äºé‡‘èç­‰ç‰¹å®šä¸šåŠ¡åœºæ™¯ã€‚</p><p>è€Œå¼‚æ­¥åˆ·ç›˜å¾€å¾€æ˜¯å¼€å¯ä¸€ä¸ªçº¿ç¨‹å»å¼‚æ­¥åœ°æ‰§è¡Œåˆ·ç›˜æ“ä½œã€‚æ¶ˆæ¯åˆ·ç›˜é‡‡ç”¨åå°å¼‚æ­¥çº¿ç¨‹æäº¤çš„æ–¹å¼è¿›è¡Œï¼Œ <strong>é™ä½äº†è¯»å†™å»¶è¿Ÿ</strong> ï¼Œæé«˜äº† <code>MQ</code> çš„æ€§èƒ½å’Œååé‡ï¼Œä¸€èˆ¬é€‚ç”¨äºå¦‚å‘éªŒè¯ç ç­‰å¯¹äºæ¶ˆæ¯ä¿è¯è¦æ±‚ä¸å¤ªé«˜çš„ä¸šåŠ¡åœºæ™¯ã€‚</p><p>ä¸€èˆ¬åœ°ï¼Œ<strong>å¼‚æ­¥åˆ·ç›˜åªæœ‰åœ¨ <code>Broker</code> æ„å¤–å®•æœºçš„æ—¶å€™ä¼šä¸¢å¤±éƒ¨åˆ†æ•°æ®</strong>ï¼Œä½ å¯ä»¥è®¾ç½® <code>Broker</code> çš„å‚æ•° <code>FlushDiskType</code> æ¥è°ƒæ•´ä½ çš„åˆ·ç›˜ç­–ç•¥(ASYNC_FLUSH æˆ–è€… SYNC_FLUSH)ã€‚</p><h3 id="åŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶"><a href="#åŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶" class="headerlink" title="åŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶"></a>åŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶</h3><p>ä¸Šé¢çš„åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜æ˜¯åœ¨å•ä¸ªç»“ç‚¹å±‚é¢çš„ï¼Œè€ŒåŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶ä¸»è¦æ˜¯æŒ‡çš„ <code>Borker</code> ä¸»ä»æ¨¡å¼ä¸‹ï¼Œä¸»èŠ‚ç‚¹è¿”å›æ¶ˆæ¯ç»™å®¢æˆ·ç«¯çš„æ—¶å€™æ˜¯å¦éœ€è¦åŒæ­¥ä»èŠ‚ç‚¹ã€‚</p><ul><li>åŒæ­¥å¤åˆ¶ï¼š ä¹Ÿå« â€œåŒæ­¥åŒå†™â€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>åªæœ‰æ¶ˆæ¯åŒæ­¥åŒå†™åˆ°ä¸»ä»ç»“ç‚¹ä¸Šæ—¶æ‰è¿”å›å†™å…¥æˆåŠŸ</strong> ã€‚</li><li>å¼‚æ­¥å¤åˆ¶ï¼š <strong>æ¶ˆæ¯å†™å…¥ä¸»èŠ‚ç‚¹ä¹‹åå°±ç›´æ¥è¿”å›å†™å…¥æˆåŠŸ</strong> ã€‚</li></ul><p>ç„¶è€Œï¼Œå¾ˆå¤šäº‹æƒ…æ˜¯æ²¡æœ‰å®Œç¾çš„æ–¹æ¡ˆçš„ï¼Œå°±æ¯”å¦‚æˆ‘ä»¬è¿›è¡Œæ¶ˆæ¯å†™å…¥çš„èŠ‚ç‚¹è¶Šå¤šå°±æ›´èƒ½ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ï¼Œä½†æ˜¯éšä¹‹çš„æ€§èƒ½ä¹Ÿä¼šä¸‹é™ï¼Œæ‰€ä»¥éœ€è¦ç¨‹åºå‘˜æ ¹æ®ç‰¹å®šä¸šåŠ¡åœºæ™¯å»é€‰æ‹©é€‚åº”çš„ä¸»ä»å¤åˆ¶æ–¹æ¡ˆã€‚</p><p>é‚£ä¹ˆï¼Œ<strong>å¼‚æ­¥å¤åˆ¶ä¼šä¸ä¼šä¹Ÿåƒå¼‚æ­¥åˆ·ç›˜é‚£æ ·å½±å“æ¶ˆæ¯çš„å¯é æ€§å‘¢ï¼Ÿ</strong></p><p>ç­”æ¡ˆæ˜¯ä¸ä¼šçš„ï¼Œå› ä¸ºä¸¤è€…å°±æ˜¯ä¸åŒçš„æ¦‚å¿µï¼Œå¯¹äºæ¶ˆæ¯å¯é æ€§æ˜¯é€šè¿‡ä¸åŒçš„åˆ·ç›˜ç­–ç•¥ä¿è¯çš„ï¼Œè€Œåƒå¼‚æ­¥åŒæ­¥å¤åˆ¶ç­–ç•¥ä»…ä»…æ˜¯å½±å“åˆ°äº† <strong>å¯ç”¨æ€§</strong> ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå…¶ä¸»è¦åŸå› <strong>æ˜¯ <code>RocketMQ</code> æ˜¯ä¸æ”¯æŒè‡ªåŠ¨ä¸»ä»åˆ‡æ¢çš„ï¼Œå½“ä¸»èŠ‚ç‚¹æŒ‚æ‰ä¹‹åï¼Œç”Ÿäº§è€…å°±ä¸èƒ½å†ç»™è¿™ä¸ªä¸»èŠ‚ç‚¹ç”Ÿäº§æ¶ˆæ¯äº†</strong>ã€‚</p><p>æ¯”å¦‚è¿™ä¸ªæ—¶å€™é‡‡ç”¨å¼‚æ­¥å¤åˆ¶çš„æ–¹å¼ï¼Œåœ¨ä¸»èŠ‚ç‚¹è¿˜æœªå‘é€å®Œéœ€è¦åŒæ­¥çš„æ¶ˆæ¯çš„æ—¶å€™ä¸»èŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œè¿™ä¸ªæ—¶å€™ä»èŠ‚ç‚¹å°±å°‘äº†ä¸€éƒ¨åˆ†æ¶ˆæ¯ã€‚ä½†æ˜¯æ­¤æ—¶ç”Ÿäº§è€…æ— æ³•å†ç»™ä¸»èŠ‚ç‚¹ç”Ÿäº§æ¶ˆæ¯äº†ï¼Œ<strong>æ¶ˆè´¹è€…å¯ä»¥è‡ªåŠ¨åˆ‡æ¢åˆ°ä»èŠ‚ç‚¹è¿›è¡Œæ¶ˆè´¹</strong>(ä»…ä»…æ˜¯æ¶ˆè´¹)ï¼Œæ‰€ä»¥åœ¨ä¸»èŠ‚ç‚¹æŒ‚æ‰çš„æ—¶é—´åªä¼šäº§ç”Ÿä¸»ä»ç»“ç‚¹çŸ­æš‚çš„æ¶ˆæ¯ä¸ä¸€è‡´çš„æƒ…å†µï¼Œé™ä½äº†å¯ç”¨æ€§ï¼Œè€Œå½“ä¸»èŠ‚ç‚¹é‡å¯ä¹‹åï¼Œä»èŠ‚ç‚¹é‚£éƒ¨åˆ†æœªæ¥å¾—åŠå¤åˆ¶çš„æ¶ˆæ¯è¿˜ä¼šç»§ç»­å¤åˆ¶ã€‚</p><p>åœ¨å•ä¸»ä»æ¶æ„ä¸­ï¼Œå¦‚æœä¸€ä¸ªä¸»èŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆä¹Ÿå°±æ„å‘³ç€æ•´ä¸ªç³»ç»Ÿä¸èƒ½å†ç”Ÿäº§äº†ã€‚é‚£ä¹ˆè¿™ä¸ªå¯ç”¨æ€§çš„é—®é¢˜èƒ½å¦è§£å†³å‘¢ï¼Ÿ<strong>ä¸€ä¸ªä¸»ä»ä¸è¡Œé‚£å°±å¤šä¸ªä¸»ä»çš„å‘—</strong>ï¼Œåˆ«å¿˜äº†åœ¨æˆ‘ä»¬æœ€åˆçš„æ¶æ„å›¾ä¸­ï¼Œæ¯ä¸ª <code>Topic</code> æ˜¯åˆ†å¸ƒåœ¨ä¸åŒ <code>Broker</code> ä¸­çš„ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef38687488a5a4.jpg.jpg"></p><p>ä½†æ˜¯è¿™ç§å¤åˆ¶æ–¹å¼åŒæ ·ä¹Ÿä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯æ— æ³•ä¿è¯ <strong>ä¸¥æ ¼é¡ºåº</strong> ã€‚åœ¨ä¸Šæ–‡ä¸­æˆ‘ä»¬æåˆ°äº†å¦‚ä½•ä¿è¯çš„æ¶ˆæ¯é¡ºåºæ€§æ˜¯é€šè¿‡å°†ä¸€ä¸ªè¯­ä¹‰çš„æ¶ˆæ¯å‘é€åœ¨åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œä½¿ç”¨ <code>Topic</code> ä¸‹çš„é˜Ÿåˆ—æ¥ä¿è¯é¡ºåºæ€§çš„ã€‚å¦‚æœæ­¤æ—¶æˆ‘ä»¬ä¸»èŠ‚ç‚¹Aè´Ÿè´£çš„æ˜¯è®¢å•Açš„ä¸€ç³»åˆ—è¯­ä¹‰æ¶ˆæ¯ï¼Œç„¶åå®ƒæŒ‚äº†ï¼Œè¿™æ ·å…¶ä»–èŠ‚ç‚¹æ˜¯æ— æ³•ä»£æ›¿ä¸»èŠ‚ç‚¹Açš„ï¼Œå¦‚æœæˆ‘ä»¬ä»»æ„èŠ‚ç‚¹éƒ½å¯ä»¥å­˜å…¥ä»»ä½•æ¶ˆæ¯ï¼Œé‚£å°±æ²¡æœ‰é¡ºåºæ€§å¯è¨€äº†ã€‚</p><p>è€Œåœ¨ <code>RocketMQ</code> ä¸­é‡‡ç”¨äº† <code>Dledger</code> è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä»–è¦æ±‚åœ¨å†™å…¥æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¦æ±‚<strong>è‡³å°‘æ¶ˆæ¯å¤åˆ¶åˆ°åŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹ä¹‹å</strong>ï¼Œæ‰ç»™å®¢â¼¾ç«¯è¿”å›å†™â¼ŠæˆåŠŸï¼Œå¹¶ä¸”å®ƒæ˜¯â½€æŒé€šè¿‡é€‰ä¸¾æ¥åŠ¨æ€åˆ‡æ¢ä¸»èŠ‚ç‚¹çš„ã€‚è¿™é‡Œæˆ‘å°±ä¸å±•å¼€è¯´æ˜äº†ï¼Œè¯»è€…å¯ä»¥è‡ªå·±å»äº†è§£ã€‚</p><blockquote><p>ä¹Ÿä¸æ˜¯è¯´ <code>Dledger</code> æ˜¯ä¸ªå®Œç¾çš„æ–¹æ¡ˆï¼Œè‡³å°‘åœ¨ <code>Dledger</code> é€‰ä¸¾è¿‡ç¨‹ä¸­æ˜¯æ— æ³•æä¾›æœåŠ¡çš„ï¼Œè€Œä¸”ä»–å¿…é¡»è¦ä½¿ç”¨ä¸‰ä¸ªèŠ‚ç‚¹æˆ–ä»¥ä¸Šï¼Œå¦‚æœå¤šæ•°èŠ‚ç‚¹åŒæ—¶æŒ‚æ‰ä»–ä¹Ÿæ˜¯æ— æ³•ä¿è¯å¯ç”¨æ€§çš„ï¼Œè€Œä¸”è¦æ±‚æ¶ˆæ¯å¤åˆ¶æ¿ä¹¦ä»¥ä¸ŠèŠ‚ç‚¹çš„æ•ˆç‡å’Œç›´æ¥å¼‚æ­¥å¤åˆ¶è¿˜æ˜¯æœ‰ä¸€å®šçš„å·®è·çš„ã€‚</p></blockquote><h3 id="å­˜å‚¨æœºåˆ¶"><a href="#å­˜å‚¨æœºåˆ¶" class="headerlink" title="å­˜å‚¨æœºåˆ¶"></a>å­˜å‚¨æœºåˆ¶</h3><p>è¿˜è®°å¾—ä¸Šé¢æˆ‘ä»¬ä¸€å¼€å§‹çš„ä¸‰ä¸ªé—®é¢˜å—ï¼Ÿåˆ°è¿™é‡Œç¬¬ä¸‰ä¸ªé—®é¢˜å·²ç»è§£å†³äº†ã€‚</p><p>ä½†æ˜¯ï¼Œåœ¨ <code>Topic</code> ä¸­çš„ <strong>é˜Ÿåˆ—æ˜¯ä»¥ä»€ä¹ˆæ ·çš„å½¢å¼å­˜åœ¨çš„ï¼Ÿé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åˆæ˜¯å¦‚ä½•è¿›è¡Œå­˜å‚¨æŒä¹…åŒ–çš„å‘¢ï¼Ÿ</strong> è¿˜æœªè§£å†³ï¼Œå…¶å®è¿™é‡Œæ¶‰åŠåˆ°äº† <code>RocketMQ</code> æ˜¯å¦‚ä½•è®¾è®¡å®ƒçš„å­˜å‚¨ç»“æ„äº†ã€‚æˆ‘é¦–å…ˆæƒ³å¤§å®¶ä»‹ç» <code>RocketMQ</code> æ¶ˆæ¯å­˜å‚¨æ¶æ„ä¸­çš„ä¸‰å¤§è§’è‰²â€”â€”<code>CommitLog</code> ã€<code>ConsumeQueue</code> å’Œ <code>IndexFile</code> ã€‚</p><ul><li><code>CommitLog</code>ï¼š <strong>æ¶ˆæ¯ä¸»ä½“ä»¥åŠå…ƒæ•°æ®çš„å­˜å‚¨ä¸»ä½“</strong>ï¼Œå­˜å‚¨ <code>Producer</code> ç«¯å†™å…¥çš„æ¶ˆæ¯ä¸»ä½“å†…å®¹,æ¶ˆæ¯å†…å®¹ä¸æ˜¯å®šé•¿çš„ã€‚å•ä¸ªæ–‡ä»¶å¤§å°é»˜è®¤1G ï¼Œæ–‡ä»¶åé•¿åº¦ä¸º20ä½ï¼Œå·¦è¾¹è¡¥é›¶ï¼Œå‰©ä½™ä¸ºèµ·å§‹åç§»é‡ï¼Œæ¯”å¦‚00000000000000000000ä»£è¡¨äº†ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œèµ·å§‹åç§»é‡ä¸º0ï¼Œæ–‡ä»¶å¤§å°ä¸º1G=1073741824ï¼›å½“ç¬¬ä¸€ä¸ªæ–‡ä»¶å†™æ»¡äº†ï¼Œç¬¬äºŒä¸ªæ–‡ä»¶ä¸º00000000001073741824ï¼Œèµ·å§‹åç§»é‡ä¸º1073741824ï¼Œä»¥æ­¤ç±»æ¨ã€‚æ¶ˆæ¯ä¸»è¦æ˜¯<strong>é¡ºåºå†™å…¥æ—¥å¿—æ–‡ä»¶</strong>ï¼Œå½“æ–‡ä»¶æ»¡äº†ï¼Œå†™å…¥ä¸‹ä¸€ä¸ªæ–‡ä»¶ã€‚</li><li><code>ConsumeQueue</code>ï¼š æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œ<strong>å¼•å…¥çš„ç›®çš„ä¸»è¦æ˜¯æé«˜æ¶ˆæ¯æ¶ˆè´¹çš„æ€§èƒ½</strong>(æˆ‘ä»¬å†å‰é¢ä¹Ÿè®²äº†)ï¼Œç”±äº<code>RocketMQ</code> æ˜¯åŸºäºä¸»é¢˜ <code>Topic</code> çš„è®¢é˜…æ¨¡å¼ï¼Œæ¶ˆæ¯æ¶ˆè´¹æ˜¯é’ˆå¯¹ä¸»é¢˜è¿›è¡Œçš„ï¼Œå¦‚æœè¦éå† <code>commitlog</code> æ–‡ä»¶ä¸­æ ¹æ® <code>Topic</code> æ£€ç´¢æ¶ˆæ¯æ˜¯éå¸¸ä½æ•ˆçš„ã€‚<code>Consumer</code> å³å¯æ ¹æ® <code>ConsumeQueue</code> æ¥æŸ¥æ‰¾å¾…æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚å…¶ä¸­ï¼Œ<code>ConsumeQueue</code>ï¼ˆé€»è¾‘æ¶ˆè´¹é˜Ÿåˆ—ï¼‰<strong>ä½œä¸ºæ¶ˆè´¹æ¶ˆæ¯çš„ç´¢å¼•</strong>ï¼Œä¿å­˜äº†æŒ‡å®š <code>Topic</code> ä¸‹çš„é˜Ÿåˆ—æ¶ˆæ¯åœ¨ <code>CommitLog</code> ä¸­çš„<strong>èµ·å§‹ç‰©ç†åç§»é‡ <code>offset</code> **ï¼Œæ¶ˆæ¯å¤§å° <code>size</code> å’Œæ¶ˆæ¯ <code>Tag</code> çš„ <code>HashCode</code> å€¼ã€‚</strong><code>consumequeue</code> æ–‡ä»¶å¯ä»¥çœ‹æˆæ˜¯åŸºäº <code>topic</code> çš„ <code>commitlog</code> ç´¢å¼•æ–‡ä»¶**ï¼Œæ•… <code>consumequeue</code> æ–‡ä»¶å¤¹çš„ç»„ç»‡æ–¹å¼å¦‚ä¸‹ï¼štopic/queue/fileä¸‰å±‚ç»„ç»‡ç»“æ„ï¼Œå…·ä½“å­˜å‚¨è·¯å¾„ä¸ºï¼š$HOME/store/consumequeue/{topic}/{queueId}/{fileName}ã€‚åŒæ · <code>consumequeue</code> æ–‡ä»¶é‡‡å–å®šé•¿è®¾è®¡ï¼Œæ¯ä¸€ä¸ªæ¡ç›®å…±20ä¸ªå­—èŠ‚ï¼Œåˆ†åˆ«ä¸º8å­—èŠ‚çš„ <code>commitlog</code> ç‰©ç†åç§»é‡ã€4å­—èŠ‚çš„æ¶ˆæ¯é•¿åº¦ã€8å­—èŠ‚tag <code>hashcode</code>ï¼Œå•ä¸ªæ–‡ä»¶ç”±30Wä¸ªæ¡ç›®ç»„æˆï¼Œå¯ä»¥åƒæ•°ç»„ä¸€æ ·éšæœºè®¿é—®æ¯ä¸€ä¸ªæ¡ç›®ï¼Œæ¯ä¸ª <code>ConsumeQueue</code>æ–‡ä»¶å¤§å°çº¦5.72Mï¼›</li><li><code>IndexFile</code>ï¼š <code>IndexFile</code>ï¼ˆç´¢å¼•æ–‡ä»¶ï¼‰æä¾›äº†ä¸€ç§å¯ä»¥é€šè¿‡keyæˆ–æ—¶é—´åŒºé—´æ¥æŸ¥è¯¢æ¶ˆæ¯çš„æ–¹æ³•ã€‚è¿™é‡Œåªåšç§‘æ™®ä¸åšè¯¦ç»†ä»‹ç»ã€‚</li></ul><p>æ€»ç»“æ¥è¯´ï¼Œæ•´ä¸ªæ¶ˆæ¯å­˜å‚¨çš„ç»“æ„ï¼Œæœ€ä¸»è¦çš„å°±æ˜¯ <code>CommitLoq</code> å’Œ <code>ConsumeQueue</code> ã€‚è€Œ <code>ConsumeQueue</code> ä½ å¯ä»¥å¤§æ¦‚ç†è§£ä¸º <code>Topic</code> ä¸­çš„é˜Ÿåˆ—ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef3884c02acc72.png.jpg"></p><p><code>RocketMQ</code> é‡‡ç”¨çš„æ˜¯ <strong>æ··åˆå‹çš„å­˜å‚¨ç»“æ„</strong> ï¼Œå³ä¸º <code>Broker</code> å•ä¸ªå®ä¾‹ä¸‹æ‰€æœ‰çš„é˜Ÿåˆ—å…±ç”¨ä¸€ä¸ªæ—¥å¿—æ•°æ®æ–‡ä»¶æ¥å­˜å‚¨æ¶ˆæ¯ã€‚æœ‰æ„æ€çš„æ˜¯åœ¨åŒæ ·é«˜å¹¶å‘çš„ <code>Kafka</code> ä¸­ä¼šä¸ºæ¯ä¸ª <code>Topic</code> åˆ†é…ä¸€ä¸ªå­˜å‚¨æ–‡ä»¶ã€‚è¿™å°±æœ‰ç‚¹ç±»ä¼¼äºæˆ‘ä»¬æœ‰ä¸€å¤§å †ä¹¦éœ€è¦è£…ä¸Šä¹¦æ¶ï¼Œ<code>RockeMQ</code> æ˜¯ä¸åˆ†ä¹¦çš„ç§ç±»ç›´æ¥æˆæ‰¹çš„å¡ä¸Šå»çš„ï¼Œè€Œ <code>Kafka</code> æ˜¯å°†ä¹¦æœ¬æ”¾å…¥æŒ‡å®šçš„åˆ†ç±»åŒºåŸŸçš„ã€‚</p><p>è€Œ <code>RocketMQ</code> ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼ŸåŸå› æ˜¯ <strong>æé«˜æ•°æ®çš„å†™å…¥æ•ˆç‡</strong> ï¼Œä¸åˆ† <code>Topic</code> æ„å‘³ç€æˆ‘ä»¬æœ‰æ›´å¤§çš„å‡ ç‡è·å– <strong>æˆæ‰¹</strong> çš„æ¶ˆæ¯è¿›è¡Œæ•°æ®å†™å…¥ï¼Œä½†ä¹Ÿä¼šå¸¦æ¥ä¸€ä¸ªéº»çƒ¦å°±æ˜¯è¯»å–æ¶ˆæ¯çš„æ—¶å€™éœ€è¦éå†æ•´ä¸ªå¤§æ–‡ä»¶ï¼Œè¿™æ˜¯éå¸¸è€—æ—¶çš„ã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨ <code>RocketMQ</code> ä¸­åˆä½¿ç”¨äº† <code>ConsumeQueue</code> ä½œä¸ºæ¯ä¸ªé˜Ÿåˆ—çš„ç´¢å¼•æ–‡ä»¶æ¥ <strong>æå‡è¯»å–æ¶ˆæ¯çš„æ•ˆç‡</strong>ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥æ ¹æ®é˜Ÿåˆ—çš„æ¶ˆæ¯åºå·ï¼Œè®¡ç®—å‡ºç´¢å¼•çš„å…¨å±€ä½ç½®ï¼ˆç´¢å¼•åºå·*ç´¢å¼•å›ºå®šâ»“åº¦20ï¼‰ï¼Œç„¶åç›´æ¥è¯»å–è¿™æ¡ç´¢å¼•ï¼Œå†æ ¹æ®ç´¢å¼•ä¸­è®°å½•çš„æ¶ˆæ¯çš„å…¨å±€ä½ç½®ï¼Œæ‰¾åˆ°æ¶ˆæ¯ã€‚</p><p>è®²åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½å¯¹ <code>RockeMQ</code> çš„å­˜å‚¨æ¶æ„è¿˜æœ‰äº›æ¨¡ç³Šï¼Œæ²¡äº‹ï¼Œæˆ‘ä»¬ç»“åˆç€å›¾æ¥ç†è§£ä¸€ä¸‹ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/16ef388763c25c62.jpg.jpg"></p><p>emmmï¼Œæ˜¯ä¸æ˜¯æœ‰ä¸€ç‚¹å¤æ‚ğŸ¤£ï¼Œçœ‹è‹±æ–‡å›¾ç‰‡å’Œè‹±æ–‡æ–‡æ¡£çš„æ—¶å€™å°±ä¸è¦æ€‚ï¼Œç¡¬ç€å¤´çš®å¾€ä¸‹çœ‹å°±è¡Œã€‚</p><blockquote><p>å¦‚æœä¸Šé¢æ²¡çœ‹æ‡‚çš„è¯»è€…ä¸€å®šè¦è®¤çœŸçœ‹ä¸‹é¢çš„æµç¨‹åˆ†æï¼</p></blockquote><p>é¦–å…ˆï¼Œåœ¨æœ€ä¸Šé¢çš„é‚£ä¸€å—å°±æ˜¯æˆ‘åˆšåˆšè®²çš„ä½ ç°åœ¨å¯ä»¥ç›´æ¥ **æŠŠ <code>ConsumerQueue</code> ç†è§£ä¸º <code>Queue</code>**ã€‚</p><p>åœ¨å›¾ä¸­æœ€å·¦è¾¹è¯´æ˜äº† <font color = red>çº¢è‰²æ–¹å— </font> ä»£è¡¨è¢«å†™å…¥çš„æ¶ˆæ¯ï¼Œè™šçº¿æ–¹å—ä»£è¡¨ç­‰å¾…è¢«å†™å…¥çš„ã€‚å·¦è¾¹çš„ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ä¼šæŒ‡å®š <code>Topic</code> ã€<code>QueueId</code> å’Œå…·ä½“æ¶ˆæ¯å†…å®¹ï¼Œè€Œåœ¨ <code>Broker</code> ä¸­ç®¡ä½ æ˜¯å“ªé—¨å­æ¶ˆæ¯ï¼Œä»–ç›´æ¥ **å…¨éƒ¨é¡ºåºå­˜å‚¨åˆ°äº† CommitLog **ã€‚è€Œæ ¹æ®ç”Ÿäº§è€…æŒ‡å®šçš„ <code>Topic</code> å’Œ <code>QueueId</code> å°†è¿™æ¡æ¶ˆæ¯æœ¬èº«åœ¨ <code>CommitLog</code> çš„åç§»(offset)ï¼Œæ¶ˆæ¯æœ¬èº«å¤§å°ï¼Œå’Œtagçš„hashå€¼å­˜å…¥å¯¹åº”çš„ <code>ConsumeQueue</code> ç´¢å¼•æ–‡ä»¶ä¸­ã€‚è€Œåœ¨æ¯ä¸ªé˜Ÿåˆ—ä¸­éƒ½ä¿å­˜äº† <code>ConsumeOffset</code> å³æ¯ä¸ªæ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹ä½ç½®(æˆ‘åœ¨æ¶æ„é‚£é‡Œæåˆ°äº†ï¼Œå¿˜äº†çš„åŒå­¦å¯ä»¥å›å»çœ‹ä¸€ä¸‹)ï¼Œè€Œæ¶ˆè´¹è€…æ‹‰å–æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹çš„æ—¶å€™åªéœ€è¦æ ¹æ® <code>ConsumeOffset</code> è·å–ä¸‹ä¸€ä¸ªæœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯å°±è¡Œäº†ã€‚</p><p>ä¸Šè¿°å°±æ˜¯æˆ‘å¯¹äºæ•´ä¸ªæ¶ˆæ¯å­˜å‚¨æ¶æ„çš„å¤§æ¦‚ç†è§£(è¿™é‡Œä¸æ¶‰åŠåˆ°ä¸€äº›ç»†èŠ‚è®¨è®ºï¼Œæ¯”å¦‚ç¨€ç–ç´¢å¼•ç­‰ç­‰é—®é¢˜)ï¼Œå¸Œæœ›å¯¹ä½ æœ‰å¸®åŠ©ã€‚</p><p>å› ä¸ºæœ‰ä¸€ä¸ªçŸ¥è¯†ç‚¹å› ä¸ºå†™å—¨äº†å¿˜è®²äº†ï¼Œæƒ³æƒ³åœ¨å“ªé‡ŒåŠ ä¹Ÿä¸å¥½ï¼Œæ‰€ä»¥æˆ‘ç•™ç»™å¤§å®¶å»æ€è€ƒğŸ¤”ğŸ¤”ä¸€ä¸‹å§ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/e314ee45gy1g05zgr67bbj20gp0b3aba.jpg.jpg"></p><p>ä¸ºä»€ä¹ˆ <code>CommitLog</code> æ–‡ä»¶è¦è®¾è®¡æˆå›ºå®šå¤§å°çš„é•¿åº¦å‘¢ï¼Ÿæé†’ï¼š<strong>å†…å­˜æ˜ å°„æœºåˆ¶</strong>ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ€»ç®—æŠŠè¿™ç¯‡åšå®¢å†™å®Œäº†ã€‚æˆ‘è®²çš„ä½ ä»¬è¿˜è®°å¾—å—ğŸ˜…ï¼Ÿ</p><p>è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä¸»è¦æƒ³å¤§å®¶ä»‹ç»äº†</p><ol><li>æ¶ˆæ¯é˜Ÿåˆ—å‡ºç°çš„åŸå› </li><li>æ¶ˆæ¯é˜Ÿåˆ—çš„ä½œç”¨(å¼‚æ­¥ï¼Œè§£è€¦ï¼Œå‰Šå³°)</li><li>æ¶ˆæ¯é˜Ÿåˆ—å¸¦æ¥çš„ä¸€ç³»åˆ—é—®é¢˜(æ¶ˆæ¯å †ç§¯ã€é‡å¤æ¶ˆè´¹ã€é¡ºåºæ¶ˆè´¹ã€åˆ†å¸ƒå¼äº‹åŠ¡ç­‰ç­‰)</li><li>æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸¤ç§æ¶ˆæ¯æ¨¡å‹â€”â€”é˜Ÿåˆ—å’Œä¸»é¢˜æ¨¡å¼</li><li>åˆ†æäº† <code>RocketMQ</code> çš„æŠ€æœ¯æ¶æ„(<code>NameServer</code> ã€<code>Broker</code> ã€<code>Producer</code> ã€<code>Comsumer</code>)</li><li>ç»“åˆ <code>RocketMQ</code> å›ç­”äº†æ¶ˆæ¯é˜Ÿåˆ—å‰¯ä½œç”¨çš„è§£å†³æ–¹æ¡ˆ</li><li>ä»‹ç»äº† <code>RocketMQ</code> çš„å­˜å‚¨æœºåˆ¶å’Œåˆ·ç›˜ç­–ç•¥ã€‚</li></ol><p>ç­‰ç­‰ã€‚ã€‚ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ–‡ç« æ¥æº  &lt;a href=&quot;https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&amp;mid=2247485969&amp;idx=1&amp;sn=6bd53abde30d42a778d5a35ec104428c&amp;chksm=cea245daf9d5cccce631f93115f0c2c4a7634e55f5bef9009fd03f5a0ffa55b745b5ef4f0530&amp;token=294077121&amp;lang=zh_CN#rd&quot;&gt;FrancisQ è€å“¥&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ¶ˆæ¯é˜Ÿåˆ—é¡¾åæ€ä¹‰å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—æˆ‘å°±ä¸è§£é‡Šäº†ï¼Œåˆ«å‘Šè¯‰æˆ‘ä½ è¿é˜Ÿåˆ—éƒ½ä¸çŸ¥é“ä¼¼å•¥å§ï¼Ÿ&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="åˆ†å¸ƒå¼" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="Java" scheme="https://brokge.github.io/tags/Java/"/>
    
      <category term="MQ" scheme="https://brokge.github.io/tags/MQ/"/>
    
  </entry>
  
  <entry>
    <title>å…³äºå¤§å‹ç³»ç»Ÿæ¶æ„çš„10ä¸ªé—®é¢˜</title>
    <link href="https://brokge.github.io/2020/08/21/%E5%85%B3%E4%BA%8E%E5%A4%A7%E5%9E%8B%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E7%9A%8410%E4%B8%AA%E9%97%AE%E9%A2%98/"/>
    <id>https://brokge.github.io/2020/08/21/å…³äºå¤§å‹ç³»ç»Ÿæ¶æ„çš„10ä¸ªé—®é¢˜/</id>
    <published>2020-08-21T06:22:37.000Z</published>
    <updated>2020-08-21T06:32:02.456Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸‹é¢è¿™äº›é—®é¢˜éƒ½æ˜¯ä¸€çº¿å¤§å‚çš„çœŸå®é¢è¯•é—®é¢˜ï¼Œä¸è®ºæ˜¯å¯¹ä½ é¢è¯•è¿˜æ˜¯è¯´æ‹“å®½çŸ¥è¯†é¢éƒ½å¾ˆæœ‰å¸®åŠ©ã€‚</p><a id="more"></a><h3 id="1-ä½ ä½¿ç”¨è¿‡å“ªäº›ç»„ä»¶æˆ–è€…æ–¹æ³•æ¥æå‡ç½‘ç«™æ€§èƒ½-å¯ç”¨æ€§ä»¥åŠå¹¶å‘é‡"><a href="#1-ä½ ä½¿ç”¨è¿‡å“ªäº›ç»„ä»¶æˆ–è€…æ–¹æ³•æ¥æå‡ç½‘ç«™æ€§èƒ½-å¯ç”¨æ€§ä»¥åŠå¹¶å‘é‡" class="headerlink" title="1. ä½ ä½¿ç”¨è¿‡å“ªäº›ç»„ä»¶æˆ–è€…æ–¹æ³•æ¥æå‡ç½‘ç«™æ€§èƒ½,å¯ç”¨æ€§ä»¥åŠå¹¶å‘é‡"></a>1. ä½ ä½¿ç”¨è¿‡å“ªäº›ç»„ä»¶æˆ–è€…æ–¹æ³•æ¥æå‡ç½‘ç«™æ€§èƒ½,å¯ç”¨æ€§ä»¥åŠå¹¶å‘é‡</h3><ol><li><strong>æé«˜ç¡¬ä»¶èƒ½åŠ›ã€å¢åŠ ç³»ç»ŸæœåŠ¡å™¨</strong>ã€‚ï¼ˆå½“æœåŠ¡å™¨å¢åŠ åˆ°æŸä¸ªç¨‹åº¦çš„æ—¶å€™ç³»ç»Ÿæ‰€èƒ½æä¾›çš„å¹¶å‘è®¿é—®é‡å‡ ä¹ä¸å˜ï¼Œæ‰€ä»¥ä¸èƒ½æ ¹æœ¬è§£å†³é—®é¢˜ï¼‰</li><li><strong>ä½¿ç”¨ç¼“å­˜</strong>ï¼ˆæœ¬åœ°ç¼“å­˜ï¼šæœ¬åœ°å¯ä»¥ä½¿ç”¨JDKè‡ªå¸¦çš„ Mapã€Guava Cache.åˆ†å¸ƒå¼ç¼“å­˜ï¼šRedisã€Memcache.æœ¬åœ°ç¼“å­˜ä¸é€‚ç”¨äºæé«˜ç³»ç»Ÿå¹¶å‘é‡ï¼Œä¸€èˆ¬æ˜¯ç”¨å¤„ç”¨åœ¨ç¨‹åºä¸­ã€‚æ¯”å¦‚Springæ˜¯å¦‚ä½•å®ç°å•ä¾‹çš„å‘¢ï¼Ÿå¤§å®¶å¦‚æœçœ‹è¿‡æºç çš„è¯ï¼Œåº”è¯¥çŸ¥é“ï¼ŒSæŠŠå·²ç»åˆå§‹è¿‡çš„å˜é‡æ”¾åœ¨ä¸€ä¸ªMapä¸­ï¼Œä¸‹æ¬¡å†è¦ä½¿ç”¨è¿™ä¸ªå˜é‡çš„æ—¶å€™ï¼Œå…ˆåˆ¤æ–­Mapä¸­æœ‰æ²¡æœ‰ï¼Œè¿™ä¹Ÿå°±æ˜¯ç³»ç»Ÿä¸­å¸¸è§çš„å•ä¾‹æ¨¡å¼çš„å®ç°ã€‚ï¼‰</li><li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong> ï¼ˆè§£è€¦+å‰Šå³°+å¼‚æ­¥ï¼‰</li><li><strong>é‡‡ç”¨åˆ†å¸ƒå¼å¼€å‘</strong> ï¼ˆä¸åŒçš„æœåŠ¡éƒ¨ç½²åœ¨ä¸åŒçš„æœºå™¨èŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¸”ä¸€ä¸ªæœåŠ¡ä¹Ÿå¯ä»¥éƒ¨ç½²åœ¨å¤šå°æœºå™¨ä¸Šï¼Œç„¶ååˆ©ç”¨ Nginx è´Ÿè½½å‡è¡¡è®¿é—®ã€‚è¿™æ ·å°±è§£å†³äº†å•ç‚¹éƒ¨ç½²(All In)çš„ç¼ºç‚¹ï¼Œå¤§å¤§æé«˜çš„ç³»ç»Ÿå¹¶å‘é‡ï¼‰</li><li><strong>æ•°æ®åº“åˆ†åº“ï¼ˆè¯»å†™åˆ†ç¦»ï¼‰ã€åˆ†è¡¨ï¼ˆæ°´å¹³åˆ†è¡¨ã€å‚ç›´åˆ†è¡¨ï¼‰</strong></li><li><strong>é‡‡ç”¨é›†ç¾¤</strong> ï¼ˆå¤šå°æœºå™¨æä¾›ç›¸åŒçš„æœåŠ¡ï¼‰</li><li><strong>CDN åŠ é€Ÿ</strong> (å°†ä¸€äº›é™æ€èµ„æºæ¯”å¦‚å›¾ç‰‡ã€è§†é¢‘ç­‰ç­‰ç¼“å­˜åˆ°ç¦»ç”¨æˆ·æœ€è¿‘çš„ç½‘ç»œèŠ‚ç‚¹)</li><li><strong>æµè§ˆå™¨ç¼“å­˜</strong></li><li><strong>ä½¿ç”¨åˆé€‚çš„è¿æ¥æ± </strong>ï¼ˆæ•°æ®åº“è¿æ¥æ± ã€çº¿ç¨‹æ± ç­‰ç­‰ï¼‰</li><li><strong>é€‚å½“ä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œå¼€å‘ã€‚</strong></li></ol><h3 id="2-è®¾è®¡é«˜å¯ç”¨ç³»ç»Ÿçš„å¸¸ç”¨æ‰‹æ®µ"><a href="#2-è®¾è®¡é«˜å¯ç”¨ç³»ç»Ÿçš„å¸¸ç”¨æ‰‹æ®µ" class="headerlink" title="2. è®¾è®¡é«˜å¯ç”¨ç³»ç»Ÿçš„å¸¸ç”¨æ‰‹æ®µ"></a>2. è®¾è®¡é«˜å¯ç”¨ç³»ç»Ÿçš„å¸¸ç”¨æ‰‹æ®µ</h3><ol><li><strong>é™çº§ï¼š</strong> æœåŠ¡é™çº§æ˜¯å½“æœåŠ¡å™¨å‹åŠ›å‰§å¢çš„æƒ…å†µä¸‹ï¼Œæ ¹æ®å½“å‰ä¸šåŠ¡æƒ…å†µåŠæµé‡å¯¹ä¸€äº›æœåŠ¡å’Œé¡µé¢æœ‰ç­–ç•¥çš„é™çº§ï¼Œä»¥æ­¤é‡Šæ”¾æœåŠ¡å™¨èµ„æºä»¥ä¿è¯æ ¸å¿ƒä»»åŠ¡çš„æ­£å¸¸è¿è¡Œã€‚é™çº§å¾€å¾€ä¼šæŒ‡å®šä¸åŒçš„çº§åˆ«ï¼Œé¢ä¸´ä¸åŒçš„å¼‚å¸¸ç­‰çº§æ‰§è¡Œä¸åŒçš„å¤„ç†ã€‚æ ¹æ®æœåŠ¡æ–¹å¼ï¼šå¯ä»¥æ‹’æ¥æœåŠ¡ï¼Œå¯ä»¥å»¶è¿ŸæœåŠ¡ï¼Œä¹Ÿæœ‰æ—¶å€™å¯ä»¥éšæœºæœåŠ¡ã€‚æ ¹æ®æœåŠ¡èŒƒå›´ï¼šå¯ä»¥ç æ‰æŸä¸ªåŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥ç æ‰æŸäº›æ¨¡å—ã€‚æ€»ä¹‹æœåŠ¡é™çº§éœ€è¦æ ¹æ®ä¸åŒçš„ä¸šåŠ¡éœ€æ±‚é‡‡ç”¨ä¸åŒçš„é™çº§ç­–ç•¥ã€‚ä¸»è¦çš„ç›®çš„å°±æ˜¯æœåŠ¡è™½ç„¶æœ‰æŸä½†æ˜¯æ€»æ¯”æ²¡æœ‰å¥½ï¼›</li><li><strong>é™æµï¼š</strong> é˜²æ­¢æ¶æ„è¯·æ±‚æµé‡ã€æ¶æ„æ”»å‡»ï¼Œæˆ–è€…é˜²æ­¢æµé‡è¶…å‡ºç³»ç»Ÿå³°å€¼ï¼›</li><li><strong>ç¼“å­˜ï¼š</strong> é¿å…å¤§é‡è¯·æ±‚ç›´æ¥è½åˆ°æ•°æ®åº“ï¼Œå°†æ•°æ®åº“å‡»å®ï¼›</li><li><strong>è¶…æ—¶å’Œé‡è¯•æœºåˆ¶ï¼š</strong> é¿å…è¯·æ±‚å †ç§¯é€ æˆé›ªå´©ï¼›</li><li><strong>å›æ»šæœºåˆ¶ï¼š</strong> å¿«é€Ÿä¿®å¤é”™è¯¯ç‰ˆæœ¬ã€‚</li></ol><h3 id="3-ç°ä»£äº’è”ç½‘åº”ç”¨ç³»ç»Ÿé€šå¸¸å…·æœ‰å“ªäº›ç‰¹ç‚¹"><a href="#3-ç°ä»£äº’è”ç½‘åº”ç”¨ç³»ç»Ÿé€šå¸¸å…·æœ‰å“ªäº›ç‰¹ç‚¹" class="headerlink" title="3. ç°ä»£äº’è”ç½‘åº”ç”¨ç³»ç»Ÿé€šå¸¸å…·æœ‰å“ªäº›ç‰¹ç‚¹?"></a>3. ç°ä»£äº’è”ç½‘åº”ç”¨ç³»ç»Ÿé€šå¸¸å…·æœ‰å“ªäº›ç‰¹ç‚¹?</h3><ol><li>é«˜å¹¶å‘ï¼Œå¤§æµé‡ï¼›</li><li>é«˜å¯ç”¨ï¼šç³»ç»Ÿ7Ã—24å°æ—¶ä¸é—´æ–­æœåŠ¡ï¼›</li><li>æµ·é‡æ•°æ®ï¼šéœ€è¦å­˜å‚¨ã€ç®¡ç†æµ·é‡æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨å¤§é‡æœåŠ¡å™¨ï¼›</li><li>ç”¨æˆ·åˆ†å¸ƒå¹¿æ³›ï¼Œç½‘ç»œæƒ…å†µå¤æ‚ï¼šè®¸å¤šå¤§å‹äº’è”ç½‘éƒ½æ˜¯ä¸ºå…¨çƒç”¨æˆ·æä¾›æœåŠ¡çš„ï¼Œç”¨æˆ·åˆ†å¸ƒèŒƒå›´å¹¿ï¼Œå„åœ°ç½‘ç»œæƒ…å†µåƒå·®ä¸‡åˆ«ï¼›</li><li>å®‰å…¨ç¯å¢ƒæ¶åŠ£ï¼šç”±äºäº’è”ç½‘çš„å¼€æ”¾æ€§ï¼Œä½¿å¾—äº’è”ç½‘æ›´å®¹æ˜“å—åˆ°æ”»å‡»ï¼Œå¤§å‹ç½‘ç«™å‡ ä¹æ¯å¤©éƒ½ä¼šè¢«é»‘å®¢æ”»å‡»ï¼›</li><li>éœ€æ±‚å¿«é€Ÿå˜æ›´ï¼Œå‘å¸ƒé¢‘ç¹ï¼šå’Œä¼ ç»Ÿè½¯ä»¶çš„ç‰ˆæœ¬å‘å¸ƒé¢‘ç‡ä¸åŒï¼Œäº’è”ç½‘äº§å“ä¸ºå¿«é€Ÿé€‚åº”å¸‚åœºï¼Œæ»¡è¶³ç”¨æˆ·éœ€æ±‚ï¼Œå…¶äº§å“å‘å¸ƒé¢‘ç‡æ˜¯æé«˜çš„ï¼›</li><li>æ¸è¿›å¼å‘å±•ï¼šä¸ä¼ ç»Ÿè½¯ä»¶äº§å“æˆ–ä¼ä¸šåº”ç”¨ç³»ç»Ÿä¸€å¼€å§‹å°±è§„åˆ’å¥½å…¨éƒ¨çš„åŠŸèƒ½å’ŒéåŠŸèƒ½éœ€æ±‚ä¸åŒï¼Œå‡ ä¹æ‰€æœ‰çš„å¤§å‹äº’è”ç½‘ç½‘ç«™éƒ½æ˜¯ä»ä¸€ä¸ªå°ç½‘ç«™å¼€å§‹ï¼Œæ¸è¿›åœ°å‘å±•èµ·æ¥ã€‚</li></ol><h3 id="4-è°ˆè°ˆä½ å¯¹å¾®æœåŠ¡é¢†åŸŸçš„äº†è§£å’Œè®¤è¯†"><a href="#4-è°ˆè°ˆä½ å¯¹å¾®æœåŠ¡é¢†åŸŸçš„äº†è§£å’Œè®¤è¯†" class="headerlink" title="4. è°ˆè°ˆä½ å¯¹å¾®æœåŠ¡é¢†åŸŸçš„äº†è§£å’Œè®¤è¯†"></a>4. è°ˆè°ˆä½ å¯¹å¾®æœåŠ¡é¢†åŸŸçš„äº†è§£å’Œè®¤è¯†</h3><p>ç°åœ¨å¤§å…¬å¸éƒ½åœ¨ç”¨å¹¶ä¸”æœªæ¥çš„è¶‹åŠ¿éƒ½æ˜¯ Spring Cloudï¼Œè€Œé˜¿é‡Œå¼€æºçš„ Spring Cloud Alibaba ä¹Ÿæ˜¯ Spring Cloud è§„èŒƒçš„å®ç° ã€‚</p><p>æˆ‘ä»¬é€šå¸¸æŠŠ Spring Cloud ç†è§£ä¸ºä¸€ç³»åˆ—å¼€æºç»„ä»¶çš„é›†åˆï¼Œä½†æ˜¯ Spring Cloudå¹¶ä¸æ˜¯ç­‰åŒäº Spring Cloud Netflix çš„ Ribbonã€Feignã€Eurekaï¼ˆåœæ­¢æ›´æ–°ï¼‰ã€Hystrix è¿™ä¸€å¥—ç»„ä»¶ï¼Œè€Œæ˜¯æŠ½è±¡äº†ä¸€å¥—é€šç”¨çš„å¼€å‘æ¨¡å¼ã€‚å®ƒçš„ç›®çš„æ˜¯é€šè¿‡æŠ½è±¡å‡ºè¿™å¥—é€šç”¨çš„æ¨¡å¼ï¼Œè®©å¼€å‘è€…æ›´å¿«æ›´å¥½åœ°å¼€å‘ä¸šåŠ¡ã€‚ä½†æ˜¯è¿™å¥—å¼€å‘æ¨¡å¼è¿è¡Œæ—¶çš„å®é™…è½½ä½“ï¼Œè¿˜æ˜¯ä¾èµ–äº RPCã€ç½‘å…³ã€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†ã€é™æµç†”æ–­ã€åˆ†å¸ƒå¼é“¾è·¯è·Ÿè¸ªç­‰ç»„ä»¶çš„å…·ä½“å®ç°ã€‚</p><p>Spring Cloud Alibaba æ˜¯å®˜æ–¹è®¤è¯çš„æ–°ä¸€å¥— Spring Cloud è§„èŒƒçš„å®ç°,Spring Cloud Alibaba æ˜¯ä¸€å¥—å›½äº§å¼€æºäº§å“é›†åˆï¼Œåç»­è¿˜ä¼šæœ‰ä¸­æ–‡ reference å’Œä¸€äº›åŸç†åˆ†ææ–‡ç« ï¼Œæ‰€ä»¥ï¼Œè¿™å¯¹äºå›½å†…çš„å¼€å‘è€…æ˜¯éå¸¸æ£’çš„ä¸€ä»¶äº‹ã€‚é˜¿é‡Œçš„è¿™ä¸€ä¸¾åŠ¨åŠ¿å¿…ä¼šæ¨åŠ¨å›½å†…å¾®æœåŠ¡æŠ€æœ¯çš„å‘å±•ï¼Œå› ä¸ºåœ¨æ²¡æœ‰ Spring Cloud Alibaba ä¹‹å‰ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€é€‰æ‹©æ˜¯ Spring Cloud Netflixï¼Œä½†æ˜¯å®ƒä»¬çš„æ–‡æ¡£éƒ½æ˜¯è‹±æ–‡çš„ï¼Œå‡ºé—®é¢˜åæ’æŸ¥ä¹Ÿæ¯”è¾ƒå›°éš¾ï¼Œ åœ¨å›½å†…å¹¶ä¸æ˜¯æœ‰ç‰¹åˆ«å¤šçš„äººç²¾é€šã€‚Spring Cloud Alibaba ç”±é˜¿é‡Œå¼€æºç»„ä»¶å’Œé˜¿é‡Œäº‘äº§å“ç»„ä»¶ä¸¤éƒ¨åˆ†ç»„æˆï¼Œå…¶è‡´åŠ›äºæä¾›å¾®æœåŠ¡ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆï¼Œæ–¹ä¾¿å¼€å‘è€…é€šè¿‡ Spring Cloud ç¼–ç¨‹æ¨¡å‹è½»æ¾å¼€å‘å¾®æœåŠ¡åº”ç”¨ã€‚</p><p>å¦å¤–ï¼ŒApache Dubbo Ecosystem æ˜¯å›´ç»• Apache Dubbo æ‰“é€ çš„å¾®æœåŠ¡ç”Ÿæ€ï¼Œæ˜¯ç»è¿‡ç”Ÿäº§éªŒè¯çš„å¾®æœåŠ¡çš„æœ€ä½³å®è·µç»„åˆã€‚åœ¨é˜¿é‡Œå·´å·´çš„å¾®æœåŠ¡è§£å†³æ–¹æ¡ˆä¸­ï¼ŒDubboã€Nacos å’Œ Sentinelï¼Œä»¥åŠåç»­å°†å¼€æºçš„å¾®æœåŠ¡ç»„ä»¶ï¼Œéƒ½æ˜¯ Dubbo EcoSystem çš„ä¸€éƒ¨åˆ†ã€‚é˜¿é‡Œåç»­ä¹Ÿä¼šå°† Dubbo EcoSystem é›†æˆåˆ° Spring Cloud çš„ç”Ÿæ€ä¸­ã€‚</p><h3 id="5-è°ˆè°ˆä½ å¯¹-Dubbo-å’Œ-Spring-Cloud-çš„è®¤è¯†-ä¸¤è€…å…³ç³»"><a href="#5-è°ˆè°ˆä½ å¯¹-Dubbo-å’Œ-Spring-Cloud-çš„è®¤è¯†-ä¸¤è€…å…³ç³»" class="headerlink" title="5. è°ˆè°ˆä½ å¯¹ Dubbo å’Œ Spring Cloud çš„è®¤è¯†(ä¸¤è€…å…³ç³»)"></a>5. è°ˆè°ˆä½ å¯¹ Dubbo å’Œ Spring Cloud çš„è®¤è¯†(ä¸¤è€…å…³ç³»)</h3><p>å…·ä½“å¯ä»¥çœ‹å…¬ä¼—å·-é˜¿é‡Œå·´å·´ä¸­é—´ä»¶çš„è¿™ç¯‡æ–‡ç« :<a href="https://mp.weixin.qq.com/s/iNVctXw7tUGHhnF0hV84ww">ç‹¬å®¶è§£è¯»ï¼šDubbo Ecosystem - ä»å¾®æœåŠ¡æ¡†æ¶åˆ°å¾®æœåŠ¡ç”Ÿæ€</a></p><p>Dubbo ä¸ Spring Cloud å¹¶ä¸æ˜¯ç«äº‰å…³ç³»ï¼ŒDubbo ä½œä¸ºæˆç†Ÿçš„ RPC æ¡†æ¶ï¼Œå…¶æ˜“ç”¨æ€§ã€æ‰©å±•æ€§å’Œå¥å£®æ€§å·²å¾—åˆ°ä¸šç•Œçš„è®¤å¯ã€‚æœªæ¥ Dubbo å°†ä¼šä½œä¸º Spring Cloud Alibaba çš„ RPC ç»„ä»¶ï¼Œå¹¶ä¸ Spring Cloud åŸç”Ÿçš„ Feign ä»¥åŠ RestTemplate è¿›è¡Œæ— ç¼æ•´åˆï¼Œå®ç°â€œé›¶â€æˆæœ¬è¿ç§»ã€‚</p><p>åœ¨é˜¿é‡Œå·´å·´çš„å¾®æœåŠ¡è§£å†³æ–¹æ¡ˆä¸­ï¼ŒDubboã€Nacos å’Œ Sentinelï¼Œä»¥åŠåç»­å°†å¼€æºçš„å¾®æœåŠ¡ç»„ä»¶ï¼Œéƒ½æ˜¯ Dubbo EcoSystem çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘ä»¬åç»­ä¹Ÿä¼šå°† Dubbo EcoSystem é›†æˆåˆ° Spring Cloud çš„ç”Ÿæ€ä¸­ã€‚</p><h3 id="6-æ€§èƒ½æµ‹è¯•äº†è§£å—-è¯´è¯´ä½ çŸ¥é“çš„æ€§èƒ½æµ‹è¯•å·¥å…·"><a href="#6-æ€§èƒ½æµ‹è¯•äº†è§£å—-è¯´è¯´ä½ çŸ¥é“çš„æ€§èƒ½æµ‹è¯•å·¥å…·" class="headerlink" title="6. æ€§èƒ½æµ‹è¯•äº†è§£å—?è¯´è¯´ä½ çŸ¥é“çš„æ€§èƒ½æµ‹è¯•å·¥å…·?"></a>6. æ€§èƒ½æµ‹è¯•äº†è§£å—?è¯´è¯´ä½ çŸ¥é“çš„æ€§èƒ½æµ‹è¯•å·¥å…·?</h3><p>æ€§èƒ½æµ‹è¯•æŒ‡é€šè¿‡è‡ªåŠ¨åŒ–çš„æµ‹è¯•å·¥å…·æ¨¡æ‹Ÿå¤šç§æ­£å¸¸ã€å³°å€¼ä»¥åŠå¼‚å¸¸è´Ÿè½½æ¡ä»¶æ¥å¯¹ç³»ç»Ÿçš„å„é¡¹æ€§èƒ½æŒ‡æ ‡è¿›è¡Œæµ‹è¯•ã€‚æ€§èƒ½æµ‹è¯•æ˜¯æ€»ç§°ï¼Œé€šå¸¸ç»†åˆ†ä¸ºï¼š</p><ol><li><strong>åŸºå‡†æµ‹è¯•ï¼š</strong> åœ¨ç»™ç³»ç»Ÿæ–½åŠ è¾ƒä½å‹åŠ›æ—¶ï¼ŒæŸ¥çœ‹ç³»ç»Ÿçš„è¿è¡ŒçŠ¶å†µå¹¶è®°å½•ç›¸å…³æ•°åšä¸ºåŸºç¡€å‚è€ƒ</li><li><strong>è´Ÿè½½æµ‹è¯•ï¼š</strong> æ˜¯æŒ‡å¯¹ç³»ç»Ÿä¸æ–­åœ°å¢åŠ å‹åŠ›æˆ–å¢åŠ ä¸€å®šå‹åŠ›ä¸‹çš„æŒç»­æ—¶é—´ï¼Œç›´åˆ°ç³»ç»Ÿçš„æŸé¡¹æˆ–å¤šé¡¹æ€§èƒ½æŒ‡æ ‡è¾¾åˆ°å®‰å…¨ä¸´ç•Œå€¼ï¼Œä¾‹å¦‚æŸç§èµ„æºå·²ç»è¾¾åˆ°é¥±å’ŒçŠ¶æ€ç­‰ ã€‚æ­¤æ—¶ç»§ç»­åŠ å‹ï¼Œç³»ç»Ÿå¤„ç†èƒ½åŠ›ä¼šä¸‹é™ã€‚</li><li><strong>å‹åŠ›æµ‹è¯•ï¼š</strong> è¶…è¿‡å®‰å…¨è´Ÿè½½æƒ…å†µä¸‹ï¼Œä¸æ–­æ–½åŠ å‹åŠ›ï¼ˆå¢åŠ å¹¶å‘è¯·æ±‚ï¼‰ï¼Œç›´åˆ°ç³»ç»Ÿå´©æºƒæˆ–æ— æ³•å¤„ç†ä»»ä½•è¯·æ±‚ï¼Œä¾æ­¤è·å¾—ç³»ç»Ÿæœ€å¤§å‹åŠ›æ‰¿å—èƒ½åŠ›ã€‚</li><li><strong>ç¨³å®šæ€§æµ‹è¯•ï¼š</strong> è¢«æµ‹è¯•ç³»ç»Ÿåœ¨ç‰¹å®šç¡¬ä»¶ã€è½¯ä»¶ã€ç½‘ç»œç¯å¢ƒä¸‹ï¼ŒåŠ è½½ä¸€å®šä¸šåŠ¡å‹åŠ›ï¼ˆæ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒä¸åŒæ—¶é—´ç‚¹ã€ä¸å‡åŒ€è¯·æ±‚ï¼Œå‘ˆæ³¢æµªç‰¹æ€§ï¼‰è¿è¡Œä¸€æ®µè¾ƒé•¿æ—¶é—´ï¼Œä»¥æ­¤æ£€æµ‹ç³»ç»Ÿæ˜¯å¦ç¨³å®šã€‚</li></ol><p>åç«¯ç¨‹åºå‘˜æˆ–è€…æµ‹è¯•å¹³å¸¸æ¯”è¾ƒå¸¸ç”¨çš„æµ‹è¯•å·¥å…·æ˜¯ JMeterï¼ˆå®˜ç½‘ï¼š<a href="https://jmeter.apache.org/">https://jmeter.apache.org/</a>ï¼‰ã€‚Apache JMeter æ˜¯ä¸€æ¬¾åŸºäºJavaçš„å‹åŠ›æµ‹è¯•å·¥å…·(100ï¼…çº¯Javaåº”ç”¨ç¨‹åº)ï¼Œæ—¨åœ¨åŠ è½½æµ‹è¯•åŠŸèƒ½è¡Œä¸ºå’Œæµ‹é‡æ€§èƒ½ã€‚å®ƒæœ€åˆè¢«è®¾è®¡ç”¨äº Web åº”ç”¨æµ‹è¯•ä½†åæ¥æ‰©å±•åˆ°å…¶ä»–æµ‹è¯•é¢†åŸŸã€‚</p><h3 id="7-å¯¹äºä¸€ä¸ªå•ä½“åº”ç”¨ç³»ç»Ÿ-éšç€äº§å“ä½¿ç”¨çš„ç”¨æˆ·è¶Šæ¥è¶Šå¤š-ç½‘ç«™çš„æµé‡ä¼šå¢åŠ -æœ€ç»ˆå•å°æœåŠ¡å™¨æ— æ³•å¤„ç†é‚£ä¹ˆå¤§çš„æµé‡æ€ä¹ˆåŠ"><a href="#7-å¯¹äºä¸€ä¸ªå•ä½“åº”ç”¨ç³»ç»Ÿ-éšç€äº§å“ä½¿ç”¨çš„ç”¨æˆ·è¶Šæ¥è¶Šå¤š-ç½‘ç«™çš„æµé‡ä¼šå¢åŠ -æœ€ç»ˆå•å°æœåŠ¡å™¨æ— æ³•å¤„ç†é‚£ä¹ˆå¤§çš„æµé‡æ€ä¹ˆåŠ" class="headerlink" title="7. å¯¹äºä¸€ä¸ªå•ä½“åº”ç”¨ç³»ç»Ÿ,éšç€äº§å“ä½¿ç”¨çš„ç”¨æˆ·è¶Šæ¥è¶Šå¤š,ç½‘ç«™çš„æµé‡ä¼šå¢åŠ ,æœ€ç»ˆå•å°æœåŠ¡å™¨æ— æ³•å¤„ç†é‚£ä¹ˆå¤§çš„æµé‡æ€ä¹ˆåŠ?"></a>7. å¯¹äºä¸€ä¸ªå•ä½“åº”ç”¨ç³»ç»Ÿ,éšç€äº§å“ä½¿ç”¨çš„ç”¨æˆ·è¶Šæ¥è¶Šå¤š,ç½‘ç«™çš„æµé‡ä¼šå¢åŠ ,æœ€ç»ˆå•å°æœåŠ¡å™¨æ— æ³•å¤„ç†é‚£ä¹ˆå¤§çš„æµé‡æ€ä¹ˆåŠ?</h3><p>è¿™ä¸ªæ—¶å€™å°±è¦è€ƒè™‘æ‰©å®¹äº†ã€‚ã€Šäº¿çº§æµé‡ç½‘ç«™æ¶æ„æ ¸å¿ƒæŠ€æœ¯ã€‹è¿™æœ¬ä¹¦ä¸Šé¢ä»‹ç»åˆ°æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¸‹é¢å‡ æ­¥æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p><ul><li>ç¬¬ä¸€æ­¥ï¼Œå¯ä»¥è€ƒè™‘ç®€å•çš„æ‰©å®¹æ¥è§£å†³é—®é¢˜ã€‚æ¯”å¦‚å¢åŠ ç³»ç»Ÿçš„æœåŠ¡å™¨ï¼Œæé«˜ç¡¬ä»¶èƒ½åŠ›ç­‰ç­‰ã€‚</li><li>ç¬¬äºŒæ­¥ï¼Œå¦‚æœç®€å•æ‰©å®¹æä¸å®šï¼Œå°±éœ€è¦æ°´å¹³æ‹†åˆ†å’Œå‚ç›´æ‹†åˆ†æ•°æ®ï¼åº”ç”¨æ¥æå‡ç³»ç»Ÿçš„ä¼¸ç¼©æ€§ï¼Œå³é€šè¿‡æ‰©å®¹æå‡ç³»ç»Ÿè´Ÿè½½èƒ½åŠ›ã€‚</li><li>ç¬¬ä¸‰æ­¥ï¼Œå¦‚æœé€šè¿‡æ°´å¹³æ‹†åˆ†ï¼å‚ç›´æ‹†åˆ†è¿˜æ˜¯æä¸å®šï¼Œé‚£å°±éœ€è¦æ ¹æ®ç°æœ‰ç³»ç»Ÿç‰¹æ€§ï¼Œæ¶æ„å±‚é¢è¿›è¡Œé‡æ„ç”šè‡³æ˜¯é‡æ–°è®¾è®¡ï¼Œå³æ¨å€’é‡æ¥ã€‚</li></ul><p>å¯¹äºç³»ç»Ÿè®¾è®¡ï¼Œç†æƒ³çš„æƒ…å†µä¸‹åº”æ”¯æŒçº¿æ€§æ‰©å®¹å’Œå¼¹æ€§æ‰©å®¹ï¼Œå³åœ¨ç³»ç»Ÿç“¶é¢ˆæ—¶ï¼Œåªéœ€è¦å¢åŠ æœºå™¨å°±å¯ä»¥è§£å†³ç³»ç»Ÿç“¶é¢ˆï¼Œå¦‚é™ä½å»¶è¿Ÿæå‡ååé‡ï¼Œä»è€Œå®ç°æ‰©å®¹éœ€æ±‚ã€‚</p><p>å¦‚æœä½ æƒ³æ‰©å®¹ï¼Œåˆ™æ”¯æŒæ°´å¹³/å‚ç›´ä¼¸ç¼©æ˜¯å‰æã€‚åœ¨è¿›è¡Œæ‹†åˆ†æ—¶ï¼Œä¸€å®šè¦æ¸…æ¥šçŸ¥é“è‡ªå·±çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Œæ‹†åˆ†åå¸¦æ¥çš„é—®é¢˜å¦‚ä½•è§£å†³ï¼Œæ‹†åˆ†åå¦‚æœæ²¡æœ‰å¾—åˆ°ä»»ä½•æ”¶ç›Šå°±ä¸è¦ä¸ºäº†<br>æ‹†è€Œæ‹†ï¼Œå³ä¸è¦è¿‡åº¦æ‹†åˆ†ï¼Œè¦é€‚åˆè‡ªå·±çš„ä¸šåŠ¡ã€‚</p><h3 id="8-å¤§è¡¨ä¼˜åŒ–çš„å¸¸è§æ‰‹æ®µ"><a href="#8-å¤§è¡¨ä¼˜åŒ–çš„å¸¸è§æ‰‹æ®µ" class="headerlink" title="8. å¤§è¡¨ä¼˜åŒ–çš„å¸¸è§æ‰‹æ®µ"></a>8. å¤§è¡¨ä¼˜åŒ–çš„å¸¸è§æ‰‹æ®µ</h3><p>   å½“MySQLå•è¡¨è®°å½•æ•°è¿‡å¤§æ—¶ï¼Œæ•°æ®åº“çš„CRUDæ€§èƒ½ä¼šæ˜æ˜¾ä¸‹é™ï¼Œä¸€äº›å¸¸è§çš„ä¼˜åŒ–æªæ–½å¦‚ä¸‹ï¼š</p><ol><li><strong>é™å®šæ•°æ®çš„èŒƒå›´ï¼š</strong> åŠ¡å¿…ç¦æ­¢ä¸å¸¦ä»»ä½•é™åˆ¶æ•°æ®èŒƒå›´æ¡ä»¶çš„æŸ¥è¯¢è¯­å¥ã€‚æ¯”å¦‚ï¼šæˆ‘ä»¬å½“ç”¨æˆ·åœ¨æŸ¥è¯¢è®¢å•å†å²çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶åœ¨ä¸€ä¸ªæœˆçš„èŒƒå›´å†…ï¼›</li><li><strong>è¯»/å†™åˆ†ç¦»ï¼š</strong> ç»å…¸çš„æ•°æ®åº“æ‹†åˆ†æ–¹æ¡ˆï¼Œä¸»åº“è´Ÿè´£å†™ï¼Œä»åº“è´Ÿè´£è¯»ï¼›</li><li><strong>å‚ç›´åˆ†åŒºï¼š</strong> <strong>æ ¹æ®æ•°æ®åº“é‡Œé¢æ•°æ®è¡¨çš„ç›¸å…³æ€§è¿›è¡Œæ‹†åˆ†ã€‚</strong> ä¾‹å¦‚ï¼Œç”¨æˆ·è¡¨ä¸­æ—¢æœ‰ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯åˆæœ‰ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¯ä»¥å°†ç”¨æˆ·è¡¨æ‹†åˆ†æˆä¸¤ä¸ªå•ç‹¬çš„è¡¨ï¼Œç”šè‡³æ”¾åˆ°å•ç‹¬çš„åº“åšåˆ†åº“ã€‚<strong>ç®€å•æ¥è¯´å‚ç›´æ‹†åˆ†æ˜¯æŒ‡æ•°æ®è¡¨åˆ—çš„æ‹†åˆ†ï¼ŒæŠŠä¸€å¼ åˆ—æ¯”è¾ƒå¤šçš„è¡¨æ‹†åˆ†ä¸ºå¤šå¼ è¡¨ã€‚</strong> å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™æ ·æ¥è¯´å¤§å®¶åº”è¯¥å°±æ›´å®¹æ˜“ç†è§£äº†ã€‚<img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/164084354ba2e0fd?w=950&h=279&f=jpeg&s=26015.jpg"><strong>å‚ç›´æ‹†åˆ†çš„ä¼˜ç‚¹ï¼š</strong> å¯ä»¥ä½¿å¾—è¡Œæ•°æ®å˜å°ï¼Œåœ¨æŸ¥è¯¢æ—¶å‡å°‘è¯»å–çš„Blockæ•°ï¼Œå‡å°‘I/Oæ¬¡æ•°ã€‚æ­¤å¤–ï¼Œå‚ç›´åˆ†åŒºå¯ä»¥ç®€åŒ–è¡¨çš„ç»“æ„ï¼Œæ˜“äºç»´æŠ¤ã€‚<strong>å‚ç›´æ‹†åˆ†çš„ç¼ºç‚¹ï¼š</strong> ä¸»é”®ä¼šå‡ºç°å†—ä½™ï¼Œéœ€è¦ç®¡ç†å†—ä½™åˆ—ï¼Œå¹¶ä¼šå¼•èµ·Joinæ“ä½œï¼Œå¯ä»¥é€šè¿‡åœ¨åº”ç”¨å±‚è¿›è¡ŒJoinæ¥è§£å†³ã€‚æ­¤å¤–ï¼Œå‚ç›´åˆ†åŒºä¼šè®©äº‹åŠ¡å˜å¾—æ›´åŠ å¤æ‚ï¼›</li><li><strong>æ°´å¹³åˆ†åŒºï¼š</strong> <strong>ä¿æŒæ•°æ®è¡¨ç»“æ„ä¸å˜ï¼Œé€šè¿‡æŸç§ç­–ç•¥å­˜å‚¨æ•°æ®åˆ†ç‰‡ã€‚è¿™æ ·æ¯ä¸€ç‰‡æ•°æ®åˆ†æ•£åˆ°ä¸åŒçš„è¡¨æˆ–è€…åº“ä¸­ï¼Œè¾¾åˆ°äº†åˆ†å¸ƒå¼çš„ç›®çš„ã€‚ æ°´å¹³æ‹†åˆ†å¯ä»¥æ”¯æ’‘éå¸¸å¤§çš„æ•°æ®é‡ã€‚</strong> æ°´å¹³æ‹†åˆ†æ˜¯æŒ‡æ•°æ®è¡¨è¡Œçš„æ‹†åˆ†ï¼Œè¡¨çš„è¡Œæ•°è¶…è¿‡200ä¸‡è¡Œæ—¶ï¼Œå°±ä¼šå˜æ…¢ï¼Œè¿™æ—¶å¯ä»¥æŠŠä¸€å¼ çš„è¡¨çš„æ•°æ®æ‹†æˆå¤šå¼ è¡¨æ¥å­˜æ”¾ã€‚ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬å¯ä»¥å°†ç”¨æˆ·ä¿¡æ¯è¡¨æ‹†åˆ†æˆå¤šä¸ªç”¨æˆ·ä¿¡æ¯è¡¨ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…å•ä¸€è¡¨æ•°æ®é‡è¿‡å¤§å¯¹æ€§èƒ½é€ æˆå½±å“ã€‚<img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/164084b7e9e423e3?w=690&h=271&f=jpeg&s=23119.jpg" alt="æ•°æ®åº“æ°´å¹³æ‹†åˆ†">æ°´å¹³æ‹†åˆ†å¯ä»¥æ”¯æŒéå¸¸å¤§çš„æ•°æ®é‡ã€‚éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯:åˆ†è¡¨ä»…ä»…æ˜¯è§£å†³äº†å•ä¸€è¡¨æ•°æ®è¿‡å¤§çš„é—®é¢˜ï¼Œä½†ç”±äºè¡¨çš„æ•°æ®è¿˜æ˜¯åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œå…¶å®å¯¹äºæå‡MySQLå¹¶å‘èƒ½åŠ›æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œæ‰€ä»¥ <strong>æ°´å¹³æ‹†åˆ†æœ€å¥½åˆ†åº“</strong> ã€‚æ°´å¹³æ‹†åˆ†èƒ½å¤Ÿ <strong>æ”¯æŒéå¸¸å¤§çš„æ•°æ®é‡å­˜å‚¨ï¼Œåº”ç”¨ç«¯æ”¹é€ ä¹Ÿå°‘</strong>ï¼Œä½† <strong>åˆ†ç‰‡äº‹åŠ¡éš¾ä»¥è§£å†³</strong>  ï¼Œè·¨ç•Œç‚¹Joinæ€§èƒ½è¾ƒå·®ï¼Œé€»è¾‘å¤æ‚ã€‚ã€ŠJavaå·¥ç¨‹å¸ˆä¿®ç‚¼ä¹‹é“ã€‹çš„ä½œè€…æ¨è <strong>å°½é‡ä¸è¦å¯¹æ•°æ®è¿›è¡Œåˆ†ç‰‡ï¼Œå› ä¸ºæ‹†åˆ†ä¼šå¸¦æ¥é€»è¾‘ã€éƒ¨ç½²ã€è¿ç»´çš„å„ç§å¤æ‚åº¦</strong> ï¼Œä¸€èˆ¬çš„æ•°æ®è¡¨åœ¨ä¼˜åŒ–å¾—å½“çš„æƒ…å†µä¸‹æ”¯æ’‘åƒä¸‡ä»¥ä¸‹çš„æ•°æ®é‡æ˜¯æ²¡æœ‰å¤ªå¤§é—®é¢˜çš„ã€‚å¦‚æœå®åœ¨è¦åˆ†ç‰‡ï¼Œå°½é‡é€‰æ‹©å®¢æˆ·ç«¯åˆ†ç‰‡æ¶æ„ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸€æ¬¡å’Œä¸­é—´ä»¶çš„ç½‘ç»œI/Oã€‚</li></ol><p><strong>ä¸‹é¢è¡¥å……ä¸€ä¸‹æ•°æ®åº“åˆ†ç‰‡çš„ä¸¤ç§å¸¸è§æ–¹æ¡ˆï¼š</strong></p><ul><li><strong>å®¢æˆ·ç«¯ä»£ç†ï¼š</strong>  <strong>åˆ†ç‰‡é€»è¾‘åœ¨åº”ç”¨ç«¯ï¼Œå°è£…åœ¨jaråŒ…ä¸­ï¼Œé€šè¿‡ä¿®æ”¹æˆ–è€…å°è£…JDBCå±‚æ¥å®ç°ã€‚</strong> å½“å½“ç½‘çš„ <strong>Sharding-JDBC</strong> ã€é˜¿é‡Œçš„TDDLæ˜¯ä¸¤ç§æ¯”è¾ƒå¸¸ç”¨çš„å®ç°ã€‚</li><li><strong>ä¸­é—´ä»¶ä»£ç†ï¼š</strong> <strong>åœ¨åº”ç”¨å’Œæ•°æ®ä¸­é—´åŠ äº†ä¸€ä¸ªä»£ç†å±‚ã€‚åˆ†ç‰‡é€»è¾‘ç»Ÿä¸€ç»´æŠ¤åœ¨ä¸­é—´ä»¶æœåŠ¡ä¸­ã€‚</strong> æˆ‘ä»¬ç°åœ¨è°ˆçš„ <strong>Mycat</strong> ã€360çš„Atlasã€ç½‘æ˜“çš„DDBç­‰ç­‰éƒ½æ˜¯è¿™ç§æ¶æ„çš„å®ç°ã€‚</li></ul><h3 id="9-åœ¨ç³»ç»Ÿä¸­ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¸¦æ¥ä»€ä¹ˆå¥½å¤„"><a href="#9-åœ¨ç³»ç»Ÿä¸­ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¸¦æ¥ä»€ä¹ˆå¥½å¤„" class="headerlink" title="9. åœ¨ç³»ç»Ÿä¸­ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¸¦æ¥ä»€ä¹ˆå¥½å¤„?"></a>9. åœ¨ç³»ç»Ÿä¸­ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¸¦æ¥ä»€ä¹ˆå¥½å¤„?</h3><p><strong>ã€Šå¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„ã€‹ç¬¬å››ç« å’Œç¬¬ä¸ƒç« å‡æœ‰æåˆ°æ¶ˆæ¯é˜Ÿåˆ—å¯¹åº”ç”¨æ€§èƒ½åŠæ‰©å±•æ€§çš„æå‡ã€‚</strong></p><h4 id="1-é€šè¿‡å¼‚æ­¥å¤„ç†æé«˜ç³»ç»Ÿæ€§èƒ½"><a href="#1-é€šè¿‡å¼‚æ­¥å¤„ç†æé«˜ç³»ç»Ÿæ€§èƒ½" class="headerlink" title="1) é€šè¿‡å¼‚æ­¥å¤„ç†æé«˜ç³»ç»Ÿæ€§èƒ½"></a>1) é€šè¿‡å¼‚æ­¥å¤„ç†æé«˜ç³»ç»Ÿæ€§èƒ½</h4><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/162e63a8e34ba534?w=910&h=350&f=jpeg&s=29123.jpg" alt="é€šè¿‡å¼‚æ­¥å¤„ç†æé«˜ç³»ç»Ÿæ€§èƒ½"><br>å¦‚ä¸Šå›¾ï¼Œ<strong>åœ¨ä¸ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨çš„æ—¶å€™ï¼Œç”¨æˆ·çš„è¯·æ±‚æ•°æ®ç›´æ¥å†™å…¥æ•°æ®åº“ï¼Œåœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹æ•°æ®åº“å‹åŠ›å‰§å¢ï¼Œä½¿å¾—å“åº”é€Ÿåº¦å˜æ…¢ã€‚ä½†æ˜¯åœ¨ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ä¹‹åï¼Œç”¨æˆ·çš„è¯·æ±‚æ•°æ®å‘é€ç»™æ¶ˆæ¯é˜Ÿåˆ—ä¹‹åç«‹å³ è¿”å›ï¼Œå†ç”±æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è€…è¿›ç¨‹ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è·å–æ•°æ®ï¼Œå¼‚æ­¥å†™å…¥æ•°æ®åº“ã€‚ç”±äºæ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨å¤„ç†é€Ÿåº¦å¿«äºæ•°æ®åº“ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿæ¯”æ•°æ®åº“æœ‰æ›´å¥½çš„ä¼¸ç¼©æ€§ï¼‰ï¼Œå› æ­¤å“åº”é€Ÿåº¦å¾—åˆ°å¤§å¹…æ”¹å–„ã€‚</strong></p><p>é€šè¿‡ä»¥ä¸Šåˆ†ææˆ‘ä»¬å¯ä»¥å¾—å‡º<strong>æ¶ˆæ¯é˜Ÿåˆ—å…·æœ‰å¾ˆå¥½çš„å‰Šå³°ä½œç”¨çš„åŠŸèƒ½</strong>â€”â€”å³<strong>é€šè¿‡å¼‚æ­¥å¤„ç†ï¼Œå°†çŸ­æ—¶é—´é«˜å¹¶å‘äº§ç”Ÿçš„äº‹åŠ¡æ¶ˆæ¯å­˜å‚¨åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œä»è€Œå‰Šå¹³é«˜å³°æœŸçš„å¹¶å‘äº‹åŠ¡ã€‚</strong> ä¸¾ä¾‹ï¼šåœ¨ç”µå­å•†åŠ¡ä¸€äº›ç§’æ€ã€ä¿ƒé”€æ´»åŠ¨ä¸­ï¼Œåˆç†ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥æœ‰æ•ˆæŠµå¾¡ä¿ƒé”€æ´»åŠ¨åˆšå¼€å§‹å¤§é‡è®¢å•æ¶Œå…¥å¯¹ç³»ç»Ÿçš„å†²å‡»ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/162e64583dd3ed01?w=780&h=384&f=jpeg&s=13550.jpg" alt="åˆç†ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥æœ‰æ•ˆæŠµå¾¡ä¿ƒé”€æ´»åŠ¨åˆšå¼€å§‹å¤§é‡è®¢å•æ¶Œå…¥å¯¹ç³»ç»Ÿçš„å†²å‡»"><br>å› ä¸º<strong>ç”¨æˆ·è¯·æ±‚æ•°æ®å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¹‹åå°±ç«‹å³è¿”å›ç»™ç”¨æˆ·äº†ï¼Œä½†æ˜¯è¯·æ±‚æ•°æ®åœ¨åç»­çš„ä¸šåŠ¡æ ¡éªŒã€å†™æ•°æ®åº“ç­‰æ“ä½œä¸­å¯èƒ½å¤±è´¥</strong>ã€‚å› æ­¤ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå¼‚æ­¥å¤„ç†ä¹‹åï¼Œéœ€è¦<strong>é€‚å½“ä¿®æ”¹ä¸šåŠ¡æµç¨‹è¿›è¡Œé…åˆ</strong>ï¼Œæ¯”å¦‚<strong>ç”¨æˆ·åœ¨æäº¤è®¢å•ä¹‹åï¼Œè®¢å•æ•°æ®å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸èƒ½ç«‹å³è¿”å›ç”¨æˆ·è®¢å•æäº¤æˆåŠŸï¼Œéœ€è¦åœ¨æ¶ˆæ¯é˜Ÿåˆ—çš„è®¢å•æ¶ˆè´¹è€…è¿›ç¨‹çœŸæ­£å¤„ç†å®Œè¯¥è®¢å•ä¹‹åï¼Œç”šè‡³å‡ºåº“åï¼Œå†é€šè¿‡ç”µå­é‚®ä»¶æˆ–çŸ­ä¿¡é€šçŸ¥ç”¨æˆ·è®¢å•æˆåŠŸ</strong>ï¼Œä»¥å…äº¤æ˜“çº çº·ã€‚è¿™å°±ç±»ä¼¼æˆ‘ä»¬å¹³æ—¶æ‰‹æœºè®¢ç«è½¦ç¥¨å’Œç”µå½±ç¥¨ã€‚</p><h3 id="2-é™ä½ç³»ç»Ÿè€¦åˆæ€§"><a href="#2-é™ä½ç³»ç»Ÿè€¦åˆæ€§" class="headerlink" title="2) é™ä½ç³»ç»Ÿè€¦åˆæ€§"></a>2) é™ä½ç³»ç»Ÿè€¦åˆæ€§</h3><p>æˆ‘ä»¬çŸ¥é“æ¨¡å—åˆ†å¸ƒå¼éƒ¨ç½²ä»¥åèšåˆæ–¹å¼é€šå¸¸æœ‰ä¸¤ç§ï¼š1.<strong>åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—</strong>å’Œ2.<strong>åˆ†å¸ƒå¼æœåŠ¡</strong>ã€‚</p><blockquote><p><strong>å…ˆæ¥ç®€å•è¯´ä¸€ä¸‹åˆ†å¸ƒå¼æœåŠ¡ï¼š</strong></p></blockquote><p>ç›®å‰ä½¿ç”¨æ¯”è¾ƒå¤šçš„ç”¨æ¥æ„å»º<strong>SOAï¼ˆService Oriented Architectureé¢å‘æœåŠ¡ä½“ç³»ç»“æ„ï¼‰</strong>çš„<strong>åˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶</strong>æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„<strong>Dubbo</strong>.å¦‚æœæƒ³æ·±å…¥äº†è§£Dubboçš„å¯ä»¥çœ‹æˆ‘å†™çš„å…³äºDubboçš„è¿™ä¸€ç¯‡æ–‡ç« ï¼š<strong>ã€Šé«˜æ€§èƒ½ä¼˜ç§€çš„æœåŠ¡æ¡†æ¶-dubboä»‹ç»ã€‹</strong>ï¼š<a href="https://juejin.im/post/5acadeb1f265da2375072f9c">https://juejin.im/post/5acadeb1f265da2375072f9c</a></p><blockquote><p><strong>å†æ¥è°ˆæˆ‘ä»¬çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ï¼š</strong></p></blockquote><p>æˆ‘ä»¬çŸ¥é“å¦‚æœæ¨¡å—ä¹‹é—´ä¸å­˜åœ¨ç›´æ¥è°ƒç”¨ï¼Œé‚£ä¹ˆæ–°å¢æ¨¡å—æˆ–è€…ä¿®æ”¹æ¨¡å—å°±å¯¹å…¶ä»–æ¨¡å—å½±å“è¾ƒå°ï¼Œè¿™æ ·ç³»ç»Ÿçš„å¯æ‰©å±•æ€§æ— ç–‘æ›´å¥½ä¸€äº›ã€‚</p><p>æˆ‘ä»¬æœ€å¸¸è§çš„<strong>äº‹ä»¶é©±åŠ¨æ¶æ„</strong>ç±»ä¼¼ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ï¼Œåœ¨å¤§å‹ç½‘ç«™ä¸­é€šå¸¸ç”¨åˆ©ç”¨æ¶ˆæ¯é˜Ÿåˆ—å®ç°äº‹ä»¶é©±åŠ¨ç»“æ„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/162e6665fa394b3b?w=790&h=290&f=jpeg&s=14946.jpg" alt="åˆ©ç”¨æ¶ˆæ¯é˜Ÿåˆ—å®ç°äº‹ä»¶é©±åŠ¨ç»“æ„"><br><strong>æ¶ˆæ¯é˜Ÿåˆ—ä½¿åˆ©ç”¨å‘å¸ƒ-è®¢é˜…æ¨¡å¼å·¥ä½œï¼Œæ¶ˆæ¯å‘é€è€…ï¼ˆç”Ÿäº§è€…ï¼‰å‘å¸ƒæ¶ˆæ¯ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆæ¯æ¥å—è€…ï¼ˆæ¶ˆè´¹è€…ï¼‰è®¢é˜…æ¶ˆæ¯ã€‚</strong> ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°<strong>æ¶ˆæ¯å‘é€è€…ï¼ˆç”Ÿäº§è€…ï¼‰å’Œæ¶ˆæ¯æ¥å—è€…ï¼ˆæ¶ˆè´¹è€…ï¼‰ä¹‹é—´æ²¡æœ‰ç›´æ¥è€¦åˆ</strong>ï¼Œæ¶ˆæ¯å‘é€è€…å°†æ¶ˆæ¯å‘é€è‡³åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—å³ç»“æŸå¯¹æ¶ˆæ¯çš„å¤„ç†ï¼Œæ¶ˆæ¯æ¥å—è€…ä»åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—è·å–è¯¥æ¶ˆæ¯åè¿›è¡Œåç»­å¤„ç†ï¼Œå¹¶ä¸éœ€è¦çŸ¥é“è¯¥æ¶ˆæ¯ä»ä½•è€Œæ¥ã€‚<strong>å¯¹æ–°å¢ä¸šåŠ¡ï¼Œåªè¦å¯¹è¯¥ç±»æ¶ˆæ¯æ„Ÿå…´è¶£ï¼Œå³å¯è®¢é˜…è¯¥æ¶ˆæ¯ï¼Œå¯¹åŸæœ‰ç³»ç»Ÿå’Œä¸šåŠ¡æ²¡æœ‰ä»»ä½•å½±å“ï¼Œä»è€Œå®ç°ç½‘ç«™ä¸šåŠ¡çš„å¯æ‰©å±•æ€§è®¾è®¡</strong>ã€‚</p><p>æ¶ˆæ¯æ¥å—è€…å¯¹æ¶ˆæ¯è¿›è¡Œè¿‡æ»¤ã€å¤„ç†ã€åŒ…è£…åï¼Œæ„é€ æˆä¸€ä¸ªæ–°çš„æ¶ˆæ¯ç±»å‹ï¼Œå°†æ¶ˆæ¯ç»§ç»­å‘é€å‡ºå»ï¼Œç­‰å¾…å…¶ä»–æ¶ˆæ¯æ¥å—è€…è®¢é˜…è¯¥æ¶ˆæ¯ã€‚å› æ­¤åŸºäºäº‹ä»¶ï¼ˆæ¶ˆæ¯å¯¹è±¡ï¼‰é©±åŠ¨çš„ä¸šåŠ¡æ¶æ„å¯ä»¥æ˜¯ä¸€ç³»åˆ—æµç¨‹ã€‚</p><p><strong>å¦å¤–ä¸ºäº†é¿å…æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨å®•æœºé€ æˆæ¶ˆæ¯ä¸¢å¤±ï¼Œä¼šå°†æˆåŠŸå‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆæ¯å­˜å‚¨åœ¨æ¶ˆæ¯ç”Ÿäº§è€…æœåŠ¡å™¨ä¸Šï¼Œç­‰æ¶ˆæ¯çœŸæ­£è¢«æ¶ˆè´¹è€…æœåŠ¡å™¨å¤„ç†åæ‰åˆ é™¤æ¶ˆæ¯ã€‚åœ¨æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨å®•æœºåï¼Œç”Ÿäº§è€…æœåŠ¡å™¨ä¼šé€‰æ‹©åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨é›†ç¾¤ä¸­çš„å…¶ä»–æœåŠ¡å™¨å‘å¸ƒæ¶ˆæ¯ã€‚</strong>   </p><p><strong>å¤‡æ³¨ï¼š</strong> ä¸è¦è®¤ä¸ºæ¶ˆæ¯é˜Ÿåˆ—åªèƒ½åˆ©ç”¨å‘å¸ƒ-è®¢é˜…æ¨¡å¼å·¥ä½œï¼Œåªä¸è¿‡åœ¨è§£è€¦è¿™ä¸ªç‰¹å®šä¸šåŠ¡ç¯å¢ƒä¸‹æ˜¯ä½¿ç”¨å‘å¸ƒ-è®¢é˜…æ¨¡å¼çš„ï¼Œ<strong>æ¯”å¦‚åœ¨æˆ‘ä»¬çš„ActiveMQæ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿˜æœ‰ç‚¹å¯¹ç‚¹å·¥ä½œæ¨¡å¼</strong>ï¼Œå…·ä½“çš„ä¼šåœ¨åé¢çš„æ–‡ç« ç»™å¤§å®¶è¯¦ç»†ä»‹ç»ï¼Œè¿™ä¸€ç¯‡æ–‡ç« ä¸»è¦è¿˜æ˜¯è®©å¤§å®¶å¯¹æ¶ˆæ¯é˜Ÿåˆ—æœ‰ä¸€ä¸ªæ›´é€å½»çš„äº†è§£ã€‚</p><blockquote><p>è¿™ä¸ªé—®é¢˜ä¸€èˆ¬ä¼šåœ¨ä¸Šä¸€ä¸ªé—®é¢˜é—®å®Œä¹‹åï¼Œç´§æ¥ç€è¢«é—®åˆ°ã€‚â€œä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Ÿâ€è¿™ä¸ªé—®é¢˜è¦å¼•èµ·é‡è§†ï¼Œä¸€èˆ¬æˆ‘ä»¬éƒ½ä¼šè€ƒè™‘ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ä¼šå¸¦æ¥çš„å¥½å¤„è€Œå¿½ç•¥å®ƒå¸¦æ¥çš„é—®é¢˜ï¼</p></blockquote><h3 id="10-è¯´è¯´è‡ªå·±å¯¹-CAP-å®šç†-BASE-ç†è®ºçš„äº†è§£"><a href="#10-è¯´è¯´è‡ªå·±å¯¹-CAP-å®šç†-BASE-ç†è®ºçš„äº†è§£" class="headerlink" title="10. è¯´è¯´è‡ªå·±å¯¹ CAP å®šç†,BASE ç†è®ºçš„äº†è§£"></a>10. è¯´è¯´è‡ªå·±å¯¹ CAP å®šç†,BASE ç†è®ºçš„äº†è§£</h3><h4 id="CAP-å®šç†"><a href="#CAP-å®šç†" class="headerlink" title="CAP å®šç†"></a>CAP å®šç†</h4><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/163912e973ecb93c?w=624&h=471&f=png&s=32984.jpg" alt="CAPå®šç†"><br>åœ¨ç†è®ºè®¡ç®—æœºç§‘å­¦ä¸­ï¼ŒCAPå®šç†ï¼ˆCAP theoremï¼‰ï¼Œåˆè¢«ç§°ä½œå¸ƒé²å°”å®šç†ï¼ˆBrewerâ€™s theoremï¼‰ï¼Œå®ƒæŒ‡å‡ºå¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼è®¡ç®—ç³»ç»Ÿæ¥è¯´ï¼Œä¸å¯èƒ½åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸‰ç‚¹ï¼š</p><ul><li><strong>ä¸€è‡´æ€§ï¼ˆConsistenceï¼‰</strong> :æ‰€æœ‰èŠ‚ç‚¹è®¿é—®åŒä¸€ä»½æœ€æ–°çš„æ•°æ®å‰¯æœ¬</li><li><strong>å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰</strong>:æ¯æ¬¡è¯·æ±‚éƒ½èƒ½è·å–åˆ°éé”™çš„å“åº”â€”â€”ä½†æ˜¯ä¸ä¿è¯è·å–çš„æ•°æ®ä¸ºæœ€æ–°æ•°æ®</li><li><strong>åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰</strong> : åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨é‡åˆ°æŸèŠ‚ç‚¹æˆ–ç½‘ç»œåˆ†åŒºæ•…éšœçš„æ—¶å€™ï¼Œä»ç„¶èƒ½å¤Ÿå¯¹å¤–æä¾›æ»¡è¶³ä¸€è‡´æ€§å’Œå¯ç”¨æ€§çš„æœåŠ¡ã€‚</li></ul><p>CAPä»…é€‚ç”¨äºåŸå­è¯»å†™çš„NOSQLåœºæ™¯ä¸­ï¼Œå¹¶ä¸é€‚åˆæ•°æ®åº“ç³»ç»Ÿã€‚ç°åœ¨çš„åˆ†å¸ƒå¼ç³»ç»Ÿå…·æœ‰æ›´å¤šç‰¹æ€§æ¯”å¦‚æ‰©å±•æ€§ã€å¯ç”¨æ€§ç­‰ç­‰ï¼Œåœ¨è¿›è¡Œç³»ç»Ÿè®¾è®¡å’Œå¼€å‘æ—¶ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ä»…ä»…å±€é™åœ¨CAPé—®é¢˜ä¸Šã€‚</p><p><strong>æ³¨æ„ï¼šä¸æ˜¯æ‰€è°“çš„3é€‰2ï¼ˆä¸è¦è¢«ç½‘ä¸Šå¤§å¤šæ•°æ–‡ç« è¯¯å¯¼äº†ï¼‰:</strong></p><p>å¤§éƒ¨åˆ†äººè§£é‡Šè¿™ä¸€å®šå¾‹æ—¶ï¼Œå¸¸å¸¸ç®€å•çš„è¡¨è¿°ä¸ºï¼šâ€œä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€åˆ†åŒºå®¹å¿æ€§ä¸‰è€…ä½ åªèƒ½åŒæ—¶è¾¾åˆ°å…¶ä¸­ä¸¤ä¸ªï¼Œä¸å¯èƒ½åŒæ—¶è¾¾åˆ°â€ã€‚å®é™…ä¸Šè¿™æ˜¯ä¸€ä¸ªéå¸¸å…·æœ‰è¯¯å¯¼æ€§è´¨çš„è¯´æ³•ï¼Œè€Œä¸”åœ¨CAPç†è®ºè¯ç”Ÿ12å¹´ä¹‹åï¼ŒCAPä¹‹çˆ¶ä¹Ÿåœ¨2012å¹´é‡å†™äº†ä¹‹å‰çš„è®ºæ–‡ã€‚</p><p><strong>å½“å‘ç”Ÿç½‘ç»œåˆ†åŒºçš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬è¦ç»§ç»­æœåŠ¡ï¼Œé‚£ä¹ˆå¼ºä¸€è‡´æ€§å’Œå¯ç”¨æ€§åªèƒ½2é€‰1ã€‚ä¹Ÿå°±æ˜¯è¯´å½“ç½‘ç»œåˆ†åŒºä¹‹åPæ˜¯å‰æï¼Œå†³å®šäº†Pä¹‹åæ‰æœ‰Cå’ŒAçš„é€‰æ‹©ã€‚ä¹Ÿå°±æ˜¯è¯´åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰æˆ‘ä»¬æ˜¯å¿…é¡»è¦å®ç°çš„ã€‚</strong></p><p>æˆ‘åœ¨ç½‘ä¸Šæ‰¾äº†å¾ˆå¤šæ–‡ç« æƒ³çœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰æ–‡ç« æåˆ°è¿™ä¸ªä¸æ˜¯æ‰€è°“çš„3é€‰2ï¼Œç”¨ç™¾åº¦åŠå¤©æ²¡æ‰¾åˆ°äº†ä¸€ç¯‡ï¼Œç”¨è°·æ­Œæœç´¢æ‰¾åˆ°ä¸€ç¯‡æ¯”è¾ƒä¸é”™çš„ï¼Œå¦‚æœæƒ³æ·±å…¥å­¦ä¹ ä¸€ä¸‹CAPå°±çœ‹è¿™ç¯‡æ–‡ç« æŠŠï¼Œæˆ‘è¿™é‡Œå°±ä¸å¤šBBäº†ï¼š<strong>ã€Šåˆ†å¸ƒå¼ç³»ç»Ÿä¹‹CAPç†è®ºã€‹ ï¼š</strong> <a href="http://www.cnblogs.com/hxsyl/p/4381980.html">http://www.cnblogs.com/hxsyl/p/4381980.html</a></p><h4 id="BASE-ç†è®º"><a href="#BASE-ç†è®º" class="headerlink" title="BASE ç†è®º"></a>BASE ç†è®º</h4><p><strong>BASE</strong> æ˜¯ <strong>Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰</strong> ã€<strong>Soft-stateï¼ˆè½¯çŠ¶æ€ï¼‰</strong> å’Œ <strong>Eventually Consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰</strong> ä¸‰ä¸ªçŸ­è¯­çš„ç¼©å†™ã€‚BASEç†è®ºæ˜¯å¯¹CAPä¸­ä¸€è‡´æ€§å’Œå¯ç”¨æ€§æƒè¡¡çš„ç»“æœï¼Œå…¶æ¥æºäºå¯¹å¤§è§„æ¨¡äº’è”ç½‘ç³»ç»Ÿåˆ†å¸ƒå¼å®è·µçš„æ€»ç»“ï¼Œæ˜¯åŸºäºCAPå®šç†é€æ­¥æ¼”åŒ–è€Œæ¥çš„ï¼Œå®ƒå¤§å¤§é™ä½äº†æˆ‘ä»¬å¯¹ç³»ç»Ÿçš„è¦æ±‚ã€‚</p><p><strong>BASEç†è®ºçš„æ ¸å¿ƒæ€æƒ³ï¼š</strong> å³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼Œä½†æ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹ç‚¹ï¼Œé‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚ä¹Ÿå°±æ˜¯ç‰ºç‰²æ•°æ®çš„ä¸€è‡´æ€§æ¥æ»¡è¶³ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ï¼Œç³»ç»Ÿä¸­ä¸€éƒ¨åˆ†æ•°æ®ä¸å¯ç”¨æˆ–è€…ä¸ä¸€è‡´æ—¶ï¼Œä»éœ€è¦ä¿æŒç³»ç»Ÿæ•´ä½“â€œä¸»è¦å¯ç”¨â€ã€‚</p><p><strong>BASEç†è®ºä¸‰è¦ç´ ï¼š</strong></p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/163914806d9e15c6?w=612&h=461&f=png&s=39129.jpg" alt="BASEç†è®ºä¸‰è¦ç´ "></p><ol><li><strong>åŸºæœ¬å¯ç”¨ï¼š</strong> åŸºæœ¬å¯ç”¨æ˜¯æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°ä¸å¯é¢„çŸ¥æ•…éšœçš„æ—¶å€™ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ã€‚ä½†æ˜¯ï¼Œè¿™ç»ä¸ç­‰ä»·äºç³»ç»Ÿä¸å¯ç”¨ã€‚ æ¯”å¦‚ï¼š <strong>â‘ å“åº”æ—¶é—´ä¸Šçš„æŸå¤±</strong>:æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåœ¨çº¿æœç´¢å¼•æ“éœ€è¦åœ¨0.5ç§’ä¹‹å†…è¿”å›ç»™ç”¨æˆ·ç›¸åº”çš„æŸ¥è¯¢ç»“æœï¼Œä½†ç”±äºå‡ºç°æ•…éšœï¼ŒæŸ¥è¯¢ç»“æœçš„å“åº”æ—¶é—´å¢åŠ äº†1~2ç§’ï¼›<strong>â‘¡ç³»ç»ŸåŠŸèƒ½ä¸Šçš„æŸå¤±</strong>ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œåœ¨ä¸€ä¸ªç”µå­å•†åŠ¡ç½‘ç«™ä¸Šè¿›è¡Œè´­ç‰©çš„æ—¶å€™ï¼Œæ¶ˆè´¹è€…å‡ ä¹èƒ½å¤Ÿé¡ºåˆ©å®Œæˆæ¯ä¸€ç¬”è®¢å•ï¼Œä½†æ˜¯åœ¨ä¸€äº›èŠ‚æ—¥å¤§ä¿ƒè´­ç‰©é«˜å³°çš„æ—¶å€™ï¼Œç”±äºæ¶ˆè´¹è€…çš„è´­ç‰©è¡Œä¸ºæ¿€å¢ï¼Œä¸ºäº†ä¿æŠ¤è´­ç‰©ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œéƒ¨åˆ†æ¶ˆè´¹è€…å¯èƒ½ä¼šè¢«å¼•å¯¼åˆ°ä¸€ä¸ªé™çº§é¡µé¢ï¼›</li><li><strong>è½¯çŠ¶æ€ï¼š</strong> è½¯çŠ¶æ€æŒ‡å…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œå¹¶è®¤ä¸ºè¯¥ä¸­é—´çŠ¶æ€çš„å­˜åœ¨ä¸ä¼šå½±å“ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§ï¼Œå³å…è®¸ç³»ç»Ÿåœ¨ä¸åŒèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥çš„è¿‡ç¨‹å­˜åœ¨å»¶æ—¶ï¼›</li><li><strong>æœ€ç»ˆä¸€è‡´æ€§ï¼š</strong> æœ€ç»ˆä¸€è‡´æ€§å¼ºè°ƒçš„æ˜¯ç³»ç»Ÿä¸­æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚å› æ­¤ï¼Œæœ€ç»ˆä¸€è‡´æ€§çš„æœ¬è´¨æ˜¯éœ€è¦ç³»ç»Ÿä¿è¯æœ€ç»ˆæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ï¼Œè€Œä¸éœ€è¦å®æ—¶ä¿è¯ç³»ç»Ÿæ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚</li></ol><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li>ã€Šå¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„ã€‹</li><li>ã€Šäº¿çº§æµé‡ç½‘ç«™æ¶æ„æ ¸å¿ƒæŠ€æœ¯ã€‹</li><li>ã€ŠJavaå·¥ç¨‹å¸ˆä¿®ç‚¼ä¹‹é“ã€‹</li><li><a href="https://www.cnblogs.com/puresoul/p/5456855.html">https://www.cnblogs.com/puresoul/p/5456855.html</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸‹é¢è¿™äº›é—®é¢˜éƒ½æ˜¯ä¸€çº¿å¤§å‚çš„çœŸå®é¢è¯•é—®é¢˜ï¼Œä¸è®ºæ˜¯å¯¹ä½ é¢è¯•è¿˜æ˜¯è¯´æ‹“å®½çŸ¥è¯†é¢éƒ½å¾ˆæœ‰å¸®åŠ©ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="æ¶æ„" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E6%9E%B6%E6%9E%84/"/>
    
    
      <category term="æ¶æ„" scheme="https://brokge.github.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>Java-åˆ†å¸ƒå¼é”è¿™æ ·å®ç°</title>
    <link href="https://brokge.github.io/2020/08/13/Java-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E8%BF%99%E6%A0%B7%E5%AE%9E%E7%8E%B0/"/>
    <id>https://brokge.github.io/2020/08/13/Java-åˆ†å¸ƒå¼é”è¿™æ ·å®ç°/</id>
    <published>2020-08-13T12:41:41.000Z</published>
    <updated>2020-08-21T04:57:50.587Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸ºäº†é˜²æ­¢åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤šä¸ªè¿›ç¨‹ä¹‹é—´ç›¸äº’å¹²æ‰°ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§åˆ†å¸ƒå¼åè°ƒæŠ€æœ¯æ¥å¯¹è¿™äº›è¿›ç¨‹è¿›è¡Œè°ƒåº¦ã€‚è€Œè¿™ä¸ªåˆ†å¸ƒå¼åè°ƒæŠ€æœ¯çš„æ ¸å¿ƒå°±æ˜¯æ¥å®ç°è¿™ä¸ªåˆ†å¸ƒå¼é”ã€‚</p><a id="more"></a><p>åˆ†å¸ƒå¼é”å®ç°ï¼Œç›®å‰æœ‰å¾ˆå¤šç§æ–¹å¼æ¯”å¦‚ä»¥ä¸‹æ–¹å¼ã€‚</p><h1 id="1-å¸¸ç”¨å®ç°æ–¹å¼"><a href="#1-å¸¸ç”¨å®ç°æ–¹å¼" class="headerlink" title="1. å¸¸ç”¨å®ç°æ–¹å¼"></a>1. å¸¸ç”¨å®ç°æ–¹å¼</h1><ul><li>åŸºäºæ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”</li></ul><ol><li>æ€§èƒ½è¾ƒå·®ï¼Œå®¹æ˜“å‡ºç°å•ç‚¹æ•…éšœã€‚</li><li>é”æ²¡æœ‰å¤±æ•ˆæ—¶é—´ï¼Œå®¹æ˜“æ­»é”ã€‚</li></ol><ul><li>åŸºäºç¼“å­˜å®ç°åˆ†å¸ƒå¼é”</li></ul><ol><li>æ¯”å¦‚é€šè¿‡Redis å®ç°ï¼Œä½†ç›¸å¯¹å¤æ‚ã€‚</li><li>å­˜åœ¨æ­»é”ï¼ˆæˆ–çŸ­æ—¶é—´æ­»é”ï¼‰çš„å¯èƒ½ã€‚</li></ol><ul><li>åŸºäº Zookeeper å®ç°åˆ†å¸ƒå¼é”</li></ul><ol><li>å®ç°ç›¸å¯¹ç®€å•</li><li>å¯é æ€§é«˜</li><li>æ€§èƒ½å¥½</li></ol><p>ä»ä¸Šé¢æ¥çœ‹ï¼ŒZookeeper æ˜¯ä¸€ä¸ªç†æƒ³çŠ¶æ€ä¸‹çš„åˆ†å¸ƒå¼é”å®ç°ï¼Œé‚£zkä¸ºä»€ä¹ˆç†æƒ³å‘¢ï¼Ÿè¿™è¦ä» zk çš„ç‰¹æ€§æ¥è¯´ã€‚</p><ol><li>é¦–å…ˆzk æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ï¼Œå¼€æ”¾æºç çš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºåè°ƒæœåŠ¡ã€‚</li><li>åŸºäºèŠ‚ç‚¹çš„æ•°æ®ç»“æ„ï¼Œå’Œunixæ–‡ä»¶è·¯å¾„ç›¸ä¼¼çš„èŠ‚ç‚¹ï¼Œå¯ä»¥å¾€è¿™ä¸ªèŠ‚ç‚¹å­˜å‚¨æˆ–è·å–æ•°æ®ã€‚</li><li>é€šè¿‡å®¢æˆ·ç«¯å¯å¯¹ znode è¿›è¡Œå¢åˆ æ”¹æŸ¥çš„æ“ä½œï¼Œè¿˜å¯ä»¥æ³¨å†Œwatcherç›‘æ§znodeå˜åŒ–ã€‚</li><li>èŠ‚ç‚¹ç±»å‹åˆ†ä¸ºæŒä¹…èŠ‚ç‚¹ï¼ˆåŒ…å«ï¼šé¡ºåºå’Œéé¡ºåºï¼‰ã€ä¸´æ—¶èŠ‚ç‚¹ï¼ˆé¡ºåºå’Œéé¡ºåºï¼‰</li><li>åŒçˆ¶çš„å­èŠ‚ç‚¹ä¸å¯é‡å¤ã€‚</li></ol><h2 id="3-Zookeeper-å®ç°åˆ†å¸ƒå¼é”ä¸€"><a href="#3-Zookeeper-å®ç°åˆ†å¸ƒå¼é”ä¸€" class="headerlink" title="3. Zookeeper å®ç°åˆ†å¸ƒå¼é”ä¸€"></a>3. Zookeeper å®ç°åˆ†å¸ƒå¼é”ä¸€</h2><p>åˆ©ç”¨zk åŒçˆ¶èŠ‚ç‚¹ä¸‹å­èŠ‚ç‚¹ä¸å¯é‡åçš„ç‰¹æ€§ã€‚</p><p>å®ç°æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/1892343233.jpg" alt="image"></p><p>é’ˆå¯¹ä»¥ä¸Šæµç¨‹ä»£ç å®ç°å¦‚ä¸‹ï¼ŒåŒ…å«å¯é‡å…¥é”çš„ç‰¹æ€§ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZKDistributeLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> String lockPath<span class="token punctuation">;</span>    <span class="token keyword">private</span> ZkClient client<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// é”é‡å…¥è®¡æ•°</span>    <span class="token keyword">private</span> ThreadLocal<span class="token operator">&lt;</span>Integer<span class="token operator">></span> reentrantCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">ZKDistributeLock</span><span class="token punctuation">(</span>String lockPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>lockPath <span class="token operator">=</span> lockPath<span class="token punctuation">;</span>        client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZkClient</span><span class="token punctuation">(</span><span class="token string">"localhost:2181"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        client<span class="token punctuation">.</span><span class="token function">setZkSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyZkSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// ä¸ä¼šé˜»å¡</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reentrantCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reentrantCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>reentrantCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token operator">++</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// åˆ›å»ºèŠ‚ç‚¹</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            client<span class="token punctuation">.</span><span class="token function">createEphemeral</span><span class="token punctuation">(</span>lockPath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>reentrantCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ZkNodeExistsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// é‡å…¥çš„é‡Šæ”¾é”å¤„ç†</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reentrantCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reentrantCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>reentrantCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token operator">--</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>reentrantCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>lockPath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// å¦‚æœè·å–ä¸åˆ°é”ï¼Œé˜»å¡ç­‰å¾…</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// æ²¡è·å¾—é”ï¼Œé˜»å¡è‡ªå·±</span>            <span class="token function">waitForLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å†æ¬¡å°è¯•</span>            <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">waitForLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        CountDownLatch cdl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        IZkDataListener listener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IZkDataListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDataDeleted</span><span class="token punctuation">(</span>String dataPath<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"----æ”¶åˆ°èŠ‚ç‚¹è¢«åˆ é™¤äº†-------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                cdl<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDataChange</span><span class="token punctuation">(</span>String dataPath<span class="token punctuation">,</span> Object data<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        client<span class="token punctuation">.</span><span class="token function">subscribeDataChanges</span><span class="token punctuation">(</span>lockPath<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// é˜»å¡è‡ªå·±</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>lockPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                cdl<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å–æ¶ˆæ³¨å†Œ</span>        client<span class="token punctuation">.</span><span class="token function">unsubscribeDataChanges</span><span class="token punctuation">(</span>lockPath<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// TODO Auto-generated method stub</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> TimeUnit unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// TODO Auto-generated method stub</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Condition <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// TODO Auto-generated method stub</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¹¶å‘æ•°</span>        <span class="token keyword">int</span> currency <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¾ªç¯å±éšœ</span>        CyclicBarrier cb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span>currency<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¤šçº¿ç¨‹æ¨¡æ‹Ÿé«˜å¹¶å‘</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> currency<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"---------æˆ‘å‡†å¤‡å¥½---------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// ç­‰å¾…ä¸€èµ·å‡ºå‘</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        cb<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> BrokenBarrierException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    ZKDistributeLock lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZKDistributeLock</span><span class="token punctuation">(</span><span class="token string">"/distLock11"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" è·å¾—é”ï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>æ˜¯å¦å¯ä»¥åˆ©ç”¨æŒä¹…èŠ‚ç‚¹è¿›è¡Œåˆ›å»ºï¼Ÿ</li></ol><p>åˆ©ç”¨æŒä¹…èŠ‚ç‚¹ï¼Œå­˜åœ¨æ­»é”çš„é£é™©ã€‚å› ä¸ºå¦‚æœæŒæœ‰é”çš„è¿›ç¨‹æŒ‚æ‰äº†ï¼Œæ²¡æœ‰æ¥çš„åŠåˆ é™¤èŠ‚ç‚¹ï¼Œåˆ™å‡ºç°æ­»é”ã€‚<br>æ‰€ä»¥éœ€è¦ç”¨ä¸´æ—¶èŠ‚ç‚¹ï¼Œå› ä¸ºä¸´æ—¶èŠ‚ç‚¹æœ‰è‡ªåˆ é™¤çš„ç‰¹æ€§ã€‚</p><ol start="2"><li>ä½†æ˜¯é‡‡ç”¨ä¸´æ—¶èŠ‚ç‚¹å°±æ²¡é—®é¢˜äº†å—ï¼Ÿ</li></ol><p>æœ‰é—®é¢˜ï¼Œä¸´æ—¶èŠ‚ç‚¹ä¼šå‡ºç°æƒŠç¾¤æ•ˆåº”ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹ æ³¨å†Œäº† watcher æœºåˆ¶ï¼Œé‚£ä¹ˆåœ¨è¿™ç§å®ç°æ–¹å¼ä¸‹ï¼Œå°±ä¼šæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è¢«å”¤é†’ï¼Œè¿›è¡Œé”äº‰æŠ¢ï¼Œä¼šé€ æˆå·¨å¤§çš„æœåŠ¡å™¨æ€§èƒ½æŸè€—ï¼Œç”šè‡³å¯èƒ½å‡ºç°å®•æœºçš„é£é™©ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„æƒŠç¾¤æ•ˆåº”ã€‚</p><p>é’ˆå¯¹æƒŠç¾¤æ•ˆåº”ï¼Œä¸‹é¢ç»™å‡ºä¸ªæ”¹è¿›ç‰ˆã€‚</p><h2 id="4-zkå®ç°åˆ†å¸ƒå¼é”æ–¹å¼äºŒ"><a href="#4-zkå®ç°åˆ†å¸ƒå¼é”æ–¹å¼äºŒ" class="headerlink" title="4. zkå®ç°åˆ†å¸ƒå¼é”æ–¹å¼äºŒ"></a>4. zkå®ç°åˆ†å¸ƒå¼é”æ–¹å¼äºŒ</h2><p>åˆ©ç”¨zk ä¸´æ—¶é¡ºåºèŠ‚ç‚¹çš„ç‰¹æ€§ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/1892343234.jpg" alt="image"></p><p>åˆ©ç”¨ä¸´æ—¶é¡ºåºèŠ‚ç‚¹æ¥å®ç°åˆ†å¸ƒå¼é”ï¼ŒåŒ…å«å¯é‡å…¥ç‰¹æ€§çš„å®Œæ•´ä»£ç ã€‚</p><ol><li>è·å–é”ï¼šå–æ’é˜Ÿå·ï¼ˆåˆ›å»ºè‡ªå·±çš„ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼‰ï¼Œç„¶ååˆ¤æ–­è‡ªå·±æ˜¯å¦æ˜¯æœ€å°å·ï¼Œå¦‚æ˜¯ï¼Œåˆ™è·å¾—é”ï¼›ä¸æ˜¯ï¼Œåˆ™æ³¨å†Œå‰ä¸€èŠ‚ç‚¹çš„watcher,é˜»å¡ç­‰å¾…</li><li>é‡Šæ”¾é”ï¼šåˆ é™¤è‡ªå·±åˆ›å»ºçš„ä¸´æ—¶é¡ºåºèŠ‚ç‚¹</li><li>é€šçŸ¥ï¼šwatcheræœºåˆ¶é€šçŸ¥é˜»å¡ç­‰å¾…çš„çº¿ç¨‹ã€‚</li></ol><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZKDistributeImproveLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String lockPath<span class="token punctuation">;</span>    <span class="token keyword">private</span> ZkClient client<span class="token punctuation">;</span>    <span class="token keyword">private</span> ThreadLocal<span class="token operator">&lt;</span>String<span class="token operator">></span> currentPath <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> ThreadLocal<span class="token operator">&lt;</span>String<span class="token operator">></span> beforePath <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// é”é‡å…¥è®¡æ•°</span>    <span class="token keyword">private</span> ThreadLocal<span class="token operator">&lt;</span>Integer<span class="token operator">></span> reentrantCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">ZKDistributeImproveLock</span><span class="token punctuation">(</span>String lockPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>lockPath <span class="token operator">=</span> lockPath<span class="token punctuation">;</span>        client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZkClient</span><span class="token punctuation">(</span><span class="token string">"localhost:2181"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        client<span class="token punctuation">.</span><span class="token function">setZkSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyZkSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>lockPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">createPersistent</span><span class="token punctuation">(</span>lockPath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ZkNodeExistsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reentrantCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reentrantCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>reentrantCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token operator">++</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentPath<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            currentPath<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">createEphemeralSequential</span><span class="token punctuation">(</span>lockPath <span class="token operator">+</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token string">"aaa"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// è·å¾—æ‰€æœ‰çš„å­</span>        List<span class="token operator">&lt;</span>String<span class="token operator">></span> children <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span>lockPath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ’åºlist</span>        Collections<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦æ˜¯æœ€å°çš„</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPath<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>lockPath <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> children<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>reentrantCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å–åˆ°å‰ä¸€ä¸ª</span>            <span class="token comment" spellcheck="true">// å¾—åˆ°å­—èŠ‚çš„ç´¢å¼•å·</span>            <span class="token keyword">int</span> curIndex <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>currentPath<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>lockPath<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            beforePath<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>lockPath <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> children<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>curIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// é˜»å¡ç­‰å¾…</span>            <span class="token function">waitForLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å†æ¬¡å°è¯•åŠ é”</span>            <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">waitForLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        CountDownLatch cdl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ³¨å†Œwatcher</span>        IZkDataListener listener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IZkDataListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDataDeleted</span><span class="token punctuation">(</span>String dataPath<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----ç›‘å¬åˆ°èŠ‚ç‚¹è¢«åˆ é™¤"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                cdl<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDataChange</span><span class="token punctuation">(</span>String dataPath<span class="token punctuation">,</span> Object data<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        client<span class="token punctuation">.</span><span class="token function">subscribeDataChanges</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beforePath<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ€ä¹ˆè®©è‡ªå·±é˜»å¡</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beforePath<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                cdl<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// é†’æ¥åï¼Œå–æ¶ˆwatcher</span>        client<span class="token punctuation">.</span><span class="token function">unsubscribeDataChanges</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beforePath<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// é‡å…¥çš„é‡Šæ”¾é”å¤„ç†</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reentrantCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reentrantCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>reentrantCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token operator">--</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>reentrantCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// åˆ é™¤èŠ‚ç‚¹</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentPath<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// TODO Auto-generated method stub</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> TimeUnit unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// TODO Auto-generated method stub</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Condition <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// TODO Auto-generated method stub</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¹¶å‘æ•°</span>        <span class="token keyword">int</span> currency <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¾ªç¯å±éšœ</span>        CyclicBarrier cb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span>currency<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¤šçº¿ç¨‹æ¨¡æ‹Ÿé«˜å¹¶å‘</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> currency<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"---------æˆ‘å‡†å¤‡å¥½---------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// ç­‰å¾…ä¸€èµ·å‡ºå‘</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        cb<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> BrokenBarrierException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    ZKDistributeImproveLock lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZKDistributeImproveLock</span><span class="token punctuation">(</span><span class="token string">"/distLock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" è·å¾—é”ï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸ºäº†é˜²æ­¢åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤šä¸ªè¿›ç¨‹ä¹‹é—´ç›¸äº’å¹²æ‰°ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§åˆ†å¸ƒå¼åè°ƒæŠ€æœ¯æ¥å¯¹è¿™äº›è¿›ç¨‹è¿›è¡Œè°ƒåº¦ã€‚è€Œè¿™ä¸ªåˆ†å¸ƒå¼åè°ƒæŠ€æœ¯çš„æ ¸å¿ƒå°±æ˜¯æ¥å®ç°è¿™ä¸ªåˆ†å¸ƒå¼é”ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="åˆ†å¸ƒå¼" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="å¾®æœåŠ¡" scheme="https://brokge.github.io/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
      <category term="Java" scheme="https://brokge.github.io/tags/Java/"/>
    
      <category term="é”" scheme="https://brokge.github.io/tags/%E9%94%81/"/>
    
  </entry>
  
  <entry>
    <title>Python ç–«è‹—çˆ¬è™«è„šæœ¬</title>
    <link href="https://brokge.github.io/2020/08/12/Python-%E7%96%AB%E8%8B%97%E7%88%AC%E8%99%AB%E8%84%9A%E6%9C%AC/"/>
    <id>https://brokge.github.io/2020/08/12/Python-ç–«è‹—çˆ¬è™«è„šæœ¬/</id>
    <published>2020-08-12T07:03:28.000Z</published>
    <updated>2020-08-21T04:52:03.076Z</updated>
    
    <content type="html"><![CDATA[<p>å…³äºç–«è‹—çš„pythonçˆ¬è™«è„šæœ¬ï¼Œä¸»è¦çˆ¬æ–°åç½‘ã€‚</p><a id="more"></a><p>æºç åœ°å€æŸ¥çœ‹ </p><p><a href="https://github.com/brokge/vaccine-scrapy">Github brokge  / vaccine-scrapy</a></p><h1 id="1-éœ€è¦ç¯å¢ƒ"><a href="#1-éœ€è¦ç¯å¢ƒ" class="headerlink" title="1. éœ€è¦ç¯å¢ƒ"></a>1. éœ€è¦ç¯å¢ƒ</h1><ul><li>python 3.5.2</li><li>scrapy 1.5.2</li><li>conda 4.6.11 æˆ–è€… pip3</li><li>pycryptodome </li><li>pymysql</li></ul><p>å¦‚æœç¢°åˆ° å…¼å®¹æ€§é—®é¢˜<br>æœ€å¥½çš„æ–¹å¼ï¼Œæ˜¯é€šè¿‡ conda å®‰è£…æ‰€éœ€è¦çš„ç¯å¢ƒå˜é‡ï¼Œè®°å¾—å®‰è£…ä¹‹åé‡å¯ä¸‹ç³»ç»Ÿ</p><pre class="line-numbers language-sh"><code class="language-sh">conda install -c conda-forge scrapy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ pip3 æ¥å®‰è£…</p><pre class="line-numbers language-sh"><code class="language-sh">pip3 --default-timeout=100 install scrapy pip3 install pycryptodomepip3 install pymysql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="2-è¿è¡Œ"><a href="#2-è¿è¡Œ" class="headerlink" title="2. è¿è¡Œ"></a>2. è¿è¡Œ</h1><pre class="line-numbers language-sh"><code class="language-sh">scrapy crawl spiderNews  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="3-æ–‡ä»¶ç›®å½•è¯´æ˜"><a href="#3-æ–‡ä»¶ç›®å½•è¯´æ˜" class="headerlink" title="3. æ–‡ä»¶ç›®å½•è¯´æ˜"></a>3. æ–‡ä»¶ç›®å½•è¯´æ˜</h1><p>é€šè¿‡ tree å‘½ä»¤æŸ¥çœ‹ç›®å½•ç»“æ„</p><pre><code>.â”€â”€ README.mdâ”œâ”€â”€ scrapy.cfgâ””â”€â”€ vaccine    â”œâ”€â”€ README.md    â”œâ”€â”€ __init__.py    â”œâ”€â”€ __pycache__    â”‚   â”œâ”€â”€ __init__.cpython-37.pyc    â”‚   â”œâ”€â”€ items.cpython-37.pyc    â”‚   â”œâ”€â”€ pipelines.cpython-37.pyc    â”‚   â””â”€â”€ settings.cpython-37.pyc    â”œâ”€â”€ dbsql.sql    â”œâ”€â”€ items.py    â”œâ”€â”€ middlewares.py    â”œâ”€â”€ pipelines.py    â”œâ”€â”€ settings.py    â”œâ”€â”€ spiders    â”‚   â”œâ”€â”€ VaccineNewsSpider.py    â”‚   â”œâ”€â”€ __init__.py    â”‚   â””â”€â”€ __pycache__    â”‚       â”œâ”€â”€ VaccineNewsSpider.cpython-37.pyc    â”‚       â””â”€â”€ __init__.cpython-37.pyc    â””â”€â”€ vaccine_name.txt</code></pre><ul><li><p>dbsql.sql â€”æ•°æ®è¡¨ç»“æ„è„šæœ¬</p></li><li><p>vaccine_name.txt â€”éœ€è¦æŸ¥è¯¢çš„å…³é”®å­—é…ç½®æ–‡ä»¶</p></li><li><p>VaccineNewsSpider.py â€” çˆ¬è™«æ‰§è¡Œæ–‡ä»¶</p></li><li><p>pipelines.py â€” é…ç½® é€šé“çš„ä½ç½®ï¼Œæ ¹æ®è‡ªå·±æƒ…å†µè°ƒæ•´</p><pre class="line-numbers language-python"><code class="language-python"> <span class="token comment" spellcheck="true"># é“¾æ¥æ•°æ®çš„é…ç½®</span> self<span class="token punctuation">.</span>connect <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>      <span class="token comment" spellcheck="true"># æ•°æ®åº“åœ°å€</span>      host<span class="token operator">=</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>      port<span class="token operator">=</span><span class="token number">3306</span><span class="token punctuation">,</span>      db<span class="token operator">=</span><span class="token string">"dbcontent"</span><span class="token punctuation">,</span>      user<span class="token operator">=</span><span class="token string">'yusuzi'</span><span class="token punctuation">,</span>      passwd<span class="token operator">=</span><span class="token string">'yusuzi'</span><span class="token punctuation">,</span>      charset<span class="token operator">=</span><span class="token string">'utf8'</span><span class="token punctuation">,</span>      use_unicode<span class="token operator">=</span><span class="token boolean">True</span>  <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h1 id="4-æ‰§è¡Œæ•ˆæœæˆªå›¾"><a href="#4-æ‰§è¡Œæ•ˆæœæˆªå›¾" class="headerlink" title="4. æ‰§è¡Œæ•ˆæœæˆªå›¾"></a>4. æ‰§è¡Œæ•ˆæœæˆªå›¾</h1><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/1FB53BAABFE04F15A20134805AE5BE2C.jpg" alt="image"></p><h1 id="5-æ ¸å¿ƒé€»è¾‘"><a href="#5-æ ¸å¿ƒé€»è¾‘" class="headerlink" title="5. æ ¸å¿ƒé€»è¾‘"></a>5. æ ¸å¿ƒé€»è¾‘</h1><p>åœ¨  VaccineNewsSpider.py æ–‡ä»¶ä¸­ï¼Œä¸»è¦é€»è¾‘æµç¨‹å¦‚ä¸‹</p><ol><li>æ„é€  urlè¯·æ±‚åœ°å€ï¼Œ</li><li>å¡«å…… å…³é”®å­—</li><li>è¯·æ±‚ url</li><li>è§£æ è¿”å›æ•°æ®</li><li>æ ¹æ®è¯·æ±‚url ç”Ÿæˆ md5 å»é‡ã€‚</li><li>å†™å…¥æ•°æ®å“­ã€‚</li></ol><h2 id="5-1-æ„é€ è¯·æ±‚å¹¶è§£æè¿”å›æ•°æ®"><a href="#5-1-æ„é€ è¯·æ±‚å¹¶è§£æè¿”å›æ•°æ®" class="headerlink" title="5.1 æ„é€ è¯·æ±‚å¹¶è§£æè¿”å›æ•°æ®"></a>5.1 æ„é€ è¯·æ±‚å¹¶è§£æè¿”å›æ•°æ®</h2><pre class="line-numbers language-py"><code class="language-py">class VaccineNewsSpider(scrapy.Spider):    name = "spiderNews"    url_format = "http://so.news.cn/getNews?keyword=%s&curPage=%s&sortField=0&searchFields=1&lang=cn"    def start_requests(self):        keywords = set()        try:            f = open('vaccine/vaccine_name.txt', 'r')            for line in f.readlines():                line = line.strip('\n')  # å»é™¤æ¢è¡Œç¬¦å·                keywords.add(line)        finally:            if f:                f.close()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>url_format: æ ¹æ®è‡ªå·±ä¸åŒçš„ç›®æ ‡ç½‘å€ï¼Œè¿›è¡Œæ„é€ è¯·æ±‚url</p><pre class="line-numbers language-py"><code class="language-py"> def parse_json(self, response):        print("aa")        print(response.body)        newJson = json.loads(response.body)         print(newJson['code'])        newContent = newJson['content']        results = newContent['results']        pageSize = newContent['pageCount']        curPage = newContent['curPage']        keyWord = newContent['keyword']        newSets = set()        for result in results:            url = result['url']            if 'm.xinhuanet.com' in url and result['des']:                html_remove = re.compile(r'<[^>]+>', re.S)  # æ„å»ºåŒ¹é…æ¨¡å¼                # dd = dr.sub('', string) # å»é™¤htmlæ ‡ç­¾                title = html_remove.sub('', result['title'])                print("title"+title)                vaccineNewsItem = VaccineNewsItem()                vaccineNewsItem['title'] = title.lstrip()                vaccineNewsItem['from_url'] = url                # result['sitename']                vaccineNewsItem['from_source'] = 'æ–°åç½‘'                vaccineNewsItem['summary'] = result['des'].lstrip()                vaccineNewsItem['create_date'] = result['pubtime']                vaccineNewsItem['md5'] = self.md5_str(str=title)                vaccineNewsItem['keyword'] = keyWord                newSets.add(vaccineNewsItem)                yield vaccineNewsItem        if curPage < pageSize:            curPage = curPage+1            url = self.url_format % (keyWord, curPage)            print(url)            yield scrapy.Request(url, callback=self.parse_json)    def md5_str(self, str):        m = MD5.new()        m.update(str.encode("utf-8"))        return m.hexdigest()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»¥ä¸Šä»£ç ä¸ºè¯·æ±‚ url å¹¶è§£æè¯·æ±‚æ•°æ®ã€‚</p><h2 id="5-2-å†™å…¥æ•°æ®åº“"><a href="#5-2-å†™å…¥æ•°æ®åº“" class="headerlink" title="5.2 å†™å…¥æ•°æ®åº“"></a>5.2 å†™å…¥æ•°æ®åº“</h2><p>é¦–å…ˆï¼šVaccinePipeline.py ä¸­é…ç½®é€šé“ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚æ•°æ®åº“é“¾æ¥é…ç½®ï¼Œæ•°æ®å®ä½“æ˜ å°„é…ç½®ï¼Œæ’å…¥æ•°æ®æ‰§è¡Œsqlé…ç½®ç­‰ã€‚</p><p>å…¶æ¬¡ï¼šsetting.py ä¸­ æ¿€æ´»é€šé“ï¼Œå¹¶é…ç½®ä¼˜å…ˆçº§</p><pre class="line-numbers language-py"><code class="language-py">ITEM_PIPELINES = {    'vaccine.pipelines.MySQLPipeLine': 300, }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ä»¥ä¸ŠåŸºæœ¬å°±å¯ä»¥è·‘èµ·æ¥äº†ã€‚è¿è¡Œä¸­æœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åé¦ˆã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å…³äºç–«è‹—çš„pythonçˆ¬è™«è„šæœ¬ï¼Œä¸»è¦çˆ¬æ–°åç½‘ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="å·¥å…·" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="python" scheme="https://brokge.github.io/tags/python/"/>
    
      <category term="çˆ¬è™«" scheme="https://brokge.github.io/tags/%E7%88%AC%E8%99%AB/"/>
    
  </entry>
  
  <entry>
    <title>Mysql explainè¯¦è§£å’Œæœ€ä½³å®è·µ</title>
    <link href="https://brokge.github.io/2020/08/05/Mysql-explain%E8%AF%A6%E8%A7%A3%E5%92%8C%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"/>
    <id>https://brokge.github.io/2020/08/05/Mysql-explainè¯¦è§£å’Œæœ€ä½³å®è·µ/</id>
    <published>2020-08-05T15:40:00.000Z</published>
    <updated>2020-08-21T04:56:19.793Z</updated>
    
    <content type="html"><![CDATA[<p>ä½¿ç”¨EXPLAINå…³é”®å­—å¯ä»¥æ¨¡æ‹Ÿä¼˜åŒ–å™¨æ‰§è¡ŒSQLè¯­å¥ï¼Œä»è€ŒçŸ¥é“MySQLæ˜¯ å¦‚ä½•å¤„ç†ä½ çš„SQLè¯­å¥çš„ã€‚åˆ†æä½ çš„æŸ¥è¯¢è¯­å¥æˆ–æ˜¯ç»“æ„çš„æ€§èƒ½ç“¶é¢ˆã€‚</p><a id="more"></a><p>åœ¨ select è¯­å¥ä¹‹å‰å¢åŠ  explain å…³é”®å­—ï¼ŒMySQL ä¼šåœ¨æŸ¥è¯¢ä¸Šè®¾ç½®ä¸€ä¸ªæ ‡è®°ï¼Œæ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œä¼šè¿”å›æ‰§è¡Œè®¡åˆ’çš„ä¿¡æ¯ï¼Œè€Œä¸æ˜¯æ‰§è¡Œè¿™æ¡SQLï¼ˆå¦‚æœ from ä¸­åŒ…å«å­æŸ¥è¯¢ï¼Œä»ä¼šæ‰§è¡Œè¯¥å­æŸ¥è¯¢ï¼Œå°†ç»“æœæ”¾å…¥ä¸´æ—¶è¡¨ä¸­ï¼‰</p><h1 id="å»ºè¡¨"><a href="#å»ºè¡¨" class="headerlink" title="å»ºè¡¨"></a>å»ºè¡¨</h1><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>actor<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>actor<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>actor<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'2017-12-22 15:27:18'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'2017-12-22 15:27:18'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'2017-12-22 15:27:18'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>film<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>film<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_name<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>film<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'film0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'film1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'film2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>film_actor<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>film_actor<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>film_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>actor_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>remark<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_film_actor_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>film_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>actor_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>film_actor<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>film_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>actor_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Explain"><a href="#Explain" class="headerlink" title="Explain"></a>Explain</h1><pre class="line-numbers language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> actor<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/D15C58240983455DA0B494E89385F7EB.jpg" alt="image"></p><p>åœ¨æŸ¥è¯¢ä¸­çš„æ¯ä¸ªè¡¨ä¼šè¾“å‡ºä¸€è¡Œï¼Œå¦‚æœæœ‰ä¸¤ä¸ªè¡¨é€šè¿‡ join è¿æ¥æŸ¥è¯¢ï¼Œé‚£ä¹ˆä¼šè¾“å‡ºä¸¤è¡Œã€‚è¡¨çš„æ„ä¹‰ç›¸å½“å¹¿æ³›ï¼šå¯ä»¥æ˜¯å­æŸ¥è¯¢ã€ä¸€ä¸ª union ç»“æœç­‰ã€‚</p><h2 id="Explain-æœ‰ä¸¤ä¸ªå˜ç§ï¼š"><a href="#Explain-æœ‰ä¸¤ä¸ªå˜ç§ï¼š" class="headerlink" title="Explain æœ‰ä¸¤ä¸ªå˜ç§ï¼š"></a>Explain æœ‰ä¸¤ä¸ªå˜ç§ï¼š</h2><h3 id="1-explain-extendedï¼š"><a href="#1-explain-extendedï¼š" class="headerlink" title="1. explain extendedï¼š"></a>1. explain extendedï¼š</h3><p>ä¼šåœ¨ explain çš„åŸºç¡€ä¸Šé¢å¤–æä¾›ä¸€äº›æŸ¥è¯¢ä¼˜åŒ–çš„ä¿¡æ¯ã€‚ç´§éšå…¶åé€šè¿‡ show warnings å‘½ä»¤å¯ä»¥ å¾—åˆ°ä¼˜åŒ–åçš„æŸ¥è¯¢è¯­å¥ï¼Œä»è€Œçœ‹å‡ºä¼˜åŒ–å™¨ä¼˜åŒ–äº†ä»€ä¹ˆã€‚é¢å¤–è¿˜æœ‰ filtered åˆ—ï¼Œæ˜¯ä¸€ä¸ªåŠåˆ†æ¯”çš„å€¼ï¼Œrows * filtered/100 å¯ä»¥ä¼°ç®—å‡ºå°†è¦å’Œ explain ä¸­å‰ä¸€ä¸ªè¡¨è¿›è¡Œè¿æ¥çš„è¡Œæ•°ï¼ˆå‰ä¸€ä¸ªè¡¨æŒ‡ explain ä¸­çš„idå€¼æ¯”å½“å‰è¡¨idå€¼å°çš„è¡¨ï¼‰ã€‚</p><pre><code>mysql&gt; explain extended select * from film where id = 1;mysql&gt; show warnings; </code></pre><h3 id="2-explain-partitionsï¼š"><a href="#2-explain-partitionsï¼š" class="headerlink" title="2. explain partitionsï¼š"></a>2. explain partitionsï¼š</h3><p>ç›¸æ¯” explain å¤šäº†ä¸ª partitions å­—æ®µï¼Œå¦‚æœæŸ¥è¯¢æ˜¯åŸºäºåˆ†åŒºè¡¨çš„è¯ï¼Œä¼šæ˜¾ç¤ºæŸ¥è¯¢å°†è®¿é—®çš„åˆ†åŒºã€‚</p><h2 id="Explain-ä¸­åˆ—çš„å«ä¹‰"><a href="#Explain-ä¸­åˆ—çš„å«ä¹‰" class="headerlink" title="Explain ä¸­åˆ—çš„å«ä¹‰"></a>Explain ä¸­åˆ—çš„å«ä¹‰</h2><h3 id="Id-åˆ—"><a href="#Id-åˆ—" class="headerlink" title="Id åˆ—"></a>Id åˆ—</h3><p>idåˆ—çš„ç¼–å·æ˜¯ select çš„åºåˆ—å·ï¼Œæœ‰å‡ ä¸ª select å°±æœ‰å‡ ä¸ªidï¼Œå¹¶ä¸”idçš„é¡ºåºæ˜¯æŒ‰ select å‡ºç°çš„é¡ºåºå¢é•¿çš„ã€‚MySQLå°† select æŸ¥è¯¢åˆ†ä¸ºç®€å•æŸ¥è¯¢(SIMPLE)å’Œå¤æ‚æŸ¥è¯¢(PRIMARY)ã€‚<br>å¤æ‚æŸ¥è¯¢åˆ†ä¸ºä¸‰ç±»ï¼šç®€å•å­æŸ¥è¯¢ã€æ´¾ç”Ÿè¡¨ï¼ˆfromè¯­å¥ä¸­çš„å­æŸ¥è¯¢ï¼‰ã€union æŸ¥è¯¢ã€‚<br>idåˆ—è¶Šå¤§æ‰§è¡Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œidç›¸åŒåˆ™ä»ä¸Šå¾€ä¸‹æ‰§è¡Œï¼Œidä¸ºNULLæœ€åæ‰§è¡Œã€‚</p><ol><li>ç®€å•å­æŸ¥è¯¢</li></ol><pre><code>mysql&gt; explain select (select 1 from actor limit 1) from film;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/10898C201A834EB781EF7BC2C044A816.jpg" alt="image"></p><ol start="2"><li><p>fromå­å¥ä¸­çš„å­æŸ¥è¯¢</p><pre><code>mysql&gt; explain select id from (select id from film) as der; </code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/620B5A7572DA4F409C5E211D4836F389.jpg" alt="image"><br>è¿™ä¸ªæŸ¥è¯¢æ‰§è¡Œæ—¶æœ‰ä¸ªä¸´æ—¶è¡¨åˆ«åä¸ºderï¼Œå¤–éƒ¨ select æŸ¥è¯¢å¼•ç”¨äº†è¿™ä¸ªä¸´æ—¶è¡¨.</p></li><li><p>unionæŸ¥è¯¢</p><pre><code>mysql&gt; explain select 1 union all select 1;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/7B675D2DD4434EA3BDB670265D0F1548.jpg" alt="image"><br>unionç»“æœæ€»æ˜¯æ”¾åœ¨ä¸€ä¸ªåŒ¿åä¸´æ—¶è¡¨ä¸­ï¼Œä¸´æ—¶è¡¨ä¸åœ¨SQLä¸­å‡ºç°ï¼Œå› æ­¤å®ƒçš„ id æ˜¯ NULLã€‚</p></li></ol><h3 id="select-typeåˆ—"><a href="#select-typeåˆ—" class="headerlink" title="select_typeåˆ—"></a>select_typeåˆ—</h3><p>select_type è¡¨ç¤ºå¯¹åº”è¡Œæ˜¯ç®€å•è¿˜æ˜¯å¤æ‚çš„æŸ¥è¯¢ï¼Œå¦‚æœæ˜¯å¤æ‚çš„æŸ¥è¯¢ï¼Œåˆæ˜¯ä¸Šè¿°ä¸‰ç§å¤æ‚æŸ¥è¯¢ä¸­çš„å“ªä¸€ç§ã€‚</p><ol><li>simpleï¼šç®€å•æŸ¥è¯¢ã€‚æŸ¥è¯¢ä¸åŒ…å«å­æŸ¥è¯¢å’Œunion</li></ol><pre><code>mysql&gt; explain select * from film where id = 2;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/A4615C5FE4434BE395226791172C471E.jpg" alt="image"></p><ol start="2"><li><p>primaryï¼šå¤æ‚æŸ¥è¯¢ä¸­æœ€å¤–å±‚çš„ select</p></li><li><p>subqueryï¼šåŒ…å«åœ¨ select ä¸­çš„å­æŸ¥è¯¢ï¼ˆä¸åœ¨ from å­å¥ä¸­ï¼‰</p></li><li><p>derivedï¼šåŒ…å«åœ¨ from å­å¥ä¸­çš„å­æŸ¥è¯¢ã€‚MySQLä¼šå°†ç»“æœå­˜æ”¾åœ¨ä¸€ä¸ªä¸´æ—¶è¡¨ä¸­ï¼Œä¹Ÿç§°ä¸ºæ´¾ç”Ÿè¡¨ï¼ˆderivedçš„è‹±æ–‡å«ä¹‰ï¼‰<br>ç”¨è¿™ä¸ªä¾‹å­æ¥äº†è§£ primaryã€subquery å’Œ derived ç±»å‹</p><pre><code>mysql&gt; explain select (select 1 from actor where id = 1) from (select * from film where id = 1) der;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/D6B2A80FE48448A98839C65F70657084.jpg" alt="image"></p></li><li><p>unionï¼šåœ¨ union ä¸­çš„ç¬¬äºŒä¸ªå’Œéšåçš„ select</p></li><li><p>union resultï¼šä» union ä¸´æ—¶è¡¨æ£€ç´¢ç»“æœçš„ select<br>ç”¨è¿™ä¸ªä¾‹å­æ¥äº†è§£ union å’Œ union result ç±»å‹ï¼š</p><pre><code>mysql&gt; explain select 1 union all select 1;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/99B591DAED3E420B8567C9FDCD1715EE.jpg" alt="image"></p></li></ol><h3 id="table-åˆ—"><a href="#table-åˆ—" class="headerlink" title="table åˆ—"></a>table åˆ—</h3><p>è¿™ä¸€åˆ—è¡¨ç¤º explain çš„ä¸€è¡Œæ­£åœ¨è®¿é—®å“ªä¸ªè¡¨ã€‚<br>å½“ from å­å¥ä¸­æœ‰å­æŸ¥è¯¢æ—¶ï¼Œtable åˆ—æ˜¯ <derivenN> æ ¼å¼ï¼Œè¡¨ç¤ºå½“å‰æŸ¥è¯¢ä¾èµ– id=N çš„æŸ¥è¯¢ï¼Œäºæ˜¯å…ˆæ‰§è¡Œ id=N çš„æŸ¥è¯¢ã€‚<br>å½“æœ‰ union æ—¶ï¼ŒUNION RESULT çš„ table åˆ—çš„å€¼ä¸º&lt;union1,2&gt;ï¼Œ1å’Œ2è¡¨ç¤ºå‚ä¸ union çš„ select è¡Œ idã€‚</p><h3 id="typeåˆ—"><a href="#typeåˆ—" class="headerlink" title="typeåˆ—"></a>typeåˆ—</h3><p>è¿™ä¸€åˆ—è¡¨ç¤ºå…³è”ç±»å‹æˆ–è®¿é—®ç±»å‹ï¼Œå³MySQLå†³å®šå¦‚ä½•æŸ¥æ‰¾è¡¨ä¸­çš„è¡Œï¼ŒæŸ¥æ‰¾æ•°æ®è¡Œè®°å½•çš„å¤§æ¦‚èŒƒå›´ã€‚<br>ä¾æ¬¡ä»æœ€ä¼˜åˆ°æœ€å·®åˆ†åˆ«ä¸ºï¼šsystem &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL<br>ä¸€èˆ¬æ¥è¯´ï¼Œå¾—ä¿è¯æŸ¥è¯¢è¾¾åˆ°rangeçº§åˆ«ï¼Œæœ€å¥½è¾¾åˆ°ref.</p><p><strong>NULL</strong>ï¼šmysqlèƒ½å¤Ÿåœ¨ä¼˜åŒ–é˜¶æ®µåˆ†è§£æŸ¥è¯¢è¯­å¥ï¼Œåœ¨æ‰§è¡Œé˜¶æ®µç”¨ä¸ç€å†è®¿é—®è¡¨æˆ–ç´¢å¼•ã€‚ä¾‹å¦‚ï¼šåœ¨ç´¢å¼•åˆ—ä¸­é€‰å–æœ€å°å€¼ï¼Œå¯ä»¥å•ç‹¬æŸ¥æ‰¾ç´¢å¼•æ¥å®Œæˆï¼Œä¸éœ€è¦åœ¨æ‰§è¡Œæ—¶è®¿é—®è¡¨.</p><pre><code>mysql&gt; explain select min(id) from film; </code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/99A7592E5BF04B44B13C011C202A4F42.jpg" alt="image"></p><p><strong>const, system</strong>ï¼šmysqlèƒ½å¯¹æŸ¥è¯¢çš„æŸéƒ¨åˆ†è¿›è¡Œä¼˜åŒ–å¹¶å°†å…¶è½¬åŒ–æˆä¸€ä¸ªå¸¸é‡ï¼ˆå¯ä»¥çœ‹show warnings çš„ç»“æœï¼‰ã€‚ç”¨äº primary key æˆ– unique key çš„æ‰€æœ‰åˆ—ä¸å¸¸æ•°æ¯”è¾ƒæ—¶ï¼Œæ‰€ä»¥è¡¨æœ€å¤šæœ‰ä¸€ä¸ªåŒ¹é…è¡Œï¼Œè¯»å–1æ¬¡ï¼Œé€Ÿåº¦æ¯”è¾ƒå¿«ã€‚systemæ˜¯constçš„ç‰¹ä¾‹ï¼Œè¡¨é‡Œåªæœ‰ä¸€æ¡å…ƒç»„åŒ¹é…æ—¶ä¸ºsystem</p><pre><code>mysql&gt; explain extended select * from (select * from film where id = 1) tmp;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/B0008777242C4F9DB30CE6481DD6321F.jpg" alt="image"></p><pre><code>mysql&gt; show warnings; </code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/8F7B3AA78C9D4D658052DFDC4EAB5395.jpg" alt="image"></p><p><strong>eq_ref</strong>ï¼šprimary key æˆ– unique key ç´¢å¼•çš„æ‰€æœ‰éƒ¨åˆ†è¢«è¿æ¥ä½¿ç”¨ ï¼Œæœ€å¤šåªä¼šè¿”å›ä¸€æ¡ç¬¦åˆæ¡ä»¶çš„è®°å½•ã€‚è¿™å¯èƒ½æ˜¯åœ¨ const ä¹‹å¤–æœ€å¥½çš„è”æ¥ç±»å‹äº†ï¼Œç®€å•çš„ select æŸ¥è¯¢ä¸ä¼šå‡ºç°è¿™ç§ typeã€‚</p><pre><code>mysql&gt; explain select * from film_actor left join film on film_actor.film_id = film.id; </code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/FA04A7F60F9B44FAB02D7F2EB39C83EF.jpg" alt="image"></p><p><strong>ref</strong>ï¼šç›¸æ¯” eq_refï¼Œä¸ä½¿ç”¨å”¯ä¸€ç´¢å¼•ï¼Œè€Œæ˜¯ä½¿ç”¨æ™®é€šç´¢å¼•æˆ–è€…å”¯ä¸€æ€§ç´¢å¼•çš„éƒ¨åˆ†å‰ç¼€ï¼Œç´¢å¼•è¦å’ŒæŸä¸ªå€¼ç›¸æ¯”è¾ƒï¼Œå¯èƒ½ä¼šæ‰¾åˆ°å¤šä¸ªç¬¦åˆæ¡ä»¶çš„è¡Œã€‚</p><ol><li><p>ç®€å• select æŸ¥è¯¢ï¼Œnameæ˜¯æ™®é€šç´¢å¼•ï¼ˆéå”¯ä¸€ç´¢å¼•ï¼‰ </p><pre><code>mysql&gt; explain select * from film where name = &quot;film1&quot;; </code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/0C68CC0AA000435EA7DEBB1F2C3F3951.jpg" alt="image"></p></li><li><p>å…³è”è¡¨æŸ¥è¯¢ï¼Œidx_film_actor_idæ˜¯film_idå’Œactor_idçš„è”åˆç´¢å¼•ï¼Œè¿™é‡Œä½¿ç”¨åˆ°äº†film_actorçš„å·¦è¾¹å‰ç¼€film_idéƒ¨åˆ†ã€‚ </p><pre><code>mysql&gt; explain select film_id from film left join film_actor on film.id = film_actor.film_id; </code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/7CBD03DB6EB8436186FD10E0151B8C5D.jpg" alt="image"></p></li></ol><p><strong>range</strong>ï¼šèŒƒå›´æ‰«æé€šå¸¸å‡ºç°åœ¨ in(), between ,&gt; ,&lt;, &gt;= ç­‰æ“ä½œä¸­ã€‚ä½¿ç”¨ä¸€ä¸ªç´¢å¼•æ¥æ£€ç´¢ç»™å®šèŒƒå›´çš„è¡Œã€‚</p><pre><code>mysql&gt; explain select * from actor where id &gt; 1;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/FCE44E2B4262490F8088E4FDCFCBD308.jpg" alt="image"></p><p><strong>index</strong>ï¼šæ‰«æå…¨è¡¨ç´¢å¼•ï¼Œè¿™é€šå¸¸æ¯”ALLå¿«ä¸€äº›ã€‚ï¼ˆindexæ˜¯ä»ç´¢å¼•ä¸­è¯»å–çš„ï¼Œè€Œallæ˜¯ä»ç¡¬ç›˜ä¸­è¯»å–ï¼‰</p><pre><code>mysql&gt; explain select * from film; </code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/03CC238786AE4E489ED2170F2D6BEE26.jpg" alt="image"><br><strong>ALL</strong>ï¼šå³å…¨è¡¨æ‰«æï¼Œæ„å‘³ç€mysqléœ€è¦ä»å¤´åˆ°å°¾å»æŸ¥æ‰¾æ‰€éœ€è¦çš„è¡Œã€‚é€šå¸¸æƒ…å†µä¸‹è¿™éœ€è¦å¢åŠ ç´¢å¼•æ¥è¿›è¡Œä¼˜åŒ–äº†</p><pre><code>mysql&gt; explain select * from actor; </code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/8369B9614FDA438BAB8F24CC964439A7.jpg" alt="image"></p><h3 id="possible-keysåˆ—"><a href="#possible-keysåˆ—" class="headerlink" title="possible_keysåˆ—"></a>possible_keysåˆ—</h3><p>è¿™ä¸€åˆ—æ˜¾ç¤ºæŸ¥è¯¢å¯èƒ½ä½¿ç”¨å“ªäº›ç´¢å¼•æ¥æŸ¥æ‰¾ã€‚<br>explain æ—¶å¯èƒ½å‡ºç° possible_keys æœ‰åˆ—ï¼Œè€Œ key æ˜¾ç¤º NULL çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µæ˜¯å› ä¸ºè¡¨ä¸­æ•°æ®ä¸å¤šï¼Œmysqlè®¤ä¸ºç´¢å¼•å¯¹æ­¤æŸ¥è¯¢å¸®åŠ©ä¸å¤§ï¼Œé€‰æ‹©äº†å…¨è¡¨æŸ¥è¯¢ã€‚<br>å¦‚æœè¯¥åˆ—æ˜¯NULLï¼Œåˆ™æ²¡æœ‰ç›¸å…³çš„ç´¢å¼•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡æ£€æŸ¥ where å­å¥çœ‹æ˜¯å¦å¯ä»¥åˆ›é€ ä¸€ä¸ªé€‚å½“çš„ç´¢å¼•æ¥æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œç„¶åç”¨ explain æŸ¥çœ‹æ•ˆæœã€‚ </p><ul><li>keyåˆ—</li></ul><p>è¿™ä¸€åˆ—æ˜¾ç¤ºmysqlå®é™…é‡‡ç”¨å“ªä¸ªç´¢å¼•æ¥ä¼˜åŒ–å¯¹è¯¥è¡¨çš„è®¿é—®ã€‚<br>å¦‚æœæ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼Œåˆ™è¯¥åˆ—æ˜¯ NULLã€‚å¦‚æœæƒ³å¼ºåˆ¶mysqlä½¿ç”¨æˆ–å¿½è§†possible_keysåˆ—ä¸­çš„ç´¢å¼•ï¼Œåœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨ force indexã€ignore indexã€‚</p><ul><li>key_lenåˆ—</li></ul><p>è¿™ä¸€åˆ—æ˜¾ç¤ºäº†mysqlåœ¨ç´¢å¼•é‡Œä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œé€šè¿‡è¿™ä¸ªå€¼å¯ä»¥ç®—å‡ºå…·ä½“ä½¿ç”¨äº†ç´¢å¼•ä¸­çš„å“ªäº›åˆ—ã€‚<br>ä¸¾ä¾‹æ¥è¯´ï¼Œfilm_actorçš„è”åˆç´¢å¼• idx_film_actor_id ç”± film_id å’Œ actor_id ä¸¤ä¸ªintåˆ—ç»„æˆï¼Œå¹¶ä¸”æ¯ä¸ªintæ˜¯4å­—èŠ‚ã€‚é€šè¿‡ç»“æœä¸­çš„key_len=4å¯æ¨æ–­å‡ºæŸ¥è¯¢ä½¿ç”¨äº†ç¬¬ä¸€ä¸ªåˆ—ï¼šfilm_idåˆ—æ¥æ‰§è¡Œç´¢å¼•æŸ¥æ‰¾ã€‚</p><pre><code>mysql&gt; explain select * from film_actor where film_id = 2;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/7849D860315B4AB6AB4FA6DF036E3B5D.jpg" alt="image"></p><blockquote><p>key_lenè®¡ç®—è§„åˆ™å¦‚ä¸‹ï¼š<br>å­—ç¬¦ä¸²<br>char(n)ï¼šnå­—èŠ‚é•¿åº¦<br>varchar(n)ï¼š2å­—èŠ‚å­˜å‚¨å­—ç¬¦ä¸²é•¿åº¦ï¼Œå¦‚æœæ˜¯utf-8ï¼Œåˆ™é•¿åº¦ 3n + 2</p><p>æ•°å€¼ç±»å‹:tinyintï¼š1å­—èŠ‚  smallintï¼š2å­—èŠ‚ intï¼š4å­—èŠ‚<br>bigintï¼š8å­—èŠ‚ã€€ã€€</p><p>æ—¶é—´ç±»å‹ã€€<br>dateï¼š3å­—èŠ‚<br>timestampï¼š4å­—èŠ‚<br>datetimeï¼š8å­—èŠ‚</p><p>å¦‚æœå­—æ®µå…è®¸ä¸º NULLï¼Œéœ€è¦1å­—èŠ‚è®°å½•æ˜¯å¦ä¸º NULL</p></blockquote><p>ç´¢å¼•æœ€å¤§é•¿åº¦æ˜¯768å­—èŠ‚ï¼Œå½“å­—ç¬¦ä¸²è¿‡é•¿æ—¶ï¼Œmysqlä¼šåšä¸€ä¸ªç±»ä¼¼å·¦å‰ç¼€ç´¢å¼•çš„å¤„ç†ï¼Œå°†å‰åŠéƒ¨åˆ†çš„å­—ç¬¦æå–å‡ºæ¥åšç´¢å¼•ã€‚</p><h3 id="refåˆ—"><a href="#refåˆ—" class="headerlink" title="refåˆ—"></a>refåˆ—</h3><p>è¿™ä¸€åˆ—æ˜¾ç¤ºäº†åœ¨keyåˆ—è®°å½•çš„ç´¢å¼•ä¸­ï¼Œè¡¨æŸ¥æ‰¾å€¼æ‰€ç”¨åˆ°çš„åˆ—æˆ–å¸¸é‡ï¼Œå¸¸è§çš„æœ‰ï¼šconstï¼ˆå¸¸é‡ï¼‰ï¼Œå­—æ®µåï¼ˆä¾‹ï¼šfilm.idï¼‰</p><h3 id="rowsåˆ—"><a href="#rowsåˆ—" class="headerlink" title="rowsåˆ—"></a>rowsåˆ—</h3><p>è¿™ä¸€åˆ—æ˜¯mysqlä¼°è®¡è¦è¯»å–å¹¶æ£€æµ‹çš„è¡Œæ•°ï¼Œæ³¨æ„è¿™ä¸ªä¸æ˜¯ç»“æœé›†é‡Œçš„è¡Œæ•°ã€‚</p><h3 id="Extraåˆ—"><a href="#Extraåˆ—" class="headerlink" title="Extraåˆ—"></a>Extraåˆ—</h3><p>è¿™ä¸€åˆ—å±•ç¤ºçš„æ˜¯é¢å¤–ä¿¡æ¯ã€‚å¸¸è§çš„é‡è¦å€¼å¦‚ä¸‹ï¼š</p><p><strong>Using index</strong>ï¼šæŸ¥è¯¢çš„åˆ—è¢«ç´¢å¼•è¦†ç›–ï¼Œå¹¶ä¸”whereç­›é€‰æ¡ä»¶æ˜¯ç´¢å¼•çš„å‰å¯¼åˆ—ï¼Œæ˜¯æ€§èƒ½é«˜çš„è¡¨ç°ã€‚ä¸€èˆ¬æ˜¯ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•(ç´¢å¼•åŒ…å«äº†æ‰€æœ‰æŸ¥è¯¢çš„å­—æ®µ)ã€‚å¯¹äºinnodbæ¥è¯´ï¼Œå¦‚æœæ˜¯è¾…åŠ©ç´¢å¼•æ€§èƒ½ä¼šæœ‰ä¸å°‘æé«˜</p><pre><code>mysql&gt; explain select film_id from film_actor where film_id = 1;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/5D3C7CA4BA7F46CB904D2C4B123BA39F.jpg" alt="image"></p><p><strong>Using where</strong>ï¼šæŸ¥è¯¢çš„åˆ—æœªè¢«ç´¢å¼•è¦†ç›–ï¼Œwhereç­›é€‰æ¡ä»¶éç´¢å¼•çš„å‰å¯¼åˆ—</p><pre><code>mysql&gt; explain select * from actor where name = &#39;a&#39;;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/10451AF8BC4E46E2B23058C4F8CA6B71.jpg" alt="image"></p><p><strong>Using where Using index</strong>ï¼šæŸ¥è¯¢çš„åˆ—è¢«ç´¢å¼•è¦†ç›–ï¼Œå¹¶ä¸”==whereç­›é€‰æ¡ä»¶æ˜¯ç´¢å¼•åˆ—ä¹‹ä¸€ä½†æ˜¯ä¸æ˜¯ç´¢å¼•çš„å‰å¯¼åˆ—==ï¼Œæ„å‘³ç€æ— æ³•ç›´æ¥é€šè¿‡ç´¢å¼•æŸ¥æ‰¾æ¥æŸ¥è¯¢åˆ°ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p><pre><code>mysql&gt; explain select film_id from film_actor where actor_id = 1;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/D79204ABDADC4803A8911BD6FFC54944.jpg" alt="image"></p><p><strong>NULL</strong>ï¼šæŸ¥è¯¢çš„åˆ—æœªè¢«ç´¢å¼•è¦†ç›–ï¼Œå¹¶ä¸”whereç­›é€‰æ¡ä»¶æ˜¯ç´¢å¼•çš„å‰å¯¼åˆ—ï¼Œæ„å‘³ç€ç”¨åˆ°äº†ç´¢å¼•ï¼Œä½†æ˜¯éƒ¨åˆ†å­—æ®µæœªè¢«ç´¢å¼•è¦†ç›–ï¼Œå¿…é¡»é€šè¿‡â€œå›è¡¨â€æ¥å®ç°ï¼Œä¸æ˜¯çº¯ç²¹åœ°ç”¨åˆ°äº†ç´¢å¼•ï¼Œä¹Ÿä¸æ˜¯å®Œå…¨æ²¡ç”¨åˆ°ç´¢å¼•</p><pre><code>mysql&gt;explain select * from film_actor where film_id = 1;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/4E85A87B5E07442F8F017E8F1AD43BB8.jpg" alt="image"></p><p><strong>Using index condition</strong>ï¼šä¸Using whereç±»ä¼¼ï¼ŒæŸ¥è¯¢çš„åˆ—ä¸å®Œå…¨è¢«ç´¢å¼•è¦†ç›–ï¼Œwhereæ¡ä»¶ä¸­æ˜¯ä¸€ä¸ªå‰å¯¼åˆ—çš„èŒƒå›´ï¼›</p><pre><code>mysql&gt; explain select * from film_actor where film_id &gt; 1;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/8310AC3EA8804936BB7BDADCDD15AFEC.jpg" alt="image"></p><p><strong>Using temporary</strong>ï¼šmysqléœ€è¦åˆ›å»ºä¸€å¼ ä¸´æ—¶è¡¨æ¥å¤„ç†æŸ¥è¯¢ã€‚å‡ºç°è¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯è¦è¿›è¡Œä¼˜åŒ–çš„ï¼Œé¦–å…ˆæ˜¯æƒ³åˆ°ç”¨ç´¢å¼•æ¥ä¼˜åŒ–ã€‚</p><ol><li><p>actor.name æ²¡æœ‰ç´¢å¼•ï¼Œæ­¤æ—¶åˆ›å»ºäº†å¼ ä¸´æ—¶è¡¨æ¥ distinct </p><pre><code>mysql&gt; explain select distinct name from actor; </code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/6701658087B1421EB24F3EE7F066189B.jpg" alt="image"></p></li><li><p>film.name å»ºç«‹äº†idx_nameç´¢å¼•ï¼Œæ­¤æ—¶æŸ¥è¯¢æ—¶extraæ˜¯using index,æ²¡æœ‰ç”¨ä¸´æ—¶è¡¨ </p><pre><code>mysql&gt; explain select distinct name from film; </code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/8F30FFC5BE9446BE8CC4B829DD269406.jpg" alt="image"></p></li></ol><p><strong>Using filesort</strong>ï¼šmysql ä¼šå¯¹ç»“æœä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨ç´¢å¼•æ’åºï¼Œè€Œä¸æ˜¯æŒ‰ç´¢å¼•æ¬¡åºä»è¡¨é‡Œè¯»å–è¡Œã€‚æ­¤æ—¶mysqlä¼šæ ¹æ®è”æ¥ç±»å‹æµè§ˆæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•ï¼Œå¹¶ä¿å­˜æ’åºå…³é”®å­—å’Œè¡ŒæŒ‡é’ˆï¼Œç„¶åæ’åºå…³é”®å­—å¹¶æŒ‰é¡ºåºæ£€ç´¢è¡Œä¿¡æ¯ã€‚è¿™ç§æƒ…å†µä¸‹ä¸€èˆ¬ä¹Ÿæ˜¯è¦è€ƒè™‘ä½¿ç”¨ç´¢å¼•æ¥ä¼˜åŒ–çš„ã€‚</p><ol><li><p>actor.name æœªåˆ›å»ºç´¢å¼•ï¼Œä¼šæµè§ˆactoræ•´ä¸ªè¡¨ï¼Œä¿å­˜æ’åºå…³é”®å­—nameå’Œå¯¹åº”çš„idï¼Œç„¶åæ’åºnameå¹¶æ£€ç´¢è¡Œè®°å½• </p><pre><code>mysql&gt; explain select * from actor order by name;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/C7764DB5AF434C998B20C27CEEE8C7A4.jpg" alt="image"></p></li><li><p>film.name å»ºç«‹äº†idx_nameç´¢å¼•,æ­¤æ—¶æŸ¥è¯¢æ—¶extraæ˜¯using index</p><pre><code>mysql&gt; explain select * from film order by name; </code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/28DEB88B1D0D40A29B5E810BD9993F52.jpg" alt="image"></p></li></ol><h1 id="ç´¢å¼•æœ€ä½³å®è·µ"><a href="#ç´¢å¼•æœ€ä½³å®è·µ" class="headerlink" title="ç´¢å¼•æœ€ä½³å®è·µ"></a>ç´¢å¼•æœ€ä½³å®è·µ</h1><p>ä½¿ç”¨çš„è¡¨ï¼š</p><pre><code>CREATE TABLE `employees` (  `id` int(11) NOT NULL AUTO_INCREMENT,  `name` varchar(24) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;å§“å&#39;,  `age` int(11) NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;å¹´é¾„&#39;,  `position` varchar(20) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;èŒä½&#39;,  `hire_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;å…¥èŒæ—¶é—´&#39;,  PRIMARY KEY (`id`),  KEY `idx_name_age_position` (`name`,`age`,`position`) USING BTREE) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8 COMMENT=&#39;å‘˜å·¥è®°å½•è¡¨&#39;;INSERT INTO employees(name,age,position,hire_time) VALUES(&#39;LiLei&#39;,22,&#39;manager&#39;,NOW());INSERT INTO employees(name,age,position,hire_time) VALUES(&#39;HanMeimei&#39;, 23,&#39;dev&#39;,NOW());INSERT INTO employees(name,age,position,hire_time) VALUES(&#39;Lucy&#39;,23,&#39;dev&#39;,NOW());</code></pre><h2 id="æœ€ä½³å®è·µè§„åˆ™"><a href="#æœ€ä½³å®è·µè§„åˆ™" class="headerlink" title="æœ€ä½³å®è·µè§„åˆ™"></a>æœ€ä½³å®è·µè§„åˆ™</h2><h3 id="1-å…¨å€¼åŒ¹é…"><a href="#1-å…¨å€¼åŒ¹é…" class="headerlink" title="1. å…¨å€¼åŒ¹é…"></a>1. å…¨å€¼åŒ¹é…</h3><pre><code>EXPLAIN SELECT * FROM employees WHERE name= &#39;LiLei&#39;;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/A36DE3157FDD49C3B18EF1E7C3823328.jpg" alt="image"></p><pre><code>EXPLAIN SELECT * FROM employees WHERE name= &#39;LiLei&#39; AND age = 22;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/5D918054B73F4CD1BAEA459DB6880AF0.jpg" alt="image"></p><pre><code>EXPLAIN SELECT * FROM employees WHERE name= &#39;LiLei&#39; AND age = 22 AND position =&#39;manager&#39;;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/B78B7997D4DB407D85CAA1EED8C27828.jpg" alt="image"></p><h3 id="2-æœ€ä½³å·¦å‰ç¼€æ³•åˆ™"><a href="#2-æœ€ä½³å·¦å‰ç¼€æ³•åˆ™" class="headerlink" title="2. æœ€ä½³å·¦å‰ç¼€æ³•åˆ™"></a>2. æœ€ä½³å·¦å‰ç¼€æ³•åˆ™</h3><p>å¦‚æœç´¢å¼•äº†å¤šåˆ—ï¼Œè¦éµå®ˆæœ€å·¦å‰ç¼€æ³•åˆ™ã€‚æŒ‡çš„æ˜¯æŸ¥è¯¢ä»å¼•çš„æœ€å·¦å‰åˆ—å¼€å§‹å¹¶ä¸”ä¸è·³è¿‡ç´¢å¼•ä¸­çš„åˆ—ã€‚</p><pre><code>EXPLAIN SELECT * FROM employees WHERE age = 22 AND position =&#39;manager&#39;;EXPLAIN SELECT * FROM employees WHERE position = &#39;manager&#39;;EXPLAIN SELECT * FROM employees WHERE name = &#39;LiLei&#39;;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/AB5FAAFBB2B94D05BD5DDDEA5537A657.jpg" alt="image"></p><h3 id="3-ä¸åœ¨ç´¢å¼•åˆ—ä¸Šåšä»»ä½•æ“ä½œï¼ˆè®¡ç®—ã€å‡½æ•°ã€ï¼ˆè‡ªåŠ¨oræ‰‹åŠ¨ï¼‰ç±»å‹è½¬æ¢ï¼‰ï¼Œä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆè€Œè½¬å‘å…¨è¡¨æ‰«æ"><a href="#3-ä¸åœ¨ç´¢å¼•åˆ—ä¸Šåšä»»ä½•æ“ä½œï¼ˆè®¡ç®—ã€å‡½æ•°ã€ï¼ˆè‡ªåŠ¨oræ‰‹åŠ¨ï¼‰ç±»å‹è½¬æ¢ï¼‰ï¼Œä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆè€Œè½¬å‘å…¨è¡¨æ‰«æ" class="headerlink" title="3. ä¸åœ¨ç´¢å¼•åˆ—ä¸Šåšä»»ä½•æ“ä½œï¼ˆè®¡ç®—ã€å‡½æ•°ã€ï¼ˆè‡ªåŠ¨oræ‰‹åŠ¨ï¼‰ç±»å‹è½¬æ¢ï¼‰ï¼Œä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆè€Œè½¬å‘å…¨è¡¨æ‰«æ"></a>3. ä¸åœ¨ç´¢å¼•åˆ—ä¸Šåšä»»ä½•æ“ä½œï¼ˆè®¡ç®—ã€å‡½æ•°ã€ï¼ˆè‡ªåŠ¨oræ‰‹åŠ¨ï¼‰ç±»å‹è½¬æ¢ï¼‰ï¼Œä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆè€Œè½¬å‘å…¨è¡¨æ‰«æ</h3><pre><code>EXPLAIN SELECT * FROM employees WHERE name = &#39;LiLei&#39;;EXPLAIN SELECT * FROM employees WHERE left(name,3) = &#39;LiLei&#39;;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/220EB6D05CFD4BE287BC311AB11EE6D3.jpg" alt="image"></p><h3 id="4-å­˜å‚¨å¼•æ“ä¸èƒ½ä½¿ç”¨ç´¢å¼•ä¸­èŒƒå›´æ¡ä»¶å³è¾¹çš„åˆ—"><a href="#4-å­˜å‚¨å¼•æ“ä¸èƒ½ä½¿ç”¨ç´¢å¼•ä¸­èŒƒå›´æ¡ä»¶å³è¾¹çš„åˆ—" class="headerlink" title="4. å­˜å‚¨å¼•æ“ä¸èƒ½ä½¿ç”¨ç´¢å¼•ä¸­èŒƒå›´æ¡ä»¶å³è¾¹çš„åˆ—"></a>4. å­˜å‚¨å¼•æ“ä¸èƒ½ä½¿ç”¨ç´¢å¼•ä¸­èŒƒå›´æ¡ä»¶å³è¾¹çš„åˆ—</h3><pre><code>EXPLAIN SELECT * FROM employees WHERE name= &#39;LiLei&#39; AND age = 22 AND position =&#39;manager&#39;;EXPLAIN SELECT * FROM employees WHERE name= &#39;LiLei&#39; AND age &gt; 22 AND position =&#39;manager&#39;;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/03ACE575E6444B098A09431C06A51AF4.jpg" alt="image"></p><h3 id="5-å°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼ˆåªè®¿é—®ç´¢å¼•çš„æŸ¥è¯¢ï¼ˆç´¢å¼•åˆ—åŒ…å«æŸ¥è¯¢åˆ—ï¼‰ï¼‰ï¼Œå‡å°‘select-è¯­å¥"><a href="#5-å°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼ˆåªè®¿é—®ç´¢å¼•çš„æŸ¥è¯¢ï¼ˆç´¢å¼•åˆ—åŒ…å«æŸ¥è¯¢åˆ—ï¼‰ï¼‰ï¼Œå‡å°‘select-è¯­å¥" class="headerlink" title="5. å°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼ˆåªè®¿é—®ç´¢å¼•çš„æŸ¥è¯¢ï¼ˆç´¢å¼•åˆ—åŒ…å«æŸ¥è¯¢åˆ—ï¼‰ï¼‰ï¼Œå‡å°‘select *è¯­å¥"></a>5. å°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼ˆåªè®¿é—®ç´¢å¼•çš„æŸ¥è¯¢ï¼ˆç´¢å¼•åˆ—åŒ…å«æŸ¥è¯¢åˆ—ï¼‰ï¼‰ï¼Œå‡å°‘select *è¯­å¥</h3><pre><code>EXPLAIN SELECT name,age FROM employees WHERE name= &#39;LiLei&#39; AND age = 23 AND position =&#39;manager&#39;;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/52C76F3FA6AB46FF9D491DC5BC07B02E.jpg" alt="image"></p><pre><code>EXPLAIN SELECT * FROM employees WHERE name= &#39;LiLei&#39; AND age = 23 AND position =&#39;manager&#39;;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/93B9706742EE4B778FCCE0E73583236B.jpg" alt="image"></p><h3 id="6-mysqlåœ¨ä½¿ç”¨ä¸ç­‰äºï¼ˆï¼-æˆ–è€…-lt-gt-ï¼‰çš„æ—¶å€™æ— æ³•ä½¿ç”¨ç´¢å¼•ä¼šå¯¼è‡´å…¨è¡¨æ‰«æ"><a href="#6-mysqlåœ¨ä½¿ç”¨ä¸ç­‰äºï¼ˆï¼-æˆ–è€…-lt-gt-ï¼‰çš„æ—¶å€™æ— æ³•ä½¿ç”¨ç´¢å¼•ä¼šå¯¼è‡´å…¨è¡¨æ‰«æ" class="headerlink" title="6. mysqlåœ¨ä½¿ç”¨ä¸ç­‰äºï¼ˆï¼=æˆ–è€…&lt;&gt;ï¼‰çš„æ—¶å€™æ— æ³•ä½¿ç”¨ç´¢å¼•ä¼šå¯¼è‡´å…¨è¡¨æ‰«æ"></a>6. mysqlåœ¨ä½¿ç”¨ä¸ç­‰äºï¼ˆï¼=æˆ–è€…&lt;&gt;ï¼‰çš„æ—¶å€™æ— æ³•ä½¿ç”¨ç´¢å¼•ä¼šå¯¼è‡´å…¨è¡¨æ‰«æ</h3><pre><code>EXPLAIN SELECT * FROM employees WHERE name != &#39;LiLei&#39;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/801D61263E3E443298EDD09A4B568B98.jpg" alt="image"></p><h3 id="7-is-null-is-not-null-ä¹Ÿæ— æ³•ä½¿ç”¨ç´¢å¼•"><a href="#7-is-null-is-not-null-ä¹Ÿæ— æ³•ä½¿ç”¨ç´¢å¼•" class="headerlink" title="7. is null,is not null ä¹Ÿæ— æ³•ä½¿ç”¨ç´¢å¼•"></a>7. is null,is not null ä¹Ÿæ— æ³•ä½¿ç”¨ç´¢å¼•</h3><pre><code>EXPLAIN SELECT * FROM employees WHERE name is null</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/E6C01DD0BEBB4DD59FC9B6A321420066.jpg" alt="image"></p><h3 id="8-likeä»¥é€šé…ç¬¦å¼€å¤´ï¼ˆâ€™-abcâ€¦â€™ï¼‰mysqlç´¢å¼•å¤±æ•ˆä¼šå˜æˆå…¨è¡¨æ‰«ææ“ä½œ"><a href="#8-likeä»¥é€šé…ç¬¦å¼€å¤´ï¼ˆâ€™-abcâ€¦â€™ï¼‰mysqlç´¢å¼•å¤±æ•ˆä¼šå˜æˆå…¨è¡¨æ‰«ææ“ä½œ" class="headerlink" title="8. likeä»¥é€šé…ç¬¦å¼€å¤´ï¼ˆâ€™$abcâ€¦â€™ï¼‰mysqlç´¢å¼•å¤±æ•ˆä¼šå˜æˆå…¨è¡¨æ‰«ææ“ä½œ"></a>8. likeä»¥é€šé…ç¬¦å¼€å¤´ï¼ˆâ€™$abcâ€¦â€™ï¼‰mysqlç´¢å¼•å¤±æ•ˆä¼šå˜æˆå…¨è¡¨æ‰«ææ“ä½œ</h3><pre><code>EXPLAIN SELECT * FROM employees WHERE name like &#39;%Lei&#39;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/8069AB8749DF4F94A32B7A615097F406.jpg" alt="image"></p><pre><code>EXPLAIN SELECT * FROM employees WHERE name like &#39;Lei%&#39;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/86DD9D2FA50A491A9657C180B33C16B0.jpg" alt="image"></p><p><strong>é—®é¢˜ï¼šè§£å†³likeâ€™%å­—ç¬¦ä¸²%â€™ç´¢å¼•ä¸è¢«ä½¿ç”¨çš„æ–¹æ³•ï¼Ÿ</strong></p><p>a. ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼ŒæŸ¥è¯¢å­—æ®µå¿…é¡»æ˜¯å»ºç«‹è¦†ç›–ç´¢å¼•å­—æ®µ</p><pre><code>EXPLAIN SELECT name,age,position FROM employees WHERE name like &#39;%Lei%&#39;;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/FC9F82F3BF1C4C3D9F635737D8A52A80.jpg" alt="image"></p><p>b. å½“è¦†ç›–ç´¢å¼•æŒ‡å‘çš„å­—æ®µæ˜¯ varchar(380) åŠ 380 ä»¥ä¸Šçš„å­—æ®µæ—¶ï¼Œè¦†ç›–ç´¢å¼•ä¼šå¤±æ•ˆï¼</p><h3 id="9-å­—ç¬¦ä¸²ä¸åŠ å•å¼•å·ç´¢å¼•å¤±æ•ˆ"><a href="#9-å­—ç¬¦ä¸²ä¸åŠ å•å¼•å·ç´¢å¼•å¤±æ•ˆ" class="headerlink" title="9. å­—ç¬¦ä¸²ä¸åŠ å•å¼•å·ç´¢å¼•å¤±æ•ˆ"></a>9. å­—ç¬¦ä¸²ä¸åŠ å•å¼•å·ç´¢å¼•å¤±æ•ˆ</h3><pre><code>EXPLAIN SELECT * FROM employees WHERE name = &#39;1000&#39;;EXPLAIN SELECT * FROM employees WHERE name = 1000;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/7951BE0D3C83494680A5203437523D4B.jpg" alt="image"></p><h3 id="10-å°‘ç”¨or-ç”¨å®ƒè¿æ¥æ—¶å¾ˆå¤šæƒ…å†µä¸‹ç´¢å¼•ä¼šå¤±æ•ˆ"><a href="#10-å°‘ç”¨or-ç”¨å®ƒè¿æ¥æ—¶å¾ˆå¤šæƒ…å†µä¸‹ç´¢å¼•ä¼šå¤±æ•ˆ" class="headerlink" title="10. å°‘ç”¨or,ç”¨å®ƒè¿æ¥æ—¶å¾ˆå¤šæƒ…å†µä¸‹ç´¢å¼•ä¼šå¤±æ•ˆ"></a>10. å°‘ç”¨or,ç”¨å®ƒè¿æ¥æ—¶å¾ˆå¤šæƒ…å†µä¸‹ç´¢å¼•ä¼šå¤±æ•ˆ</h3><pre><code>EXPLAIN SELECT * FROM employees WHERE name = &#39;LiLei&#39; or name = &#39;HanMeimei&#39;;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/CB583B20AE814DB5A7B3C64DA63FF4DD.jpg" alt="image"></p><h2 id="å®è·µæ€»ç»“ï¼š"><a href="#å®è·µæ€»ç»“ï¼š" class="headerlink" title="å®è·µæ€»ç»“ï¼š"></a>å®è·µæ€»ç»“ï¼š</h2><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/E473DB8A1C0B4AB59A494790716A08AB.jpg" alt="image"></p><blockquote><p>like KK%ç›¸å½“äº=å¸¸é‡ï¼Œ%KKå’Œ%KK% ç›¸å½“äºèŒƒå›´</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä½¿ç”¨EXPLAINå…³é”®å­—å¯ä»¥æ¨¡æ‹Ÿä¼˜åŒ–å™¨æ‰§è¡ŒSQLè¯­å¥ï¼Œä»è€ŒçŸ¥é“MySQLæ˜¯ å¦‚ä½•å¤„ç†ä½ çš„SQLè¯­å¥çš„ã€‚åˆ†æä½ çš„æŸ¥è¯¢è¯­å¥æˆ–æ˜¯ç»“æ„çš„æ€§èƒ½ç“¶é¢ˆã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="æ•°æ®åº“" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="mysql" scheme="https://brokge.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£Mysqlç´¢å¼•åº•å±‚æ•°æ®ç»“æ„ä¸ç®—æ³•</title>
    <link href="https://brokge.github.io/2020/08/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Mysql%E7%B4%A2%E5%BC%95%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    <id>https://brokge.github.io/2020/08/05/æ·±å…¥ç†è§£Mysqlç´¢å¼•åº•å±‚æ•°æ®ç»“æ„ä¸ç®—æ³•/</id>
    <published>2020-08-05T15:38:26.000Z</published>
    <updated>2020-08-21T05:02:21.555Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€ç´¢å¼•ä¼˜åŒ–é¢è¯•é¢˜åˆ†æ"><a href="#ä¸€ã€ç´¢å¼•ä¼˜åŒ–é¢è¯•é¢˜åˆ†æ" class="headerlink" title="ä¸€ã€ç´¢å¼•ä¼˜åŒ–é¢è¯•é¢˜åˆ†æ"></a>ä¸€ã€ç´¢å¼•ä¼˜åŒ–é¢è¯•é¢˜åˆ†æ</h2><a id="more"></a><p>åˆ†æä»¥ä¸‹å‡ æ¡sqlçš„ç´¢å¼•ä½¿ç”¨æƒ…å†µ</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> titles <span class="token keyword">WHERE</span> emp_no<span class="token operator">=</span><span class="token string">'10001'</span> <span class="token operator">AND</span> title<span class="token operator">=</span><span class="token string">'Senior Engineer'</span> <span class="token operator">AND</span> from_date<span class="token operator">=</span><span class="token string">'1986-06-26'</span><span class="token punctuation">;</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> titles <span class="token keyword">WHERE</span> title<span class="token operator">=</span><span class="token string">'Senior Engineer'</span> <span class="token punctuation">;</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> titles <span class="token keyword">WHERE</span> emp_no <span class="token operator">></span> â€˜<span class="token number">10001</span><span class="token string">';SELECT * FROM titles WHERE emp_no > â€˜10001'</span> <span class="token operator">and</span> title<span class="token operator">=</span><span class="token string">'Senior Engineer'</span><span class="token punctuation">;</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> titles <span class="token keyword">WHERE</span> emp_no <span class="token operator">></span> â€˜<span class="token number">10001</span>' <span class="token keyword">order</span> <span class="token keyword">BY</span> title<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/56891307BDC64F33A02FBC942C108A50.jpg" alt="image"></p><h2 id="äºŒã€ç´¢å¼•åˆ°åº•æ˜¯ä»€ä¹ˆ"><a href="#äºŒã€ç´¢å¼•åˆ°åº•æ˜¯ä»€ä¹ˆ" class="headerlink" title="äºŒã€ç´¢å¼•åˆ°åº•æ˜¯ä»€ä¹ˆ"></a>äºŒã€ç´¢å¼•åˆ°åº•æ˜¯ä»€ä¹ˆ</h2><p>ç´¢å¼•æ˜¯å¸®åŠ©MySQLé«˜æ•ˆè·å–æ•°æ®çš„æ’å¥½åºçš„æ•°æ®ç»“æ„<br>,ç´¢å¼•å­˜å‚¨åœ¨æ–‡ä»¶é‡Œã€‚</p><ul><li>ç´¢å¼•ç»“æ„ äºŒå‰æ ‘ã€çº¢é»‘æ ‘ã€HASHã€Btree(B+tree)</li></ul><h3 id="ç£ç›˜å­˜å‚¨åŸç†"><a href="#ç£ç›˜å­˜å‚¨åŸç†" class="headerlink" title="ç£ç›˜å­˜å‚¨åŸç†"></a>ç£ç›˜å­˜å‚¨åŸç†</h3><p>ç£ç›˜å­˜å‚¨è€—æ—¶åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>å¯»é“æ—¶é—´ï¼ŒæŒ‡é’ˆç§»åŠ¨æ—¶é—´(é€Ÿåº¦æ…¢ï¼Œè´¹æ—¶)</li><li>æ—‹è½¬æ—¶é—´ï¼Œç£ç›˜æ—‹è½¬(é€Ÿåº¦è¾ƒå¿«)<br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/AF528CD17AC44F86A458243B4FBC4268.jpg" alt="image"></li></ol><p>æ‰€ä»¥ä»mysqlç´¢å¼•çš„è§’åº¦ï¼Œè¦å‡å°‘å¯»é“æ—¶é—´ã€‚</p><p>ç£ç›˜IO ä»¥é¡µä¸ºå•ä½ï¼ˆå›ºå®šå¤§å° 4KBï¼‰ã€‚æ‰€ä»¥ä¸€æ¬¡æ•°æ®åº“æŸ¥è¯¢æˆ–å†™å…¥æ“ä½œï¼Œè¦å°½å¯èƒ½çš„å‡å°‘IO æ¬¡æ•°ï¼Œåˆ™æ¯é¡µåŒ…å«çš„å°½é‡å¤šçš„è¦æ“ä½œçš„ç›®æ ‡æ•°æ®ã€‚</p><h2 id="ä¸‰ã€ç´¢å¼•åº•å±‚æ•°æ®ç»“æ„ä¸ç®—æ³•"><a href="#ä¸‰ã€ç´¢å¼•åº•å±‚æ•°æ®ç»“æ„ä¸ç®—æ³•" class="headerlink" title="ä¸‰ã€ç´¢å¼•åº•å±‚æ•°æ®ç»“æ„ä¸ç®—æ³•"></a>ä¸‰ã€ç´¢å¼•åº•å±‚æ•°æ®ç»“æ„ä¸ç®—æ³•</h2><p>æ ‘ç®€å•åˆ†ä¸ºï¼šäºŒå‰æ ‘ã€Bæ ‘ã€B+æ ‘ã€‚<br>åº¦(Degree)-ä»£è¡¨èŠ‚ç‚¹çš„æ•°æ®å­˜å‚¨ä¸ªæ•°ï¼Œä¹ŸæŒ‡ä»£èŠ‚ç‚¹æœ€å¤§çš„å­èŠ‚ç‚¹ä¸ªæ•°ã€‚</p><h3 id="B-Tree"><a href="#B-Tree" class="headerlink" title="B-Tree"></a>B-Tree</h3><ol><li>æ¯ä¸ªèŠ‚ç‚¹éƒ½ï¼ˆåŒ…å«å¶å­èŠ‚ç‚¹ï¼‰å­˜å‚¨æ•°æ®</li><li>èŠ‚ç‚¹ä¸­çš„æ•°æ® key ä»å·¦åˆ°å³é€’å¢æ’åˆ—</li><li>å¶å­èŠ‚ç‚¹ä¸å­˜å‚¨æŒ‡é’ˆã€‚</li><li>æ¯ä¸ªèŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸ªæ•°m/2&lt;= ä¸ªæ•° &lt;=m,ä½†æ ¹èŠ‚ç‚¹çš„èŠ‚ç‚¹ä¸ªæ•°å¯ä»¥ä¸è¶…è¿‡m/2ã€‚</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/A27A5822516D41ADA83D082A07ADF8D1.jpg" alt="image"></p><h3 id="B-Tree-B-Treeå˜ç§"><a href="#B-Tree-B-Treeå˜ç§" class="headerlink" title="B+Tree(B-Treeå˜ç§)"></a>B+Tree(B-Treeå˜ç§)</h3><ol><li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ ¹èŠ‚ç‚¹å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå…¶ä»–èŠ‚ç‚¹å­˜å‚¨åœ¨ç£ç›˜ä¸­</li><li>éå¶å­èŠ‚ç‚¹ä¸å­˜å‚¨æ•°æ®ï¼Œåªå­˜å‚¨ç´¢å¼•ï¼Œå¯ä»¥å¢å¤§åº¦ï¼Œç±»ä¼¼è·³è¡¨ã€‚</li><li>å¶å­èŠ‚ç‚¹ä¸å­˜å‚¨æŒ‡é’ˆï¼Œå­˜å‚¨æ•°æ®</li><li>æ¯ä¸ªèŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸ªæ•°m/2&lt;= ä¸ªæ•° &lt;=m,ä½†æ ¹èŠ‚ç‚¹çš„èŠ‚ç‚¹ä¸ªæ•°å¯ä»¥ä¸è¶…è¿‡m/2ã€‚</li><li>å¶å­èŠ‚ç‚¹ä¸å­˜å‚¨æŒ‡é’ˆ</li><li>å¶å­èŠ‚ç‚¹æ˜¯é€šè¿‡é“¾è¡¨ä¸²åœ¨ä¸€èµ·ï¼ˆæ–¹ä¾¿åŒºé—´æŸ¥æ‰¾ï¼‰ã€‚</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/CF305DBAECD843518162BBF1F15DD14A.jpg" alt="image"></p><h3 id="Bä¸-B-æ ‘çš„åŒºåˆ«"><a href="#Bä¸-B-æ ‘çš„åŒºåˆ«" class="headerlink" title="Bä¸ B+æ ‘çš„åŒºåˆ«"></a>Bä¸ B+æ ‘çš„åŒºåˆ«</h3><ol><li>B+æ ‘ä¸­çš„èŠ‚ç‚¹ä¸å­˜å‚¨æ•°æ®ï¼Œåªæ˜¯ç´¢å¼•,è€Œ B æ ‘ä¸­çš„èŠ‚ç‚¹å­˜å‚¨æ•°æ®ã€‚</li><li>B æ ‘ä¸­çš„å¶å­èŠ‚ç‚¹ä¸éœ€è¦é“¾è¡¨æ¥ä¸²è”ã€‚</li></ol><h3 id="æ€§èƒ½åˆ†æ"><a href="#æ€§èƒ½åˆ†æ" class="headerlink" title="æ€§èƒ½åˆ†æ"></a>æ€§èƒ½åˆ†æ</h3><h4 id="B-Tree-ç´¢å¼•çš„æ€§èƒ½åˆ†æ"><a href="#B-Tree-ç´¢å¼•çš„æ€§èƒ½åˆ†æ" class="headerlink" title="B+Tree ç´¢å¼•çš„æ€§èƒ½åˆ†æ"></a>B+Tree ç´¢å¼•çš„æ€§èƒ½åˆ†æ</h4><p>ä¸€èˆ¬ä½¿ç”¨ç£ç›˜I/Oæ¬¡æ•°è¯„ä»·ç´¢å¼•ç»“æ„çš„ä¼˜åŠ£</p><ul><li>é¢„è¯»ï¼šç£ç›˜ä¸€èˆ¬ä¼šé¡ºåºå‘åè¯»å–ä¸€å®šé•¿åº¦çš„æ•°æ®(é¡µçš„æ•´æ•°å€)æ”¾å…¥å†…å­˜ã€‚</li><li>å±€éƒ¨æ€§åŸç†ï¼šå½“ä¸€ä¸ªæ•°æ®è¢«ç”¨åˆ°æ—¶ï¼Œå…¶é™„è¿‘çš„æ•°æ®ä¹Ÿé€šå¸¸ä¼šé©¬ä¸Šè¢«ä½¿ç”¨B+TreeèŠ‚ç‚¹çš„å¤§å°è®¾ä¸ºç­‰äºä¸€ä¸ªé¡µï¼Œæ¯æ¬¡æ–°å»ºèŠ‚ç‚¹ç›´æ¥ç”³è¯·ä¸€ä¸ªé¡µçš„ç©ºé—´ï¼Œè¿™æ ·å°±ä¿è¯ä¸€ä¸ªèŠ‚ç‚¹ç‰©ç†ä¸Šä¹Ÿå­˜å‚¨åœ¨ä¸€ä¸ªé¡µé‡Œï¼Œå°±å®ç°äº†ä¸€ä¸ªèŠ‚ç‚¹çš„è½½å…¥åªéœ€ä¸€æ¬¡I/Oã€‚</li><li>B+Treeçš„åº¦dä¸€èˆ¬ä¼šè¶…è¿‡100ï¼Œå› æ­¤héå¸¸å°(ä¸€èˆ¬ä¸º3åˆ°5ä¹‹é—´)</li></ul><h2 id="ç´¢å¼•å®ç°"><a href="#ç´¢å¼•å®ç°" class="headerlink" title="ç´¢å¼•å®ç°"></a>ç´¢å¼•å®ç°</h2><p>Mysql å¸¸ç”¨å­˜å‚¨å¼•æ“ä¸ºï¼šMyISAM å’Œ InnoDBã€‚åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™æŒ‡å®šå­˜å‚¨å¼•æ“ï¼Œ</p><h3 id="MyISAMç´¢å¼•å®ç°-éèšé›†"><a href="#MyISAMç´¢å¼•å®ç°-éèšé›†" class="headerlink" title="MyISAMç´¢å¼•å®ç°(éèšé›†)"></a>MyISAMç´¢å¼•å®ç°(éèšé›†)</h3><p>MyISAMç´¢å¼•æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶æ˜¯åˆ†ç¦»çš„</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/0619AC2863944836AFA2B35232B777E0.jpg" alt="image"></p><h3 id="InnoDBç´¢å¼•å®ç°-èšé›†"><a href="#InnoDBç´¢å¼•å®ç°-èšé›†" class="headerlink" title="InnoDBç´¢å¼•å®ç°(èšé›†)"></a>InnoDBç´¢å¼•å®ç°(èšé›†)</h3><ol><li>æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯ç´¢å¼•æ–‡ä»¶ã€‚</li><li>è¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯æŒ‰B+Treeç»„ç»‡çš„ä¸€ä¸ªç´¢å¼•ç»“æ„æ–‡ä»¶ã€‚</li><li>èšé›†ç´¢å¼•-å¶èŠ‚ç‚¹åŒ…å«äº†å®Œæ•´çš„æ•°æ®è®°å½•ã€‚</li><li>ä¸ºä»€ä¹ˆ InnoDBè¡¨å¿…é¡»æœ‰ä¸»é”®ï¼Œå¹¶ä¸”æ¨èä½¿ç”¨æ•´å‹çš„è‡ªå¢ä¸»é”®ï¼Ÿ<blockquote><p>å› ä¸ºä¸»é”®ç´¢å¼•å­˜å‚¨çš„æœ‰æ•°æ®ï¼ŒåŸºäºè¿™ä¸ªåŸå› ï¼Œå¿…é¡»è¦æœ‰ä¸»é”®ï¼Œå¦‚æœæ²¡ä¸»é”®ä¼šé»˜è®¤æ·»åŠ ä¸€ä¸ªæ•´å‹è‡ªå¢ä¸»é”®ã€‚</p></blockquote></li><li>ä¸ºä»€ä¹ˆéä¸»é”®ç´¢å¼•ç»“æ„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ä¸»é”®å€¼ï¼Ÿ<br>åŸºäºä¸€è‡´æ€§å’ŒèŠ‚çœå­˜å‚¨ç©ºé—´çš„è€ƒè™‘ï¼Œéä¸»é”®ç´¢å¼•èŠ‚ç‚¹å­˜å‚¨ä¸»é”®å€¼ã€‚<br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/E57C60E2EDAA4863ADBEF76B2A5EAC01.jpg" alt="image"></li></ol><h2 id="è”åˆç´¢å¼•ï¼Œç´¢å¼•æœ€å·¦å‰ç¼€åŸç†"><a href="#è”åˆç´¢å¼•ï¼Œç´¢å¼•æœ€å·¦å‰ç¼€åŸç†" class="headerlink" title="è”åˆç´¢å¼•ï¼Œç´¢å¼•æœ€å·¦å‰ç¼€åŸç†"></a>è”åˆç´¢å¼•ï¼Œç´¢å¼•æœ€å·¦å‰ç¼€åŸç†</h2><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/341B6DF11EB34172BA8DA3C2D7BA79B5.jpg" alt="image"></p><p>å¦‚æœç´¢å¼•äº†å¤šåˆ—ï¼Œè¦éµå®ˆæœ€å·¦å‰ç¼€æ³•åˆ™ã€‚æŒ‡çš„æ˜¯æŸ¥è¯¢ä»å¼•çš„æœ€å·¦å‰åˆ—å¼€å§‹å¹¶ä¸”ä¸è·³è¿‡ç´¢å¼•ä¸­çš„åˆ—ã€‚</p><p>ä¾‹ï¼š<br>idx(a,b,c)</p><pre><code>select * from table where a=10002 and b=&#39;staff&#39; and c=&#39;199600823&#39;;(Y)select * from table where a=10002;(Y)select * from table where a=10002 and c = &#39;199600823&#39;;(éƒ¨åˆ†ç´¢å¼•Y,éƒ¨åˆ† N)select * from table where b=&#39;staff&#39; and c = &#39;199600823&#39;;(N)elect * from table where b=&#39;staff&#39;;(N)elect * from table where c = &#39;199600823&#39;;(N)</code></pre><table><thead><tr><th>è¯­å¥</th><th>æ˜¯å¦ç”¨åˆ°ç´¢å¼•</th><th>ä½¿ç”¨çš„ç´¢å¼•</th></tr></thead><tbody><tr><td>where a=3</td><td>Y</td><td>a</td></tr><tr><td>where a=3 and b = 5</td><td>Y</td><td>aï¼Œb</td></tr><tr><td>where a=3 and b = 5 and c = 4</td><td>Y</td><td>aï¼Œb, c</td></tr><tr><td>where b=3 æˆ–è€… where b = 3 and c = 4 æˆ–è€… where c=4</td><td>N</td><td></td></tr><tr><td>where a=3 and c = 5</td><td>Y</td><td>ä½¿ç”¨åˆ° a,ä½† c æ²¡æœ‰ä½¿ç”¨ï¼Œbä¸­é—´æ–­äº†</td></tr><tr><td>where a=3 and b&gt;4 and c = 5</td><td>Y</td><td>ä½¿ç”¨åˆ° a,b,ä½† c ä¸èƒ½ç”¨åœ¨èŒƒå›´ä¹‹åï¼Œæ‰€ä»¥ b æ–­äº†ã€‚</td></tr><tr><td>where a=3 and b like â€˜kk%â€™ and c = 5</td><td>Y</td><td>åªç”¨åˆ° aï¼Œb ,c</td></tr><tr><td>where a=3 and b like â€˜%kkâ€™ and c = 5</td><td>Y</td><td>åªç”¨åˆ° a</td></tr><tr><td>where a=3 and b like â€˜%kk%â€™ and c = 5</td><td>Y</td><td>åªç”¨åˆ° a</td></tr><tr><td>where a=3 and b like â€˜k%kk%â€™ and c = 5</td><td>Y</td><td>åªç”¨åˆ° a,b,c</td></tr><tr><td><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/9AAD735E36F94A52AFDEDD8B3D2DAA07.jpg" alt="image"></td><td></td><td></td></tr></tbody></table><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li><p>MySQLæ”¯æŒä¸¤ç§æ–¹å¼çš„æ’åºfilesortå’Œindexï¼ŒUsing indexæ˜¯æŒ‡MySQLæ‰«æç´¢å¼•æœ¬èº«å®Œæˆæ’åºã€‚indexæ•ˆç‡é«˜ï¼Œfilesortæ•ˆç‡ä½ã€‚</p></li><li><p>order byæ»¡è¶³ä¸¤ç§æƒ…å†µä¼šä½¿ç”¨Using indexã€‚<br>#1.order byè¯­å¥ä½¿ç”¨ç´¢å¼•æœ€å·¦å‰åˆ—ã€‚<br>#2.ä½¿ç”¨whereå­å¥ä¸order byå­å¥æ¡ä»¶åˆ—ç»„åˆæ»¡è¶³ç´¢å¼•æœ€å·¦å‰åˆ—ã€‚</p></li><li><p>å°½é‡åœ¨ç´¢å¼•åˆ—ä¸Šå®Œæˆæ’åºï¼Œéµå¾ªç´¢å¼•å»ºç«‹ï¼ˆç´¢å¼•åˆ›å»ºçš„é¡ºåºï¼‰æ—¶çš„æœ€ä½³å·¦å‰ç¼€æ³•åˆ™ã€‚</p></li><li><p>å¦‚æœorder byçš„æ¡ä»¶ä¸åœ¨ç´¢å¼•åˆ—ä¸Šï¼Œå°±ä¼šäº§ç”ŸUsing filesortã€‚</p></li><li><p>group byä¸order byå¾ˆç±»ä¼¼ï¼Œå…¶å®è´¨æ˜¯å…ˆæ’åºååˆ†ç»„ï¼Œéµç…§ç´¢å¼•åˆ›å»ºé¡ºåºçš„æœ€ä½³å·¦å‰ç¼€æ³•åˆ™ã€‚æ³¨æ„whereé«˜äºhavingï¼Œèƒ½å†™åœ¨whereä¸­çš„é™å®šæ¡ä»¶å°±ä¸è¦å»havingé™å®šäº†ã€‚</p></li></ol><p>é€šä¿—ç†è§£å£è¯€ï¼š</p><blockquote></blockquote><pre><code>å…¨å€¼åŒ¹é…æˆ‘æœ€çˆ±ï¼Œæœ€å·¦å‰ç¼€è¦éµå®ˆï¼›å¸¦å¤´å¤§å“¥ä¸èƒ½æ­»ï¼Œä¸­é—´å…„å¼Ÿä¸èƒ½æ–­ï¼›ç´¢å¼•åˆ—ä¸Šå°‘è®¡ç®—ï¼ŒèŒƒå›´ä¹‹åå…¨å¤±æ•ˆï¼›LIKEç™¾åˆ†å†™æœ€å³ï¼Œè¦†ç›–ç´¢å¼•ä¸å†™æ˜Ÿï¼›ä¸ç­‰ç©ºå€¼è¿˜æœ‰orï¼Œç´¢å¼•å¤±æ•ˆè¦å°‘ç”¨ã€‚</code></pre><p><strong>è¡¥å……ï¼šinå’Œexsitsä¼˜åŒ–</strong></p><p>åŸåˆ™ï¼šå°è¡¨é©±åŠ¨å¤§è¡¨ï¼Œå³å°çš„æ•°æ®é›†é©±åŠ¨å¤§çš„æ•°æ®é›†</p><p>inï¼šå½“Bè¡¨çš„æ•°æ®é›†å¿…é¡»å°äºAè¡¨çš„æ•°æ®é›†æ—¶ï¼Œinä¼˜äºexists</p><pre><code>select * from A where id in (select id from B)#ç­‰ä»·äºï¼šã€€ã€€for select id from Bã€€ã€€for select * from A where A.id = B.id</code></pre><p>existsï¼šå½“Aè¡¨çš„æ•°æ®é›†å°äºBè¡¨çš„æ•°æ®é›†æ—¶ï¼Œexistsä¼˜äºin<br>ã€€ã€€å°†ä¸»æŸ¥è¯¢Açš„æ•°æ®ï¼Œæ”¾åˆ°å­æŸ¥è¯¢Bä¸­åšæ¡ä»¶éªŒè¯ï¼Œæ ¹æ®éªŒè¯ç»“æœï¼ˆtrueæˆ–falseï¼‰æ¥å†³å®šä¸»æŸ¥è¯¢çš„æ•°æ®æ˜¯å¦ä¿ç•™</p><pre><code>select * from A where exists (select 1 from B where B.id = A.id)#ç­‰ä»·äº    for select * from A    for select * from B where B.id = A.id</code></pre><p>Aè¡¨ä¸Bè¡¨çš„IDå­—æ®µåº”å»ºç«‹ç´¢å¼•</p><blockquote></blockquote><ol><li>EXISTS (subquery)åªè¿”å›TRUEæˆ–FALSE,å› æ­¤å­æŸ¥è¯¢ä¸­çš„SELECT * ä¹Ÿå¯ä»¥æ˜¯SELECT 1æˆ–select X,å®˜æ–¹è¯´æ³•æ˜¯å®é™…æ‰§è¡Œæ—¶ä¼šå¿½ç•¥SELECTæ¸…å•,å› æ­¤æ²¡æœ‰åŒºåˆ«</li><li>EXISTSå­æŸ¥è¯¢çš„å®é™…æ‰§è¡Œè¿‡ç¨‹å¯èƒ½ç»è¿‡äº†ä¼˜åŒ–è€Œä¸æ˜¯æˆ‘ä»¬ç†è§£ä¸Šçš„é€æ¡å¯¹æ¯”</li><li>EXISTSå­æŸ¥è¯¢å¾€å¾€ä¹Ÿå¯ä»¥ç”¨JOINæ¥ä»£æ›¿ï¼Œä½•ç§æœ€ä¼˜éœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æ</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ä¸€ã€ç´¢å¼•ä¼˜åŒ–é¢è¯•é¢˜åˆ†æ&quot;&gt;&lt;a href=&quot;#ä¸€ã€ç´¢å¼•ä¼˜åŒ–é¢è¯•é¢˜åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€ç´¢å¼•ä¼˜åŒ–é¢è¯•é¢˜åˆ†æ&quot;&gt;&lt;/a&gt;ä¸€ã€ç´¢å¼•ä¼˜åŒ–é¢è¯•é¢˜åˆ†æ&lt;/h2&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="æ•°æ®åº“" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="mysql" scheme="https://brokge.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£MySqlé” å’Œäº‹ç‰©éš”ç¦»çº§åˆ«</title>
    <link href="https://brokge.github.io/2020/08/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3MySql%E9%94%81-%E5%92%8C%E4%BA%8B%E7%89%A9%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/"/>
    <id>https://brokge.github.io/2020/08/05/æ·±å…¥ç†è§£MySqlé”-å’Œäº‹ç‰©éš”ç¦»çº§åˆ«/</id>
    <published>2020-08-05T15:36:29.000Z</published>
    <updated>2020-08-21T05:02:27.721Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€æ¦‚è¿°"><a href="#ä¸€ã€æ¦‚è¿°" class="headerlink" title="ä¸€ã€æ¦‚è¿°"></a>ä¸€ã€æ¦‚è¿°</h1><h2 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h2><p>é”æ˜¯è®¡ç®—æœºåè°ƒå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹å¹¶å‘è®¿é—®æŸä¸€èµ„æºçš„æœºåˆ¶ã€‚<br>åœ¨æ•°æ®åº“ä¸­ï¼Œé™¤äº†ä¼ ç»Ÿçš„è®¡ç®—èµ„æºï¼ˆå¦‚CPUã€RAMã€I/Oç­‰ï¼‰çš„äº‰ç”¨ä»¥å¤–ï¼Œæ•°æ®ä¹Ÿæ˜¯ä¸€ç§ä¾›éœ€è¦ç”¨æˆ·å…±äº«çš„èµ„æºã€‚å¦‚ä½•ä¿è¯æ•°æ®å¹¶å‘è®¿é—®çš„ä¸€è‡´æ€§ã€æœ‰æ•ˆæ€§æ˜¯æ‰€æœ‰æ•°æ®åº“å¿…é¡»è§£å†³çš„ä¸€ä¸ªé—®é¢˜ï¼Œé”å†²çªä¹Ÿæ˜¯å½±å“æ•°æ®åº“å¹¶å‘è®¿é—®æ€§èƒ½çš„ä¸€ä¸ªé‡è¦å› ç´ ã€‚ä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œé”å¯¹æ•°æ®åº“è€Œè¨€æ˜¾å¾—å°¤å…¶é‡è¦ï¼Œä¹Ÿæ›´åŠ å¤æ‚ã€‚</p><a id="more"></a><h2 id="é”çš„åˆ†ç±»"><a href="#é”çš„åˆ†ç±»" class="headerlink" title="é”çš„åˆ†ç±»"></a>é”çš„åˆ†ç±»</h2><ul><li>ä»æ€§èƒ½ä¸Šåˆ†ä¸ºä¹è§‚é”(ç”¨ç‰ˆæœ¬å¯¹æ¯”æ¥å®ç°)å’Œæ‚²è§‚é”</li><li>ä»å¯¹æ•°æ®åº“æ“ä½œçš„ç±»å‹åˆ†ï¼Œåˆ†ä¸ºè¯»é”å’Œå†™é”(éƒ½å±äºæ‚²è§‚é”)<ol><li>è¯»é”ï¼ˆå…±äº«é”ï¼‰ï¼šé’ˆå¯¹åŒä¸€ä»½æ•°æ®ï¼Œå¤šä¸ªè¯»æ“ä½œå¯ä»¥åŒæ—¶è¿›è¡Œè€Œä¸ä¼šäº’ç›¸å½±å“</li><li>å†™é”ï¼ˆæ’å®ƒé”ï¼‰ï¼šå½“å‰å†™æ“ä½œæ²¡æœ‰å®Œæˆå‰ï¼Œå®ƒä¼šé˜»æ–­å…¶ä»–å†™é”å’Œè¯»é”</li></ol></li><li>ä»å¯¹æ•°æ®æ“ä½œçš„ç²’åº¦åˆ†ï¼Œåˆ†ä¸ºè¡¨é”å’Œè¡Œé”</li></ul><h1 id="äºŒã€ä¸‰ç§é”"><a href="#äºŒã€ä¸‰ç§é”" class="headerlink" title="äºŒã€ä¸‰ç§é”"></a>äºŒã€ä¸‰ç§é”</h1><h2 id="è¡¨é”ï¼ˆåè¯»ï¼‰"><a href="#è¡¨é”ï¼ˆåè¯»ï¼‰" class="headerlink" title="è¡¨é”ï¼ˆåè¯»ï¼‰"></a>è¡¨é”ï¼ˆåè¯»ï¼‰</h2><p>è¡¨é”åå‘MyISAMå­˜å‚¨å¼•æ“ï¼Œå¼€é”€å°ï¼ŒåŠ é”å¿«ï¼Œæ— æ€ç´¢ï¼Œé”å®šç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ã€‚</p><h3 id="åŸºæœ¬æ“ä½œ"><a href="#åŸºæœ¬æ“ä½œ" class="headerlink" title="åŸºæœ¬æ“ä½œ"></a>åŸºæœ¬æ“ä½œ</h3><ul><li>å»ºè¡¨SQL<pre><code>CREATE TABLE `mylock` (`id` INT (11) NOT NULL AUTO_INCREMENT,`NAME` VARCHAR (20) DEFAULT NULL,PRIMARY KEY (`id`)) ENGINE = MyISAM DEFAULT CHARSET = utf8;</code></pre></li><li>æ’å…¥æ•°æ®<pre><code>INSERT INTO`test`.`mylock` (`id`, `NAME`) VALUES (&#39;1&#39;, &#39;a&#39;);INSERT INTO`test`.`mylock` (`id`, `NAME`) VALUES (&#39;2&#39;, &#39;b&#39;);INSERT INTO`test`.`mylock` (`id`, `NAME`) VALUES (&#39;3&#39;, &#39;c&#39;);INSERT INTO`test`.`mylock` (`id`, `NAME`) VALUES (&#39;4&#39;, &#39;d&#39;);</code></pre></li><li>æ‰‹åŠ¨å¢åŠ è¡¨é”<pre><code>lock table è¡¨åç§° read(write),è¡¨åç§°2 read(write);</code></pre></li><li>æŸ¥çœ‹è¡¨ä¸ŠåŠ è¿‡çš„é”<pre><code>show open tables;</code></pre></li><li>åˆ é™¤è¡¨é”<pre><code>unlock tables;</code></pre></li></ul><h3 id="æ¡ˆä¾‹åˆ†æ-åŠ è¯»-å†™é”ï¼‰"><a href="#æ¡ˆä¾‹åˆ†æ-åŠ è¯»-å†™é”ï¼‰" class="headerlink" title="æ¡ˆä¾‹åˆ†æ(åŠ è¯»/å†™é”ï¼‰"></a>æ¡ˆä¾‹åˆ†æ(åŠ è¯»/å†™é”ï¼‰</h3><ul><li><p>æ·»åŠ è¯»é”<br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/BFE8ADDD90014C6BBB0BBE036AD3A63D.jpg" alt="image"><br>å½“å‰sessionå’Œå…¶ä»–sessionéƒ½å¯ä»¥è¯»è¯¥è¡¨<br>å½“å‰sessionä¸­æ’å…¥æˆ–è€…æ›´æ–°é”å®šçš„è¡¨éƒ½ä¼šæŠ¥é”™ï¼Œå…¶ä»–sessionæ’å…¥æˆ–æ›´æ–°åˆ™ä¼šç­‰å¾…</p></li><li><p>åŠ å†™é”<br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/C461F77F31324DD18959B693CBE9F650.jpg" alt="image"><br>å½“å‰sessionå¯¹è¯¥è¡¨çš„å¢åˆ æ”¹æŸ¥éƒ½æ²¡æœ‰é—®é¢˜ï¼Œå…¶ä»–sessionå¯¹è¯¥è¡¨çš„æ‰€æœ‰æ“ä½œè¢«é˜»å¡</p></li></ul><h3 id="æ¡ˆä¾‹ç»“è®º"><a href="#æ¡ˆä¾‹ç»“è®º" class="headerlink" title="æ¡ˆä¾‹ç»“è®º"></a>æ¡ˆä¾‹ç»“è®º</h3><p>MyISAMåœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥(SELECT)å‰,ä¼šè‡ªåŠ¨ç»™æ¶‰åŠçš„æ‰€æœ‰è¡¨åŠ è¯»é”,åœ¨æ‰§è¡Œå¢åˆ æ”¹æ“ä½œå‰,ä¼šè‡ªåŠ¨ç»™æ¶‰åŠçš„è¡¨åŠ å†™é”ã€‚</p><ol><li>å¯¹MyISAMè¡¨çš„è¯»æ“ä½œ(åŠ è¯»é”) ,ä¸ä¼šé˜»å¯’å…¶ä»–è¿›ç¨‹å¯¹åŒä¸€è¡¨çš„è¯»è¯·æ±‚,ä½†ä¼šé˜»èµ›å¯¹åŒä¸€è¡¨çš„å†™è¯·æ±‚ã€‚åªæœ‰å½“è¯»é”é‡Šæ”¾å,æ‰ä¼šæ‰§è¡Œå…¶å®ƒè¿›ç¨‹çš„å†™æ“ä½œã€‚</li><li>å¯¹MylSAMè¡¨çš„å†™æ“ä½œ(åŠ å†™é”) ,ä¼šé˜»å¡å…¶ä»–è¿›ç¨‹å¯¹åŒä¸€è¡¨çš„è¯»å’Œå†™æ“ä½œ,åªæœ‰å½“å†™é”é‡Šæ”¾å,æ‰ä¼šæ‰§è¡Œå…¶å®ƒè¿›ç¨‹çš„è¯»å†™æ“ä½œ</li></ol><p><strong>æ€»ç»“ï¼š</strong><br>ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯è¯»é”ä¼šé˜»å¡å†™ï¼Œä½†æ˜¯ä¸ä¼šé˜»å¡è¯»ã€‚è€Œå†™é”åˆ™ä¼šæŠŠè¯»å’Œå†™éƒ½é˜»å¡ã€‚</p><h2 id="è¡Œé”ï¼ˆåå†™ï¼‰"><a href="#è¡Œé”ï¼ˆåå†™ï¼‰" class="headerlink" title="è¡Œé”ï¼ˆåå†™ï¼‰"></a>è¡Œé”ï¼ˆåå†™ï¼‰</h2><p>è¡Œé”åå‘InnoDBå­˜å‚¨å¼•æ“ï¼Œå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼Œä¼šå‡ºç°æ­»é”ï¼Œé”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½ï¼Œå¹¶å‘åº¦ä¹Ÿæœ€é«˜ã€‚InnoDB ä¸ MYISAM çš„æœ€å¤§ä¸åŒæœ‰ä¸¤ç‚¹ï¼šä¸€æ˜¯æ”¯æŒäº‹åŠ¡ï¼ˆTRANSACTIONï¼‰ï¼›äºŒæ˜¯é‡‡ç”¨äº†è¡Œçº§é”ã€‚</p><h3 id="è¡Œé”æ”¯æŒäº‹åŠ¡"><a href="#è¡Œé”æ”¯æŒäº‹åŠ¡" class="headerlink" title="è¡Œé”æ”¯æŒäº‹åŠ¡"></a>è¡Œé”æ”¯æŒäº‹åŠ¡</h3><ul><li>äº‹åŠ¡ï¼ˆTransactionï¼‰åŠå…¶ACIDå±æ€§</li></ul><p>äº‹åŠ¡æ˜¯ç”±ä¸€ç»„SQLè¯­å¥ç»„æˆçš„é€»è¾‘å¤„ç†å•å…ƒ,äº‹åŠ¡å…·æœ‰ä»¥ä¸‹4ä¸ªå±æ€§,é€šå¸¸ç®€ç§°ä¸ºäº‹åŠ¡çš„ACIDå±æ€§ã€‚</p><p>**åŸå­æ€§(Atomicity)**ï¼šäº‹åŠ¡æ˜¯ä¸€ä¸ªåŸå­æ“ä½œå•å…ƒ,å…¶å¯¹æ•°æ®çš„ä¿®æ”¹,è¦ä¹ˆå…¨éƒ½æ‰§è¡Œ,è¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œã€‚</p><p>**ä¸€è‡´æ€§(Consistent)**ï¼šåœ¨äº‹åŠ¡å¼€å§‹å’Œå®Œæˆæ—¶,æ•°æ®éƒ½å¿…é¡»ä¿æŒä¸€è‡´çŠ¶æ€ã€‚è¿™æ„å‘³ç€æ‰€æœ‰ç›¸å…³çš„æ•°æ®è§„åˆ™éƒ½å¿…é¡»åº”ç”¨äºäº‹åŠ¡çš„ä¿®æ”¹,ä»¥ä¿æŒæ•°æ®çš„å®Œæ•´æ€§;äº‹åŠ¡ç»“æŸæ—¶,æ‰€æœ‰çš„å†…éƒ¨æ•°æ®ç»“æ„(å¦‚Bæ ‘ç´¢å¼•æˆ–åŒå‘é“¾è¡¨)ä¹Ÿéƒ½å¿…é¡»æ˜¯æ­£ç¡®çš„ã€‚</p><p>**éš”ç¦»æ€§(Isolation)**ï¼šæ•°æ®åº“ç³»ç»Ÿæä¾›ä¸€å®šçš„éš”ç¦»æœºåˆ¶,ä¿è¯äº‹åŠ¡åœ¨ä¸å—å¤–éƒ¨å¹¶å‘æ“ä½œå½±å“çš„â€œç‹¬ç«‹â€ç¯å¢ƒæ‰§è¡Œã€‚è¿™æ„å‘³ç€äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­çš„ä¸­é—´çŠ¶æ€å¯¹å¤–éƒ¨æ˜¯ä¸å¯è§çš„,åä¹‹äº¦ç„¶ã€‚</p><p>**æŒä¹…æ€§(Durable)**ï¼šäº‹åŠ¡å®Œæˆä¹‹å,å®ƒå¯¹äºæ•°æ®çš„ä¿®æ”¹æ˜¯æ°¸ä¹…æ€§çš„,å³ä½¿å‡ºç°ç³»ç»Ÿæ•…éšœä¹Ÿèƒ½å¤Ÿä¿æŒã€‚</p><ul><li>å¹¶å‘äº‹åŠ¡å¤„ç†å¸¦æ¥çš„é—®é¢˜</li></ul><p>æ›´æ–°ä¸¢å¤±ï¼ˆLost Updateï¼‰å½“ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡é€‰æ‹©åŒä¸€è¡Œï¼Œç„¶ååŸºäºæœ€åˆé€‰å®šçš„å€¼æ›´æ–°è¯¥è¡Œæ—¶ï¼Œç”±äºæ¯ä¸ªäº‹åŠ¡éƒ½ä¸çŸ¥é“å…¶ä»–äº‹åŠ¡çš„å­˜åœ¨ï¼Œå°±ä¼šå‘ç”Ÿä¸¢å¤±æ›´æ–°é—®é¢˜â€“æœ€åçš„æ›´æ–°è¦†ç›–äº†ç”±å…¶ä»–äº‹åŠ¡æ‰€åšçš„æ›´æ–°ã€‚</p><ol><li><strong>è„è¯»(Dirty Reads)</strong><br>ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨å¯¹ä¸€æ¡è®°å½•åšä¿®æ”¹ï¼Œåœ¨è¿™ä¸ªäº‹åŠ¡å®Œæˆå¹¶æäº¤å‰ï¼Œè¿™æ¡è®°å½•çš„æ•°æ®å°±å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ï¼›è¿™æ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ä¹Ÿæ¥è¯»å–åŒä¸€æ¡è®°å½•ï¼Œå¦‚æœä¸åŠ æ§åˆ¶ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡è¯»å–äº†è¿™äº›â€œè„â€æ•°æ®ï¼Œå¹¶æ®æ­¤ä½œè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œå°±ä¼šäº§ç”Ÿæœªæäº¤çš„æ•°æ®ä¾èµ–å…³ç³»ã€‚è¿™ç§ç°è±¡è¢«å½¢è±¡çš„å«åšâ€œè„è¯»â€ã€‚<br>==ä¸€å¥è¯==ï¼šäº‹åŠ¡Aè¯»å–åˆ°äº†äº‹åŠ¡Bå·²ç»ä¿®æ”¹ä½†å°šæœªæäº¤çš„æ•°æ®ï¼Œè¿˜åœ¨è¿™ä¸ªæ•°æ®åŸºç¡€ä¸Šåšäº†æ“ä½œã€‚æ­¤æ—¶ï¼Œå¦‚æœBäº‹åŠ¡å›æ»šï¼ŒAè¯»å–çš„æ•°æ®æ— æ•ˆï¼Œä¸ç¬¦åˆä¸€è‡´æ€§è¦æ±‚ã€‚</li><li><strong>ä¸å¯é‡è¯»(Non-Repeatable Reads)</strong><br>ä¸€ä¸ªäº‹åŠ¡åœ¨è¯»å–æŸäº›æ•°æ®åçš„æŸä¸ªæ—¶é—´ï¼Œå†æ¬¡è¯»å–ä»¥å‰è¯»è¿‡çš„æ•°æ®ï¼Œå´å‘ç°å…¶è¯»å‡ºçš„æ•°æ®å·²ç»å‘ç”Ÿäº†æ”¹å˜ã€æˆ–æŸäº›è®°å½•å·²ç»è¢«åˆ é™¤äº†ï¼è¿™ç§ç°è±¡å°±å«åšâ€œä¸å¯é‡å¤è¯»â€ã€‚<br>==ä¸€å¥è¯==ï¼šäº‹åŠ¡Aè¯»å–åˆ°äº†äº‹åŠ¡Bå·²ç»æäº¤çš„ä¿®æ”¹æ•°æ®ï¼Œä¸ç¬¦åˆéš”ç¦»æ€§ã€‚</li><li><strong>å¹»è¯»ï¼ˆPhantom Readsï¼‰</strong><br>ä¸€ä¸ªäº‹åŠ¡æŒ‰ç›¸åŒçš„æŸ¥è¯¢æ¡ä»¶é‡æ–°è¯»å–ä»¥å‰æ£€ç´¢è¿‡çš„æ•°æ®ï¼Œå´å‘ç°å…¶ä»–äº‹åŠ¡æ’å…¥äº†æ»¡è¶³å…¶æŸ¥è¯¢æ¡ä»¶çš„æ–°æ•°æ®ï¼Œè¿™ç§ç°è±¡å°±ç§°ä¸ºâ€œå¹»è¯»â€ã€‚<br>==ä¸€å¥è¯==ï¼šäº‹åŠ¡Aè¯»å–åˆ°äº†äº‹åŠ¡Bæäº¤çš„æ–°å¢æ•°æ®ï¼Œä¸ç¬¦åˆéš”ç¦»æ€§ï¼Œè„è¯»æ˜¯äº‹åŠ¡Bé‡Œé¢ä¿®æ”¹äº†æ•°æ®ï¼Œå¹»è¯»æ˜¯äº‹åŠ¡Bé‡Œé¢æ–°å¢äº†æ•°æ®ã€‚</li></ol><p>äº‹åŠ¡éš”ç¦»çº§åˆ«<br>è„è¯»â€ã€â€œä¸å¯é‡å¤è¯»â€å’Œâ€œå¹»è¯»â€,å…¶å®éƒ½æ˜¯æ•°æ®åº“è¯»ä¸€è‡´æ€§é—®é¢˜,å¿…é¡»ç”±æ•°æ®åº“æä¾›ä¸€å®šçš„äº‹åŠ¡éš”ç¦»æœºåˆ¶æ¥è§£å†³ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/93E21899E14C49588AA24EDA089B6AC7.jpg" alt="image"></p><p>æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»è¶Šä¸¥æ ¼,å¹¶å‘å‰¯ä½œç”¨è¶Šå°,ä½†ä»˜å‡ºçš„ä»£ä»·ä¹Ÿå°±è¶Šå¤§,å› ä¸ºäº‹åŠ¡éš”ç¦»å®è´¨ä¸Šå°±æ˜¯ä½¿äº‹åŠ¡åœ¨ä¸€å®šç¨‹åº¦ä¸Šâ€œä¸²è¡ŒåŒ–â€è¿›è¡Œ,è¿™æ˜¾ç„¶ä¸â€œå¹¶å‘â€æ˜¯çŸ›ç›¾çš„ã€‚</p><p>åŒæ—¶,ä¸åŒçš„åº”ç”¨å¯¹è¯»ä¸€è‡´æ€§å’Œäº‹åŠ¡éš”ç¦»ç¨‹åº¦çš„è¦æ±‚ä¹Ÿæ˜¯ä¸åŒçš„,æ¯”å¦‚è®¸å¤šåº”ç”¨å¯¹â€œä¸å¯é‡å¤è¯»â€å’Œâ€œå¹»è¯»â€å¹¶ä¸æ•æ„Ÿ,å¯èƒ½æ›´å…³å¿ƒæ•°æ®å¹¶å‘è®¿é—®çš„èƒ½åŠ›ã€‚</p><p>å¸¸çœ‹å½“å‰æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«: </p><pre><code>show variables like &#39;tx_isolation&#39;;</code></pre><p>è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼šset tx_isolation=â€™REPEATABLE-READâ€™;</p><h3 id="è¡Œé”æ¡ˆä¾‹åˆ†æç»“è®º"><a href="#è¡Œé”æ¡ˆä¾‹åˆ†æç»“è®º" class="headerlink" title="è¡Œé”æ¡ˆä¾‹åˆ†æç»“è®º"></a>è¡Œé”æ¡ˆä¾‹åˆ†æç»“è®º</h3><p>åœ¨å¼€å¯äº‹åŠ¡çš„æƒ…å†µä¸‹ï¼ŒSession_1 æ›´æ–°æŸä¸€è¡Œï¼ŒSession_2 æ›´æ–°åŒä¸€è¡Œè¢«é˜»å¡ï¼Œä½†æ˜¯æ›´æ–°å…¶ä»–è¡Œæ­£å¸¸ã€‚</p><h3 id="éš”ç¦»çº§åˆ«æ¡ˆä¾‹åˆ†æ"><a href="#éš”ç¦»çº§åˆ«æ¡ˆä¾‹åˆ†æ" class="headerlink" title="éš”ç¦»çº§åˆ«æ¡ˆä¾‹åˆ†æ"></a>éš”ç¦»çº§åˆ«æ¡ˆä¾‹åˆ†æ</h3><pre><code>CREATE TABLE `account` (  `id` int(11) NOT NULL AUTO_INCREMENT,  `name` varchar(255) DEFAULT NULL,  `balance` int(11) DEFAULT NULL,  PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8;INSERT INTO `test`.`account` (`name`, `balance`) VALUES (&#39;lilei&#39;, &#39;450&#39;);INSERT INTO `test`.`account` (`name`, `balance`) VALUES (&#39;hanmei&#39;, &#39;16000&#39;);INSERT INTO `test`.`account` (`name`, `balance`) VALUES (&#39;lucy&#39;, &#39;2400&#39;);</code></pre><ul><li>è¯»æœªæäº¤ï¼š</li></ul><ol><li><p>æ‰“å¼€ä¸€ä¸ªå®¢æˆ·ç«¯Aï¼Œå¹¶è®¾ç½®å½“å‰äº‹åŠ¡æ¨¡å¼ä¸ºread uncommittedï¼ˆæœªæäº¤è¯»ï¼‰ï¼ŒæŸ¥è¯¢è¡¨accountçš„åˆå§‹å€¼ï¼š</p><pre><code>set tx_isolation=&#39;read-uncommitted&#39;;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/CDED85F0DF60461A9E2D7092AB8EF2FA.jpg" alt="image"></p></li><li><p>åœ¨å®¢æˆ·ç«¯Açš„äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œæ‰“å¼€å¦ä¸€ä¸ªå®¢æˆ·ç«¯Bï¼Œæ›´æ–°è¡¨accountï¼š</p></li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/403767AE76FE45DDA2BA39966EBB504E.jpg" alt="image"></p><ol start="3"><li>è¿™æ—¶ï¼Œè™½ç„¶å®¢æˆ·ç«¯Bçš„äº‹åŠ¡è¿˜æ²¡æäº¤ï¼Œä½†æ˜¯å®¢æˆ·ç«¯Aå°±å¯ä»¥æŸ¥è¯¢åˆ°Bå·²ç»æ›´æ–°çš„æ•°æ®ï¼š</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/699F1A3528B746EFA38CC4C0AF87F450.jpg" alt="image"></p><ol start="4"><li>ä¸€æ—¦å®¢æˆ·ç«¯Bçš„äº‹åŠ¡å› ä¸ºæŸç§åŸå› å›æ»šï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½å°†ä¼šè¢«æ’¤é”€ï¼Œé‚£å®¢æˆ·ç«¯AæŸ¥è¯¢åˆ°çš„æ•°æ®å…¶å®å°±æ˜¯è„æ•°æ®ï¼š</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/A7C1D41774A1443BAF3405874BBAD8EE.jpg" alt="image"></p><ol start="5"><li>åœ¨å®¢æˆ·ç«¯Aæ‰§è¡Œæ›´æ–°è¯­å¥<code>update account set balance = balance - 50 where id =1</code>ï¼Œlileiçš„balanceæ²¡æœ‰å˜æˆ350ï¼Œå±…ç„¶æ˜¯400ï¼Œæ˜¯ä¸æ˜¯å¾ˆå¥‡æ€ªï¼Œæ•°æ®ä¸ä¸€è‡´å•Šï¼Œ==å¦‚æœä½ è¿™ä¹ˆæƒ³å°±å¤ªå¤©çœŸ äº†ï¼Œåœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬ä¼šç”¨400-50=350ï¼Œå¹¶ä¸çŸ¥é“å…¶ä»–ä¼šè¯å›æ»šäº†ï¼Œè¦æƒ³è§£å†³è¿™ä¸ªé—®é¢˜å¯ä»¥é‡‡ç”¨è¯»å·²æäº¤çš„éš”ç¦»çº§åˆ«==</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/74461B8919624E67A96DD8B617151680.jpg" alt="image"></p><ul><li>è¯»å·²æäº¤</li></ul><ol><li><p>æ‰“å¼€ä¸€ä¸ªå®¢æˆ·ç«¯Aï¼Œå¹¶è®¾ç½®å½“å‰äº‹åŠ¡æ¨¡å¼ä¸ºread committedï¼ˆæœªæäº¤è¯»ï¼‰ï¼ŒæŸ¥è¯¢è¡¨accountçš„æ‰€æœ‰è®°å½•ï¼š</p><pre><code>set tx_isolation=&#39;read-committed&#39;;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/3CF7411455184AB69905A49EAE33799C.jpg" alt="image"></p></li><li><p>åœ¨å®¢æˆ·ç«¯Açš„äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œæ‰“å¼€å¦ä¸€ä¸ªå®¢æˆ·ç«¯Bï¼Œæ›´æ–°è¡¨account.</p></li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/F9521950E2204FBDAC8B87285480D4B9.jpg" alt="image"></p><ol start="3"><li>è¿™æ—¶ï¼Œå®¢æˆ·ç«¯Bçš„äº‹åŠ¡è¿˜æ²¡æäº¤ï¼Œå®¢æˆ·ç«¯Aä¸èƒ½æŸ¥è¯¢åˆ°Bå·²ç»æ›´æ–°çš„æ•°æ®ï¼Œè§£å†³äº†è„è¯»é—®é¢˜ï¼š</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/1A9DE283DA394653B31752A9AC6A7441.jpg" alt="image"></p><ol start="4"><li>å®¢æˆ·ç«¯Bçš„äº‹åŠ¡æäº¤</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/BA04776FFF0A49879D440E0ABB1CFF87.jpg" alt="image"><br>5. å®¢æˆ·ç«¯Aæ‰§è¡Œä¸ä¸Šä¸€æ­¥ç›¸åŒçš„æŸ¥è¯¢ï¼Œç»“æœ ä¸ä¸Šä¸€æ­¥ä¸ä¸€è‡´ï¼Œå³äº§ç”Ÿäº†ä¸å¯é‡å¤è¯»çš„é—®é¢˜</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/1CB8D92B7BC5412F8A9C85397AF40B51.jpg" alt="image"></p><ul><li>å¯é‡å¤è¯»</li></ul><ol><li>æ‰“å¼€ä¸€ä¸ªå®¢æˆ·ç«¯Aï¼Œå¹¶è®¾ç½®å½“å‰äº‹åŠ¡æ¨¡å¼ä¸ºrepeatable readï¼ŒæŸ¥è¯¢è¡¨accountçš„æ‰€æœ‰è®°å½•</li></ol><pre><code>set tx_isolation=&#39;repeatable-read&#39;;</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/5A48F50168B249F18207E466FC05F3DA.jpg" alt="image"></p><ol start="2"><li>åœ¨å®¢æˆ·ç«¯Açš„äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œæ‰“å¼€å¦ä¸€ä¸ªå®¢æˆ·ç«¯Bï¼Œæ›´æ–°è¡¨accountå¹¶æäº¤</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/BF5B9C07539B450BB6E35AE36C1DD2B1.jpg" alt="image"></p><ol start="3"><li>åœ¨å®¢æˆ·ç«¯AæŸ¥è¯¢è¡¨accountçš„æ‰€æœ‰è®°å½•ï¼Œä¸æ­¥éª¤ï¼ˆ1ï¼‰æŸ¥è¯¢ç»“æœä¸€è‡´ï¼Œæ²¡æœ‰å‡ºç°ä¸å¯é‡å¤è¯»çš„é—®é¢˜</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/074ED7B01BE74D57A896ABA9CDB2C19E.jpg" alt="image"></p><ol start="4"><li>åœ¨å®¢æˆ·ç«¯Aï¼Œæ¥ç€æ‰§è¡Œupdate balance = balance - 50 where id = 1ï¼Œbalanceæ²¡æœ‰å˜æˆ400-50=350ï¼Œlileiçš„balanceå€¼ç”¨çš„æ˜¯æ­¥éª¤ï¼ˆ2ï¼‰ä¸­çš„350æ¥ç®—çš„ï¼Œæ‰€ä»¥æ˜¯300ï¼Œæ•°æ®çš„ä¸€è‡´æ€§å€’æ˜¯æ²¡æœ‰è¢«ç ´åã€‚å¯é‡å¤è¯»çš„éš”ç¦»çº§åˆ«ä¸‹ä½¿ç”¨äº†MVCCæœºåˆ¶ï¼Œselectæ“ä½œä¸ä¼šæ›´æ–°ç‰ˆæœ¬å·ï¼Œæ˜¯å¿«ç…§è¯»ï¼ˆå†å²ç‰ˆæœ¬ï¼‰ï¼›insertã€updateå’Œdeleteä¼šæ›´æ–°ç‰ˆæœ¬å·ï¼Œæ˜¯å½“å‰è¯»ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰ã€‚</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/3D0CF09EA3324E4FB7CA05DD2A1E2E85.jpg" alt="image"></p><ol start="5"><li>é‡æ–°æ‰“å¼€å®¢æˆ·ç«¯Bï¼Œæ’å…¥ä¸€æ¡æ–°æ•°æ®åæäº¤</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/9F567B7BC1314EE6A95B27595003AACD.jpg" alt="image"></p><ol start="6"><li>åœ¨å®¢æˆ·ç«¯AæŸ¥è¯¢è¡¨accountçš„æ‰€æœ‰è®°å½•ï¼Œæ²¡æœ‰ æŸ¥å‡º æ–°å¢æ•°æ®ï¼Œæ‰€ä»¥æ²¡æœ‰å‡ºç°å¹»è¯»</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/7962D7EB0B33471DB68CDE7650782F1C.jpg" alt="image"> </p><ol start="7"><li>éªŒè¯å¹»è¯»<br>åœ¨å®¢æˆ·ç«¯Aæ‰§è¡Œupdate account set balance=888 where id = 4;èƒ½æ›´æ–°æˆåŠŸï¼Œå†æ¬¡æŸ¥è¯¢èƒ½æŸ¥åˆ°å®¢æˆ·ç«¯Bæ–°å¢çš„æ•°æ®.</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/DB875DCAD8124843AD598E2C2F592D94.jpg" alt="image"></p><ul><li>ä¸²è¡ŒåŒ–</li></ul><ol><li>æ‰“å¼€ä¸€ä¸ªå®¢æˆ·ç«¯Aï¼Œå¹¶è®¾ç½®å½“å‰äº‹åŠ¡æ¨¡å¼ä¸ºserializableï¼ŒæŸ¥è¯¢è¡¨accountçš„åˆå§‹å€¼ï¼š</li></ol><pre><code>set tx_isolation=&#39;serializable&#39;; mysql&gt; set session transaction isolation level serializable; Query OK, 0 rows affected (0.00 sec)  mysql&gt; start transaction; Query OK, 0 rows affected (0.00 sec)  mysql&gt; select * from account; +------+--------+---------+| id   | name   | balance |+------+--------+---------+|    1 | lilei  |   10000 ||    2 | hanmei |   10000 ||    3 | lucy   |   10000 ||    4 | lily   |   10000 |+------+--------+---------+4 rows in set (0.00 sec)</code></pre><ol start="2"><li>æ‰“å¼€ä¸€ä¸ªå®¢æˆ·ç«¯Bï¼Œå¹¶è®¾ç½®å½“å‰äº‹åŠ¡æ¨¡å¼ä¸ºserializableï¼Œæ’å…¥ä¸€æ¡è®°å½•æŠ¥é”™ï¼Œè¡¨è¢«é”äº†æ’å…¥å¤±è´¥ï¼Œmysqlä¸­äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºserializableæ—¶ä¼šé”è¡¨ï¼Œå› æ­¤ä¸ä¼šå‡ºç°å¹»è¯»çš„æƒ…å†µï¼Œè¿™ç§éš”ç¦»çº§åˆ«å¹¶å‘æ€§æä½ï¼Œå¼€å‘ä¸­å¾ˆå°‘ä¼šç”¨åˆ°ã€‚</li></ol><pre><code>mysql&gt; set session transaction isolation level serializable; Query OK, 0 rows affected (0.00 sec)  mysql&gt; start transaction; Query OK, 0 rows affected (0.00 sec) mysql&gt; insert into account values(5,&#39;tom&#39;,0); ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</code></pre><ol start="3"><li>Mysqlé»˜è®¤çº§åˆ«æ˜¯repeatable-readï¼Œæœ‰åŠæ³•è§£å†³å¹»è¯»é—®é¢˜å—ï¼Ÿ</li></ol><p>é—´éš™é”åœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥è§£å†³å¹»è¯»é—®é¢˜, è¦é¿å…å¹»è¯»å¯ä»¥ç”¨é—´éš™é”åœ¨Session_1ä¸‹é¢æ‰§è¡Œ</p><pre><code>update account set name = &#39;zhuge&#39; where id &gt; 10 and id &lt;=20;</code></pre><p>åˆ™å…¶ä»–Sessionæ²¡æ³•æ’å…¥è¿™ä¸ªèŒƒå›´å†…çš„æ•°æ®</p><h3 id="æ¡ˆä¾‹ç»“è®º-1"><a href="#æ¡ˆä¾‹ç»“è®º-1" class="headerlink" title="æ¡ˆä¾‹ç»“è®º"></a>æ¡ˆä¾‹ç»“è®º</h3><p>Innodbå­˜å‚¨å¼•æ“ç”±äºå®ç°äº†è¡Œçº§é”å®šï¼Œè™½ç„¶åœ¨é”å®šæœºåˆ¶çš„å®ç°æ–¹é¢æ‰€å¸¦æ¥çš„æ€§èƒ½æŸè€—å¯èƒ½æ¯”è¡¨çº§é”å®šä¼šè¦æ›´é«˜ä¸€ä¸‹ï¼Œä½†æ˜¯åœ¨æ•´ä½“å¹¶å‘å¤„ç†èƒ½åŠ›æ–¹é¢è¦è¿œè¿œä¼˜äºMYISAMçš„è¡¨çº§é”å®šçš„ã€‚å½“ç³»ç»Ÿå¹¶å‘é‡é«˜çš„æ—¶å€™ï¼ŒInnodbçš„æ•´ä½“æ€§èƒ½å’ŒMYISAMç›¸æ¯”å°±ä¼šæœ‰æ¯”è¾ƒæ˜æ˜¾çš„ä¼˜åŠ¿äº†ã€‚</p><p>ä½†æ˜¯ï¼ŒInnodbçš„è¡Œçº§é”å®šåŒæ ·ä¹Ÿæœ‰å…¶è„†å¼±çš„ä¸€é¢ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ä¸å½“çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šè®©Innodbçš„æ•´ä½“æ€§èƒ½è¡¨ç°ä¸ä»…ä¸èƒ½æ¯”MYISAMé«˜ï¼Œç”šè‡³å¯èƒ½ä¼šæ›´å·®ã€‚</p><h3 id="è¡Œé”åˆ†æ"><a href="#è¡Œé”åˆ†æ" class="headerlink" title="è¡Œé”åˆ†æ"></a>è¡Œé”åˆ†æ</h3><p>é€šè¿‡æ£€æŸ¥InnoDB_row_lockçŠ¶æ€å˜é‡æ¥åˆ†æç³»ç»Ÿä¸Šçš„è¡Œé”çš„äº‰å¤ºæƒ…å†µ</p><pre><code>show status like&#39;innodb_row_lock%&#39;;</code></pre><p>å¯¹å„ä¸ªçŠ¶æ€é‡çš„è¯´æ˜å¦‚ä¸‹ï¼š</p><blockquote><p>Innodb_row_lock_current_waits: å½“å‰æ­£åœ¨ç­‰å¾…é”å®šçš„æ•°é‡</p><p>Innodb_row_lock_time: ä»ç³»ç»Ÿå¯åŠ¨åˆ°ç°åœ¨é”å®šæ€»æ—¶é—´é•¿åº¦</p><p>Innodb_row_lock_time_avg: æ¯æ¬¡ç­‰å¾…æ‰€èŠ±å¹³å‡æ—¶é—´</p><p>Innodb_row_lock_time_maxï¼šä»ç³»ç»Ÿå¯åŠ¨åˆ°ç°åœ¨ç­‰å¾…æœ€é•¿çš„ä¸€æ¬¡æ‰€èŠ±æ—¶é—´</p><p>Innodb_row_lock_waits:ç³»ç»Ÿå¯åŠ¨ååˆ°ç°åœ¨æ€»å…±ç­‰å¾…çš„æ¬¡æ•°</p><p>å¯¹äºè¿™5ä¸ªçŠ¶æ€å˜é‡ï¼Œæ¯”è¾ƒé‡è¦çš„ä¸»è¦æ˜¯ï¼š</p><p>Innodb_row_lock_time_avg ï¼ˆç­‰å¾…å¹³å‡æ—¶é•¿ï¼‰</p><p>Innodb_row_lock_waits ï¼ˆç­‰å¾…æ€»æ¬¡æ•°ï¼‰</p><p>Innodb_row_lock_timeï¼ˆç­‰å¾…æ€»æ—¶é•¿ï¼‰</p></blockquote><p>å°¤å…¶æ˜¯å½“ç­‰å¾…æ¬¡æ•°å¾ˆé«˜ï¼Œè€Œä¸”æ¯æ¬¡ç­‰å¾…æ—¶é•¿ä¹Ÿä¸å°çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦åˆ†æç³»ç»Ÿä¸­ä¸ºä»€ä¹ˆä¼šæœ‰å¦‚æ­¤å¤šçš„ç­‰å¾…ï¼Œç„¶åæ ¹æ®åˆ†æç»“æœç€æ‰‹åˆ¶å®šä¼˜åŒ–è®¡åˆ’ã€‚</p><h2 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h2><pre><code>set tx_isolation=&#39;repeatable-read&#39;;Session_1æ‰§è¡Œï¼šselect * from account where id=1 for update;Session_2æ‰§è¡Œï¼šselect * from account where id=2 for update;Session_1æ‰§è¡Œï¼šselect * from account where id=2 for update;Session_2æ‰§è¡Œï¼šselect * from account where id=1 for update;</code></pre><p>æŸ¥çœ‹è¿‘æœŸæ­»é”æ—¥å¿—ä¿¡æ¯ï¼š</p><pre><code>show engine innodb status; </code></pre><p>å¤§å¤šæ•°æƒ…å†µmysqlå¯ä»¥è‡ªåŠ¨æ£€æµ‹æ­»é”å¹¶å›æ»šäº§ç”Ÿæ­»é”çš„é‚£ä¸ªäº‹åŠ¡ï¼Œä½†æ˜¯æœ‰äº›æƒ…å†µmysqlæ²¡æ³•è‡ªåŠ¨æ£€æµ‹æ­»é”</p><h1 id="ä¸‰ã€å…³äºé”çš„ä¼˜åŒ–å»ºè®®"><a href="#ä¸‰ã€å…³äºé”çš„ä¼˜åŒ–å»ºè®®" class="headerlink" title="ä¸‰ã€å…³äºé”çš„ä¼˜åŒ–å»ºè®®"></a>ä¸‰ã€å…³äºé”çš„ä¼˜åŒ–å»ºè®®</h1><ol><li>å°½å¯èƒ½è®©æ‰€æœ‰æ•°æ®æ£€ç´¢éƒ½é€šè¿‡ç´¢å¼•æ¥å®Œæˆï¼Œé¿å…æ— ç´¢å¼•è¡Œé”å‡çº§ä¸ºè¡¨é”</li><li>åˆç†è®¾è®¡ç´¢å¼•ï¼Œå°½é‡ç¼©å°é”çš„èŒƒå›´</li><li>å°½å¯èƒ½å‡å°‘æ£€ç´¢æ¡ä»¶ï¼Œé¿å…é—´éš™é”</li><li>å°½é‡æ§åˆ¶äº‹åŠ¡å¤§å°ï¼Œå‡å°‘é”å®šèµ„æºé‡å’Œæ—¶é—´é•¿åº¦</li><li>å°½å¯èƒ½ä½çº§åˆ«äº‹åŠ¡éš”ç¦»</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ä¸€ã€æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#ä¸€ã€æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€æ¦‚è¿°&quot;&gt;&lt;/a&gt;ä¸€ã€æ¦‚è¿°&lt;/h1&gt;&lt;h2 id=&quot;å®šä¹‰&quot;&gt;&lt;a href=&quot;#å®šä¹‰&quot; class=&quot;headerlink&quot; title=&quot;å®šä¹‰&quot;&gt;&lt;/a&gt;å®šä¹‰&lt;/h2&gt;&lt;p&gt;é”æ˜¯è®¡ç®—æœºåè°ƒå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹å¹¶å‘è®¿é—®æŸä¸€èµ„æºçš„æœºåˆ¶ã€‚&lt;br&gt;åœ¨æ•°æ®åº“ä¸­ï¼Œé™¤äº†ä¼ ç»Ÿçš„è®¡ç®—èµ„æºï¼ˆå¦‚CPUã€RAMã€I/Oç­‰ï¼‰çš„äº‰ç”¨ä»¥å¤–ï¼Œæ•°æ®ä¹Ÿæ˜¯ä¸€ç§ä¾›éœ€è¦ç”¨æˆ·å…±äº«çš„èµ„æºã€‚å¦‚ä½•ä¿è¯æ•°æ®å¹¶å‘è®¿é—®çš„ä¸€è‡´æ€§ã€æœ‰æ•ˆæ€§æ˜¯æ‰€æœ‰æ•°æ®åº“å¿…é¡»è§£å†³çš„ä¸€ä¸ªé—®é¢˜ï¼Œé”å†²çªä¹Ÿæ˜¯å½±å“æ•°æ®åº“å¹¶å‘è®¿é—®æ€§èƒ½çš„ä¸€ä¸ªé‡è¦å› ç´ ã€‚ä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œé”å¯¹æ•°æ®åº“è€Œè¨€æ˜¾å¾—å°¤å…¶é‡è¦ï¼Œä¹Ÿæ›´åŠ å¤æ‚ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="æ•°æ®åº“" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="mysql" scheme="https://brokge.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>çº¿ç¨‹é€šä¿¡çš„æ–¹å¼</title>
    <link href="https://brokge.github.io/2020/07/31/%E7%BA%BF%E7%A8%8B%E9%80%9A%E4%BF%A1%E7%9A%84%E6%96%B9%E5%BC%8F/"/>
    <id>https://brokge.github.io/2020/07/31/çº¿ç¨‹é€šä¿¡çš„æ–¹å¼/</id>
    <published>2020-07-31T09:49:53.000Z</published>
    <updated>2020-08-21T04:40:32.285Z</updated>
    
    <content type="html"><![CDATA[<p>çº¿ç¨‹é€šä¿¡ä¹Ÿå°±æ˜¯çº¿ç¨‹ä¹‹é—´çš„åä½œæ–¹å¼ã€‚</p><a id="more"></a><h1 id="1-çº¿ç¨‹åä½œçš„æ–¹å¼"><a href="#1-çº¿ç¨‹åä½œçš„æ–¹å¼" class="headerlink" title="1. çº¿ç¨‹åä½œçš„æ–¹å¼"></a>1. çº¿ç¨‹åä½œçš„æ–¹å¼</h1><p>è¦æƒ³å®ç°å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡åä½œ<br>å¦‚ï¼š çº¿ç¨‹æ‰§è¡Œçš„å…ˆåé¡ºåºã€è·å–æŸä¸ªçº¿ç¨‹æ‰§è¡Œçš„ç»“æœç­‰ã€‚</p><p>æ¶‰åŠåˆ°çº¿ç¨‹ä¹‹é—´çš„ç›¸äº’é€šä¿¡/åä½œï¼Œå¯ä»¥åˆ†ä¸º ä»¥ä¸‹å››ç±»ï¼š</p><ol><li><p>æ–‡ä»¶å…±äº«</p></li><li><p>ç½‘ç»œå…±äº«</p></li><li><p>å…±äº«å˜é‡</p></li><li><p>JDK æä¾›çš„çº¿ç¨‹ååŒ API </p><ol><li>suppend/resume  (å·²ç»å¼ƒç”¨)</li><li>wait/notify</li><li>park/unpark</li></ol></li><li><p>ç®¡é“é€šä¿¡</p></li></ol><p>ä¸‹é¢ä¸»è¦é’ˆå¯¹ å…±äº«å˜é‡ å’Œ JDK æä¾›çš„çº¿ç¨‹åä½œ API æ¥åšä¸ªæ¢³ç†ã€‚</p><h1 id="2-å…±äº«å˜é‡"><a href="#2-å…±äº«å˜é‡" class="headerlink" title="2. å…±äº«å˜é‡"></a>2. å…±äº«å˜é‡</h1><p>æ‰€è°“å…±äº«å˜é‡ï¼Œå³é€šè¿‡ä¸€ä¸ªçº¿ç¨‹ä¹‹é—´å¯ä»¥å…±äº«çš„å˜é‡æ¥è¾¾åˆ°çº¿ç¨‹ä¹‹é—´é€šä¿¡çš„ç›®çš„ã€‚</p><p>æ ¹æ® JVM çš„ç‰¹æ€§ï¼Œçº¿ç¨‹ä¹‹é—´èƒ½å¤Ÿå…±äº«çš„å˜é‡æ–¹å¼ï¼Œå³ é™æ€å˜é‡ã€‚</p><h2 id="å…±äº«å˜é‡ä»£ç ç¤ºä¾‹"><a href="#å…±äº«å˜é‡ä»£ç ç¤ºä¾‹" class="headerlink" title="å…±äº«å˜é‡ä»£ç ç¤ºä¾‹"></a>å…±äº«å˜é‡ä»£ç ç¤ºä¾‹</h2><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>study<span class="token punctuation">.</span>hc<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>chapter1<span class="token punctuation">.</span>thread<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainTest</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// å®šä¹‰å…±äº«å˜é‡</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> String content <span class="token operator">=</span> <span class="token string">"ç©º"</span><span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// çº¿ç¨‹1 - å†™å…¥æ•°æ®</span>    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          content <span class="token operator">=</span> <span class="token string">"å½“å‰æ—¶é—´"</span> <span class="token operator">+</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>1000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// çº¿ç¨‹2 - è¯»å–æ•°æ®</span>    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>1000L<span class="token punctuation">)</span><span class="token punctuation">;</span>          System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çº¿ç¨‹ 1 å¯¹é™æ€å˜é‡ content åšæ›´æ”¹ï¼Œåˆ™ çº¿ç¨‹ 2 å¯ä»¥è®¿é—®æ›´æ”¹è¿‡çš„å€¼ã€‚</p><h1 id="3-JDK-æä¾›çš„çº¿ç¨‹ååŒ-API"><a href="#3-JDK-æä¾›çš„çº¿ç¨‹ååŒ-API" class="headerlink" title="3. JDK æä¾›çš„çº¿ç¨‹ååŒ API"></a>3. JDK æä¾›çš„çº¿ç¨‹ååŒ API</h1><p>JDK ä¸­å¯¹äºéœ€è¦å¤šçº¿ç¨‹åä½œå®ŒæˆæŸä¸€ä»»åŠ¡çš„åœºæ™¯ï¼Œæä¾›äº†å¯¹åº”çš„ API æ”¯æŒã€‚å¤šçº¿ç¨‹åä½œçš„å…¸å‹åœºæ™¯æ˜¯ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ã€‚ï¼ˆçº¿ç¨‹é˜»å¡ã€çº¿ç¨‹å”¤é†’ï¼‰ã€‚</p><p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªåœºæ™¯æ¥çœ‹ jdk æä¾›çš„çº¿ç¨‹ååŒ api å¹¶åšä¸ªå¯¹æ¯”ã€‚</p><p>åœºæ™¯æ˜¯è¿™æ ·å­ï¼š</p><blockquote><p>çº¿ç¨‹-1 å»ä¹°åŒ…å­ï¼Œæ²¡æœ‰åŒ…å­ï¼Œåˆ™ä¸å†æ‰§è¡Œã€‚çº¿ç¨‹-2 ç”Ÿäº§åŒ…å­ï¼Œé€šçŸ¥çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œçº¿ç¨‹1æ”¶åˆ°é€šçŸ¥ç»§ç»­ä¹°åŒ…å­ã€‚</p></blockquote><p>æµç¨‹å›¾å¦‚ä¸‹</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/C7A478DEEB2D4E9482227967CCCA941E.jpg" alt="image"></p><h2 id="3-1-suspend-resume"><a href="#3-1-suspend-resume" class="headerlink" title="3.1 suspend/resume"></a>3.1 suspend/resume</h2><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo6</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/** åŒ…å­åº— */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Object baozidian <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/** æ­£å¸¸çš„suspend/resume */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">suspendResumeTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨çº¿ç¨‹</span>        Thread consumerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>baozidian <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// å¦‚æœæ²¡åŒ…å­ï¼Œåˆ™è¿›å…¥ç­‰å¾…</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1ã€è¿›å…¥ç­‰å¾…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3ã€ä¹°åˆ°åŒ…å­ï¼Œå›å®¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        consumerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3ç§’ä¹‹åï¼Œç”Ÿäº§ä¸€ä¸ªåŒ…å­</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>3000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        baozidian <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        consumerThread<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2ã€é€šçŸ¥æ¶ˆè´¹è€…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ consumerThread è´­ä¹°åŒ…å­ï¼Œå¦‚æœæ²¡åŒ…å­ï¼Œåˆ™è¿›å…¥ç­‰å¾… è°ƒç”¨ <code>suspend()</code>,ä¸»çº¿ç¨‹ 3ç§’ä¹‹åç”Ÿäº§ä¸€ä¸ªåŒ…å­ï¼Œç„¶åå”¤é†’å…¶ä»–çº¿ç¨‹<code>resume()</code>ã€‚consumerThread è¢«å”¤é†’ç»§ç»­æ‰§è¡Œ <code>3ã€ä¹°åˆ°åŒ…å­ï¼Œå›å®¶</code>ã€‚</p><p>æŒ‰ç…§æ­£å¸¸é€»è¾‘ä»¥ä¸Šä»£ç æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœæ˜¯ä»¥ä¸‹æ–¹å¼å‘¢ï¼Ÿ</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/** æ­»é”çš„suspend/resumeã€‚ suspendå¹¶ä¸ä¼šåƒwaitä¸€æ ·é‡Šæ”¾é”ï¼Œæ•…æ­¤å®¹æ˜“å†™å‡ºæ­»é”ä»£ç  */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">suspendResumeDeadLockTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨çº¿ç¨‹</span>        Thread consumerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>baozidian <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// å¦‚æœæ²¡åŒ…å­ï¼Œåˆ™è¿›å…¥ç­‰å¾…</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1ã€è¿›å…¥ç­‰å¾…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// å½“å‰çº¿ç¨‹æ‹¿åˆ°é”ï¼Œç„¶åæŒ‚èµ·</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3ã€ä¹°åˆ°åŒ…å­ï¼Œå›å®¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        consumerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3ç§’ä¹‹åï¼Œç”Ÿäº§ä¸€ä¸ªåŒ…å­</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>3000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        baozidian <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// äº‰å–åˆ°é”ä»¥åï¼Œå†æ¢å¤consumerThread</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            consumerThread<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2ã€é€šçŸ¥æ¶ˆè´¹è€…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/** å¯¼è‡´ç¨‹åºæ°¸ä¹…æŒ‚èµ·çš„suspend/resume */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">suspendResumeDeadLockTest2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨çº¿ç¨‹</span>        Thread consumerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>baozidian <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1ã€æ²¡åŒ…å­ï¼Œè¿›å…¥ç­‰å¾…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// ä¸ºè¿™ä¸ªçº¿ç¨‹åŠ ä¸Šä¸€ç‚¹å»¶æ—¶</span>                    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>5000L<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// è¿™é‡Œçš„æŒ‚èµ·æ‰§è¡Œåœ¨resumeåé¢</span>                Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2ã€ä¹°åˆ°åŒ…å­ï¼Œå›å®¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        consumerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3ç§’ä¹‹åï¼Œç”Ÿäº§ä¸€ä¸ªåŒ…å­</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>3000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        baozidian <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        consumerThread<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3ã€é€šçŸ¥æ¶ˆè´¹è€…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        consumerThread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»¥ä¸Šä¸¤ç§æ–¹å¼éƒ½æ˜¯æ­»é”çš„å†™æ³•ã€‚</p><ul><li>suspendResumeDeadLockTest å†™æ³•ä¸­ suspend å¹¶ä¸é‡Šæ”¾é”ï¼Œä¸€ç›´æŒæœ‰é”ï¼Œå¯¼è‡´ä¸»çº¿ç¨‹è·å–ä¸åˆ°é”ï¼Œä¸èƒ½æ‰§è¡Œ <code>resume()</code>å”¤é†’æ“ä½œï¼Œ æ•…æ­¤å®¹æ˜“å†™å‡ºæ­»é”ä»£ç  ã€‚</li><li>suspendResumeDeadLockTest2 å†™æ³•ç§ï¼Œç”±äºçº¿ç¨‹ä¼‘çœ çš„é—®é¢˜ï¼Œå¯¼è‡´<code>resume()</code> å† <code>suspend()</code>ä¹‹å‰è°ƒç”¨ï¼Œç”±äºåç»­æ²¡æœ‰è°ƒç”¨ <code>resume()</code>çš„æ“ä½œï¼Œå¯¼è‡´æ­»é”ã€‚</li></ul><h2 id="3-2-notify-wait"><a href="#3-2-notify-wait" class="headerlink" title="3.2 notify/wait"></a>3.2 notify/wait</h2><p>notify / wait å¿…é¡»å† synchronized ä»£ç å—ä¸­æ‰ä¼šæœ‰æ•ˆï¼Œè€Œä¸” <code>wait</code> å’Œ <code>notify()</code> è°ƒç”¨ä¹‹åä¼šè‡ªåŠ¨é‡Šæ”¾æŒæœ‰çš„é”ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** æ­£å¸¸çš„wait/notify */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">waitNotifyTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨çº¿ç¨‹</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">while</span> <span class="token punctuation">(</span>baozidian <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// å¦‚æœæ²¡åŒ…å­ï¼Œåˆ™è¿›å…¥ç­‰å¾…</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1ã€è¿›å…¥ç­‰å¾…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3ã€ä¹°åˆ°åŒ…å­ï¼Œå›å®¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3ç§’ä¹‹åï¼Œç”Ÿäº§ä¸€ä¸ªåŒ…å­</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>3000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        baozidian <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2ã€é€šçŸ¥æ¶ˆè´¹è€…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†æ˜¯ä¹Ÿä¼šå†™å‡ºæ­»é”çš„ä»£ç ï¼Œæ¯”å¦‚ä»¥ä¸‹å†™æ³•ï¼š</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/** ä¼šå¯¼è‡´ç¨‹åºæ°¸ä¹…ç­‰å¾…çš„wait/notify */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">waitNotifyDeadLockTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨çº¿ç¨‹</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>baozidian <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// å¦‚æœæ²¡åŒ…å­ï¼Œåˆ™è¿›å…¥ç­‰å¾…</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>5000L<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e1<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1ã€è¿›å…¥ç­‰å¾…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3ã€ä¹°åˆ°åŒ…å­ï¼Œå›å®¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3ç§’ä¹‹åï¼Œç”Ÿäº§ä¸€ä¸ªåŒ…å­</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>3000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        baozidian <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2ã€é€šçŸ¥æ¶ˆè´¹è€…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è™½ç„¶ <code>wait()</code> ä¼šè‡ªåŠ¨è§£é”ï¼Œä½†æ˜¯å¯¹é¡ºåºæœ‰è¦æ±‚ã€‚ å¦‚æœ <code>wait()</code> æ–¹æ³•ï¼Œæ˜¯åœ¨ <code>notify</code> ä¹‹åè°ƒç”¨ï¼Œåˆ™çº¿ç¨‹ä¼šæ°¸è¿œå¤„äº <code>waitting</code> çŠ¶æ€ã€‚</p><h2 id="3-3-park-unpark"><a href="#3-3-park-unpark" class="headerlink" title="3.3 park/unpark"></a>3.3 park/unpark</h2><p><code>park</code> æ˜¯ç­‰å¾…è®¸å¯ï¼Œ<code>unpark</code> æ˜¯ä¸ºæŒ‡å®šçº¿ç¨‹æä¾›è®¸å¯ï¼Œä»–çš„ä¸»è¦ç‰¹æ€§å°±æ˜¯å¯¹é¡ºåºæ²¡æœ‰è¦æ±‚ï¼Œè°ƒç”¨<code>park</code>æ—¶å€™ï¼Œå¦‚æœè°ƒç”¨è¿‡ <code>unpark</code> åˆ™ï¼Œçº¿ç¨‹ç›´æ¥æ‰§è¡Œã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** æ­£å¸¸çš„park/unpark */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parkUnparkTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨çº¿ç¨‹</span>        Thread consumerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>baozidian <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// å¦‚æœæ²¡åŒ…å­ï¼Œåˆ™è¿›å…¥ç­‰å¾…</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1ã€è¿›å…¥ç­‰å¾…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                LockSupport<span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2ã€ä¹°åˆ°åŒ…å­ï¼Œå›å®¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        consumerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3ç§’ä¹‹åï¼Œç”Ÿäº§ä¸€ä¸ªåŒ…å­</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>3000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        baozidian <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        LockSupport<span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>consumerThread<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3ã€é€šçŸ¥æ¶ˆè´¹è€…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†æ˜¯ <code>unpark</code> è°ƒç”¨ä¹‹åï¼Œè®¸å¯åªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚å³åªè¦è°ƒä¸€æ¬¡parkï¼Œåˆ™è®¸å¯å°±ä¼šå¤±æ•ˆã€‚åç»­è°ƒç”¨ <code>park</code>ï¼Œåˆ™è¯¥çº¿ç¨‹ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/** æ­»é”çš„park/unpark */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parkUnparkDeadLockTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨çº¿ç¨‹</span>        Thread consumerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>baozidian <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// å¦‚æœæ²¡åŒ…å­ï¼Œåˆ™è¿›å…¥ç­‰å¾…</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1ã€è¿›å…¥ç­‰å¾…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// å½“å‰çº¿ç¨‹æ‹¿åˆ°é”ï¼Œç„¶åæŒ‚èµ·</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    LockSupport<span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3ã€ä¹°åˆ°åŒ…å­ï¼Œå›å®¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        consumerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3ç§’ä¹‹åï¼Œç”Ÿäº§ä¸€ä¸ªåŒ…å­</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>3000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        baozidian <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// äº‰å–åˆ°é”ä»¥åï¼Œå†æ¢å¤consumerThread</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            LockSupport<span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>consumerThread<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2ã€é€šçŸ¥æ¶ˆè´¹è€…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-4-æ‰€æœ‰ä»£ç "><a href="#3-4-æ‰€æœ‰ä»£ç " class="headerlink" title="3.4 æ‰€æœ‰ä»£ç "></a>3.4 æ‰€æœ‰ä»£ç </h2><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>study<span class="token punctuation">.</span>hc<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>chapter1<span class="token punctuation">.</span>thread<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span>LockSupport<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** ä¸‰ç§çº¿ç¨‹åä½œé€šä¿¡çš„æ–¹å¼ï¼šsuspend/resumeã€wait/notifyã€park/unpark */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo6</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/** åŒ…å­åº— */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Object baozidian <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/** æ­£å¸¸çš„suspend/resume */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">suspendResumeTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨çº¿ç¨‹</span>        Thread consumerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>baozidian <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// å¦‚æœæ²¡åŒ…å­ï¼Œåˆ™è¿›å…¥ç­‰å¾…</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1ã€è¿›å…¥ç­‰å¾…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2ã€ä¹°åˆ°åŒ…å­ï¼Œå›å®¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        consumerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3ç§’ä¹‹åï¼Œç”Ÿäº§ä¸€ä¸ªåŒ…å­</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>3000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        baozidian <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        consumerThread<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3ã€é€šçŸ¥æ¶ˆè´¹è€…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/** æ­»é”çš„suspend/resumeã€‚ suspendå¹¶ä¸ä¼šåƒwaitä¸€æ ·é‡Šæ”¾é”ï¼Œæ•…æ­¤å®¹æ˜“å†™å‡ºæ­»é”ä»£ç  */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">suspendResumeDeadLockTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨çº¿ç¨‹</span>        Thread consumerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>baozidian <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// å¦‚æœæ²¡åŒ…å­ï¼Œåˆ™è¿›å…¥ç­‰å¾…</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1ã€è¿›å…¥ç­‰å¾…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// å½“å‰çº¿ç¨‹æ‹¿åˆ°é”ï¼Œç„¶åæŒ‚èµ·</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2ã€ä¹°åˆ°åŒ…å­ï¼Œå›å®¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        consumerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3ç§’ä¹‹åï¼Œç”Ÿäº§ä¸€ä¸ªåŒ…å­</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>3000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        baozidian <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// äº‰å–åˆ°é”ä»¥åï¼Œå†æ¢å¤consumerThread</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            consumerThread<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3ã€é€šçŸ¥æ¶ˆè´¹è€…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/** å¯¼è‡´ç¨‹åºæ°¸ä¹…æŒ‚èµ·çš„suspend/resume */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">suspendResumeDeadLockTest2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨çº¿ç¨‹</span>        Thread consumerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>baozidian <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1ã€æ²¡åŒ…å­ï¼Œè¿›å…¥ç­‰å¾…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// ä¸ºè¿™ä¸ªçº¿ç¨‹åŠ ä¸Šä¸€ç‚¹å»¶æ—¶</span>                    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>5000L<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// è¿™é‡Œçš„æŒ‚èµ·æ‰§è¡Œåœ¨resumeåé¢</span>                Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2ã€ä¹°åˆ°åŒ…å­ï¼Œå›å®¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        consumerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3ç§’ä¹‹åï¼Œç”Ÿäº§ä¸€ä¸ªåŒ…å­</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>3000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        baozidian <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        consumerThread<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3ã€é€šçŸ¥æ¶ˆè´¹è€…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        consumerThread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/** æ­£å¸¸çš„wait/notify */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">waitNotifyTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨çº¿ç¨‹</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">while</span> <span class="token punctuation">(</span>baozidian <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// å¦‚æœæ²¡åŒ…å­ï¼Œåˆ™è¿›å…¥ç­‰å¾…</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1ã€è¿›å…¥ç­‰å¾…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2ã€ä¹°åˆ°åŒ…å­ï¼Œå›å®¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3ç§’ä¹‹åï¼Œç”Ÿäº§ä¸€ä¸ªåŒ…å­</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>3000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        baozidian <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3ã€é€šçŸ¥æ¶ˆè´¹è€…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/** ä¼šå¯¼è‡´ç¨‹åºæ°¸ä¹…ç­‰å¾…çš„wait/notify */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">waitNotifyDeadLockTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨çº¿ç¨‹</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>baozidian <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// å¦‚æœæ²¡åŒ…å­ï¼Œåˆ™è¿›å…¥ç­‰å¾…</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>5000L<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e1<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1ã€è¿›å…¥ç­‰å¾…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2ã€ä¹°åˆ°åŒ…å­ï¼Œå›å®¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3ç§’ä¹‹åï¼Œç”Ÿäº§ä¸€ä¸ªåŒ…å­</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>3000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        baozidian <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3ã€é€šçŸ¥æ¶ˆè´¹è€…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/** æ­£å¸¸çš„park/unpark */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parkUnparkTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨çº¿ç¨‹</span>        Thread consumerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>baozidian <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// å¦‚æœæ²¡åŒ…å­ï¼Œåˆ™è¿›å…¥ç­‰å¾…</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1ã€è¿›å…¥ç­‰å¾…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                LockSupport<span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2ã€ä¹°åˆ°åŒ…å­ï¼Œå›å®¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        consumerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3ç§’ä¹‹åï¼Œç”Ÿäº§ä¸€ä¸ªåŒ…å­</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>3000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        baozidian <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        LockSupport<span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>consumerThread<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3ã€é€šçŸ¥æ¶ˆè´¹è€…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/** æ­»é”çš„park/unpark */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parkUnparkDeadLockTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨çº¿ç¨‹</span>        Thread consumerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>baozidian <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// å¦‚æœæ²¡åŒ…å­ï¼Œåˆ™è¿›å…¥ç­‰å¾…</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1ã€è¿›å…¥ç­‰å¾…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// å½“å‰çº¿ç¨‹æ‹¿åˆ°é”ï¼Œç„¶åæŒ‚èµ·</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    LockSupport<span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2ã€ä¹°åˆ°åŒ…å­ï¼Œå›å®¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        consumerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3ç§’ä¹‹åï¼Œç”Ÿäº§ä¸€ä¸ªåŒ…å­</span>        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>3000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        baozidian <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// äº‰å–åˆ°é”ä»¥åï¼Œå†æ¢å¤consumerThread</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            LockSupport<span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>consumerThread<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3ã€é€šçŸ¥æ¶ˆè´¹è€…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¯¹è°ƒç”¨é¡ºåºæœ‰è¦æ±‚ï¼Œä¹Ÿè¦å¼€å‘è‡ªå·±æ³¨æ„é”çš„é‡Šæ”¾ã€‚è¿™ä¸ªè¢«å¼ƒç”¨çš„APIï¼Œ å®¹æ˜“æ­»é”ï¼Œä¹Ÿå®¹æ˜“å¯¼è‡´æ°¸ä¹…æŒ‚èµ·ã€‚</span><span class="token comment" spellcheck="true">//         new Demo6().suspendResumeTest();</span><span class="token comment" spellcheck="true">//         new Demo6().suspendResumeDeadLockTest();</span><span class="token comment" spellcheck="true">//         new Demo6().suspendResumeDeadLockTest2();</span>        <span class="token comment" spellcheck="true">// wait/notifyè¦æ±‚å†åŒæ­¥å…³é”®å­—é‡Œé¢ä½¿ç”¨ï¼Œå…å»äº†æ­»é”çš„å›°æ‰°ï¼Œä½†æ˜¯ä¸€å®šè¦å…ˆè°ƒç”¨waitï¼Œå†è°ƒç”¨notifyï¼Œå¦åˆ™æ°¸ä¹…ç­‰å¾…äº†</span>        <span class="token comment" spellcheck="true">// new Demo6().waitNotifyTest();</span><span class="token comment" spellcheck="true">//         new Demo6().waitNotifyDeadLockTest();</span>        <span class="token comment" spellcheck="true">// park/unparkæ²¡æœ‰é¡ºåºè¦æ±‚ï¼Œä½†æ˜¯parkå¹¶ä¸ä¼šé‡Šæ”¾é”ï¼Œæ‰€æœ‰å†åŒæ­¥ä»£ç ä¸­ä½¿ç”¨è¦æ³¨æ„</span><span class="token comment" spellcheck="true">//         new Demo6().parkUnparkTest();</span>         <span class="token keyword">new</span> <span class="token class-name">Demo6</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parkUnparkDeadLockTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="4-æ€»ç»“"><a href="#4-æ€»ç»“" class="headerlink" title="4. æ€»ç»“"></a>4. æ€»ç»“</h1><ol><li><p><strong>suspend å’Œ resume</strong> å®¹æ˜“å†™å‡ºæ­»é”ä»£ç æ‰€ä»¥è¢«å¼ƒç”¨ï¼Œå¯¼è‡´æ­»é”çš„åŸå› ï¼š suspend æŒ‚èµ·ä¹‹åä¸ä¼šé‡Šæ”¾é”ï¼›suspend å’Œ resume å…ˆåé¡ºåºä¸ä¿è¯ã€‚</p></li><li><p><strong>wait å’Œ notify</strong>ã€‚åªèƒ½ç”±åŒä¸€å¯¹è±¡é”çš„æŒæœ‰è€…çº¿ç¨‹è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´å†™åœ¨ä»£ç åŒæ­¥å—é‡Œï¼Œå¦åˆ™ä¼šæŠ›å‡º IllegalMonitorStateException å¼‚å¸¸ã€‚wait æ–¹æ³•å¯¼è‡´å½“å‰çº¿ç¨‹ç­‰å¾…ï¼ŒåŠ å…¥è¯¥å¯¹è±¡çš„ç­‰å¾…é›†åˆä¸­ï¼Œå¹¶ä¸” æ”¾å¼ƒå½“å‰æŒæœ‰çš„å¯¹è±¡é”ã€‚notify å’Œ notifyAll æ–¹æ³•å”¤é†’ä¸€ä¸ªæˆ–æ‰€æœ‰æ­£åœ¨ç­‰å¾…è¿™ä¸ªå¯¹è±¡é”çš„çº¿ç¨‹ã€‚</p><blockquote><p>æ³¨æ„ï¼šè™½ç„¶  wait ä¼šè‡ªåŠ¨è§£é”ï¼Œä½†æ˜¯å¯¹é¡ºåºæœ‰è¦æ±‚ã€‚ å¦‚æœ wait æ–¹æ³•ï¼Œæ˜¯åœ¨ notify ä¹‹åè°ƒç”¨ï¼Œåˆ™çº¿ç¨‹ä¼šæ°¸è¿œå¤„äº waitting çŠ¶æ€ã€‚</p></blockquote></li><li><p><strong>park / unpark</strong> park æ˜¯ç­‰å¾…è®¸å¯ï¼Œunpark æ˜¯ä¸ºæŒ‡å®šçº¿ç¨‹æä¾›è®¸å¯ï¼Œå¯¹é¡ºåºæ²¡æœ‰è¦æ±‚ï¼Œè°ƒç”¨parkæ—¶å€™ï¼Œå¦‚æœè°ƒç”¨è¿‡ unpark åˆ™ï¼Œçº¿ç¨‹ç›´æ¥æ‰§è¡Œã€‚ä½†ç”±äºè®¸å¯çš„ä¸€æ¬¡æœ‰æ•ˆæ€§ï¼Œå³åªè¦è°ƒä¸€æ¬¡parkï¼Œåˆ™è®¸å¯å°±ä¼šå¤±æ•ˆã€‚åç»­è°ƒç”¨parkï¼Œåˆ™è¯¥çº¿ç¨‹ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p></li></ol><p><strong>ä¼ªå”¤é†’é—®é¢˜</strong> ç”±äº jvm åœ¨å®ç°æœºåˆ¶é—®é¢˜ï¼Œé€šè¿‡ä»¥ä¸Šä¸‰ç§æ–¹å¼ä¼šå‡ºç°é”™è¯¯è­¦æŠ¥æˆ–ä¼ªå”¤é†’çš„é—®é¢˜ï¼Œè¿™æ—¶å¹¶ä¸æ˜¯çœŸæ­£çš„æ»¡è¶³æ¡ä»¶å”¤é†’ã€‚å¦‚æœ é€šè¿‡ if è¯­å¥åˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œæ¥ä½¿çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œåˆ™ä¼šä¹Ÿä¼šå‡ºç°å¼‚å¸¸æƒ…å†µã€‚</p><p>æ‰€ä»¥å»ºè®® é€šè¿‡ while å¾ªç¯çš„å†™æ³•ï¼Œç„¶åè®¾ç½® flag æ¥æ£€æµ‹çº¿ç¨‹çš„ç­‰å¾…æ¡ä»¶ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;çº¿ç¨‹é€šä¿¡ä¹Ÿå°±æ˜¯çº¿ç¨‹ä¹‹é—´çš„åä½œæ–¹å¼ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="å¹¶å‘ç¼–ç¨‹" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    
    
      <category term="Java" scheme="https://brokge.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>kafka é›†ç¾¤æ­å»º</title>
    <link href="https://brokge.github.io/2020/07/25/kafka-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"/>
    <id>https://brokge.github.io/2020/07/25/kafka-é›†ç¾¤æ­å»º/</id>
    <published>2020-07-25T04:30:57.000Z</published>
    <updated>2020-08-21T04:54:27.882Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-å®‰è£…å‰çš„ç¯å¢ƒå‡†å¤‡"><a href="#1-å®‰è£…å‰çš„ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1. å®‰è£…å‰çš„ç¯å¢ƒå‡†å¤‡"></a>1. å®‰è£…å‰çš„ç¯å¢ƒå‡†å¤‡</h1><p>ç”±äºKafkaæ˜¯ç”¨Scalaè¯­è¨€å¼€å‘çš„ï¼Œè¿è¡Œåœ¨JVMä¸Šï¼Œå› æ­¤åœ¨å®‰è£…Kafkaä¹‹å‰éœ€è¦å…ˆå®‰è£…JDKã€‚</p><a id="more"></a><pre><code># yum install java-1.8.0-openjdk* -y</code></pre><p>kafkaä¾èµ–zookeeperï¼Œæ‰€ä»¥éœ€è¦å…ˆå®‰è£…zookeeper</p><pre><code># wget http://mirror.bit.edu.cn/apache/zookeeper/stable/zookeeper-3.4.12.tar.gz# tar -zxvf zookeeper-3.4.12.tar.gz# cd zookeeper-3.4.12# cp conf/zoo_sample.cfg conf/zoo.cfg</code></pre><p>å¯åŠ¨zookeeper</p><pre><code># bin/zkServer.sh start# bin/zkCli.sh # ls /            #æŸ¥çœ‹zkçš„æ ¹ç›®å½•ç›¸å…³èŠ‚ç‚¹</code></pre><h1 id="2-å®‰è£…"><a href="#2-å®‰è£…" class="headerlink" title="2. å®‰è£…"></a>2. å®‰è£…</h1><h2 id="ç¬¬ä¸€æ­¥ï¼šä¸‹è½½å®‰è£…åŒ…"><a href="#ç¬¬ä¸€æ­¥ï¼šä¸‹è½½å®‰è£…åŒ…" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šä¸‹è½½å®‰è£…åŒ…"></a>ç¬¬ä¸€æ­¥ï¼šä¸‹è½½å®‰è£…åŒ…</h2><p>ä¸‹è½½1.1.0 releaseç‰ˆæœ¬ï¼Œå¹¶è§£å‹ï¼š</p><pre><code># wget https://archive.apache.org/dist/kafka/1.1.0/kafka_2.11-1.1.0.tgz# tar -xzf kafka_2.11-1.1.0.tgz# cd kafka_2.11-1.1.0</code></pre><h2 id="ç¬¬äºŒæ­¥ï¼šå¯åŠ¨æœåŠ¡"><a href="#ç¬¬äºŒæ­¥ï¼šå¯åŠ¨æœåŠ¡" class="headerlink" title="ç¬¬äºŒæ­¥ï¼šå¯åŠ¨æœåŠ¡"></a>ç¬¬äºŒæ­¥ï¼šå¯åŠ¨æœåŠ¡</h2><p>ç°åœ¨æ¥å¯åŠ¨kafkaæœåŠ¡ï¼š<br>å¯åŠ¨è„šæœ¬è¯­æ³•ï¼š</p><pre><code>kafka-server-start.sh [-daemon] server.properties</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œserver.propertiesçš„é…ç½®è·¯å¾„æ˜¯ä¸€ä¸ªå¼ºåˆ¶çš„å‚æ•°ï¼Œ-daemonè¡¨ç¤ºä»¥åå°è¿›ç¨‹è¿è¡Œï¼Œå¦åˆ™sshå®¢æˆ·ç«¯é€€å‡ºåï¼Œå°±ä¼šåœæ­¢æœåŠ¡ã€‚(æ³¨æ„ï¼Œåœ¨å¯åŠ¨kafkaæ—¶ä¼šä½¿ç”¨linuxä¸»æœºåå…³è”çš„ipåœ°å€ï¼Œæ‰€ä»¥éœ€è¦æŠŠä¸»æœºåå’Œlinuxçš„ipæ˜ å°„é…ç½®åˆ°æœ¬åœ°hosté‡Œï¼Œç”¨vim /etc/hosts)</p><pre><code># bin/kafka-server-start.sh -daemon config/server.properties</code></pre><p>æˆ‘ä»¬è¿›å…¥zookeeperç›®å½•é€šè¿‡zookeeperå®¢æˆ·ç«¯æŸ¥çœ‹ä¸‹zookeeperçš„ç›®å½•æ ‘</p><pre><code># bin/zkCli.sh # ls /            #æŸ¥çœ‹zkçš„æ ¹ç›®å½•kafkaç›¸å…³èŠ‚ç‚¹# ls /brokers/ids    #æŸ¥çœ‹kafkaèŠ‚ç‚¹</code></pre><h1 id="3-åˆ›å»ºä¸»é¢˜"><a href="#3-åˆ›å»ºä¸»é¢˜" class="headerlink" title="3. åˆ›å»ºä¸»é¢˜"></a>3. åˆ›å»ºä¸»é¢˜</h1><p>ç°åœ¨æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªåå­—ä¸ºâ€œtestâ€çš„Topicï¼Œè¿™ä¸ªtopicåªæœ‰ä¸€ä¸ªpartitionï¼Œå¹¶ä¸”å¤‡ä»½å› å­ä¹Ÿè®¾ç½®ä¸º1ï¼š</p><pre><code># bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic test</code></pre><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹kafkaä¸­ç›®å‰å­˜åœ¨çš„topic</p><pre><code># bin/kafka-topics.sh --list --zookeeper localhost:2181</code></pre><p>é™¤äº†æˆ‘ä»¬é€šè¿‡æ‰‹å·¥çš„æ–¹å¼åˆ›å»ºTopicï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®brokerï¼Œå½“producerå‘å¸ƒä¸€ä¸ªæ¶ˆæ¯æŸä¸ªæŒ‡å®šçš„Topicï¼Œä½†æ˜¯è¿™ä¸ªTopicå¹¶ä¸å­˜åœ¨æ—¶ï¼Œå°±è‡ªåŠ¨åˆ›å»ºã€‚</p><h1 id="4-å‘é€æ¶ˆæ¯"><a href="#4-å‘é€æ¶ˆæ¯" class="headerlink" title="4. å‘é€æ¶ˆæ¯"></a>4. å‘é€æ¶ˆæ¯</h1><p>kafkaè‡ªå¸¦äº†ä¸€ä¸ªproducerå‘½ä»¤å®¢æˆ·ç«¯ï¼Œå¯ä»¥ä»æœ¬åœ°æ–‡ä»¶ä¸­è¯»å–å†…å®¹ï¼Œæˆ–è€…æˆ‘ä»¬ä¹Ÿå¯ä»¥ä»¥å‘½ä»¤è¡Œä¸­ç›´æ¥è¾“å…¥å†…å®¹ï¼Œå¹¶å°†è¿™äº›å†…å®¹ä»¥æ¶ˆæ¯çš„å½¢å¼å‘é€åˆ°kafkaé›†ç¾¤ä¸­ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸€ä¸ªè¡Œä¼šè¢«å½“åšæˆä¸€ä¸ªç‹¬ç«‹çš„æ¶ˆæ¯ã€‚<br>é¦–å…ˆæˆ‘ä»¬è¦è¿è¡Œå‘å¸ƒæ¶ˆæ¯çš„è„šæœ¬ï¼Œç„¶ååœ¨å‘½ä»¤ä¸­è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯çš„å†…å®¹ï¼š</p><pre><code># bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test &gt;this is a msg&gt;this is a another msg </code></pre><h1 id="5-æ¶ˆè´¹æ¶ˆæ¯"><a href="#5-æ¶ˆè´¹æ¶ˆæ¯" class="headerlink" title="5. æ¶ˆè´¹æ¶ˆæ¯"></a>5. æ¶ˆè´¹æ¶ˆæ¯</h1><p>å¯¹äºconsumerï¼ŒkafkaåŒæ ·ä¹Ÿæºå¸¦äº†ä¸€ä¸ªå‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼Œä¼šå°†è·å–åˆ°å†…å®¹åœ¨å‘½ä»¤ä¸­è¿›è¡Œè¾“å‡ºï¼š</p><pre><code># bin/kafka-console-consumer.sh --zookeeper localhost:2181 --topic test   --from-beginning #è€ç‰ˆæœ¬# bin/kafka-console-consumer.sh --bootstrap-server localhost:9092  --consumer-property group.id=testGroup --consumer-property client.id=consumer-1  --topic test    #æ–°ç‰ˆæœ¬</code></pre><p>å¦‚æœä½ æ˜¯é€šè¿‡ä¸åŒçš„ç»ˆç«¯çª—å£æ¥è¿è¡Œä»¥ä¸Šçš„å‘½ä»¤ï¼Œä½ å°†ä¼šçœ‹åˆ°åœ¨producerç»ˆç«¯è¾“å…¥çš„å†…å®¹ï¼Œå¾ˆå¿«å°±ä¼šåœ¨consumerçš„ç»ˆç«¯çª—å£ä¸Šæ˜¾ç¤ºå‡ºæ¥ã€‚<br>ä»¥ä¸Šæ‰€æœ‰çš„å‘½ä»¤éƒ½æœ‰ä¸€äº›é™„åŠ çš„é€‰é¡¹ï¼›å½“æˆ‘ä»¬ä¸æºå¸¦ä»»ä½•å‚æ•°è¿è¡Œå‘½ä»¤çš„æ—¶å€™ï¼Œå°†ä¼šæ˜¾ç¤ºå‡ºè¿™ä¸ªå‘½ä»¤çš„è¯¦ç»†ç”¨æ³•ã€‚<br>è¿˜æœ‰ä¸€äº›å…¶ä»–å‘½ä»¤å¦‚ä¸‹ï¼š<br>æŸ¥çœ‹ç»„å</p><pre><code>#  bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --list --new-consumer</code></pre><p>æŸ¥çœ‹æ¶ˆè´¹è€…çš„æ¶ˆè´¹åç§»é‡</p><pre><code># bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --describe --group testGroup</code></pre><p>æ¶ˆè´¹å¤šä¸»é¢˜</p><pre><code># bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --whitelist &quot;test|test-2&quot;</code></pre><h2 id="5-1-å•æ’­æ¶ˆè´¹"><a href="#5-1-å•æ’­æ¶ˆè´¹" class="headerlink" title="5.1 å•æ’­æ¶ˆè´¹"></a>5.1 å•æ’­æ¶ˆè´¹</h2><p>ä¸€æ¡æ¶ˆæ¯åªèƒ½è¢«æŸä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹çš„æ¨¡å¼ï¼Œç±»ä¼¼queueæ¨¡å¼ï¼Œåªéœ€è®©æ‰€æœ‰æ¶ˆè´¹è€…åœ¨åŒä¸€ä¸ªæ¶ˆè´¹ç»„é‡Œå³å¯<br>åˆ†åˆ«åœ¨ä¸¤ä¸ªå®¢æˆ·ç«¯æ‰§è¡Œå¦‚ä¸‹æ¶ˆè´¹å‘½ä»¤ï¼Œç„¶åå¾€ä¸»é¢˜é‡Œå‘é€æ¶ˆæ¯ï¼Œç»“æœåªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½æ”¶åˆ°æ¶ˆæ¯</p><pre><code># bin/kafka-console-consumer.sh --bootstrap-server localhost:9092  --consumer-property group.id=testGroup --topic test </code></pre><h2 id="5-2-å¤šæ’­æ¶ˆè´¹"><a href="#5-2-å¤šæ’­æ¶ˆè´¹" class="headerlink" title="5.2 å¤šæ’­æ¶ˆè´¹"></a>5.2 å¤šæ’­æ¶ˆè´¹</h2><p>ä¸€æ¡æ¶ˆæ¯èƒ½è¢«å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹çš„æ¨¡å¼ï¼Œç±»ä¼¼publish-subscribeæ¨¡å¼è´¹ï¼Œé’ˆå¯¹KafkaåŒä¸€æ¡æ¶ˆæ¯åªèƒ½è¢«åŒä¸€ä¸ªæ¶ˆè´¹ç»„ä¸‹çš„æŸä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹çš„ç‰¹æ€§ï¼Œè¦å®ç°å¤šæ’­åªè¦ä¿è¯è¿™äº›æ¶ˆè´¹è€…å±äºä¸åŒçš„æ¶ˆè´¹ç»„å³å¯ã€‚æˆ‘ä»¬å†å¢åŠ ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œè¯¥æ¶ˆè´¹è€…å±äºtestGroup-2æ¶ˆè´¹ç»„ï¼Œç»“æœä¸¤ä¸ªå®¢æˆ·ç«¯éƒ½èƒ½æ”¶åˆ°æ¶ˆæ¯</p><pre><code># bin/kafka-console-consumer.sh --bootstrap-server localhost:9092  --consumer-property group.id=testGroup-2 --topic test </code></pre><h1 id="6-kafkaé›†ç¾¤é…ç½®"><a href="#6-kafkaé›†ç¾¤é…ç½®" class="headerlink" title="6. kafkaé›†ç¾¤é…ç½®"></a>6. kafkaé›†ç¾¤é…ç½®</h1><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬éƒ½æ˜¯åœ¨ä¸€ä¸ªå•èŠ‚ç‚¹ä¸Šè¿è¡Œbrokerï¼Œè¿™å¹¶æ²¡æœ‰ä»€ä¹ˆæ„æ€ã€‚å¯¹äºkafkaæ¥è¯´ï¼Œä¸€ä¸ªå•ç‹¬çš„brokeræ„å‘³ç€kafkaé›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ªæ¥ç‚¹ã€‚è¦æƒ³å¢åŠ kafkaé›†ç¾¤ä¸­çš„èŠ‚ç‚¹æ•°é‡ï¼Œåªéœ€è¦å¤šå¯åŠ¨å‡ ä¸ªbrokerå®ä¾‹å³å¯ã€‚ä¸ºäº†æœ‰æ›´å¥½çš„ç†è§£ï¼Œç°åœ¨æˆ‘ä»¬åœ¨ä¸€å°æœºå™¨ä¸ŠåŒæ—¶å¯åŠ¨ä¸‰ä¸ªbrokerå®ä¾‹ã€‚</p><h2 id="6-1-ç¬¬ä¸€æ­¥é…ç½®æ–‡ä»¶"><a href="#6-1-ç¬¬ä¸€æ­¥é…ç½®æ–‡ä»¶" class="headerlink" title="6.1 ç¬¬ä¸€æ­¥é…ç½®æ–‡ä»¶"></a>6.1 ç¬¬ä¸€æ­¥é…ç½®æ–‡ä»¶</h2><p>æˆ‘ä»¬éœ€è¦å»ºç«‹å¥½å…¶ä»–2ä¸ªbrokerçš„é…ç½®æ–‡ä»¶ï¼š</p><pre><code># cp config/server.properties config/server-1.properties# cp config/server.properties config/server-2.properties</code></pre><pre><code>é…ç½®æ–‡ä»¶çš„å†…å®¹åˆ†åˆ«å¦‚ä¸‹ï¼šconfig/server-1.properties:    broker.id=1    listeners=PLAINTEXT://:9093    log.dir=/tmp/kafka-logs-1config/server-2.properties:    broker.id=2    listeners=PLAINTEXT://:9094    log.dir=/tmp/kafka-logs-2</code></pre><p><strong>broker.id</strong> å±æ€§åœ¨kafkaé›†ç¾¤ä¸­å¿…é¡»è¦æ˜¯å”¯ä¸€çš„ã€‚</p><p>æˆ‘ä»¬éœ€è¦é‡æ–°æŒ‡å®športå’Œlogç›®å½•ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯åœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œå¤šä¸ªå®ä¾‹ã€‚å¦‚æœä¸è¿›è¡Œä¿®æ”¹çš„è¯ï¼Œconsumer åªèƒ½è·å–åˆ°ä¸€ä¸ª instance å®ä¾‹çš„ä¿¡æ¯ï¼Œæˆ–è€…æ˜¯ç›¸äº’ä¹‹é—´çš„æ•°æ®ä¼šè¢«å½±å“ã€‚<br>ç›®å‰æˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ªzookeeperå®ä¾‹å’Œä¸€ä¸ªbrokerå®ä¾‹åœ¨è¿è¡Œäº†.</p><h2 id="6-2-ç¬¬äºŒæ­¥-å¯åŠ¨å®ä¾‹"><a href="#6-2-ç¬¬äºŒæ­¥-å¯åŠ¨å®ä¾‹" class="headerlink" title="6.2 ç¬¬äºŒæ­¥ å¯åŠ¨å®ä¾‹"></a>6.2 ç¬¬äºŒæ­¥ å¯åŠ¨å®ä¾‹</h2><p>ç°åœ¨æˆ‘ä»¬åªéœ€è¦åœ¨å¯åŠ¨2ä¸ªbrokerå®ä¾‹å³å¯ï¼š</p><pre><code># bin/kafka-server-start.sh -daemon config/server-1.properties# bin/kafka-server-start.sh -daemon config/server-2.properties</code></pre><h2 id="6-3-ç¬¬ä¸‰æ­¥-åˆ›å»ºæ–°çš„topic"><a href="#6-3-ç¬¬ä¸‰æ­¥-åˆ›å»ºæ–°çš„topic" class="headerlink" title="6.3 ç¬¬ä¸‰æ­¥ åˆ›å»ºæ–°çš„topic"></a>6.3 ç¬¬ä¸‰æ­¥ åˆ›å»ºæ–°çš„topic</h2><p>ç°åœ¨æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„topicï¼Œå¤‡ä»½å› å­è®¾ç½®ä¸º3ï¼š</p><pre><code># bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 3 --partitions 1 --topic my-replicated-topic</code></pre><p>ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†é›†ç¾¤ï¼Œå¹¶ä¸”åˆ›å»ºäº†ä¸€ä¸ª3ä¸ªå¤‡ä»½å› å­çš„topicï¼Œä½†æ˜¯åˆ°åº•æ˜¯å“ªä¸€ä¸ªbrokeråœ¨ä¸ºè¿™ä¸ªtopicæä¾›æœåŠ¡å‘¢(å› ä¸ºæˆ‘ä»¬åªæœ‰ä¸€ä¸ªåˆ†åŒºï¼Œæ‰€ä»¥è‚¯å®šåŒæ—¶åªæœ‰ä¸€ä¸ªbrokeråœ¨å¤„ç†è¿™ä¸ªtopic)ï¼Ÿ</p><pre><code># bin/kafka-topics.sh --describe --zookeeper localhost:2181 --topic my-replicated-topic</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/4A84105C94DF433286557C4A47EB2087.jpg" alt="image"></p><blockquote><p>ä»¥ä¸‹æ˜¯è¾“å‡ºå†…å®¹çš„è§£é‡Šï¼Œç¬¬ä¸€è¡Œæ˜¯æ‰€æœ‰åˆ†åŒºçš„æ¦‚è¦ä¿¡æ¯ï¼Œä¹‹åçš„æ¯ä¸€è¡Œè¡¨ç¤ºæ¯ä¸€ä¸ªpartitionçš„ä¿¡æ¯ã€‚å› ä¸ºç›®å‰æˆ‘ä»¬åªæœ‰ä¸€ä¸ªpartitionï¼Œå› æ­¤å…³äºpartitionçš„ä¿¡æ¯åªæœ‰ä¸€è¡Œã€‚<br>leaderèŠ‚ç‚¹è´Ÿè´£ç»™å®špartitionçš„æ‰€æœ‰è¯»å†™è¯·æ±‚ã€‚<br>replicas è¡¨ç¤ºæŸä¸ªpartitionåœ¨å“ªå‡ ä¸ªbrokerä¸Šå­˜åœ¨å¤‡ä»½ã€‚ä¸ç®¡è¿™ä¸ªå‡ ç‚¹æ˜¯ä¸æ˜¯â€leaderâ€œï¼Œç”šè‡³è¿™ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œä¹Ÿä¼šåˆ—å‡ºã€‚<br>isr æ˜¯replicasçš„ä¸€ä¸ªå­é›†ï¼Œå®ƒåªåˆ—å‡ºå½“å‰è¿˜å­˜æ´»ç€çš„ï¼Œå¹¶ä¸”å¤‡ä»½äº†è¯¥partitionçš„èŠ‚ç‚¹ã€‚</p></blockquote><p>ç°åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œ0å·èŠ‚ç‚¹æ˜¯leaderï¼Œå³ä½¿ç”¨server.properties å¯åŠ¨çš„é‚£ä¸ªè¿›ç¨‹ã€‚</p><h2 id="6-4-ç¬¬å››æ­¥-å‘é€æ¶ˆæ¯"><a href="#6-4-ç¬¬å››æ­¥-å‘é€æ¶ˆæ¯" class="headerlink" title="6.4 ç¬¬å››æ­¥ å‘é€æ¶ˆæ¯"></a>6.4 ç¬¬å››æ­¥ å‘é€æ¶ˆæ¯</h2><p>ç°åœ¨æˆ‘ä»¬å‘æ–°å»ºçš„topicä¸­å‘é€ä¸€äº›messageï¼š</p><pre><code># bin/kafka-console-producer.sh --broker-list localhost:9092 --topic my-replicated-topic&gt;my test msg 1&gt;my test msg 2</code></pre><h2 id="6-5-ç¬¬äº”æ­¥-æ¶ˆè´¹æ¶ˆæ¯"><a href="#6-5-ç¬¬äº”æ­¥-æ¶ˆè´¹æ¶ˆæ¯" class="headerlink" title="6.5 ç¬¬äº”æ­¥ æ¶ˆè´¹æ¶ˆæ¯"></a>6.5 ç¬¬äº”æ­¥ æ¶ˆè´¹æ¶ˆæ¯</h2><pre><code># bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --from-beginning --topic my-replicated-topicmy test msg 1my test msg 2</code></pre><h2 id="6-6-ç¬¬å…­æ­¥-æµ‹è¯•å®¹é”™æ€§"><a href="#6-6-ç¬¬å…­æ­¥-æµ‹è¯•å®¹é”™æ€§" class="headerlink" title="6.6 ç¬¬å…­æ­¥ æµ‹è¯•å®¹é”™æ€§"></a>6.6 ç¬¬å…­æ­¥ æµ‹è¯•å®¹é”™æ€§</h2><p>ç°åœ¨æˆ‘ä»¬æ¥æµ‹è¯•æˆ‘ä»¬å®¹é”™æ€§ï¼Œå› ä¸ºbroker0ç›®å‰æ˜¯leaderï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°†å…¶kill</p><pre><code># ps -ef | grep server.properties# kill -9 1177</code></pre><p>ç°åœ¨å†æ‰§è¡Œå‘½ä»¤ï¼š</p><pre><code># bin/kafka-topics.sh --describe --zookeeper localhost:9092 --topic my-replicated-topic</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/F9EE7EAD337748ABB25CB8BE81179AC8.jpg" alt="image"></p><blockquote><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒleaderèŠ‚ç‚¹å·²ç»å˜æˆäº†broker 2.è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨Isrä¸­ï¼Œå·²ç»æ²¡æœ‰äº†0å·èŠ‚ç‚¹ã€‚leaderçš„é€‰ä¸¾ä¹Ÿæ˜¯ä»ISR(in-sync replica)ä¸­è¿›è¡Œçš„ã€‚</p></blockquote><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥ æ¶ˆè´¹æ–°æ¶ˆæ¯</p><pre><code># bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --from-beginning --topic my-replicated-topicmy test msg 1my test msg 2</code></pre><p>æŸ¥çœ‹ä¸»é¢˜åˆ†åŒºå¯¹åº”çš„leaderä¿¡æ¯ï¼š</p><p>éœ€è¦é€šè¿‡zk å®¢æˆ·ç«¯æŸ¥çœ‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/1A9C68F18131409E844516D103E78B50.jpg" alt="image"></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;1-å®‰è£…å‰çš„ç¯å¢ƒå‡†å¤‡&quot;&gt;&lt;a href=&quot;#1-å®‰è£…å‰çš„ç¯å¢ƒå‡†å¤‡&quot; class=&quot;headerlink&quot; title=&quot;1. å®‰è£…å‰çš„ç¯å¢ƒå‡†å¤‡&quot;&gt;&lt;/a&gt;1. å®‰è£…å‰çš„ç¯å¢ƒå‡†å¤‡&lt;/h1&gt;&lt;p&gt;ç”±äºKafkaæ˜¯ç”¨Scalaè¯­è¨€å¼€å‘çš„ï¼Œè¿è¡Œåœ¨JVMä¸Šï¼Œå› æ­¤åœ¨å®‰è£…Kafkaä¹‹å‰éœ€è¦å…ˆå®‰è£…JDKã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="åˆ†å¸ƒå¼" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="Java" scheme="https://brokge.github.io/tags/Java/"/>
    
      <category term="MQ" scheme="https://brokge.github.io/tags/MQ/"/>
    
  </entry>
  
  <entry>
    <title>kafka æ¦‚å¿µå’ŒåŸç†è¯¦è§£</title>
    <link href="https://brokge.github.io/2020/07/22/kafka-%E6%A6%82%E5%BF%B5%E5%92%8C%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3/"/>
    <id>https://brokge.github.io/2020/07/22/kafka-æ¦‚å¿µå’ŒåŸç†è¯¦è§£/</id>
    <published>2020-07-22T04:28:51.000Z</published>
    <updated>2020-08-21T04:56:34.525Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h1><p>Kafkaæ˜¯ä¸€ç§é«˜ååé‡çš„åˆ†å¸ƒå¼å‘å¸ƒè®¢é˜…æ¶ˆæ¯ç³»ç»Ÿï¼Œä½¿ç”¨Scalaç¼–å†™ã€‚<br>å¯¹äºç†Ÿæ‚‰JMSï¼ˆJava Message Serviceï¼‰è§„èŒƒçš„åŒå­¦æ¥è¯´ï¼Œæ¶ˆæ¯ç³»ç»Ÿå·²ç»ä¸æ˜¯ä»€ä¹ˆæ–°æ¦‚å¿µäº†(ä¾‹å¦‚ActiveMQï¼ŒRabbitMQç­‰)ã€‚</p><a id="more"></a><p>Kafka æ‹¥æœ‰ä½œä¸ºä¸€ä¸ªæ¶ˆæ¯ç³»ç»Ÿåº”è¯¥å…·å¤‡çš„åŠŸèƒ½ï¼Œä½†æ˜¯ç¡®æœ‰ç€ç‹¬ç‰¹çš„è®¾è®¡ã€‚å¯ä»¥è¿™æ ·æ¥è¯´ï¼ŒKafka å€Ÿé‰´äº†JMSè§„èŒƒçš„æ€æƒ³ï¼Œä½†æ˜¯ç¡®å¹¶æ²¡æœ‰å®Œå…¨éµå¾ªJMSè§„èŒƒã€‚</p><p>kafkaæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ï¼Œåˆ†åŒºçš„æ¶ˆæ¯(å®˜æ–¹ç§°ä¹‹ä¸ºcommit log)æœåŠ¡ã€‚å®ƒæä¾›ä¸€ä¸ªæ¶ˆæ¯ç³»ç»Ÿåº”è¯¥å…·å¤‡çš„åŠŸèƒ½ï¼Œä½†æ˜¯ç¡®æœ‰ç€ç‹¬ç‰¹çš„è®¾è®¡ã€‚</p><h2 id="1-1-é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åŸºç¡€çš„æ¶ˆæ¯-Message-ç›¸å…³æœ¯è¯­"><a href="#1-1-é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åŸºç¡€çš„æ¶ˆæ¯-Message-ç›¸å…³æœ¯è¯­" class="headerlink" title="1.1 é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åŸºç¡€çš„æ¶ˆæ¯(Message)ç›¸å…³æœ¯è¯­"></a>1.1 é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åŸºç¡€çš„æ¶ˆæ¯(Message)ç›¸å…³æœ¯è¯­</h2><ul><li>Topic: KafkaæŒ‰ç…§Topicåˆ†ç±»æ¥ç»´æŠ¤æ¶ˆæ¯</li><li>Producerï¼š æˆ‘ä»¬å°†å‘å¸ƒ(publish)æ¶ˆæ¯åˆ°Topicçš„è¿›ç¨‹ç§°ä¹‹ä¸ºç”Ÿäº§è€…(producer)</li><li>Consumerï¼š æˆ‘ä»¬å°†è®¢é˜…(subscribe)Topicå¹¶ä¸”å¤„ç†Topicä¸­æ¶ˆæ¯çš„è¿›ç¨‹ç§°ä¹‹ä¸ºæ¶ˆè´¹è€…(consumer)</li><li>Brokerï¼šKafkaä»¥é›†ç¾¤çš„æ–¹å¼è¿è¡Œï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸€å°æœåŠ¡å™¨ç§°ä¹‹ä¸ºä¸€ä¸ªä»£ç†(broker)ã€‚</li></ul><p>å› æ­¤ï¼Œä»ä¸€ä¸ªè¾ƒé«˜çš„å±‚é¢ä¸Šæ¥çœ‹ï¼Œproducersé€šè¿‡ç½‘ç»œå‘é€æ¶ˆæ¯åˆ°Kafkaé›†ç¾¤ï¼Œç„¶åconsumersæ¥è¿›è¡Œæ¶ˆè´¹ï¼Œ</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/94E20F013CAA4F3694867F196F09F9D7.jpg" alt="image"></p><p>æœåŠ¡ç«¯(brokers)å’Œå®¢æˆ·ç«¯(producerã€consumer)ä¹‹é—´é€šä¿¡é€šè¿‡TCPåè®®æ¥å®Œæˆã€‚Kafkaæä¾›äº†ä¸€ä¸ªJavaå®¢æˆ·ç«¯ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–è¯­è¨€ç¼–å†™çš„å®¢æˆ·ç«¯ã€‚</p><h3 id="1-1-1-Topicå’ŒLog"><a href="#1-1-1-Topicå’ŒLog" class="headerlink" title="1.1.1 Topicå’ŒLog"></a>1.1.1 Topicå’ŒLog</h3><p>è®©æˆ‘ä»¬é¦–å…ˆæ·±å…¥ç†è§£Kafkaæå‡ºä¸€ä¸ªé«˜å±‚æ¬¡çš„æŠ½è±¡æ¦‚å¿µ-Topicã€‚<br>å¯ä»¥ç†è§£Topicæ˜¯ä¸€ä¸ªç±»åˆ«çš„åç§°ï¼Œæ‰€æœ‰çš„messageå‘é€åˆ°Topicä¸‹é¢ã€‚å¯¹äºæ¯ä¸€ä¸ªTopicï¼Œkafkaé›†ç¾¤æŒ‰ç…§å¦‚ä¸‹æ–¹å¼ç»´æŠ¤ä¸€ä¸ªåˆ†åŒº(Partition,å¯ä»¥å°±ç†è§£ä¸ºä¸€ä¸ªé˜Ÿåˆ—Queue)æ—¥å¿—æ–‡ä»¶:</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/7E80C11FB6AE43B1A579D9A283331D43.jpg" alt="image"></p><p>partitionæ˜¯ä¸€ä¸ªæœ‰åºçš„messageåºåˆ—ï¼Œè¿™äº›messageæŒ‰é¡ºåºæ·»åŠ åˆ°ä¸€ä¸ªå«åšcommit logçš„æ–‡ä»¶ä¸­ã€‚æ¯ä¸ªpartitionä¸­çš„æ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·ï¼Œç§°ä¹‹ä¸ºoffsetï¼Œç”¨æ¥å”¯ä¸€æ ‡ç¤ºæŸä¸ªåˆ†åŒºä¸­çš„messageã€‚</p><blockquote><p>æç¤ºï¼šæ¯ä¸ª partition ï¼Œéƒ½å¯¹åº”ä¸€ä¸ªcommit-logã€‚ä¸€ä¸ª partition ä¸­çš„messageçš„offsetéƒ½æ˜¯å”¯ä¸€çš„ï¼Œä½†æ˜¯ä¸åŒçš„partitionä¸­çš„messageçš„offsetå¯èƒ½æ˜¯ç›¸åŒçš„ã€‚</p></blockquote><p><strong>kafkaé›†ç¾¤</strong>ï¼Œåœ¨é…ç½®çš„æ—¶é—´èŒƒå›´å†…ï¼Œç»´æŠ¤æ‰€æœ‰çš„ç”±producerç”Ÿæˆçš„æ¶ˆæ¯ï¼Œè€Œä¸ç®¡è¿™äº›æ¶ˆæ¯æœ‰æ²¡æœ‰è¢«æ¶ˆè´¹ã€‚ä¾‹å¦‚æ—¥å¿—ä¿ç•™( log retention )æ—¶é—´è¢«è®¾ç½®ä¸º2å¤©ã€‚kafkaä¼šç»´æŠ¤æœ€è¿‘2å¤©ç”Ÿäº§çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œè€Œ2å¤©å‰çš„æ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒã€‚==kafka çš„æ€§èƒ½ä¸ä¿ç•™çš„æ•°æ®é‡çš„å¤§å°æ²¡æœ‰å…³ç³»==ï¼Œå› æ­¤ä¿å­˜å¤§é‡çš„æ•°æ®(æ—¥å¿—ä¿¡æ¯)ä¸ä¼šæœ‰ä»€ä¹ˆå½±å“ã€‚</p><p><strong>å…³äº consumer</strong> ï¼Œæ¯ä¸ªconsumeræ˜¯åŸºäºè‡ªå·±åœ¨commit log ä¸­çš„æ¶ˆè´¹è¿›åº¦(offset)æ¥è¿›è¡Œå·¥ä½œçš„ã€‚åœ¨kafkaä¸­ï¼Œoffsetç”±consumeræ¥ç»´æŠ¤ï¼šä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬æŒ‰ç…§é¡ºåºé€æ¡æ¶ˆè´¹commit logä¸­çš„æ¶ˆæ¯ï¼Œå½“ç„¶æˆ‘å¯ä»¥é€šè¿‡æŒ‡å®šoffsetæ¥é‡å¤æ¶ˆè´¹æŸäº›æ¶ˆæ¯ï¼Œæˆ–è€…è·³è¿‡æŸäº›æ¶ˆæ¯ã€‚</p><p>è¿™æ„å‘³ kafka ä¸­çš„ consumer å¯¹é›†ç¾¤çš„å½±å“æ˜¯éå¸¸å°çš„ï¼Œæ·»åŠ ä¸€ä¸ªæˆ–è€…å‡å°‘ä¸€ä¸ªconsumerï¼Œå¯¹äºé›†ç¾¤æˆ–è€…å…¶ä»–consumeræ¥è¯´ï¼Œéƒ½æ˜¯æ²¡æœ‰å½±å“çš„ï¼Œå› æ­¤==æ¯ä¸ªconsumerç»´æŠ¤å„è‡ªçš„offset==ã€‚</p><p><strong>å¯¹logè¿›è¡Œåˆ†åŒºï¼ˆpartitionedï¼‰ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><ul><li>é¦–å…ˆï¼Œå½“logæ–‡ä»¶å¤§å°è¶…è¿‡ç³»ç»Ÿæ–‡ä»¶ç³»ç»Ÿçš„é™åˆ¶æ—¶ï¼Œå¯ä»¥è‡ªåŠ¨æ‹†åˆ†ã€‚æ¯ä¸ªpartitionå¯¹åº”çš„logéƒ½å—åˆ°æ‰€åœ¨æœºå™¨çš„æ–‡ä»¶ç³»ç»Ÿå¤§å°çš„é™åˆ¶ï¼Œä½†æ˜¯ä¸€ä¸ªTopicä¸­æ˜¯å¯ä»¥æœ‰å¾ˆå¤šåˆ†åŒºçš„ï¼Œå› æ­¤å¯ä»¥å¤„ç†ä»»æ„æ•°é‡çš„æ•°æ®ã€‚</li><li>å¦ä¸€ä¸ªæ–¹é¢ï¼Œæ˜¯ä¸ºäº†æé«˜å¹¶è¡Œåº¦ã€‚</li></ul><h3 id="1-1-3-Distribution"><a href="#1-1-3-Distribution" class="headerlink" title="1.1.3 Distribution"></a>1.1.3 Distribution</h3><p>logçš„partitionsåˆ†å¸ƒåœ¨kafkaé›†ç¾¤ä¸­ä¸åŒçš„brokerä¸Šï¼Œæ¯ä¸ªbrokerå¯ä»¥è¯·æ±‚å¤‡ä»½å…¶ä»–brokerä¸Špartitionä¸Šçš„æ•°æ®ã€‚kafkaé›†ç¾¤æ”¯æŒé…ç½®ä¸€ä¸ªpartitionå¤‡ä»½çš„æ•°é‡ã€‚</p><p>é’ˆå¯¹æ¯ä¸ªpartitionï¼Œéƒ½æœ‰ä¸€ä¸ªbrokerèµ·åˆ°â€œleaderâ€çš„ä½œç”¨ï¼Œ0ä¸ªå¤šä¸ªå…¶ä»–çš„brokerä½œä¸ºâ€œfollwersâ€çš„ä½œç”¨ã€‚leaderå¤„ç†æ‰€æœ‰çš„é’ˆå¯¹è¿™ä¸ªpartitionçš„è¯»å†™è¯·æ±‚ï¼Œè€Œ==followersè¢«åŠ¨å¤åˆ¶leaderçš„ç»“æœ==ã€‚å¦‚æœè¿™ä¸ªleaderå¤±æ•ˆäº†ï¼Œå…¶ä¸­çš„ä¸€ä¸ªfollowerå°†ä¼šè‡ªåŠ¨çš„å˜æˆæ–°çš„leaderã€‚==æ¯ä¸ªbrokeréƒ½æ˜¯è‡ªå·±æ‰€ç®¡ç†çš„partitionçš„leaderï¼ŒåŒæ—¶åˆæ˜¯å…¶ä»–brokeræ‰€ç®¡ç†partitionsçš„followersï¼Œkafkaé€šè¿‡è¿™ç§æ–¹å¼æ¥è¾¾åˆ°è´Ÿè½½å‡è¡¡ã€‚==</p><h3 id="1-1-3-Producers"><a href="#1-1-3-Producers" class="headerlink" title="1.1.3 Producers"></a>1.1.3 Producers</h3><p>ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ°topicä¸­å»ï¼ŒåŒæ—¶è´Ÿè´£é€‰æ‹©å°†messageå‘é€åˆ°topicçš„å“ªä¸€ä¸ªpartitionä¸­ã€‚é€šè¿‡round-robinï¼ˆè½®è¯¢ï¼‰åšç®€å•çš„è´Ÿè½½å‡è¡¡ã€‚ä¹Ÿå¯ä»¥æ ¹æ®æ¶ˆæ¯ä¸­çš„æŸä¸€ä¸ªå…³é”®å­—æ¥è¿›è¡ŒåŒºåˆ†ï¼Œæ¯”å¦‚æŒ‡å®šå®škey é€šè¿‡ hash å–æ¨¡ã€‚é€šå¸¸ç¬¬äºŒç§æ–¹å¼ä½¿ç”¨çš„æ›´å¤šã€‚</p><h3 id="1-1-4-Consumers-å’Œ-Consumer-Group"><a href="#1-1-4-Consumers-å’Œ-Consumer-Group" class="headerlink" title="1.1.4 Consumers å’Œ Consumer Group"></a>1.1.4 Consumers å’Œ Consumer Group</h3><p>ä¼ ç»Ÿçš„æ¶ˆæ¯ä¼ é€’æ¨¡å¼æœ‰2ç§ï¼šé˜Ÿåˆ—( queuing )å’Œï¼ˆ publish-subscribeï¼‰ã€‚<br>åœ¨queuingæ¨¡å¼ä¸­ï¼Œå¤šä¸ªconsumerä»æœåŠ¡å™¨ä¸­è¯»å–æ•°æ®ï¼Œæ¶ˆæ¯åªä¼šåˆ°è¾¾ä¸€ä¸ªconsumerã€‚åœ¨ publish-subscribe æ¨¡å‹ä¸­ï¼Œæ¶ˆæ¯ä¼šè¢«å¹¿æ’­ç»™æ‰€æœ‰çš„consumerã€‚==KafkaåŸºäºè¿™2ç§æ¨¡å¼æä¾›äº†ä¸€ç§consumerçš„æŠ½è±¡æ¦‚å¿µ==ï¼š==consumer group==ã€‚</p><p>æ¯ä¸ªconsumeréƒ½è¦æ ‡è®°è‡ªå·±å±äºå“ªä¸€ä¸ª consumer groupã€‚å‘å¸ƒåˆ° topic ä¸­çš„ message ä¸­ message ä¼šè¢«ä¼ é€’åˆ° consumer group ä¸­çš„ä¸€ä¸ª consumer å®ä¾‹ã€‚consumerå®ä¾‹å¯ä»¥è¿è¡Œåœ¨ä¸åŒçš„è¿›ç¨‹ä¸Šï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒçš„ç‰©ç†æœºå™¨ä¸Šã€‚<br>å¦‚æœæ‰€æœ‰çš„consumeréƒ½ä½äºåŒä¸€ä¸ªconsumer group ä¸‹ï¼Œè¿™å°±ç±»ä¼¼äºä¼ ç»Ÿçš„queueæ¨¡å¼ï¼Œå¹¶åœ¨ä¼—å¤šçš„consumer instanceä¹‹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚<br>å¦‚æœæ‰€æœ‰çš„consumeréƒ½æœ‰ç€è‡ªå·±å”¯ä¸€çš„consumer groupï¼Œè¿™å°±ç±»ä¼¼äºä¼ ç»Ÿçš„publish-subscribeæ¨¡å‹ã€‚</p><p>æ›´ä¸€èˆ¬çš„æƒ…å†µæ˜¯ï¼Œé€šå¸¸ä¸€ä¸ªtopicä¼šæœ‰å‡ ä¸ªconsumer groupï¼Œæ¯ä¸ªconsumer groupéƒ½æ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„è®¢é˜…è€…ï¼ˆ logical subscriber ï¼‰ã€‚æ¯ä¸ªconsumer groupç”±å¤šä¸ªconsumer instance ç»„æˆï¼Œä»è€Œè¾¾åˆ°å¯æ‰©å±•å’Œå®¹ç¾çš„åŠŸèƒ½ã€‚è¿™å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„åœ°æ–¹ï¼Œä»…ä»…æ˜¯å°†publish-subscribeæ¨¡å‹ä¸­çš„è¿è¡Œåœ¨å•ä¸ªè¿›ç¨‹ä¸Šçš„consumersä¸­çš„consumeræ›¿æ¢æˆä¸€ä¸ªconsumer groupã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/79D77C03B804413AB5D481ACDBBA0FC6.jpg" alt="image"></p><blockquote><p>è¯´æ˜ï¼šç”±2ä¸ªbrokerç»„æˆçš„kafkaé›†ç¾¤ï¼Œæ€»å…±æœ‰4ä¸ª Parition (P0-P3)ã€‚è¿™ä¸ªé›†ç¾¤ç”±2ä¸ªConsumer Groupï¼Œ Aæœ‰2ä¸ª consumer instances ï¼Œè€ŒBæœ‰å››ä¸ª.consumer instancesçš„ä¸ªæ•°ä¸èƒ½å¤§äºå¯¹åº”topic çš„ Parition ä¸ªæ•°ã€‚</p></blockquote><h2 id="1-2-æ¶ˆè´¹é¡ºåº"><a href="#1-2-æ¶ˆè´¹é¡ºåº" class="headerlink" title="1.2  æ¶ˆè´¹é¡ºåº"></a>1.2  æ¶ˆè´¹é¡ºåº</h2><p>Kafka æ¯”ä¼ ç»Ÿçš„æ¶ˆæ¯ç³»ç»Ÿæœ‰ç€æ›´å¼ºçš„é¡ºåºä¿è¯ã€‚</p><p><strong>åœ¨ä¼ ç»Ÿçš„æƒ…å†µä¸‹</strong>ï¼šæœåŠ¡å™¨æŒ‰ç…§é¡ºåºä¿ç•™æ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼Œå¦‚æœæœ‰å¤šä¸ªconsumeræ¥æ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨ ä¼šæ¥å—æ¶ˆæ¯çš„é¡ºåºå‘å¤–æä¾›æ¶ˆæ¯ã€‚ä½†æ˜¯ï¼Œå°½ç®¡æœåŠ¡å™¨æ˜¯æŒ‰ç…§é¡ºåºæä¾›æ¶ˆæ¯ï¼Œä½†æ˜¯æ¶ˆæ¯ä¼ é€’åˆ°æ¯ä¸€ä¸ªconsumeræ˜¯å¼‚æ­¥çš„ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å…ˆæ¶ˆè´¹çš„ consumerè·å–åˆ°æ¶ˆæ¯æ—¶é—´å¯èƒ½æ¯”åæ¶ˆè´¹çš„consumerè·å–åˆ°æ¶ˆæ¯çš„æ—¶é—´é•¿ï¼Œå¯¼è‡´ä¸èƒ½ä¿è¯é¡ºåºæ€§ã€‚è¿™è¡¨æ˜ï¼Œå½“è¿›è¡Œå¹¶è¡Œçš„æ¶ˆè´¹çš„æ—¶å€™ï¼Œæ¶ˆæ¯åœ¨å¤šä¸ª consumerä¹‹é—´å¯èƒ½ä¼šå¤±å»é¡ºåºæ€§ã€‚æ¶ˆæ¯ç³»ç»Ÿé€šå¸¸ä¼šé‡‡å–ä¸€ç§â€œ exclusive consumerâ€çš„æ¦‚å¿µï¼Œæ¥ç¡®ä¿åŒä¸€æ—¶é—´å†…åªæœ‰ä¸€ä¸ªconsumerèƒ½å¤Ÿä»é˜Ÿåˆ—ä¸­è¿›è¡Œæ¶ˆè´¹ï¼Œä½†æ˜¯è¿™å®é™…ä¸Šæ„å‘³ç€åœ¨æ¶ˆæ¯å¤„ç†çš„è¿‡ç¨‹ä¸­æ˜¯ä¸æ”¯æŒå¹¶è¡Œçš„ã€‚</p><p><strong>Kafka</strong>ï¼šåœ¨è¿™æ–¹é¢åšçš„æ›´å¥½ã€‚é€šè¿‡Topicä¸­å¹¶è¡Œåº¦çš„æ¦‚å¿µï¼Œå³partitionï¼ŒKafkaå¯ä»¥åŒæ—¶æä¾›é¡ºåºæ€§ä¿è¯å’Œå¤šä¸ªconsumeråŒæ—¶æ¶ˆè´¹æ—¶çš„è´Ÿè½½å‡è¡¡ã€‚å®ç°çš„åŸç†æ˜¯é€šè¿‡å°†ä¸€ä¸ªtopicä¸­çš„partitionåˆ†é…ç»™ä¸€ä¸ªconsumer groupä¸­çš„ä¸åŒconsumer instanceã€‚<br>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥ä¿è¯ä¸€ä¸ªpartitionåœ¨åŒä¸€ä¸ªæ—¶åˆ»åªæœ‰ä¸€ä¸ªconsumer instanceåœ¨æ¶ˆæ¯ï¼Œä»è€Œä¿è¯é¡ºåºã€‚è™½ç„¶ä¸€ä¸ªtopicä¸­æœ‰å¤šä¸ªpartitionï¼Œä½†æ˜¯ä¸€ä¸ªconsumer groupä¸­åŒæ—¶ä¹Ÿæœ‰å¤šä¸ªconsumer instanceï¼Œé€šè¿‡åˆç†çš„åˆ†é…ä¾ç„¶èƒ½å¤Ÿä¿è¯è´Ÿè½½å‡è¡¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€ä¸ªconsumer groupä¸­çš„consumer instanceçš„æ•°é‡ä¸èƒ½æ¯”ä¸€ä¸ªTopicä¸­çš„partitionçš„æ•°é‡å¤šã€‚</p><p>Kafkaåªåœ¨ partition çš„èŒƒå›´å†…ä¿è¯æ¶ˆæ¯æ¶ˆè´¹çš„å±€éƒ¨é¡ºåºæ€§ï¼Œä¸èƒ½åœ¨åŒä¸€ä¸ªtopicä¸­çš„å¤šä¸ªpartitionä¸­ä¿è¯æ€»çš„æ¶ˆè´¹é¡ºåºæ€§ã€‚</p><p>é€šå¸¸æ¥è¯´ï¼Œè¿™å·²ç»å¯ä»¥æ»¡è¶³å¤§éƒ¨åˆ†åº”ç”¨çš„éœ€æ±‚ã€‚ä½†æ˜¯ï¼Œå¦‚æœçš„ç¡®æœ‰åœ¨æ€»ä½“ä¸Šä¿è¯æ¶ˆè´¹çš„é¡ºåºçš„éœ€æ±‚çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡å°† topic çš„ partition æ•°é‡è®¾ç½®ä¸º1ï¼Œå°† consumer group ä¸­çš„ consumer instance æ•°é‡ä¹Ÿè®¾ç½®ä¸º1.</p><h2 id="1-3-Guaranteesï¼ˆæ‹…ä¿ï¼‰"><a href="#1-3-Guaranteesï¼ˆæ‹…ä¿ï¼‰" class="headerlink" title="1.3 Guaranteesï¼ˆæ‹…ä¿ï¼‰"></a>1.3 Guaranteesï¼ˆæ‹…ä¿ï¼‰</h2><p>ä»è¾ƒé«˜çš„å±‚é¢ä¸Šæ¥è¯´çš„è¯ï¼ŒKafkaæä¾›äº†ä»¥ä¸‹çš„ä¿è¯ï¼š</p><p><strong>å‘é€é¡ºåºä¿è¯:</strong> å‘é€åˆ°ä¸€ä¸ªTopicä¸­çš„messageä¼šæŒ‰ç…§å‘é€çš„é¡ºåºæ·»åŠ åˆ°commit log ä¸­ã€‚æ„æ€æ˜¯ï¼Œå¦‚æœæ¶ˆæ¯ M1ï¼ŒM2 ç”±åŒä¸€ä¸ªproducerå‘é€ï¼ŒM1 æ¯” M2 å‘é€çš„æ—©çš„è¯ï¼Œé‚£ä¹ˆåœ¨ commit log ä¸­ï¼ŒM1çš„ offsetä¸€å®šæ¯”commit M2çš„ offset å°ã€‚</p><p><strong>æ¶ˆæ¯å®¹ç¾ä¿è¯:</strong> ä¸€ä¸ªconsumeråœ¨commit logä¸­å¯ä»¥æŒ‰ç…§å‘é€é¡ºåºæ¥æ¶ˆè´¹message<br>å¦‚æœä¸€ä¸ª topic çš„å¤‡ä»½å› å­( replication factor )è®¾ç½®ä¸ºNï¼Œé‚£ä¹ˆKafkaå¯ä»¥å®¹å¿N-1ä¸ªæœåŠ¡å™¨çš„å¤±è´¥ï¼Œè€Œå­˜å‚¨åœ¨commit logä¸­çš„æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ã€‚</p><h1 id="2-Kafkaè®¾è®¡åŸç†åˆ†æ"><a href="#2-Kafkaè®¾è®¡åŸç†åˆ†æ" class="headerlink" title="2. Kafkaè®¾è®¡åŸç†åˆ†æ"></a>2. Kafkaè®¾è®¡åŸç†åˆ†æ</h1><h2 id="2-1-kafka-æ‹“æ‰‘ç»“æ„"><a href="#2-1-kafka-æ‹“æ‰‘ç»“æ„" class="headerlink" title="2.1 kafka æ‹“æ‰‘ç»“æ„"></a>2.1 kafka æ‹“æ‰‘ç»“æ„</h2><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/04CD2B96DA934EC8A301480B308A9DE7.jpg" alt="image"></p><h2 id="2-2-kafka-zoopeeper-èŠ‚ç‚¹ç»“æ„"><a href="#2-2-kafka-zoopeeper-èŠ‚ç‚¹ç»“æ„" class="headerlink" title="2.2 kafka zoopeeper èŠ‚ç‚¹ç»“æ„"></a>2.2 kafka zoopeeper èŠ‚ç‚¹ç»“æ„</h2><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/5C5F8A937B9245F7956014A6010F9E0E.jpg" alt="image"></p><ul><li>topics èŠ‚ç‚¹ä¸ºæ°¸ä¹…èŠ‚ç‚¹ç±»å‹ï¼ˆé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼‰ã€‚</li><li>ids ä¸ºä¸´æ—¶èŠ‚ç‚¹ï¼ˆèŠ‚ç‚¹æŒ‚æ‰ï¼Œå°±éœ€è¦åˆ é™¤idï¼‰</li></ul><h2 id="2-3-producer-å‘å¸ƒæ¶ˆæ¯"><a href="#2-3-producer-å‘å¸ƒæ¶ˆæ¯" class="headerlink" title="2.3 producer å‘å¸ƒæ¶ˆæ¯"></a>2.3 producer å‘å¸ƒæ¶ˆæ¯</h2><h3 id="2-3-1-å†™å…¥æ–¹å¼"><a href="#2-3-1-å†™å…¥æ–¹å¼" class="headerlink" title="2.3.1 å†™å…¥æ–¹å¼"></a>2.3.1 å†™å…¥æ–¹å¼</h3><p>producer é‡‡ç”¨ push æ¨¡å¼å°†æ¶ˆæ¯å‘å¸ƒåˆ° brokerï¼Œæ¯æ¡æ¶ˆæ¯éƒ½è¢« append åˆ° patition ä¸­ï¼Œå±äºé¡ºåºå†™ç£ç›˜ï¼ˆé¡ºåºå†™ç£ç›˜æ•ˆç‡æ¯”éšæœºå†™å†…å­˜è¦é«˜ï¼Œä¿éšœ kafka ååç‡ï¼‰ã€‚</p><h3 id="2-3-2-æ¶ˆæ¯è·¯ç”±"><a href="#2-3-2-æ¶ˆæ¯è·¯ç”±" class="headerlink" title="2.3.2 æ¶ˆæ¯è·¯ç”±"></a>2.3.2 æ¶ˆæ¯è·¯ç”±</h3><p>producer å‘é€æ¶ˆæ¯åˆ° broker æ—¶ï¼Œä¼šæ ¹æ®åˆ†åŒºç®—æ³•é€‰æ‹©å°†å…¶å­˜å‚¨åˆ°å“ªä¸€ä¸ª partitionã€‚<br>å…¶è·¯ç”±æœºåˆ¶ä¸ºï¼š</p><ol><li>æŒ‡å®šäº† patitionï¼Œåˆ™ç›´æ¥ä½¿ç”¨ï¼›</li><li>æœªæŒ‡å®š patition ä½†æŒ‡å®š keyï¼Œé€šè¿‡å¯¹ key çš„ value è¿›è¡Œhash é€‰å‡ºä¸€ä¸ª patition</li><li>patition å’Œ key éƒ½æœªæŒ‡å®šï¼Œä½¿ç”¨è½®è¯¢é€‰å‡ºä¸€ä¸ª patitionã€‚<br>3ã€å†™å…¥æµç¨‹</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/5575DC56967641BC9AF89F9C8078E6B9.jpg" alt="image"></p><blockquote><ol><li>producer å…ˆä» zookeeper çš„ â€œ/brokers/â€¦/stateâ€ èŠ‚ç‚¹æ‰¾åˆ°è¯¥ partition çš„ leader</li><li>producer å°†æ¶ˆæ¯å‘é€ç»™è¯¥ leader</li><li>leader å°†æ¶ˆæ¯å†™å…¥æœ¬åœ° log</li><li>followers ä» leader pull æ¶ˆæ¯ï¼Œå†™å…¥æœ¬åœ° log å leader å‘é€ ACK</li><li>leader æ”¶åˆ°æ‰€æœ‰ ISR ä¸­çš„ replica çš„ ACK åï¼Œå¢åŠ  HWï¼ˆhigh watermarkï¼Œæœ€å commit çš„ offsetï¼‰ å¹¶å‘ producer å‘é€ ACK</li></ol></blockquote><h2 id="2-4-kafkaåˆ†åŒºleaderé€‰ä¸¾åŸç†"><a href="#2-4-kafkaåˆ†åŒºleaderé€‰ä¸¾åŸç†" class="headerlink" title="2.4 kafkaåˆ†åŒºleaderé€‰ä¸¾åŸç†"></a>2.4 kafkaåˆ†åŒºleaderé€‰ä¸¾åŸç†</h2><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/10991B022F3F4E829DEFB78EA4228095.jpg" alt="image"></p><p>é€‰ä¸¾åŸç†ï¼šæ˜¯æ ¹æ® zookeeper çš„é”æœºåˆ¶æ¥å®ç°ï¼ŒåŒä¸€æ—¶é—´åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹å†™å…¥å‚é€‰ä¿¡æ¯ï¼Œåªæœ‰ä¸€ä¸ªflower èƒ½å†™å…¥æˆåŠŸï¼Œå†™å…¥æˆåŠŸçš„å³ä¸º  leaderã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;1-ç®€ä»‹&quot;&gt;&lt;a href=&quot;#1-ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;1. ç®€ä»‹&quot;&gt;&lt;/a&gt;1. ç®€ä»‹&lt;/h1&gt;&lt;p&gt;Kafkaæ˜¯ä¸€ç§é«˜ååé‡çš„åˆ†å¸ƒå¼å‘å¸ƒè®¢é˜…æ¶ˆæ¯ç³»ç»Ÿï¼Œä½¿ç”¨Scalaç¼–å†™ã€‚&lt;br&gt;å¯¹äºç†Ÿæ‚‰JMSï¼ˆJava Message Serviceï¼‰è§„èŒƒçš„åŒå­¦æ¥è¯´ï¼Œæ¶ˆæ¯ç³»ç»Ÿå·²ç»ä¸æ˜¯ä»€ä¹ˆæ–°æ¦‚å¿µäº†(ä¾‹å¦‚ActiveMQï¼ŒRabbitMQç­‰)ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="åˆ†å¸ƒå¼" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="Java" scheme="https://brokge.github.io/tags/Java/"/>
    
      <category term="MQ" scheme="https://brokge.github.io/tags/MQ/"/>
    
  </entry>
  
  <entry>
    <title>JVM- è™šæ‹Ÿæœºè°ƒä¼˜å·¥å…·</title>
    <link href="https://brokge.github.io/2020/07/10/JVM-%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%B0%83%E4%BC%98%E5%B7%A5%E5%85%B7/"/>
    <id>https://brokge.github.io/2020/07/10/JVM-è™šæ‹Ÿæœºè°ƒä¼˜å·¥å…·/</id>
    <published>2020-07-10T12:46:00.000Z</published>
    <updated>2020-08-21T04:56:55.615Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-JVM-è°ƒä¼˜ç›‘æ§å‘½ä»¤è¡Œå·¥å…·ä»‹ç»"><a href="#1-JVM-è°ƒä¼˜ç›‘æ§å‘½ä»¤è¡Œå·¥å…·ä»‹ç»" class="headerlink" title="1. JVM è°ƒä¼˜ç›‘æ§å‘½ä»¤è¡Œå·¥å…·ä»‹ç»"></a>1. JVM è°ƒä¼˜ç›‘æ§å‘½ä»¤è¡Œå·¥å…·ä»‹ç»</h1><a id="more"></a><h2 id="1-1-jps"><a href="#1-1-jps" class="headerlink" title="1.1 jps"></a>1.1 jps</h2><p>æŸ¥çœ‹è¿è¡Œè¿›ç¨‹ ä»¥åŠè¿›ç¨‹ idã€‚</p><h2 id="1-2-Jinfo"><a href="#1-2-Jinfo" class="headerlink" title="1.2 Jinfo"></a>1.2 Jinfo</h2><p>æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„Javaåº”ç”¨ç¨‹åºçš„æ‰©å±•å‚æ•°</p><ol><li>æŸ¥çœ‹jvmçš„å‚æ•°</li></ol><pre><code>jinfo -flags 30880</code></pre><ol start="2"><li><p>æŸ¥çœ‹javaç³»ç»Ÿå‚æ•°</p><pre><code>jinfo -sysprops 30880</code></pre><h2 id="1-3-jstat"><a href="#1-3-jstat" class="headerlink" title="1.3 jstat"></a>1.3 jstat</h2><p>jstat å‘½ä»¤å¯ä»¥æŸ¥çœ‹å †å†…å­˜å„éƒ¨åˆ†çš„ä½¿ç”¨é‡ï¼Œä»¥åŠåŠ è½½ç±»çš„æ•°é‡ã€‚å‘½ä»¤çš„æ ¼å¼å¦‚ä¸‹ï¼š<br>jstat [-å‘½ä»¤é€‰é¡¹] [vmid] [é—´éš”æ—¶é—´/æ¯«ç§’] [æŸ¥è¯¢æ¬¡æ•°]<br>æ³¨æ„ï¼šä½¿ç”¨çš„jdkç‰ˆæœ¬æ˜¯jdk8.</p></li><li><p>ç±»åŠ è½½ç»Ÿè®¡</p><pre><code>jstat -class 5989</code></pre></li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/B3B456FC88EE4870A8C30E2E785ECED4.jpg" alt="image"></p><table><thead><tr><th>æ ‡é¢˜</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>Loaded</td><td>åŠ è½½classçš„æ•°é‡</td></tr><tr><td>Bytes</td><td>æ‰€å ç”¨ç©ºé—´å¤§å°</td></tr><tr><td>Unloaded</td><td>æœªåŠ è½½æ•°é‡</td></tr><tr><td>Bytes</td><td>æœªåŠ è½½å ç”¨ç©ºé—´</td></tr><tr><td>Time</td><td>æ—¶é—´</td></tr></tbody></table><ol start="2"><li>åƒåœ¾å›æ”¶ç»Ÿè®¡</li></ol><pre><code>jstat -gc 5989</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/84830F699417470C859862202F3AA646.jpg" alt="image"></p><table><thead><tr><th>æ ‡é¢˜</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>S0C</td><td>ç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„å¤§å°</td></tr><tr><td>S1C</td><td>ç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„å¤§å°</td></tr><tr><td>S0U</td><td>ç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å°</td></tr><tr><td>S1U</td><td>ç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å°</td></tr><tr><td>EC</td><td>ä¼Šç”¸å›­åŒºçš„å¤§å°</td></tr><tr><td>EU</td><td>ä¼Šç”¸å›­åŒºçš„ä½¿ç”¨å¤§å°</td></tr><tr><td>OC</td><td>è€å¹´ä»£å¤§å°</td></tr><tr><td>OU</td><td>è€å¹´ä»£ä½¿ç”¨å¤§å°</td></tr><tr><td>MC</td><td>æ–¹æ³•åŒºå¤§å°(å…ƒç©ºé—´)</td></tr><tr><td>MU</td><td>æ–¹æ³•åŒºä½¿ç”¨å¤§å°</td></tr><tr><td>CCSC</td><td>å‹ç¼©ç±»ç©ºé—´å¤§å°</td></tr><tr><td>CCSU</td><td>å‹ç¼©ç±»ç©ºé—´ä½¿ç”¨å¤§å°</td></tr><tr><td>YGC</td><td>å¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•°</td></tr><tr><td>YGCT</td><td>å¹´è½»ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´</td></tr><tr><td>FGC</td><td>è€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•°</td></tr><tr><td>FGCT</td><td>è€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´</td></tr><tr><td>GCT</td><td>åƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´</td></tr></tbody></table><ol start="3"><li>å †å†…å­˜ç»Ÿè®¡</li></ol><pre><code>jstat -gccapacity 5989</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/E033D8E689C4436D81692D953BD25632.jpg" alt="image"></p><table><thead><tr><th>æ ‡é¢˜</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>NGCMN</td><td>æ–°ç”Ÿä»£æœ€å°å®¹é‡</td></tr><tr><td>NGCMX</td><td>æ–°ç”Ÿä»£æœ€å¤§å®¹é‡</td></tr><tr><td>NGC</td><td>å½“å‰æ–°ç”Ÿä»£å®¹é‡</td></tr><tr><td>S0C</td><td>ç¬¬ä¸€ä¸ªå¹¸å­˜åŒºå¤§å°</td></tr><tr><td>S1C</td><td>ç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„å¤§å°</td></tr><tr><td>EC</td><td>ä¼Šç”¸å›­åŒºçš„å¤§å°</td></tr><tr><td>OGCMN</td><td>è€å¹´ä»£æœ€å°å®¹é‡</td></tr><tr><td>OGCMX</td><td>è€å¹´ä»£æœ€å¤§å®¹é‡</td></tr><tr><td>OGC</td><td>å½“å‰è€å¹´ä»£å¤§å°</td></tr><tr><td>OC</td><td>å½“å‰è€å¹´ä»£å¤§å°</td></tr><tr><td>MCMN</td><td>æœ€å°å…ƒæ•°æ®å®¹é‡</td></tr><tr><td>MCMX</td><td>æœ€å¤§å…ƒæ•°æ®å®¹é‡</td></tr><tr><td>MC</td><td>å½“å‰å…ƒæ•°æ®ç©ºé—´å¤§å°</td></tr><tr><td>CCSMN</td><td>æœ€å°å‹ç¼©ç±»ç©ºé—´å¤§å°</td></tr><tr><td>CCSMX</td><td>æœ€å¤§å‹ç¼©ç±»ç©ºé—´å¤§å°</td></tr><tr><td>CCSC</td><td>å½“å‰å‹ç¼©ç±»ç©ºé—´å¤§å°</td></tr><tr><td>YGC</td><td>å¹´è½»ä»£gcæ¬¡æ•°</td></tr><tr><td>FGC</td><td>è€å¹´ä»£GCæ¬¡æ•°</td></tr></tbody></table><ol start="4"><li>æ–°ç”Ÿä»£åƒåœ¾å›æ”¶ç»Ÿè®¡</li></ol><pre><code>jstat -gcnew 13988</code></pre><ol start="5"><li>æ–°ç”Ÿä»£å†…å­˜ç»Ÿè®¡</li></ol><pre><code>jstat -gcnewcapacity 13988</code></pre><ol start="6"><li>è€å¹´ä»£åƒåœ¾å›æ”¶ç»Ÿè®¡</li></ol><pre><code>jstat -gcold 13988</code></pre><ol start="7"><li>è€å¹´ä»£å†…å­˜ç»Ÿè®¡<pre><code>jstat -gcoldcapacity 13988</code></pre></li><li>å…ƒæ•°æ®ç©ºé—´ç»Ÿè®¡<pre><code>jstat -gcmetacapacity 13988</code></pre></li></ol><h2 id="1-4-jmap"><a href="#1-4-jmap" class="headerlink" title="1.4 jmap"></a>1.4 jmap</h2><p>æ­¤å‘½ä»¤å¯ä»¥ç”¨æ¥æŸ¥çœ‹å†…å­˜ä¿¡æ¯,æŸ¥è¯¢å†…å­˜æº¢å‡ºï¼ˆOOMï¼‰å¯ä»¥é€šè¿‡è¿™ä¸ªå‘½ä»¤ã€‚</p><ol><li>å®ä¾‹ä¸ªæ•°ä»¥åŠå ç”¨å†…å­˜å¤§å°</li></ol><pre><code>jmap -histo 8899 &gt;./log.txt</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/7B15E576C60E4DCA9B09712C6D9930E6.jpg" alt="image"></p><table><thead><tr><th>æ ‡é¢˜</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>num</td><td>åºå·</td></tr><tr><td>instances</td><td>å®ä¾‹æ•°é‡</td></tr><tr><td>bytes</td><td>å ç”¨ç©ºé—´å¤§å°</td></tr><tr><td>class name</td><td>ç±»åç§°</td></tr></tbody></table><ol start="2"><li>å †ä¿¡æ¯</li></ol><pre><code>jmap -heap 8899</code></pre><ol start="3"><li>å †å†…å­˜dump</li></ol><pre><code>jmap -dump:format=b,file = log.hprof 8899</code></pre><p>ä¹Ÿå¯ä»¥è®¾ç½®å†…å­˜æº¢å‡ºè‡ªåŠ¨å¯¼å‡ºdumpæ–‡ä»¶(å†…å­˜å¾ˆå¤§çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå¯¼ä¸å‡ºæ¥)</p><pre><code>-XX:+HeapDumpOnOutOfMemoryError-XX:HeapDumpPath=./ ï¼ˆè·¯å¾„ï¼‰</code></pre><p>å¯ä»¥ç”¨ <code>jvisualvm</code> å‘½ä»¤å·¥å…·å¯¼å…¥è¯¥ dumpæ–‡ä»¶åˆ†æ</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/0843F9809FB540259A749275DFCEF883.jpg" alt="image"></p><h2 id="1-5-Jstack"><a href="#1-5-Jstack" class="headerlink" title="1.5 Jstack"></a>1.5 Jstack</h2><p>æŸ¥çœ‹å †æ ˆä¿¡æ¯,<strong>æ ˆæº¢å‡ºæˆ–æ­»é”å¯ä»¥é€šè¿‡è¿™ä¸ªå·¥å…·</strong>ã€‚</p><pre><code>jstack 88999</code></pre><p>ç”¨ jstack æŸ¥æ‰¾æ­»é”ï¼Œè§å¦‚ä¸‹ç¤ºä¾‹ï¼Œä¹Ÿå¯ä»¥ç”¨<code>jvisualvm</code> æŸ¥çœ‹æ­»é”</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLockTest</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Object lock1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Object lock2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock1<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"thread1 begin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock2<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"thread1 end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock2<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"thread2 begin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock1<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"thread2 end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main thread end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/0EB4FF290AC94746BAF3745D7CA1948F.jpg" alt="image"></p><h1 id="2-å¯è§†åŒ–å·¥å…·-jvisualvm"><a href="#2-å¯è§†åŒ–å·¥å…·-jvisualvm" class="headerlink" title="2. å¯è§†åŒ–å·¥å…· jvisualvm"></a>2. å¯è§†åŒ–å·¥å…· jvisualvm</h1><pre><code>jvisualvm</code></pre><h2 id="2-1-å¯åŠ¨jvisualvmçš„è¿œç¨‹é“¾æ¥"><a href="#2-1-å¯åŠ¨jvisualvmçš„è¿œç¨‹é“¾æ¥" class="headerlink" title="2.1 å¯åŠ¨jvisualvmçš„è¿œç¨‹é“¾æ¥"></a>2.1 å¯åŠ¨jvisualvmçš„è¿œç¨‹é“¾æ¥</h2><p>å¯åŠ¨æ™®é€šçš„jarç¨‹åºJMXç«¯å£é…ç½®ï¼š</p><pre><code>java -Dcom.sun.management.jmxremote.port=12345 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -jar foo.jar</code></pre><p>tomcatçš„JMXé…ç½®</p><pre><code>JAVA_OPTS=-Dcom.sun.management.jmxremote.port=8999-Dcom.sun.management.jmxremote.ssl=false-Dcom.sun.management.jmxremote.authenticate=false</code></pre><p>jvisualvm è¿œç¨‹è¿æ¥æœåŠ¡éœ€è¦åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šé…ç½®host(è¿æ¥ip ä¸»æœºå)ï¼Œå¹¶ä¸”è¦å…³é—­é˜²ç«å¢™ã€‚</p><h1 id="3-jstackæ‰¾å‡ºå ç”¨cpuæœ€é«˜çš„å †æ ˆä¿¡æ¯"><a href="#3-jstackæ‰¾å‡ºå ç”¨cpuæœ€é«˜çš„å †æ ˆä¿¡æ¯" class="headerlink" title="3. jstackæ‰¾å‡ºå ç”¨cpuæœ€é«˜çš„å †æ ˆä¿¡æ¯"></a>3. jstackæ‰¾å‡ºå ç”¨cpuæœ€é«˜çš„å †æ ˆä¿¡æ¯</h1><ol><li><p>ä½¿ç”¨å‘½ä»¤<code>top -p &lt;pid&gt;</code> ï¼Œæ˜¾ç¤ºä½ çš„javaè¿›ç¨‹çš„å†…å­˜æƒ…å†µï¼Œpidæ˜¯ä½ çš„javaè¿›ç¨‹å·ï¼Œæ¯”å¦‚4977</p></li><li><p>æŒ‰Hï¼Œè·å–æ¯ä¸ªçº¿ç¨‹çš„å†…å­˜æƒ…å†µ </p></li><li><p>æ‰¾åˆ°å†…å­˜å’Œcpuå ç”¨æœ€é«˜çš„çº¿ç¨‹tidï¼Œæ¯”å¦‚4977 </p></li><li><p>è½¬ä¸ºåå…­è¿›åˆ¶å¾—åˆ° 0x1371 ,æ­¤ä¸ºçº¿ç¨‹idçš„åå…­è¿›åˆ¶è¡¨ç¤º</p></li><li><p>æ‰§è¡Œ <code>jstack 4977|grep -A 10 1371</code>ï¼Œå¾—åˆ°çº¿ç¨‹å †æ ˆä¿¡æ¯ä¸­1371è¿™ä¸ªçº¿ç¨‹æ‰€åœ¨è¡Œçš„åé¢10è¡Œ </p></li><li><p>æŸ¥çœ‹å¯¹åº”çš„å †æ ˆä¿¡æ¯æ‰¾å‡ºå¯èƒ½å­˜åœ¨é—®é¢˜çš„ä»£ç </p></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;1-JVM-è°ƒä¼˜ç›‘æ§å‘½ä»¤è¡Œå·¥å…·ä»‹ç»&quot;&gt;&lt;a href=&quot;#1-JVM-è°ƒä¼˜ç›‘æ§å‘½ä»¤è¡Œå·¥å…·ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;1. JVM è°ƒä¼˜ç›‘æ§å‘½ä»¤è¡Œå·¥å…·ä»‹ç»&quot;&gt;&lt;/a&gt;1. JVM è°ƒä¼˜ç›‘æ§å‘½ä»¤è¡Œå·¥å…·ä»‹ç»&lt;/h1&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="è™šæ‹Ÿæœº" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E8%99%9A%E6%8B%9F%E6%9C%BA/"/>
    
    
      <category term="JVM" scheme="https://brokge.github.io/tags/JVM/"/>
    
      <category term="Java" scheme="https://brokge.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>JVM- å†…å­˜å›æ”¶æœºåˆ¶</title>
    <link href="https://brokge.github.io/2020/07/08/JVM-%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6/"/>
    <id>https://brokge.github.io/2020/07/08/JVM-å†…å­˜å›æ”¶æœºåˆ¶/</id>
    <published>2020-07-08T08:44:57.000Z</published>
    <updated>2020-08-21T04:57:07.389Z</updated>
    
    <content type="html"><![CDATA[<h1 id="JVM-å†…å­˜ç»“æ„"><a href="#JVM-å†…å­˜ç»“æ„" class="headerlink" title="JVM å†…å­˜ç»“æ„"></a>JVM å†…å­˜ç»“æ„</h1><a id="more"></a><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/84A35B9748EC46758F35BA070CBA4564.jpg" alt="image"></p><h1 id="2-JVMå†…å­˜åˆ†é…ä¸å›æ”¶"><a href="#2-JVMå†…å­˜åˆ†é…ä¸å›æ”¶" class="headerlink" title="2. JVMå†…å­˜åˆ†é…ä¸å›æ”¶"></a>2. JVMå†…å­˜åˆ†é…ä¸å›æ”¶</h1><h2 id="2-1-Minor-Gc-å’Œ-Full-GC-æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ"><a href="#2-1-Minor-Gc-å’Œ-Full-GC-æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ" class="headerlink" title="2.1 Minor Gc å’Œ Full GC æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ"></a>2.1 Minor Gc å’Œ Full GC æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ</h2><p>åƒåœ¾å›æ”¶æ–¹å¼æœ‰ä¸¤ç§ MinorGC å’Œ Full GC</p><p><strong>æ–°ç”Ÿä»£GCï¼ˆMinor GCï¼‰</strong>:æŒ‡å‘ç”Ÿæ–°ç”Ÿä»£çš„çš„åƒåœ¾æ”¶é›†åŠ¨ä½œï¼ŒMinor GCéå¸¸é¢‘ç¹ï¼Œå›æ”¶é€Ÿåº¦ä¸€èˆ¬ä¹Ÿæ¯”è¾ƒå¿«ã€‚é€šå¸¸ Minor GC ä¹Ÿå«åš Young GC.</p><p><strong>è€å¹´ä»£GCï¼ˆMajor GC/Full GC</strong>ï¼‰:æŒ‡å‘ç”Ÿåœ¨è€å¹´ä»£çš„ GCï¼Œå‡ºç°äº†Major GCç»å¸¸ä¼šä¼´éšè‡³å°‘ä¸€æ¬¡çš„ Minor GCï¼ˆå¹¶éç»å¯¹ï¼‰ï¼ŒMajor GCçš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯”Minor GCçš„æ…¢10å€ä»¥ä¸Šã€‚è€å¹´ä»£ GC ä¹Ÿå¯ç§°ä¸º Old GC.</p><h2 id="2-2-å¯¹è±¡ä¼˜å…ˆåœ¨EdenåŒºåˆ†é…"><a href="#2-2-å¯¹è±¡ä¼˜å…ˆåœ¨EdenåŒºåˆ†é…" class="headerlink" title="2.2 å¯¹è±¡ä¼˜å…ˆåœ¨EdenåŒºåˆ†é…"></a>2.2 å¯¹è±¡ä¼˜å…ˆåœ¨EdenåŒºåˆ†é…</h2><p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯¹è±¡åœ¨æ–°ç”Ÿä»£ä¸­ Eden åŒºåˆ†é…ã€‚å½“ Eden åŒºæ²¡æœ‰è¶³å¤Ÿç©ºé—´è¿›è¡Œåˆ†é…æ—¶ï¼Œè™šæ‹Ÿæœºå°†å‘èµ·ä¸€æ¬¡<strong>Minor GC</strong></p><h3 id="å®éªŒæµ‹è¯•"><a href="#å®éªŒæµ‹è¯•" class="headerlink" title="å®éªŒæµ‹è¯•"></a>å®éªŒæµ‹è¯•</h3><pre><code>public static void main(String[] args) throws InterruptedException {        byte[] allocation1, allocation2;        allocation1 = new byte[20231 * 1024];        //allocation2 = new byte[10000*1024];        try {            System.in.read();        } catch (IOException e) {            e.printStackTrace();        }    }</code></pre><pre><code>Heap PSYoungGen      total 38400K, used 26468K [0x0000000795580000, 0x0000000798000000, 0x00000007c0000000)  eden space 33280K, 79% used [0x0000000795580000,0x0000000796f59348,0x0000000797600000)  from space 5120K, 0% used [0x0000000797b00000,0x0000000797b00000,0x0000000798000000)  to   space 5120K, 0% used [0x0000000797600000,0x0000000797600000,0x0000000797b00000) ParOldGen       total 87552K, used 0K [0x0000000740000000, 0x0000000745580000, 0x0000000795580000)  object space 87552K, 0% used [0x0000000740000000,0x0000000740000000,0x0000000745580000) Metaspace       used 3600K, capacity 4536K, committed 4864K, reserved 1056768K  class space    used 401K, capacity 428K, committed 512K, reserved 1048576K</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/A58B033A8C194AF7BC9AC2684D048B35.jpg" alt="image"></p><p>ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºedenåŒºå†…å­˜å·²ç»è¢«åˆ†é…79%ï¼ˆå³ä½¿ç¨‹åºä»€ä¹ˆä¹Ÿä¸åšï¼Œæ–°ç”Ÿä»£ä¹Ÿä¼šä½¿ç”¨è‡³å°‘2000å¤škå†…å­˜ï¼‰ã€‚<br>å‡å¦‚æˆ‘ä»¬å†ä¸ºallocation2åˆ†é…å†…å­˜ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ  </p><pre><code>Heap PSYoungGen      total 38400K, used 3190K [0x0000000795580000, 0x000000079a080000, 0x00000007c0000000)  eden space 33280K, 8% used [0x0000000795580000,0x0000000795819a30,0x0000000797600000)  from space 5120K, 10% used [0x0000000797600000,0x0000000797684010,0x0000000797b00000)  to   space 5120K, 0% used [0x0000000799b80000,0x0000000799b80000,0x000000079a080000) ParOldGen       total 87552K, used 30239K [0x0000000740000000, 0x0000000745580000, 0x0000000795580000)  object space 87552K, 34% used [0x0000000740000000,0x0000000741d87c20,0x0000000745580000) Metaspace       used 3600K, capacity 4536K, committed 4864K, reserved 1056768K  class space    used 401K, capacity 428K, committed 512K, reserved 1048576K</code></pre><p>ç®€å•è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µï¼š å› ä¸ºç»™ allocation2 åˆ†é…å†…å­˜çš„æ—¶å€™edenåŒºå†…å­˜å‡ ä¹å·²ç»è¢«åˆ†é…å®Œäº†ï¼Œæˆ‘ä»¬åˆšåˆšè®²äº†å½“EdenåŒºæ²¡æœ‰è¶³å¤Ÿç©ºé—´è¿›è¡Œåˆ†é…æ—¶ï¼Œè™šæ‹Ÿæœºå°†å‘èµ·ä¸€æ¬¡ Minor GC.GC æœŸé—´è™šæ‹Ÿæœºåˆå‘ç° allocation1 æ— æ³•å­˜å…¥ Survior ç©ºé—´ï¼Œæ‰€ä»¥åªå¥½é€šè¿‡ åˆ†é…æ‹…ä¿æœºåˆ¶ æŠŠæ–°ç”Ÿä»£çš„å¯¹è±¡æå‰è½¬ç§»åˆ°è€å¹´ä»£ä¸­å»ï¼Œè€å¹´ä»£ä¸Šçš„ç©ºé—´è¶³å¤Ÿå­˜æ”¾ allocation1ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°Full GCã€‚æ‰§è¡Œ Minor GCåï¼Œåé¢åˆ†é…çš„å¯¹è±¡å¦‚æœèƒ½å¤Ÿå­˜åœ¨edenåŒºçš„è¯ï¼Œè¿˜æ˜¯ä¼šåœ¨edenåŒºåˆ†é…å†…å­˜ã€‚</p><p>å‘ç”Ÿ Minor GCçš„æ¬¡æ•° ä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢çš„ç»Ÿè®¡ä¿¡æ¯çœ‹åˆ°ï¼Œ<code>YGC = 1</code>ã€‚<br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/D005CBE2829A445E89EE71A29C44F692.jpg" alt="image"></p><h2 id="2-3-å¯¹è±¡è¿›å…¥è€å¹´çš„æ–¹å¼"><a href="#2-3-å¯¹è±¡è¿›å…¥è€å¹´çš„æ–¹å¼" class="headerlink" title="2.3 å¯¹è±¡è¿›å…¥è€å¹´çš„æ–¹å¼"></a>2.3 å¯¹è±¡è¿›å…¥è€å¹´çš„æ–¹å¼</h2><h3 id="2-3-1-å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£"><a href="#2-3-1-å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£" class="headerlink" title="2.3.1 å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£"></a>2.3.1 å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£</h3><p>å¤§å¯¹è±¡å°±æ˜¯éœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„å¯¹è±¡ï¼ˆæ¯”å¦‚ï¼šå­—ç¬¦ä¸²ã€æ•°ç»„ï¼‰ã€‚<br>ä¸ºä»€ä¹ˆè¦è¿™æ ·å‘¢ï¼Ÿ<br>ä¸ºäº†é¿å…ä¸ºå¤§å¯¹è±¡åˆ†é…å†…å­˜æ—¶ç”±äºåˆ†é…æ‹…ä¿æœºåˆ¶å¸¦æ¥çš„å¤åˆ¶è€Œé™ä½æ•ˆç‡ã€‚</p><h3 id="2-3-2-é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£"><a href="#2-3-2-é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£" class="headerlink" title="2.3.2 é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£"></a>2.3.2 é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£</h3><p>æ—¢ç„¶è™šæ‹Ÿæœºé‡‡ç”¨äº†åˆ†ä»£æ”¶é›†çš„æ€æƒ³æ¥ç®¡ç†å†…å­˜ï¼Œé‚£ä¹ˆå†…å­˜å›æ”¶æ—¶å°±å¿…é¡»èƒ½è¯†åˆ«é‚£äº›å¯¹è±¡åº”æ”¾åœ¨æ–°ç”Ÿä»£ï¼Œé‚£äº›å¯¹è±¡åº”æ”¾åœ¨è€å¹´ä»£ä¸­ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œè™šæ‹Ÿæœºç»™æ¯ä¸ªå¯¹è±¡ä¸€ä¸ªå¯¹è±¡å¹´é¾„ï¼ˆAgeï¼‰è®¡æ•°å™¨ã€‚<br>å¦‚æœå¯¹è±¡åœ¨ Eden å‡ºç”Ÿå¹¶ç»è¿‡ç¬¬ä¸€æ¬¡ Minor GC åä»ç„¶èƒ½å¤Ÿå­˜æ´»ï¼Œå¹¶ä¸”èƒ½è¢« Survivor å®¹çº³çš„è¯ï¼Œå°†è¢«ç§»åŠ¨åˆ° Survivor ç©ºé—´ä¸­ï¼Œå¹¶å°†å¯¹è±¡å¹´é¾„è®¾ä¸º1.å¯¹è±¡åœ¨ Survivor ä¸­æ¯ç†¬è¿‡ä¸€æ¬¡ MinorGC,å¹´é¾„å°±å¢åŠ 1å²ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆé»˜è®¤ä¸º15å²ï¼‰ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ä¸­ã€‚å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼ï¼Œå¯ä»¥é€šè¿‡å‚æ•° <code>-XX:MaxTenuringThreshold </code>æ¥è®¾ç½®ã€‚</p><h2 id="2-4-å¦‚ä½•åˆ¤æ–­å¯¹è±¡å¯ä»¥è¢«å›æ”¶"><a href="#2-4-å¦‚ä½•åˆ¤æ–­å¯¹è±¡å¯ä»¥è¢«å›æ”¶" class="headerlink" title="2.4 å¦‚ä½•åˆ¤æ–­å¯¹è±¡å¯ä»¥è¢«å›æ”¶"></a>2.4 å¦‚ä½•åˆ¤æ–­å¯¹è±¡å¯ä»¥è¢«å›æ”¶</h2><p>å †ä¸­å‡ ä¹æ”¾ç€æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ï¼Œå¯¹å †åƒåœ¾å›æ”¶å‰çš„ç¬¬ä¸€æ­¥å°±æ˜¯è¦åˆ¤æ–­é‚£äº›å¯¹è±¡å·²ç»æ­»äº¡ï¼ˆå³ä¸èƒ½å†è¢«ä»»ä½•é€”å¾„ä½¿ç”¨çš„å¯¹è±¡ï¼‰ã€‚</p><h3 id="2-4-1-å¼•ç”¨è®¡æ•°æ³•"><a href="#2-4-1-å¼•ç”¨è®¡æ•°æ³•" class="headerlink" title="2.4.1 å¼•ç”¨è®¡æ•°æ³•"></a>2.4.1 å¼•ç”¨è®¡æ•°æ³•</h3><p>ç»™å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œæ¯å½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨å®ƒï¼Œè®¡æ•°å™¨å°±åŠ 1ï¼›å½“å¼•ç”¨å¤±æ•ˆï¼Œè®¡æ•°å™¨å°±å‡1ï¼›ä»»ä½•æ—¶å€™è®¡æ•°å™¨ä¸º0çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ã€‚<br>è¿™ä¸ªæ–¹æ³•å®ç°ç®€å•ï¼Œæ•ˆç‡é«˜ï¼Œ==ä½†æ˜¯ç›®å‰ä¸»æµçš„è™šæ‹Ÿæœºä¸­å¹¶æ²¡æœ‰é€‰æ‹©è¿™ä¸ªç®—æ³•æ¥ç®¡ç†å†…å­˜ï¼Œå…¶æœ€ä¸»è¦çš„åŸå› æ˜¯å®ƒå¾ˆéš¾è§£å†³å¯¹è±¡ä¹‹é—´ç›¸äº’å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚ æ‰€è°“å¯¹è±¡ä¹‹é—´çš„ç›¸äº’å¼•ç”¨é—®é¢˜ï¼Œ== å¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼šé™¤äº†å¯¹è±¡objA å’Œ objB ç›¸äº’å¼•ç”¨ç€å¯¹æ–¹ä¹‹å¤–ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´å†æ— ä»»ä½•å¼•ç”¨ã€‚ä½†æ˜¯ä»–ä»¬å› ä¸ºäº’ç›¸å¼•ç”¨å¯¹æ–¹ï¼Œå¯¼è‡´å®ƒä»¬çš„å¼•ç”¨è®¡æ•°å™¨éƒ½ä¸ä¸º0ï¼Œäºæ˜¯å¼•ç”¨è®¡æ•°ç®—æ³•æ— æ³•é€šçŸ¥ GC å›æ”¶å™¨å›æ”¶ä»–ä»¬ã€‚</p><pre><code>public class ReferenceCountingGc {    Object instance = null;    public static void main(String[] args) {        ReferenceCountingGc objA = new ReferenceCountingGc();        ReferenceCountingGc objB = new ReferenceCountingGc();        objA.instance = objB;        objB.instance = objA;        objA = null;        objB = null;    }}</code></pre><h3 id="2-4-2-å¯è¾¾æ€§åˆ†æç®—æ³•"><a href="#2-4-2-å¯è¾¾æ€§åˆ†æç®—æ³•" class="headerlink" title="2.4.2 å¯è¾¾æ€§åˆ†æç®—æ³•"></a>2.4.2 å¯è¾¾æ€§åˆ†æç®—æ³•</h3><p>è¿™ä¸ªç®—æ³•çš„åŸºæœ¬æ€æƒ³å°±æ˜¯é€šè¿‡ä¸€ç³»åˆ—çš„ç§°ä¸º â€œGC Rootsâ€ çš„å¯¹è±¡ä½œä¸ºèµ·ç‚¹ï¼Œä»è¿™äº›èŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼ŒèŠ‚ç‚¹æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ° GC Roots æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿çš„è¯ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ˜¯ä¸å¯ç”¨çš„ã€‚</p><p><strong>GC Rootsæ ¹èŠ‚ç‚¹</strong>ï¼šç±»åŠ è½½å™¨ã€Threadã€è™šæ‹Ÿæœºæ ˆçš„æœ¬åœ°å˜é‡è¡¨ã€staticæˆå‘˜ã€å¸¸é‡å¼•ç”¨ã€æœ¬åœ°æ–¹æ³•æ ˆçš„å˜é‡ç­‰ç­‰</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/A5C7B9534B934431A6328BBAEE20FE9F.jpg" alt="image"></p><h3 id="2-4-3-finalize-æ–¹æ³•æœ€ç»ˆåˆ¤å®šå¯¹è±¡æ˜¯å¦å­˜æ´»"><a href="#2-4-3-finalize-æ–¹æ³•æœ€ç»ˆåˆ¤å®šå¯¹è±¡æ˜¯å¦å­˜æ´»" class="headerlink" title="2.4.3 finalize()æ–¹æ³•æœ€ç»ˆåˆ¤å®šå¯¹è±¡æ˜¯å¦å­˜æ´»"></a>2.4.3 finalize()æ–¹æ³•æœ€ç»ˆåˆ¤å®šå¯¹è±¡æ˜¯å¦å­˜æ´»</h3><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/FCBB514303EA44C79F7FD4315F15F2EC.jpg" alt="image"><br>å³ä½¿åœ¨å¯è¾¾æ€§åˆ†æç®—æ³•ä¸­ä¸å¯è¾¾çš„å¯¹è±¡ï¼Œä¹Ÿå¹¶éæ˜¯â€œéæ­»ä¸å¯â€çš„ï¼Œè¿™æ—¶å€™å®ƒä»¬æš‚æ—¶å¤„äºâ€œç¼“åˆ‘â€é˜¶æ®µï¼Œè¦çœŸæ­£å®£å‘Šä¸€ä¸ªå¯¹è±¡æ­»äº¡ï¼Œè¿˜å¯ä»¥å†æŠ¢æ•‘ä»¥ä¸‹ï¼Œè‡³å°‘è¦ç»å†å†æ¬¡æ ‡è®°è¿‡ç¨‹ã€‚æ ‡è®°çš„å‰ææ˜¯å¯¹è±¡åœ¨è¿›è¡Œå¯è¾¾æ€§åˆ†æåå‘ç°æ²¡æœ‰ä¸ GCRoots ç›¸è¿æ¥çš„å¼•ç”¨é“¾ã€‚</p><p>ä¸¤æ¬¡æ ‡è®° ã€‚</p><ol><li><p>ç¬¬ä¸€æ¬¡æ ‡è®°å¹¶è¿›è¡Œä¸€æ¬¡ç­›é€‰ã€‚<br>ç­›é€‰çš„æ¡ä»¶æ˜¯æ­¤å¯¹è±¡æ˜¯å¦æœ‰å¿…è¦æ‰§è¡Œfinalize()æ–¹æ³•ã€‚<br>å½“å¯¹è±¡æ²¡æœ‰è¦†ç›–finalizeæ–¹æ³•ï¼Œæˆ–è€…finzlizeæ–¹æ³•å·²ç»è¢«è™šæ‹Ÿæœºè°ƒç”¨è¿‡ï¼Œè™šæ‹Ÿæœºå°†è¿™ä¸¤ç§æƒ…å†µéƒ½è§†ä¸ºâ€œæ²¡æœ‰å¿…è¦æ‰§è¡Œâ€ï¼Œå¯¹è±¡è¢«å›æ”¶ã€‚</p></li><li><p>ç¬¬äºŒæ¬¡æ ‡è®°<br>å¦‚æœè¿™ä¸ªå¯¹è±¡è¢«åˆ¤å®šä¸ºæœ‰å¿…è¦æ‰§è¡Œfinalizeï¼ˆï¼‰æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°†ä¼šè¢«æ”¾ç½®åœ¨ä¸€ä¸ªåä¸ºï¼šF-Queueçš„é˜Ÿåˆ—ä¹‹ä¸­ï¼Œå¹¶åœ¨ç¨åç”±ä¸€æ¡è™šæ‹Ÿæœºè‡ªåŠ¨å»ºç«‹çš„ã€ä½ä¼˜å…ˆçº§çš„Finalizerçº¿ç¨‹å»æ‰§è¡Œã€‚è¿™é‡Œæ‰€è°“çš„â€œæ‰§è¡Œâ€æ˜¯æŒ‡è™šæ‹Ÿæœºä¼šè§¦å‘è¿™ä¸ªæ–¹æ³•ï¼Œä½†å¹¶ä¸æ‰¿è¯ºä¼šç­‰å¾…å®ƒè¿è¡Œç»“æŸã€‚è¿™æ ·åšçš„åŸå› æ˜¯ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡finalizeï¼ˆï¼‰æ–¹æ³•ä¸­æ‰§è¡Œç¼“æ…¢ï¼Œæˆ–è€…å‘ç”Ÿæ­»å¾ªç¯ï¼ˆæ›´æç«¯çš„æƒ…å†µï¼‰ï¼Œå°†å¾ˆå¯èƒ½ä¼šå¯¼è‡´F-Queueé˜Ÿåˆ—ä¸­çš„å…¶ä»–å¯¹è±¡æ°¸ä¹…å¤„äºç­‰å¾…çŠ¶æ€ï¼Œç”šè‡³å¯¼è‡´æ•´ä¸ªå†…å­˜å›æ”¶ç³»ç»Ÿå´©æºƒã€‚</p></li></ol><p>finalizeï¼ˆï¼‰æ–¹æ³•æ˜¯å¯¹è±¡è„±é€ƒæ­»äº¡å‘½è¿çš„æœ€åä¸€æ¬¡æœºä¼šï¼Œç¨åGCå°†å¯¹F-Queueä¸­çš„å¯¹è±¡è¿›è¡Œç¬¬äºŒæ¬¡å°è§„æ¨¡æ ‡è®°ï¼Œå¦‚æœå¯¹è±¡è¦åœ¨finalizeï¼ˆï¼‰ä¸­æˆåŠŸæ‹¯æ•‘è‡ªå·±(åªè¦é‡æ–°ä¸å¼•ç”¨é“¾ä¸Šçš„ä»»ä½•çš„ä¸€ä¸ªå¯¹è±¡å»ºç«‹å…³è”å³å¯)ï¼Œè­¬å¦‚æŠŠè‡ªå·±èµ‹å€¼ç»™æŸä¸ªç±»å˜é‡æˆ–å¯¹è±¡çš„æˆå‘˜å˜é‡ï¼Œé‚£åœ¨ç¬¬äºŒæ¬¡æ ‡è®°æ—¶å®ƒå°†ç§»é™¤å‡ºâ€œå³å°†å›æ”¶â€çš„é›†åˆã€‚</p><p>å¦‚æœå¯¹è±¡è¿™æ—¶å€™è¿˜æ²¡é€ƒè„±ï¼Œé‚£åŸºæœ¬ä¸Šå®ƒå°±çœŸçš„è¢«å›æ”¶äº†ã€‚</p><p> æµ‹è¯•ä»£ç ï¼š</p><pre><code>public class OOMTest {    // JVMè®¾ç½®    // -Xms10M -Xmx10M -XX:+PrintGCDetails -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=D:\jvm.dump    public static void main(String[] args) {        List list = new ArrayList();        int i = 0;        int j = 0;        while (true) {            list.add(new User(i++, UUID.randomUUID().toString()));            new User(j--, UUID.randomUUID().toString());        }    }}</code></pre><h3 id="2-4-4-å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¸¸é‡æ˜¯åºŸå¼ƒå¸¸é‡"><a href="#2-4-4-å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¸¸é‡æ˜¯åºŸå¼ƒå¸¸é‡" class="headerlink" title="2.4.4 å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¸¸é‡æ˜¯åºŸå¼ƒå¸¸é‡"></a>2.4.4 å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¸¸é‡æ˜¯åºŸå¼ƒå¸¸é‡</h3><p>è¿è¡Œæ—¶å¸¸é‡æ± ä¸»è¦å›æ”¶çš„æ˜¯åºŸå¼ƒçš„å¸¸é‡ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¸¸é‡æ˜¯åºŸå¼ƒå¸¸é‡å‘¢ï¼Ÿ<br>å‡å¦‚åœ¨å¸¸é‡æ± ä¸­å­˜åœ¨å­—ç¬¦ä¸² â€œabcâ€ï¼Œå¦‚æœå½“å‰æ²¡æœ‰ä»»ä½•Stringå¯¹è±¡å¼•ç”¨è¯¥å­—ç¬¦ä¸²å¸¸é‡çš„è¯ï¼Œå°±è¯´æ˜å¸¸é‡ â€œabcâ€ å°±æ˜¯åºŸå¼ƒå¸¸é‡ï¼Œå¦‚æœè¿™æ—¶å‘ç”Ÿå†…å­˜å›æ”¶çš„è¯è€Œä¸”æœ‰å¿…è¦çš„è¯ï¼Œâ€abcâ€ å°±ä¼šè¢«ç³»ç»Ÿæ¸…ç†å‡ºå¸¸é‡æ± ã€‚</p><h3 id="2-4-5-å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯æ— ç”¨çš„ç±»"><a href="#2-4-5-å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯æ— ç”¨çš„ç±»" class="headerlink" title="2.4.5 å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯æ— ç”¨çš„ç±»"></a>2.4.5 å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯æ— ç”¨çš„ç±»</h3><p>æ–¹æ³•åŒºä¸»è¦å›æ”¶çš„æ˜¯æ— ç”¨çš„ç±»ï¼Œé‚£ä¹ˆå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯æ— ç”¨çš„ç±»çš„å‘¢ï¼Ÿ<br>åˆ¤å®šä¸€ä¸ªå¸¸é‡æ˜¯å¦æ˜¯â€œåºŸå¼ƒå¸¸é‡â€æ¯”è¾ƒç®€å•ï¼Œè€Œè¦åˆ¤å®šä¸€ä¸ªç±»æ˜¯å¦æ˜¯â€œæ— ç”¨çš„ç±»â€çš„æ¡ä»¶åˆ™ç›¸å¯¹è‹›åˆ»è®¸å¤šã€‚ç±»éœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢3ä¸ªæ¡ä»¶æ‰èƒ½ç®—æ˜¯ â€œæ— ç”¨çš„ç±»â€ ï¼š</p><ol><li>è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯ Java å †ä¸­ä¸å­˜åœ¨è¯¥ç±»çš„ä»»ä½•å®ä¾‹ã€‚</li><li>åŠ è½½è¯¥ç±»çš„ ClassLoader å·²ç»è¢«å›æ”¶ã€‚</li><li>è¯¥ç±»å¯¹åº”çš„ java.lang.Classå¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚</li></ol><p>è™šæ‹Ÿæœºå¯ä»¥å¯¹æ»¡è¶³ä¸Šè¿°3ä¸ªæ¡ä»¶çš„æ— ç”¨ç±»è¿›è¡Œå›æ”¶ï¼Œè¿™é‡Œè¯´çš„ä»…ä»…æ˜¯â€œå¯ä»¥â€ï¼Œè€Œå¹¶ä¸æ˜¯å’Œå¯¹è±¡ä¸€æ ·ä¸ä½¿ç”¨äº†å°±ä¼šå¿…ç„¶è¢«å›æ”¶ã€‚</p><h1 id="3-åƒåœ¾æ”¶é›†ç®—æ³•"><a href="#3-åƒåœ¾æ”¶é›†ç®—æ³•" class="headerlink" title="3. åƒåœ¾æ”¶é›†ç®—æ³•"></a>3. åƒåœ¾æ”¶é›†ç®—æ³•</h1><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/CF04E79D16864FCDAB9BCA4AED74A82E.jpg" alt="image"></p><h2 id="3-1-æ ‡è®°-æ¸…é™¤ç®—æ³•"><a href="#3-1-æ ‡è®°-æ¸…é™¤ç®—æ³•" class="headerlink" title="3.1 æ ‡è®°-æ¸…é™¤ç®—æ³•"></a>3.1 æ ‡è®°-æ¸…é™¤ç®—æ³•</h2><p>ç®—æ³•åˆ†ä¸ºâ€œæ ‡è®°â€å’Œâ€œæ¸…é™¤â€é˜¶æ®µï¼šé¦–å…ˆæ ‡è®°å‡ºæ‰€æœ‰éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®Œæˆåç»Ÿä¸€å›æ”¶æ‰€æœ‰è¢«æ ‡è®°çš„å¯¹è±¡ã€‚å®ƒæ˜¯æœ€åŸºç¡€çš„æ”¶é›†ç®—æ³•ï¼Œæ•ˆç‡ä¹Ÿå¾ˆé«˜ï¼Œä½†æ˜¯ä¼šå¸¦æ¥ä¸¤ä¸ªæ˜æ˜¾çš„é—®é¢˜ï¼š</p><ol><li>æ•ˆç‡é—®é¢˜</li><li>ç©ºé—´é—®é¢˜ï¼ˆæ ‡è®°æ¸…é™¤åä¼šäº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„ç¢ç‰‡ï¼‰</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/D20509B98FA94400B0119A7F96237875.jpg" alt="image"> </p><h2 id="3-2-å¤åˆ¶ç®—æ³•"><a href="#3-2-å¤åˆ¶ç®—æ³•" class="headerlink" title="3.2 å¤åˆ¶ç®—æ³•"></a>3.2 å¤åˆ¶ç®—æ³•</h2><p>ä¸ºäº†è§£å†³æ•ˆç‡é—®é¢˜ï¼Œâ€œå¤åˆ¶â€æ”¶é›†ç®—æ³•å‡ºç°äº†ã€‚å®ƒå¯ä»¥å°†å†…å­˜åˆ†ä¸ºå¤§å°ç›¸åŒçš„ä¸¤å—ï¼Œæ¯æ¬¡ä½¿ç”¨å…¶ä¸­çš„ä¸€å—ã€‚å½“è¿™ä¸€å—çš„å†…å­˜ä½¿ç”¨å®Œåï¼Œå°±å°†è¿˜å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—å»ï¼Œç„¶åå†æŠŠä½¿ç”¨çš„ç©ºé—´ä¸€æ¬¡æ¸…ç†æ‰ã€‚è¿™æ ·å°±ä½¿æ¯æ¬¡çš„å†…å­˜å›æ”¶éƒ½æ˜¯å¯¹å†…å­˜åŒºé—´çš„ä¸€åŠè¿›è¡Œå›æ”¶ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/63CB574DAD564B5483B146B5D49DDF14.jpg" alt="image"></p><h2 id="3-3-æ ‡è®°-æ•´ç†ç®—æ³•"><a href="#3-3-æ ‡è®°-æ•´ç†ç®—æ³•" class="headerlink" title="3.3 æ ‡è®°-æ•´ç†ç®—æ³•"></a>3.3 æ ‡è®°-æ•´ç†ç®—æ³•</h2><p>æ ¹æ®è€å¹´ä»£çš„ç‰¹ç‚¹ç‰¹å‡ºçš„ä¸€ç§æ ‡è®°ç®—æ³•ï¼Œæ ‡è®°è¿‡ç¨‹ä»ç„¶ä¸â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•ä¸€æ ·ï¼Œä½†åç»­æ­¥éª¤ä¸æ˜¯ç›´æ¥å¯¹å¯å›æ”¶å¯¹è±¡å›æ”¶ï¼Œè€Œæ˜¯è®©æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡å‘ä¸€æ®µç§»åŠ¨ï¼Œç„¶åç›´æ¥æ¸…ç†æ‰ç«¯è¾¹ç•Œä»¥å¤–çš„å†…å­˜ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/F3E25E0FA9F84E2DA27673E094DF04E5.jpg" alt="image"><br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/146612F58E97421CA4EB3ACC2A630B77.jpg" alt="image"><br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/5C04D60F7EA64FBB9A7CD1EDAA232368.jpg" alt="image"><br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/E82EA683993C42109AB7CBBDAC405717.jpg" alt="image"></p><h2 id="3-4-åˆ†ä»£æ”¶é›†ç®—æ³•"><a href="#3-4-åˆ†ä»£æ”¶é›†ç®—æ³•" class="headerlink" title="3.4 åˆ†ä»£æ”¶é›†ç®—æ³•"></a>3.4 åˆ†ä»£æ”¶é›†ç®—æ³•</h2><p>å½“å‰è™šæ‹Ÿæœºçš„åƒåœ¾æ”¶é›†éƒ½é‡‡ç”¨åˆ†ä»£æ”¶é›†ç®—æ³•ï¼Œè¿™ç§ç®—æ³•æ²¡æœ‰ä»€ä¹ˆæ–°çš„æ€æƒ³ï¼Œåªæ˜¯æ ¹æ®å¯¹è±¡å­˜æ´»å‘¨æœŸçš„ä¸åŒå°†å†…å­˜åˆ†ä¸ºå‡ å—ã€‚ä¸€èˆ¬å°†javaå †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®å„ä¸ªå¹´ä»£çš„ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„åƒåœ¾æ”¶é›†ç®—æ³•ã€‚<br>æ¯”å¦‚åœ¨æ–°ç”Ÿä»£ä¸­ï¼Œæ¯æ¬¡æ”¶é›†éƒ½ä¼šæœ‰å¤§é‡å¯¹è±¡æ­»å»ï¼Œæ‰€ä»¥å¯ä»¥é€‰æ‹©å¤åˆ¶ç®—æ³•ï¼Œåªéœ€è¦ä»˜å‡ºå°‘é‡å¯¹è±¡çš„å¤åˆ¶æˆæœ¬å°±å¯ä»¥å®Œæˆæ¯æ¬¡åƒåœ¾æ”¶é›†ã€‚è€Œè€å¹´ä»£çš„å¯¹è±¡å­˜æ´»å‡ ç‡æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œè€Œä¸”æ²¡æœ‰é¢å¤–çš„ç©ºé—´å¯¹å®ƒè¿›è¡Œåˆ†é…æ‹…ä¿ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»é€‰æ‹©â€œæ ‡è®°-æ¸…é™¤â€æˆ–â€œæ ‡è®°-æ•´ç†â€ç®—æ³•è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚</p><h1 id="4-åƒåœ¾æ”¶é›†å™¨"><a href="#4-åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="4. åƒåœ¾æ”¶é›†å™¨"></a>4. åƒåœ¾æ”¶é›†å™¨</h1><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/81F9203653EF45968896617D2F39B6FB.jpg" alt="image"></p><p>å¦‚æœè¯´æ”¶é›†ç®—æ³•æ˜¯å†…å­˜å›æ”¶çš„æ–¹æ³•è®ºï¼Œé‚£ä¹ˆåƒåœ¾æ”¶é›†å™¨å°±æ˜¯å†…å­˜å›æ”¶çš„å…·ä½“å®ç°ã€‚</p><p>å…ˆå¯¹ å¹¶è¡Œå’Œå¹¶å‘æ¦‚å¿µè¿›è¡Œäº†è§£ï¼š</p><ul><li>å¹¶è¡Œï¼ˆParallelï¼‰ ï¼šæŒ‡å¤šæ¡åƒåœ¾æ”¶é›†çº¿ç¨‹å¹¶è¡Œå·¥ä½œï¼Œä½†æ­¤æ—¶ç”¨æˆ·çº¿ç¨‹ä»ç„¶å¤„äºç­‰å¾…çŠ¶æ€ã€‚é€‚åˆç§‘å­¦è®¡ç®—ã€åå°å¤„ç†ç­‰å¼±äº¤äº’åœºæ™¯ã€‚</li><li>å¹¶å‘ï¼ˆConcurrentï¼‰ï¼šæŒ‡ç”¨æˆ·çº¿ç¨‹ä¸åƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼ˆä½†ä¸ä¸€å®šæ˜¯å¹¶è¡Œï¼Œå¯èƒ½ä¼šäº¤æ›¿æ‰§è¡Œï¼‰ï¼Œç”¨æˆ·ç¨‹åºåœ¨ç»§ç»­è¿è¡Œï¼Œè€Œåƒåœ¾æ”¶é›†å™¨è¿è¡Œåœ¨å¦ä¸€ä¸ªCPUä¸Šã€‚é€‚åˆWebåº”ç”¨ã€‚</li></ul><p>è™½ç„¶æˆ‘ä»¬å¯¹å„ä¸ªæ”¶é›†å™¨è¿›è¡Œæ¯”è¾ƒï¼Œä½†å¹¶éä¸ºäº†æŒ‘é€‰å‡ºä¸€ä¸ªæœ€å¥½çš„æ”¶é›†å™¨ã€‚å› ä¸ºç›´åˆ°ç°åœ¨ä¸ºæ­¢è¿˜æ²¡æœ‰æœ€å¥½çš„åƒåœ¾æ”¶é›†å™¨å‡ºç°ï¼Œæ›´åŠ æ²¡æœ‰ä¸‡èƒ½çš„åƒåœ¾æ”¶é›†å™¨ï¼Œæˆ‘ä»¬èƒ½åšçš„å°±æ˜¯æ ¹æ®å…·ä½“åº”ç”¨åœºæ™¯é€‰æ‹©é€‚åˆè‡ªå·±çš„åƒåœ¾æ”¶é›†å™¨ã€‚è¯•æƒ³ä¸€ä¸‹ï¼šå¦‚æœæœ‰ä¸€ç§å››æµ·ä¹‹å†…ã€ä»»ä½•åœºæ™¯ä¸‹éƒ½é€‚ç”¨çš„å®Œç¾æ”¶é›†å™¨å­˜åœ¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„HotSpotè™šæ‹Ÿæœºå°±ä¸ä¼šå®ç°é‚£ä¹ˆå¤šä¸åŒçš„åƒåœ¾æ”¶é›†å™¨äº†ã€‚</p><h2 id="4-1-Serialæ”¶é›†å™¨"><a href="#4-1-Serialæ”¶é›†å™¨" class="headerlink" title="4.1 Serialæ”¶é›†å™¨"></a>4.1 Serialæ”¶é›†å™¨</h2><p>Serialï¼ˆä¸²è¡Œï¼‰æ”¶é›†å™¨æ”¶é›†å™¨æ˜¯æœ€åŸºæœ¬ã€å†å²æœ€æ‚ ä¹…çš„åƒåœ¾æ”¶é›†å™¨äº†ã€‚å¤§å®¶çœ‹åå­—å°±çŸ¥é“è¿™ä¸ªæ”¶é›†å™¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ”¶é›†å™¨äº†ã€‚å®ƒçš„ â€œå•çº¿ç¨‹â€ çš„æ„ä¹‰ä¸ä»…ä»…æ„å‘³ç€å®ƒåªä¼šä½¿ç”¨ä¸€æ¡åƒåœ¾æ”¶é›†çº¿ç¨‹å»å®Œæˆåƒåœ¾æ”¶é›†å·¥ä½œï¼Œæ›´é‡è¦çš„æ˜¯å®ƒåœ¨è¿›è¡Œåƒåœ¾æ”¶é›†å·¥ä½œçš„æ—¶å€™å¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼ˆ â€œStop The Worldâ€ ï¼‰ï¼Œç›´åˆ°å®ƒæ”¶é›†ç»“æŸã€‚</p><p>++æ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚++</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/C6E4EECA4B7544B4B00A334485A89AEA.jpg" alt="image"></p><p>è™šæ‹Ÿæœºçš„è®¾è®¡è€…ä»¬å½“ç„¶çŸ¥é“ <code>Stop The World</code> å¸¦æ¥çš„ä¸è‰¯ç”¨æˆ·ä½“éªŒï¼Œæ‰€ä»¥åœ¨åç»­çš„åƒåœ¾æ”¶é›†å™¨è®¾è®¡ä¸­åœé¡¿æ—¶é—´åœ¨ä¸æ–­ç¼©çŸ­ï¼ˆä»ç„¶è¿˜æœ‰åœé¡¿ï¼Œå¯»æ‰¾æœ€ä¼˜ç§€çš„åƒåœ¾æ”¶é›†å™¨çš„è¿‡ç¨‹ä»ç„¶åœ¨ç»§ç»­ï¼‰ã€‚<br>ä½†æ˜¯Serialæ”¶é›†å™¨æœ‰æ²¡æœ‰ä¼˜äºå…¶ä»–åƒåœ¾æ”¶é›†å™¨çš„åœ°æ–¹å‘¢ï¼Ÿå½“ç„¶æœ‰ï¼Œå®ƒç®€å•è€Œé«˜æ•ˆï¼ˆä¸å…¶ä»–æ”¶é›†å™¨çš„å•çº¿ç¨‹ç›¸æ¯”ï¼‰ã€‚Serialæ”¶é›†å™¨ç”±äºæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œè‡ªç„¶å¯ä»¥è·å¾—å¾ˆé«˜çš„å•çº¿ç¨‹æ”¶é›†æ•ˆç‡ã€‚</p><h2 id="4-2-ParNewæ”¶é›†å™¨"><a href="#4-2-ParNewæ”¶é›†å™¨" class="headerlink" title="4.2 ParNewæ”¶é›†å™¨"></a>4.2 ParNewæ”¶é›†å™¨</h2><p>ParNewæ”¶é›†å™¨å…¶å®å°±æ˜¯Serialæ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œé™¤äº†ä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†å¤–ï¼Œå…¶ä½™è¡Œä¸ºï¼ˆæ§åˆ¶å‚æ•°ã€æ”¶é›†ç®—æ³•ã€å›æ”¶ç­–ç•¥ç­‰ç­‰ï¼‰å’ŒSerialæ”¶é›†å™¨å®Œå…¨ä¸€æ ·ã€‚<br>==æ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚==</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/EF654130AB66417EAFEFC1C1F8C20338.jpg" alt="image"></p><p>å®ƒæ˜¯è®¸å¤šè¿è¡Œåœ¨Serveræ¨¡å¼ä¸‹çš„è™šæ‹Ÿæœºçš„é¦–è¦é€‰æ‹©ï¼Œé™¤äº†Serialæ”¶é›†å™¨å¤–ï¼Œåªæœ‰å®ƒèƒ½ä¸CMSæ”¶é›†å™¨ï¼ˆçœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘æ”¶é›†å™¨ï¼Œåé¢ä¼šä»‹ç»åˆ°ï¼‰é…åˆå·¥ä½œã€‚</p><h2 id="4-3-Parallel-Scavengeæ”¶é›†å™¨"><a href="#4-3-Parallel-Scavengeæ”¶é›†å™¨" class="headerlink" title="4.3 Parallel Scavengeæ”¶é›†å™¨"></a>4.3 Parallel Scavengeæ”¶é›†å™¨</h2><p>Parallel Scavenge æ”¶é›†å™¨ç±»ä¼¼äº ParNew æ”¶é›†å™¨ï¼Œæ˜¯ Server æ¨¡å¼ï¼ˆå†…å­˜å¤§äº 2Gï¼Œ2 ä¸ª cpuï¼‰ä¸‹çš„é»˜è®¤æ”¶é›†å™¨ï¼Œé‚£ä¹ˆå®ƒæœ‰ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„å‘¢ï¼Ÿ</p><p>Parallel Scavengeæ”¶é›†å™¨å…³æ³¨ç‚¹æ˜¯ååé‡ï¼ˆé«˜æ•ˆç‡çš„åˆ©ç”¨CPUï¼‰ã€‚CMSç­‰åƒåœ¾æ”¶é›†å™¨çš„å…³æ³¨ç‚¹æ›´å¤šçš„æ˜¯ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ï¼ˆæé«˜ç”¨æˆ·ä½“éªŒï¼‰ã€‚æ‰€è°“ååé‡å°±æ˜¯CPUä¸­ç”¨äºè¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´ä¸CPUæ€»æ¶ˆè€—æ—¶é—´çš„æ¯”å€¼ã€‚ Parallel Scavengeæ”¶é›†å™¨æä¾›äº†å¾ˆå¤šå‚æ•°ä¾›ç”¨æˆ·æ‰¾åˆ°æœ€åˆé€‚çš„åœé¡¿æ—¶é—´æˆ–æœ€å¤§ååé‡ï¼Œå¦‚æœå¯¹äºæ”¶é›†å™¨è¿ä½œä¸å¤ªäº†è§£çš„è¯ï¼Œå¯ä»¥é€‰æ‹©æŠŠå†…å­˜ç®¡ç†ä¼˜åŒ–äº¤ç»™è™šæ‹Ÿæœºå»å®Œæˆä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚<br>==æ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚==</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/CB2FC5646BCD4E00973AD3CF38DF1D2F.jpg" alt="image"></p><h2 id="4-4-Serial-Oldæ”¶é›†å™¨"><a href="#4-4-Serial-Oldæ”¶é›†å™¨" class="headerlink" title="4.4 Serial Oldæ”¶é›†å™¨"></a>4.4 Serial Oldæ”¶é›†å™¨</h2><p>Serialæ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œå®ƒåŒæ ·æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ”¶é›†å™¨ã€‚å®ƒä¸»è¦æœ‰ä¸¤å¤§ç”¨é€”ï¼šä¸€ç§ç”¨é€”æ˜¯åœ¨JDK1.5ä»¥åŠä»¥å‰çš„ç‰ˆæœ¬ä¸­ä¸Parallel Scavengeæ”¶é›†å™¨æ­é…ä½¿ç”¨ï¼Œå¦ä¸€ç§ç”¨é€”æ˜¯ä½œä¸ºCMSæ”¶é›†å™¨çš„åå¤‡æ–¹æ¡ˆã€‚</p><h2 id="4-5-Parallel-Oldæ”¶é›†å™¨"><a href="#4-5-Parallel-Oldæ”¶é›†å™¨" class="headerlink" title="4.5 Parallel Oldæ”¶é›†å™¨"></a>4.5 Parallel Oldæ”¶é›†å™¨</h2><p>Parallel Scavengeæ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬ã€‚ä½¿ç”¨å¤šçº¿ç¨‹å’Œâ€œæ ‡è®°-æ•´ç†â€ç®—æ³•ã€‚åœ¨æ³¨é‡ååé‡ä»¥åŠCPUèµ„æºçš„åœºåˆï¼Œéƒ½å¯ä»¥ä¼˜å…ˆè€ƒè™‘ Parallel Scavengeæ”¶é›†å™¨å’ŒParallel Oldæ”¶é›†å™¨ã€‚</p><h2 id="4-6-CMSæ”¶é›†å™¨-XX-UseConcMarkSweepGC-ä¸»è¦æ˜¯oldåŒºä½¿ç”¨"><a href="#4-6-CMSæ”¶é›†å™¨-XX-UseConcMarkSweepGC-ä¸»è¦æ˜¯oldåŒºä½¿ç”¨" class="headerlink" title="4.6 CMSæ”¶é›†å™¨(-XX:+UseConcMarkSweepGC(ä¸»è¦æ˜¯oldåŒºä½¿ç”¨))"></a>4.6 CMSæ”¶é›†å™¨(-XX:+UseConcMarkSweepGC(ä¸»è¦æ˜¯oldåŒºä½¿ç”¨))</h2><p>CMSï¼ˆConcurrent MarkSweepï¼‰æ”¶é›†å™¨æ˜¯ä¸€ç§ä»¥è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡çš„æ”¶é›†å™¨ã€‚å®ƒè€Œéå¸¸ç¬¦åˆåœ¨æ³¨é‡ç”¨æˆ·ä½“éªŒçš„åº”ç”¨ä¸Šä½¿ç”¨ï¼Œå®ƒæ˜¯HotSpotè™šæ‹Ÿæœºç¬¬ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘æ”¶é›†å™¨ï¼Œå®ƒç¬¬ä¸€æ¬¡å®ç°äº†è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹ï¼ˆåŸºæœ¬ä¸Šï¼‰åŒæ—¶å·¥ä½œã€‚</p><p>ä»åå­—ä¸­çš„Mark Sweepè¿™ä¸¤ä¸ªè¯å¯ä»¥çœ‹å‡ºï¼ŒCMSæ”¶é›†å™¨æ˜¯ä¸€ç§ â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•å®ç°çš„ï¼Œå®ƒçš„è¿ä½œè¿‡ç¨‹ç›¸æ¯”äºå‰é¢å‡ ç§åƒåœ¾æ”¶é›†å™¨æ¥è¯´æ›´åŠ å¤æ‚ä¸€äº›ã€‚</p><p>æ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼š</p><ul><li>åˆå§‹æ ‡è®°ï¼šæš‚åœæ‰€æœ‰çš„å…¶ä»–çº¿ç¨‹(STW)ï¼Œå¹¶è®°å½•ä¸‹ç›´æ¥ä¸rootç›¸è¿çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿« ï¼›</li><li>å¹¶å‘æ ‡è®°ï¼šåŒæ—¶å¼€å¯GCå’Œç”¨æˆ·çº¿ç¨‹ï¼Œç”¨ä¸€ä¸ªé—­åŒ…ç»“æ„å»è®°å½•å¯è¾¾å¯¹è±¡ã€‚ä½†åœ¨è¿™ä¸ªé˜¶æ®µç»“æŸï¼Œè¿™ä¸ªé—­åŒ…ç»“æ„å¹¶ä¸èƒ½ä¿è¯åŒ…å«å½“å‰æ‰€æœ‰çš„å¯è¾¾å¯¹è±¡ã€‚å› ä¸ºç”¨æˆ·çº¿ç¨‹å¯èƒ½ä¼šä¸æ–­çš„æ›´æ–°å¼•ç”¨åŸŸï¼Œæ‰€ä»¥GCçº¿ç¨‹æ— æ³•ä¿è¯å¯è¾¾æ€§åˆ†æçš„å®æ—¶æ€§ã€‚æ‰€ä»¥è¿™ä¸ªç®—æ³•é‡Œä¼šè·Ÿè¸ªè®°å½•è¿™äº›å‘ç”Ÿå¼•ç”¨æ›´æ–°çš„åœ°æ–¹ã€‚</li><li>é‡æ–°æ ‡è®°ï¼šé‡æ–°æ ‡è®°é˜¶æ®µå°±æ˜¯ä¸ºäº†ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´å› ä¸ºç”¨æˆ·ç¨‹åºç»§ç»­è¿è¡Œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼Œè¿™ä¸ªé˜¶æ®µçš„åœé¡¿æ—¶é—´ä¸€èˆ¬ä¼šæ¯”åˆå§‹æ ‡è®°é˜¶æ®µçš„æ—¶é—´ç¨é•¿ï¼Œè¿œè¿œæ¯”å¹¶å‘æ ‡è®°é˜¶æ®µæ—¶é—´çŸ­</li><li>å¹¶å‘æ¸…é™¤ï¼šå¼€å¯ç”¨æˆ·çº¿ç¨‹ï¼ŒåŒæ—¶GCçº¿ç¨‹å¼€å§‹å¯¹æœªæ ‡è®°çš„åŒºåŸŸåšæ¸…æ‰«ã€‚</li></ul><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/8036227F2EE742D6AB5D0510FB5DD71D.jpg" alt="image"></p><p>ä»å®ƒçš„åå­—å°±å¯ä»¥çœ‹å‡ºå®ƒæ˜¯ä¸€æ¬¾ä¼˜ç§€çš„åƒåœ¾æ”¶é›†å™¨ï¼Œä¸»è¦ä¼˜ç‚¹ï¼šå¹¶å‘æ”¶é›†ã€ä½åœé¡¿ã€‚</p><p>ä½†æ˜¯å®ƒæœ‰ä¸‹é¢ä¸‰ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹ï¼š</p><ol><li>å¯¹CPUèµ„æºæ•æ„Ÿï¼ˆä¼šå’ŒæœåŠ¡æŠ¢èµ„æºï¼‰ï¼›</li><li>æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾(åœ¨javaä¸šåŠ¡ç¨‹åºçº¿ç¨‹ä¸åƒåœ¾æ”¶é›†çº¿ç¨‹å¹¶å‘æ‰§è¡Œè¿‡ç¨‹ä¸­åˆäº§ç”Ÿçš„åƒåœ¾ï¼Œè¿™ç§æµ®åŠ¨åƒåœ¾åªèƒ½ç­‰åˆ°ä¸‹ä¸€æ¬¡gcå†æ¸…ç†äº†)ï¼›</li><li>å®ƒä½¿ç”¨çš„å›æ”¶ç®—æ³•-â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•ä¼šå¯¼è‡´æ”¶é›†ç»“æŸæ—¶ä¼šæœ‰å¤§é‡ç©ºé—´ç¢ç‰‡äº§ç”Ÿã€‚</li><li></li></ol><p>CMSçš„ç›¸å…³å‚æ•°</p><pre><code>-XX:+UseConcMarkSweepGC å¯ç”¨cms-XX:ConcGCThreads:å¹¶å‘çš„GCçº¿ç¨‹æ•°ï¼ˆå¹¶éSTWæ—¶é—´ï¼Œè€Œæ˜¯å’ŒæœåŠ¡ä¸€èµ·æ‰§è¡Œçš„çº¿ç¨‹æ•°ï¼‰-XX:+UseCMSCompactAtFullCollection:FullGCä¹‹ååšå‹ç¼©ï¼ˆå‡å°‘ç¢ç‰‡ï¼‰-XX:CMSFullGCsBeforeCompaction:å¤šå°‘æ¬¡FullGCä¹‹åå‹ç¼©ä¸€æ¬¡ï¼ˆå› å‹ç¼©éå¸¸çš„æ¶ˆè€—æ—¶é—´ï¼Œæ‰€ä»¥ä¸èƒ½æ¯æ¬¡FullGCéƒ½åšï¼‰-XX:CMSInitiatingOccupancyFraction:è§¦å‘FulGCæ¡ä»¶ï¼ˆé»˜è®¤æ˜¯92ï¼‰-XX:+UseCMSInitiatingOccupancyOnly:æ˜¯å¦åŠ¨æ€è°ƒèŠ‚-XX:+CMSScavengeBeforeRemark:FullGCä¹‹å‰å…ˆåšYGCï¼ˆä¸€èˆ¬è¿™ä¸ªå‚æ•°æ˜¯æ‰“å¼€çš„ï¼‰-XX:+CMSClassUnloadingEnabled:å¯ç”¨å›æ”¶PermåŒºï¼ˆjdk1.7åŠä»¥å‰ï¼‰</code></pre><h2 id="4-7-G1æ”¶é›†å™¨-XX-UseG1GC"><a href="#4-7-G1æ”¶é›†å™¨-XX-UseG1GC" class="headerlink" title="4.7 G1æ”¶é›†å™¨(-XX:+UseG1GC)"></a>4.7 G1æ”¶é›†å™¨(-XX:+UseG1GC)</h2><p>G1 (Garbage-First)æ˜¯ä¸€æ¬¾é¢å‘æœåŠ¡å™¨çš„åƒåœ¾æ”¶é›†å™¨,ä¸»è¦é’ˆå¯¹é…å¤‡å¤šé¢—å¤„ç†å™¨åŠå¤§å®¹é‡å†…å­˜çš„æœºå™¨. ä»¥æé«˜æ¦‚ç‡æ»¡è¶³GCåœé¡¿æ—¶é—´è¦æ±‚çš„åŒæ—¶,è¿˜å…·å¤‡é«˜ååé‡æ€§èƒ½ç‰¹å¾.</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/4421E80B1A4F4438AA637E46B2197F51.jpg" alt="image"></p><p>G1å°†Javaå †åˆ’åˆ†ä¸ºå¤šä¸ªå¤§å°ç›¸ç­‰çš„ç‹¬ç«‹åŒºåŸŸï¼ˆRegionï¼‰ï¼Œè™½ä¿ç•™æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„æ¦‚å¿µï¼Œä½†ä¸å†æ˜¯ç‰©ç†éš”é˜‚äº†ï¼Œå®ƒä»¬éƒ½æ˜¯ï¼ˆå¯ä»¥ä¸è¿ç»­ï¼‰Regionçš„é›†åˆã€‚</p><p>åˆ†é…å¤§å¯¹è±¡ï¼ˆç›´æ¥è¿›HumongousåŒºï¼Œä¸“é—¨å­˜æ”¾çŸ­æœŸå·¨å‹å¯¹è±¡ï¼Œä¸ç”¨ç›´æ¥è¿›è€å¹´ä»£ï¼Œé¿å…Full GCçš„å¤§é‡å¼€é”€ï¼‰ä¸ä¼šå› ä¸ºæ— æ³•æ‰¾åˆ°è¿ç»­ç©ºé—´è€Œæå‰è§¦å‘ä¸‹ä¸€æ¬¡GCã€‚</p><p>è¢«è§†ä¸ºJDK1.7ä¸­HotSpotè™šæ‹Ÿæœºçš„ä¸€ä¸ªé‡è¦è¿›åŒ–ç‰¹å¾ã€‚å®ƒå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š<br>å¹¶è¡Œä¸å¹¶å‘ï¼šG1èƒ½å……åˆ†åˆ©ç”¨CPUã€å¤šæ ¸ç¯å¢ƒä¸‹çš„ç¡¬ä»¶ä¼˜åŠ¿ï¼Œä½¿ç”¨å¤šä¸ªCPUï¼ˆCPUæˆ–è€…CPUæ ¸å¿ƒï¼‰æ¥ç¼©çŸ­Stop-The-Worldåœé¡¿æ—¶é—´ã€‚éƒ¨åˆ†å…¶ä»–æ”¶é›†å™¨åŸæœ¬éœ€è¦åœé¡¿Javaçº¿ç¨‹æ¥æ‰§è¡ŒGCåŠ¨ä½œï¼ŒG1æ”¶é›†å™¨ä»ç„¶å¯ä»¥é€šè¿‡å¹¶å‘çš„æ–¹å¼è®©javaç¨‹åºç»§ç»­æ‰§è¡Œã€‚</p><ul><li>åˆ†ä»£æ”¶é›†ï¼šè™½ç„¶G1å¯ä»¥ä¸éœ€è¦å…¶ä»–æ”¶é›†å™¨é…åˆå°±èƒ½ç‹¬ç«‹ç®¡ç†æ•´ä¸ªGCå †ï¼Œä½†æ˜¯è¿˜æ˜¯ä¿ç•™äº†åˆ†ä»£çš„æ¦‚å¿µã€‚</li><li>ç©ºé—´æ•´åˆï¼šä¸CMSçš„â€œæ ‡è®°â€“æ¸…ç†â€ç®—æ³•ä¸åŒï¼ŒG1ä»æ•´ä½“æ¥çœ‹æ˜¯åŸºäºâ€œæ ‡è®°æ•´ç†â€ç®—æ³•å®ç°çš„æ”¶é›†å™¨ï¼›ä»å±€éƒ¨ä¸Šæ¥çœ‹æ˜¯åŸºäºâ€œå¤åˆ¶â€ç®—æ³•å®ç°çš„ã€‚</li><li>å¯é¢„æµ‹çš„åœé¡¿ï¼šè¿™æ˜¯G1ç›¸å¯¹äºCMSçš„å¦ä¸€ä¸ªå¤§ä¼˜åŠ¿ï¼Œé™ä½åœé¡¿æ—¶é—´æ˜¯G1 å’Œ CMS å…±åŒçš„å…³æ³¨ç‚¹ï¼Œä½†G1 é™¤äº†è¿½æ±‚ä½åœé¡¿å¤–ï¼Œè¿˜èƒ½å»ºç«‹å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹ï¼Œèƒ½è®©ä½¿ç”¨è€…æ˜ç¡®æŒ‡å®šåœ¨ä¸€ä¸ªé•¿åº¦ä¸ºMæ¯«ç§’çš„æ—¶é—´ç‰‡æ®µå†…å®Œæˆåƒåœ¾æ”¶é›†ã€‚</li></ul><h3 id="G1æ”¶é›†å™¨çš„è¿ä½œå¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š"><a href="#G1æ”¶é›†å™¨çš„è¿ä½œå¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š" class="headerlink" title="G1æ”¶é›†å™¨çš„è¿ä½œå¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š"></a>G1æ”¶é›†å™¨çš„è¿ä½œå¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</h3><ol><li><p>åˆå§‹æ ‡è®°ï¼ˆinitial markï¼ŒSTWï¼‰ï¼šåœ¨æ­¤é˜¶æ®µï¼ŒG1 GCå¯¹æ ¹è¿›è¡Œæ ‡è®°ã€‚è¯¥é˜¶æ®µä¸å¸¸è§„çš„ (STW) å¹´è½»ä»£åƒåœ¾å›æ”¶å¯†åˆ‡ç›¸å…³ã€‚</p></li><li><p>å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markingï¼‰ï¼šG1 GCåœ¨æ•´ä¸ªå †ä¸­æŸ¥æ‰¾å¯è®¿é—®çš„ï¼ˆå­˜æ´»çš„ï¼‰å¯¹è±¡ã€‚</p></li><li><p>æœ€ç»ˆæ ‡è®°ï¼ˆRemarkï¼ŒSTWï¼‰ï¼šè¯¥é˜¶æ®µæ˜¯ STW å›æ”¶ï¼Œå¸®åŠ©å®Œæˆæ ‡è®°å‘¨æœŸã€‚</p></li><li><p>ç­›é€‰å›æ”¶ï¼ˆCleanupï¼ŒSTWï¼‰ï¼šç­›é€‰å›æ”¶é˜¶æ®µé¦–å…ˆå¯¹å„ä¸ªRegionçš„å›æ”¶ä»·å€¼å’Œæˆæœ¬è¿›è¡Œæ’åºï¼Œæ ¹æ®ç”¨æˆ·æ‰€æœŸæœ›çš„GCåœé¡¿æ—¶é—´æ¥åˆ¶å®šå›æ”¶è®¡åˆ’ï¼Œè¿™ä¸ªé˜¶æ®µå…¶å®ä¹Ÿå¯ä»¥åšåˆ°ä¸ç”¨æˆ·ç¨‹åºä¸€èµ·å¹¶å‘æ‰§è¡Œï¼Œä½†æ˜¯å› ä¸ºåªå›æ”¶ä¸€éƒ¨åˆ†Regionï¼Œæ—¶é—´æ˜¯ç”¨æˆ·å¯æ§åˆ¶çš„ï¼Œè€Œä¸”åœé¡¿ç”¨æˆ·çº¿ç¨‹å°†å¤§å¹…æé«˜æ”¶é›†æ•ˆç‡ã€‚ </p></li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/319BBC12D56C4BE7929004D4648023D3.jpg" alt="image"></p><p><strong>G1æ”¶é›†å™¨åœ¨åå°ç»´æŠ¤äº†ä¸€ä¸ªä¼˜å…ˆåˆ—è¡¨</strong>ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆé€‰æ‹©å›æ”¶ä»·å€¼æœ€å¤§çš„Region(è¿™ä¹Ÿå°±æ˜¯å®ƒçš„åå­—Garbage-Firstçš„ç”±æ¥)ã€‚è¿™ç§ä½¿ç”¨Regionåˆ’åˆ†å†…å­˜ç©ºé—´ä»¥åŠæœ‰ä¼˜å…ˆçº§çš„åŒºåŸŸå›æ”¶æ–¹å¼ï¼Œä¿è¯äº†GFæ”¶é›†å™¨åœ¨æœ‰é™æ—¶é—´å†…å¯ä»¥å°½å¯èƒ½é«˜çš„æ”¶é›†æ•ˆç‡ã€‚</p><h1 id="5-å¦‚ä½•é€‰æ‹©åƒåœ¾æ”¶é›†å™¨"><a href="#5-å¦‚ä½•é€‰æ‹©åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="5. å¦‚ä½•é€‰æ‹©åƒåœ¾æ”¶é›†å™¨"></a>5. å¦‚ä½•é€‰æ‹©åƒåœ¾æ”¶é›†å™¨</h1><ol><li>ä¼˜å…ˆè°ƒæ•´å †çš„å¤§å°è®©æœåŠ¡å™¨è‡ªå·±æ¥é€‰æ‹©</li><li>å¦‚æœå†…å­˜å°äº100Mï¼Œä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨</li><li>å¦‚æœæ˜¯å•æ ¸ï¼Œå¹¶ä¸”æ²¡æœ‰åœé¡¿æ—¶é—´çš„è¦æ±‚ï¼Œä¸²è¡Œæˆ–JVMè‡ªå·±é€‰æ‹©</li><li>å¦‚æœå…è®¸åœé¡¿æ—¶é—´è¶…è¿‡1ç§’ï¼Œé€‰æ‹©å¹¶è¡Œæˆ–è€…JVMè‡ªå·±é€‰</li><li>å¦‚æœå“åº”æ—¶é—´æœ€é‡è¦ï¼Œå¹¶ä¸”ä¸èƒ½è¶…è¿‡1ç§’ï¼Œä½¿ç”¨å¹¶å‘æ”¶é›†å™¨</li></ol><p>ä¸‹å›¾æœ‰è¿çº¿çš„å¯ä»¥æ­é…ä½¿ç”¨ï¼Œå®˜æ–¹æ¨èä½¿ç”¨G1ï¼Œå› ä¸ºæ€§èƒ½é«˜</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/18D6A441DD6E4B6E8EAB4CD6085053E4.jpg" alt="image"></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;JVM-å†…å­˜ç»“æ„&quot;&gt;&lt;a href=&quot;#JVM-å†…å­˜ç»“æ„&quot; class=&quot;headerlink&quot; title=&quot;JVM å†…å­˜ç»“æ„&quot;&gt;&lt;/a&gt;JVM å†…å­˜ç»“æ„&lt;/h1&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="è™šæ‹Ÿæœº" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E8%99%9A%E6%8B%9F%E6%9C%BA/"/>
    
    
      <category term="JVM" scheme="https://brokge.github.io/tags/JVM/"/>
    
      <category term="Java" scheme="https://brokge.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>JVM-Java è™šæ‹Ÿæœºå…¥é—¨</title>
    <link href="https://brokge.github.io/2020/07/01/JVM-Java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%85%A5%E9%97%A8/"/>
    <id>https://brokge.github.io/2020/07/01/JVM-Java-è™šæ‹Ÿæœºå…¥é—¨/</id>
    <published>2020-06-30T18:43:39.000Z</published>
    <updated>2020-08-21T04:56:47.017Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-JVM-æ•´ä½“æ¶æ„"><a href="#1-JVM-æ•´ä½“æ¶æ„" class="headerlink" title="1. JVM æ•´ä½“æ¶æ„"></a>1. JVM æ•´ä½“æ¶æ„</h1><a id="more"></a><h2 id="1-1-æ¦‚è¿°"><a href="#1-1-æ¦‚è¿°" class="headerlink" title="1.1 æ¦‚è¿°"></a>1.1 æ¦‚è¿°</h2><p>**JVM(è™šæ‹Ÿæœº)**ï¼šæŒ‡ä»¥è½¯ä»¶çš„æ–¹å¼æ¨¡æ‹Ÿå…·æœ‰å®Œæ•´ç¡¬ä»¶ç³»ç»ŸåŠŸèƒ½ã€è¿è¡Œåœ¨ä¸€ä¸ªå®Œå…¨éš”ç¦»ç¯å¢ƒä¸­çš„å®Œæ•´è®¡ç®—æœºç³»ç»Ÿ ï¼Œæ˜¯ç‰©ç†æœºçš„è½¯ä»¶å®ç°ã€‚å¸¸ç”¨çš„è™šæ‹Ÿæœºæœ‰VMWareï¼ŒVirtual Boxï¼ŒJava Virtual Machine</p><p><strong>Javaè™šæ‹Ÿæœºé˜µè¥</strong>ï¼šSun HotSpot VMã€BEA JRockit VMã€IBM J9 VMã€Azul VMã€Apache Harmonyã€Google Dalvik VMã€Microsoft JVM</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/B6C4C346061744E49EFACF2AFD644161.jpg" alt="image"></p><h2 id="1-2-JVM-æ„æˆ"><a href="#1-2-JVM-æ„æˆ" class="headerlink" title="1.2 JVM æ„æˆ"></a>1.2 JVM æ„æˆ</h2><p>ç”±ä¸‰ä¸ªä¸»è¦çš„å­ç³»ç»Ÿ</p><ol><li>ç±»åŠ è½½å™¨å­ç³»ç»Ÿ</li><li>è¿è¡Œæ—¶æ•°æ®åŒºï¼ˆå†…å­˜ç»“æ„ï¼‰</li><li>æ‰§è¡Œå¼•æ“</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/8276252A099C4767B0824412B5AC790E.jpg" alt="image"></p><h2 id="1-3-Java-ç¼–è¯‘å™¨"><a href="#1-3-Java-ç¼–è¯‘å™¨" class="headerlink" title="1.3 Java ç¼–è¯‘å™¨"></a>1.3 Java ç¼–è¯‘å™¨</h2><p>Java  Compiler è¿è¡Œæ—¶ç¼–è¯‘æºç (.java)æˆå­—èŠ‚ç (.class)ï¼Œç”±jreï¼ˆJava Run Environmentï¼‰è¿è¡Œã€‚jreç”±javaè™šæ‹Ÿæœºï¼ˆjvmï¼‰å®ç°ã€‚Jvm åˆ†æå­—èŠ‚ç ï¼Œåè§£é‡Šå¹¶æ‰§è¡Œã€‚</p><p>ç¼–è¯‘æµç¨‹å¦‚ä¸‹ï¼š<br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/ACA7583FB3E9488D96C6D3E9B3D0C96B.jpg" alt="image"></p><h1 id="2-JVMç±»åŠ è½½å™¨"><a href="#2-JVMç±»åŠ è½½å™¨" class="headerlink" title="2. JVMç±»åŠ è½½å™¨"></a>2. JVMç±»åŠ è½½å™¨</h1><h2 id="2-1-ç±»åŠ è½½è¿‡ç¨‹"><a href="#2-1-ç±»åŠ è½½è¿‡ç¨‹" class="headerlink" title="2.1 ç±»åŠ è½½è¿‡ç¨‹"></a>2.1 ç±»åŠ è½½è¿‡ç¨‹</h2><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/B3DF1EEF61FD424C8D38E4737D702F62.jpg" alt="image"><br>ç±»åŠ è½½è¿‡ç¨‹ï¼šç±»åŠ è½½å™¨å°†classæ–‡ä»¶åŠ è½½åˆ°è™šæ‹Ÿæœºçš„å†…å­˜çš„è¿‡ç¨‹ã€‚</p><p>æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>åŠ è½½ï¼šåœ¨ç¡¬ç›˜ä¸ŠæŸ¥æ‰¾å¹¶é€šè¿‡IOè¯»å…¥å­—èŠ‚ç æ–‡ä»¶</li><li>è¿æ¥ï¼šæ‰§è¡Œæ ¡éªŒã€å‡†å¤‡ã€è§£æï¼ˆå¯é€‰ï¼‰æ­¥éª¤</li><li>æ ¡éªŒï¼šæ ¡éªŒå­—èŠ‚ç æ–‡ä»¶çš„æ­£ç¡®æ€§</li><li>å‡†å¤‡ï¼šç»™ç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶èµ‹äºˆé»˜è®¤å€¼</li><li>è§£æï¼šç±»è£…è½½å™¨è£…å…¥ç±»æ‰€å¼•ç”¨çš„å…¶ä»–æ‰€æœ‰ç±»</li><li>åˆå§‹åŒ–ï¼šå¯¹ç±»çš„é™æ€å˜é‡åˆå§‹åŒ–ä¸ºæŒ‡å®šçš„å€¼ï¼Œæ‰§è¡Œé™æ€ä»£ç å—</li></ol><h2 id="2-2-åŠ è½½å™¨ç§ç±»"><a href="#2-2-åŠ è½½å™¨ç§ç±»" class="headerlink" title="2.2 åŠ è½½å™¨ç§ç±»"></a>2.2 åŠ è½½å™¨ç§ç±»</h2><ul><li>å¯åŠ¨ç±»åŠ è½½å™¨ï¼šè´Ÿè´£åŠ è½½JREçš„æ ¸å¿ƒç±»åº“ï¼Œå¦‚jreç›®æ ‡ä¸‹çš„rt.jar,charsets.jarç­‰</li><li>æ‰©å±•ç±»åŠ è½½å™¨ï¼šè´Ÿè´£åŠ è½½JREæ‰©å±•ç›®å½•extä¸­JARç±»åŒ…</li><li>ç³»ç»Ÿç±»åŠ è½½å™¨ï¼šè´Ÿè´£åŠ è½½ClassPathè·¯å¾„ä¸‹çš„ç±»åŒ…</li><li>ç”¨æˆ·è‡ªå®šä¹‰åŠ è½½å™¨ï¼šè´Ÿè´£åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰è·¯å¾„ä¸‹çš„ç±»åŒ…</li></ul><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/99121BE919D44D7FA55CF8B574A4221C.jpg" alt="image"><br>ç¤ºä¾‹ä»£ç å¯ä»¥è¾“å‡ºåŠ è½½å™¨åç§°ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/92E7D1EEA0B5442288B29BB6D0AD315E.jpg" alt="image"></p><h2 id="2-3-ç±»åŠ è½½æœºåˆ¶"><a href="#2-3-ç±»åŠ è½½æœºåˆ¶" class="headerlink" title="2.3 ç±»åŠ è½½æœºåˆ¶"></a>2.3 ç±»åŠ è½½æœºåˆ¶</h2><p>ç±»åŠ è½½è¿‡ç¨‹ç§ï¼Œæœ‰ä¸¤ç§æœºåˆ¶æ¥ä¿è¯åŠ è½½çš„å®‰å…¨ä¸é¿å…é‡å¤åŠ è½½ï¼š</p><ol><li><strong>å…¨ç›˜è´Ÿè´£å§”æ‰˜æœºåˆ¶</strong>ï¼šå½“ä¸€ä¸ªClassLoaderåŠ è½½ä¸€ä¸ªç±»æ—¶ï¼Œé™¤éæ˜¾ç¤ºçš„ä½¿ç”¨å¦ä¸€ä¸ªClassLoaderï¼Œè¯¥ç±»æ‰€ä¾èµ–å’Œå¼•ç”¨çš„ç±»ä¹Ÿç”±è¿™ä¸ªClassLoaderè½½å…¥ã€‚</li><li><strong>åŒäº²å§”æ´¾æœºåˆ¶</strong>ï¼šæŒ‡å…ˆå§”æ‰˜çˆ¶ç±»åŠ è½½å™¨å¯»æ‰¾ç›®æ ‡ç±»ï¼Œè€Œä¸æ˜¯è‡ªå·±å…ˆæ‰¾ï¼Œåœ¨çˆ¶ç±»æ‰¾ä¸åˆ°çš„æƒ…å†µä¸‹ï¼Œæ‰ä¸å¾—å·²åœ¨è‡ªå·±çš„è·¯å¾„ä¸­æŸ¥æ‰¾å¹¶è½½å…¥ç›®æ ‡ç±»ã€‚</li></ol><p>ä¸Šé¢ä¸¤æ¡æœºåˆ¶å¯ä»¥ç®€å•æ€»ç»“å°±æ˜¯ï¼šä¸€äººå¾—é“é¸¡çŠ¬å‡å¤© å’Œ è´¥å®¶å­æ¨¡å‹ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/F39CDE3D07DE4FCB9AB2A2EF3DAE5600.jpg" alt="image"></p><p><strong>åŒäº²å§”æ´¾æ¨¡å¼ä¼˜åŠ¿ï¼š</strong></p><p>æ²™ç®±å®‰å…¨æœºåˆ¶ï¼šè‡ªå·±å†™çš„String.classç±»ä¸ä¼šè¢«åŠ è½½ï¼Œè¿™æ ·ä¾¿å¯ä»¥é˜²æ­¢æ ¸å¿ƒAPIåº“è¢«éšæ„ç¯¡æ”¹<br>é¿å…ç±»çš„é‡å¤åŠ è½½ï¼šå½“çˆ¶äº²å·²ç»åŠ è½½äº†è¯¥ç±»æ—¶ï¼Œå°±æ²¡æœ‰å¿…è¦å­ClassLoaderå† åŠ è½½ä¸€æ¬¡ã€‚</p><h2 id="2-4-JVMåŠ è½½jaråŒ…æ˜¯å¦ä¼šå°†åŒ…é‡Œçš„æ‰€æœ‰ç±»å…¨éƒ¨åŠ è½½è¿›å†…å­˜ï¼Ÿ"><a href="#2-4-JVMåŠ è½½jaråŒ…æ˜¯å¦ä¼šå°†åŒ…é‡Œçš„æ‰€æœ‰ç±»å…¨éƒ¨åŠ è½½è¿›å†…å­˜ï¼Ÿ" class="headerlink" title="2.4 JVMåŠ è½½jaråŒ…æ˜¯å¦ä¼šå°†åŒ…é‡Œçš„æ‰€æœ‰ç±»å…¨éƒ¨åŠ è½½è¿›å†…å­˜ï¼Ÿ"></a>2.4 JVMåŠ è½½jaråŒ…æ˜¯å¦ä¼šå°†åŒ…é‡Œçš„æ‰€æœ‰ç±»å…¨éƒ¨åŠ è½½è¿›å†…å­˜ï¼Ÿ</h2><p>å…ˆè¯´ç­”æ¡ˆï¼š JVM å¯¹ class æ–‡ä»¶æ˜¯æŒ‰éœ€åŠ è½½(è¿è¡ŒæœŸé—´åŠ¨æ€åŠ è½½)ï¼Œéä¸€æ¬¡æ€§åŠ è½½ã€‚</p><p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥æµ‹è¯•ï¼Œæ³¨æ„ï¼š(å¯åŠ¨éœ€è¦åŠ ä¸Šå‚æ•°ï¼š-verbose:class)</p><pre><code>public class TestDynamicLoad {    static {        System.out.println(&quot;*************static code************&quot;);    }    public static void main(String[] args){        new A();        System.out.println(&quot;*************load test************&quot;);        new B();    }}class A{    public A(){        System.out.println(&quot;*************initial A************&quot;);    }}class B{    public B(){        System.out.println(&quot;*************initial B************&quot;);    }}[Loaded java.lang.Void from /Library/Java/JavaVirtualMachines/jdk1.8.0_92.jdk/Contents/Home/jre/lib/rt.jar]*************static code************[Loaded com.study.jvm.A from file:/U/jvmtest/out/production/jvmtest/]*************initial A*************************load test************[Loaded com.study.jvm.B from file:/Us/jvmtest/out/production/jvmtest/]*************initial B************</code></pre><p>ä»ä¸Šé¢è¾“å…¥æ—¥å¿—å¯ä»¥å‘ç°ï¼ŒA å’Œ B éƒ½æ˜¯åœ¨åŠ è½½ä¹‹åå¼€å§‹è¾“å‡ºæ„é€ å‡½æ•°å†…çš„æ—¥å¿—ã€‚</p><h2 id="2-5-jvm-å¦‚ä½•çŸ¥é“æˆ‘ä»¬çš„ç±»åœ¨ä½•æ–¹ï¼Ÿ"><a href="#2-5-jvm-å¦‚ä½•çŸ¥é“æˆ‘ä»¬çš„ç±»åœ¨ä½•æ–¹ï¼Ÿ" class="headerlink" title="2.5 jvm å¦‚ä½•çŸ¥é“æˆ‘ä»¬çš„ç±»åœ¨ä½•æ–¹ï¼Ÿ"></a>2.5 jvm å¦‚ä½•çŸ¥é“æˆ‘ä»¬çš„ç±»åœ¨ä½•æ–¹ï¼Ÿ</h2><p>æˆ‘ä»¬çš„ class ä¿¡æ¯å­˜æ”¾åœ¨ä¸åŒçš„åœ°æ–¹ï¼Œå¦‚ä¸åŒæ–‡ä»¶å¤¹é‡Œé¢çš„jarï¼Œé¡¹ç›®binç›®å½•ï¼Œtargetç›®å½•ç­‰ï¼Œjvm æ€ä¹ˆçŸ¥é“éƒ½éœ€è¦åŠ è½½å“ªäº›è·¯å¾„å‘¢ï¼Ÿ</p><p>é€šè¿‡æŸ¥çœ‹ sun.misc.Launcher.AppClassLoader æºç å¯ä»¥å‘ç°ï¼Œæ˜¯é€šè¿‡è¯»å–<code> java.class.path</code> é…ç½®ï¼Œé€šè¿‡è¿™ä¸ªæŒ‡å®šå»ç‰¹å®šé…ç½®ç›®å½•å»åŠ è½½ã€‚</p><p>é€šè¿‡ <code>jps</code> å’Œ <code>jcmd</code> ä¸¤ä¸ªå‘½ä»¤æ¥éªŒè¯</p><pre class="line-numbers language-bash"><code class="language-bash">jpsjcmd pid <span class="token function">help</span>jcmd pid VM.system_properties<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/6BACF4F6B07B4C518CE7820CDBAD22A0.jpg" alt="image"></p><h1 id="3-JVM-å†…å­˜ç»“æ„"><a href="#3-JVM-å†…å­˜ç»“æ„" class="headerlink" title="3. JVM å†…å­˜ç»“æ„"></a>3. JVM å†…å­˜ç»“æ„</h1><h2 id="3-1-å†…å­˜ç»“æ„ç»“æ„å›¾"><a href="#3-1-å†…å­˜ç»“æ„ç»“æ„å›¾" class="headerlink" title="3.1 å†…å­˜ç»“æ„ç»“æ„å›¾"></a>3.1 å†…å­˜ç»“æ„ç»“æ„å›¾</h2><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/50969016BB3446248562F165B43F902F.jpg" alt="image"></p><ol><li><p>æœ¬åœ°æ–¹æ³•æ ˆ(çº¿ç¨‹ç§æœ‰)ï¼šç™»è®°nativeæ–¹æ³•ï¼Œåœ¨Execution Engineæ‰§è¡Œæ—¶åŠ è½½æœ¬åœ°æ–¹æ³•åº“</p></li><li><p>ç¨‹åºè®¡æ•°å™¨ï¼ˆçº¿ç¨‹ç§æœ‰ï¼‰ï¼šå°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æ–¹æ³•åŒºä¸­çš„æ–¹æ³•å­—èŠ‚ç ï¼ˆç”¨æ¥å­˜å‚¨æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€,ä¹Ÿå³å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ä»£ç ï¼‰ï¼Œç”±æ‰§è¡Œå¼•æ“è¯»å–ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å°çš„å†…å­˜ç©ºé—´ï¼Œå‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®°ã€‚</p></li><li><p>Javaæ ˆï¼ˆçº¿ç¨‹ç§æœ‰ï¼‰ï¼šJavaçº¿ç¨‹æ‰§è¡Œæ–¹æ³•çš„å†…å­˜æ¨¡å‹ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªæ ˆï¼Œæ¯ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œçš„åŒæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼ˆç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ï¼Œæ“ä½œæ•°æ ˆï¼ŒåŠ¨æ€é“¾æ¥ï¼Œæ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ï¼‰==ä¸å­˜åœ¨åƒåœ¾å›æ”¶é—®é¢˜==ï¼Œåªè¦çº¿ç¨‹ä¸€ç»“æŸè¯¥æ ˆå°±é‡Šæ”¾ï¼Œç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ä¸€è‡´ã€‚</p></li><li><p>æ–¹æ³•åŒº(çº¿ç¨‹å…±äº«)ï¼šç±»çš„æ‰€æœ‰å­—æ®µå’Œæ–¹æ³•å­—èŠ‚ç ï¼Œä»¥åŠä¸€äº›ç‰¹æ®Šæ–¹æ³•å¦‚æ„é€ å‡½æ•°ï¼Œæ¥å£ä»£ç ä¹Ÿåœ¨æ­¤å®šä¹‰ã€‚ç®€å•è¯´ï¼Œæ‰€æœ‰å®šä¹‰çš„æ–¹æ³•çš„ä¿¡æ¯éƒ½ä¿å­˜åœ¨è¯¥åŒºåŸŸï¼Œé™æ€å˜é‡+å¸¸é‡+ç±»ä¿¡æ¯(æ„é€ æ–¹æ³•/æ¥å£å®šä¹‰)+è¿è¡Œæ—¶å¸¸é‡æ± éƒ½å­˜åœ¨æ–¹æ³•åŒºä¸­ï¼Œè™½ç„¶Javaè™šæ‹Ÿæœºè§„èŒƒæŠŠæ–¹æ³•åŒºæè¿°ä¸ºå †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒå´æœ‰ä¸€ä¸ªåˆ«åå«åš Non-Heapï¼ˆéå †ï¼‰ï¼Œç›®çš„åº”è¯¥æ˜¯ä¸ Java å †åŒºåˆ†å¼€æ¥ã€‚</p></li><li><p>å †(çº¿ç¨‹å…±äº«)ï¼šè™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºï¼Œç”¨äºå­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯¹è±¡ï¼ˆåŒ…å«å¸¸é‡æ± ï¼‰éƒ½åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œå½“å¯¹è±¡æ— æ³•å†è¯¥ç©ºé—´ç”³è¯·åˆ°å†…å­˜æ—¶å°†æŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚åŒæ—¶ä¹Ÿæ˜¯åƒåœ¾æ”¶é›†å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸã€‚å¯é€šè¿‡ -Xmx â€“Xms å‚æ•°æ¥åˆ†åˆ«æŒ‡å®šæœ€å¤§å †å’Œæœ€å°å †</p></li></ol><p>JVM å¯¹è¯¥åŒºåŸŸè§„èŒƒäº†ä¸¤ç§å¼‚å¸¸ï¼š</p><ol><li>é’ˆå¯¹ä¸æ ˆï¼šçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºæ ˆæ‰€å…è®¸çš„æ·±åº¦ï¼Œå°†æŠ›å‡º StackOverFlowError å¼‚å¸¸</li><li>é’ˆå¯¹å †ï¼šè‹¥è™šæ‹Ÿæœºæ ˆå¯åŠ¨æ€æ‰©å±•ï¼Œå½“æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿå†…å­˜ç©ºé—´æ—¶å°†æŠ›å‡ºOutOfMemoryErrorï¼Œé€šè¿‡jvmå‚æ•°â€“XssæŒ‡å®šæ ˆç©ºé—´ï¼Œç©ºé—´å¤§å°å†³å®šå‡½æ•°è°ƒç”¨çš„æ·±åº¦<h2 id="3-2-Java-æ ˆ"><a href="#3-2-Java-æ ˆ" class="headerlink" title="3.2 Java æ ˆ"></a>3.2 Java æ ˆ</h2></li></ol><p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç§æœ‰çš„æ ˆï¼Œæ ˆå†…éƒ¨æ˜¯ç”±nä¸ªæ ˆå¸§ï¼ˆå‡½æ•°/æ–¹æ³•ï¼‰ç»„æˆã€‚<br>æ ˆå¸§ï¼ˆå‡½æ•°/æ–¹æ³•ï¼‰å†…éƒ¨åˆåŒ…å«ï¼šå±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€è¿”å›åœ°å€ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/5B247C51135C4A00B2B9A3F77D109081.jpg" alt="image"></p><h2 id="3-3-æ ˆ-å †-æ–¹æ³•åŒºçš„äº¤äº’å…³ç³»"><a href="#3-3-æ ˆ-å †-æ–¹æ³•åŒºçš„äº¤äº’å…³ç³»" class="headerlink" title="3.3 æ ˆ+å †+æ–¹æ³•åŒºçš„äº¤äº’å…³ç³»"></a>3.3 æ ˆ+å †+æ–¹æ³•åŒºçš„äº¤äº’å…³ç³»</h2><p>HotSpot æ˜¯ä½¿ç”¨==æŒ‡é’ˆ==çš„æ–¹å¼æ¥è®¿é—®å¯¹è±¡<br>Javaå †ä¸­ä¼šå­˜æ”¾è®¿é—®==ç±»å…ƒæ•°æ®==çš„åœ°å€<br>referenceå­˜å‚¨çš„å°±ç›´æ¥æ˜¯å¯¹è±¡çš„åœ°å€</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/D2B31A961A53482A9FB921AA929285EA.jpg" alt="image"></p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/B803B954C8254EF18A95473BF80D015A.jpg" alt="image"></p><h2 id="3-4-å †"><a href="#3-4-å †" class="headerlink" title="3.4 å †"></a>3.4 å †</h2><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/84A35B9748EC46758F35BA070CBA4564.jpg" alt="image"></p><h3 id="3-4-1-Young-Generation-æ–°ç”ŸåŒº"><a href="#3-4-1-Young-Generation-æ–°ç”ŸåŒº" class="headerlink" title="3.4.1 Young Generation æ–°ç”ŸåŒº"></a>3.4.1 Young Generation æ–°ç”ŸåŒº</h3><p>ç±»è¯ç”Ÿã€æˆé•¿ã€æ¶ˆäº¡çš„åŒºåŸŸï¼Œä¸€ä¸ªç±»åœ¨è¿™é‡Œäº§ç”Ÿï¼Œåº”ç”¨ï¼Œæœ€åè¢«åƒåœ¾å›æ”¶å™¨æ”¶é›†ï¼Œç»“æŸç”Ÿå‘½ã€‚<br>æ–°ç”ŸåŒºåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š ä¼Šç”¸åŒºï¼ˆEden spaceï¼‰å’Œå¹¸å­˜è€…åŒºï¼ˆSurvivor paceï¼‰ ï¼Œæ‰€æœ‰çš„ç±»éƒ½æ˜¯åœ¨ä¼Šç”¸åŒºè¢«newå‡ºæ¥çš„ã€‚</p><p>å¹¸å­˜åŒºæœ‰ä¸¤ä¸ªï¼š 0(From)åŒºï¼ˆSurvivor 0 spaceï¼‰å’Œ1(To)åŒºï¼ˆSurvivor 1 spaceï¼‰ã€‚</p><p>å½“ä¼Šç”¸å›­çš„ç©ºé—´ç”¨å®Œæ—¶ï¼Œç¨‹åºåˆéœ€è¦åˆ›å»ºå¯¹è±¡ï¼ŒJVMçš„åƒåœ¾å›æ”¶å™¨å°†å¯¹ä¼Šç”¸å›­åŒºè¿›è¡Œåƒåœ¾å›æ”¶(Minor GC)ï¼Œå°†ä¼Šç”¸å›­åŒºä¸­çš„ä¸å†è¢«å…¶ä»–å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡è¿›è¡Œé”€æ¯ã€‚ç„¶åå°†ä¼Šç”¸å›­ä¸­çš„å‰©ä½™å¯¹è±¡ç§»åŠ¨åˆ°å¹¸å­˜ 0åŒºã€‚<br>è‹¥å¹¸å­˜ 0åŒºä¹Ÿæ»¡äº†ï¼Œå†å¯¹è¯¥åŒºè¿›è¡Œåƒåœ¾å›æ”¶ï¼Œç„¶åç§»åŠ¨åˆ°1åŒºã€‚é‚£å¦‚æœ1åŒºä¹Ÿæ»¡äº†å‘¢ï¼Ÿåˆ™ ç§»åŠ¨åˆ° è€å¹´ä»£ã€‚</p><h3 id="3-4-2-old-Generation-è€å¹´åŒº"><a href="#3-4-2-old-Generation-è€å¹´åŒº" class="headerlink" title="3.4.2 old Generation è€å¹´åŒº"></a>3.4.2 old Generation è€å¹´åŒº</h3><p>æ–°ç”ŸåŒºç»è¿‡å¤šæ¬¡GCä»ç„¶å­˜æ´»çš„å¯¹è±¡ç§»åŠ¨åˆ°è€å¹´åŒºã€‚<br>è‹¥è€å¹´åŒºä¹Ÿæ»¡äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°†äº§ç”ŸMajorGCï¼ˆFullGCï¼‰ï¼Œè¿›è¡Œè€å¹´åŒºçš„å†…å­˜æ¸…ç†ã€‚è‹¥è€å¹´åŒºæ‰§è¡Œäº†Full GC ä¹‹åå‘ç°ä¾ç„¶æ— æ³•è¿›è¡Œå¯¹è±¡çš„ä¿å­˜ï¼Œå°±ä¼šäº§ç”Ÿ OOM å¼‚å¸¸â€œOutOfMemoryErrorâ€</p><h3 id="3-4-3-MetaDataSpace-å…ƒæ•°æ®åŒº"><a href="#3-4-3-MetaDataSpace-å…ƒæ•°æ®åŒº" class="headerlink" title="3.4.3 MetaDataSpace å…ƒæ•°æ®åŒº"></a>3.4.3 MetaDataSpace å…ƒæ•°æ®åŒº</h3><p>å…ƒæ•°æ®åŒºå–ä»£äº†æ°¸ä¹…ä»£(jdk1.8ä»¥å‰)ï¼Œæœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹JVMè§„èŒƒä¸­æ–¹æ³•åŒºçš„å®ç°ï¼ŒåŒºåˆ«åœ¨äºå…ƒæ•°æ®åŒºå¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°ç‰©ç†å†…å­˜ï¼Œæ°¸ä¹…ä»£åœ¨è™šæ‹Ÿæœºä¸­ï¼Œæ°¸ä¹…ä»£é€»è¾‘ç»“æ„ä¸Šå±äºå †ï¼Œä½†æ˜¯ç‰©ç†ä¸Šä¸å±äºå †ï¼Œå †å¤§å°=æ–°ç”Ÿä»£+è€å¹´ä»£ã€‚å…ƒæ•°æ®åŒºä¹Ÿæœ‰å¯èƒ½å‘ç”ŸOutOfMemoryå¼‚å¸¸ã€‚</p><table><thead><tr><th>JAVA ç‰ˆæœ¬</th><th>æ˜¯å¦æœ‰æ°¸ä¹…ä»£</th></tr></thead><tbody><tr><td>Jdk1.6åŠä¹‹å‰</td><td>æœ‰æ°¸ä¹…ä»£, å¸¸é‡æ± åœ¨æ–¹æ³•åŒº</td></tr><tr><td>Jdk1.7</td><td>æœ‰æ°¸ä¹…ä»£ï¼Œä½†å·²ç»é€æ­¥â€œå»æ°¸ä¹…ä»£â€ï¼Œå¸¸é‡æ± åœ¨å †</td></tr><tr><td>Jdk1.8åŠä¹‹å</td><td>æ— æ°¸ä¹…ä»£ï¼Œå¸¸é‡æ± åœ¨å…ƒç©ºé—´.</td></tr></tbody></table><p>å…ƒæ•°æ®åŒºçš„åŠ¨æ€æ‰©å±•ï¼Œé»˜è®¤ â€“XX:MetaspaceSizeå€¼ä¸º21MBçš„é«˜æ°´ä½çº¿ã€‚ä¸€æ—¦è§¦åŠåˆ™Full GCå°†è¢«è§¦å‘å¹¶å¸è½½æ²¡æœ‰ç”¨çš„ç±»ï¼ˆç±»å¯¹åº”çš„ç±»åŠ è½½å™¨ä¸å†å­˜æ´»ï¼‰ï¼Œç„¶åé«˜æ°´ä½çº¿å°†ä¼šé‡ç½®ã€‚æ–°çš„é«˜æ°´ä½çº¿çš„å€¼å–å†³äºGCåé‡Šæ”¾çš„å…ƒç©ºé—´ã€‚å¦‚æœé‡Šæ”¾çš„ç©ºé—´å°‘ï¼Œè¿™ä¸ªé«˜æ°´ä½çº¿åˆ™ä¸Šå‡ã€‚å¦‚æœé‡Šæ”¾ç©ºé—´è¿‡å¤šï¼Œåˆ™é«˜æ°´ä½çº¿ä¸‹é™ã€‚</p><p><strong>ä¸ºä»€ä¹ˆjdk1.8ç”¨å…ƒæ•°æ®åŒºå–ä»£äº†æ°¸ä¹…ä»£ï¼Ÿ</strong></p><p>å®˜æ–¹è§£é‡Šï¼šç§»é™¤æ°¸ä¹…ä»£æ˜¯ä¸ºèåˆHotSpot JVMä¸ JRockit VMè€Œåšå‡ºçš„åŠªåŠ›ï¼Œå› ä¸ºJRockitæ²¡æœ‰æ°¸ä¹…ä»£ï¼Œä¸éœ€è¦é…ç½®æ°¸ä¹…ä»£ã€‚</p><h1 id="JVMæ‰§è¡Œå¼•æ“"><a href="#JVMæ‰§è¡Œå¼•æ“" class="headerlink" title="JVMæ‰§è¡Œå¼•æ“"></a>JVMæ‰§è¡Œå¼•æ“</h1><p>æ‰§è¡Œå¼•æ“ï¼šè¯»å–è¿è¡Œæ—¶æ•°æ®åŒºçš„Javaå­—èŠ‚ç å¹¶é€ä¸ªæ‰§è¡Œ</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/BE6F2D2F39AF4F80A6D80BA8807A8A67.jpg" alt="image"></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;1-JVM-æ•´ä½“æ¶æ„&quot;&gt;&lt;a href=&quot;#1-JVM-æ•´ä½“æ¶æ„&quot; class=&quot;headerlink&quot; title=&quot;1. JVM æ•´ä½“æ¶æ„&quot;&gt;&lt;/a&gt;1. JVM æ•´ä½“æ¶æ„&lt;/h1&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="è™šæ‹Ÿæœº" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E8%99%9A%E6%8B%9F%E6%9C%BA/"/>
    
    
      <category term="JVM" scheme="https://brokge.github.io/tags/JVM/"/>
    
      <category term="Java" scheme="https://brokge.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Nginx åŠ¨æ€é¡µé¢ç¼“å­˜æ–¹å¼å®ç°</title>
    <link href="https://brokge.github.io/2020/06/25/Nginx-%E5%8A%A8%E6%80%81%E9%A1%B5%E9%9D%A2%E7%BC%93%E5%AD%98%E6%96%B9%E5%BC%8F%E5%AE%9E%E7%8E%B0/"/>
    <id>https://brokge.github.io/2020/06/25/Nginx-åŠ¨æ€é¡µé¢ç¼“å­˜æ–¹å¼å®ç°/</id>
    <published>2020-06-24T18:40:22.000Z</published>
    <updated>2020-08-21T05:05:00.592Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å…·ä½“å®ç°æ­¥éª¤ï¼š"><a href="#å…·ä½“å®ç°æ­¥éª¤ï¼š" class="headerlink" title="å…·ä½“å®ç°æ­¥éª¤ï¼š"></a>å…·ä½“å®ç°æ­¥éª¤ï¼š</h2><p>ä¾æ‰˜äº OpenResty æ¡†æ¶å®ç°</p><a id="more"></a><h3 id="ä¸€ã€Openrestyå®‰è£…"><a href="#ä¸€ã€Openrestyå®‰è£…" class="headerlink" title="ä¸€ã€Openrestyå®‰è£…"></a>ä¸€ã€Openrestyå®‰è£…</h3><pre class="line-numbers language-sh"><code class="language-sh">mkdir â€p /usr/servers cd  /usr/servers/yum installâ€y readlineâ€devel pcreâ€devel opensslâ€devel gccwget http://openresty.org/download/ngx_openrestyâ€1.7.7.2.tar.gz tar â€xzvf ngx_openrestyâ€1.7.7.2.tar.gzcd  /usr/servers/ngx_openrestyâ€1.7.7.2/cd  bundle/LuaJITâ€2.1â€20150120/ make clean && make&& make install ln â€sf luajitâ€2.1.0â€alpha /usr/local/bin/luajitcd  /usr/servers/ngx_openrestyâ€1.7.7.2/bundle wget  https://github.com/FRiCKLE/ngx_cache_purge/archive/2.3.tar.gz tarâ€xvf 2.3.tar.gzcd  bundle wget  https://github.com/yaoweibin/nginx_upstream_check_module/archive/v0.3.0.tar.gz tar  â€xvf  v0.3.0.tar.gzcd  /usr/servers/ngx_openrestyâ€1.7.7.2 ./configureâ€â€prefix=/usr/serversâ€â€withâ€http_realip_moduleâ€â€withâ€pcreâ€â€withâ€luajitâ€â€addâ€module=./bundle/ngx_cache_purgeâ€2.3/ â€â€addâ€module=./bundle/nginx_upstream_check_moduleâ€0.3.0/ â€j2 24 make&&makeinstallcd /usr/servers/ll/usr/servers/luajit/usr/servers/lualib/usr/servers/nginx/usr/servers/nginx/sbin/nginx â€V##å¯åŠ¨nginx: /usr/servers/nginx/sbin/nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="äºŒã€-Nginx-lua-å¼€å‘-hello-world"><a href="#äºŒã€-Nginx-lua-å¼€å‘-hello-world" class="headerlink" title="äºŒã€ Nginx + lua å¼€å‘ hello world"></a>äºŒã€ Nginx + lua å¼€å‘ hello world</h3><pre class="line-numbers language-sh"><code class="language-sh">cd /usr/servers/nginx/confvim  lua.conf server{    listen 80;    server_name _;    location /lua { default_type 'text/html';    content_by_lua 'ngx.say("helloworld")';    } }vim  nginx.conf##åœ¨httpéƒ¨åˆ†å¼•å…¥luaåŒ…lua_package_path"/usr/servers/lualib/?.lua;;";lua_package_cpath"/usr/servers/lualib/?.so;;"; include lua.conf;../sbin/nginxâ€sreload #è®¿é—®:http://192.168.0.60/lua<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¸‰ã€Nginx-luaå¼€å‘çš„æµé‡åˆ†å‘é€»è¾‘ï¼Œå¯ä»¥æ ¹æ®å•†å“id-è¿›è¡Œ-hash-ç„¶åå–æ¨¡åˆ†å‘ã€‚"><a href="#ä¸‰ã€Nginx-luaå¼€å‘çš„æµé‡åˆ†å‘é€»è¾‘ï¼Œå¯ä»¥æ ¹æ®å•†å“id-è¿›è¡Œ-hash-ç„¶åå–æ¨¡åˆ†å‘ã€‚" class="headerlink" title="ä¸‰ã€Nginx+luaå¼€å‘çš„æµé‡åˆ†å‘é€»è¾‘ï¼Œå¯ä»¥æ ¹æ®å•†å“id è¿›è¡Œ hash ç„¶åå–æ¨¡åˆ†å‘ã€‚"></a>ä¸‰ã€Nginx+luaå¼€å‘çš„æµé‡åˆ†å‘é€»è¾‘ï¼Œå¯ä»¥æ ¹æ®å•†å“id è¿›è¡Œ hash ç„¶åå–æ¨¡åˆ†å‘ã€‚</h3><pre class="line-numbers language-sh"><code class="language-sh">#æµé‡åˆ†å‘çš„nginxï¼Œä¼šå‘é€httpè¯·æ±‚åˆ°åç«¯çš„åº”ç”¨å±‚nginxä¸Šå»ï¼Œæ‰€ä»¥è¦å…ˆå¼•å…¥lua http libåŒ… cd /usr/servers/lualib/resty wget https://raw.githubusercontent.com/pintsized/luaâ€restyâ€http/master/lib/resty/http_headers.lua wget https://raw.githubusercontent.com/pintsized/luaâ€restyâ€http/master/lib/resty/http.luacd  /usr/servers/nginx/conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>lua-distribution.lua</p><pre class="line-numbers language-SH"><code class="language-SH">vim luaâ€distribution.lua# lua-distribution.lualocal uri_args=ngx.req.get_uri_args()local productId=uri_args["productId"] local host={"192.168.0.61","192.168.0.62"}local hash=ngx.crc32_long(productId) hash = (hash%2)+1backend="http://"..host[hash]local method = uri_args["method"] local requestBody="/"..method.."?productId="..productIdlocal http=require("resty.http") localhttpc=http.new()local resp,err=httpc:request_uri(backend,{      method = "GET", path = requestBody, keepalive=false})if not resp then    ngx.say("request error :", err)    returnend ngx.say(resp.body) httpc:close()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰“å¼€ lua.conf</p><pre class="line-numbers language-sh"><code class="language-sh">vim lua.conf åœ¨serveréƒ¨åˆ†åŠ å…¥ location/product{    default_type 'text/html';    content_by_lua_file /usr/servers/nginx/conf/luaâ€distribution.lua; }../sbin/nginxâ€sreload#è®¿é—®:http://192.168.0.60/lua?productId=XX ä¼šæ ¹æ®productIdå°†è¯·æ±‚åˆ†å‘åˆ°ä¸åŒçš„åº”ç”¨å±‚nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å››ã€Nginx-luaå¼€å‘åº”ç”¨å±‚é¡µé¢ç¼“å­˜ä¸æ¨¡æ¿åŠ¨æ€æ¸²æŸ“é€»è¾‘"><a href="#å››ã€Nginx-luaå¼€å‘åº”ç”¨å±‚é¡µé¢ç¼“å­˜ä¸æ¨¡æ¿åŠ¨æ€æ¸²æŸ“é€»è¾‘" class="headerlink" title="å››ã€Nginx+luaå¼€å‘åº”ç”¨å±‚é¡µé¢ç¼“å­˜ä¸æ¨¡æ¿åŠ¨æ€æ¸²æŸ“é€»è¾‘"></a>å››ã€Nginx+luaå¼€å‘åº”ç”¨å±‚é¡µé¢ç¼“å­˜ä¸æ¨¡æ¿åŠ¨æ€æ¸²æŸ“é€»è¾‘</h3><pre class="line-numbers language-sh"><code class="language-sh">##åº”ç”¨å±‚éœ€è¦è®¿é—®æœåŠ¡httpæ¥å£ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦å¼•å…¥lua http libåŒ…cd /usr/servers/lualib/resty wget https://raw.githubusercontent.com/pintsized/luaâ€restyâ€http/master/lib/resty/http_headers.luawget https://raw.githubusercontent.com/pintsized/luaâ€restyâ€http/master/lib/resty/http.lua##åº”ç”¨å±‚è¿˜éœ€è¦ç”¨åˆ°æ¨¡æ¿åŠ¨æ€æ¸²æŸ“æŠ€æœ¯ï¼Œæ‰€ä»¥è¿˜éœ€è¦å¼•å…¥luaçš„templateåŒ…cd  /usr/servers/lualib/resty wget https://raw.githubusercontent.com/bungle/luaâ€restyâ€template/master/lib/resty/template.lua mkdir/usr/servers/lualib/resty/htmlcd /usr/servers/lualib/resty/html wget https://raw.githubusercontent.com/bungle/luaâ€restyâ€template/master/lib/resty/template/html.luacd /usr/servers/templates vim product.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å¢åŠ htmlé™æ€æ¨¡æ¿ </li></ul><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">httpâ€equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Contentâ€Type<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/html; charset<span class="token punctuation">=</span>utfâ€8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>å•†å“id: {* productId *}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span> å•†å“åç§°: {* productName *}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span> å•†å“åŸä»·: {* productPrice *}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span> å•†å“ç°ä»·: {* productNowPrice *}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span> å•†å“åº“å­˜: {* productStock *}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span> å•†å“æè¿°: {* productHTML *}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sh"><code class="language-sh">cd  /usr/servers/nginx/confvim lua.conf## åœ¨serveréƒ¨åˆ†åŠ å…¥set $template_location"/templates";set $template_root"/usr/servers/templates";## å¢åŠ ngxinç¼“å­˜é…ç½®vim lua.conf## åœ¨æœ€å‰é¢åŠ å…¥lua_shared_dictmy_cache  128m;## å¢åŠ å•†å“è¯¦æƒ…é¡µæ¸²æŸ“çš„luaè„šæœ¬vim lua.conf## åœ¨serveréƒ¨åˆ†å¢åŠ location/product{  default_type 'text/html';  content_by_lua_file /usr/servers/nginx/conf/product.lua;}## æœ€åï¼Œç¼–å†™å•†å“è¯¦æƒ…é¡µæ¸²æŸ“luaè„šæœ¬vim product.lualocal uri_args=ngx.req.get_uri_args()local productId=uri_args["productId"]local cache_ngx=ngx.shared.my_cachelocal productCacheKey="product_info_"..productIdlocal productCache=cache_ngx:get(productCacheKey)if productCache == "" or productCache == nil then   local http=require("resty.http")   local httpc=http.new()   local resp,err=httpc:request_uri("http://192.168.0.175:8080",{   method="GET", path="/shopâ€web/product/cache/"..productId,keepalive=false   })   productCache = resp.body   local expireTime = math.random(600,1200)   cache_ngx:set(productCacheKey,productCache,expireTime)endngx.log(ngx.ERR,"jsonâ€â€â€â€â€â€â€â€2",productCache)local cjson=require("cjson")local productCacheJSON=cjson.decode(productCache)local context={    productId=productCacheJSON.id,    productName=productCacheJSON.name,    productPrice=productCacheJSON.price,    productNowPrice=productCacheJSON.nowPrice,    productStock=productCacheJSON.stock,    productHTML=productCacheJSON.productHTML}local template=require("resty.template")template.render("product.html",context)../sbin/nginxâ€sreload ## è®¿é—®:http://192.168.0.60/product?productId=XX&method=product## ä¼šæ ¹æ®productIdå°†è¯·æ±‚åˆ†å‘åˆ°ä¸åŒçš„åº”ç”¨å±‚nginxè·å–ç›¸åº”çš„å•†å“è¯¦æƒ…é¡µé¢<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å…·ä½“å®ç°æ­¥éª¤ï¼š&quot;&gt;&lt;a href=&quot;#å…·ä½“å®ç°æ­¥éª¤ï¼š&quot; class=&quot;headerlink&quot; title=&quot;å…·ä½“å®ç°æ­¥éª¤ï¼š&quot;&gt;&lt;/a&gt;å…·ä½“å®ç°æ­¥éª¤ï¼š&lt;/h2&gt;&lt;p&gt;ä¾æ‰˜äº OpenResty æ¡†æ¶å®ç°&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="Java" scheme="https://brokge.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>ç½‘ç»œåè®®æ¢³ç†</title>
    <link href="https://brokge.github.io/2020/06/06/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A2%B3%E7%90%86/"/>
    <id>https://brokge.github.io/2020/06/06/ç½‘ç»œåè®®æ¢³ç†/</id>
    <published>2020-06-06T09:35:01.000Z</published>
    <updated>2020-07-24T14:12:49.138Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€OSI-ç½‘ç»œä¸ƒå±‚æ¨¡å‹"><a href="#ä¸€ã€OSI-ç½‘ç»œä¸ƒå±‚æ¨¡å‹" class="headerlink" title="ä¸€ã€OSI ç½‘ç»œä¸ƒå±‚æ¨¡å‹"></a>ä¸€ã€OSI ç½‘ç»œä¸ƒå±‚æ¨¡å‹</h2><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/0A162883B11F412DBAF35E4FDB31D054.jpg" alt="image"></p><p><strong>åº”ç”¨å±‚</strong>ï¼š<br>å†³å®šå‘ç”¨æˆ·æä¾›åº”ç”¨æœåŠ¡æ—¶é€šä¿¡çš„æ´»åŠ¨ï¼Œæ­¤å¤„çš„æ´»åŠ¨åŒ…æ‹¬æ¯”å¦‚å¾…ä¼ é€æ•°æ®çš„å¤„ç†ï¼ˆåº”ç”¨å†…éƒ¨ç”Ÿæˆç‰¹å®šæ ¼å¼çš„æ•°æ®ï¼Œåå¯¹æ•°æ®è¿›è¡Œæ ‡å‡†åè®®çš„æ ¼å¼çš„ç¼–ç ï¼‰ã€‚</p><p><strong>è¡¨ç¤ºå±‚</strong><br>è´Ÿè´£æ•°æ®æ ¼å¼è½¬æ¢ã€æ•°æ®åŠ å¯†ä¸è§£å¯†ã€å‹ç¼©è§£å‹ç¼©ç­‰</p><p><strong>ä¼šè¯å±‚</strong><br>è´Ÿè´£å»ºç«‹ã€ç®¡ç†å’Œç»ˆæ­¢è¿›ç¨‹ä¹‹é—´çš„ä¼šè¯å’Œæ•°æ®äº¤æ¢ã€‚</p><p><strong>ä¼ è¾“å±‚ï¼š</strong><br>å¯¹ä¸Šå±‚åº”ç”¨å±‚ï¼Œæä¾›å¤„äºç½‘ç»œè¿æ¥ç§çš„ä¸¤å°è®¡ç®—æœºä¹‹é—´çš„æ•°æ®ä¼ è¾“ï¼ˆTCPã€UDPï¼‰ã€‚</p><p><strong>ç½‘ç»œå±‚ï¼š</strong><br>ç”¨æ¥å¤„ç†ç½‘ç»œä¸ŠæµåŠ¨çš„æ•°æ®åŒ…ï¼Œæ•°æ®åŒ…æ˜¯ç½‘ç»œä¼ è¾“çš„æœ€å°æ•°æ®å•ä½ã€‚è¯¥å±‚è§„å®šäº†é€šè¿‡æ€æ ·çš„è·¯å¾„åˆ°è¾¾å¯¹æ–¹è®¡ç®—æœºï¼Œå¹¶æŠŠæ•°æ®åŒ…ä¼ é€ç»™å¯¹æ–¹ã€‚<br>ä¸å¯¹æ–¹è®¡ç®—æœºä¹‹é—´é€šè¿‡å¤šå°è®¡ç®—æœºæˆ–ç½‘ç»œè®¾å¤‡è¿›è¡Œä¼ è¾“æ—¶ï¼Œç½‘ç»œå±‚æ‰€èµ·çš„ä½œç”¨å°±æ˜¯åœ¨ä¼—å¤šçš„é€‰é¡¹å†…é€‰æ‹©ä¸€æ¡ä¼ è¾“è·¯çº¿ã€‚</p><p><strong>é“¾è·¯å±‚</strong>ï¼ˆåˆåæ•°æ®é“¾è·¯å±‚ï¼Œç½‘ç»œæ¥å£å±‚ï¼‰ï¼š<br>ç”¨æ¥ç®¡ç†ï¼æ“ä½œè¿æ¥ç½‘ç»œçš„ç¡¬ä»¶éƒ¨åˆ†ã€‚åŒ…æ‹¬æ§åˆ¶æ“ä½œç³»ç»Ÿã€ç¡¬ä»¶çš„è®¾å¤‡é©±åŠ¨ã€ç½‘å¡ã€å…‰çº¤ç­‰ç‰©ç†å¯è§éƒ¨åˆ†ã€‚</p><a id="more"></a><h2 id="äºŒã€-OSI-ä¸ƒå±‚æ¨¡å‹å¯¹åº”çš„åè®®"><a href="#äºŒã€-OSI-ä¸ƒå±‚æ¨¡å‹å¯¹åº”çš„åè®®" class="headerlink" title="äºŒã€ OSI ä¸ƒå±‚æ¨¡å‹å¯¹åº”çš„åè®®"></a>äºŒã€ OSI ä¸ƒå±‚æ¨¡å‹å¯¹åº”çš„åè®®</h2><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/2B803AB503B144418B043A283CC22B3A.jpg" alt="image"> </p><h2 id="TCP-UDP-ç½‘ç»œè¯·æ±‚è¿‡ç¨‹"><a href="#TCP-UDP-ç½‘ç»œè¯·æ±‚è¿‡ç¨‹" class="headerlink" title="TCP/UDP ç½‘ç»œè¯·æ±‚è¿‡ç¨‹"></a>TCP/UDP ç½‘ç»œè¯·æ±‚è¿‡ç¨‹</h2><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/451F2587D1F4416198ED3CEACAB3052B.jpg" alt="image"> </p><p>å‘é€ç«¯ï¼šåœ¨å±‚ä¸å±‚ä¹‹é—´ä¼ è¾“æ•°æ®æ—¶ï¼Œæ¯ä¸€å±‚éƒ½ä¼šè¢«æ‰“ä¸Šå½“å‰å±‚æ‰€å±çš„å¤´éƒ¨ä¿¡æ¯ã€‚</p><p>æ¥æ”¶ç«¯ï¼šåœ¨å±‚ä¸å±‚ä¹‹é—´ä¼ è¾“æ•°æ®æ—¶ï¼Œæ¯ä¸€å±‚éƒ½ä¼šå–æ¶ˆå½“å‰å±‚æ‰€å±çš„å¤´éƒ¨ä¿¡æ¯ã€‚</p><h3 id="TCP-å¤´éƒ¨ä¿¡æ¯"><a href="#TCP-å¤´éƒ¨ä¿¡æ¯" class="headerlink" title="TCP å¤´éƒ¨ä¿¡æ¯"></a>TCP å¤´éƒ¨ä¿¡æ¯</h3><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/8890607AEBBB48C286631BC8087B2941.jpg" alt="image"> </p><h3 id="TCP-å¯é æ€§ä¿è¯"><a href="#TCP-å¯é æ€§ä¿è¯" class="headerlink" title="TCP å¯é æ€§ä¿è¯"></a>TCP å¯é æ€§ä¿è¯</h3><ul><li><p>ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹æœºåˆ¶</p><blockquote><p>åœ¨å»ºç«‹è¿æ¥çš„æ—¶å€™ï¼Œé€šè¿‡3 æ¬¡æ¡æ‰‹æœºåˆ¶ã€‚åœ¨ç»“æŸè¿æ¥çš„æ—¶å€™é€šè¿‡4æ¬¡æŒ¥æ‰‹ã€‚è¿™æ ·ä¿è¯è¿æ¥çš„å¯é æ€§ã€‚</p></blockquote></li><li><p>æ ¡éªŒå’Œ</p><blockquote><p>å‘é€çš„æ•°æ®åŒ…çš„äºŒè¿›åˆ¶ç›¸åŠ ç„¶åå–åï¼Œç›®çš„æ˜¯æ£€æµ‹æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­çš„ä»»ä½•å˜åŒ–ã€‚å¦‚æœæ”¶åˆ°æ®µçš„æ£€éªŒå’Œæœ‰å·®é”™ï¼ŒTCPå°†ä¸¢å¼ƒè¿™ä¸ªæŠ¥æ–‡æ®µå’Œä¸ç¡®è®¤æ”¶åˆ°æ­¤æŠ¥æ–‡æ®µã€‚</p></blockquote></li><li><p>ç¡®è®¤åº”ç­”+åºåˆ—å·</p><blockquote><p>TCPç»™å‘é€çš„æ¯ä¸€ä¸ªåŒ…è¿›è¡Œç¼–å·ï¼Œæ¥æ”¶æ–¹å¯¹æ•°æ®åŒ…è¿›è¡Œæ’åºï¼ŒæŠŠæœ‰åºæ•°æ®ä¼ é€ç»™åº”ç”¨å±‚ã€‚</p></blockquote></li><li><p>è¶…æ—¶é‡ä¼ </p><blockquote><p>å½“TCPå‘å‡ºä¸€ä¸ªæ®µåï¼Œå®ƒå¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨ï¼Œç­‰å¾…ç›®çš„ç«¯ç¡®è®¤æ”¶åˆ°è¿™ä¸ªæŠ¥æ–‡æ®µã€‚å¦‚æœä¸èƒ½åŠæ—¶æ”¶åˆ°ä¸€ä¸ªç¡®è®¤ï¼Œå°†é‡å‘è¿™ä¸ªæŠ¥æ–‡æ®µã€‚é‚£ä¹ˆå‘é€æ–¹å‘é€å®Œæ¯•åç­‰å¾…çš„æ—¶é—´æ˜¯å¤šå°‘å‘¢ï¼Ÿå¦‚æœè¿™ä¸ªç­‰å¾…çš„æ—¶é—´è¿‡é•¿ï¼Œé‚£ä¹ˆä¼šå½±å“TCPä¼ è¾“çš„æ•´ä½“æ•ˆç‡ï¼Œå¦‚æœç­‰å¾…æ—¶é—´è¿‡çŸ­ï¼Œåˆä¼šå¯¼è‡´é¢‘ç¹çš„å‘é€é‡å¤çš„åŒ…ã€‚å¦‚ä½•æƒè¡¡ï¼Ÿ</p><p>ç”±äºTCPä¼ è¾“æ—¶ä¿è¯èƒ½å¤Ÿåœ¨ä»»ä½•ç¯å¢ƒä¸‹éƒ½æœ‰ä¸€ä¸ªé«˜æ€§èƒ½çš„é€šä¿¡ï¼Œå› æ­¤è¿™ä¸ªæœ€å¤§è¶…æ—¶æ—¶é—´ï¼ˆä¹Ÿå°±æ˜¯ç­‰å¾…çš„æ—¶é—´ï¼‰æ˜¯åŠ¨æ€è®¡ç®—çš„ã€‚</p><p>è¶…æ—¶ä»¥500msï¼ˆ0.5ç§’ï¼‰ä¸ºä¸€ä¸ªå•ä½è¿›è¡Œæ§åˆ¶ï¼Œæ¯æ¬¡åˆ¤å®šè¶…æ—¶é‡å‘çš„è¶…æ—¶æ—¶é—´éƒ½æ˜¯500msçš„æ•´æ•°å€ã€‚é‡å‘ä¸€æ¬¡åï¼Œä»æœªå“åº”ï¼Œé‚£ä¹ˆç­‰å¾…2<em>500msçš„æ—¶é—´åï¼Œå†æ¬¡é‡ä¼ ã€‚ç­‰å¾…4</em>500msçš„æ—¶é—´ç»§ç»­é‡ä¼ ã€‚ä»¥ä¸€ä¸ªæŒ‡æ•°çš„å½¢å¼å¢é•¿ã€‚ç´¯è®¡åˆ°ä¸€å®šçš„é‡ä¼ æ¬¡æ•°ï¼ŒTCPå°±è®¤ä¸ºç½‘ç»œæˆ–è€…å¯¹ç«¯å‡ºç°å¼‚å¸¸ï¼Œå¼ºåˆ¶å…³é—­è¿æ¥ã€‚</p></blockquote></li><li><p>æµé‡æ§åˆ¶</p><blockquote><p>TCPè¿æ¥çš„æ¯ä¸€æ–¹éƒ½æœ‰å›ºå®šå¤§å°çš„ç¼“å†²ç©ºé—´ï¼ŒTCPçš„æ¥æ”¶ç«¯åªå…è®¸å‘é€ç«¯å‘é€æ¥æ”¶ç«¯ç¼“å†²åŒºèƒ½æ¥çº³çš„æ•°æ®ã€‚å½“æ¥æ”¶æ–¹æ¥ä¸åŠå¤„ç†å‘é€æ–¹çš„æ•°æ®ï¼Œèƒ½æç¤ºå‘é€æ–¹é™ä½å‘é€çš„é€Ÿç‡ï¼Œé˜²æ­¢åŒ…ä¸¢å¤±ã€‚TCPä½¿ç”¨çš„æµé‡æ§åˆ¶åè®®æ˜¯å¯å˜å¤§å°çš„æ»‘åŠ¨çª—å£åè®®ã€‚æ¥æ”¶æ–¹æœ‰å³æ—¶çª—å£ï¼ˆæ»‘åŠ¨çª—å£ï¼‰ï¼ŒéšACKæŠ¥æ–‡å‘é€ã€‚</p></blockquote></li><li><p>æ‹¥å¡æ§åˆ¶</p><blockquote><p>è€Œä¸” TCP å¼•å…¥äº†æ…¢å¯åŠ¨çš„æœºåˆ¶ï¼Œåœ¨å¼€å§‹å‘é€æ•°æ®æ—¶ï¼Œå…ˆå‘é€å°‘é‡çš„æ•°æ®æ¢è·¯ã€‚æ¢æ¸…å½“å‰çš„ç½‘ç»œçŠ¶æ€å¦‚ä½•ï¼Œå†å†³å®šå¤šå¤§çš„é€Ÿåº¦è¿›è¡Œä¼ è¾“ã€‚è¿™æ—¶å€™å°±å¼•å…¥ä¸€ä¸ªå«åšæ‹¥å¡çª—å£çš„æ¦‚å¿µã€‚å‘é€åˆšå¼€å§‹å®šä¹‰æ‹¥å¡çª—å£ä¸º 1ï¼Œæ¯æ¬¡æ”¶åˆ°ACKåº”ç­”ï¼Œæ‹¥å¡çª—å£åŠ 1ã€‚åœ¨å‘é€æ•°æ®ä¹‹å‰ï¼Œé¦–å…ˆå°†æ‹¥å¡çª—å£ä¸æ¥æ”¶ç«¯åé¦ˆçš„çª—å£å¤§å°æ¯”å¯¹ï¼Œå–è¾ƒå°çš„å€¼ä½œä¸ºå®é™…å‘é€çš„çª—å£ã€‚å‘é€è¿‡ç¨‹ä¸­å½“ç½‘ç»œæ‹¥å¡æ—¶ï¼Œå‡å°‘æ•°æ®çš„å‘é€ã€‚å‘é€æ–¹æœ‰æ‹¥å¡çª—å£ï¼Œå‘é€æ•°æ®å‰æ¯”å¯¹æ¥æ”¶æ–¹å‘è¿‡æ¥çš„åŠæ—¶çª—å£ã€‚</p></blockquote></li></ul><h3 id="TCP-æ¡æ‰‹å’ŒæŒ¥æ‰‹æœºåˆ¶"><a href="#TCP-æ¡æ‰‹å’ŒæŒ¥æ‰‹æœºåˆ¶" class="headerlink" title="TCP æ¡æ‰‹å’ŒæŒ¥æ‰‹æœºåˆ¶"></a>TCP æ¡æ‰‹å’ŒæŒ¥æ‰‹æœºåˆ¶</h3><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/3467CABB79EC412A955A981B18752DE3.jpg" alt="image"> </p><h2 id="ä¸‰ã€-æµè§ˆå™¨ä¸­è¾“å…¥ä¸€ä¸ªåŸŸååœ°å€-å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ"><a href="#ä¸‰ã€-æµè§ˆå™¨ä¸­è¾“å…¥ä¸€ä¸ªåŸŸååœ°å€-å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ä¸‰ã€ æµè§ˆå™¨ä¸­è¾“å…¥ä¸€ä¸ªåŸŸååœ°å€ å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ"></a>ä¸‰ã€ æµè§ˆå™¨ä¸­è¾“å…¥ä¸€ä¸ªåŸŸååœ°å€ å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</h2><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/9FF77B5A7DF74377A11A7049C637C1C6.jpg" alt="image"> </p><pre class="line-numbers language-shell"><code class="language-shell">$ nslookup www.baidu.comServer:        192.168.1.1Address:    192.168.1.1#53Non-authoritative answer:www.baidu.com    canonical name = www.a.shifen.com.Name:    www.a.shifen.comAddress: 36.152.44.95Name:    www.a.shifen.comAddress: 36.152.44.96<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å››ã€-WebSocket-å’Œ-HTTP-Socket-åŒºåˆ«"><a href="#å››ã€-WebSocket-å’Œ-HTTP-Socket-åŒºåˆ«" class="headerlink" title="å››ã€ WebSocket å’Œ HTTP, Socket åŒºåˆ«"></a>å››ã€ WebSocket å’Œ HTTP, Socket åŒºåˆ«</h2><p>WebSocket åŒ HTTP ä¸€æ ·ä¹Ÿæ˜¯åº”ç”¨å±‚çš„åè®®,ä½†æ˜¯å®ƒæ˜¯ä¸€ç§åŒå‘é€šä¿¡åè®®,æ˜¯å»ºç«‹åœ¨TCPä¹‹ä¸Šçš„ã€‚</p><h3 id="è¿æ¥è¿‡ç¨‹"><a href="#è¿æ¥è¿‡ç¨‹" class="headerlink" title="è¿æ¥è¿‡ç¨‹"></a>è¿æ¥è¿‡ç¨‹</h3><ol><li><p>æµè§ˆå™¨ã€æœåŠ¡å™¨é€šè¿‡ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹TCPè¿æ¥ ã€‚è¿™æ˜¯é€šä¿¡çš„åŸºç¡€,è‹¥å¤±è´¥åç»­éƒ½ä¸æ‰§è¡Œã€‚</p></li><li><p>TCPè¿æ¥æˆåŠŸå,æµè§ˆå™¨é€šè¿‡HTTPåè®®å‘æœåŠ¡å™¨ä¼ é€WebSocket æ”¯æŒçš„ç‰ˆæœ¬å·ç­‰ä¿¡æ¯ã€‚(å¼€å§‹å‰çš„HTTPæ¡æ‰‹ï¼‰</p></li><li><p>æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„æ¡æ‰‹è¯·æ±‚å,åŒæ ·é‡‡ç”¨HTTPåè®®å›é¦ˆæ•°æ®ã€‚</p></li><li><p>å½“æ”¶åˆ°äº†è¿æ¥æˆåŠŸçš„æ¶ˆæ¯å,é€šè¿‡TCPé€šé“è¿›è¡Œä¼ è¾“é€šä¿¡ã€‚</p></li></ol><h3 id="WebSocketä¸HTTPçš„ç›¸åŒç‚¹å’Œä¸åŒç‚¹"><a href="#WebSocketä¸HTTPçš„ç›¸åŒç‚¹å’Œä¸åŒç‚¹" class="headerlink" title="WebSocketä¸HTTPçš„ç›¸åŒç‚¹å’Œä¸åŒç‚¹"></a>WebSocketä¸HTTPçš„ç›¸åŒç‚¹å’Œä¸åŒç‚¹</h3><ul><li>ç›¸åŒç‚¹</li></ul><ol><li>éƒ½æ˜¯ä¸€æ ·åŸºäºTCPçš„,éƒ½æ˜¯å¯é æ€§ä¼ è¾“åè®®ã€‚</li><li>éƒ½æ˜¯åº”ç”¨å±‚åè®®</li></ol><ul><li>ä¸åŒç‚¹</li></ul><ol><li>WebSocketæ˜¯åŒå‘é€šä¿¡åè®®,æ¨¡æ‹ŸSocketåè®®,å¯ä»¥åŒå‘å‘é€æˆ–æ¥å—ä¿¡æ¯,HTTPæ˜¯å•å‘çš„ã€‚</li><li>WebSocketæ˜¯éœ€è¦æ¡æ‰‹è¿›è¡Œå»ºç«‹è¿æ¥çš„ ï¼ŒWebSocketåœ¨å»ºç«‹æ¡æ‰‹æ—¶,æ•°æ®æ˜¯é€šè¿‡HTTPä¼ è¾“çš„ã€‚ä½†æ˜¯å»ºç«‹ä¹‹å,åœ¨çœŸæ­£ä¼ è¾“æ—¶å€™æ˜¯ä¸éœ€è¦HTTPåè®®çš„ã€‚</li></ol><h3 id="WebSocket-ä¸-Socketçš„å…³ç³»"><a href="#WebSocket-ä¸-Socketçš„å…³ç³»" class="headerlink" title="WebSocket ä¸ Socketçš„å…³ç³»"></a>WebSocket ä¸ Socketçš„å…³ç³»</h3><p>Socket å…¶å®å¹¶ä¸æ˜¯ä¸€ä¸ªåè®®,è€Œæ˜¯ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ TCP æˆ– UDP è€ŒæŠ½è±¡å‡ºæ¥çš„å±‚,æ˜¯ä½äºåº”ç”¨å±‚å’Œä¼ è¾“æ§åˆ¶å±‚ä¹‹é—´çš„â€”ç»„æ¥å£ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/5F3C32A779AF4085B1EFA79585EFA7F0.jpg" alt="image"> </p><blockquote><p>Socket æ˜¯åº”ç”¨å±‚ä¸ TCP/IP åè®®æ—é€šä¿¡çš„ä¸­é—´è½¯ä»¶æŠ½è±¡å±‚,å®ƒæ˜¯ä¸€ç»„æ¥å£ã€‚åœ¨è®¾è®¡æ¨¡å¼ä¸­, Socketå…¶å®å°±æ˜¯ä¸€ä¸ªé—¨é¢æ¨¡å¼,å®ƒæŠŠå¤æ‚çš„ TCP/IP åè®®æ—éšè—åœ¨ Socket æ¥å£åé¢,å¯¹ç”¨æˆ·æ¥è¯´,ä¸€ç»„ç®€å•çš„æ¥å£å°±æ˜¯å…¨éƒ¨,è®© Socketå»ç»„ç»‡æ•°æ®,ä»¥ç¬¦åˆæŒ‡å®šçš„åè®®ã€‚</p></blockquote><p>å½“ä¸¤å°ä¸»æœºé€šä¿¡æ—¶,å¿…é¡»é€šè¿‡ Socket è¿æ¥, Socketåˆ™åˆ©ç”¨ TCP/IP åè®®å»ºç«‹ TCP è¿æ¥ã€‚TCPè¿æ¥åˆ™æ›´ä¾é äºåº•å±‚çš„ IP åè®®, IP åè®®çš„è¿æ¥åˆ™ä¾èµ–äºé“¾è·¯å±‚ç­‰æ›´ä½å±‚æ¬¡ã€‚</p><p>WebSocket åˆ™æ˜¯ä¸€ä¸ªå…¸å‹çš„åº”ç”¨å±‚åè®®ã€‚</p><ul><li>åŒºåˆ«</li></ul><p>Socketæ˜¯ä¼ è¾“æ§åˆ¶å±‚åè®®, WebSocketæ˜¯åº”ç”¨å±‚åè®®ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>å›¾è§£ http</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ä¸€ã€OSI-ç½‘ç»œä¸ƒå±‚æ¨¡å‹&quot;&gt;&lt;a href=&quot;#ä¸€ã€OSI-ç½‘ç»œä¸ƒå±‚æ¨¡å‹&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€OSI ç½‘ç»œä¸ƒå±‚æ¨¡å‹&quot;&gt;&lt;/a&gt;ä¸€ã€OSI ç½‘ç»œä¸ƒå±‚æ¨¡å‹&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://cdn.jsdelivr.net/gh/brokge/drawio/img/0A162883B11F412DBAF35E4FDB31D054.jpg&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åº”ç”¨å±‚&lt;/strong&gt;ï¼š&lt;br&gt;å†³å®šå‘ç”¨æˆ·æä¾›åº”ç”¨æœåŠ¡æ—¶é€šä¿¡çš„æ´»åŠ¨ï¼Œæ­¤å¤„çš„æ´»åŠ¨åŒ…æ‹¬æ¯”å¦‚å¾…ä¼ é€æ•°æ®çš„å¤„ç†ï¼ˆåº”ç”¨å†…éƒ¨ç”Ÿæˆç‰¹å®šæ ¼å¼çš„æ•°æ®ï¼Œåå¯¹æ•°æ®è¿›è¡Œæ ‡å‡†åè®®çš„æ ¼å¼çš„ç¼–ç ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;è¡¨ç¤ºå±‚&lt;/strong&gt;&lt;br&gt;è´Ÿè´£æ•°æ®æ ¼å¼è½¬æ¢ã€æ•°æ®åŠ å¯†ä¸è§£å¯†ã€å‹ç¼©è§£å‹ç¼©ç­‰&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¼šè¯å±‚&lt;/strong&gt;&lt;br&gt;è´Ÿè´£å»ºç«‹ã€ç®¡ç†å’Œç»ˆæ­¢è¿›ç¨‹ä¹‹é—´çš„ä¼šè¯å’Œæ•°æ®äº¤æ¢ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¼ è¾“å±‚ï¼š&lt;/strong&gt;&lt;br&gt;å¯¹ä¸Šå±‚åº”ç”¨å±‚ï¼Œæä¾›å¤„äºç½‘ç»œè¿æ¥ç§çš„ä¸¤å°è®¡ç®—æœºä¹‹é—´çš„æ•°æ®ä¼ è¾“ï¼ˆTCPã€UDPï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç½‘ç»œå±‚ï¼š&lt;/strong&gt;&lt;br&gt;ç”¨æ¥å¤„ç†ç½‘ç»œä¸ŠæµåŠ¨çš„æ•°æ®åŒ…ï¼Œæ•°æ®åŒ…æ˜¯ç½‘ç»œä¼ è¾“çš„æœ€å°æ•°æ®å•ä½ã€‚è¯¥å±‚è§„å®šäº†é€šè¿‡æ€æ ·çš„è·¯å¾„åˆ°è¾¾å¯¹æ–¹è®¡ç®—æœºï¼Œå¹¶æŠŠæ•°æ®åŒ…ä¼ é€ç»™å¯¹æ–¹ã€‚&lt;br&gt;ä¸å¯¹æ–¹è®¡ç®—æœºä¹‹é—´é€šè¿‡å¤šå°è®¡ç®—æœºæˆ–ç½‘ç»œè®¾å¤‡è¿›è¡Œä¼ è¾“æ—¶ï¼Œç½‘ç»œå±‚æ‰€èµ·çš„ä½œç”¨å°±æ˜¯åœ¨ä¼—å¤šçš„é€‰é¡¹å†…é€‰æ‹©ä¸€æ¡ä¼ è¾“è·¯çº¿ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;é“¾è·¯å±‚&lt;/strong&gt;ï¼ˆåˆåæ•°æ®é“¾è·¯å±‚ï¼Œç½‘ç»œæ¥å£å±‚ï¼‰ï¼š&lt;br&gt;ç”¨æ¥ç®¡ç†ï¼æ“ä½œè¿æ¥ç½‘ç»œçš„ç¡¬ä»¶éƒ¨åˆ†ã€‚åŒ…æ‹¬æ§åˆ¶æ“ä½œç³»ç»Ÿã€ç¡¬ä»¶çš„è®¾å¤‡é©±åŠ¨ã€ç½‘å¡ã€å…‰çº¤ç­‰ç‰©ç†å¯è§éƒ¨åˆ†ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="ç½‘ç»œ" scheme="https://brokge.github.io/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
      <category term="ç½‘ç»œç¼–ç¨‹" scheme="https://brokge.github.io/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>å¤šçº¿ç¨‹ç¼–ç¨‹å¦‚ä½•ç¡®å®šçº¿ç¨‹ä¸ªæ•°</title>
    <link href="https://brokge.github.io/2020/06/05/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9A%E7%BA%BF%E7%A8%8B%E4%B8%AA%E6%95%B0/"/>
    <id>https://brokge.github.io/2020/06/05/å¤šçº¿ç¨‹ç¼–ç¨‹å¦‚ä½•ç¡®å®šçº¿ç¨‹ä¸ªæ•°/</id>
    <published>2020-06-05T13:08:38.000Z</published>
    <updated>2020-08-21T04:44:45.952Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-å¤šçº¿ç¨‹ç¼–ç¨‹å¦‚ä½•ç¡®å®šçº¿ç¨‹ä¸ªæ•°ï¼Ÿ"><a href="#1-å¤šçº¿ç¨‹ç¼–ç¨‹å¦‚ä½•ç¡®å®šçº¿ç¨‹ä¸ªæ•°ï¼Ÿ" class="headerlink" title="1. å¤šçº¿ç¨‹ç¼–ç¨‹å¦‚ä½•ç¡®å®šçº¿ç¨‹ä¸ªæ•°ï¼Ÿ"></a>1. å¤šçº¿ç¨‹ç¼–ç¨‹å¦‚ä½•ç¡®å®šçº¿ç¨‹ä¸ªæ•°ï¼Ÿ</h1><p>åœ¨å…·ä½“çš„ä¼˜åŒ–åœºæ™¯ä¸­ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§åœºæ™¯ç€æ‰‹ã€‚</p><ol><li><p>CPU å¯†é›†å‹ç¨‹åº</p></li><li><p>I/O å¯†é›†å‹ç¨‹åº</p><a id="more"></a></li></ol><h2 id="1-1-CPU-å¯†é›†å‹"><a href="#1-1-CPU-å¯†é›†å‹" class="headerlink" title="1.1 CPU å¯†é›†å‹"></a>1.1 CPU å¯†é›†å‹</h2><blockquote><ol><li>å•æ ¸CPUå¤„ç† CPU å¯†é›†å‹ç¨‹åºï¼Œè¿™ç§æƒ…å†µå¹¶ä¸å¤ªé€‚åˆä½¿ç”¨å¤šçº¿ç¨‹ã€‚</li><li>å¦‚æœæ˜¯å¤šæ ¸CPU å¤„ç† CPU å¯†é›†å‹ç¨‹åºï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥æœ€å¤§åŒ–çš„åˆ©ç”¨ CPU æ ¸å¿ƒæ•°ï¼Œåº”ç”¨å¹¶å‘ç¼–ç¨‹æ¥æé«˜æ•ˆç‡</li></ol></blockquote><p>çº¿ç¨‹æ•°é‡ = CPU æ ¸æ•°ï¼ˆé€»è¾‘ï¼‰ å°±å¯ä»¥äº†ï¼Œä½†æ˜¯å®é™…ä¸Šï¼Œæ•°é‡ä¸€èˆ¬ä¼šè®¾ç½®ä¸º CPU æ ¸æ•°ï¼ˆé€»è¾‘ï¼‰+ 1, è¿™æ˜¯å› ä¸ºï¼šè®¡ç®—(CPU)å¯†é›†å‹çš„çº¿ç¨‹æ°å¥½åœ¨æŸæ—¶å› ä¸ºå‘ç”Ÿä¸€ä¸ªé¡µé”™è¯¯æˆ–è€…å› å…¶ä»–åŸå› è€Œæš‚åœï¼Œåˆšå¥½æœ‰ä¸€ä¸ªâ€œé¢å¤–â€çš„çº¿ç¨‹ï¼Œå¯ä»¥ç¡®ä¿åœ¨è¿™ç§æƒ…å†µä¸‹CPUå‘¨æœŸä¸ä¼šä¸­æ–­å·¥ä½œã€‚</p><h2 id="1-2-I-Oå¯†é›†å‹"><a href="#1-2-I-Oå¯†é›†å‹" class="headerlink" title="1.2 I/Oå¯†é›†å‹"></a>1.2 I/Oå¯†é›†å‹</h2><blockquote><p>ä¸ CPU å¯†é›†å‹ç¨‹åºç›¸å¯¹ï¼Œä¸€ä¸ªå®Œæ•´è¯·æ±‚ï¼ŒCPUè¿ç®—æ“ä½œå®Œæˆä¹‹åè¿˜æœ‰å¾ˆå¤š I/O æ“ä½œè¦åšï¼Œä¹Ÿå°±æ˜¯è¯´ I/O æ“ä½œå æ¯”å¾ˆå¤§éƒ¨åˆ†</p></blockquote><p>çº¿ç¨‹ç­‰å¾…æ—¶é—´æ‰€å æ¯”ä¾‹è¶Šé«˜ï¼Œéœ€è¦è¶Šå¤šçº¿ç¨‹ï¼›çº¿ç¨‹CPUæ—¶é—´æ‰€å æ¯”ä¾‹è¶Šé«˜ï¼Œéœ€è¦è¶Šå°‘çº¿ç¨‹ã€‚</p><p>æœ€ä½³çº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° *  (1/CPUåˆ©ç”¨ç‡) =  CPUæ ¸å¿ƒæ•° * (1 + (I/Oè€—æ—¶/CPUè€—æ—¶))</p><p>å‡å¦‚å‡ ä¹å…¨æ˜¯ I/Oè€—æ—¶ï¼Œæ‰€ä»¥çº¯ç†è®ºä½ å°±å¯ä»¥è¯´æ˜¯ 2Nï¼ˆN=CPUæ ¸æ•°ï¼‰ï¼Œå½“ç„¶ä¹Ÿæœ‰è¯´ 2N + 1çš„ã€‚</p><h2 id="1-3-é—®é¢˜"><a href="#1-3-é—®é¢˜" class="headerlink" title="1.3 é—®é¢˜"></a>1.3 é—®é¢˜</h2><blockquote><p>å‡è®¾è¦æ±‚ä¸€ä¸ªç³»ç»Ÿçš„ TPSï¼ˆTransaction Per Second æˆ–è€… Task Per Secondï¼‰è‡³å°‘ä¸º 20ï¼Œç„¶åå‡è®¾æ¯ä¸ªTransactionç”±ä¸€ä¸ªçº¿ç¨‹å®Œæˆï¼Œç»§ç»­å‡è®¾å¹³å‡æ¯ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªTransactionçš„æ—¶é—´ä¸º4s</p></blockquote><p>ç­”æ¡ˆï¼š<br>å› ä¸º ä¸€ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ª Transaction æ—¶é—´æ˜¯4ç§’ï¼Œé‚£1ç§’ å¤„ç† 0.25 ä¸ª Transactionï¼›</p><p>æ‰€ä»¥ ï¼š 20 / 0.25 = 80ï¼ˆä¸ªï¼‰ã€‚</p><p>ä½†æ˜¯ï¼Œè¿™æ˜¯å› ä¸ºæ²¡æœ‰è€ƒè™‘åˆ°CPUæ•°ç›®ã€‚ä¸€èˆ¬æœåŠ¡å™¨çš„CPUæ ¸æ•°ä¸º16æˆ–è€…32ï¼Œå¦‚æœæœ‰80ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆè‚¯å®šä¼šå¸¦æ¥å¤ªå¤šä¸å¿…è¦çš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€‚</p><blockquote><p>è®¡ç®—æ“ä½œéœ€è¦5msï¼ŒDBæ“ä½œéœ€è¦ 100msï¼Œå¯¹äºä¸€å° 8ä¸ªCPUçš„æœåŠ¡å™¨ï¼Œæ€ä¹ˆè®¾ç½®çº¿ç¨‹æ•°å‘¢ï¼Ÿ</p></blockquote><p>çº¿ç¨‹æ•° = 8 * (1 + 100/5) = 168 (ä¸ª)</p><blockquote><p>é‚£å¦‚æœDBçš„ QPSï¼ˆQuery Per Secondï¼‰ä¸Šé™æ˜¯1000ï¼Œæ­¤æ—¶è¿™ä¸ªçº¿ç¨‹æ•°åˆè¯¥è®¾ç½®ä¸ºå¤šå¤§å‘¢ï¼Ÿ</p></blockquote><p>ç­”æ¡ˆï¼š å› ä¸º 1 s = 1000ms  å®Œæˆä¸€ä¸ªå®Œæ•´çš„db æ“ä½œç­‰äº 100+5  =105 msã€‚ é‚£ä¸€ä¸ªçº¿ç¨‹ä¸€ç§’å¯ä»¥å¤„ç†çš„ä»»åŠ¡æ•°æ˜¯  1000/105ã€‚168 ä¸ªçº¿ç¨‹ å°±æ˜¯ 168 * 1000/105 = 1600ï¼ˆQPSï¼‰ã€‚</p><p>å¦‚æœ db çš„QPS ä¸Šé™æ˜¯ 1000 ï¼Œåˆ™168*1000/1600 = 105 ä¸ªã€‚</p><h1 id="1-4-å¢åŠ -CPU-æ ¸æ•°ä¸€å®šèƒ½è§£å†³é—®é¢˜å—"><a href="#1-4-å¢åŠ -CPU-æ ¸æ•°ä¸€å®šèƒ½è§£å†³é—®é¢˜å—" class="headerlink" title="1.4 å¢åŠ  CPU æ ¸æ•°ä¸€å®šèƒ½è§£å†³é—®é¢˜å—"></a>1.4 å¢åŠ  CPU æ ¸æ•°ä¸€å®šèƒ½è§£å†³é—®é¢˜å—</h1><p>å³ä¾¿æˆ‘ç®—å‡ºäº†ç†è®ºçº¿ç¨‹æ•°ï¼Œä½†å®é™…CPUæ ¸æ•°ä¸å¤Ÿï¼Œä¼šå¸¦æ¥çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥å°±éœ€è¦å¢åŠ  CPU æ ¸æ•°ï¼Œé‚£æˆ‘ä»¬ç›²ç›®çš„å¢åŠ  CPU æ ¸æ•°å°±ä¸€å®šèƒ½è§£å†³é—®é¢˜å—ï¼Ÿ</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/21A8D6F6DF074BAB8A79192C8190C38E.jpg" alt="image"></p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/DC07610E6E0E4003B7B1F29B8219F936.jpg" alt="image"></p><p>å‡å¦‚æˆ‘ä»¬çš„ä¸²è¡Œç‡æ˜¯ 5%ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ— è®ºé‡‡ç”¨ä»€ä¹ˆæŠ€æœ¯ï¼Œæœ€é«˜ä¹Ÿå°±åªèƒ½æé«˜ 20 å€çš„æ€§èƒ½ã€‚</p><p>æ‰€è°“ä¸²è¡Œç‡ï¼š ä¸´ç•ŒåŒºéƒ½æ˜¯ä¸²è¡Œçš„ï¼Œéä¸´ç•ŒåŒºéƒ½æ˜¯å¹¶è¡Œçš„ï¼Œç”¨å•çº¿ç¨‹æ‰§è¡Œä¸´ç•ŒåŒºçš„æ—¶é—´/ç”¨å•çº¿ç¨‹æ‰§è¡Œ(ä¸´ç•ŒåŒº+éä¸´ç•ŒåŒº)çš„æ—¶é—´å°±æ˜¯ä¸²è¡Œç‡</p><p>å› ä¸ºä¸´ç•ŒåŒºçš„å¤§å°å¾€å¾€å°±æ˜¯ç“¶é¢ˆé—®é¢˜çš„æ‰€åœ¨ï¼Œæ‰€ä»¥å°½å¯èƒ½çš„æœ€å°åŒ–ä¸´ç•ŒåŒºèŒƒå›´</p><h1 id="2-åŠ¨æ€çº¿ç¨‹æ± "><a href="#2-åŠ¨æ€çº¿ç¨‹æ± " class="headerlink" title="2. åŠ¨æ€çº¿ç¨‹æ± "></a>2. åŠ¨æ€çº¿ç¨‹æ± </h1><p>æ‰€è°“åŠ¨æ€çº¿ç¨‹æ± ï¼Œæ˜¯åŠ¨æ€è®¾ç½®çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°ã€æœ‰ç•Œé˜Ÿåˆ—ã€‚</p><h2 id="2-1-åŠ¨æ€è®¾ç½®æ ¸å¿ƒçº¿ç¨‹æ•°-corePoolSize-å’Œ-MaxmumPoolSize"><a href="#2-1-åŠ¨æ€è®¾ç½®æ ¸å¿ƒçº¿ç¨‹æ•°-corePoolSize-å’Œ-MaxmumPoolSize" class="headerlink" title="2.1 åŠ¨æ€è®¾ç½®æ ¸å¿ƒçº¿ç¨‹æ•° corePoolSize å’Œ MaxmumPoolSize"></a>2.1 åŠ¨æ€è®¾ç½®æ ¸å¿ƒçº¿ç¨‹æ•° corePoolSize å’Œ MaxmumPoolSize</h2><pre><code>ThreadPoolExecutor.setCorePoolSize();</code></pre><p>å¹¶ä¸” Spring çš„ ThreadPoolTaskExecutorç±» ï¼ˆå°±æ˜¯å¯¹JDK ThreadPoolExecutor çš„ä¸€å±‚åŒ…è£…ï¼Œå¯ä»¥ç†è§£ä¸ºè£…é¥°è€…æ¨¡å¼ï¼‰ä¹Ÿæä¾›äº†çš„ setCorePoolSize ï¼›</p><pre><code>ThreadPoolExecutor.setMaxmumPoolSize();</code></pre><h3 id="è°ƒæ•´çš„æ—¶å€™æ³¨æ„ç‚¹ï¼š"><a href="#è°ƒæ•´çš„æ—¶å€™æ³¨æ„ç‚¹ï¼š" class="headerlink" title="è°ƒæ•´çš„æ—¶å€™æ³¨æ„ç‚¹ï¼š"></a>è°ƒæ•´çš„æ—¶å€™æ³¨æ„ç‚¹ï¼š</h3><h4 id="1-è°ƒæ•´æ ¸å¿ƒçº¿ç¨‹æ•°ä¹‹åæ— æ•ˆçš„æƒ…å†µ"><a href="#1-è°ƒæ•´æ ¸å¿ƒçº¿ç¨‹æ•°ä¹‹åæ— æ•ˆçš„æƒ…å†µ" class="headerlink" title="1. è°ƒæ•´æ ¸å¿ƒçº¿ç¨‹æ•°ä¹‹åæ— æ•ˆçš„æƒ…å†µ"></a>1. è°ƒæ•´æ ¸å¿ƒçº¿ç¨‹æ•°ä¹‹åæ— æ•ˆçš„æƒ…å†µ</h4><p>è¿™æ˜¯å› ä¸ºï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°å¤§äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œåœ¨æ“ä½œçš„è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸ªå¢å‡æ“ä½œï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹ workerï¼Œç„¶åå·¥ä½œçº¿ç¨‹æ•°è¿›è¡ŒåŠ ä¸€æ“ä½œã€‚</li><li>è¿è¡Œåˆ›å»ºçš„å·¥ä½œçº¿ç¨‹ workerï¼Œå¼€å§‹è·å–ä»»åŠ¡ taskã€‚</li><li>å·¥ä½œçº¿ç¨‹æ•°é‡å¤§äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œå¯¹å·¥ä½œçº¿ç¨‹æ•°è¿›è¡Œå‡ä¸€æ“ä½œã€‚</li><li>è¿”å› nullï¼Œå³æ²¡æœ‰è·å–åˆ° taskã€‚</li><li>æ¸…ç†è¯¥ä»»åŠ¡ï¼Œæµç¨‹ç»“æŸã€‚</li></ol><p>é’ˆå¯¹è¿™ä¸ªæƒ…å†µï¼Œåº”è¯¥ setCorePoolSizeå’Œ setMaxmumPoolSize ä¸€èµ·è°ƒç”¨ã€‚</p><h4 id="2-å¦‚æœè°ƒæ•´ä¹‹åæŠŠæ´»åŠ¨çº¿ç¨‹æ•°è®¾ç½®çš„å€¼å¤ªå¤§äº†ï¼Œå²‚ä¸æ˜¯ä¸šåŠ¡ä½å³°æœŸæˆ‘ä»¬è¿˜éœ€è¦äººå·¥æŠŠå€¼è°ƒçš„å°ä¸€ç‚¹ï¼Ÿ"><a href="#2-å¦‚æœè°ƒæ•´ä¹‹åæŠŠæ´»åŠ¨çº¿ç¨‹æ•°è®¾ç½®çš„å€¼å¤ªå¤§äº†ï¼Œå²‚ä¸æ˜¯ä¸šåŠ¡ä½å³°æœŸæˆ‘ä»¬è¿˜éœ€è¦äººå·¥æŠŠå€¼è°ƒçš„å°ä¸€ç‚¹ï¼Ÿ" class="headerlink" title="2. å¦‚æœè°ƒæ•´ä¹‹åæŠŠæ´»åŠ¨çº¿ç¨‹æ•°è®¾ç½®çš„å€¼å¤ªå¤§äº†ï¼Œå²‚ä¸æ˜¯ä¸šåŠ¡ä½å³°æœŸæˆ‘ä»¬è¿˜éœ€è¦äººå·¥æŠŠå€¼è°ƒçš„å°ä¸€ç‚¹ï¼Ÿ"></a>2. å¦‚æœè°ƒæ•´ä¹‹åæŠŠæ´»åŠ¨çº¿ç¨‹æ•°è®¾ç½®çš„å€¼å¤ªå¤§äº†ï¼Œå²‚ä¸æ˜¯ä¸šåŠ¡ä½å³°æœŸæˆ‘ä»¬è¿˜éœ€è¦äººå·¥æŠŠå€¼è°ƒçš„å°ä¸€ç‚¹ï¼Ÿ</h4><p>å½“ allowCoreThreadTimeOut å‚æ•°è®¾ç½®ä¸º true çš„æ—¶å€™ï¼Œæ ¸å¿ƒçº¿ç¨‹åœ¨ç©ºé—²äº† keepAliveTime çš„æ—¶é—´åä¹Ÿä¼šè¢«å›æ”¶çš„ï¼Œç›¸å½“äºçº¿ç¨‹æ± è‡ªåŠ¨ç»™ä½ åŠ¨æ€ä¿®æ”¹äº†ã€‚</p><h4 id="3-çº¿ç¨‹æ± è¢«åˆ›å»ºåé‡Œé¢æœ‰çº¿ç¨‹å—ï¼Ÿå¦‚æœæ²¡æœ‰çš„è¯ï¼Œä½ çŸ¥é“æœ‰ä»€ä¹ˆæ–¹æ³•å¯¹çº¿ç¨‹æ± è¿›è¡Œé¢„çƒ­å—ï¼Ÿ"><a href="#3-çº¿ç¨‹æ± è¢«åˆ›å»ºåé‡Œé¢æœ‰çº¿ç¨‹å—ï¼Ÿå¦‚æœæ²¡æœ‰çš„è¯ï¼Œä½ çŸ¥é“æœ‰ä»€ä¹ˆæ–¹æ³•å¯¹çº¿ç¨‹æ± è¿›è¡Œé¢„çƒ­å—ï¼Ÿ" class="headerlink" title="3. çº¿ç¨‹æ± è¢«åˆ›å»ºåé‡Œé¢æœ‰çº¿ç¨‹å—ï¼Ÿå¦‚æœæ²¡æœ‰çš„è¯ï¼Œä½ çŸ¥é“æœ‰ä»€ä¹ˆæ–¹æ³•å¯¹çº¿ç¨‹æ± è¿›è¡Œé¢„çƒ­å—ï¼Ÿ"></a>3. çº¿ç¨‹æ± è¢«åˆ›å»ºåé‡Œé¢æœ‰çº¿ç¨‹å—ï¼Ÿå¦‚æœæ²¡æœ‰çš„è¯ï¼Œä½ çŸ¥é“æœ‰ä»€ä¹ˆæ–¹æ³•å¯¹çº¿ç¨‹æ± è¿›è¡Œé¢„çƒ­å—ï¼Ÿ</h4><p>çº¿ç¨‹æ± è¢«åˆ›å»ºåå¦‚æœæ²¡æœ‰ä»»åŠ¡è¿‡æ¥ï¼Œé‡Œé¢æ˜¯ä¸ä¼šæœ‰çº¿ç¨‹çš„ã€‚å¦‚æœéœ€è¦é¢„çƒ­çš„è¯å¯ä»¥è°ƒç”¨ä¸‹é¢çš„ä¸¤ä¸ªæ–¹æ³•æ¥è¿›è¡Œé¢„çƒ­ï¼š</p><pre><code>prestartAllCoreThreads();prestartCoreThread();</code></pre><h4 id="4-æ ¸å¿ƒçº¿ç¨‹æ•°ä¼šè¢«å›æ”¶å—ï¼Ÿéœ€è¦ä»€ä¹ˆè®¾ç½®ï¼Ÿ"><a href="#4-æ ¸å¿ƒçº¿ç¨‹æ•°ä¼šè¢«å›æ”¶å—ï¼Ÿéœ€è¦ä»€ä¹ˆè®¾ç½®ï¼Ÿ" class="headerlink" title="4. æ ¸å¿ƒçº¿ç¨‹æ•°ä¼šè¢«å›æ”¶å—ï¼Ÿéœ€è¦ä»€ä¹ˆè®¾ç½®ï¼Ÿ"></a>4. æ ¸å¿ƒçº¿ç¨‹æ•°ä¼šè¢«å›æ”¶å—ï¼Ÿéœ€è¦ä»€ä¹ˆè®¾ç½®ï¼Ÿ</h4><p>æ ¸å¿ƒçº¿ç¨‹æ•°é»˜è®¤æ˜¯ä¸ä¼šè¢«å›æ”¶çš„ï¼Œå¦‚æœéœ€è¦å›æ”¶æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œéœ€è¦è°ƒç”¨ä¸‹é¢çš„æ–¹æ³•ï¼š</p><pre><code>allowCoreThreadTimeOut()// è¯¥å€¼é»˜è®¤ä¸º falseã€‚</code></pre><p>allowCoreThreadTimeOut é»˜è®¤ä¸ºfalseï¼Œè®¾ç½®trueï¼Œä¼šåœ¨è¿‡æœŸæ—¶é—´ä¹‹åå›æ”¶ æ ¸å¿ƒçº¿ç¨‹ã€‚</p><h2 id="2-2-åŠ¨æ€æŒ‡å®šé˜Ÿåˆ—é•¿åº¦"><a href="#2-2-åŠ¨æ€æŒ‡å®šé˜Ÿåˆ—é•¿åº¦" class="headerlink" title="2.2 åŠ¨æ€æŒ‡å®šé˜Ÿåˆ—é•¿åº¦"></a>2.2 åŠ¨æ€æŒ‡å®šé˜Ÿåˆ—é•¿åº¦</h2><p>é¦–å…ˆé€šè¿‡æºç apiï¼Œæ¥çœ‹æ²¡æœ‰æä¾›ä¿®æ”¹é˜Ÿåˆ—é•¿åº¦çš„æ–¹æ³•ã€‚è¿™æ˜¯ç”±äº ThreadPoolExecutor  å†…éƒ¨çš„ capacity å˜é‡è¢« finalä¿®é¥°ã€‚</p><p>ç”±äºè¿™ä¸ªå› ç´ ï¼Œå¯ä»¥é‡‡ç”¨è‡ªå®šä¹‰é˜Ÿåˆ—çš„æ–¹å¼</p><p>å¯ä»¥æŠŠ LinkedBlockingQueue ç²˜è´´ä¸€ä»½å‡ºæ¥ï¼Œä¿®æ”¹ä¸ªåå­—ï¼Œç„¶åæŠŠ Capacity å‚æ•°çš„ final ä¿®é¥°ç¬¦å»æ‰ï¼Œå¹¶æä¾›å…¶å¯¹åº”çš„ get/set æ–¹æ³•ã€‚</p><p>ç„¶ååœ¨ç¨‹åºé‡Œé¢æŠŠåŸæ¥çš„é˜Ÿåˆ—æ¢æ‰æ–°åˆ›å»ºçš„è‡ªå®šä¹‰é˜Ÿåˆ—ï¼Œè¾¾åˆ°åŠ¨æ€è®¾ç½®é˜Ÿåˆ—é•¿åº¦çš„ç›®çš„ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;1-å¤šçº¿ç¨‹ç¼–ç¨‹å¦‚ä½•ç¡®å®šçº¿ç¨‹ä¸ªæ•°ï¼Ÿ&quot;&gt;&lt;a href=&quot;#1-å¤šçº¿ç¨‹ç¼–ç¨‹å¦‚ä½•ç¡®å®šçº¿ç¨‹ä¸ªæ•°ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;1. å¤šçº¿ç¨‹ç¼–ç¨‹å¦‚ä½•ç¡®å®šçº¿ç¨‹ä¸ªæ•°ï¼Ÿ&quot;&gt;&lt;/a&gt;1. å¤šçº¿ç¨‹ç¼–ç¨‹å¦‚ä½•ç¡®å®šçº¿ç¨‹ä¸ªæ•°ï¼Ÿ&lt;/h1&gt;&lt;p&gt;åœ¨å…·ä½“çš„ä¼˜åŒ–åœºæ™¯ä¸­ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§åœºæ™¯ç€æ‰‹ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;CPU å¯†é›†å‹ç¨‹åº&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;I/O å¯†é›†å‹ç¨‹åº&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="å¹¶å‘ç¼–ç¨‹" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    
    
      <category term="Java" scheme="https://brokge.github.io/tags/Java/"/>
    
      <category term="ä¼˜åŒ–" scheme="https://brokge.github.io/tags/%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Dubboè¯¦è§£</title>
    <link href="https://brokge.github.io/2020/06/02/Dubbo%E8%AF%A6%E8%A7%A3/"/>
    <id>https://brokge.github.io/2020/06/02/Dubboè¯¦è§£/</id>
    <published>2020-06-02T08:28:45.000Z</published>
    <updated>2020-08-21T04:58:28.974Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h2><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/64A03BA7F21B4BB29F4ABC5F11140870.jpg" alt="image"></p><h4 id="åˆ†å¸ƒå¼æ¶æ„çš„-æœ‰-3-ç§è§£å†³æ–¹æ¡ˆ"><a href="#åˆ†å¸ƒå¼æ¶æ„çš„-æœ‰-3-ç§è§£å†³æ–¹æ¡ˆ" class="headerlink" title="åˆ†å¸ƒå¼æ¶æ„çš„ æœ‰ 3 ç§è§£å†³æ–¹æ¡ˆ"></a><strong>åˆ†å¸ƒå¼æ¶æ„çš„ æœ‰ 3 ç§è§£å†³æ–¹æ¡ˆ</strong></h4><ol><li>åŸºäºåå‘ä»£ç†çš„ä¸­å¿ƒåŒ–æ¶æ„</li><li>åµŒå…¥åº”ç”¨å†…éƒ¨çš„å»ä¸­å¿ƒåŒ–æ¶æ„</li><li>åŸºäºç‹¬ç«‹ä»£ç†è¿›ç¨‹çš„Service Meshæ¶æ„<a id="more"></a></li></ol><h4 id="åŸºäºåå‘ä»£ç†çš„é›†ä¸­å¼åˆ†å¸ƒå¼æ¶æ„"><a href="#åŸºäºåå‘ä»£ç†çš„é›†ä¸­å¼åˆ†å¸ƒå¼æ¶æ„" class="headerlink" title="åŸºäºåå‘ä»£ç†çš„é›†ä¸­å¼åˆ†å¸ƒå¼æ¶æ„"></a>åŸºäºåå‘ä»£ç†çš„é›†ä¸­å¼åˆ†å¸ƒå¼æ¶æ„</h4><p>è¿™æ˜¯æœ€ç®€å•å’Œä¼ ç»Ÿåšæ³•ï¼Œåœ¨æœåŠ¡æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ä¹‹é—´ï¼Œä»£ç†ä½œä¸ºç‹¬ç«‹ä¸€å±‚é›†ä¸­éƒ¨ç½²ï¼Œç”±ç‹¬ç«‹å›¢é˜Ÿ(ä¸€èˆ¬æ˜¯è¿ç»´æˆ–æ¡†æ¶)è´Ÿè´£æ²»ç†å’Œè¿ç»´ã€‚å¸¸ç”¨çš„é›†ä¸­å¼ä»£ç†æœ‰ç¡¬ä»¶è´Ÿè½½å‡è¡¡å™¨(å¦‚F5)ï¼Œæˆ–è€…è½¯ä»¶è´Ÿè½½å‡è¡¡å™¨(å¦‚Nginx)ï¼Œè¿™ç§è½¯ç¡¬ç»“åˆä¸¤å±‚ä»£ç†ä¹Ÿæ˜¯ä¸šå†…å¸¸è§åšæ³•ï¼Œå…¼é¡¾é…ç½®çš„çµæ´»æ€§(Nginxæ¯”F5æ˜“äºé…ç½®)ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/29E919D8DA684D4E99671F5A16013855.jpg" alt="image"></p><p><strong>Http+Nginx æ–¹æ¡ˆæ€»ç»“</strong></p><p><strong>ä¼˜ç‚¹ï¼š</strong> ç®€å•å¿«é€Ÿã€å‡ ä¹æ²¡æœ‰å­¦ä¹ æˆæœ¬</p><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> è½»é‡çº§åˆ†å¸ƒå¼ç³»ç»Ÿã€å±€éƒ¨åˆ†å¸ƒå¼æ¶æ„ã€‚</p><p><strong>ç“¶é¢ˆï¼š</strong> Nginxä¸­å¿ƒè´Ÿè½½ã€Httpä¼ è¾“ã€JSONåºåˆ—åŒ–ã€å¼€å‘æ•ˆç‡ã€è¿ç»´æ•ˆç‡ã€‚</p><h3 id="åµŒå…¥åº”ç”¨å†…éƒ¨çš„å»ä¸­å¿ƒåŒ–æ¶æ„"><a href="#åµŒå…¥åº”ç”¨å†…éƒ¨çš„å»ä¸­å¿ƒåŒ–æ¶æ„" class="headerlink" title="åµŒå…¥åº”ç”¨å†…éƒ¨çš„å»ä¸­å¿ƒåŒ–æ¶æ„"></a>åµŒå…¥åº”ç”¨å†…éƒ¨çš„å»ä¸­å¿ƒåŒ–æ¶æ„</h3><p>è¿™æ˜¯å¾ˆå¤šäº’è”ç½‘å…¬å¸æ¯”è¾ƒæµè¡Œçš„ä¸€ç§åšæ³•ï¼Œä»£ç†(åŒ…æ‹¬æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡é€»è¾‘)ä»¥å®¢æˆ·åº“çš„å½¢å¼åµŒå…¥åœ¨åº”ç”¨ç¨‹åºä¸­ã€‚è¿™ç§æ¨¡å¼ä¸€èˆ¬éœ€è¦ç‹¬ç«‹çš„æœåŠ¡æ³¨å†Œä¸­å¿ƒç»„ä»¶é…åˆï¼ŒæœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒå¹¶å®šæœŸæŠ¥å¿ƒè·³ï¼Œå®¢æˆ·ç«¯ä»£ç†åˆ™å‘ç°æœåŠ¡å¹¶åšè´Ÿè½½å‡è¡¡ã€‚æˆ‘ä»¬æ‰€ç†Ÿæ‚‰çš„ duboo å’Œspring cloud Eureka +Ribbon/â€˜rÉªbÉ™n/ éƒ½æ˜¯è¿™ç§æ–¹å¼å®ç°ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/91E7A4D0836A49B395A817DDC2CF2376.jpg" alt="image"><br>ç›¸æ¯”ç¬¬ä¸€ä»£æ¶æ„å®ƒæœ‰ä»¥ä¸‹ç‰¹ç‚¹å‡ ç‚¹ï¼š</p><ul><li>å»ä¸­å¿ƒåŒ–ï¼Œå®¢æˆ·ç«¯ç›´è¿æœåŠ¡ç«¯</li><li>åŠ¨æ€æ³¨å†Œå’Œå‘ç°æœåŠ¡</li><li>é«˜æ•ˆç¨³å®šçš„ç½‘ç»œä¼ è¾“</li><li>é«˜æ•ˆå¯å®¹é”™çš„åºåˆ—åŒ–</li></ul><h3 id="åŸºäºç‹¬ç«‹ä»£ç†è¿›ç¨‹çš„æ¶æ„-Service-Mesh"><a href="#åŸºäºç‹¬ç«‹ä»£ç†è¿›ç¨‹çš„æ¶æ„-Service-Mesh" class="headerlink" title="åŸºäºç‹¬ç«‹ä»£ç†è¿›ç¨‹çš„æ¶æ„(Service Mesh)"></a>åŸºäºç‹¬ç«‹ä»£ç†è¿›ç¨‹çš„æ¶æ„(Service Mesh)</h3><p>è¿™ç§åšæ³•æ˜¯ä¸Šé¢ä¸¤ç§æ¨¡å¼çš„ä¸€ä¸ªæŠ˜ä¸­ï¼Œä»£ç†æ—¢ä¸æ˜¯ç‹¬ç«‹é›†ä¸­éƒ¨ç½²ï¼Œä¹Ÿä¸åµŒå…¥åœ¨å®¢æˆ·åº”ç”¨ç¨‹åºä¸­ï¼Œè€Œæ˜¯ä½œä¸ºç‹¬ç«‹è¿›ç¨‹éƒ¨ç½²åœ¨æ¯ä¸€ä¸ªä¸»æœºä¸Šï¼Œä¸€ä¸ªä¸»æœºä¸Šçš„å¤šä¸ªæ¶ˆè´¹è€…åº”ç”¨å¯ä»¥å…±ç”¨è¿™ä¸ªä»£ç†ï¼Œå®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚è¿™ä¸ªæ¨¡å¼ä¸€èˆ¬ä¹Ÿéœ€è¦ç‹¬ç«‹çš„æœåŠ¡æ³¨å†Œä¸­å¿ƒç»„ä»¶é…åˆï¼Œä½œç”¨åŒç¬¬äºŒä»£æ¶æ„ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/E7DE6B068DC74C7D8AE0808F46AB24AF.jpg" alt="image"></p><h4 id="ä¸‰ç§æ¶æ„çš„æ¯”è¾ƒ"><a href="#ä¸‰ç§æ¶æ„çš„æ¯”è¾ƒ" class="headerlink" title="ä¸‰ç§æ¶æ„çš„æ¯”è¾ƒ"></a>ä¸‰ç§æ¶æ„çš„æ¯”è¾ƒ</h4><table><thead><tr><th align="left"><strong>æ¨¡å¼</strong></th><th align="left"><strong>ä¼˜ç‚¹</strong></th><th align="left"><strong>ç¼ºç‚¹</strong></th><th align="left"><strong>é€‚åº”åœºæ™¯</strong></th><th align="left"><strong>æ¡ˆä¾‹</strong></th></tr></thead><tbody><tr><td align="left">é›†ä¸­å¼è´Ÿè½½æ¶æ„</td><td align="left">ç®€å•  é›†ä¸­å¼æ²»ç†  ä¸è¯­è¨€æ— å…³</td><td align="left">é…ç½®ç»´æŠ¤æˆæœ¬é«˜  å¤šäº†ä¸€å±‚IO  å•ç‚¹é—®é¢˜</td><td align="left">å¤§éƒ¨åˆ†å…¬å¸éƒ½é€‚ç”¨ï¼Œå¯¹è¿ç»´æœ‰è¦æ±‚</td><td align="left">äº¿è´ã€æºç¨‹ã€æ—©æœŸäº’è”ç½‘å…¬å¸</td></tr><tr><td align="left">å®¢æˆ·ç«¯åµŒå…¥å¼æ¶æ„</td><td align="left">æ— å•ç‚¹  æ€§èƒ½æ›´å¥½</td><td align="left">å®¢æˆ·ç«¯å¤æ‚  è¯­è¨€æ ˆè¦æ±‚</td><td align="left">ä¸­å¤§è§„æ¨¡å…¬å¸ã€è¯­è¨€æ ˆç»Ÿä¸€</td><td align="left">Dubbo    ã€  Twitter finagleã€  Spring Cloud Ribbon</td></tr><tr><td align="left">ç‹¬ç«‹è¿›ç¨‹ä»£ç†æ¶æ„</td><td align="left">æ— å•ç‚¹  æ€§èƒ½æ›´å¥½  ä¸è¯­è¨€æ— å…³</td><td align="left">è¿ç»´éƒ¨ç½²å¤æ‚  å¼€å‘è”è°ƒå¤æ‚</td><td align="left">ä¸­å¤§è§„æ¨¡å…¬å¸  å¯¹è¿ç»´æœ‰è¦æ±‚</td><td align="left">Smart Stack  Service Mesh</td></tr></tbody></table><h2 id="äºŒã€ä»€ä¹ˆæ˜¯-Dubbo"><a href="#äºŒã€ä»€ä¹ˆæ˜¯-Dubbo" class="headerlink" title="äºŒã€ä»€ä¹ˆæ˜¯ Dubbo"></a>äºŒã€ä»€ä¹ˆæ˜¯ Dubbo</h2><p>dubbo é˜¿é‡Œå¼€æºçš„ä¸€ä¸ª SOAï¼ˆé¢å‘æœåŠ¡çš„æ¶æ„ï¼‰ æœåŠ¡æ²»ç†æ¡†æ¶ï¼Œä»ç›®å‰æ¥çœ‹æŠŠå®ƒç§°ä½œæ˜¯ä¸€ä¸ªRPCè¿œç¨‹è°ƒç”¨æ¡†æ¶æ›´ä¸ºè´´åˆ‡ã€‚å•ä»RPCæ¡†æ¶æ¥è¯´ï¼ŒåŠŸèƒ½è¾ƒå®Œå–„ï¼Œæ”¯æŒå¤šç§ä¼ è¾“å’Œåºåˆ—åŒ–æ–¹æ¡ˆã€‚æ‰€ä»¥æƒ³å¿…å¤§å®¶å·²ç»çŸ¥é“ä»–çš„æ ¸å¿ƒåŠŸèƒ½äº†ï¼šå°±æ˜¯è¿œç¨‹è°ƒç”¨ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/81A705F26C0346EA871AB8936296BFE1.jpg" alt="image"></p><p><strong>æµç¨‹è¯´æ˜ï¼š</strong></p><ol><li>Provider(æä¾›è€…)ç»‘å®šæŒ‡å®šç«¯å£å¹¶å¯åŠ¨æœåŠ¡</li><li>æŒ‡ä¾›è€…è¿æ¥æ³¨å†Œä¸­å¿ƒï¼Œå¹¶å‘æœ¬æœºIPã€ç«¯å£ã€åº”ç”¨ä¿¡æ¯å’Œæä¾›æœåŠ¡ä¿¡æ¯å‘é€è‡³æ³¨å†Œä¸­å¿ƒå­˜å‚¨</li><li>Consumer(æ¶ˆè´¹è€…ï¼‰ï¼Œè¿æ¥æ³¨å†Œä¸­å¿ƒ ï¼Œå¹¶å‘é€åº”ç”¨ä¿¡æ¯ã€æ‰€æ±‚æœåŠ¡ä¿¡æ¯è‡³æ³¨å†Œä¸­å¿ƒ</li><li>æ³¨å†Œä¸­å¿ƒæ ¹æ® æ¶ˆè´¹ è€…æ‰€æ±‚æœåŠ¡ä¿¡æ¯åŒ¹é…å¯¹åº”çš„æä¾›è€…åˆ—è¡¨å‘é€è‡³Consumer åº”ç”¨ç¼“å­˜ã€‚</li><li>Consumer åœ¨å‘èµ·è¿œç¨‹è°ƒç”¨æ—¶åŸºäºç¼“å­˜çš„æ¶ˆè´¹è€…åˆ—è¡¨æ‹©å…¶ä¸€å‘èµ·è°ƒç”¨ã€‚</li><li>Provider çŠ¶æ€å˜æ›´ä¼šå®æ—¶é€šçŸ¥æ³¨å†Œä¸­å¿ƒã€åœ¨ç”±æ³¨å†Œä¸­å¿ƒå®æ—¶æ¨é€è‡³Consumer</li></ol><p><strong>è¿™ä¹ˆè®¾è®¡çš„æ„ä¹‰ï¼š</strong></p><ol><li>Consumer ä¸Provider è§£å¶ï¼ŒåŒæ–¹éƒ½å¯ä»¥æ¨ªå‘å¢å‡èŠ‚ç‚¹æ•°ã€‚</li><li>æ³¨å†Œä¸­å¿ƒå¯¹æœ¬èº«å¯åšå¯¹ç­‰é›†ç¾¤ï¼Œå¯åŠ¨æ€å¢å‡èŠ‚ç‚¹ï¼Œå¹¶ä¸”ä»»æ„ä¸€å°å®•æ‰åï¼Œå°†è‡ªåŠ¨åˆ‡æ¢åˆ°å¦ä¸€å°</li><li>å»ä¸­å¿ƒåŒ–ï¼ŒåŒæ–¹ä¸ç›´æ¥ä¾æ‡’æ³¨å†Œä¸­å¿ƒï¼Œå³ä½¿æ³¨å†Œä¸­å¿ƒå…¨éƒ¨å®•æœºçŸ­æ—¶é—´å†…ä¹Ÿä¸ä¼šå½±å“æœåŠ¡çš„è°ƒç”¨</li><li>æœåŠ¡æä¾›è€…æ— çŠ¶æ€ï¼Œä»»æ„ä¸€å°å®•æ‰åï¼Œä¸å½±å“ä½¿ç”¨</li></ol><p><strong>Dubbo è®¾è®¡å±‚çº§</strong></p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/60BD217B1ED345898A01578CF19291CB.jpg" alt="image"></p><ul><li>config <strong>é…ç½®å±‚</strong>ï¼šå¯¹å¤–é…ç½®æ¥å£ï¼Œä»¥Â ServiceConfig,Â ReferenceConfigÂ ä¸ºä¸­å¿ƒï¼Œå¯ä»¥ç›´æ¥åˆå§‹åŒ–é…ç½®ç±»ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ spring è§£æé…ç½®ç”Ÿæˆé…ç½®ç±»</li><li>proxy <strong>æœåŠ¡ä»£ç†å±‚</strong>ï¼šæœåŠ¡æ¥å£é€æ˜ä»£ç†ï¼Œç”ŸæˆåŠ¨æ€ä»£ç† æ‰©å±•æ¥å£ä¸ºÂ ProxyFactory</li><li>registry <strong>æ³¨å†Œä¸­å¿ƒå±‚</strong>ï¼šå°è£…æœåŠ¡åœ°å€çš„æ³¨å†Œä¸å‘ç°ï¼Œä»¥æœåŠ¡ URL ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸ºÂ RegistryFactory,Â Registry,Â RegistryService</li><li>cluster <strong>è·¯ç”±å±‚</strong>ï¼šå°è£…å¤šä¸ªæä¾›è€…çš„è·¯ç”±åŠè´Ÿè½½å‡è¡¡ï¼Œå¹¶æ¡¥æ¥æ³¨å†Œä¸­å¿ƒï¼Œä»¥Â InvokerÂ ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸ºÂ Cluster,Â Directory,Â Router,Â LoadBalance</li><li>monitor <strong>ç›‘æ§å±‚</strong>ï¼šRPC è°ƒç”¨æ¬¡æ•°å’Œè°ƒç”¨æ—¶é—´ç›‘æ§ï¼Œä»¥Â StatisticsÂ ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸ºÂ MonitorFactory,Â Monitor,Â MonitorService</li><li>protocol <strong>è¿œç¨‹è°ƒç”¨å±‚</strong>ï¼šå°è£… RPC è°ƒç”¨ï¼Œä»¥Â Invocation,Â ResultÂ ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸ºÂ Protocol,Â Invoker,Â Exporter</li><li>exchange <strong>ä¿¡æ¯äº¤æ¢å±‚</strong>ï¼šå°è£…è¯·æ±‚å“åº”æ¨¡å¼ï¼ŒåŒæ­¥è½¬å¼‚æ­¥ï¼Œä»¥Â Request,Â ResponseÂ ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸ºÂ Exchanger,Â ExchangeChannel,Â ExchangeClient,Â ExchangeServer</li><li>transport <strong>ç½‘ç»œä¼ è¾“å±‚</strong>ï¼šæŠ½è±¡ mina å’Œ netty ä¸ºç»Ÿä¸€æ¥å£ï¼Œä»¥Â MessageÂ ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸ºÂ Channel,Â Transporter,Â Client,Â Server,Â Codec</li><li>serialize <strong>æ•°æ®åºåˆ—åŒ–å±‚</strong>ï¼šå¯å¤ç”¨çš„ä¸€äº›å·¥å…·ï¼Œæ‰©å±•æ¥å£ä¸ºÂ Serialization,Â ObjectInput,Â ObjectOutput,Â ThreadPool</li></ul><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/7DC769031DD64DDABC42BDFBC7384599.jpg" alt="image"></p><h3 id="Dubbo-SPI-æœºåˆ¶"><a href="#Dubbo-SPI-æœºåˆ¶" class="headerlink" title="Dubbo SPI æœºåˆ¶"></a>Dubbo SPI æœºåˆ¶</h3><p>Java SPI çš„å…·ä½“çº¦å®šä¸º:å½“æœåŠ¡çš„æä¾›è€…ï¼Œæä¾›äº†æœåŠ¡æ¥å£çš„ä¸€ç§å®ç°ä¹‹åï¼Œåœ¨jaråŒ…çš„META-INF/services/ç›®å½•é‡ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªä»¥æœåŠ¡æ¥å£å‘½åçš„æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶é‡Œå°±æ˜¯å®ç°è¯¥æœåŠ¡æ¥å£çš„å…·ä½“å®ç°ç±»ã€‚è€Œå½“å¤–éƒ¨ç¨‹åºè£…é…è¿™ä¸ªæ¨¡å—çš„æ—¶å€™ï¼Œå°±èƒ½é€šè¿‡è¯¥jaråŒ…META-INF/services/é‡Œçš„é…ç½®æ–‡ä»¶æ‰¾åˆ°å…·ä½“çš„å®ç°ç±»åï¼Œå¹¶è£…è½½å®ä¾‹åŒ–ï¼Œå®Œæˆæ¨¡å—çš„æ³¨å…¥ã€‚ åŸºäºè¿™æ ·ä¸€ä¸ªçº¦å®šå°±èƒ½å¾ˆå¥½çš„æ‰¾åˆ°æœåŠ¡æ¥å£çš„å®ç°ç±»ï¼Œè€Œä¸éœ€è¦å†ä»£ç é‡Œåˆ¶å®šã€‚jdkæä¾›æœåŠ¡å®ç°æŸ¥æ‰¾çš„ä¸€ä¸ªå·¥å…·ç±»java.util.ServiceLoader</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/0723FDE7587148BAB47925D8471D652D.jpg" alt="image"></p><p>META-INF/services/xxx.dubbo.server.UserService ä¸­çš„å€¼ï¼š</p><pre><code>xxx.dubbo.server.impl.UserServiceImpl2</code></pre><p>è£…è½½è·å–SPIå®ç°ç±»ï¼š</p><pre><code>public static void main(String[] args) {Â Â Â  Iterator&lt;UserService&gt; services = ServiceLoader.load(UserService.class).iterator();Â Â Â  UserService service = null;Â Â Â  while (services.hasNext()) {Â Â Â Â Â Â Â  service = services.next();Â Â Â  }Â Â Â  System.out.println(service.getUser(111));}</code></pre><p>Dubbo SPI åœ¨JAVAè‡ªå¸¦çš„SPIåŸºç¡€ä¸ŠåŠ å…¥äº†æ‰©å±•ç‚¹çš„åŠŸèƒ½ï¼Œå³æ¯ä¸ªå®ç°ç±»éƒ½ä¼šå¯¹åº”è‡³ä¸€ä¸ªæ‰©å±•ç‚¹åç§°ï¼Œå…¶ç›®çš„æ˜¯ åº”ç”¨å¯åŸºäºæ­¤åç§°è¿›è¡Œç›¸åº”çš„è£…é…ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/B158D3A511A54EE0819951B33A188F0D.jpg" alt="image"><br>dubbo spi  æ–‡ä»¶å†…å®¹ï¼š</p><pre><code>luban=xxx.dubbo.server.LubanFilter</code></pre><p>è£…é…è‡ªå®šä¹‰Filter</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/17D1822AA2FB4427A92566F2E64917B7.jpg" alt="image"></p><p>æƒ³äº†è§£æ›´è¯¦ç»†ä¿¡æ¯ï¼š<br><a href="http://dubbo.apache.org/zh-cn/docs/source_code_guide/dubbo-spi.html">å®˜æ–¹æ–‡æ¡£</a></p><h2 id="ä¸‰ã€Dubboæ³¨å†Œä¸­å¿ƒè¯¦è§£"><a href="#ä¸‰ã€Dubboæ³¨å†Œä¸­å¿ƒè¯¦è§£" class="headerlink" title="ä¸‰ã€Dubboæ³¨å†Œä¸­å¿ƒè¯¦è§£"></a>ä¸‰ã€Dubboæ³¨å†Œä¸­å¿ƒè¯¦è§£</h2><h3 id="æ³¨å†Œä¸­å¿ƒçš„ä½œç”¨"><a href="#æ³¨å†Œä¸­å¿ƒçš„ä½œç”¨" class="headerlink" title="æ³¨å†Œä¸­å¿ƒçš„ä½œç”¨"></a>æ³¨å†Œä¸­å¿ƒçš„ä½œç”¨</h3><p>ä¸ºäº†åˆ°è¾¾æœåŠ¡é›†ç¾¤åŠ¨æ€æ‰©å®¹çš„ç›®çš„ï¼Œæ³¨å†Œä¸­å¿ƒå­˜å‚¨äº†æœåŠ¡çš„åœ°å€ä¿¡æ¯ä¸å¯ç”¨çŠ¶æ€ä¿¡æ¯ï¼Œå¹¶å®æ—¶æ¨é€ç»™è®¢é˜…äº†ç›¸å…³æœåŠ¡çš„å®¢æˆ·ç«¯ã€‚<br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/8638BBF57BF946769ABFCE0DAF896809.jpg" alt="image"></p><p><strong>ä¸€ä¸ªå®Œæ•´çš„æ³¨å†Œä¸­å¿ƒéœ€è¦å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š</strong></p><ol><li>æ¥æ”¶æœåŠ¡ç«¯çš„æ³¨å†Œä¸å®¢æˆ·ç«¯çš„å¼•ç”¨ï¼Œå³å°†å¼•ç”¨ä¸æ¶ˆè´¹å»ºç«‹å…³è”ï¼Œå¹¶æ”¯æŒå¤šå¯¹å¤šã€‚</li><li>å½“æœåŠ¡éæ­£å¸¸å…³é—­æ—¶èƒ½å³æ—¶æ¸…é™¤å…¶çŠ¶æ€</li><li>å½“æ³¨å†Œä¸­å¿ƒé‡å¯æ—¶ï¼Œèƒ½è‡ªåŠ¨æ¢å¤æ³¨å†Œæ•°æ®ï¼Œä»¥åŠè®¢é˜…è¯·æ±‚</li><li>æ³¨å†Œä¸­å¿ƒæœ¬èº«çš„é›†ç¾¤ ã€‚</li></ol><h3 id="Dubboæ‰€æ”¯æŒçš„æ³¨å†Œä¸­å¿ƒ"><a href="#Dubboæ‰€æ”¯æŒçš„æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="Dubboæ‰€æ”¯æŒçš„æ³¨å†Œä¸­å¿ƒ"></a>Dubboæ‰€æ”¯æŒçš„æ³¨å†Œä¸­å¿ƒ</h3><ol><li><strong>Multicast æ³¨å†Œä¸­å¿ƒ</strong><ol><li>åŸºäºç»„ç½‘å¹¿æ’­æŠ€æœ¯ï¼Œåªèƒ½ç”¨åœ¨å±€åŸŸç½‘å†…ï¼Œä¸€èˆ¬ç”¨äºç®€å•çš„æµ‹è¯•æœåŠ¡</li></ol></li><li><strong>Zookeeper æ³¨å†Œä¸­å¿ƒ(**</strong>æ¨è**<strong>)</strong><ol><li><a href="http://zookeeper.apache.org/">Zookeeper</a>Â æ˜¯ Apacahe Hadoop çš„å­é¡¹ç›®ï¼Œæ˜¯ä¸€ä¸ªæ ‘å‹çš„ç›®å½•æœåŠ¡ï¼Œæ”¯æŒå˜æ›´æ¨é€ï¼Œé€‚åˆä½œä¸º Dubbo æœåŠ¡çš„æ³¨å†Œä¸­å¿ƒï¼Œå·¥ä¸šå¼ºåº¦è¾ƒé«˜ï¼Œå¯ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œå¹¶æ¨èä½¿ç”¨</li></ol></li><li><strong>Redis æ³¨å†Œä¸­å¿ƒ</strong><ol><li>åŸºäºRedisçš„æ³¨å†Œä¸­å¿ƒ</li></ol></li><li><strong>Simple æ³¨å†Œä¸­å¿ƒ</strong><ol><li>åŸºäºæœ¬èº«çš„DubboæœåŠ¡å®ç°ï¼ˆSimpleRegistryServiceï¼‰ï¼Œä¸æ”¯æŒé›†ç¾¤å¯ä½œä¸ºè‡ªå®šä¹‰æ³¨å†Œä¸­å¿ƒçš„å‚è€ƒï¼Œä½†ä¸é€‚åˆç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚Â </li></ol></li></ol><h3 id="Redis-æ³¨å†Œä¸­å¿ƒ"><a href="#Redis-æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="Redis æ³¨å†Œä¸­å¿ƒ"></a><strong>Redis æ³¨å†Œä¸­å¿ƒ</strong></h3><p>å…³äºRedisæ³¨å†Œä¸­å¿ƒæˆ‘ä»¬éœ€è¦äº†è§£ä¸¤ç‚¹ï¼Œ</p><h4 id="1-å¦‚ä½•å­˜å‚¨æœåŠ¡çš„æ³¨å†Œä¸è®¢é˜…å…³ç³»"><a href="#1-å¦‚ä½•å­˜å‚¨æœåŠ¡çš„æ³¨å†Œä¸è®¢é˜…å…³ç³»" class="headerlink" title="1. å¦‚ä½•å­˜å‚¨æœåŠ¡çš„æ³¨å†Œä¸è®¢é˜…å…³ç³»"></a>1. å¦‚ä½•å­˜å‚¨æœåŠ¡çš„æ³¨å†Œä¸è®¢é˜…å…³ç³»</h4><p>redis æ³¨å†Œä¸­å¿ƒé…ç½®</p><pre><code>&lt;dubbo:registry protocol=&quot;redis&quot; address=&quot;192.168.0.147:6379&quot;/&gt;</code></pre><p>å½“æˆ‘ä»¬å¯åŠ¨ä¸¤ä¸ªæœåŠ¡ç«¯åå‘ç°ï¼ŒReidsä¸­å¢åŠ äº†ä¸€ä¸ªHash ç±»å‹çš„è®°å½•ï¼Œå…¶keyä¸º/dubbo/xxx.dubbo.server.UserService/providersã€‚Valueä¸­åˆ†åˆ«å­˜å‚¨äº†ä¸¤ä¸ªæœåŠ¡æä¾›è€…çš„URLå’Œæœ‰æ•ˆæœŸã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/89233BE1BB03402C9224A6348FAA7007.jpg" alt="image"></p><p><strong>åŒæ ·æ¶ˆè´¹è€…ä¹Ÿæ˜¯ç±»ä¼¼å…¶æ•´ä½“ç»“æ„å¦‚ä¸‹ï¼š</strong></p><pre><code>//æœåŠ¡æä¾›è€…æ³¨å†Œä¿¡æ¯ /dubbbo/com.xxx.teach.service.DemoService/providers  dubbo://192.168.246.1:20880/XXX.DemoService=1542619052964   dubbo://192.168.246.2:20880/XXX.DemoService=1542619052964 //æœåŠ¡æ¶ˆè´¹è®¢é˜…ä¿¡æ¯/dubbbo/com.xxx.teach.service.DemoService/consumers  dubbo://192.168.246.1:20880/XXX.DemoService=1542619788641</code></pre><ul><li>ä¸» Key ä¸ºæœåŠ¡åå’Œç±»å‹</li><li>Map ä¸­çš„ Key ä¸º URL åœ°å€</li><li>Map ä¸­çš„ Value ä¸ºè¿‡æœŸæ—¶é—´ï¼Œç”¨äºåˆ¤æ–­è„æ•°æ®ï¼Œè„æ•°æ®ç”±ç›‘æ§ä¸­å¿ƒåˆ é™¤</li></ul><h4 id="2-æ˜¯å½“æœåŠ¡çŠ¶æ€æ”¹å˜æ—¶å¦‚ä½•å³æ—¶æ›´æ–°ï¼Ÿ"><a href="#2-æ˜¯å½“æœåŠ¡çŠ¶æ€æ”¹å˜æ—¶å¦‚ä½•å³æ—¶æ›´æ–°ï¼Ÿ" class="headerlink" title="2. æ˜¯å½“æœåŠ¡çŠ¶æ€æ”¹å˜æ—¶å¦‚ä½•å³æ—¶æ›´æ–°ï¼Ÿ"></a>2. æ˜¯å½“æœåŠ¡çŠ¶æ€æ”¹å˜æ—¶å¦‚ä½•å³æ—¶æ›´æ–°ï¼Ÿ</h4><p>ç¬¬äºŒä¸ªé—®é¢˜ <strong>å½“æä¾›è€…çªç„¶ å®•æœºçŠ¶æ€èƒ½å³é‡Œå˜æ›´å—</strong>ï¼Ÿ<br>è¿™é‡ŒDubboé‡‡ç”¨çš„æ˜¯<strong>å®šæ—¶å¿ƒè·³çš„æœºåˆ¶</strong> æ¥ç»´æŠ¤æœåŠ¡URLçš„æœ‰æ•ˆæœŸï¼Œé»˜è®¤<strong>æ¯30ç§’æ›´æ–°ä¸€æ¬¡æœ‰æ•ˆæœŸ</strong>ã€‚å³URLå¯¹åº”çš„æ¯«ç§’å€¼ã€‚å…·ä½“ä»£ç å‚è§ï¼šcom.alibaba.dubbo.registry.redis.RedisRegistry#expireExecutor</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/F32248B7D113492EBC48590051A3CD04.jpg" alt="image"></p><p>com.alibaba.dubbo.registry.redis.RedisRegistry#deferExpired<br>com.alibaba.dubbo.registry.integration.RegistryDirectory<br>com.alibaba.dubbo.registry.support.ProviderConsumerRegTable</p><h3 id="Zookeeper-æ³¨å†Œä¸­å¿ƒ"><a href="#Zookeeper-æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="Zookeeper æ³¨å†Œä¸­å¿ƒ"></a><strong>Zookeeper æ³¨å†Œä¸­å¿ƒ</strong></h3><p>å…³äºZookeeper æ³¨å†Œä¸­å¿ƒåŒæ ·éœ€è¦äº†è§£å…¶å­˜å‚¨ç»“æ„å’Œæ›´æ–°æœºåˆ¶ã€‚<br>Zookeperæ˜¯ä¸€ä¸ªæ ‘å‹çš„ç›®å½•æœåŠ¡ï¼Œæœ¬èº«æ”¯æŒå˜æ›´æ¨é€ç›¸æ¯” redis çš„å®ç° Publish/Subscribe åŠŸèƒ½æ›´ç¨³å®šã€‚</p><ol><li>Providerå’ŒConsumerå‘Zookeeperæ³¨å†Œä¸´æ—¶èŠ‚ç‚¹ï¼Œå½“è¿æ¥æ–­å¼€æ—¶åˆ é™¤ç›¸åº”çš„æ³¨å†ŒèŠ‚ç‚¹ã€‚</li><li>Consumerè®¢é˜… ProvidersèŠ‚ç‚¹çš„å­èŠ‚ç‚¹ï¼Œé€šè¿‡ watch äº‹ä»¶ï¼Œå½“ Zookeeper åˆ é™¤ä¸´æ—¶èŠ‚ç‚¹æ—¶ï¼Œå®æ—¶æ„ŸçŸ¥ Provider çš„å˜åŒ–æƒ…å†µï¼Œå®æ—¶åŒæ­¥è‡ªèº«çš„Invokerå¯¹è±¡ï¼Œä¿è¯ RPCçš„å¯ç”¨æ€§ã€‚</li></ol><p>ç»“æ„ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/D8B581F4BF944E94AF6382ECA1CB770F.jpg" alt="image"></p><h4 id="æºç æŸ¥çœ‹"><a href="#æºç æŸ¥çœ‹" class="headerlink" title="æºç æŸ¥çœ‹"></a>æºç æŸ¥çœ‹</h4><pre class="line-numbers language-java"><code class="language-java"> <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doRegister</span><span class="token punctuation">(</span>URL url<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            zkClient<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">toUrlPath</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>DYNAMIC_KEY<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">"Failed to register "</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">" to zookeeper "</span> <span class="token operator">+</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">create</span><span class="token punctuation">(</span>String path<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ephemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ephemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkExists</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æŠŠå‰é¢çš„å…ˆåˆ›å»ºå¥½   dubbo/com.xx.xx/providers</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// åˆ›å»ºæŒä¹…èŠ‚ç‚¹</span>            <span class="token function">create</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ephemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹,node èŠ‚ç‚¹ï¼ˆä¿å­˜å…·ä½“åœ°å€ï¼‰ã€‚</span>            <span class="token function">createEphemeral</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// åˆ›å»ºæŒä¹…èŠ‚ç‚¹</span>            <span class="token function">createPersistent</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>å¤±è´¥é‡è¿ï¼š</strong><br>com.alibaba.dubbo.registry.support.FailbackRegistry</p><p><strong>æä¾›è€…çªç„¶æ–­å¼€ï¼š</strong><br>å­˜å‚¨åŸºäºZookeeper ä¸´æ—¶èŠ‚ç‚¹æœºåˆ¶å®ç°ï¼Œåœ¨å®¢æˆ·ç«¯ä¼šè¯è¶…æ—¶åï¼ˆé»˜è®¤ä¸º40ç§’ï¼‰ Zookeeper ä¼šè‡ªåŠ¨åˆ é™¤æ‰€æœ‰ä¸´æ—¶èŠ‚ç‚¹ã€‚ </p><pre><code>// åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹com.alibaba.dubbo.remoting.zookeeper.curator.CuratorZookeeperClient#createEphemeral</code></pre><p><strong>åœ¨ zookeeper æ–­å¼€çš„40ç§’å†… å¦‚æœ æœ‰å®¢æˆ·ç«¯åŠ å…¥ ä¼šè°ƒç”¨ å·²å¤±æ•ˆçš„æä¾›è€…è¿æ¥å—ï¼Ÿ</strong></p><blockquote><p>ç­”ï¼šä¸ä¼šï¼Œæä¾›è€…å®•æœºå ï¼Œå…¶ä¸å®¢æˆ·ç«¯çš„é“¾æ¥ä¹Ÿéšå³æ–­å¼€ï¼Œå®¢æˆ·ç«¯åœ¨è°ƒç”¨å‰ä¼šæ£€æµ‹é•¿è¿æ¥æ˜¯å¦å¯ç”¨çŠ¶æ€çš„æ–¹æ³•ã€‚</p><pre><code>// æ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆ com.alibaba.dubbo.rpc.protocol.dubbo.DubboInvoker#isAvailable</code></pre></blockquote><p>åˆ›å»º configuratorsä¸ routers  ä¼šé€šè¿‡ <strong>æŒä¹…èŠ‚ç‚¹</strong>æ¥åˆ›å»º, æ¯”å¦‚ï¼šâ€œdubbo/com.xx.xx/providersâ€</p><pre><code>com.alibaba.dubbo.remoting.zookeeper.curator.CuratorZookeeperClient#createPersistent</code></pre><p><strong>æœåŠ¡è®¢é˜…æœºåˆ¶å®ç°ï¼š</strong></p><pre><code>// æ³¨å†Œç›®å½•com.alibaba.dubbo.registry.integration.RegistryDirectory</code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/7903EF7E728C436EBABA5AB637CB1588.jpg" alt="image"></p><h2 id="ä¸‰ã€-Dubbo-è°ƒç”¨æ¨¡å—"><a href="#ä¸‰ã€-Dubbo-è°ƒç”¨æ¨¡å—" class="headerlink" title="ä¸‰ã€ Dubbo è°ƒç”¨æ¨¡å—"></a>ä¸‰ã€ Dubbo è°ƒç”¨æ¨¡å—</h2><p>dubboè°ƒç”¨æ¨¡å—æ ¸å¿ƒåŠŸèƒ½æ˜¯å‘èµ·ä¸€ä¸ªè¿œç¨‹æ–¹æ³•çš„è°ƒç”¨å¹¶é¡ºåˆ©æ‹¿åˆ°è¿”å›ç»“æœï¼Œå…¶ä½“ç³»ç»„æˆå¦‚ä¸‹ï¼š</p><ol><li><strong>é€æ˜ä»£ç†ï¼š</strong> é€šè¿‡åŠ¨æ€ä»£ç†æŠ€æœ¯ï¼Œå±è”½è¿œç¨‹è°ƒç”¨ç»†èŠ‚ä»¥æé«˜ç¼–ç¨‹å‹å¥½æ€§ã€‚</li><li><strong>è´Ÿè½½å‡è¡¡ï¼š</strong> å½“æœ‰å¤šä¸ªæä¾›è€…æ˜¯ï¼Œå¦‚ä½•é€‰æ‹©å“ªä¸ªè¿›è¡Œè°ƒç”¨çš„è´Ÿè½½ç®—æ³•ã€‚</li><li><strong>å®¹é”™æœºåˆ¶ï¼š</strong> å½“æœåŠ¡è°ƒç”¨å¤±è´¥æ—¶é‡‡å–çš„ç­–ç•¥</li><li><strong>è°ƒç”¨æ–¹å¼ï¼š</strong> æ”¯æŒåŒæ­¥è°ƒç”¨ã€å¼‚æ­¥è°ƒç”¨</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/C29CEB5BE9E4479EA5988A07FC429C28.jpg" alt="image"></p><h3 id="é€æ˜ä»£ç†ï¼š"><a href="#é€æ˜ä»£ç†ï¼š" class="headerlink" title="é€æ˜ä»£ç†ï¼š"></a>é€æ˜ä»£ç†ï¼š</h3><p>é’ˆå¯¹ä»£ç† dubbo æä¾› ä¸‰ç§æ–¹å¼ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/BCE9E2B8BB9F4E1DBE9E0249FCE1D4C7.jpg" alt="image"></p><p>é»˜è®¤æ–¹å¼æ˜¯ï¼š</p><pre><code>    public static final String DEFAULT_PROXY = &quot;javassist&quot;;</code></pre><p>è°ƒç”¨é“¾å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">></span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ReferenceConfig#createProxy<span class="token operator">--</span><span class="token operator">></span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>javassist<span class="token punctuation">.</span>JavassistProxyFactory<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">></span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span>bytecode<span class="token punctuation">.</span>Proxy#<span class="token function">getProxy</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ClassLoader<span class="token punctuation">,</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">></span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>common<span class="token punctuation">.</span>bytecode<span class="token punctuation">.</span>ClassGenerator#<span class="token function">newInstance</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ClassLoader<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/2835D117E1FE424F84ED8907FC986A2B.jpg" alt="image"></p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/5B1BA7C374ED444DAFD557DF5055D4D9.jpg" alt="image"></p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/B8DCD49FB51847ED97BBA2C316A5BCDF.jpg" alt="image"></p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/E7EF7C875FBD48A4B2037B3A74D5BC62.jpg" alt="image"></p><h3 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a><strong>è´Ÿè½½å‡è¡¡</strong></h3><p>Dubbo ç›®å‰å®˜æ–¹æ”¯æŒä»¥ä¸‹è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š</p><ol><li><strong>éšæœº</strong>(random)ï¼šæŒ‰æƒé‡è®¾ç½®éšæœºæ¦‚ç‡ã€‚æ­¤ä¸ºé»˜è®¤ç®—æ³•.</li><li><strong>è½®å¾ª</strong>(roundrobin):æŒ‰å…¬çº¦åçš„æƒé‡è®¾ç½®è½®å¾ªæ¯”ç‡ã€‚</li><li><strong>æœ€å°‘æ´»è·ƒè°ƒç”¨æ•°</strong>(leastactive):ç›¸åŒæ´»è·ƒæ•°çš„éšæœºï¼Œæ´»è·ƒæ•°æŒ‡è°ƒç”¨å‰åè®¡æ•°å·®ã€‚</li><li><strong>ä¸€è‡´æ€§Hash</strong>(consistenthash ):ç›¸åŒçš„å‚æ•°æ€»æ˜¯å‘åˆ°åŒä¸€å°æœºå™¨</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/EDE99CF742414CB5921E56E2BD341282.jpg" alt="image"><br>è®¾ç½®æ–¹å¼æ”¯æŒå¦‚ä¸‹å››ç§æ–¹å¼è®¾ç½®ï¼Œä¼˜å…ˆçº§ç”±ä½è‡³é«˜</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- æœåŠ¡ç«¯çº§åˆ«--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>service</span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span> <span class="token attr-name">loadbalance</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roundrobin<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token comment" spellcheck="true">&lt;!-- å®¢æˆ·ç«¯çº§åˆ«--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span> <span class="token attr-name">loadbalance</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roundrobin<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token comment" spellcheck="true">&lt;!-- æœåŠ¡ç«¯æ–¹æ³•çº§åˆ«--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>service</span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span> <span class="token attr-name">loadbalance</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roundrobin<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">dubbo:</span>service</span><span class="token punctuation">></span></span><span class="token comment" spellcheck="true">&lt;!-- å®¢æˆ·ç«¯æ–¹æ³•çº§åˆ«--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span> <span class="token attr-name">loadbalance</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>roundrobin<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">dubbo:</span>reference</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®¹é”™"><a href="#å®¹é”™" class="headerlink" title="å®¹é”™"></a><strong>å®¹é”™</strong></h3><p>Dubbo å®˜æ–¹ç›®å‰æ”¯æŒä»¥ä¸‹å®¹é”™ç­–ç•¥ï¼š</p><ol><li><strong>å¤±è´¥è‡ªåŠ¨åˆ‡æ¢ï¼š</strong> è°ƒç”¨å¤±è´¥ååŸºäºretries=â€œ2â€ å±æ€§é‡è¯•å…¶å®ƒæœåŠ¡å™¨</li><li><strong>å¿«é€Ÿå¤±è´¥ï¼š</strong> å¿«é€Ÿå¤±è´¥ï¼Œåªå‘èµ·ä¸€æ¬¡è°ƒç”¨ï¼Œå¤±è´¥ç«‹å³æŠ¥é”™ã€‚</li><li><strong>å‹¿ç•¥å¤±è´¥ï¼š</strong> å¤±è´¥åå‹¿ç•¥ï¼Œä¸æŠ›å‡ºå¼‚å¸¸ç»™å®¢æˆ·ç«¯ã€‚</li><li><strong>å¤±è´¥é‡è¯•ï¼š</strong> å¤±è´¥è‡ªåŠ¨æ¢å¤ï¼Œåå°è®°å½•å¤±è´¥è¯·æ±‚ï¼Œå®šæ—¶é‡å‘ã€‚é€šå¸¸ç”¨äºæ¶ˆæ¯é€šçŸ¥æ“ä½œ</li><li><strong>å¹¶è¡Œè°ƒç”¨:</strong> åªè¦ä¸€ä¸ªæˆåŠŸå³è¿”å›ï¼Œå¹¶è¡Œè°ƒç”¨æŒ‡å®šæ•°é‡æœºå™¨ï¼Œå¯é€šè¿‡ forks=â€2â€ æ¥è®¾ç½®æœ€å¤§å¹¶è¡Œæ•°ã€‚</li><li><strong>å¹¿æ’­è°ƒç”¨ï¼š</strong> å¹¿æ’­è°ƒç”¨æ‰€æœ‰æä¾›è€…ï¼Œé€ä¸ªè°ƒç”¨ï¼Œä»»æ„ä¸€å°æŠ¥é”™åˆ™æŠ¥é”™</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/CD04A0766E944919A0D62EBFE9F964C6.jpg" alt="image"><br>è®¾ç½®æ–¹å¼æ”¯æŒå¦‚ä¸‹ä¸¤ç§æ–¹å¼è®¾ç½®ï¼Œä¼˜å…ˆçº§ç”±ä½è‡³é«˜</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>Failover å¤±è´¥è‡ªåŠ¨åˆ‡æ¢ retries<span class="token operator">=</span><span class="token string">"1"</span> åˆ‡æ¢æ¬¡æ•°Failfast å¿«é€Ÿå¤±è´¥Failsafe å‹¿ç•¥å¤±è´¥Failback å¤±è´¥é‡è¯•ï¼Œ<span class="token number">5</span>ç§’åä»…é‡è¯•ä¸€æ¬¡Forking å¹¶è¡Œè°ƒç”¨ forks<span class="token operator">=</span><span class="token string">"2"</span> æœ€å¤§å¹¶è¡Œæ•°Broadcast å¹¿æ’­è°ƒç”¨<span class="token operator">--</span><span class="token operator">></span><span class="token operator">&lt;</span>dubbo<span class="token operator">:</span>service <span class="token keyword">interface</span><span class="token operator">=</span><span class="token string">"..."</span> cluster<span class="token operator">=</span><span class="token string">"broadcast"</span> <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span>dubbo<span class="token operator">:</span>reference <span class="token keyword">interface</span><span class="token operator">=</span><span class="token string">"..."</span> cluster<span class="token operator">=</span><span class="token string">"broadcast"</span><span class="token operator">/</span> <span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨ï¼šå®¹é”™æœºåˆ¶ åœ¨åŸºäº APIè®¾ç½®æ—¶æ— æ•ˆ å¦‚  referenceConfig.setCluster(â€œfailbackâ€); ç»æµ‹è¯•ä¸å¯ä½œç”¨ </p><h3 id="å¼‚æ­¥è°ƒç”¨"><a href="#å¼‚æ­¥è°ƒç”¨" class="headerlink" title="å¼‚æ­¥è°ƒç”¨"></a><strong>å¼‚æ­¥è°ƒç”¨</strong></h3><p>å¼‚æ­¥è°ƒç”¨æ˜¯æŒ‡å‘èµ·è¿œç¨‹è°ƒç”¨ä¹‹åè·å–ç»“æœçš„æ–¹å¼ã€‚</p><ol><li>åŒæ­¥ç­‰å¾…ç»“æœè¿”å›ï¼ˆé»˜è®¤ï¼‰</li><li>å¼‚æ­¥ç­‰å¾…ç»“æœè¿”å›</li><li>ä¸éœ€è¦è¿”å›ç»“æœ</li></ol><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/F1C320C5A219405B8EFC66F1FE4CC78B.jpg" alt="image"></p><p>å¼‚æ­¥è°ƒç”¨é…ç½®:</p><pre><code>&lt;dubbo:reference id=&quot;asyncDemoService&quot;    interface=&quot;com.xxx.teach.service.async.AsyncDemoService&quot;&gt;   &lt;!-- å¼‚æ­¥è°ƒasyncï¼štrue å¼‚æ­¥è°ƒç”¨ false åŒæ­¥è°ƒç”¨--&gt;   &lt;dubbo:method name=&quot;sayHello1&quot; async=&quot;false&quot;/&gt;   &lt;dubbo:method name=&quot;sayHello2&quot; async=&quot;false&quot;/&gt;   &lt;dubbo:method name=&quot;notReturn&quot; return=&quot;false&quot;/&gt;&lt;/dubbo:reference&gt;</code></pre><p>æ³¨ï¼šåœ¨è¿›è¡Œå¼‚æ­¥è°ƒç”¨æ—¶ å®¹é”™æœºåˆ¶ä¸èƒ½ä¸º  cluster=â€forkingâ€ æˆ–  cluster=â€broadcastâ€</p><p><em>å¼‚æ­¥è°ƒç”¨ç»“æœè·å–Demo</em></p><pre class="line-numbers language-java"><code class="language-java">demoService<span class="token punctuation">.</span><span class="token function">sayHello1</span><span class="token punctuation">(</span><span class="token string">"han"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Future<span class="token operator">&lt;</span>Object<span class="token operator">></span> future1 <span class="token operator">=</span> RpcContext<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>demoService<span class="token punctuation">.</span><span class="token function">sayHello2</span><span class="token punctuation">(</span><span class="token string">"han2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Future<span class="token operator">&lt;</span>Object<span class="token operator">></span> future2 <span class="token operator">=</span> RpcContext<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Object r1 <span class="token operator">=</span> null<span class="token punctuation">,</span> r2 <span class="token operator">=</span> null<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// wait ç›´åˆ°æ‹¿åˆ°ç»“æœ æˆ–è¶…æ—¶</span>r1 <span class="token operator">=</span> future1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// wait ç›´åˆ°æ‹¿åˆ°ç»“æœ æˆ–è¶…æ—¶</span>r2 <span class="token operator">=</span> future2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="è¿‡æ»¤å™¨"><a href="#è¿‡æ»¤å™¨" class="headerlink" title="è¿‡æ»¤å™¨"></a><strong>è¿‡æ»¤å™¨</strong></h3><p>** ç±»ä¼¼äº WEB ä¸­çš„Filter ï¼ŒDubboæœ¬èº«æä¾›äº†Filter åŠŸèƒ½ç”¨äºæ‹¦æˆªè¿œç¨‹æ–¹æ³•çš„è°ƒç”¨ã€‚å…¶æ”¯æŒè‡ªå®šä¹‰è¿‡æ»¤å™¨ä¸å®˜æ–¹çš„è¿‡æ»¤å™¨ä½¿ç”¨ï¼š**<br>#TODO æ¼”ç¤ºæ·»åŠ æ—¥å¿—è®¿é—®è¿‡æ»¤:</p><pre><code>&lt;dubbo:provider  filter=&quot;accesslog&quot; accesslog=&quot;logs/dubbo.log&quot;/&gt;</code></pre><p>ä»¥ä¸Šé…ç½® å°±æ˜¯ ä¸º æœåŠ¡æä¾›è€… æ·»åŠ  æ—¥å¿—è®°å½•è¿‡æ»¤å™¨ï¼Œ æ‰€æœ‰è®¿é—®æ—¥å¿—å°†ä¼šé›†ä¸­æ‰“å°è‡³ accesslog å½“ä¸­ã€‚</p><h2 id="è°ƒç”¨é€šä¿¡-å†…éƒ¨å®ç°åŸç†"><a href="#è°ƒç”¨é€šä¿¡-å†…éƒ¨å®ç°åŸç†" class="headerlink" title="è°ƒç”¨é€šä¿¡  å†…éƒ¨å®ç°åŸç†"></a>è°ƒç”¨é€šä¿¡  å†…éƒ¨å®ç°åŸç†</h2><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/17E56F436154424BA5E8AAC97BD84B13.jpg" alt="image"></p><p><strong>IOæ¨¡å‹ï¼š</strong></p><ol><li>BIO åŒæ­¥é˜»å¡</li><li>NIO åŒæ­¥éé˜»å¡</li><li>AIO å¼‚æ­¥éé˜»å¡</li></ol><p><strong>è¿æ¥æ¨¡å‹ï¼š</strong></p><ol><li>é•¿è¿æ¥</li><li>çŸ­è¿æ¥</li></ol><p><strong>çº¿ç¨‹åˆ†ç±»ï¼š</strong></p><ol><li>IOçº¿ç¨‹</li><li>æœåŠ¡ç«¯ä¸šåŠ¡çº¿ç¨‹</li><li>å®¢æˆ·ç«¯è°ƒåº¦çº¿ç¨‹</li><li>å®¢æˆ·ç«¯ç»“æœexchangeçº¿ç¨‹ã€‚</li><li>ä¿æ´»å¿ƒè·³çº¿ç¨‹</li><li>é‡è¿çº¿ç¨‹</li></ol><p><strong>çº¿ç¨‹æ± æ¨¡å‹ï¼š</strong></p><ol><li>å›ºå®šæ•°é‡çº¿ç¨‹æ± </li><li>ç¼“å­˜çº¿ç¨‹æ± </li><li>æœ‰é™çº¿ç¨‹æ± </li></ol><h3 id="Dubbo-é•¿è¿æ¥å®ç°ä¸é…ç½®"><a href="#Dubbo-é•¿è¿æ¥å®ç°ä¸é…ç½®" class="headerlink" title="Dubbo é•¿è¿æ¥å®ç°ä¸é…ç½®"></a><strong>Dubbo é•¿è¿æ¥å®ç°ä¸é…ç½®</strong></h3><p><strong>åˆå§‹è¿æ¥ï¼š</strong></p><p>å¼•ç”¨æœåŠ¡å¢åŠ æä¾›è€… â€”&gt; è·å–è¿æ¥ â€“&gt; æ˜¯å¦è·å–å…±äº«è¿æ¥ â€“&gt;åˆ›å»ºè¿æ¥å®¢æˆ·ç«¯â€“&gt;å¼€å¯å¿ƒè·³æ£€æµ‹çŠ¶æ€æ£€æŸ¥å®šæ—¶ä»»åŠ¡â€“&gt; å¼€å¯è¿æ¥çŠ¶æ€æ£€æµ‹.</p><blockquote><p>com.alibaba.dubbo.rpc.protocol.dubbo.DubboProtocol#getClients</p></blockquote><p><strong>å¿ƒè·³å‘é€ï¼š</strong><br>åœ¨åˆ›å»ºä¸€ä¸ªè¿æ¥å®¢æˆ·ç«¯åŒæ—¶ä¹Ÿä¼šåˆ›å»ºä¸€ä¸ªå¿ƒè·³å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯é»˜è®¤åŸºäº60ç§’å‘é€ä¸€æ¬¡å¿ƒè·³æ¥ä¿æŒè¿æ¥çš„å­˜æ´»ï¼Œå¯é€šè¿‡ heartbeat è®¾ç½®ã€‚</p><blockquote><p>com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeClient#startHeatbeatTimer</p></blockquote><p><strong>æ–­çº¿é‡è¿ï¼š</strong><br>æ¯åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥éƒ½ä¼šå¯åŠ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ¯ä¸¤ç§’ä¸­æ£€æµ‹ä¸€æ¬¡å½“å‰è¿æ¥çŠ¶æ€ï¼Œå¦‚æœæ–­çº¿åˆ™è‡ªåŠ¨é‡è¿ã€‚</p><blockquote><p>com.alibaba.dubbo.remoting.transport.AbstractClient#initConnectStatusCheckCommand</p></blockquote><p><strong>è¿æ¥é”€æ¯:</strong><br>åŸºäºæ³¨å†Œä¸­å¿ƒé€šçŸ¥ï¼ŒæœåŠ¡ç«¯æ–­å¼€åé”€æ¯</p><blockquote><p>com.alibaba.dubbo.remoting.transport.AbstractClient#close()</p></blockquote><h3 id="Dubbo-ä¼ è¾“åä½œçº¿ç¨‹"><a href="#Dubbo-ä¼ è¾“åä½œçº¿ç¨‹" class="headerlink" title="Dubbo ä¼ è¾“åä½œçº¿ç¨‹"></a><strong>Dubbo ä¼ è¾“åä½œçº¿ç¨‹</strong></h3><ol><li><strong>å®¢æˆ·ç«¯è°ƒåº¦çº¿ç¨‹</strong>ï¼šç”¨äºå‘èµ·è¿œç¨‹æ–¹æ³•è°ƒç”¨çš„çº¿ç¨‹ã€‚</li><li><strong>å®¢æˆ·ç«¯ç»“æœExchangeçº¿ç¨‹ï¼š</strong> å½“è¿œç¨‹æ–¹æ³•è¿”å›responseåç”±è¯¥çº¿ç¨‹å¡«å……è‡³æŒ‡å®šResponseFutureï¼Œå¹¶å«é†’ç­‰å¾…çš„è°ƒåº¦çº¿ç¨‹ã€‚</li><li><strong>å®¢æˆ·ç«¯IOçº¿ç¨‹</strong> ç”±ä¼ è¾“æ¡†æ¶å®ç°ï¼Œç”¨äºrequest æ¶ˆæ¯æµå‘é€ã€response æ¶ˆæ¯æµè¯»å–ä¸è§£ç ç­‰æ“ä½œã€‚</li><li><strong>æœåŠ¡ç«¯IOçº¿ç¨‹</strong>ï¼šç”±ä¼ è¾“æ¡†æ¶å®ç°ï¼Œç”¨äºrequestæ¶ˆæ¯æµè¯»å–ä¸è§£ç  ä¸Responseå‘é€ã€‚</li><li><strong>ä¸šåŠ¡æ‰§è¡Œçº¿ç¨‹ï¼š</strong> æœåŠ¡ç«¯å…·ä½“æ‰§è¡Œä¸šåŠ¡æ–¹æ³•çš„çº¿ç¨‹</li></ol><p><strong>å®¢æˆ·ç«¯çº¿ç¨‹åä½œï¼š</strong><br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/9564293312B2420DB80E156C7FB00CF5.jpg" alt="image"></p><ol><li><strong>è°ƒåº¦çº¿ç¨‹</strong><ol><li>è°ƒç”¨è¿œç¨‹æ–¹æ³•</li><li>å¯¹request è¿›è¡Œåè®®ç¼–ç </li><li>å‘é€request æ¶ˆæ¯è‡³IOçº¿ç¨‹</li><li>ç­‰å¾…ç»“æœçš„è·å–</li></ol></li><li><strong>IOçº¿ç¨‹</strong><ol><li>è¯»å–responseæµ</li><li>response è§£ç </li><li>æäº¤Exchange ä»»åŠ¡</li></ol></li><li><strong>Exchangeçº¿ç¨‹</strong><ol><li>å¡«å†™responseå€¼ è‡³ ResponseFuture</li><li>å”¤é†’è°ƒåº¦çº¿ç¨‹ï¼Œé€šçŸ¥å…¶è·å–ç»“æœ</li></ol></li></ol><p><strong>æœåŠ¡ç«¯çº¿ç¨‹åä½œï¼š</strong><br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/6E0C6D20EF8C4276B16C4BCF37D183CF.jpg" alt="image"></p><ol><li><strong>IOçº¿ç¨‹ï¼š</strong><ol><li>request æµè¯»å–</li><li>request è§£ç </li><li>æäº¤ä¸šåŠ¡å¤„ç†ä»»åŠ¡</li></ol></li><li><strong>ä¸šåŠ¡çº¿ç¨‹ï¼š</strong><ol><li>ä¸šåŠ¡æ–¹æ³•æ‰§è¡Œ</li><li>response ç¼–ç </li><li>å›å†™ç»“æœè‡³channel</li></ol></li></ol><p><strong>çº¿ç¨‹æ± </strong></p><ol><li><strong>fixedï¼š</strong> å›ºå®šçº¿ç¨‹æ± ,æ­¤çº¿ç¨‹æ± å¯åŠ¨æ—¶å³åˆ›å»ºå›ºå®šå¤§å°çš„çº¿ç¨‹æ•°ï¼Œä¸åšä»»ä½•ä¼¸ç¼©ï¼Œ</li><li><strong>cachedï¼š</strong> ç¼“å­˜çº¿ç¨‹æ± ,æ­¤çº¿ç¨‹æ± å¯ä¼¸ç¼©ï¼Œçº¿ç¨‹ç©ºé—²ä¸€åˆ†é’Ÿåå›æ”¶ï¼Œæ–°è¯·æ±‚é‡æ–°åˆ›å»ºçº¿ç¨‹</li><li><strong>Limitedï¼š</strong> æœ‰é™çº¿ç¨‹æ± ,æ­¤çº¿ç¨‹æ± ä¸€ç›´å¢é•¿ï¼Œç›´åˆ°ä¸Šé™ï¼Œå¢é•¿åä¸æ”¶ç¼©ã€‚</li></ol><h2 id="å››ã€Dubbo-åè®®"><a href="#å››ã€Dubbo-åè®®" class="headerlink" title="å››ã€Dubbo åè®®"></a>å››ã€Dubbo åè®®</h2><h3 id="RPC-åè®®åè¯è§£é‡Š"><a href="#RPC-åè®®åè¯è§£é‡Š" class="headerlink" title="RPC åè®®åè¯è§£é‡Š"></a><strong>RPC åè®®åè¯è§£é‡Š</strong></h3><p>åœ¨ä¸€ä¸ªå…¸å‹RPCçš„ä½¿ç”¨åœºæ™¯ä¸­ï¼ŒåŒ…å«äº†æœåŠ¡å‘ç°ã€è´Ÿè½½ã€å®¹é”™ã€ç½‘ç»œä¼ è¾“ã€åºåˆ—åŒ–ç­‰ç»„ä»¶ï¼Œå…¶ä¸­RPCåè®®å°±æŒ‡æ˜äº†ç¨‹åºå¦‚ä½•è¿›è¡Œç½‘ç»œä¼ è¾“å’Œåºåˆ—åŒ– ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªRPCåè®®çš„å®ç°å°±ç­‰äºä¸€ä¸ªéé€æ˜çš„è¿œç¨‹è°ƒç”¨å®ç°ï¼Œå¦‚ä½•åšåˆ°çš„çš„å‘¢ï¼Ÿ</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/AFE8EDF1A5B0427FA856137A2B9C6B12.jpg" alt="image"></p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/35AAA35E698A442687702615820C1AD7.jpg" alt="image"></p><ol><li>åœ°å€ï¼šæœåŠ¡æä¾›è€…åœ°å€</li><li>ç«¯å£ï¼šåè®®æŒ‡å®šå¼€æ”¾çš„ç«¯å£</li><li>æŠ¥æ–‡ç¼–ç ï¼šåè®®æŠ¥æ–‡ç¼–ç  ï¼Œåˆ†ä¸ºè¯·æ±‚å¤´å’Œè¯·æ±‚ä½“ä¸¤éƒ¨åˆ†ã€‚</li><li>åºåˆ—åŒ–æ–¹å¼ï¼šå°†è¯·æ±‚ä½“åºåˆ—åŒ–æˆå¯¹è±¡<br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/A8AA0D50758B4D9BA51737391F3AE4CE.jpg" alt="image"></li><li>è¿è¡ŒæœåŠ¡: ç½‘ç»œä¼ è¾“å®ç°<br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/3DC6FD7E7BFB4F4786B0CCD6A9BF87DA.jpg" alt="image"></li></ol><h3 id="dubbo-æ”¯æŒçš„RPCåè®®"><a href="#dubbo-æ”¯æŒçš„RPCåè®®" class="headerlink" title="dubbo æ”¯æŒçš„RPCåè®®"></a>dubbo æ”¯æŒçš„RPCåè®®</h3><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/DC0DB69BE0F449DF870E40A1093A57CC.jpg" alt="image"></p><table><thead><tr><th align="left"><strong>åç§°</strong></th><th align="left"><strong>å®ç°æè¿°</strong></th><th align="left"><strong>è¿æ¥æè¿°</strong></th><th align="left"><strong>é€‚ç”¨åœºæ™¯</strong></th></tr></thead><tbody><tr><td align="left"><strong>dubbo</strong></td><td align="left">ä¼ è¾“æœåŠ¡: mina, netty(é»˜è®¤), grizzyåºåˆ—åŒ–: hessian2(é»˜è®¤), java, fastjsonè‡ªå®šä¹‰æŠ¥æ–‡</td><td align="left">å•ä¸ªé•¿è¿æ¥NIOå¼‚æ­¥ä¼ è¾“</td><td align="left">1ã€å¸¸è§„RPCè°ƒç”¨2ã€ä¼ è¾“æ•°æ®é‡å°3ã€æä¾›è€…å°‘äºæ¶ˆè´¹è€…</td></tr><tr><td align="left"><strong>rmi</strong></td><td align="left">ä¼ è¾“ï¼šjava rmi æœåŠ¡åºåˆ—åŒ–ï¼šjavaåŸç”ŸäºŒè¿›åˆ¶åºåˆ—åŒ–</td><td align="left">å¤šä¸ªçŸ­è¿æ¥BIOåŒæ­¥ä¼ è¾“</td><td align="left">1ã€å¸¸è§„RPCè°ƒç”¨2ã€ä¸åŸRMIå®¢æˆ·ç«¯é›†æˆ3ã€å¯ä¼ å°‘é‡æ–‡ä»¶4ã€ä¸æ”¯æŒé˜²ç«å¢™ç©¿é€</td></tr><tr><td align="left"><strong>hessian</strong></td><td align="left">ä¼ è¾“æœåŠ¡ï¼šservletå®¹å™¨åºåˆ—åŒ–ï¼šhessianäºŒè¿›åˆ¶åºåˆ—åŒ–</td><td align="left">åŸºäºHttp åè®®ä¼ è¾“ï¼Œä¾æ‡’servletå®¹å™¨é…ç½®</td><td align="left">1ã€æä¾›è€…å¤šäºæ¶ˆè´¹è€…2ã€å¯ä¼ å¤§å­—æ®µå’Œæ–‡ä»¶3ã€è·¨è¯­è¨€è°ƒç”¨</td></tr><tr><td align="left"><strong>http</strong></td><td align="left">ä¼ è¾“æœåŠ¡ï¼šservletå®¹å™¨åºåˆ—åŒ–ï¼šjavaåŸç”ŸäºŒè¿›åˆ¶åºåˆ—åŒ–</td><td align="left">ä¾æ‡’servletå®¹å™¨é…ç½®</td><td align="left">1ã€æ•°æ®åŒ…å¤§å°æ··åˆ</td></tr><tr><td align="left"><strong>thrift</strong></td><td align="left">ä¸thrift RPC å®ç°é›†æˆï¼Œå¹¶åœ¨å…¶åŸºç¡€ä¸Šä¿®æ”¹äº†æŠ¥æ–‡å¤´</td><td align="left">é•¿è¿æ¥ã€NIOå¼‚æ­¥ä¼ è¾“</td><td align="left"></td></tr></tbody></table><p><strong><em>å…³äºRMIä¸æ”¯æŒé˜²ç«å¢™ç©¿é€çš„è¡¥å……è¯´æ˜ï¼š</em></strong><br>    åŸå› åœ¨äºRMI åº•å±‚å®ç°ä¸­ä¼šæœ‰ä¸¤ä¸ªç«¯å£ï¼Œä¸€ä¸ªæ˜¯å›ºå®šçš„ç”¨äºæœåŠ¡å‘ç°çš„æ³¨å†Œç«¯å£ï¼Œå¦å¤–ä¼šç”Ÿæˆä¸€ä¸ª**<em>éšæœº**</em>ç«¯å£ç”¨äºç½‘ç»œä¼ è¾“ã€‚å› ä¸ºè¿™ä¸ªéšæœºç«¯å£å°±ä¸èƒ½åœ¨é˜²ç«å¢™ä¸­æå‰è®¾ç½®å¼€æ”¾å¼€ã€‚æ‰€ä»¥å­˜åœ¨<em>é˜²ç«å¢™ç©¿é€é—®é¢˜</em></p><h3 id="åè®®çš„ä½¿ç”¨ä¸é…ç½®"><a href="#åè®®çš„ä½¿ç”¨ä¸é…ç½®" class="headerlink" title="åè®®çš„ä½¿ç”¨ä¸é…ç½®:"></a><strong>åè®®çš„ä½¿ç”¨ä¸é…ç½®:</strong></h3><p>Dubboæ¡†æ¶é…ç½®åè®®éå¸¸æ–¹ä¾¿ï¼Œç”¨æˆ·åªéœ€è¦åœ¨ provider åº”ç”¨ä¸­ é…ç½®*&lt;**dubbo:protocol&gt;*å…ƒç´ å³å¯ã€‚</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- name: åè®®åç§° dubbo|rmi|hessian|http|host:æœ¬æœºIPå¯ä¸å¡«ï¼Œåˆ™ç³»ç»Ÿè‡ªåŠ¨è·å–portï¼šç«¯å£ã€å¡«-1è¡¨ç¤ºç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©serverï¼šè¿è¡ŒæœåŠ¡ mina|netty|grizzy|servlet|jetty serializationï¼šåºåˆ—åŒ–æ–¹å¼ hessian2|java|compactedjava|fastjson è¯¦ç»†é…ç½®å‚è§dubbo å®˜ç½‘ dubbo.io--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>protocol</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dubbo<span class="token punctuation">"</span></span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>192.168.0.11<span class="token punctuation">"</span></span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20880<span class="token punctuation">"</span></span> <span class="token attr-name">server</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>netty<span class="token punctuation">"</span></span> <span class="token attr-name">serialization</span><span class="token attr-value"><span class="token punctuation">=</span>â€œhessian2â€</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span>â€œUTF-8â€</span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="dubbo-æ”¯æŒçš„åºåˆ—åŒ–ï¼š"><a href="#dubbo-æ”¯æŒçš„åºåˆ—åŒ–ï¼š" class="headerlink" title="dubbo æ”¯æŒçš„åºåˆ—åŒ–ï¼š"></a>dubbo æ”¯æŒçš„åºåˆ—åŒ–ï¼š</h3><table><thead><tr><th align="left"></th><th align="left">ç‰¹ç‚¹</th></tr></thead><tbody><tr><td align="left">fastjson</td><td align="left">æ–‡æœ¬å‹ï¼šä½“ç§¯è¾ƒå¤§ï¼Œæ€§èƒ½æ…¢ã€è·¨è¯­è¨€ã€å¯è¯»æ€§é«˜</td></tr><tr><td align="left">fst</td><td align="left">äºŒè¿›åˆ¶å‹ï¼šä½“ç§¯å°ã€å…¼å®¹ JDK åŸç”Ÿçš„åºåˆ—åŒ–ã€‚è¦æ±‚ JDK 1.7 æ”¯æŒã€‚</td></tr><tr><td align="left">hessian2</td><td align="left">äºŒè¿›åˆ¶å‹ï¼šè·¨è¯­è¨€ã€å®¹é”™æ€§é«˜ã€ä½“ç§¯å°</td></tr><tr><td align="left">java</td><td align="left">äºŒè¿›åˆ¶å‹ï¼šåœ¨JAVAåŸç”Ÿçš„åŸºç¡€ä¸Š å¯ä»¥å†™å…¥Null</td></tr><tr><td align="left">compactedjava</td><td align="left">äºŒè¿›åˆ¶å‹ï¼šä¸java ç±»ä¼¼ï¼Œå†…å®¹åšäº†å‹ç¼©</td></tr><tr><td align="left">nativejava</td><td align="left">äºŒè¿›åˆ¶å‹ï¼šåŸç”Ÿçš„JAVA åºåˆ—åŒ–</td></tr><tr><td align="left">kryo</td><td align="left">äºŒè¿›åˆ¶å‹ï¼šä½“ç§¯æ¯”hessian2 è¿˜è¦å°ï¼Œä½†å®¹é”™æ€§ æ²¡æœ‰hessian2 å¥½</td></tr></tbody></table><h3 id="Hessian-åºåˆ—åŒ–"><a href="#Hessian-åºåˆ—åŒ–" class="headerlink" title="Hessian åºåˆ—åŒ–"></a>Hessian åºåˆ—åŒ–</h3><ul><li>å‚æ•°åŠè¿”å›å€¼éœ€å®ç° Serializable æ¥å£</li><li>å‚æ•°åŠè¿”å›å€¼ä¸èƒ½è‡ªå®šä¹‰å®ç° List,Map,Number,Date,Calendarç­‰æ¥å£ï¼Œåªèƒ½ç”¨ JDK è‡ªå¸¦çš„å®ç°ï¼Œå› ä¸º hessian ä¼šåšç‰¹æ®Šå¤„ç†ï¼Œè‡ªå®šä¹‰å®ç°ç±»ä¸­çš„å±æ€§å€¼éƒ½ä¼šä¸¢å¤±ã€‚</li><li>Hessian åºåˆ—åŒ–ï¼Œåªä¼ æˆå‘˜å±æ€§å€¼å’Œå€¼çš„ç±»å‹ï¼Œä¸ä¼ æ–¹æ³•æˆ–é™æ€å˜é‡ï¼Œå…¼å®¹æƒ…å†µ <a href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/dubbo.html#fn1">[1]</a><a href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/dubbo.html#fn2">[2]</a>ï¼š</li></ul><table><thead><tr><th align="left"><strong>æ•°æ®é€šè®¯</strong></th><th align="left"><strong>æƒ…å†µ</strong></th><th align="left"><strong>ç»“æœ</strong></th></tr></thead><tbody><tr><td align="left">A-&gt;B</td><td align="left">ç±»Aå¤šä¸€ç§ å±æ€§ï¼ˆæˆ–è€…è¯´ç±»Bå°‘ä¸€ç§ å±æ€§ï¼‰</td><td align="left">ä¸æŠ›å¼‚å¸¸ï¼ŒAå¤šçš„é‚£ ä¸ªå±æ€§çš„å€¼ï¼ŒBæ²¡æœ‰ï¼Œ å…¶ä»–æ­£å¸¸</td></tr><tr><td align="left">A-&gt;B</td><td align="left">æšä¸¾Aå¤šä¸€ç§ æšä¸¾ï¼ˆæˆ–è€…è¯´Bå°‘ä¸€ç§ æšä¸¾ï¼‰ï¼ŒAä½¿ç”¨å¤š å‡ºæ¥çš„æšä¸¾è¿›è¡Œä¼ è¾“</td><td align="left">æŠ›å¼‚å¸¸</td></tr><tr><td align="left">A-&gt;B</td><td align="left">æšä¸¾Aå¤šä¸€ç§ æšä¸¾ï¼ˆæˆ–è€…è¯´Bå°‘ä¸€ç§ æšä¸¾ï¼‰ï¼ŒAä¸ä½¿ç”¨ å¤šå‡ºæ¥çš„æšä¸¾è¿›è¡Œä¼ è¾“</td><td align="left">ä¸æŠ›å¼‚å¸¸ï¼ŒBæ­£å¸¸æ¥ æ”¶æ•°æ®</td></tr><tr><td align="left">A-&gt;B</td><td align="left">Aå’ŒBçš„å±æ€§ åç›¸åŒï¼Œä½†ç±»å‹ä¸ç›¸åŒ</td><td align="left">æŠ›å¼‚å¸¸</td></tr><tr><td align="left">A-&gt;B</td><td align="left">serialId ä¸ç›¸åŒ</td><td align="left">æ­£å¸¸ä¼ è¾“</td></tr></tbody></table><blockquote><p>æ¥å£å¢åŠ æ–¹æ³•ï¼Œå¯¹å®¢æˆ·ç«¯æ— å½±å“ï¼Œå¦‚æœè¯¥æ–¹æ³•ä¸æ˜¯å®¢æˆ·ç«¯éœ€è¦çš„ï¼Œå®¢æˆ·ç«¯ä¸éœ€è¦é‡æ–°éƒ¨ç½²ã€‚è¾“å…¥å‚æ•°å’Œç»“æœé›†ä¸­å¢åŠ å±æ€§ï¼Œå¯¹å®¢æˆ·ç«¯æ— å½±å“ï¼Œå¦‚æœå®¢æˆ·ç«¯å¹¶ä¸éœ€è¦æ–°å±æ€§ï¼Œä¸ç”¨é‡æ–°éƒ¨ç½²ã€‚<br>è¾“å…¥å‚æ•°å’Œç»“æœé›†å±æ€§åå˜åŒ–ï¼Œå¯¹å®¢æˆ·ç«¯åºåˆ—åŒ–æ— å½±å“ï¼Œä½†æ˜¯å¦‚æœå®¢æˆ·ç«¯ä¸é‡æ–°éƒ¨ç½²ï¼Œä¸ç®¡è¾“å…¥è¿˜æ˜¯è¾“å‡ºï¼Œå±æ€§åå˜åŒ–çš„å±æ€§å€¼æ˜¯è·å–ä¸åˆ°çš„ã€‚</p></blockquote><p>æ€»ç»“ï¼šæœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯å¯¹é¢†åŸŸå¯¹è±¡å¹¶ä¸éœ€è¦å®Œå…¨ä¸€è‡´ï¼Œè€Œæ˜¯æŒ‰ç…§æœ€å¤§åŒ¹é…åŸåˆ™ã€‚</p><h2 id="äº”ã€RPCåè®®æŠ¥æ–‡ç¼–ç ä¸å®ç°è¯¦è§£"><a href="#äº”ã€RPCåè®®æŠ¥æ–‡ç¼–ç ä¸å®ç°è¯¦è§£" class="headerlink" title="äº”ã€RPCåè®®æŠ¥æ–‡ç¼–ç ä¸å®ç°è¯¦è§£"></a>äº”ã€RPCåè®®æŠ¥æ–‡ç¼–ç ä¸å®ç°è¯¦è§£</h2><h3 id="RPC-ä¼ è¾“å®ç°ï¼š"><a href="#RPC-ä¼ è¾“å®ç°ï¼š" class="headerlink" title="RPC ä¼ è¾“å®ç°ï¼š"></a><strong>RPC ä¼ è¾“å®ç°ï¼š</strong></h3><p>RPCçš„åè®®çš„ä¼ è¾“æ˜¯åŸºäº TCP/IP åšä¸ºåŸºç¡€ä½¿ç”¨Socket æˆ–Nettyã€minaç­‰ç½‘ç»œç¼–ç¨‹ç»„ä»¶å®ç°ã€‚ä½†æœ‰ä¸ªé—®é¢˜æ˜¯TCPæ˜¯é¢å‘å­—èŠ‚æµçš„æ— è¾¹è¾¹ç•Œåè®®ï¼Œå…¶åªç®¡è´Ÿè´£æ•°æ®ä¼ è¾“å¹¶ä¸ä¼šåŒºåˆ†æ¯æ¬¡è¯·æ±‚æ‰€å¯¹åº”çš„æ¶ˆæ¯ï¼Œè¿™æ ·å°±ä¼šå‡ºç°TCPåä¹‰ä¼ è¾“å½“ä¸­çš„æ‹†åŒ…ä¸ç²˜åŒ…é—®é¢˜</p><h3 id="æ‹†åŒ…ä¸ç²˜åŒ…äº§ç”Ÿçš„åŸå› ï¼š"><a href="#æ‹†åŒ…ä¸ç²˜åŒ…äº§ç”Ÿçš„åŸå› ï¼š" class="headerlink" title="æ‹†åŒ…ä¸ç²˜åŒ…äº§ç”Ÿçš„åŸå› ï¼š"></a><strong>æ‹†åŒ…ä¸ç²˜åŒ…äº§ç”Ÿçš„åŸå› ï¼š</strong></h3><p>æˆ‘ä»¬çŸ¥é“tcpæ˜¯ä»¥æµåŠ¨çš„æ–¹å¼ä¼ è¾“æ•°æ®ï¼Œä¼ è¾“çš„æœ€å°å•ä½ä¸ºä¸€ä¸ªæŠ¥æ–‡æ®µï¼ˆsegmentï¼‰ã€‚tcp Headerä¸­æœ‰ä¸ªOptionsæ ‡è¯†ä½ï¼Œå¸¸è§çš„æ ‡è¯†ä¸ºmss(Maximum Segment Size)æŒ‡çš„æ˜¯ï¼Œè¿æ¥å±‚æ¯æ¬¡ä¼ è¾“çš„æ•°æ®æœ‰ä¸ªæœ€å¤§é™åˆ¶MTU(Maximum Transmission Unit)ï¼Œä¸€èˆ¬æ˜¯1500æ¯”ç‰¹ï¼Œè¶…è¿‡è¿™ä¸ªé‡è¦åˆ†æˆå¤šä¸ªæŠ¥æ–‡æ®µï¼Œmssåˆ™æ˜¯è¿™ä¸ªæœ€å¤§é™åˆ¶å‡å»TCPçš„headerï¼Œå…‰æ˜¯è¦ä¼ è¾“çš„æ•°æ®çš„å¤§å°ï¼Œä¸€èˆ¬ä¸º1460æ¯”ç‰¹ã€‚æ¢ç®—æˆå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯180å¤šå­—èŠ‚ã€‚</p><p>tcpä¸ºæé«˜æ€§èƒ½ï¼Œå‘é€ç«¯ä¼šå°†éœ€è¦å‘é€çš„æ•°æ®å‘é€åˆ°ç¼“å†²åŒºï¼Œç­‰å¾…ç¼“å†²åŒºæ»¡äº†ä¹‹åï¼Œå†å°†ç¼“å†²ä¸­çš„æ•°æ®å‘é€åˆ°æ¥æ”¶æ–¹ã€‚åŒç†ï¼Œæ¥æ”¶æ–¹ä¹Ÿæœ‰ç¼“å†²åŒºè¿™æ ·çš„æœºåˆ¶ï¼Œæ¥æ¥æ”¶æ•°æ®ã€‚è¿™æ—¶å°±ä¼šå‡ºç°ä»¥ä¸‹æƒ…å†µï¼š</p><ol><li>åº”ç”¨ç¨‹åºå†™å…¥çš„æ•°æ®å¤§äºMSSå¤§å°ï¼Œè¿™å°†ä¼šå‘ç”Ÿæ‹†åŒ…ã€‚</li><li>åº”ç”¨ç¨‹åºå†™å…¥æ•°æ®å°äºMSSå¤§å°ï¼Œè¿™å°†ä¼šå‘ç”Ÿç²˜åŒ…ã€‚</li><li>æ¥æ”¶æ–¹æ³•ä¸åŠæ—¶è¯»å–å¥—æ¥å­—ç¼“å†²åŒºæ•°æ®ï¼Œè¿™å°†å‘ç”Ÿç²˜åŒ…ã€‚</li></ol><h3 id="æ‹†åŒ…ä¸ç²˜åŒ…è§£å†³åŠæ³•ï¼š"><a href="#æ‹†åŒ…ä¸ç²˜åŒ…è§£å†³åŠæ³•ï¼š" class="headerlink" title="æ‹†åŒ…ä¸ç²˜åŒ…è§£å†³åŠæ³•ï¼š"></a><strong>æ‹†åŒ…ä¸ç²˜åŒ…è§£å†³åŠæ³•ï¼š</strong></h3><ol><li>è®¾ç½®å®šé•¿æ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯æ¯æ¬¡è¯»å–æ—¢å®šé•¿åº¦çš„å†…å®¹ä½œä¸ºä¸€æ¡å®Œæ•´æ¶ˆæ¯ã€‚</li><li>{â€œtypeâ€:â€messageâ€,â€contentâ€:â€helloâ€}\n</li><li>ä½¿ç”¨å¸¦æ¶ˆæ¯å¤´çš„åè®®ã€æ¶ˆæ¯å¤´å­˜å‚¨æ¶ˆæ¯å¼€å§‹æ ‡è¯†åŠæ¶ˆæ¯é•¿åº¦ä¿¡æ¯ï¼ŒæœåŠ¡ç«¯è·å–æ¶ˆæ¯å¤´çš„æ—¶å€™è§£æå‡ºæ¶ˆæ¯é•¿åº¦ï¼Œç„¶åå‘åè¯»å–è¯¥é•¿åº¦çš„å†…å®¹ã€‚</li></ol><p><strong>æ¯”å¦‚ï¼š</strong> Httpåè®® heade ä¸­çš„ Content-Length å°±è¡¨ç¤ºæ¶ˆæ¯ä½“çš„å¤§å°ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/1627E3D71B36459393AAD1066002AFE6.jpg" alt="image"></p><h3 id="Dubbo-åè®®æŠ¥æ–‡ç¼–ç ï¼š"><a href="#Dubbo-åè®®æŠ¥æ–‡ç¼–ç ï¼š" class="headerlink" title="Dubbo åè®®æŠ¥æ–‡ç¼–ç ï¼š"></a>Dubbo åè®®æŠ¥æ–‡ç¼–ç ï¼š</h3><p><strong>dubbo åè®®æŠ¥æ–‡ç¼–ç ï¼š</strong></p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/25B9C2C5C20C46168D641144B2B6A07E.jpg" alt="image"></p><ul><li><strong>magic</strong>ï¼šç±»ä¼¼javaå­—èŠ‚ç æ–‡ä»¶é‡Œçš„é­”æ•°ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯dubboåè®®çš„æ•°æ®åŒ…ã€‚é­”æ•°æ˜¯å¸¸é‡0xdabb,ç”¨äºåˆ¤æ–­æŠ¥æ–‡çš„å¼€å§‹ã€‚</li><li><strong>flag</strong>ï¼šæ ‡å¿—ä½, ä¸€å…±8ä¸ªåœ°å€ä½ã€‚ä½å››ä½ç”¨æ¥è¡¨ç¤ºæ¶ˆæ¯ä½“æ•°æ®ç”¨çš„åºåˆ—åŒ–å·¥å…·çš„ç±»å‹ï¼ˆé»˜è®¤hessianï¼‰ï¼Œé«˜å››ä½ä¸­ï¼Œç¬¬ä¸€ä½ä¸º1è¡¨ç¤ºæ˜¯requestè¯·æ±‚ï¼Œç¬¬äºŒä½ä¸º1è¡¨ç¤ºåŒå‘ä¼ è¾“ï¼ˆå³æœ‰è¿”å›responseï¼‰ï¼Œç¬¬ä¸‰ä½ä¸º1è¡¨ç¤ºæ˜¯å¿ƒè·³pingäº‹ä»¶ã€‚</li><li><strong>status</strong>ï¼šçŠ¶æ€ä½, è®¾ç½®è¯·æ±‚å“åº”çŠ¶æ€ï¼Œdubboå®šä¹‰äº†ä¸€äº›å“åº”çš„ç±»å‹ã€‚å…·ä½“ç±»å‹è§ com.alibaba.dubbo.remoting.exchange.Response</li><li><strong>invoke idï¼š</strong> æ¶ˆæ¯id, long ç±»å‹ã€‚æ¯ä¸€ä¸ªè¯·æ±‚çš„å”¯ä¸€è¯†åˆ«idï¼ˆç”±äºé‡‡ç”¨å¼‚æ­¥é€šè®¯çš„æ–¹å¼ï¼Œç”¨æ¥æŠŠè¯·æ±‚requestå’Œè¿”å›çš„responseå¯¹åº”ä¸Šï¼‰</li><li><strong>body lengthï¼š</strong> æ¶ˆæ¯ä½“ body é•¿åº¦, int ç±»å‹ï¼Œå³è®°å½•Body Contentæœ‰å¤šå°‘ä¸ªå­—èŠ‚ã€‚</li></ul><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/B37D5C57C013452AA75C1DCB90F2766A.jpg" alt="image"></p><ul><li>com.alibaba.dubbo.rpc.protocol.dubbo.DubboCodec#encodeRequestData()</li></ul><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encodeRequestData</span><span class="token punctuation">(</span>Channel channel<span class="token punctuation">,</span> ObjectOutput out<span class="token punctuation">,</span> Object data<span class="token punctuation">,</span> String version<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        RpcInvocation inv <span class="token operator">=</span> <span class="token punctuation">(</span>RpcInvocation<span class="token punctuation">)</span> data<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">//ç‰ˆæœ¬å·</span>        out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//æ¥å£è·¯å¾„</span>        out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span>inv<span class="token punctuation">.</span><span class="token function">getAttachment</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>PATH_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//æ¥å£ç‰ˆæœ¬</span>        out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span>inv<span class="token punctuation">.</span><span class="token function">getAttachment</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>VERSION_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//æ–¹æ³•åç§°</span>        out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span>inv<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å‚æ•°ç±»å‹</span>        out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span>ReflectUtils<span class="token punctuation">.</span><span class="token function">getDesc</span><span class="token punctuation">(</span>inv<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å‚æ•°å€¼</span>        Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> inv<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> null<span class="token punctuation">)</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token function">encodeInvocationArgument</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> inv<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>inv<span class="token punctuation">.</span><span class="token function">getAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>com.alibaba.dubbo.rpc.protocol.dubbo.DubboCodec#encodeResponseData()</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encodeResponseData</span><span class="token punctuation">(</span>Channel channel<span class="token punctuation">,</span> ObjectOutput out<span class="token punctuation">,</span> Object data<span class="token punctuation">,</span> String version<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>      Result result <span class="token operator">=</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span> data<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// currently, the version value in Response records the version of Request</span>      <span class="token keyword">boolean</span> attach <span class="token operator">=</span> Version<span class="token punctuation">.</span><span class="token function">isSupportResponseAttatchment</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>      Throwable th <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>th <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>          Object ret <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>              out<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>attach <span class="token operator">?</span> RESPONSE_NULL_VALUE_WITH_ATTACHMENTS <span class="token operator">:</span> RESPONSE_NULL_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>              out<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>attach <span class="token operator">?</span> RESPONSE_VALUE_WITH_ATTACHMENTS <span class="token operator">:</span> RESPONSE_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>              out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          out<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>attach <span class="token operator">?</span> RESPONSE_WITH_EXCEPTION_WITH_ATTACHMENTS <span class="token operator">:</span> RESPONSE_WITH_EXCEPTION<span class="token punctuation">)</span><span class="token punctuation">;</span>          out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>th<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>attach<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// returns current version of Response to consumer side.</span>          result<span class="token punctuation">.</span><span class="token function">getAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>DUBBO_VERSION_KEY<span class="token punctuation">,</span> Version<span class="token punctuation">.</span><span class="token function">getProtocolVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>è§£ç </p></li></ul><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> Object <span class="token function">decodeBody</span><span class="token punctuation">(</span>Channel channel<span class="token punctuation">,</span> InputStream is<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> header<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        <span class="token keyword">byte</span> flag <span class="token operator">=</span> header<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> proto <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> SERIALIZATION_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è·å– request id</span>        <span class="token keyword">long</span> id <span class="token operator">=</span> Bytes<span class="token punctuation">.</span><span class="token function">bytes2long</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//åˆ¤æ–­æ˜¯request è§£ç è¿˜æ˜¯ response è§£ç </span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> FLAG_REQUEST<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//å®¢æˆ·ç«¯ï¼š è§£ç  response.</span>            Response res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> FLAG_EVENT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                res<span class="token punctuation">.</span><span class="token function">setEvent</span><span class="token punctuation">(</span>Response<span class="token punctuation">.</span>HEARTBEAT_EVENT<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// get status.</span>            <span class="token keyword">byte</span> status <span class="token operator">=</span> header<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            res<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> Response<span class="token punctuation">.</span>OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Object data<span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">isHeartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        data <span class="token operator">=</span> <span class="token function">decodeHeartbeatData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>  CodecSupport<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is<span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">isEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        data <span class="token operator">=</span> <span class="token function">decodeEventData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span>  CodecSupport<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is<span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        DecodeableRpcResult result<span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>                                Constants<span class="token punctuation">.</span>DECODE_IN_IO_THREAD_KEY<span class="token punctuation">,</span>                                Constants<span class="token punctuation">.</span>DEFAULT_DECODE_IN_IO_THREAD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DecodeableRpcResult</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> res<span class="token punctuation">,</span> is<span class="token punctuation">,</span>                                    <span class="token punctuation">(</span>Invocation<span class="token punctuation">)</span> <span class="token function">getRequestData</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">;</span>                            result<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                            result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DecodeableRpcResult</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> res<span class="token punctuation">,</span>                                    <span class="token keyword">new</span> <span class="token class-name">UnsafeByteArrayInputStream</span><span class="token punctuation">(</span><span class="token function">readMessageData</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                    <span class="token punctuation">(</span>Invocation<span class="token punctuation">)</span> <span class="token function">getRequestData</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        data <span class="token operator">=</span> result<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    res<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    res<span class="token punctuation">.</span><span class="token function">setErrorMessage</span><span class="token punctuation">(</span>CodecSupport<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is<span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Decode response failed: "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                res<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>Response<span class="token punctuation">.</span>CLIENT_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>                res<span class="token punctuation">.</span><span class="token function">setErrorMessage</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> res<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// æœåŠ¡ç«¯ ï¼šè§£ç  request.</span>            Request req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>            req<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span>Version<span class="token punctuation">.</span><span class="token function">getProtocolVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            req<span class="token punctuation">.</span><span class="token function">setTwoWay</span><span class="token punctuation">(</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> FLAG_TWOWAY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> FLAG_EVENT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                req<span class="token punctuation">.</span><span class="token function">setEvent</span><span class="token punctuation">(</span>Request<span class="token punctuation">.</span>HEARTBEAT_EVENT<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                Object data<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">isHeartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    data <span class="token operator">=</span> <span class="token function">decodeHeartbeatData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> CodecSupport<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is<span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">isEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    data <span class="token operator">=</span> <span class="token function">decodeEventData</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> CodecSupport<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is<span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    DecodeableRpcInvocation inv<span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>                            Constants<span class="token punctuation">.</span>DECODE_IN_IO_THREAD_KEY<span class="token punctuation">,</span>                            Constants<span class="token punctuation">.</span>DEFAULT_DECODE_IN_IO_THREAD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        inv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DecodeableRpcInvocation</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> req<span class="token punctuation">,</span> is<span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">;</span>                        inv<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        inv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DecodeableRpcInvocation</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> req<span class="token punctuation">,</span>                                <span class="token keyword">new</span> <span class="token class-name">UnsafeByteArrayInputStream</span><span class="token punctuation">(</span><span class="token function">readMessageData</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    data <span class="token operator">=</span> inv<span class="token punctuation">;</span>                <span class="token punctuation">}</span>                req<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Decode request failed: "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// bad request</span>                req<span class="token punctuation">.</span><span class="token function">setBroken</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                req<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> req<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/298139E160AA428486709FD4E1641C6A.jpg" alt="image"></p><h2 id="å…­ã€æœ€å"><a href="#å…­ã€æœ€å" class="headerlink" title="å…­ã€æœ€å"></a>å…­ã€æœ€å</h2><ol><li>è´Ÿè½½å‡è¡¡ï¼šå¤šä¸ªæœºå™¨è°ƒç”¨å“ªä¸€å°?<blockquote><p>ç­”ï¼šå¤šç§è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚</p></blockquote></li><li>æœåŠ¡å‘ç°ï¼šæ€æ ·å‘ç°æ–°çš„æœåŠ¡åœ°å€å‘¢ï¼Ÿ<blockquote><p>ç­”ï¼šæœåŠ¡æ³¨å†Œä¸å‘ç°ã€‚</p></blockquote></li><li>å¥åº·æ£€æµ‹ï¼šæœåŠ¡å…³å®•æœºæˆ–æ¢å¤åæ€ä¹ˆåŠï¼Ÿ<blockquote><p>ç­”ï¼šä¸¤ç§æƒ…å†µï¼Œæ¶ˆè´¹è€…è¿˜æ˜¯ç”¨è€çš„è¯·æ±‚ï¼Œåˆ™</p></blockquote></li><li>å®¹é”™ï¼šå¦‚æœè°ƒç”¨å…¶ä¸­ä¸€å°è°ƒç”¨å‡ºé”™äº†æ€ä¹ˆåŠï¼Ÿ<blockquote><p>ç­”ï¼šå®¹é”™ç­–ç•¥ã€‚</p></blockquote></li></ol><ul><li><a href="http://dubbo.apache.org/zh-cn/docs/user/quick-start.html">Dubboå®˜æ–¹æ–‡æ¡£</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ä¸€ã€å‰è¨€&quot;&gt;&lt;a href=&quot;#ä¸€ã€å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€å‰è¨€&quot;&gt;&lt;/a&gt;ä¸€ã€å‰è¨€&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://cdn.jsdelivr.net/gh/brokge/drawio/img/64A03BA7F21B4BB29F4ABC5F11140870.jpg&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;åˆ†å¸ƒå¼æ¶æ„çš„-æœ‰-3-ç§è§£å†³æ–¹æ¡ˆ&quot;&gt;&lt;a href=&quot;#åˆ†å¸ƒå¼æ¶æ„çš„-æœ‰-3-ç§è§£å†³æ–¹æ¡ˆ&quot; class=&quot;headerlink&quot; title=&quot;åˆ†å¸ƒå¼æ¶æ„çš„ æœ‰ 3 ç§è§£å†³æ–¹æ¡ˆ&quot;&gt;&lt;/a&gt;&lt;strong&gt;åˆ†å¸ƒå¼æ¶æ„çš„ æœ‰ 3 ç§è§£å†³æ–¹æ¡ˆ&lt;/strong&gt;&lt;/h4&gt;&lt;ol&gt;
&lt;li&gt;åŸºäºåå‘ä»£ç†çš„ä¸­å¿ƒåŒ–æ¶æ„&lt;/li&gt;
&lt;li&gt;åµŒå…¥åº”ç”¨å†…éƒ¨çš„å»ä¸­å¿ƒåŒ–æ¶æ„&lt;/li&gt;
&lt;li&gt;åŸºäºç‹¬ç«‹ä»£ç†è¿›ç¨‹çš„Service Meshæ¶æ„
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="å¾®æœåŠ¡" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
    
      <category term="å¾®æœåŠ¡" scheme="https://brokge.github.io/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>Redisæ ¸å¿ƒåŸç†è¯¦è§£</title>
    <link href="https://brokge.github.io/2020/02/11/Redis%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3/"/>
    <id>https://brokge.github.io/2020/02/11/Redisæ ¸å¿ƒåŸç†è¯¦è§£/</id>
    <published>2020-02-11T12:04:17.000Z</published>
    <updated>2020-08-21T04:55:10.271Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€Redis-åŸºç¡€æ•°æ®ç»“æ„"><a href="#ä¸€ã€Redis-åŸºç¡€æ•°æ®ç»“æ„" class="headerlink" title="ä¸€ã€Redis åŸºç¡€æ•°æ®ç»“æ„"></a>ä¸€ã€Redis åŸºç¡€æ•°æ®ç»“æ„</h2><p>Redis æœ‰ 5 ç§åŸºç¡€æ•°æ®ç»“æ„ï¼Œåˆ†åˆ«ä¸ºï¼šstring (å­—ç¬¦ä¸²)ã€list (åˆ—è¡¨)ã€set (é›†åˆ)ã€hash (å“ˆå¸Œ) å’Œ zset (æœ‰åºé›†åˆ)ï¼Œä¸‹é¢å°±è¯¦ç»†è¯´è¯´è¿™å‡ ç§æ•°æ®ç»“æ„ã€‚<br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/0A3FCFF09EFA4D6A8B1F6D5CCCF848A8.jpg" alt="image"></p><a id="more"></a><h3 id="åˆ—è¡¨ï¼ˆlistï¼‰"><a href="#åˆ—è¡¨ï¼ˆlistï¼‰" class="headerlink" title="åˆ—è¡¨ï¼ˆlistï¼‰"></a>åˆ—è¡¨ï¼ˆlistï¼‰</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹åˆ—è¡¨ã€‚åˆ—è¡¨è¿™ç§æ•°æ®ç±»å‹æ”¯æŒå­˜å‚¨ä¸€ç»„æ•°æ®ã€‚è¿™ç§æ•°æ®ç±»å‹å¯¹åº”ä¸¤ç§å®ç°æ–¹æ³•ï¼Œä¸€ç§æ˜¯å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰ï¼Œå¦ä¸€ç§æ˜¯åŒå‘å¾ªç¯é“¾è¡¨ã€‚å½“åˆ—è¡¨ä¸­å­˜å‚¨çš„æ•°æ®é‡æ¯”è¾ƒå°çš„æ—¶å€™ï¼Œåˆ—è¡¨å°±å¯ä»¥é‡‡ç”¨å‹ç¼©åˆ—è¡¨çš„æ–¹å¼å®ç°ã€‚å…·ä½“éœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ol><li>åˆ—è¡¨ä¸­ä¿å­˜çš„å•ä¸ªæ•°æ®ï¼ˆæœ‰å¯èƒ½æ˜¯å­—ç¬¦ä¸²ç±»å‹çš„ï¼‰å°äº 64 å­—èŠ‚ï¼›</li><li>åˆ—è¡¨ä¸­æ•°æ®ä¸ªæ•°å°‘äº 512 ä¸ªã€‚</li></ol><p>æ‰€è°“å‹ç¼©åˆ—è¡¨ï¼Œå®ƒå¹¶ä¸æ˜¯åŸºç¡€æ•°æ®ç»“æ„ï¼Œè€Œæ˜¯ Redisä¸ºäº†<strong>å‹ç¼©å†…å­˜å’Œæ”¯æŒå­˜å‚¨ä¸åŒç±»å‹çš„æ•°æ®</strong>ï¼Œ è‡ªå·±è®¾è®¡çš„ä¸€ç§æ•°æ®å­˜å‚¨ç»“æ„ã€‚å®ƒæœ‰ç‚¹å„¿ç±»ä¼¼æ•°ç»„ï¼Œé€šè¿‡ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œæ¥å­˜å‚¨æ•°æ®ã€‚ä¸è¿‡ï¼Œå®ƒè·Ÿæ•°ç»„ä¸åŒçš„ä¸€ç‚¹æ˜¯ï¼Œå®ƒå…è®¸å­˜å‚¨çš„æ•°æ®å¤§å°ä¸åŒ,ç”±äºåˆ†é…çš„ç©ºé—´ä¸åŒï¼Œæ‰€ä»¥ä¸èƒ½é€šè¿‡åœ°å€ç´¢å¼•éšæœºè®¿é—®ã€‚<br><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/5909E6B696754BF0BD809353853E6B34.jpg" alt="image"><br>å¦‚æœä¸èƒ½åŒæ—¶æ»¡è¶³åˆšåˆšè®²çš„ä¸¤ä¸ªæ¡ä»¶çš„æ—¶å€™ï¼Œåˆ—è¡¨å°±è¦é€šè¿‡åŒå‘å¾ªç¯é“¾è¡¨æ¥å®ç°äº†ã€‚</p><h3 id="å­—å…¸ï¼ˆhashï¼‰"><a href="#å­—å…¸ï¼ˆhashï¼‰" class="headerlink" title="å­—å…¸ï¼ˆhashï¼‰"></a>å­—å…¸ï¼ˆhashï¼‰</h3><p>å…¸ç±»å‹ç”¨æ¥å­˜å‚¨ä¸€ç»„æ•°æ®å¯¹ã€‚æ¯ä¸ªæ•°æ®å¯¹åˆåŒ…å«é”®å€¼ä¸¤éƒ¨åˆ†ã€‚å­—å…¸ç±»å‹ä¹Ÿæœ‰ä¸¤ç§å®ç°æ–¹å¼ã€‚ä¸€ç§æ˜¯æˆ‘ä»¬åˆšåˆšè®²åˆ°çš„å‹ç¼©åˆ—è¡¨ï¼Œå¦ä¸€ç§æ˜¯æ•£åˆ—è¡¨ã€‚åŒæ ·ï¼Œåªæœ‰å½“å­˜å‚¨çš„æ•°æ®é‡æ¯”è¾ƒå°çš„æƒ…å†µä¸‹ï¼ŒRedis æ‰ä½¿ç”¨å‹ç¼©åˆ—è¡¨æ¥å®ç°å­—å…¸ç±»å‹ã€‚<br>å…·ä½“éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ol><li>å­—å…¸ä¸­ä¿å­˜çš„é”®å’Œå€¼çš„å¤§å°éƒ½è¦å°äº 64 å­—èŠ‚ï¼›</li><li>å­—å…¸ä¸­é”®å€¼å¯¹çš„ä¸ªæ•°è¦å°äº 512 ä¸ªã€‚</li></ol><p>å½“ä¸èƒ½åŒæ—¶æ»¡è¶³ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶çš„æ—¶å€™ Redis å°±ä½¿ç”¨æ•£åˆ—è¡¨æ¥å®ç°å­—å…¸ç±»å‹ã€‚Redis ä½¿ç”¨<strong>MurmurHash2</strong>è¿™ç§è¿è¡Œé€Ÿåº¦å¿«ã€éšæœºæ€§å¥½çš„å“ˆå¸Œç®—æ³•ä½œä¸ºå“ˆå¸Œå‡½æ•°ã€‚å¯¹äºå“ˆå¸Œå†²çªé—®é¢˜ï¼ŒRedis ä½¿ç”¨é“¾è¡¨æ³•æ¥è§£å†³ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒRedis è¿˜æ”¯æŒæ•£åˆ—è¡¨çš„åŠ¨æ€æ‰©å®¹ã€ç¼©å®¹ã€‚</p><h3 id="é›†åˆï¼ˆsetï¼‰"><a href="#é›†åˆï¼ˆsetï¼‰" class="headerlink" title="é›†åˆï¼ˆsetï¼‰"></a>é›†åˆï¼ˆsetï¼‰</h3><p>é›†åˆè¿™ç§æ•°æ®ç±»å‹ç”¨æ¥å­˜å‚¨ä¸€ç»„ä¸é‡å¤çš„æ•°æ®ã€‚è¿™ç§æ•°æ®ç±»å‹ä¹Ÿæœ‰ä¸¤ç§å®ç°æ–¹æ³•ï¼Œä¸€ç§æ˜¯åŸºäºæœ‰åºæ•°ç»„ï¼Œå¦ä¸€ç§æ˜¯åŸºäºæ•£åˆ—è¡¨ã€‚å½“è¦å­˜å‚¨çš„æ•°æ®ï¼ŒåŒæ—¶æ»¡è¶³ä¸‹é¢è¿™æ ·ä¸¤ä¸ªæ¡ä»¶çš„æ—¶å€™ï¼ŒRedis å°±é‡‡ç”¨æœ‰åºæ•°ç»„ï¼Œæ¥å®ç°é›†åˆè¿™ç§æ•°æ®ç±»å‹ã€‚</p><ol><li>å­˜å‚¨çš„æ•°æ®éƒ½æ˜¯æ•´æ•°ï¼›</li><li>å­˜å‚¨çš„æ•°æ®å…ƒç´ ä¸ªæ•°ä¸è¶…è¿‡ 512ä¸ªã€‚</li></ol><p>å½“ä¸èƒ½åŒæ—¶æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„æ—¶å€™ï¼ŒRedis å°±ä½¿ç”¨æ•£åˆ—è¡¨æ¥å­˜å‚¨é›†åˆä¸­çš„æ•°æ®ã€‚</p><h3 id="æœ‰åºé›†åˆï¼ˆsortedsetï¼‰"><a href="#æœ‰åºé›†åˆï¼ˆsortedsetï¼‰" class="headerlink" title="æœ‰åºé›†åˆï¼ˆsortedsetï¼‰"></a>æœ‰åºé›†åˆï¼ˆsortedsetï¼‰</h3><p>æœ‰åºé›†åˆè¿™ç§æ•°æ®ç±»å‹ï¼Œå®ƒç”¨æ¥å­˜å‚¨ä¸€ç»„æ•°æ®ï¼Œå¹¶ä¸”æ¯ä¸ªæ•°æ®ä¼šé™„å¸¦ä¸€ä¸ªå¾—åˆ†ã€‚é€šè¿‡å¾—åˆ†çš„å¤§å°ï¼Œè¿›è¡Œæ•°æ®ç»“æ„ç»„ç»‡ã€‚å½“æ•°æ®é‡æ¯”è¾ƒå°çš„æ—¶å€™ï¼ŒRedis ä¼šç”¨å‹ç¼©åˆ—è¡¨æ¥å®ç°æœ‰åºé›†åˆã€‚</p><ol><li>æ‰€æœ‰æ•°æ®çš„å¤§å°éƒ½è¦å°äº 64 å­—èŠ‚ï¼›</li><li>å…ƒç´ ä¸ªæ•°è¦å°äº 128 ä¸ªã€‚</li></ol><p>å½“ä¸¤è€…éƒ½ä¸æ»¡è¶³æ—¶ï¼Œä¼šé‡‡ç”¨è·³è¡¨è¿™æ ·çš„æ•°æ®ç»“æ„æ¥å­˜å‚¨ã€‚é€šè¿‡å¾—åˆ†çš„å¤§å°ï¼Œæˆ‘ä»¬å°†æ•°æ®ç»„ç»‡æˆè·³è¡¨è¿™æ ·çš„æ•°æ®ç»“æ„ï¼Œä»¥æ”¯æŒå¿«é€Ÿåœ°æŒ‰ç…§å¾—åˆ†å€¼ã€å¾—åˆ†åŒºé—´è·å–æ•°æ®ã€‚</p><h2 id="ä¸€äº›é«˜çº§å‘½ä»¤"><a href="#ä¸€äº›é«˜çº§å‘½ä»¤" class="headerlink" title="ä¸€äº›é«˜çº§å‘½ä»¤"></a>ä¸€äº›é«˜çº§å‘½ä»¤</h2><ul><li>keysï¼šå…¨é‡éå†é”®ï¼Œç”¨æ¥åˆ—å‡ºæ‰€æœ‰æ»¡è¶³ç‰¹å®šæ­£åˆ™å­—ç¬¦ä¸²è§„åˆ™çš„keyï¼Œå½“redisæ•°æ®é‡æ¯”è¾ƒå¤§æ—¶ï¼Œæ€§èƒ½æ¯”è¾ƒå·®ï¼Œè¦é¿å…ä½¿ç”¨</li></ul><ul><li><p>scanï¼šæ¸è¿›å¼éå†é”®ï¼Œscan å‚æ•°æä¾›äº†ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯ cursor æ•´æ•°å€¼ï¼Œç¬¬äºŒä¸ªæ˜¯ key çš„æ­£åˆ™æ¨¡å¼ï¼Œç¬¬ä¸‰ä¸ªæ˜¯éå†çš„ limit hintã€‚ç¬¬ä¸€æ¬¡éå†æ—¶ï¼Œcursor å€¼ä¸º 0ï¼Œç„¶åå°†è¿”å›ç»“æœä¸­ç¬¬ä¸€ä¸ªæ•´æ•°å€¼ä½œä¸ºä¸‹ä¸€æ¬¡éå†çš„ cursorã€‚ä¸€ç›´éå†åˆ°è¿”å›çš„ cursor å€¼ä¸º 0 æ—¶ç»“æŸã€‚</p></li><li><p>Infoï¼šæŸ¥çœ‹redisæœåŠ¡è¿è¡Œä¿¡æ¯ï¼Œåˆ†ä¸º 9 å¤§å—ï¼Œæ¯ä¸ªå—éƒ½æœ‰éå¸¸å¤šçš„å‚æ•°ï¼Œè¿™ 9 ä¸ªå—åˆ†åˆ«æ˜¯: </p><blockquote><p>Server æœåŠ¡å™¨è¿è¡Œçš„ç¯å¢ƒå‚æ•°<br>  Clients å®¢æˆ·ç«¯ç›¸å…³ä¿¡æ¯<br>  Memory æœåŠ¡å™¨è¿è¡Œå†…å­˜ç»Ÿè®¡æ•°æ®<br>  Persistence æŒä¹…åŒ–ä¿¡æ¯<br>  Stats é€šç”¨ç»Ÿè®¡æ•°æ®<br>  Replication ä¸»ä»å¤åˆ¶ç›¸å…³ä¿¡æ¯<br>  CPU CPU ä½¿ç”¨æƒ…å†µ<br>  Cluster é›†ç¾¤ä¿¡æ¯ </p></blockquote></li></ul><h2 id="äºŒã€çº¿ç¨‹æ¨¡å‹æ ¸å¿ƒåŸç†"><a href="#äºŒã€çº¿ç¨‹æ¨¡å‹æ ¸å¿ƒåŸç†" class="headerlink" title="äºŒã€çº¿ç¨‹æ¨¡å‹æ ¸å¿ƒåŸç†"></a>äºŒã€çº¿ç¨‹æ¨¡å‹æ ¸å¿ƒåŸç†</h2><p>Redisçš„å•çº¿ç¨‹å’Œé«˜æ€§èƒ½</p><p>Redis å•çº¿ç¨‹ä¸ºä»€ä¹ˆè¿˜èƒ½è¿™ä¹ˆå¿«ï¼Ÿ</p><blockquote><p>å› ä¸ºå®ƒæ‰€æœ‰çš„æ•°æ®éƒ½åœ¨å†…å­˜ä¸­ï¼Œæ‰€æœ‰çš„è¿ç®—éƒ½æ˜¯å†…å­˜çº§åˆ«çš„è¿ç®—ï¼Œè€Œä¸”å•çº¿ç¨‹é¿å…äº†å¤šçº¿ç¨‹çš„åˆ‡æ¢æ€§èƒ½æŸè€—é—®é¢˜ã€‚æ­£å› ä¸º Redis æ˜¯å•çº¿ç¨‹ï¼Œæ‰€ä»¥è¦å°å¿ƒä½¿ç”¨ Redis æŒ‡ä»¤ï¼Œå¯¹äºé‚£äº›è€—æ—¶çš„æŒ‡ä»¤(æ¯”å¦‚keys)ï¼Œä¸€å®šè¦è°¨æ…ä½¿ç”¨ï¼Œä¸€ä¸å°å¿ƒå°±å¯èƒ½ä¼šå¯¼è‡´ Redis å¡é¡¿ã€‚ </p></blockquote><p>Redis å•çº¿ç¨‹å¦‚ä½•å¤„ç†é‚£ä¹ˆå¤šçš„å¹¶å‘å®¢æˆ·ç«¯è¿æ¥ï¼Ÿ</p><blockquote><p>Redisçš„IOå¤šè·¯å¤ç”¨ï¼šredisåˆ©ç”¨epollæ¥å®ç°IOå¤šè·¯å¤ç”¨ï¼Œå°†è¿æ¥ä¿¡æ¯å’Œäº‹ä»¶æ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œä¾æ¬¡æ”¾åˆ°æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ï¼Œäº‹ä»¶åˆ†æ´¾å™¨å°†äº‹ä»¶åˆ†å‘ç»™äº‹ä»¶å¤„ç†å™¨ã€‚</p></blockquote><p>Nginxä¹Ÿæ˜¯é‡‡ç”¨IOå¤šè·¯å¤ç”¨åŸç†è§£å†³C10Ké—®é¢˜</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/F5F6FED5FA534F7CA467AD6D634E8E49.jpg" alt="image"></p><h2 id="ä¸‰ã€æŒä¹…åŒ–"><a href="#ä¸‰ã€æŒä¹…åŒ–" class="headerlink" title="ä¸‰ã€æŒä¹…åŒ–"></a>ä¸‰ã€æŒä¹…åŒ–</h2><h3 id="RDBå¿«ç…§ï¼ˆsnapshotï¼‰"><a href="#RDBå¿«ç…§ï¼ˆsnapshotï¼‰" class="headerlink" title="RDBå¿«ç…§ï¼ˆsnapshotï¼‰"></a>RDBå¿«ç…§ï¼ˆsnapshotï¼‰</h3><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ Redis å°†å†…å­˜æ•°æ®åº“å¿«ç…§ä¿å­˜åœ¨åå­—ä¸º dump.rdb çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚<br>ä½ å¯ä»¥å¯¹ Redis è¿›è¡Œè®¾ç½®ï¼Œ è®©å®ƒåœ¨â€œNç§’å†…æ•°æ®é›†è‡³å°‘æœ‰ M ä¸ªæ”¹åŠ¨â€è¿™ä¸€æ¡ä»¶è¢«æ»¡è¶³æ—¶ï¼Œ è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡æ•°æ®é›†ã€‚<br>æ¯”å¦‚è¯´ï¼Œ ä»¥ä¸‹è®¾ç½®ä¼šè®© Redis åœ¨æ»¡è¶³â€œ 60 ç§’å†…æœ‰è‡³å°‘æœ‰ 1000 ä¸ªé”®è¢«æ”¹åŠ¨â€è¿™ä¸€æ¡ä»¶æ—¶ï¼Œ è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡æ•°æ®é›†ï¼š</p><blockquote><p> save 60 1000</p></blockquote><h3 id="AOFï¼ˆappend-only-fileï¼‰"><a href="#AOFï¼ˆappend-only-fileï¼‰" class="headerlink" title="AOFï¼ˆappend-only fileï¼‰"></a>AOFï¼ˆappend-only fileï¼‰</h3><p>å¿«ç…§åŠŸèƒ½å¹¶ä¸æ˜¯éå¸¸è€ä¹…ï¼ˆdurableï¼‰ï¼š å¦‚æœ Redis å› ä¸ºæŸäº›åŸå› è€Œé€ æˆæ•…éšœåœæœºï¼Œ é‚£ä¹ˆæœåŠ¡å™¨å°†ä¸¢å¤±æœ€è¿‘å†™å…¥ã€ä¸”ä»æœªä¿å­˜åˆ°å¿«ç…§ä¸­çš„é‚£äº›æ•°æ®ã€‚ä» 1.1 ç‰ˆæœ¬å¼€å§‹ï¼Œ Redis å¢åŠ äº†ä¸€ç§å®Œå…¨è€ä¹…çš„æŒä¹…åŒ–æ–¹å¼ï¼š AOF æŒä¹…åŒ–ï¼Œå°†ä¿®æ”¹çš„æ¯ä¸€æ¡æŒ‡ä»¤è®°å½•è¿›æ–‡ä»¶<br>ä½ å¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶æ¥æ‰“å¼€ AOF åŠŸèƒ½ï¼š</p><blockquote><p>appendonly yes</p></blockquote><p>ä»ç°åœ¨å¼€å§‹ï¼Œ æ¯å½“ Redis æ‰§è¡Œä¸€ä¸ªæ”¹å˜æ•°æ®é›†çš„å‘½ä»¤æ—¶ï¼ˆæ¯”å¦‚ SETï¼‰ï¼Œ è¿™ä¸ªå‘½ä»¤å°±ä¼šè¢«è¿½åŠ åˆ° AOF æ–‡ä»¶çš„æœ«å°¾ã€‚<br>è¿™æ ·çš„è¯ï¼Œ å½“ Redis é‡æ–°å¯æ—¶ï¼Œ ç¨‹åºå°±å¯ä»¥é€šè¿‡é‡æ–°æ‰§è¡Œ AOF æ–‡ä»¶ä¸­çš„å‘½ä»¤æ¥è¾¾åˆ°é‡å»ºæ•°æ®é›†çš„ç›®çš„ã€‚<br>ä½ å¯ä»¥é…ç½® Redis å¤šä¹…æ‰å°†æ•°æ® fsync åˆ°ç£ç›˜ä¸€æ¬¡ã€‚</p><p>æœ‰ä¸‰ä¸ªé€‰é¡¹ï¼š</p><ol><li>æ¯æ¬¡æœ‰æ–°å‘½ä»¤è¿½åŠ åˆ° AOF æ–‡ä»¶æ—¶å°±æ‰§è¡Œä¸€æ¬¡ fsyncï¼šéå¸¸æ…¢ï¼Œä¹Ÿéå¸¸å®‰å…¨ã€‚</li><li>æ¯ç§’ fsync ä¸€æ¬¡ï¼šè¶³å¤Ÿå¿«ï¼ˆå’Œä½¿ç”¨ RDB æŒä¹…åŒ–å·®ä¸å¤šï¼‰ï¼Œå¹¶ä¸”åœ¨æ•…éšœæ—¶åªä¼šä¸¢å¤± 1 ç§’é’Ÿçš„æ•°æ®ã€‚</li><li>ä»ä¸ fsync ï¼šå°†æ•°æ®äº¤ç»™æ“ä½œç³»ç»Ÿæ¥å¤„ç†ã€‚æ›´å¿«ï¼Œä¹Ÿæ›´ä¸å®‰å…¨çš„é€‰æ‹©ã€‚<br>æ¨èï¼ˆå¹¶ä¸”ä¹Ÿæ˜¯é»˜è®¤ï¼‰çš„æªæ–½ä¸ºæ¯ç§’ fsyncä¸€æ¬¡ï¼Œ è¿™ç§ fsync ç­–ç•¥å¯ä»¥å…¼é¡¾é€Ÿåº¦å’Œå®‰å…¨æ€§ã€‚ </li></ol><h3 id="RDB-å’Œ-AOF-ï¼Œæˆ‘åº”è¯¥ç”¨å“ªä¸€ä¸ªï¼Ÿ"><a href="#RDB-å’Œ-AOF-ï¼Œæˆ‘åº”è¯¥ç”¨å“ªä¸€ä¸ªï¼Ÿ" class="headerlink" title="RDB å’Œ AOF ï¼Œæˆ‘åº”è¯¥ç”¨å“ªä¸€ä¸ªï¼Ÿ"></a>RDB å’Œ AOF ï¼Œæˆ‘åº”è¯¥ç”¨å“ªä¸€ä¸ªï¼Ÿ</h3><p>å¦‚æœä½ éå¸¸å…³å¿ƒä½ çš„æ•°æ®ï¼Œ ä½†ä»ç„¶å¯ä»¥æ‰¿å—æ•°åˆ†é’Ÿä»¥å†…çš„æ•°æ®ä¸¢å¤±ï¼Œ é‚£ä¹ˆä½ å¯ä»¥åªä½¿ç”¨ RDB æŒä¹…åŒ–ã€‚<br>æœ‰å¾ˆå¤šç”¨æˆ·éƒ½åªä½¿ç”¨ AOF æŒä¹…åŒ–ï¼Œ ä½†æˆ‘ä»¬å¹¶ä¸æ¨èè¿™ç§æ–¹å¼ï¼š å› ä¸ºå®šæ—¶ç”Ÿæˆ RDB å¿«ç…§ï¼ˆsnapshotï¼‰éå¸¸ä¾¿äºè¿›è¡Œæ•°æ®åº“å¤‡ä»½ï¼Œ å¹¶ä¸” RDB æ¢å¤æ•°æ®é›†çš„é€Ÿåº¦ä¹Ÿè¦æ¯” AOF æ¢å¤çš„é€Ÿåº¦è¦å¿«ã€‚</p><h3 id="Redis-4-0-æ··åˆæŒä¹…åŒ–"><a href="#Redis-4-0-æ··åˆæŒä¹…åŒ–" class="headerlink" title="Redis 4.0 æ··åˆæŒä¹…åŒ–"></a>Redis 4.0 æ··åˆæŒä¹…åŒ–</h3><p>é‡å¯ Redis æ—¶ï¼Œæˆ‘ä»¬å¾ˆå°‘ä½¿ç”¨ rdb æ¥æ¢å¤å†…å­˜çŠ¶æ€ï¼Œå› ä¸ºä¼šä¸¢å¤±å¤§é‡æ•°æ®ã€‚æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ AOF æ—¥å¿—é‡æ”¾ï¼Œä½†æ˜¯é‡æ”¾ AOF æ—¥å¿—æ€§èƒ½ç›¸å¯¹ rdb æ¥è¯´è¦æ…¢å¾ˆå¤šï¼Œè¿™æ ·åœ¨ Redis å®ä¾‹å¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œå¯åŠ¨éœ€è¦èŠ±è´¹å¾ˆé•¿çš„æ—¶é—´ã€‚ Redis 4.0 ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¸¦æ¥äº†ä¸€ä¸ªæ–°çš„æŒä¹…åŒ–é€‰é¡¹â€”â€”æ··åˆæŒä¹…åŒ–ã€‚AOFåœ¨é‡å†™(aofæ–‡ä»¶é‡Œå¯èƒ½æœ‰å¤ªå¤šæ²¡ç”¨æŒ‡ä»¤ï¼Œæ‰€ä»¥aofä¼šå®šæœŸæ ¹æ®å†…å­˜çš„æœ€æ–°æ•°æ®ç”Ÿæˆaofæ–‡ä»¶)æ—¶å°†é‡å†™è¿™ä¸€åˆ»ä¹‹å‰çš„å†…å­˜rdbå¿«ç…§æ–‡ä»¶çš„å†…å®¹å’Œå¢é‡çš„ AOFä¿®æ”¹å†…å­˜æ•°æ®çš„å‘½ä»¤æ—¥å¿—æ–‡ä»¶å­˜åœ¨ä¸€èµ·ï¼Œéƒ½å†™å…¥æ–°çš„aofæ–‡ä»¶ï¼Œæ–°çš„æ–‡ä»¶ä¸€å¼€å§‹ä¸å«appendonly.aofï¼Œç­‰åˆ°é‡å†™å®Œæ–°çš„AOFæ–‡ä»¶æ‰ä¼šè¿›è¡Œæ”¹åï¼ŒåŸå­çš„è¦†ç›–åŸæœ‰çš„AOFæ–‡ä»¶ï¼Œå®Œæˆæ–°æ—§ä¸¤ä¸ªAOFæ–‡ä»¶çš„æ›¿æ¢ï¼›<br>AOFæ ¹æ®é…ç½®è§„åˆ™åœ¨åå°è‡ªåŠ¨é‡å†™ï¼Œä¹Ÿå¯ä»¥äººä¸ºæ‰§è¡Œå‘½ä»¤bgrewriteaofé‡å†™AOFã€‚ äºæ˜¯åœ¨ Redis é‡å¯çš„æ—¶å€™ï¼Œå¯ä»¥å…ˆåŠ è½½ rdb çš„å†…å®¹ï¼Œç„¶åå†é‡æ”¾å¢é‡ AOF æ—¥å¿—å°±å¯ä»¥å®Œå…¨æ›¿ä»£ä¹‹å‰çš„ AOF å…¨é‡æ–‡ä»¶é‡æ”¾ï¼Œé‡å¯æ•ˆç‡å› æ­¤å¤§å¹…å¾—åˆ°æå‡ã€‚</p><p>å¼€å¯æ··åˆæŒä¹…åŒ–ï¼š</p><blockquote><p>aof-use-rdb-preamble yes   </p></blockquote><p>æ··åˆæŒä¹…åŒ–aofæ–‡ä»¶ç»“æ„</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/00BB6062917B4FC4A6F72ADD90007BB4.jpg" alt="image"></p><h2 id="å››ã€ç¼“å­˜æ·˜æ±°ç­–ç•¥"><a href="#å››ã€ç¼“å­˜æ·˜æ±°ç­–ç•¥" class="headerlink" title="å››ã€ç¼“å­˜æ·˜æ±°ç­–ç•¥"></a>å››ã€ç¼“å­˜æ·˜æ±°ç­–ç•¥</h2><p>å½“ Redis å†…å­˜è¶…å‡ºç‰©ç†å†…å­˜é™åˆ¶æ—¶ï¼Œå†…å­˜çš„æ•°æ®ä¼šå¼€å§‹å’Œç£ç›˜äº§ç”Ÿé¢‘ç¹çš„äº¤æ¢ (swap)ã€‚äº¤æ¢ä¼šè®© Redis çš„æ€§èƒ½æ€¥å‰§ä¸‹é™ï¼Œå¯¹äºè®¿é—®é‡æ¯”è¾ƒé¢‘ç¹çš„ Redis æ¥è¯´ï¼Œè¿™æ ·é¾Ÿé€Ÿçš„å­˜å–æ•ˆç‡åŸºæœ¬ä¸Šç­‰äºä¸å¯ç”¨ã€‚<br>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä»¬æ˜¯ä¸å…è®¸ Redis å‡ºç°äº¤æ¢è¡Œä¸ºçš„ï¼Œä¸ºäº†é™åˆ¶æœ€å¤§ä½¿ç”¨å†…å­˜ï¼ŒRedis æä¾›äº†é…ç½®å‚æ•° maxmemory æ¥é™åˆ¶å†…å­˜è¶…å‡ºæœŸæœ›å¤§å°ã€‚<br>å½“å®é™…å†…å­˜è¶…å‡º maxmemory æ—¶ï¼ŒRedis æä¾›äº†å‡ ç§å¯é€‰ç­–ç•¥ (maxmemory-policy) æ¥è®©ç”¨æˆ·è‡ªå·±å†³å®šè¯¥å¦‚ä½•è…¾å‡ºæ–°çš„ç©ºé—´ä»¥ç»§ç»­æä¾›è¯»å†™æœåŠ¡ã€‚</p><ul><li>noeviction ä¸ä¼šç»§ç»­æœåŠ¡å†™è¯·æ±‚ (DEL è¯·æ±‚å¯ä»¥ç»§ç»­æœåŠ¡)ï¼Œè¯»è¯·æ±‚å¯ä»¥ç»§ç»­è¿›è¡Œã€‚è¿™æ ·å¯ä»¥ä¿è¯ä¸ä¼šä¸¢å¤±æ•°æ®ï¼Œä½†æ˜¯ä¼šè®©çº¿ä¸Šçš„ä¸šåŠ¡ä¸èƒ½æŒç»­è¿›è¡Œã€‚è¿™æ˜¯é»˜è®¤çš„æ·˜æ±°ç­–ç•¥ã€‚</li><li>volatile-lru å°è¯•æ·˜æ±°è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ keyï¼Œæœ€å°‘ä½¿ç”¨çš„ key ä¼˜å…ˆè¢«æ·˜æ±°ã€‚æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´çš„ key ä¸ä¼šè¢«æ·˜æ±°ï¼Œè¿™æ ·å¯ä»¥ä¿è¯éœ€è¦æŒä¹…åŒ–çš„æ•°æ®ä¸ä¼šçªç„¶ä¸¢å¤±ã€‚</li><li>volatile-ttl è·Ÿä¸Šé¢ä¸€æ ·ï¼Œé™¤äº†æ·˜æ±°çš„ç­–ç•¥ä¸æ˜¯ LRUï¼Œè€Œæ˜¯ key çš„å‰©ä½™å¯¿å‘½ ttl çš„å€¼ï¼Œttl è¶Šå°è¶Šä¼˜å…ˆè¢«æ·˜æ±°ã€‚</li><li>volatile-random è·Ÿä¸Šé¢ä¸€æ ·ï¼Œä¸è¿‡æ·˜æ±°çš„ key æ˜¯è¿‡æœŸ key é›†åˆä¸­éšæœºçš„ keyã€‚</li><li>allkeys-lru åŒºåˆ«äº volatile-lruï¼Œè¿™ä¸ªç­–ç•¥è¦æ·˜æ±°çš„ key å¯¹è±¡æ˜¯å…¨ä½“çš„ key é›†åˆï¼Œè€Œä¸åªæ˜¯è¿‡æœŸçš„ key é›†åˆã€‚è¿™æ„å‘³ç€æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´çš„ key ä¹Ÿä¼šè¢«æ·˜æ±°ã€‚</li><li>allkeys-random è·Ÿä¸Šé¢ä¸€æ ·ï¼Œä¸è¿‡æ·˜æ±°çš„ç­–ç•¥æ˜¯éšæœºçš„ keyã€‚</li></ul><blockquote><p>volatile-xxx ç­–ç•¥åªä¼šé’ˆå¯¹å¸¦è¿‡æœŸæ—¶é—´çš„ key è¿›è¡Œæ·˜æ±°ï¼Œallkeys-xxx ç­–ç•¥ä¼šå¯¹æ‰€æœ‰çš„ key è¿›è¡Œæ·˜æ±°ã€‚å¦‚æœä½ åªæ˜¯æ‹¿ Redis åšç¼“å­˜ï¼Œé‚£åº”è¯¥ä½¿ç”¨ allkeys-xxxï¼Œå®¢æˆ·ç«¯å†™ç¼“å­˜æ—¶ä¸å¿…æºå¸¦è¿‡æœŸæ—¶é—´ã€‚å¦‚æœä½ è¿˜æƒ³åŒæ—¶ä½¿ç”¨ Redis çš„æŒä¹…åŒ–åŠŸèƒ½ï¼Œé‚£å°±ä½¿ç”¨ volatile-xxx ç­–ç•¥ï¼Œè¿™æ ·å¯ä»¥ä¿ç•™æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´çš„ keyï¼Œå®ƒä»¬æ˜¯æ°¸ä¹…çš„ key ä¸ä¼šè¢« LRU ç®—æ³•æ·˜æ±°ã€‚</p></blockquote><h2 id="äº”ã€Redisé›†ç¾¤åŸç†åˆ†æ"><a href="#äº”ã€Redisé›†ç¾¤åŸç†åˆ†æ" class="headerlink" title="äº”ã€Redisé›†ç¾¤åŸç†åˆ†æ"></a>äº”ã€Redisé›†ç¾¤åŸç†åˆ†æ</h2><p>redis cluster æ˜¯ redis åˆ†å¸ƒå¼é›†ç¾¤è§£å†³æ–¹æ¡ˆï¼Œä» 3.0 ä¹‹åæ¨å‡ºè§£å†³ redis åˆ†å¸ƒå¼æ–¹é¢éœ€æ±‚ï¼Œå®ç°æ•°æ®åˆ†ç‰‡ã€æ•…éšœè½¬ç§»ã€æ‰©å®¹æ‰€å®¹æœºåˆ¶ç­‰ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/7EDE606229F6415BBA9A4C7A9FB975FB.jpg" alt="image"></p><p>Redis Cluster å°†æ‰€æœ‰æ•°æ®åˆ’åˆ†ä¸º 16384 çš„ slots(æ§½ä½)ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£å…¶ä¸­ä¸€éƒ¨åˆ†æ§½ ä½ã€‚æ§½ä½çš„ä¿¡æ¯å­˜å‚¨äºæ¯ä¸ªèŠ‚ç‚¹ä¸­ã€‚ å½“ Redis Cluster çš„å®¢æˆ·ç«¯æ¥è¿æ¥é›†ç¾¤æ—¶ï¼Œå®ƒä¹Ÿä¼šå¾—åˆ°ä¸€ä»½é›†ç¾¤çš„æ§½ä½é…ç½®ä¿¡æ¯å¹¶å°† å…¶ç¼“å­˜åœ¨å®¢æˆ·ç«¯æœ¬åœ°ã€‚è¿™æ ·å½“å®¢æˆ·ç«¯è¦æŸ¥æ‰¾æŸä¸ª key æ—¶ï¼Œå¯ä»¥ç›´æ¥å®šä½åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚ åŒæ—¶å› ä¸ºæ§½ä½çš„ä¿¡æ¯å¯èƒ½ä¼šå­˜åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¸ä¸€è‡´çš„æƒ…å†µï¼Œè¿˜éœ€è¦çº æ­£æœºåˆ¶æ¥å® ç°æ§½ä½ä¿¡æ¯çš„æ ¡éªŒè°ƒæ•´ã€‚</p><ul><li>redisé›†ç¾¤å¤§å°çš„é€‰æ‹©,å¯ä»¥è£…å¤šå°‘æ•°æ®?<blockquote><p>ç†è®ºæ˜¯å¯ä»¥åšåˆ°16384ä¸ªé›†ç¾¤,æ¯ä¸ªæ§½å¯¹åº”ä¸€ä¸ªå®ä¾‹,ä½†æ˜¯rediså®˜æ–¹å»ºè®®æ˜¯æœ€å¤§1000ä¸ªå®ä¾‹ã€‚å­˜å‚¨è¶³å¤Ÿå¤§äº†ã€‚å¦å¤–ï¼šèŠ‚ç‚¹ä¹‹é—´ä¼šæœ‰é¢‘ç¹é€šä¿¡ï¼Œä¼ é€’çš„åŒ…æ‹¬æ§½ä½ä¿¡æ¯ï¼Œé›†ç¾¤å¤ªå¤§ä¼šæœ‰å¸¦å®½æ¶ˆè€—ã€‚</p></blockquote></li></ul><h3 id="æ§½ä½å®šä½ç®—æ³•"><a href="#æ§½ä½å®šä½ç®—æ³•" class="headerlink" title="æ§½ä½å®šä½ç®—æ³•"></a>æ§½ä½å®šä½ç®—æ³•</h3><p>æ§½ä½å®šä½ç®—æ³• ä¹Ÿå°±æ˜¯å¸¸è¯´çš„ ä¸€è‡´æ€§Hashç®—æ³•<br>Cluster é»˜è®¤ä¼šå¯¹ key å€¼ä½¿ç”¨ crc16 ç®—æ³•è¿›è¡Œ hash å¾—åˆ°ä¸€ä¸ªæ•´æ•°å€¼ï¼Œç„¶åç”¨è¿™ä¸ªæ•´ æ•°å€¼å¯¹ 16384 è¿›è¡Œå–æ¨¡æ¥å¾—åˆ°å…·ä½“æ§½ä½ã€‚ HASH_SLOT = CRC16(key) mod 16384</p><ul><li>é‚£ä¹ˆå¢åŠ äº†slotæ§½çš„è®¡ç®—,æ˜¯ä¸æ˜¯æ¯”å•æœºæ€§èƒ½å·®?<blockquote><p>å…±16384ä¸ªæ§½, slotsæ§½è®¡ç®—æ–¹å¼å…¬å¼€çš„,<br>ä¸ºäº†é¿å…æ¯æ¬¡éƒ½éœ€è¦æœåŠ¡å™¨è®¡ç®—é‡å®šå‘,ä¼˜ç§€çš„javaå®¢æˆ·ç«¯éƒ½å®ç°äº†æœ¬åœ°è®¡ç®—,å¹¶ä¸”ç¼“å­˜æœåŠ¡å™¨slotsåˆ†é…,æœ‰å˜åŠ¨æ—¶å†æ›´æ–°æœ¬åœ°å†…å®¹,ä»è€Œé¿å…äº†å¤šæ¬¡é‡å®šå‘å¸¦æ¥çš„æ€§èƒ½æŸè€—</p></blockquote></li></ul><ul><li>è®¿é—®å€¾æ–œå’Œæ•°æ®å­˜å‚¨å€¾æ–œé—®é¢˜æ€ä¹ˆå¤„ç†ï¼Ÿ<blockquote><p>å€¾æ–œå¯¼è‡´æŸäº›èŠ‚ç‚¹é‡å¤§ï¼Œå‹åŠ›å¤§ å¯ä»¥ä»ä¸¤æ–¹é¢ç€æ‰‹</p><ol><li>äº‹å‰é¢„æµ‹æ•°æ®å“ªäº›ä¼šæ˜¯çƒ­ç‚¹æ•°æ®ï¼Œè®¾è®¡çš„æ—¶å€™è§„é¿ã€‚</li><li>äº‹å é€šè¿‡ slot è°ƒæ•´ï¼Œå‹åŠ›åˆ†æ‘Šï¼ˆslot è°ƒæ•´ï¼šrebalance å’Œ resharedï¼‰</li></ol></blockquote></li></ul><h3 id="è·³è½¬é‡å®šä½"><a href="#è·³è½¬é‡å®šä½" class="headerlink" title="è·³è½¬é‡å®šä½"></a>è·³è½¬é‡å®šä½</h3><p>å½“å®¢æˆ·ç«¯å‘ä¸€ä¸ªé”™è¯¯çš„èŠ‚ç‚¹å‘å‡ºäº†æŒ‡ä»¤ï¼Œè¯¥èŠ‚ç‚¹ä¼šå‘ç°æŒ‡ä»¤çš„ key æ‰€åœ¨çš„æ§½ä½å¹¶ä¸å½’ è‡ªå·±ç®¡ç†ï¼Œè¿™æ—¶å®ƒä¼šå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªç‰¹æ®Šçš„è·³è½¬æŒ‡ä»¤æºå¸¦ç›®æ ‡æ“ä½œçš„èŠ‚ç‚¹åœ°å€ï¼Œå‘Š è¯‰å®¢æˆ·ç«¯å»è¿è¿™ä¸ªèŠ‚ç‚¹å»è·å–æ•°æ®ã€‚å®¢æˆ·ç«¯æ”¶åˆ°æŒ‡ä»¤åé™¤äº†è·³è½¬åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ä¸Šå»æ“ ä½œï¼Œè¿˜ä¼šåŒæ­¥æ›´æ–°çº æ­£æœ¬åœ°çš„æ§½ä½æ˜ å°„è¡¨ç¼“å­˜ï¼Œåç»­æ‰€æœ‰ key å°†ä½¿ç”¨æ–°çš„æ§½ä½æ˜ å°„ è¡¨ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/brokge/drawio/img/F13207F13DBB421EAD5B865697A65B79.jpg" alt="image"></p><ul><li>askå’Œmovedé‡å®šå‘çš„åŒºåˆ«<blockquote><p>é‡å®šå‘åŒ…æ‹¬ä¸¤ç§æƒ…å†µ,è‹¥ç¡®å®šslotä¸å±äºå½“å‰èŠ‚ç‚¹, redisä¼šè¿”å›moved<br>,è‹¥å½“ç…redisèŠ‚ç‚¹æ­£åœ¨å¤„ç†slotè¿ç§»,åˆ™ä»£è¡¨æ­¤å¤„è¯·æ±‚å¯¹åº”çš„keyæš‚æ—¶ä¸åœ¨æ­¤èŠ‚å®šå‘ã€‚</p></blockquote></li></ul><h3 id="ç½‘ç»œæŠ–åŠ¨"><a href="#ç½‘ç»œæŠ–åŠ¨" class="headerlink" title="ç½‘ç»œæŠ–åŠ¨"></a>ç½‘ç»œæŠ–åŠ¨</h3><p>çœŸå®ä¸–ç•Œçš„æœºæˆ¿ç½‘ç»œå¾€å¾€å¹¶ä¸æ˜¯é£å¹³æµªé™çš„ï¼Œå®ƒä»¬ç»å¸¸ä¼šå‘ç”Ÿå„ç§å„æ ·çš„å°é—®é¢˜ã€‚æ¯” å¦‚ç½‘ç»œæŠ–åŠ¨å°±æ˜¯éå¸¸å¸¸è§çš„ä¸€ç§ç°è±¡ï¼Œçªç„¶ä¹‹é—´éƒ¨åˆ†è¿æ¥å˜å¾—ä¸å¯è®¿é—®ï¼Œç„¶åå¾ˆå¿«åˆ æ¢å¤æ­£å¸¸ã€‚ ä¸ºè§£å†³è¿™ç§é—®é¢˜ï¼ŒRedis Cluster æä¾›äº†ä¸€ç§é€‰é¡¹cluster node timeoutï¼Œè¡¨ç¤ºå½“æŸ ä¸ªèŠ‚ç‚¹æŒç»­ timeout çš„æ—¶é—´å¤±è”æ—¶ï¼Œæ‰å¯ä»¥è®¤å®šè¯¥èŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œéœ€è¦è¿›è¡Œä¸»ä»åˆ‡ æ¢ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªé€‰é¡¹ï¼Œç½‘ç»œæŠ–åŠ¨ä¼šå¯¼è‡´ä¸»ä»é¢‘ç¹åˆ‡æ¢ (æ•°æ®çš„é‡æ–°å¤åˆ¶)ã€‚</p><h3 id="ä¸»ä»åˆ‡æ¢-é€‰ä¸¾åŸç†"><a href="#ä¸»ä»åˆ‡æ¢-é€‰ä¸¾åŸç†" class="headerlink" title="ä¸»ä»åˆ‡æ¢ é€‰ä¸¾åŸç†"></a>ä¸»ä»åˆ‡æ¢ é€‰ä¸¾åŸç†</h3><p>Redis é›†ç¾¤ä½¿ç”¨ä¸€ä¸ªç±»ä¼¼äºæœ¨ç­ç®—æ³•ï¼ˆRaft algorithmï¼‰æ¦‚å¿µã€‚å¦‚æœæ²¡æœ‰äº†è§£è¿‡å¯ä»¥çœ‹çœ‹è¿™ä¸ª  <a href="http://thesecretlivesofdata.com/raft/">Raft</a>, åœ¨ Redis é›†ç¾¤ä¸­è¿™ä¸ªæœ¯è¯­å«åš é˜¶æ®µï¼ˆepochï¼‰ã€‚</p><p>Redis é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ï¼ŒåŒ…æ‹¬ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ï¼Œéƒ½åœ¨åˆ›å»ºçš„æ—¶å€™è®¾ç½®äº† currentEpoch ä¸º0ã€‚æ¯æ¬¡ä¸»ä»é€‰ä¸¾ä¹‹å Epoch ä¼šç›¸åº”çš„åŠ  1ã€‚å¦‚æœå‡ºç°è„‘è£‚çš„æƒ…å†µï¼Œå…¶ä»–ä¸»èŠ‚ç‚¹åªè®¤ epoch æœ€å¤§çš„é‚£ä¸ªã€‚</p><p>Redisé›†ç¾¤é€‰ä¸¾åŸç†åˆ†æå½“ slave å‘ç°è‡ªå·±çš„ master å˜ä¸ºFAILçŠ¶æ€æ—¶ï¼Œä¾¿å°è¯•è¿›è¡Œ Failoverï¼Œä»¥æœŸæˆä¸ºæ–°çš„ masterã€‚ç”±äºæŒ‚æ‰çš„master å¯èƒ½ä¼šæœ‰å¤šä¸ª slaveï¼Œä»è€Œå­˜åœ¨å¤šä¸ª slave ç«äº‰æˆä¸º masterèŠ‚ç‚¹çš„è¿‡ç¨‹ï¼Œ å…¶è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>slave å‘ç°è‡ªå·±çš„ masterå˜ä¸ºFAIL</li><li>å°†è‡ªå·±è®°å½•çš„é›†ç¾¤currentEpochï¼ˆå¹´ä»£ï¼Œçºªå…ƒï¼‰åŠ  1ï¼Œå¹¶å¹¿æ’­FAILOVER_AUTH_REQUEST ä¿¡æ¯</li><li>å…¶ä»–èŠ‚ç‚¹æ”¶åˆ°è¯¥ä¿¡æ¯ï¼Œåªæœ‰masterå“åº”ï¼Œåˆ¤æ–­è¯·æ±‚è€…çš„åˆæ³•æ€§ï¼Œå¹¶å‘é€FAILOVER_AUTH_ACKï¼Œå¯¹æ¯ä¸€ä¸ªepochåªå‘é€ä¸€æ¬¡ack</li><li>å°è¯•failoverçš„slaveæ”¶é›†FAILOVER_AUTH_ACK</li><li>è¶…è¿‡åŠæ•°åå˜æˆæ–°Master</li><li>å¹¿æ’­ Pong é€šçŸ¥å…¶ä»–é›†ç¾¤èŠ‚ç‚¹ã€‚</li></ol><p>ä»èŠ‚ç‚¹å¹¶ä¸æ˜¯åœ¨ä¸»èŠ‚ç‚¹ä¸€è¿›å…¥ FAIL çŠ¶æ€å°±é©¬ä¸Šå°è¯•å‘èµ·é€‰ä¸¾ï¼Œè€Œæ˜¯æœ‰ä¸€å®šå»¶è¿Ÿï¼Œä¸€å®šçš„å»¶è¿Ÿç¡®ä¿æˆ‘ä»¬ç­‰å¾…FAILçŠ¶æ€åœ¨é›†ç¾¤ä¸­ä¼ æ’­ï¼Œslaveå¦‚æœç«‹å³å°è¯•é€‰ä¸¾ï¼Œå…¶å®ƒmastersæˆ–è®¸å°šæœªæ„è¯†åˆ°FAILçŠ¶æ€ï¼Œå¯èƒ½ä¼šæ‹’ç»æŠ•ç¥¨</p><ul><li>å»¶è¿Ÿè®¡ç®—å…¬å¼ï¼š<blockquote><p>DELAY = 500ms + random(0 ~ 500ms) + SLAVE_RANK * 1000ms</p></blockquote></li><li>SLAVE_RANK è¡¨ç¤ºæ­¤slaveå·²ç»ä»masterå¤åˆ¶æ•°æ®çš„æ€»é‡çš„rankã€‚Rankè¶Šå°ä»£è¡¨å·²å¤åˆ¶çš„æ•°æ®è¶Šæ–°ã€‚è¿™ç§æ–¹å¼ä¸‹ï¼ŒæŒæœ‰æœ€æ–°æ•°æ®çš„slaveå°†ä¼šé¦–å…ˆå‘èµ·é€‰ä¸¾ï¼ˆç†è®ºä¸Šï¼‰ã€‚</li></ul><h2 id="å‘å¸ƒè®¢é˜…æœºåˆ¶"><a href="#å‘å¸ƒè®¢é˜…æœºåˆ¶" class="headerlink" title="å‘å¸ƒè®¢é˜…æœºåˆ¶"></a>å‘å¸ƒè®¢é˜…æœºåˆ¶</h2><p>å‘å¸ƒ/è®¢é˜…ï¼ˆPublish/Subscribeï¼‰<br>åœ¨ä¸€ä¸ª Redis é›†ç¾¤ä¸­ï¼Œå®¢æˆ·ç«¯èƒ½è®¢é˜…ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿèƒ½å‘å¸ƒæ¶ˆæ¯ç»™ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ã€‚é›†ç¾¤ä¼šç¡®ä¿å‘å¸ƒçš„æ¶ˆæ¯éƒ½ä¼šæŒ‰éœ€è¿›è¡Œè½¬å‘ã€‚ ç›®å‰çš„å®ç°æ–¹å¼æ˜¯å•çº¯åœ°å‘æ‰€æœ‰èŠ‚ç‚¹å¹¿æ’­æ‰€æœ‰çš„å‘å¸ƒæ¶ˆæ¯ï¼Œåœ¨å°†æ¥çš„å®ç°ä¸­ä¼šç”¨ bloom filters æˆ–å…¶ä»–ç®—æ³•æ¥ä¼˜åŒ–ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="http://redis.cn/topics/cluster-tutorial.html">Redis é›†ç¾¤æ•™ç¨‹</a></li><li>æ•°æ®ç»“æ„ä¸ç®—æ³•</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ä¸€ã€Redis-åŸºç¡€æ•°æ®ç»“æ„&quot;&gt;&lt;a href=&quot;#ä¸€ã€Redis-åŸºç¡€æ•°æ®ç»“æ„&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€Redis åŸºç¡€æ•°æ®ç»“æ„&quot;&gt;&lt;/a&gt;ä¸€ã€Redis åŸºç¡€æ•°æ®ç»“æ„&lt;/h2&gt;&lt;p&gt;Redis æœ‰ 5 ç§åŸºç¡€æ•°æ®ç»“æ„ï¼Œåˆ†åˆ«ä¸ºï¼šstring (å­—ç¬¦ä¸²)ã€list (åˆ—è¡¨)ã€set (é›†åˆ)ã€hash (å“ˆå¸Œ) å’Œ zset (æœ‰åºé›†åˆ)ï¼Œä¸‹é¢å°±è¯¦ç»†è¯´è¯´è¿™å‡ ç§æ•°æ®ç»“æ„ã€‚&lt;br&gt;&lt;img src=&quot;https://cdn.jsdelivr.net/gh/brokge/drawio/img/0A3FCFF09EFA4D6A8B1F6D5CCCF848A8.jpg&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="æ•°æ®åº“" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="ç¼“å­˜" scheme="https://brokge.github.io/tags/%E7%BC%93%E5%AD%98/"/>
    
      <category term="Redis" scheme="https://brokge.github.io/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis5 é›†ç¾¤æ­å»º</title>
    <link href="https://brokge.github.io/2020/02/10/redis5%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"/>
    <id>https://brokge.github.io/2020/02/10/redis5é›†ç¾¤æ­å»º/</id>
    <published>2020-02-10T04:50:24.000Z</published>
    <updated>2020-08-21T04:55:02.810Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1ã€-ç¯å¢ƒä¿¡æ¯"><a href="#1ã€-ç¯å¢ƒä¿¡æ¯" class="headerlink" title="1ã€ ç¯å¢ƒä¿¡æ¯"></a>1ã€ ç¯å¢ƒä¿¡æ¯</h1><pre class="line-numbers language-bash"><code class="language-bash">centos7redis5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><a id="more"></a><h1 id="2ã€æ•´ä½“é›†ç¾¤ä¿¡æ¯"><a href="#2ã€æ•´ä½“é›†ç¾¤ä¿¡æ¯" class="headerlink" title="2ã€æ•´ä½“é›†ç¾¤ä¿¡æ¯"></a>2ã€æ•´ä½“é›†ç¾¤ä¿¡æ¯</h1><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># ä»¥ç›´æ¥åœ¨ä¸€å°æœºå™¨ä¸Šå®ç°ä¸Šè¿°çš„ä¼ªé›†ç¾¤ï¼Œå› ä¸ºç«¯å£å·ç‰¹æ„è®¾ç½®ä¸ºä¸åŒçš„ã€‚</span><span class="token comment" spellcheck="true"># é‡ç‚¹ï¼šä¸è®ºæœºå™¨å¤šå°‘ï¼Œå¯¹äºéƒ¨ç½²è¿‡ç¨‹éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡æ˜¯åœ¨ä¸åŒæœºå™¨å¯åŠ¨redis-serverè€Œå·²</span>192.168.100.242 <span class="token punctuation">(</span>6381- 6386å…±6ä¸ªç«¯å£ï¼‰<span class="token comment" spellcheck="true"># æ³¨æ„äº‹é¡¹ï¼šå¦‚æœä½ çš„æœåŠ¡å™¨æœ‰å¤šä¸ªIPï¼Œé‚£ä½ æ“ä½œä¸‹é¢æ­¥éª¤æ—¶ï¼Œå°½é‡ä½¿ç”¨ä½ çš„å®¢æˆ·ç«¯èƒ½å¤Ÿè®¿é—®çš„IP</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h1 id="3ã€æ¯å°æœåŠ¡å™¨ä¸Šé¢éƒ½è¦ä¸‹è½½å®‰è£…"><a href="#3ã€æ¯å°æœåŠ¡å™¨ä¸Šé¢éƒ½è¦ä¸‹è½½å®‰è£…" class="headerlink" title="3ã€æ¯å°æœåŠ¡å™¨ä¸Šé¢éƒ½è¦ä¸‹è½½å®‰è£…"></a>3ã€æ¯å°æœåŠ¡å™¨ä¸Šé¢éƒ½è¦ä¸‹è½½å®‰è£…</h1><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">wget</span> http://download.redis.io/releases/redis-5.0.3.tar.gz<span class="token function">tar</span> -zxvf redis-5.0.3.tar.gz<span class="token function">cd</span> redis-5.0.3 <span class="token function">make</span><span class="token comment" spellcheck="true"># å®‰è£…åˆ° /usr/local/redis ç›®å½•ä¸­ å®‰è£…çš„æ–‡ä»¶åªæœ‰ä¸€ä¸ªbinç›®å½•</span><span class="token function">make</span> <span class="token function">install</span> PREFIX<span class="token operator">=</span>/usr/local/redis/ <span class="token comment" spellcheck="true"># åˆ›å»ºé…ç½®æ–‡ä»¶å’Œdataå­˜æ”¾ç›®å½•</span><span class="token function">mkdir</span> /usr/local/redis/conf /usr/local/redis/data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="4ã€å‡†å¤‡6ä¸ªredis-confé…ç½®æ–‡ä»¶ï¼ˆä¸ºäº†æ–¹ä¾¿å­¦ä¹ ï¼Œredis-confæ ¹æ®ä¸åŒç«¯å£æ¥å‘½åï¼Œæ–¹ä¾¿ä¸€å°æœºå™¨ä¸Šæ„å»ºä¼ªé›†ç¾¤ï¼‰"><a href="#4ã€å‡†å¤‡6ä¸ªredis-confé…ç½®æ–‡ä»¶ï¼ˆä¸ºäº†æ–¹ä¾¿å­¦ä¹ ï¼Œredis-confæ ¹æ®ä¸åŒç«¯å£æ¥å‘½åï¼Œæ–¹ä¾¿ä¸€å°æœºå™¨ä¸Šæ„å»ºä¼ªé›†ç¾¤ï¼‰" class="headerlink" title="4ã€å‡†å¤‡6ä¸ªredis.confé…ç½®æ–‡ä»¶ï¼ˆä¸ºäº†æ–¹ä¾¿å­¦ä¹ ï¼Œredis.confæ ¹æ®ä¸åŒç«¯å£æ¥å‘½åï¼Œæ–¹ä¾¿ä¸€å°æœºå™¨ä¸Šæ„å»ºä¼ªé›†ç¾¤ï¼‰"></a>4ã€å‡†å¤‡6ä¸ªredis.confé…ç½®æ–‡ä»¶ï¼ˆä¸ºäº†æ–¹ä¾¿å­¦ä¹ ï¼Œredis.confæ ¹æ®ä¸åŒç«¯å£æ¥å‘½åï¼Œæ–¹ä¾¿ä¸€å°æœºå™¨ä¸Šæ„å»ºä¼ªé›†ç¾¤ï¼‰</h1><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># é…ç½®æ–‡ä»¶è¿›è¡Œäº†ç²¾ç®€ï¼Œå®Œæ•´é…ç½®å¯è‡ªè¡Œå’Œå®˜æ–¹æä¾›çš„å®Œæ•´confæ–‡ä»¶è¿›è¡Œå¯¹ç…§ã€‚ç«¯å£å·è‡ªè¡Œå¯¹åº”ä¿®æ”¹</span><span class="token comment" spellcheck="true">#åå°å¯åŠ¨çš„æ„æ€</span>daemonize <span class="token function">yes</span>  <span class="token comment" spellcheck="true">#ç«¯å£å·</span>port 6381<span class="token comment" spellcheck="true"># IPç»‘å®šï¼Œredisä¸å»ºè®®å¯¹å…¬ç½‘å¼€æ”¾ï¼Œç›´æ¥ç»‘å®š0.0.0.0æ²¡æ¯›ç—…</span>bind 0.0.0.0<span class="token comment" spellcheck="true"># redisæ•°æ®æ–‡ä»¶å­˜æ”¾çš„ç›®å½•</span><span class="token function">dir</span> /usr/local/redis/data<span class="token comment" spellcheck="true"># å¼€å¯AOF</span>appendonly <span class="token function">yes</span> <span class="token comment" spellcheck="true"># å¼€å¯é›†ç¾¤</span>cluster-enabled <span class="token function">yes</span><span class="token comment" spellcheck="true"># ä¼šè‡ªåŠ¨ç”Ÿæˆåœ¨ä¸Šé¢é…ç½®çš„dirç›®å½•ä¸‹</span>cluster-config-file nodes-6381.conf cluster-node-timeout 5000<span class="token comment" spellcheck="true"># è¿™ä¸ªæ–‡ä»¶ä¼šè‡ªåŠ¨ç”Ÿæˆ</span>pidfile /var/run/redis_6381.pid <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="5ã€å¯åŠ¨6ä¸ªRediså®ä¾‹"><a href="#5ã€å¯åŠ¨6ä¸ªRediså®ä¾‹" class="headerlink" title="5ã€å¯åŠ¨6ä¸ªRediså®ä¾‹"></a>5ã€å¯åŠ¨6ä¸ªRediså®ä¾‹</h1><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># ä¸€å®šè¦æ³¨æ„æ¯ä¸ªé…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£å·å“¦</span>/usr/local/redis/bin/redis-server /usr/local/redis/conf/6381.conf/usr/local/redis/bin/redis-server /usr/local/redis/conf/6382.conf/usr/local/redis/bin/redis-server /usr/local/redis/conf/6383.conf/usr/local/redis/bin/redis-server /usr/local/redis/conf/6384.conf/usr/local/redis/bin/redis-server /usr/local/redis/conf/6385.conf/usr/local/redis/bin/redis-server /usr/local/redis/conf/6386.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="6ã€-åˆ›å»ºcluster"><a href="#6ã€-åˆ›å»ºcluster" class="headerlink" title="6ã€ åˆ›å»ºcluster"></a>6ã€ åˆ›å»ºcluster</h1><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 5.0ç‰ˆæœ¬çš„æ–¹å¼</span>/usr/local/redis/bin/redis-cli --cluster create 192.168.100.242:6381 192.168.100.242:6382 \192.168.100.242:6383 192.168.100.242:6384 192.168.100.242:6385 192.168.100.242:6386 \--cluster-replicas 1<span class="token comment" spellcheck="true"># è‡ªåŠ¨è®¾ç½®ä¸»ä»ï¼Œè€Œä¸”ä¼šæç¤ºä½ ï¼Œæ˜¯å¦è¿è¡Œä½¿ç”¨è‡ªåŠ¨çš„é…ç½®</span>Can I <span class="token keyword">set</span> the above configuration? <span class="token punctuation">(</span>type <span class="token string">'yes'</span> to accept<span class="token punctuation">)</span>: <span class="token function">yes</span><span class="token comment" spellcheck="true"># æ‰§è¡Œåçš„ä¿¡æ¯</span><span class="token operator">>></span><span class="token operator">></span> Performing <span class="token function">hash</span> slots allocation on 6 nodes<span class="token punctuation">..</span>.Master<span class="token punctuation">[</span>0<span class="token punctuation">]</span> -<span class="token operator">></span> Slots 0 - 5460Master<span class="token punctuation">[</span>1<span class="token punctuation">]</span> -<span class="token operator">></span> Slots 5461 - 10922Master<span class="token punctuation">[</span>2<span class="token punctuation">]</span> -<span class="token operator">></span> Slots 10923 - 16383Adding replica 192.168.100.242:6384 to 192.168.100.242:6381Adding replica 192.168.100.242:6385 to 192.168.100.242:6382Adding replica 192.168.100.242:6386 to 192.168.100.242:6383<span class="token operator">>></span><span class="token operator">></span> Trying to optimize slaves allocation <span class="token keyword">for</span> anti-affinity<span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> Some slaves are <span class="token keyword">in</span> the same host as their masterM: 68326caa0238cb877afc3e6df23eb92558fcbc3c 192.168.100.242:6381   slots:<span class="token punctuation">[</span>0-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span>5461 slots<span class="token punctuation">)</span> masterM: 764500b86fadebd535ac2b5b778a73486fe7d2b7 192.168.100.242:6382   slots:<span class="token punctuation">[</span>5461-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span>5462 slots<span class="token punctuation">)</span> masterM: 93293699b8966ccc202bb29c659a9f60e26e4c86 192.168.100.242:6383   slots:<span class="token punctuation">[</span>10923-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span>5461 slots<span class="token punctuation">)</span> masterS: a842c5188c441453fd303520424132d45914fe5b 192.168.100.242:6384   replicates 764500b86fadebd535ac2b5b778a73486fe7d2b7S: 0a7061773b2512c91b6173bc27451b19fe02f269 192.168.100.242:6385   replicates 93293699b8966ccc202bb29c659a9f60e26e4c86S: 42806ad3f740f639ec321b78ea492c42a4040176 192.168.100.242:6386   replicates 68326caa0238cb877afc3e6df23eb92558fcbc3cCan I <span class="token keyword">set</span> the above configuration? <span class="token punctuation">(</span>type <span class="token string">'yes'</span> to accept<span class="token punctuation">)</span>: <span class="token function">yes</span><span class="token operator">>></span><span class="token operator">></span> Nodes configuration updated<span class="token operator">>></span><span class="token operator">></span> Assign a different config epoch to each node<span class="token operator">>></span><span class="token operator">></span> Sending CLUSTER MEET messages to <span class="token function">join</span> the clusterWaiting <span class="token keyword">for</span> the cluster to <span class="token function">join</span><span class="token punctuation">..</span>.<span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using node 192.168.100.242:6381<span class="token punctuation">)</span>M: 68326caa0238cb877afc3e6df23eb92558fcbc3c 192.168.100.242:6381   slots:<span class="token punctuation">[</span>0-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span>5461 slots<span class="token punctuation">)</span> master   1 additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>S: 0a7061773b2512c91b6173bc27451b19fe02f269 192.168.100.242:6385   slots: <span class="token punctuation">(</span>0 slots<span class="token punctuation">)</span> slave   replicates 93293699b8966ccc202bb29c659a9f60e26e4c86S: a842c5188c441453fd303520424132d45914fe5b 192.168.100.242:6384   slots: <span class="token punctuation">(</span>0 slots<span class="token punctuation">)</span> slave   replicates 764500b86fadebd535ac2b5b778a73486fe7d2b7M: 93293699b8966ccc202bb29c659a9f60e26e4c86 192.168.100.242:6383   slots:<span class="token punctuation">[</span>10923-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span>5461 slots<span class="token punctuation">)</span> master   1 additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>M: 764500b86fadebd535ac2b5b778a73486fe7d2b7 192.168.100.242:6382   slots:<span class="token punctuation">[</span>5461-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span>5462 slots<span class="token punctuation">)</span> master   1 additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>S: 42806ad3f740f639ec321b78ea492c42a4040176 192.168.100.242:6386   slots: <span class="token punctuation">(</span>0 slots<span class="token punctuation">)</span> slave   replicates 68326caa0238cb877afc3e6df23eb92558fcbc3c<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.<span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.<span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>.<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All 16384 slots covered.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="7ã€-é›†ç¾¤æ£€éªŒå’Œæµ‹è¯•"><a href="#7ã€-é›†ç¾¤æ£€éªŒå’Œæµ‹è¯•" class="headerlink" title="7ã€ é›†ç¾¤æ£€éªŒå’Œæµ‹è¯•"></a>7ã€ é›†ç¾¤æ£€éªŒå’Œæµ‹è¯•</h1><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># æ£€æŸ¥é›†ç¾¤ï¼ŒæŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯</span>/usr/local/redis/bin/redis-cli -c -h 192.168.100.242 -p 6381 cluster nodes<span class="token comment" spellcheck="true"># æ‰§è¡Œåçš„ä¿¡æ¯</span><span class="token punctuation">[</span>root@node3 redis<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># /usr/local/redis/bin/redis-cli -c -h 192.168.100.242 -p 6381 cluster nodes</span>0a7061773b2512c91b6173bc27451b19fe02f269 192.168.100.242:6385@16385 slave 93293699b8966ccc202bb29c659a9f60e26e4c86 0 1550635081000 5 connecteda842c5188c441453fd303520424132d45914fe5b 192.168.100.242:6384@16384 slave 764500b86fadebd535ac2b5b778a73486fe7d2b7 0 1550635081565 4 connected93293699b8966ccc202bb29c659a9f60e26e4c86 192.168.100.242:6383@16383 master - 0 1550635081665 3 connected 10923-16383764500b86fadebd535ac2b5b778a73486fe7d2b7 192.168.100.242:6382@16382 master - 0 1550635081000 2 connected 5461-1092268326caa0238cb877afc3e6df23eb92558fcbc3c 192.168.100.242:6381@16381 myself,master - 0 1550635080000 1 connected 0-546042806ad3f740f639ec321b78ea492c42a4040176 192.168.100.242:6386@16386 slave 68326caa0238cb877afc3e6df23eb92558fcbc3c 0 1550635080664 6 connected<span class="token comment" spellcheck="true"># èŠ‚ç‚¹id ip+ç«¯å£ è§’è‰² masterid å¤„ç†çš„pingæ•°é‡ æœ€åä¸€ä¸ªpongæ—¶é—´ èŠ‚ç‚¹é…ç½®ç‰ˆæœ¬ èŠ‚ç‚¹è¿æ¥çŠ¶æ€ slotæ§½åˆ†é…æƒ…å†µ</span><span class="token comment" spellcheck="true"># æµ‹è¯•Redis Clusterçš„ä¸€ç§ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨redis-cliå‘½ä»¤è¡Œå®ç”¨ç¨‹åº</span><span class="token comment" spellcheck="true"># -c æ˜¯æ”¯æŒclusteré‡å®šå‘</span><span class="token punctuation">[</span>root@node3 redis<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># /usr/local/redis/bin/redis-cli -c -h 192.168.100.242 -p 6381</span>192.168.100.242:6381<span class="token operator">></span> <span class="token keyword">set</span> a 1-<span class="token operator">></span> Redirected to slot <span class="token punctuation">[</span>15495<span class="token punctuation">]</span> located at 192.168.100.242:6383OK192.168.100.242:6383<span class="token operator">></span> get a<span class="token string">"1"</span>192.168.100.242:6383<span class="token operator">></span> <span class="token keyword">set</span> hello tony-<span class="token operator">></span> Redirected to slot <span class="token punctuation">[</span>866<span class="token punctuation">]</span> located at 192.168.100.242:6381OK192.168.100.242:6381<span class="token operator">></span> get hello<span class="token string">"tony"</span>192.168.100.242:6381<span class="token operator">></span> get a-<span class="token operator">></span> Redirected to slot <span class="token punctuation">[</span>15495<span class="token punctuation">]</span> located at 192.168.100.242:6383<span class="token string">"1"</span><span class="token comment" spellcheck="true"># æŸ¥çœ‹ä¸€ä¸ªkeyå±äºå“ªä¸€ä¸ªèŠ‚ç‚¹</span>CLUSTER KEYSLOT key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="8ã€é›†ç¾¤slotæ•°é‡æ•´ç†-reshard"><a href="#8ã€é›†ç¾¤slotæ•°é‡æ•´ç†-reshard" class="headerlink" title="8ã€é›†ç¾¤slotæ•°é‡æ•´ç† reshard"></a>8ã€é›†ç¾¤slotæ•°é‡æ•´ç† reshard</h1><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#  /usr/local/redis/bin/redis-cli --cluster help å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è¿™ä¸ªå‘½ä»¤å’Œå­å‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯</span><span class="token comment" spellcheck="true"># é»˜è®¤æ˜¯masterå¹³å‡åˆ†äº†0-16383çš„æ‰€æœ‰è™šæ‹Ÿslot</span><span class="token comment" spellcheck="true"># å¯ä»¥è¿›è¡Œè°ƒæ•´ï¼Œéƒ¨åˆ†èŠ‚ç‚¹æ”¾å¤šä¸€ç‚¹slot(æ§½æˆ–è€…ä½ç½®)ã€‚</span>/usr/local/redis/bin/redis-cli --cluster reshard  <span class="token operator">&lt;</span>host<span class="token operator">></span>:<span class="token operator">&lt;</span>port<span class="token operator">></span> --cluster-from <span class="token operator">&lt;</span>node-id<span class="token operator">></span> --cluster-to <span class="token operator">&lt;</span>node-id<span class="token operator">></span> --cluster-slots <span class="token operator">&lt;</span>number of slots<span class="token operator">></span> --cluster-yes<span class="token comment" spellcheck="true"># é‡æ–°æ£€æŸ¥é›†ç¾¤</span><span class="token punctuation">[</span>root@node3 redis<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># /usr/local/redis/bin/redis-cli --cluster check 192.168.100.242:6382</span>192.168.100.242:6382 <span class="token punctuation">(</span>764500b8<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> 0 keys <span class="token operator">|</span> 5462 slots <span class="token operator">|</span> 1 slaves.192.168.100.242:6383 <span class="token punctuation">(</span>93293699<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> 1 keys <span class="token operator">|</span> 5461 slots <span class="token operator">|</span> 1 slaves.192.168.100.242:6381 <span class="token punctuation">(</span>68326caa<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> 1 keys <span class="token operator">|</span> 5461 slots <span class="token operator">|</span> 1 slaves.<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> 2 keys <span class="token keyword">in</span> 3 masters.0.00 keys per slot on average.<span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using node 192.168.100.242:6382<span class="token punctuation">)</span>M: 764500b86fadebd535ac2b5b778a73486fe7d2b7 192.168.100.242:6382   slots:<span class="token punctuation">[</span>5461-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span>5462 slots<span class="token punctuation">)</span> master   1 additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>S: a842c5188c441453fd303520424132d45914fe5b 192.168.100.242:6384   slots: <span class="token punctuation">(</span>0 slots<span class="token punctuation">)</span> slave   replicates 764500b86fadebd535ac2b5b778a73486fe7d2b7M: 93293699b8966ccc202bb29c659a9f60e26e4c86 192.168.100.242:6383   slots:<span class="token punctuation">[</span>10923-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span>5461 slots<span class="token punctuation">)</span> master   1 additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>S: 42806ad3f740f639ec321b78ea492c42a4040176 192.168.100.242:6386   slots: <span class="token punctuation">(</span>0 slots<span class="token punctuation">)</span> slave   replicates 68326caa0238cb877afc3e6df23eb92558fcbc3cS: 0a7061773b2512c91b6173bc27451b19fe02f269 192.168.100.242:6385   slots: <span class="token punctuation">(</span>0 slots<span class="token punctuation">)</span> slave   replicates 93293699b8966ccc202bb29c659a9f60e26e4c86M: 68326caa0238cb877afc3e6df23eb92558fcbc3c 192.168.100.242:6381   slots:<span class="token punctuation">[</span>0-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span>5461 slots<span class="token punctuation">)</span> master   1 additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.<span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.<span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>.<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All 16384 slots covered.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="9ã€-æµ‹è¯•è‡ªåŠ¨æ•…éšœè½¬ç§»"><a href="#9ã€-æµ‹è¯•è‡ªåŠ¨æ•…éšœè½¬ç§»" class="headerlink" title="9ã€ æµ‹è¯•è‡ªåŠ¨æ•…éšœè½¬ç§»"></a>9ã€ æµ‹è¯•è‡ªåŠ¨æ•…éšœè½¬ç§»</h1><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># clusteré›†ç¾¤ä¸ä¿è¯æ•°æ®ä¸€è‡´ï¼Œæ•°æ®ä¹Ÿå¯èƒ½ä¸¢å¤±</span><span class="token comment" spellcheck="true"># é¦–å…ˆæ˜¯è¿è¡Œå®¢æˆ·ç«¯ä¸æ–­çš„å†™å…¥æˆ–è¯»å–æ•°æ®ï¼Œä»¥ä¾¿èƒ½å¤Ÿå‘ç°é—®é¢˜</span><span class="token comment" spellcheck="true"># ç„¶åæ˜¯æ¨¡æ‹ŸèŠ‚ç‚¹æ•…éšœï¼šæ‰¾ä¸€ä¸ªä¸»èŠ‚ç‚¹å…³é—­ï¼Œä¸»ä»æ•…éšœåˆ‡æ¢çš„è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªæ—¶é—´ç«¯çš„æ“ä½œï¼Œå®¢æˆ·ç«¯è€Œè¨€ï¼Œåªèƒ½æ˜¯å¤±è´¥</span><span class="token comment" spellcheck="true"># å®˜æ–¹æè¿° https://redis.io/topics/cluster-spec  </span>There is always a window of <span class="token function">time</span> when it is possible to lose writes during partitions.åˆ†åŒºçš„æ—¶é—´çª—å£å†…æ€»æ˜¯æœ‰å¯èƒ½ä¸¢å¤±å†™æ“ä½œã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="10ã€æ‰‹åŠ¨æ•…éšœè½¬ç§»"><a href="#10ã€æ‰‹åŠ¨æ•…éšœè½¬ç§»" class="headerlink" title="10ã€æ‰‹åŠ¨æ•…éšœè½¬ç§»"></a>10ã€æ‰‹åŠ¨æ•…éšœè½¬ç§»</h1><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># å¯èƒ½æŸä¸ªèŠ‚ç‚¹éœ€è¦ç»´æŠ¤ï¼ˆæœºå™¨ä¸‹çº¿ã€ç¡¬ä»¶å‡çº§ã€ç³»ç»Ÿç‰ˆæœ¬è°ƒæ•´ç­‰ç­‰åœºæ™¯ï¼‰ï¼Œéœ€è¦æ‰‹åŠ¨çš„å®ç°è½¬ç§»</span><span class="token comment" spellcheck="true"># åœ¨slaveèŠ‚ç‚¹ä¸Šæ‰§è¡Œå‘½ä»¤</span>CLUSTER FAILOVER <span class="token comment" spellcheck="true"># æ³¨ï¼šCLUSTER  help å¯ä»¥çœ‹åˆ°å¸®åŠ©æ–‡æ¡£å’Œç®€ä»‹ã€‚ ç›¸å¯¹å®‰å…¨çš„åšæ³•</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h1 id="11ã€æ‰©å®¹"><a href="#11ã€æ‰©å®¹" class="headerlink" title="11ã€æ‰©å®¹"></a>11ã€æ‰©å®¹</h1><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 1ã€ å¯åŠ¨æ–°èŠ‚ç‚¹</span>/usr/local/redis/bin/redis-server /usr/local/redis/conf/6387.conf<span class="token comment" spellcheck="true"># 2ã€ åŠ å…¥åˆ°å·²ç»å­˜åœ¨çš„é›†ç¾¤ä½œä¸ºmaster</span>/usr/local/redis/bin/redis-cli --cluster add-node 192.168.100.242:6387 192.168.100.242:6382<span class="token comment" spellcheck="true"># æœ¬è´¨å°±æ˜¯å‘é€ä¸€ä¸ªæ–°èŠ‚ç‚¹é€šè¿‡ CLUSTER MEETå‘½ä»¤åŠ å…¥é›†ç¾¤</span><span class="token comment" spellcheck="true"># æ–°èŠ‚ç‚¹æ²¡æœ‰åˆ†é…hashæ§½</span><span class="token comment" spellcheck="true"># 3ã€ åŠ å…¥åˆ°å·²ç»å­˜åœ¨çš„é›†ç¾¤ä½œä¸ºslave</span>/usr/local/redis/bin/redis-cli --cluster add-node 192.168.100.242:7006 192.168.100.242:7000 --cluster-slave<span class="token comment" spellcheck="true"># å¯ä»¥æ‰‹å·¥æŒ‡å®šmasterï¼Œå¦åˆ™å°±æ˜¯é€‰æ‹©ä¸€ä¸ªslaveæ•°é‡è¾ƒå°‘çš„master </span>/usr/local/redis/bin/redis-cli --cluster add-node 192.168.100.242:7006 192.168.100.242:7000 --cluster-slave --cluster-master-id <span class="token operator">&lt;</span>node-id<span class="token operator">></span><span class="token comment" spellcheck="true"># è¿˜å¯ä»¥å°†ç©ºmasterï¼Œè½¬æ¢ä¸ºslave</span>cluster replicate <span class="token operator">&lt;</span>master-node-id<span class="token operator">></span><span class="token comment" spellcheck="true"># 4ã€ æ£€æŸ¥é›†ç¾¤</span>/usr/local/redis/bin/redis-cli --cluster check 192.168.100.242:6382<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="12ã€ç¼©å®¹ï¼ˆåˆ é™¤èŠ‚ç‚¹ï¼‰"><a href="#12ã€ç¼©å®¹ï¼ˆåˆ é™¤èŠ‚ç‚¹ï¼‰" class="headerlink" title="12ã€ç¼©å®¹ï¼ˆåˆ é™¤èŠ‚ç‚¹ï¼‰"></a>12ã€ç¼©å®¹ï¼ˆåˆ é™¤èŠ‚ç‚¹ï¼‰</h1><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># æ³¨æ„ï¼šåˆ é™¤masterçš„æ—¶å€™è¦æŠŠæ•°æ®æ¸…ç©ºæˆ–è€…åˆ†é…ç»™å…¶ä»–ä¸»èŠ‚ç‚¹</span>/usr/local/redis/bin/redis-cli --cluster del-node 192.168.100.242:6381 <span class="token operator">&lt;</span>node-id<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="13ã€å…³å¿ƒçš„é—®é¢˜"><a href="#13ã€å…³å¿ƒçš„é—®é¢˜" class="headerlink" title="13ã€å…³å¿ƒçš„é—®é¢˜"></a>13ã€å…³å¿ƒçš„é—®é¢˜</h1><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 1ã€ å¢åŠ äº†slotæ§½çš„è®¡ç®—ï¼Œæ˜¯ä¸æ˜¯æ¯”å•æœºæ€§èƒ½å·®ï¼Ÿ</span>å…±16384ä¸ªæ§½ï¼Œslotsæ§½è®¡ç®—æ–¹å¼å…¬å¼€çš„ï¼Œjavaå®¢æˆ·ç«¯ä¸­å°±ä½¿ç”¨äº†ï¼šHASH_SLOT <span class="token operator">=</span> CRC16<span class="token punctuation">(</span>key<span class="token punctuation">)</span> mod 16384ä¸ºäº†é¿å…æ¯æ¬¡éƒ½éœ€è¦æœåŠ¡å™¨è®¡ç®—é‡å®šå‘ï¼Œä¼˜ç§€çš„javaå®¢æˆ·ç«¯éƒ½å®ç°äº†æœ¬åœ°è®¡ç®—ï¼Œå’ŒæœåŠ¡å™¨slotsåˆ†é…è¿›è¡Œæ˜ å°„ï¼Œæœ‰å˜åŠ¨æ—¶å†æ›´æ–°æœ¬åœ°å†…å®¹ã€‚<span class="token comment" spellcheck="true"># 2ã€ redisé›†ç¾¤å¤§å°</span>ç†è®ºæ˜¯å¯ä»¥åšåˆ°16384ä¸ªæ§½ï¼Œä½†æ˜¯rediså®˜æ–¹å»ºè®®æ˜¯æœ€å¤§1000ä¸ªå®ä¾‹<span class="token comment" spellcheck="true"># 3ã€ æ‰¹é‡æ“ä½œæˆ–è€…</span><span class="token comment" spellcheck="true"># 4ã€cluster meetå‘½ä»¤ä¸­çš„bus-portæ˜¯ä»€ä¹ˆï¼Ÿ</span>MEET <span class="token operator">&lt;</span>ip<span class="token operator">></span> <span class="token operator">&lt;</span>port<span class="token operator">></span> <span class="token punctuation">[</span>bus-port<span class="token punctuation">]</span>æ¯ä¸ªRedisç¾¤é›†èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªé¢å¤–çš„TCPç«¯å£ï¼Œç”¨äºæ¥æ”¶æ¥è‡ªå…¶ä»–Redisç¾¤é›†èŠ‚ç‚¹çš„ä¼ å…¥è¿æ¥<span class="token comment" spellcheck="true"># 5ã€é›†ç¾¤èŠ‚ç‚¹é—´çš„é€šä¿¡æ–¹å¼</span>æ¯ä¸ªèŠ‚ç‚¹ä½¿ç”¨TCPè¿æ¥ä¸æ¯ä¸ªå…¶ä»–èŠ‚ç‚¹è¿æ¥ã€‚<span class="token comment" spellcheck="true"># 6ã€askå’Œmovedé‡å®šå‘çš„åŒºåˆ«</span>é‡å®šå‘åŒ…æ‹¬ä¸¤ç§æƒ…å†µå¦‚æœæ˜¯ç¡®å®šslotä¸å±äºå½“å‰èŠ‚ç‚¹ï¼Œredisä¼šè¿”å›movedå¦‚æœå½“å‰redisèŠ‚ç‚¹æ­£åœ¨å¤„ç†slotè¿ç§»ï¼Œåˆ™ä»£è¡¨æ­¤å¤„è¯·æ±‚å¯¹åº”çš„keyæš‚æ—¶ä¸åœ¨æ­¤èŠ‚ç‚¹ï¼Œè¿”å›askï¼Œå‘Šè¯‰å®¢æˆ·ç«¯æœ¬æ¬¡è¯·æ±‚é‡å®šå‘<span class="token comment" spellcheck="true"># 7ã€æ•°æ®å€¾æ–œå’Œè®¿é—®å€¾æ–œçš„é—®é¢˜</span>è§£å†³åŠæ³• è°ƒæ•´keyçš„ç­–ç•¥ + slotè¿ç§»è¿ç§»è¿‡ç¨‹å¦‚ä¸‹ï¼Œå®Œæ•´çš„è¿ç§»æµç¨‹ï¼šåœ¨è¿ç§»ç›®çš„èŠ‚ç‚¹æ‰§è¡Œcluster setslot <span class="token operator">&lt;</span>slot<span class="token operator">></span> IMPORTING <span class="token operator">&lt;</span>node ID<span class="token operator">></span>å‘½ä»¤ï¼ŒæŒ‡æ˜éœ€è¦è¿ç§»çš„slotå’Œè¿ç§»æºèŠ‚ç‚¹ã€‚åœ¨è¿ç§»æºèŠ‚ç‚¹æ‰§è¡Œcluster setslot <span class="token operator">&lt;</span>slot<span class="token operator">></span> MIGRATING <span class="token operator">&lt;</span>node ID<span class="token operator">></span>å‘½ä»¤ï¼ŒæŒ‡æ˜éœ€è¦è¿ç§»çš„slotå’Œè¿ç§»ç›®çš„èŠ‚ç‚¹ã€‚åœ¨è¿ç§»æºèŠ‚ç‚¹æ‰§è¡Œcluster getkeysinslotè·å–è¯¥slotçš„keyåˆ—è¡¨ã€‚åœ¨è¿ç§»æºèŠ‚ç‚¹æ‰§è¡Œå¯¹æ¯ä¸ªkeyæ‰§è¡Œmigrateå‘½ä»¤ï¼Œè¯¥å‘½ä»¤ä¼šåŒæ­¥æŠŠè¯¥keyè¿ç§»åˆ°ç›®çš„èŠ‚ç‚¹ã€‚åœ¨è¿ç§»æºèŠ‚ç‚¹åå¤æ‰§è¡Œcluster getkeysinslotå‘½ä»¤ï¼Œç›´åˆ°è¯¥slotçš„åˆ—è¡¨ä¸ºç©ºã€‚åœ¨è¿ç§»æºèŠ‚ç‚¹å’Œç›®çš„èŠ‚ç‚¹æ‰§è¡Œcluster setslot <span class="token operator">&lt;</span>slot<span class="token operator">></span> NODE <span class="token operator">&lt;</span>node ID<span class="token operator">></span>ï¼Œå®Œæˆè¿ç§»æ“ä½œã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;1ã€-ç¯å¢ƒä¿¡æ¯&quot;&gt;&lt;a href=&quot;#1ã€-ç¯å¢ƒä¿¡æ¯&quot; class=&quot;headerlink&quot; title=&quot;1ã€ ç¯å¢ƒä¿¡æ¯&quot;&gt;&lt;/a&gt;1ã€ ç¯å¢ƒä¿¡æ¯&lt;/h1&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;centos7
redis5&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="æ•°æ®åº“" scheme="https://brokge.github.io/categories/%E6%8A%80%E6%9C%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="ç¼“å­˜" scheme="https://brokge.github.io/tags/%E7%BC%93%E5%AD%98/"/>
    
      <category term="Redis" scheme="https://brokge.github.io/tags/Redis/"/>
    
  </entry>
  
</feed>
